import{d as he,g as f,h as ve,c as o,n as fe,s as ge,f as n,t as h,l as p,F as b,j as $,e as B,p as me,b as E,J as V,K as ye,m as _e,L as M,o as a}from"./index-D93vx-Bb.js";import{h as ke}from"./index-C6G0aGO3.js";import{_ as be}from"./_plugin-vue_export-helper-DlAUqK2U.js";const xe={key:0,class:"chat-empty"},Ce={key:0,class:"welcome-msg"},we={key:1,class:"examples"},$e=["onClick"],Se={key:0,class:"msg-row user"},Ie={class:"msg-bubble user"},Me={key:0,class:"msg-images"},Te=["src","onClick"],De={class:"msg-text"},Ae={key:1,class:"msg-row assistant"},Ne={class:"msg-col"},Fe=["open"],Le={class:"thinking-summary"},Je={class:"thinking-len"},Oe={class:"thinking-content"},Be={class:"msg-bubble assistant"},Ee={class:"tool-details"},Re={class:"tool-summary"},je={class:"tool-name"},He={key:0,class:"tool-status running"},Ke={key:1,class:"tool-status done"},Pe={key:2,class:"tool-status error"},Ue={class:"tool-body"},Ve={key:0,class:"tool-section"},ze={class:"tool-pre"},We={key:1,class:"tool-section"},Ye={class:"tool-pre result"},Ge=["innerHTML"],qe={key:1,class:"apply-card"},Qe={class:"apply-preview"},Xe={class:"apply-key"},Ze={class:"apply-val"},et=["onClick"],tt={class:"msg-actions"},st=["onClick","title"],nt=["onClick"],lt=["onClick"],ot={key:1,class:"option-chips"},at=["onClick"],it={key:2,class:"msg-row system"},ct={class:"msg-system"},rt={key:1,class:"msg-row assistant"},ut={class:"msg-col"},dt={key:0,class:"thinking-block",open:""},pt={class:"thinking-content"},ht={class:"msg-bubble assistant"},vt={key:0,class:"typing-dots"},ft=["innerHTML"],gt={key:2,class:"blink"},mt=["src"],yt={class:"chat-input-area"},_t={key:0,class:"attachments-bar"},kt=["src"],bt=["onClick"],xt={class:"input-row"},Ct={class:"textarea-wrap"},wt=["placeholder","disabled","onKeydown"],$t={class:"input-actions"},St={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},It=["disabled"],Mt={key:0,class:"spinner"},Tt={key:1},Dt=he({__name:"AiChat",props:{agentId:{},sessionId:{},context:{},scenario:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply","session-change"],setup(g,{expose:z,emit:W}){const v=g,T=W,d=f(v.initialMessages?[...v.initialMessages]:[]),S=f(""),x=f([]),C=f(!1),m=f(""),I=f(""),D=f(null),A=f(""),w=f(v.sessionId),N=f(),y=f(),Y=_e(()=>({height:v.height??"100%","--bg":v.bgColor??"transparent"}));function _(){M(()=>{N.value&&(N.value.scrollTop=N.value.scrollHeight)})}function G(){y.value&&(y.value.style.height="auto",y.value.style.height=Math.min(y.value.scrollHeight,160)+"px")}function R(s){S.value=s,M(()=>y.value?.focus())}function q(s){try{return JSON.stringify(JSON.parse(s),null,2)}catch{return s}}function Q(s){navigator.clipboard?.writeText(s);const e=d.value.findIndex(t=>t.text===s);D.value=e,setTimeout(()=>{D.value=null},1500)}function X(s){for(let e=s-1;e>=0;e--){const t=d.value[e];if(t&&t.role==="user"){const i=t.text,l=t.images??[];d.value.splice(e,d.value.length-e),U(i,l);return}}}function Z(s){A.value=s}function H(s){return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(t,i,l)=>`<pre class="code-block${i?" lang-"+i:""}"><code>${l}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function ee(s){const e=s.split(`
`),t=[],i=/^([ğŸ™ğŸ˜„ğŸŒğŸ›ğŸ“šğŸ¨ğŸ’¼ğŸ¤–âš½ğŸ¯âœ…âŒğŸ”¥ğŸ’¡ğŸğŸš€ğŸŒŸğŸ’ğŸªğŸ­ğŸ¬ğŸ¤]|[\u{1F300}-\u{1FFFF}]|[\u{2600}-\u{27BF}])\s+(.{4,40})/u;for(const l of e){const c=l.replace(/^[-*â€¢]\s*/,"").trim();if(c.match(i)){const u=c.replace(/[ï¼š:ã€‚ï¼Œ,]$/,"").trim();u.length>=5&&t.push(u)}}return t.slice(0,5)}function te(s){return s?/\{[\s\S]{30,}\}/.test(s)&&(s.includes('"name"')||s.includes('"identity"')||s.includes('"soul"')||s.includes('"IDENTITY"')||s.includes('"SOUL"')):!1}function se(s){const e=K(s.text);console.log("[AiChat] manualApply result:",e),e?(s.applyData=e,M(()=>T("apply",e))):alert("æœªèƒ½ä»æ¶ˆæ¯ä¸­æå–åˆ°é…ç½® JSONï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶")}function K(s){const e=s.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(e?.[1]){const i=F(e[1]);if(i)return i;const l=P(e[1]),c=F(l);if(c)return c}const t=[...s.matchAll(/(\{[^{}]{20,}\})/g)];for(let i=t.length-1;i>=0;i--){const l=t[i]?.[1];if(!l)continue;const c=F(l)??F(P(l));if(c)return c}return null}function F(s){try{const e=JSON.parse(s);if(e&&typeof e=="object"&&!Array.isArray(e)){const t=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(i=>t.includes(i)))return e}}catch{}return null}function P(s){let e="",t=!1,i=!1;for(let l=0;l<s.length;l++){const c=s[l];if(i){e+=c,i=!1;continue}if(c==="\\"&&t){e+=c,i=!0;continue}if(c==='"'){t=!t,e+=c;continue}if(t&&c===`
`){e+="\\n";continue}if(t&&c==="\r"){e+="\\r";continue}e+=c}return e}function ne(s){const e=s.clipboardData?.items;if(e){for(const t of Array.from(e))if(t.type.startsWith("image/")){s.preventDefault();const i=t.getAsFile();i&&j(i)}}}function le(s){const e=s.dataTransfer?.files;if(e)for(const t of Array.from(e))t.type.startsWith("image/")&&j(t)}function oe(s){const e=s.target.files;if(e)for(const t of Array.from(e))j(t)}function j(s){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&x.value.push(e.result)},e.readAsDataURL(s)}function ae(s){x.value.splice(s,1)}function L(){const s=S.value.trim(),e=[...x.value];!s&&!e.length||C.value||(S.value="",x.value=[],M(()=>{y.value&&(y.value.style.height="auto")}),T("message",s,e),U(s,e))}function U(s,e){d.value.push({role:"user",text:s,images:e.length?e:void 0}),_(),C.value=!0,m.value="",I.value="";const t={role:"assistant",text:"",toolCalls:[]};d.value.push(t);const i=d.value.length-1;let l="",c;if(!w.value){const u=d.value.slice(0,-1).filter(r=>(r.role==="user"||r.role==="assistant")&&r.text).slice(-20).map(r=>({role:r.role,content:r.text}));c=u.length>0?u:void 0}const J={sessionId:w.value,context:v.context,scenario:v.scenario,images:e.length?e:void 0,history:c};ke(v.agentId,s,u=>{switch(u.type){case"thinking_delta":I.value+=u.text,_();break;case"text":case"text_delta":m.value+=u.text,_();break;case"tool_call":{const r={id:u.tool_call?.id??String(Date.now()),name:u.tool_call?.name??"tool",input:u.tool_call?.input?JSON.stringify(u.tool_call.input):void 0,status:"running"};d.value[i].toolCalls.push(r),l=r.id,_();break}case"tool_result":{const r=d.value[i].toolCalls?.find(O=>O.id===l);r&&(r.result=u.text,r.status="done"),_();break}case"done":case"error":{if(u.type==="done"&&u.sessionId){const k=!w.value;w.value=u.sessionId,k&&T("session-change",u.sessionId)}const r=d.value[i];if(r.text=m.value,r.thinking=I.value||void 0,v.applyable){const k=K(m.value);k?(r.applyData=k,console.log("[AiChat] applyData extracted:",k)):console.log("[AiChat] no applyData found in text length:",m.value.length)}const O=ee(m.value);if(O.length>=2&&(r.options=O),u.type==="error"){r.text=`âŒ ${u.error}`;const k=r.toolCalls?.find(pe=>pe.status==="running");k&&(k.status="error")}C.value=!1,m.value="",I.value="",T("response",r.text),_();break}}},J)}function ie(){d.value=[]}function ce(s){d.value.push(s),_()}function re(s){w.value=s,d.value=[]}function ue(){w.value=void 0,d.value=[]}function de(s){R(s),M(L)}return z({clearMessages:ie,appendMessage:ce,sendText:de,messages:d,currentSessionId:w,resumeSession:re,startNewSession:ue}),ve(()=>{_()}),(s,e)=>(a(),o("div",{class:ge(["ai-chat",{compact:g.compact,"has-bg":g.bgColor}]),style:fe(Y.value)},[n("div",{class:"chat-messages",ref_key:"msgListRef",ref:N},[d.value.length?p("",!0):(a(),o("div",xe,[g.welcomeMessage?(a(),o("div",Ce,h(g.welcomeMessage),1)):p("",!0),g.examples.length?(a(),o("div",we,[(a(!0),o(b,null,$(g.examples,(t,i)=>(a(),o("div",{key:i,class:"example-chip",onClick:l=>R(t)},h(t),9,$e))),128))])):p("",!0)])),(a(!0),o(b,null,$(d.value,(t,i)=>(a(),o(b,{key:i},[t.role==="user"?(a(),o("div",Se,[n("div",Ie,[t.images?.length?(a(),o("div",Me,[(a(!0),o(b,null,$(t.images,(l,c)=>(a(),o("img",{key:c,src:l,class:"msg-img",onClick:J=>Z(l)},null,8,Te))),128))])):p("",!0),n("div",De,h(t.text),1)])])):t.role==="assistant"?(a(),o("div",Ae,[n("div",Ne,[t.thinking?(a(),o("details",{key:0,class:"thinking-block",open:g.showThinking},[n("summary",Le,[e[3]||(e[3]=n("span",{class:"thinking-icon"},"ğŸ’­",-1)),e[4]||(e[4]=B(" æ€è€ƒè¿‡ç¨‹ ",-1)),n("span",Je,h(t.thinking.length)+" å­—ç¬¦",1)]),n("pre",Oe,h(t.thinking),1)],8,Fe)):p("",!0),n("div",Be,[(a(!0),o(b,null,$(t.toolCalls,(l,c)=>(a(),o("div",{key:c,class:"tool-call-block"},[n("details",Ee,[n("summary",Re,[e[5]||(e[5]=n("span",{class:"tool-icon"},"ğŸ”§",-1)),n("span",je,h(l.name),1),l.status==="running"?(a(),o("span",He,"è¿è¡Œä¸­â€¦")):l.status==="done"?(a(),o("span",Ke,"å®Œæˆ")):l.status==="error"?(a(),o("span",Pe,"å¤±è´¥")):p("",!0)]),n("div",Ue,[l.input?(a(),o("div",Ve,[e[6]||(e[6]=n("div",{class:"tool-label"},"è¾“å…¥",-1)),n("pre",ze,h(q(l.input)),1)])):p("",!0),l.result?(a(),o("div",We,[e[7]||(e[7]=n("div",{class:"tool-label"},"è¾“å‡º",-1)),n("pre",Ye,h(l.result.slice(0,800))+h(l.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):p("",!0)])])]))),128)),t.text?(a(),o("div",{key:0,class:"msg-text",innerHTML:H(t.text)},null,8,Ge)):p("",!0),t.applyData&&v.applyable?(a(),o("div",qe,[n("div",Qe,[(a(!0),o(b,null,$(t.applyData,(l,c)=>(a(),o("div",{key:c,class:"apply-row"},[n("span",Xe,h(c),1),n("span",Ze,h(String(l).slice(0,60))+h(String(l).length>60?"â€¦":""),1)]))),128))]),n("button",{class:"apply-btn",onClick:l=>s.$emit("apply",t.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,et)])):p("",!0),n("div",tt,[n("button",{class:"act-btn",onClick:l=>Q(t.text),title:D.value===i?"å·²å¤åˆ¶":"å¤åˆ¶"},h(D.value===i?"âœ“":"â˜"),9,st),n("button",{class:"act-btn",onClick:l=>X(i),title:"é‡è¯•"},"â†º",8,nt),v.applyable&&!t.applyData&&te(t.text)?(a(),o("button",{key:0,class:"act-btn apply-manual-btn",onClick:l=>se(t),title:"æ£€æµ‹åˆ°é…ç½® JSONï¼Œç‚¹å‡»åº”ç”¨"}," âš™ åº”ç”¨é…ç½® ",8,lt)):p("",!0)])]),t.options&&t.options.length?(a(),o("div",ot,[(a(!0),o(b,null,$(t.options,(l,c)=>(a(),o("button",{key:c,class:"option-chip",onClick:J=>R(l)},h(l),9,at))),128))])):p("",!0)])])):t.role==="system"?(a(),o("div",it,[n("div",ct,h(t.text),1)])):p("",!0)],64))),128)),C.value?(a(),o("div",rt,[n("div",ut,[I.value&&g.showThinking?(a(),o("details",dt,[e[9]||(e[9]=n("summary",{class:"thinking-summary"},[n("span",{class:"thinking-icon"},"ğŸ’­"),B(" æ€è€ƒä¸­â€¦ ")],-1)),n("pre",pt,[B(h(I.value),1),e[8]||(e[8]=n("span",{class:"blink"},"â–Š",-1))])])):p("",!0),n("div",ht,[m.value?(a(),o("div",{key:1,class:"msg-text",innerHTML:H(m.value)},null,8,ft)):(a(),o("div",vt,[...e[10]||(e[10]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])),m.value?(a(),o("span",gt,"â–Š")):p("",!0)])])])):p("",!0)],512),A.value?(a(),o("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=t=>A.value="")},[n("img",{src:A.value,class:"img-preview-full"},null,8,mt)])):p("",!0),n("div",yt,[x.value.length?(a(),o("div",_t,[(a(!0),o(b,null,$(x.value,(t,i)=>(a(),o("div",{key:i,class:"attach-thumb"},[n("img",{src:t},null,8,kt),n("button",{class:"remove-attach",onClick:l=>ae(i)},"Ã—",8,bt)]))),128))])):p("",!0),n("div",xt,[n("div",Ct,[me(n("textarea",{ref_key:"inputRef",ref:y,"onUpdate:modelValue":e[1]||(e[1]=t=>S.value=t),placeholder:g.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:C.value,rows:"1",class:"chat-textarea",onKeydown:[V(E(L,["ctrl","prevent"]),["enter"]),V(E(L,["meta","prevent"]),["enter"])],onPaste:ne,onInput:G,onDragover:e[2]||(e[2]=E(()=>{},["prevent"])),onDrop:E(le,["prevent"])},null,40,wt),[[ye,S.value]])]),n("div",$t,[n("label",St,[e[11]||(e[11]=B(" ğŸ“ ",-1)),n("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:oe},null,32)]),n("button",{class:"send-btn",disabled:C.value||!S.value.trim()&&!x.value.length,onClick:L},[C.value?(a(),o("span",Mt)):(a(),o("span",Tt,"â†‘"))],8,It)])]),e[12]||(e[12]=n("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6))}}),Lt=be(Dt,[["__scopeId","data-v-e962abfd"]]);export{Lt as A};
