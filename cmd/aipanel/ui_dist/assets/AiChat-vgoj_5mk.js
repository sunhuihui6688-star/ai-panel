import{d as be,g,h as xe,c as l,n as Ce,q as we,b as n,j as h,t as f,F as w,l as T,a as _,w as M,f as K,m as $e,e as U,N as Q,B as Se,x as Ie,O as B,r as D,o,i as X}from"./index-_eXtwnxf.js";import{n as Te,j as Me}from"./index-sb85_xT4.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ae={key:0,class:"history-loading"},Ne={key:1,class:"chat-empty"},Fe={key:0,class:"welcome-msg"},Le={key:1,class:"examples"},Oe=["onClick"],Be={key:0,class:"msg-row user"},Je={class:"msg-bubble user"},Re={key:0,class:"msg-images"},Ee=["src","onClick"],je={class:"msg-text"},Pe={key:1,class:"msg-row assistant"},He={class:"msg-col"},Ve=["open"],Ke={class:"thinking-summary"},Ue={class:"thinking-len"},ze={class:"thinking-content"},We={class:"msg-bubble assistant"},Ye={class:"tool-details"},qe={class:"tool-summary"},Ge={class:"tool-name"},Qe={key:0,class:"tool-status running"},Xe={key:1,class:"tool-status done"},Ze={key:2,class:"tool-status error"},et={class:"tool-body"},tt={key:0,class:"tool-section"},st={class:"tool-pre"},nt={key:1,class:"tool-section"},ot={class:"tool-pre result"},lt=["innerHTML"],at={key:1,class:"apply-card"},it={class:"apply-preview"},ct={class:"apply-key"},rt={class:"apply-val"},ut=["onClick"],dt={class:"msg-actions"},pt=["onClick","title"],ht=["onClick"],ft=["onClick"],vt={key:1,class:"option-chips"},mt=["onClick"],gt={key:2,class:"msg-row system"},_t={class:"msg-system"},yt={key:2,class:"msg-row assistant"},kt={class:"msg-col"},bt={key:0,class:"thinking-block",open:""},xt={class:"thinking-summary"},Ct={class:"thinking-content"},wt={class:"msg-bubble assistant"},$t={key:0,class:"typing-dots"},St=["innerHTML"],It={key:2,class:"blink"},Tt=["src"],Mt={class:"chat-input-area"},Dt={key:0,class:"attachments-bar"},At=["src"],Nt=["onClick"],Ft={class:"input-row"},Lt={class:"textarea-wrap"},Ot=["placeholder","disabled","onKeydown"],Bt={class:"input-actions"},Jt={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},Rt=["disabled"],Et={key:0,class:"spinner"},jt={key:1},Pt=be({__name:"AiChat",props:{agentId:{},sessionId:{},context:{},scenario:{},skillId:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply","session-change"],setup(y,{expose:Z,emit:ee}){const m=y,J=ee,d=g(m.initialMessages?[...m.initialMessages]:[]),A=g(""),$=g([]),S=g(!1),k=g(""),N=g(""),R=g(null),E=g(""),I=g(m.sessionId),F=g(!1),j=g(),C=g(),te=Ie(()=>({height:m.height??"100%","--bg":m.bgColor??"transparent"}));function b(){B(()=>{j.value&&(j.value.scrollTop=j.value.scrollHeight)})}function se(){C.value&&(C.value.style.height="auto",C.value.style.height=Math.min(C.value.scrollHeight,160)+"px")}function P(t){A.value=t,B(()=>C.value?.focus())}function ne(t){try{return JSON.stringify(JSON.parse(t),null,2)}catch{return t}}function oe(t){navigator.clipboard?.writeText(t);const e=d.value.findIndex(a=>a.text===t);R.value=e,setTimeout(()=>{R.value=null},1500)}function le(t){for(let e=t-1;e>=0;e--){const a=d.value[e];if(a&&a.role==="user"){const i=a.text,u=a.images??[];d.value.splice(e,d.value.length-e),W(i,u);return}}}function ae(t){E.value=t}function Y(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(a,i,u)=>`<pre class="code-block${i?" lang-"+i:""}"><code>${u}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function ie(t){const e=t.split(`
`),a=[],i=/^([ğŸ™ğŸ˜„ğŸŒğŸ›ğŸ“šğŸ¨ğŸ’¼ğŸ¤–âš½ğŸ¯âœ…âŒğŸ”¥ğŸ’¡ğŸğŸš€ğŸŒŸğŸ’ğŸªğŸ­ğŸ¬ğŸ¤]|[\u{1F300}-\u{1FFFF}]|[\u{2600}-\u{27BF}])\s+(.{4,40})/u;for(const u of e){const r=u.replace(/^[-*â€¢]\s*/,"").trim();if(r.match(i)){const O=r.replace(/[ï¼š:ã€‚ï¼Œ,]$/,"").trim();O.length>=5&&a.push(O)}}return a.slice(0,5)}function ce(t){return t?/\{[\s\S]{30,}\}/.test(t)&&(t.includes('"name"')||t.includes('"identity"')||t.includes('"soul"')||t.includes('"IDENTITY"')||t.includes('"SOUL"')):!1}function re(t){const e=q(t.text);console.log("[AiChat] manualApply result:",e),e?(t.applyData=e,B(()=>J("apply",e))):alert("æœªèƒ½ä»æ¶ˆæ¯ä¸­æå–åˆ°é…ç½® JSONï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶")}function q(t){const e=t.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(e?.[1]){const i=H(e[1]);if(i)return i;const u=G(e[1]),r=H(u);if(r)return r}const a=[...t.matchAll(/(\{[^{}]{20,}\})/g)];for(let i=a.length-1;i>=0;i--){const u=a[i]?.[1];if(!u)continue;const r=H(u)??H(G(u));if(r)return r}return null}function H(t){try{const e=JSON.parse(t);if(e&&typeof e=="object"&&!Array.isArray(e)){const a=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(i=>a.includes(i)))return e}}catch{}return null}function G(t){let e="",a=!1,i=!1;for(let u=0;u<t.length;u++){const r=t[u];if(i){e+=r,i=!1;continue}if(r==="\\"&&a){e+=r,i=!0;continue}if(r==='"'){a=!a,e+=r;continue}if(a&&r===`
`){e+="\\n";continue}if(a&&r==="\r"){e+="\\r";continue}e+=r}return e}function ue(t){const e=t.clipboardData?.items;if(e){for(const a of Array.from(e))if(a.type.startsWith("image/")){t.preventDefault();const i=a.getAsFile();i&&z(i)}}}function de(t){const e=t.dataTransfer?.files;if(e)for(const a of Array.from(e))a.type.startsWith("image/")&&z(a)}function pe(t){const e=t.target.files;if(e)for(const a of Array.from(e))z(a)}function z(t){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&$.value.push(e.result)},e.readAsDataURL(t)}function he(t){$.value.splice(t,1)}function V(){const t=A.value.trim(),e=[...$.value];!t&&!e.length||S.value||(A.value="",$.value=[],B(()=>{C.value&&(C.value.style.height="auto")}),J("message",t,e),W(t,e))}function W(t,e,a=!1){a||(d.value.push({role:"user",text:t,images:e.length?e:void 0}),b()),S.value=!0,k.value="",N.value="";const i={role:"assistant",text:"",toolCalls:[]};d.value.push(i),a&&b();const u=d.value.length-1;let r="",L;if(I.value)L=void 0;else{const p=d.value.slice(0,-1).filter(s=>(s.role==="user"||s.role==="assistant")&&s.text).slice(-20).map(s=>({role:s.role,content:s.text}));L=p.length>0?p:void 0}const O={sessionId:I.value,context:m.context,scenario:m.scenario,skillId:m.skillId,images:e.length?e:void 0,history:L};Te(m.agentId,t,p=>{switch(p.type){case"thinking_delta":N.value+=p.text,b();break;case"text":case"text_delta":k.value+=p.text,b();break;case"tool_call":{const s={id:p.tool_call?.id??String(Date.now()),name:p.tool_call?.name??"tool",input:p.tool_call?.input?JSON.stringify(p.tool_call.input):void 0,status:"running"};d.value[u].toolCalls.push(s),r=s.id,b();break}case"tool_result":{const s=d.value[u].toolCalls?.find(v=>v.id===r);s&&(s.result=p.text,s.status="done"),b();break}case"done":case"error":{if(p.type==="done"&&p.sessionId){const c=!I.value;I.value=p.sessionId,c&&J("session-change",p.sessionId)}const s=d.value[u];if(s.text=k.value,s.thinking=N.value||void 0,m.applyable){const c=q(k.value);c?(s.applyData=c,console.log("[AiChat] applyData extracted:",c)):console.log("[AiChat] no applyData found in text length:",k.value.length)}const v=ie(k.value);if(v.length>=2&&(s.options=v),p.type==="error"){s.text=`[é”™è¯¯] ${p.error}`;const c=s.toolCalls?.find(x=>x.status==="running");c&&(c.status="error")}S.value=!1,k.value="",N.value="",J("response",s.text),b();break}}},O)}function fe(){d.value=[]}function ve(t){d.value.push(t),b()}async function me(t){I.value=t,d.value=[],F.value=!0;try{const a=(await Me.get(m.agentId,t)).data.messages??[],i=[];a.some(r=>r.isCompact||r.role==="compaction")&&i.push({role:"system",text:"æ›´æ—©çš„å†…å®¹å·²å‹ç¼©"});for(const r of a)r.role!=="compaction"&&i.push({role:r.role,text:r.text});d.value=i,b()}catch(e){e?.response?.status===404?d.value=[]:(console.error("[AiChat] resumeSession failed",e),d.value=[{role:"system",text:"å†å²åŠ è½½å¤±è´¥ï¼Œç»§ç»­å¯¹è¯ä»å¯æ¥ç»­"}])}finally{F.value=!1}}function ge(){I.value=void 0,d.value=[]}function _e(t){P(t),B(V)}function ye(t){W(t,[],!0)}return Z({clearMessages:fe,appendMessage:ve,sendText:_e,sendSilent:ye,fillInput:P,messages:d,currentSessionId:I,resumeSession:me,startNewSession:ge}),xe(()=>{b()}),(t,e)=>{const a=D("ChatRound"),i=D("el-icon"),u=D("Tools"),r=D("Check"),L=D("CopyDocument"),O=D("Setting"),p=D("Paperclip");return o(),l("div",{class:we(["ai-chat",{compact:y.compact,"has-bg":y.bgColor}]),style:Ce(te.value)},[n("div",{class:"chat-messages",ref_key:"msgListRef",ref:j},[F.value?(o(),l("div",Ae,[...e[3]||(e[3]=[n("div",{class:"history-loading-dots"},[n("span"),n("span"),n("span")],-1),n("div",{class:"history-loading-text"},"åŠ è½½å†å²å¯¹è¯â€¦",-1)])])):h("",!0),!d.value.length&&!F.value?(o(),l("div",Ne,[y.welcomeMessage?(o(),l("div",Fe,f(y.welcomeMessage),1)):h("",!0),y.examples.length?(o(),l("div",Le,[(o(!0),l(w,null,T(y.examples,(s,v)=>(o(),l("div",{key:v,class:"example-chip",onClick:c=>P(s)},f(s),9,Oe))),128))])):h("",!0)])):h("",!0),(o(!0),l(w,null,T(d.value,(s,v)=>(o(),l(w,{key:v},[s.role==="user"?(o(),l("div",Be,[n("div",Je,[s.images?.length?(o(),l("div",Re,[(o(!0),l(w,null,T(s.images,(c,x)=>(o(),l("img",{key:x,src:c,class:"msg-img",onClick:ke=>ae(c)},null,8,Ee))),128))])):h("",!0),n("div",je,f(s.text),1)])])):s.role==="assistant"?(o(),l("div",Pe,[n("div",He,[s.thinking?(o(),l("details",{key:0,class:"thinking-block",open:y.showThinking},[n("summary",Ke,[_(i,{class:"thinking-icon"},{default:M(()=>[_(a)]),_:1}),e[4]||(e[4]=K(" æ€è€ƒè¿‡ç¨‹ ",-1)),n("span",Ue,f(s.thinking.length)+" å­—ç¬¦",1)]),n("pre",ze,f(s.thinking),1)],8,Ve)):h("",!0),n("div",We,[(o(!0),l(w,null,T(s.toolCalls,(c,x)=>(o(),l("div",{key:x,class:"tool-call-block"},[n("details",Ye,[n("summary",qe,[_(i,{class:"tool-icon"},{default:M(()=>[_(u)]),_:1}),n("span",Ge,f(c.name),1),c.status==="running"?(o(),l("span",Qe,"è¿è¡Œä¸­â€¦")):c.status==="done"?(o(),l("span",Xe,"å®Œæˆ")):c.status==="error"?(o(),l("span",Ze,"å¤±è´¥")):h("",!0)]),n("div",et,[c.input?(o(),l("div",tt,[e[5]||(e[5]=n("div",{class:"tool-label"},"è¾“å…¥",-1)),n("pre",st,f(ne(c.input)),1)])):h("",!0),c.result?(o(),l("div",nt,[e[6]||(e[6]=n("div",{class:"tool-label"},"è¾“å‡º",-1)),n("pre",ot,f(c.result.slice(0,800))+f(c.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):h("",!0)])])]))),128)),s.text?(o(),l("div",{key:0,class:"msg-text",innerHTML:Y(s.text)},null,8,lt)):h("",!0),s.applyData&&m.applyable?(o(),l("div",at,[n("div",it,[(o(!0),l(w,null,T(s.applyData,(c,x)=>(o(),l("div",{key:x,class:"apply-row"},[n("span",ct,f(x),1),n("span",rt,f(String(c).slice(0,60))+f(String(c).length>60?"â€¦":""),1)]))),128))]),n("button",{class:"apply-btn",onClick:c=>t.$emit("apply",s.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,ut)])):h("",!0),n("div",dt,[n("button",{class:"act-btn",onClick:c=>oe(s.text),title:R.value===v?"å·²å¤åˆ¶":"å¤åˆ¶"},[R.value===v?(o(),X(i,{key:0},{default:M(()=>[_(r)]),_:1})):(o(),X(i,{key:1},{default:M(()=>[_(L)]),_:1}))],8,pt),n("button",{class:"act-btn",onClick:c=>le(v),title:"é‡è¯•"},"â†º",8,ht),m.applyable&&!s.applyData&&ce(s.text)?(o(),l("button",{key:0,class:"act-btn apply-manual-btn",onClick:c=>re(s),title:"æ£€æµ‹åˆ°é…ç½® JSONï¼Œç‚¹å‡»åº”ç”¨"},[_(i,null,{default:M(()=>[_(O)]),_:1}),e[7]||(e[7]=K(" åº”ç”¨é…ç½® ",-1))],8,ft)):h("",!0)])]),s.options&&s.options.length?(o(),l("div",vt,[(o(!0),l(w,null,T(s.options,(c,x)=>(o(),l("button",{key:x,class:"option-chip",onClick:ke=>P(c)},f(c),9,mt))),128))])):h("",!0)])])):s.role==="system"?(o(),l("div",gt,[n("div",_t,f(s.text),1)])):h("",!0)],64))),128)),S.value?(o(),l("div",yt,[n("div",kt,[N.value&&y.showThinking?(o(),l("details",bt,[n("summary",xt,[_(i,{class:"thinking-icon"},{default:M(()=>[_(a)]),_:1}),e[8]||(e[8]=K(" æ€è€ƒä¸­â€¦ ",-1))]),n("pre",Ct,[K(f(N.value),1),e[9]||(e[9]=n("span",{class:"blink"},"â–Š",-1))])])):h("",!0),n("div",wt,[k.value?(o(),l("div",{key:1,class:"msg-text",innerHTML:Y(k.value)},null,8,St)):(o(),l("div",$t,[...e[10]||(e[10]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])),k.value?(o(),l("span",It,"â–Š")):h("",!0)])])])):h("",!0)],512),E.value?(o(),l("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=s=>E.value="")},[n("img",{src:E.value,class:"img-preview-full"},null,8,Tt)])):h("",!0),n("div",Mt,[$.value.length?(o(),l("div",Dt,[(o(!0),l(w,null,T($.value,(s,v)=>(o(),l("div",{key:v,class:"attach-thumb"},[n("img",{src:s},null,8,At),n("button",{class:"remove-attach",onClick:c=>he(v)},"Ã—",8,Nt)]))),128))])):h("",!0),n("div",Ft,[n("div",Lt,[$e(n("textarea",{ref_key:"inputRef",ref:C,"onUpdate:modelValue":e[1]||(e[1]=s=>A.value=s),placeholder:y.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:S.value||F.value,rows:"1",class:"chat-textarea",onKeydown:[Q(U(V,["ctrl","prevent"]),["enter"]),Q(U(V,["meta","prevent"]),["enter"])],onPaste:ue,onInput:se,onDragover:e[2]||(e[2]=U(()=>{},["prevent"])),onDrop:U(de,["prevent"])},null,40,Ot),[[Se,A.value]])]),n("div",Bt,[n("label",Jt,[_(i,null,{default:M(()=>[_(p)]),_:1}),n("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:pe},null,32)]),n("button",{class:"send-btn",disabled:S.value||F.value||!A.value.trim()&&!$.value.length,onClick:V},[S.value?(o(),l("span",Et)):(o(),l("span",jt,"â†‘"))],8,Rt)])]),e[11]||(e[11]=n("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6)}}}),Ut=De(Pt,[["__scopeId","data-v-e6abec73"]]);export{Ut as A};
