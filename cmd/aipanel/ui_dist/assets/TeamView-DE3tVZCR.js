import{d as he,o as f,c as y,F as J,b as n,t as U,a as l,w as i,k as Ve,U as Se,l as te,q as ke,n as Xe,f as m,x as oe,r as k,h as Te,T as Ye,m as Fe,i as fe,j as H,g as M,E as N,N as Oe,e as Z,p as me,M as ve}from"./index-BMDeUy9G.js";import{r as q}from"./index-B6ZRKErS.js";import{_ as xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe={class:"rel-pair"},We={class:"rel-node"},Ge={class:"rel-node"},je={class:"type-grid"},He=["onClick"],qe={class:"type-card-top"},Ie={class:"type-desc"},Je=he({__name:"RelTypeForm",props:{fromName:{},toName:{},type:{},strength:{},desc:{}},emits:["update:type","update:strength","update:desc"],setup(B){const C=B,F=oe(()=>[{value:"上级",color:"#f56c6c",desc:`${C.toName} 是 ${C.fromName} 的上级，负责领导和管理`},{value:"下级",color:"#e6a23c",desc:`${C.toName} 是 ${C.fromName} 的下级，接受指导和分配任务`},{value:"平级协作",color:"#409eff",desc:`${C.fromName} 与 ${C.toName} 并列合作，地位平等`},{value:"支持",color:"#67c23a",desc:`${C.toName} 为 ${C.fromName} 提供支持和辅助`}]);return(R,d)=>{const L=k("el-icon"),S=k("el-radio-button"),ne=k("el-radio-group"),O=k("el-form-item"),le=k("el-input"),se=k("el-form");return f(),y(J,null,[n("div",Pe,[n("span",We,U(B.fromName),1),l(L,{style:{color:"#c0c4cc","flex-shrink":"0","font-size":"18px"}},{default:i(()=>[l(Ve(Se))]),_:1}),n("span",Ge,U(B.toName),1)]),n("div",je,[(f(!0),y(J,null,te(F.value,x=>(f(),y("div",{key:x.value,class:ke(["type-card",{active:B.type===x.value}]),onClick:P=>R.$emit("update:type",x.value)},[n("div",qe,[n("span",{class:"type-tag",style:Xe({background:x.color+"18",color:x.color})},U(x.value),5)]),n("div",Ie,U(x.desc),1)],10,He))),128))]),l(se,{"label-width":"72px",style:{"margin-top":"16px"}},{default:i(()=>[l(O,{label:"关系强度"},{default:i(()=>[l(ne,{"model-value":B.strength,"onUpdate:modelValue":d[0]||(d[0]=x=>R.$emit("update:strength",x))},{default:i(()=>[l(S,{value:"核心"},{default:i(()=>[...d[2]||(d[2]=[m("核心",-1)])]),_:1}),l(S,{value:"常用"},{default:i(()=>[...d[3]||(d[3]=[m("常用",-1)])]),_:1}),l(S,{value:"偶尔"},{default:i(()=>[...d[4]||(d[4]=[m("偶尔",-1)])]),_:1})]),_:1},8,["model-value"])]),_:1}),l(O,{label:"说明"},{default:i(()=>[l(le,{"model-value":B.desc,"onUpdate:modelValue":d[1]||(d[1]=x=>R.$emit("update:desc",x)),placeholder:"可选备注"},null,8,["model-value"])]),_:1})]),_:1})],64)}}}),pe=xe(Je,[["__scopeId","data-v-0bce55d0"]]),Ke={class:"team-view"},Qe={class:"page-header"},Ze={style:{display:"flex",gap:"8px"}},et={key:0,class:"empty-state"},tt={key:0,class:"connect-banner"},ot={style:{margin:"0 4px"}},nt=["width","height"],lt=["x1","y1","x2","y2"],st=["x1","y1","x2","y2","onClick"],at=["x1","y1","x2","y2","stroke","stroke-width","marker-end"],rt=["x","y","fill"],it=["transform","onMousedown","onClick"],ut={key:0,r:"37",fill:"none",stroke:"#409eff","stroke-width":"2.5","stroke-dasharray":"7,3",class:"selection-ring"},dt={key:1,r:"33",fill:"rgba(64,158,255,0.06)",stroke:"#409eff","stroke-width":"1.5","stroke-opacity":"0.5"},ct=["fill"],ft={"text-anchor":"middle","dominant-baseline":"central",fill:"#fff","font-weight":"700","font-size":"15","font-family":"system-ui, sans-serif"},mt=["fill"],vt={"text-anchor":"middle",y:"46","font-size":"12",fill:"#303133","font-family":"system-ui, sans-serif","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},pt={"text-anchor":"middle",y:"58","font-size":"10",fill:"#909399","font-family":"system-ui, monospace"},yt={key:1,class:"no-edge-hint"},gt={class:"legend"},ht={class:"legend-item"},kt={class:"legend-item"},xt={width:"28",height:"8"},_t=["stroke-width"],I=28,ye=160,ee=90,ge=80,wt=he({__name:"TeamView",setup(B){const C=M(),F=M(),R=M(!1),d=M({nodes:[],edges:[]}),L=M(860),S={核心:4,常用:2.5,偶尔:1.5},ne={上级:"#f56c6c",下级:"#e6a23c",平级协作:"#409eff",支持:"#67c23a"};function O(t){return ne[t]??"#94a3b8"}function le(t){return t==="上级"||t==="下级"}function se(t,e){const r={};t.forEach(u=>{r[u.id]=0});const s=t.length+2;for(let u=0;u<s;u++){let w=!1;for(const h of e){const D=r[h.from]??0,z=r[h.to]??0;if(h.type==="上级"){const E=D-1;z>E&&(r[h.to]=E,w=!0)}else if(h.type==="下级"){const E=D+1;z<E&&(r[h.to]=E,w=!0)}}if(!w)break}const a=Object.values(r),g=a.length?Math.min(...a):0;return t.forEach(u=>{r[u.id]=(r[u.id]??0)-g}),r}const x=oe(()=>se(d.value.nodes,d.value.edges)),P=oe(()=>{const t=Object.values(x.value).reduce((e,r)=>Math.max(e,r),0);return Math.max(600,ee+t*ye+160)}),_e=oe(()=>{const t=d.value.nodes,e=x.value,r=L.value,s={};t.forEach(g=>{const u=e[g.id]??0;s[u]||(s[u]=[]),s[u].push(g.id)});const a={};for(const[g,u]of Object.entries(s)){const w=Number(g),h=ee+w*ye,D=r-ge*2,z=u.length>1?D/(u.length-1):0;u.forEach((E,Y)=>{a[E]={x:Math.round(u.length===1?r/2:ge+Y*z),y:Math.round(h)}})}return a}),K=M({}),_=M(null),Q=M({x:400,y:ee}),W=M(null);function b(t){return K.value[t]??_e.value[t]??{x:L.value/2,y:ee}}function we(t,e){t.preventDefault(),W.value=null;const r=b(e);_.value={id:e,startClientX:t.clientX,startClientY:t.clientY,startNodeX:r.x,startNodeY:r.y,moved:!1},document.addEventListener("mousemove",ae),document.addEventListener("mouseup",re)}function ue(t,e){const r=C.value;if(!r)return{x:t,y:e};const s=r.getBoundingClientRect(),a=s.width>0?L.value/s.width:1,g=s.height>0?P.value/s.height:1;return{x:(t-s.left)*a,y:(e-s.top)*g}}function ae(t){if(C.value&&(Q.value=ue(t.clientX,t.clientY)),!_.value)return;const e=t.clientX-_.value.startClientX,r=t.clientY-_.value.startClientY;if((Math.abs(e)>4||Math.abs(r)>4)&&(_.value.moved=!0),!_.value.moved)return;const a=C.value?.getBoundingClientRect(),g=a&&a.width>0?L.value/a.width:1,u=a&&a.height>0?P.value/a.height:1,w=_.value.startNodeX+e*g,h=_.value.startNodeY+r*u,D=I+4,z=L.value*2-I,E=I+4,Y=P.value-I-24;K.value={...K.value,[_.value.id]:{x:Math.round(Math.max(D,Math.min(z,w))),y:Math.round(Math.max(E,Math.min(Y,h)))}}}function re(){_.value?.moved&&(W.value=_.value.id),_.value=null,document.removeEventListener("mousemove",ae),document.removeEventListener("mouseup",re)}function Ce(t){_.value||(Q.value=ue(t.clientX,t.clientY))}function Me(){v.value=null}const v=M(null);function be(t){if(W.value===t){W.value=null;return}if(W.value=null,!v.value){v.value=t;return}if(v.value===t){v.value=null;return}const e=v.value;v.value=null,Le(e,t)}function A(t,e,r){const s=b(t),a=b(e),g=a.x-s.x,u=a.y-s.y,w=Math.sqrt(g*g+u*u)||1,h=I+3;return r==="start"?{x:s.x+g/w*h,y:s.y+u/w*h}:{x:a.x-g/w*h,y:a.y-u/w*h}}function $e(t){return S[t]??1.5}const de=["#409EFF","#67C23A","#E6A23C","#F56C6C","#7C3AED","#0891B2","#B45309","#64748B"];function Ee(t){let e=0;for(let r=0;r<t.length;r++)e=t.charCodeAt(r)+((e<<5)-e);return de[Math.abs(e)%de.length]??"#409EFF"}function Ne(t){return(t||"?").charAt(0).toUpperCase()}function V(t){return d.value.nodes.find(e=>e.id===t)?.name??t}function Ue(){K.value={},N.success("已重置为自动布局")}const G=M(!1),p=me({from:"",to:"",type:"平级协作",strength:"常用",desc:""}),$=M(!1);function Le(t,e){if(d.value.edges.some(s=>s.from===t&&s.to===e||s.from===e&&s.to===t)){const s=d.value.edges.find(a=>a.from===t&&a.to===e||a.from===e&&a.to===t);ce(s);return}p.from=t,p.to=e,p.type="平级协作",p.strength="常用",p.desc="",G.value=!0}async function De(){if(!$.value){$.value=!0;try{await q.putEdge(p.from,p.to,p.type,p.strength,p.desc),N.success("关系已建立"),G.value=!1,await T()}catch{N.error("保存失败")}finally{$.value=!1}}}const X=M(!1),c=me({from:"",to:"",type:"平级协作",strength:"常用",desc:""});function ce(t){c.from=t.from,c.to=t.to,c.type=t.type,c.strength=t.strength,c.desc=t.label,X.value=!0}async function Re(){if(!$.value){$.value=!0;try{await q.putEdge(c.from,c.to,c.type,c.strength,c.desc),N.success("关系已更新"),X.value=!1,await T()}catch{N.error("保存失败")}finally{$.value=!1}}}async function Ae(){try{await ve.confirm(`删除 ${V(c.from)} ↔ ${V(c.to)} 的关系？`,"删除关系",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"})}catch{return}$.value=!0;try{await q.deleteEdge(c.from,c.to),N.success("关系已删除"),X.value=!1,await T()}catch{N.error("删除失败")}finally{$.value=!1}}async function T(){R.value=!0;try{const t=await q.graph();d.value=t.data}catch{N.error("加载图谱失败")}finally{R.value=!1}}async function ze(){try{await ve.confirm("将清空所有成员的关系，不可恢复。确认吗？","清空所有关系",{confirmButtonText:"确认清空",cancelButtonText:"取消",type:"warning"})}catch{return}try{await q.clearAll(),N.success("已清空所有成员关系"),await T()}catch{N.error("清空失败")}}let ie=null;return Te(()=>{T(),F.value&&(ie=new ResizeObserver(t=>{const e=t[0]?.contentRect.width;e&&e>100&&(L.value=Math.floor(e))}),ie.observe(F.value))}),Ye(()=>{ie?.disconnect(),document.removeEventListener("mousemove",ae),document.removeEventListener("mouseup",re)}),(t,e)=>{const r=k("Grid"),s=k("el-icon"),a=k("el-button"),g=k("Refresh"),u=k("Delete"),w=k("Share"),h=k("Link"),D=k("el-card"),z=k("ArrowUp"),E=k("ArrowDown"),Y=k("el-dialog"),Be=Oe("loading");return f(),y("div",Ke,[n("div",Qe,[e[14]||(e[14]=n("h2",null,"团队关系图谱",-1)),n("div",Ze,[l(a,{size:"small",onClick:Ue},{default:i(()=>[l(s,null,{default:i(()=>[l(r)]),_:1}),e[11]||(e[11]=m(" 整理 ",-1))]),_:1}),l(a,{size:"small",onClick:T},{default:i(()=>[l(s,null,{default:i(()=>[l(g)]),_:1}),e[12]||(e[12]=m(" 刷新 ",-1))]),_:1}),l(a,{size:"small",type:"danger",plain:"",onClick:ze},{default:i(()=>[l(s,null,{default:i(()=>[l(u)]),_:1}),e[13]||(e[13]=m(" 清空关系 ",-1))]),_:1})])]),Fe((f(),fe(D,{class:"graph-card"},{default:i(()=>[!R.value&&!d.value.nodes.length?(f(),y("div",et,[l(s,{style:{"font-size":"64px",color:"#c0c4cc",display:"block",margin:"0 auto 16px"}},{default:i(()=>[l(w)]),_:1}),e[15]||(e[15]=n("p",{style:{color:"#909399","text-align":"center",margin:"0"}},"暂无成员数据",-1))])):(f(),y("div",{key:1,class:"graph-container",ref_key:"graphContainerRef",ref:F},[v.value?(f(),y("div",tt,[l(s,{style:{"margin-right":"6px"}},{default:i(()=>[l(h)]),_:1}),e[17]||(e[17]=m(" 连线模式：已选中 ",-1)),n("strong",ot,U(V(v.value)),1),e[18]||(e[18]=m("，点击另一个成员建立关系 ",-1)),l(a,{size:"small",text:"",style:{"margin-left":"8px"},onClick:e[0]||(e[0]=o=>v.value=null)},{default:i(()=>[...e[16]||(e[16]=[m("取消",-1)])]),_:1})])):H("",!0),(f(),y("svg",{ref_key:"svgRef",ref:C,width:L.value,height:P.value,class:"graph-svg",onMousemove:Ce,onClick:Z(Me,["self"]),style:{display:"block",width:"100%",overflow:"visible"}},[e[20]||(e[20]=n("defs",null,[n("pattern",{id:"smallGrid",width:"20",height:"20",patternUnits:"userSpaceOnUse"},[n("path",{d:"M 20 0 L 0 0 0 20",fill:"none",stroke:"#e8ecf0","stroke-width":"0.5"})]),n("pattern",{id:"grid",width:"100",height:"100",patternUnits:"userSpaceOnUse"},[n("rect",{width:"100",height:"100",fill:"url(#smallGrid)"}),n("path",{d:"M 100 0 L 0 0 0 100",fill:"none",stroke:"#dde1e7","stroke-width":"1"})]),n("marker",{id:"arrow-上级",markerWidth:"10",markerHeight:"10",refX:"9",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse"},[n("path",{d:"M1,2 L1,8 L9,5 z",fill:"#f56c6c","fill-opacity":"0.85"})]),n("marker",{id:"arrow-下级",markerWidth:"10",markerHeight:"10",refX:"9",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse"},[n("path",{d:"M1,2 L1,8 L9,5 z",fill:"#e6a23c","fill-opacity":"0.85"})])],-1)),e[21]||(e[21]=n("rect",{width:"100%",height:"100%",fill:"url(#grid)",rx:"0"},null,-1)),v.value&&!_.value?(f(),y("line",{key:0,x1:b(v.value).x,y1:b(v.value).y,x2:Q.value.x,y2:Q.value.y,stroke:"#409eff","stroke-width":"2","stroke-dasharray":"6,4","stroke-opacity":"0.7","pointer-events":"none"},null,8,lt)):H("",!0),(f(!0),y(J,null,te(d.value.edges,o=>(f(),y("g",{key:`${o.from}|${o.to}`},[n("line",{x1:A(o.from,o.to,"start").x,y1:A(o.from,o.to,"start").y,x2:A(o.from,o.to,"end").x,y2:A(o.from,o.to,"end").y,stroke:"transparent","stroke-width":"14",style:{cursor:"pointer"},onClick:Z(j=>ce(o),["stop"])},null,8,st),n("line",{x1:A(o.from,o.to,"start").x,y1:A(o.from,o.to,"start").y,x2:A(o.from,o.to,"end").x,y2:A(o.from,o.to,"end").y,stroke:O(o.type),"stroke-width":$e(o.strength),"stroke-opacity":"0.7","stroke-linecap":"round","marker-end":le(o.type)?`url(#arrow-${o.type})`:void 0,"pointer-events":"none",class:"graph-edge"},null,8,at),n("text",{x:(b(o.from).x+b(o.to).x)/2,y:(b(o.from).y+b(o.to).y)/2-6,"text-anchor":"middle","font-size":"10",fill:O(o.type),"pointer-events":"none","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},U(o.type),9,rt)]))),128)),(f(!0),y(J,null,te(d.value.nodes,o=>(f(),y("g",{key:o.id,transform:`translate(${b(o.id).x}, ${b(o.id).y})`,class:ke(["graph-node",{"node-selected":v.value===o.id},{"node-target":!!v.value&&v.value!==o.id}]),style:{cursor:"grab"},onMousedown:Z(j=>we(j,o.id),["stop"]),onClick:Z(()=>be(o.id),["stop"])},[v.value===o.id?(f(),y("circle",ut)):v.value?(f(),y("circle",dt)):H("",!0),e[19]||(e[19]=n("circle",{r:"30",fill:"rgba(0,0,0,0.07)",transform:"translate(2,3)"},null,-1)),n("circle",{r:"28",fill:Ee(o.id),stroke:"#fff","stroke-width":"2.5"},null,8,ct),n("text",ft,U(Ne(o.id)),1),n("circle",{cx:"20",cy:"-20",r:"6",fill:o.status==="running"?"#67C23A":"#c0c4cc",stroke:"#fff","stroke-width":"1.5"},null,8,mt),n("text",vt,U(o.name),1),n("text",pt,U(o.id),1)],42,it))),128))],40,nt)),d.value.edges.length?H("",!0):(f(),y("div",yt," 点击任意成员选中，再点击另一个成员即可创建关系连线 "))],512))]),_:1})),[[Be,R.value]]),d.value.nodes.length?(f(),fe(D,{key:0,class:"legend-card"},{default:i(()=>[n("div",gt,[e[24]||(e[24]=n("span",{class:"legend-title"},"布局规则：",-1)),n("span",ht,[l(s,null,{default:i(()=>[l(z)]),_:1}),e[22]||(e[22]=m(" 上方 = 上级",-1))]),e[25]||(e[25]=n("span",{class:"legend-item"},"— 同层 = 平级",-1)),n("span",kt,[l(s,null,{default:i(()=>[l(E)]),_:1}),e[23]||(e[23]=m(" 下方 = 下级",-1))]),e[26]||(e[26]=n("span",{class:"legend-divider"},"|",-1)),e[27]||(e[27]=n("span",{class:"legend-title"},"线粗：",-1)),(f(),y(J,null,te(S,(o,j)=>n("span",{key:j,class:"legend-item"},[(f(),y("svg",xt,[n("line",{x1:"0",y1:"4",x2:"28",y2:"4",stroke:"#64748b","stroke-width":o,"stroke-linecap":"round"},null,8,_t)])),m(" "+U(j),1)])),64)),e[28]||(e[28]=n("span",{class:"legend-divider"},"|",-1)),e[29]||(e[29]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#67C23A"})]),m(" 运行中 ")],-1)),e[30]||(e[30]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#c0c4cc"})]),m(" 空闲 ")],-1))])]),_:1})):H("",!0),l(Y,{modelValue:G.value,"onUpdate:modelValue":e[5]||(e[5]=o=>G.value=o),title:"建立关系",width:"460px","close-on-click-modal":!1},{footer:i(()=>[l(a,{onClick:e[4]||(e[4]=o=>G.value=!1)},{default:i(()=>[...e[31]||(e[31]=[m("取消",-1)])]),_:1}),l(a,{type:"primary",loading:$.value,onClick:De},{default:i(()=>[...e[32]||(e[32]=[m("建立",-1)])]),_:1},8,["loading"])]),default:i(()=>[l(pe,{"from-name":V(p.from),"to-name":V(p.to),type:p.type,"onUpdate:type":e[1]||(e[1]=o=>p.type=o),strength:p.strength,"onUpdate:strength":e[2]||(e[2]=o=>p.strength=o),desc:p.desc,"onUpdate:desc":e[3]||(e[3]=o=>p.desc=o)},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"]),l(Y,{modelValue:X.value,"onUpdate:modelValue":e[10]||(e[10]=o=>X.value=o),title:"编辑关系",width:"460px","close-on-click-modal":!1},{footer:i(()=>[l(a,{type:"danger",plain:"",loading:$.value,onClick:Ae},{default:i(()=>[...e[33]||(e[33]=[m("删除关系",-1)])]),_:1},8,["loading"]),l(a,{onClick:e[9]||(e[9]=o=>X.value=!1)},{default:i(()=>[...e[34]||(e[34]=[m("取消",-1)])]),_:1}),l(a,{type:"primary",loading:$.value,onClick:Re},{default:i(()=>[...e[35]||(e[35]=[m("保存",-1)])]),_:1},8,["loading"])]),default:i(()=>[l(pe,{"from-name":V(c.from),"to-name":V(c.to),type:c.type,"onUpdate:type":e[6]||(e[6]=o=>c.type=o),strength:c.strength,"onUpdate:strength":e[7]||(e[7]=o=>c.strength=o),desc:c.desc,"onUpdate:desc":e[8]||(e[8]=o=>c.desc=o)},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"])])}}}),$t=xe(wt,[["__scopeId","data-v-4c44215e"]]);export{$t as default};
