import{d as Le,h as Se,c as f,b as s,a as o,w as n,m as $e,i as de,j as T,g as V,E as M,r as m,N as Fe,o as d,f as v,t as w,e as j,F as R,l as B,q as Te,x as q,p as ce,M as fe}from"./index-BpJ3CHTQ.js";import{r as X}from"./index-B6ZRKErS.js";import{_ as Xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe={class:"team-view"},Ye={class:"page-header"},Oe={style:{display:"flex",gap:"8px"}},je={key:0,class:"empty-state"},We={key:1,class:"graph-container"},Ge={key:0,class:"connect-banner"},qe={style:{margin:"0 4px"}},He=["height"],Ie=["x1","y1","x2","y2"],Je=["x1","y1","x2","y2","onClick"],Ke=["x1","y1","x2","y2","stroke","stroke-width"],Qe=["x","y","fill"],Ze=["transform","onMousedown","onClick"],et={key:0,r:"37",fill:"none",stroke:"#409eff","stroke-width":"2.5","stroke-dasharray":"7,3",class:"selection-ring"},tt={key:1,r:"33",fill:"rgba(64,158,255,0.06)",stroke:"#409eff","stroke-width":"1.5","stroke-opacity":"0.5"},lt=["fill"],ot={"text-anchor":"middle","dominant-baseline":"central",fill:"#fff","font-weight":"700","font-size":"15","font-family":"system-ui, sans-serif"},nt=["fill"],st={"text-anchor":"middle",y:"46","font-size":"12",fill:"#303133","font-family":"system-ui, sans-serif","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},at={"text-anchor":"middle",y:"58","font-size":"10",fill:"#909399","font-family":"system-ui, monospace"},rt={key:1,class:"no-edge-hint"},it={class:"legend"},ut={class:"legend-item"},dt={class:"legend-item"},ct={width:"28",height:"8"},ft=["stroke-width"],mt={class:"rel-pair"},pt={class:"rel-node"},vt={class:"rel-node"},yt={class:"rel-pair"},gt={class:"rel-node"},_t={class:"rel-node"},P=860,xt=28,me=160,W=90,pe=80,ht=Le({__name:"TeamView",setup(kt){const H=V(),Y=V(!1),x=V({nodes:[],edges:[]}),I={核心:4,常用:2.5,偶尔:1.5},J=["上级","下级","平级协作","支持"],K=["核心","常用","偶尔"],ve={上级:"#f56c6c",下级:"#e6a23c",平级协作:"#409eff",支持:"#67c23a"};function Q(l){return ve[l]??"#94a3b8"}function ye(l,e){const a={};l.forEach(g=>{a[g.id]=0});const r=l.length+2;for(let g=0;g<r;g++){let k=!1;for(const _ of e){const N=a[_.from]??0,L=a[_.to]??0;if(_.type==="上级"){const E=N-1;L>E&&(a[_.to]=E,k=!0)}else if(_.type==="下级"){const E=N+1;L<E&&(a[_.to]=E,k=!0)}}if(!k)break}const i=Object.values(a),y=i.length?Math.min(...i):0;return l.forEach(g=>{a[g.id]=(a[g.id]??0)-y}),a}const Z=q(()=>ye(x.value.nodes,x.value.edges)),ge=q(()=>{const l=Object.values(Z.value).reduce((e,a)=>Math.max(e,a),0);return Math.max(400,W+l*me+160)}),_e=q(()=>{const l=x.value.nodes,e=Z.value,a={};l.forEach(i=>{const y=e[i.id]??0;a[y]||(a[y]=[]),a[y].push(i.id)});const r={};for(const[i,y]of Object.entries(a)){const g=Number(i),k=W+g*me,_=P-pe*2,N=y.length>1?_/(y.length-1):0;y.forEach((L,E)=>{r[L]={x:Math.round(y.length===1?P/2:pe+E*N),y:Math.round(k)}})}return r}),O=V({}),h=V(null),G=V({x:P/2,y:W});function C(l){return O.value[l]??_e.value[l]??{x:P/2,y:W}}function xe(l,e){const a=C(e);h.value={id:e,startClientX:l.clientX,startClientY:l.clientY,startNodeX:a.x,startNodeY:a.y,moved:!1}}function he(l){const e=H.value.getBoundingClientRect();if(G.value={x:l.clientX-e.left,y:l.clientY-e.top},!h.value)return;const a=l.clientX-h.value.startClientX,r=l.clientY-h.value.startClientY;(Math.abs(a)>4||Math.abs(r)>4)&&(h.value.moved=!0),h.value.moved&&(O.value={...O.value,[h.value.id]:{x:h.value.startNodeX+a,y:h.value.startNodeY+r}})}function ke(){h.value=null}function we(){h.value=null}function Ce(){p.value=null}const p=V(null);function be(l){if(h.value?.moved)return;if(!p.value){p.value=l;return}if(p.value===l){p.value=null;return}const e=p.value;p.value=null,De(e,l)}function A(l,e,a){const r=C(l),i=C(e),y=i.x-r.x,g=i.y-r.y,k=Math.sqrt(y*y+g*g)||1,_=xt+3;return a==="start"?{x:r.x+y/k*_,y:r.y+g/k*_}:{x:i.x-y/k*_,y:i.y-g/k*_}}function Ve(l){return I[l]??1.5}const ee=["#409EFF","#67C23A","#E6A23C","#F56C6C","#7C3AED","#0891B2","#B45309","#64748B"];function Me(l){let e=0;for(let a=0;a<l.length;a++)e=l.charCodeAt(a)+((e<<5)-e);return ee[Math.abs(e)%ee.length]??"#409EFF"}function Ee(l){return(l||"?").charAt(0).toUpperCase()}function D(l){return x.value.nodes.find(e=>e.id===l)?.name??l}function Ae(){O.value={},M.success("已重置为自动布局")}const $=V(!1),c=ce({from:"",to:"",type:"平级协作",strength:"常用",desc:""}),b=V(!1);function De(l,e){if(x.value.edges.some(r=>r.from===l&&r.to===e||r.from===e&&r.to===l)){const r=x.value.edges.find(i=>i.from===l&&i.to===e||i.from===e&&i.to===l);te(r);return}c.from=l,c.to=e,c.type="平级协作",c.strength="常用",c.desc="",$.value=!0}async function Ne(){if(!b.value){b.value=!0;try{await X.putEdge(c.from,c.to,c.type,c.strength,c.desc),M.success("关系已建立"),$.value=!1,await z()}catch{M.error("保存失败")}finally{b.value=!1}}}const U=V(!1),u=ce({from:"",to:"",type:"平级协作",strength:"常用",desc:""});function te(l){u.from=l.from,u.to=l.to,u.type=l.type,u.strength=l.strength,u.desc=l.label,U.value=!0}async function Re(){if(!b.value){b.value=!0;try{await X.putEdge(u.from,u.to,u.type,u.strength,u.desc),M.success("关系已更新"),U.value=!1,await z()}catch{M.error("保存失败")}finally{b.value=!1}}}async function Be(){try{await fe.confirm(`删除 ${D(u.from)} ↔ ${D(u.to)} 的关系？`,"删除关系",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"})}catch{return}b.value=!0;try{await X.deleteEdge(u.from,u.to),M.success("关系已删除"),U.value=!1,await z()}catch{M.error("删除失败")}finally{b.value=!1}}async function z(){Y.value=!0;try{const l=await X.graph();x.value=l.data}catch{M.error("加载图谱失败")}finally{Y.value=!1}}async function Ue(){try{await fe.confirm("将清空所有成员的关系，不可恢复。确认吗？","清空所有关系",{confirmButtonText:"确认清空",cancelButtonText:"取消",type:"warning"})}catch{return}try{await X.clearAll(),M.success("已清空所有成员关系"),await z()}catch{M.error("清空失败")}}return Se(z),(l,e)=>{const a=m("Grid"),r=m("el-icon"),i=m("el-button"),y=m("Refresh"),g=m("Delete"),k=m("Share"),_=m("Link"),N=m("el-card"),L=m("ArrowUp"),E=m("ArrowDown"),le=m("ArrowRight"),oe=m("el-option"),ne=m("el-select"),S=m("el-form-item"),se=m("el-radio-button"),ae=m("el-radio-group"),re=m("el-input"),ie=m("el-form"),ue=m("el-dialog"),ze=Fe("loading");return d(),f("div",Pe,[s("div",Ye,[e[14]||(e[14]=s("h2",null,"团队关系图谱",-1)),s("div",Oe,[o(i,{size:"small",onClick:Ae},{default:n(()=>[o(r,null,{default:n(()=>[o(a)]),_:1}),e[11]||(e[11]=v(" 整理 ",-1))]),_:1}),o(i,{size:"small",onClick:z},{default:n(()=>[o(r,null,{default:n(()=>[o(y)]),_:1}),e[12]||(e[12]=v(" 刷新 ",-1))]),_:1}),o(i,{size:"small",type:"danger",plain:"",onClick:Ue},{default:n(()=>[o(r,null,{default:n(()=>[o(g)]),_:1}),e[13]||(e[13]=v(" 清空关系 ",-1))]),_:1})])]),$e((d(),de(N,{class:"graph-card"},{default:n(()=>[!Y.value&&!x.value.nodes.length?(d(),f("div",je,[o(r,{style:{"font-size":"64px",color:"#c0c4cc",display:"block",margin:"0 auto 16px"}},{default:n(()=>[o(k)]),_:1}),e[15]||(e[15]=s("p",{style:{color:"#909399","text-align":"center",margin:"0"}},"暂无成员数据",-1))])):(d(),f("div",We,[p.value?(d(),f("div",Ge,[o(r,{style:{"margin-right":"6px"}},{default:n(()=>[o(_)]),_:1}),e[17]||(e[17]=v(" 连线模式：已选中 ",-1)),s("strong",qe,w(D(p.value)),1),e[18]||(e[18]=v("，点击另一个成员建立关系 ",-1)),o(i,{size:"small",text:"",style:{"margin-left":"8px"},onClick:e[0]||(e[0]=t=>p.value=null)},{default:n(()=>[...e[16]||(e[16]=[v("取消",-1)])]),_:1})])):T("",!0),(d(),f("svg",{ref_key:"svgRef",ref:H,width:P,height:ge.value,class:"graph-svg",onMousemove:he,onMouseup:ke,onMouseleave:we,onClick:j(Ce,["self"])},[p.value?(d(),f("line",{key:0,x1:C(p.value).x,y1:C(p.value).y,x2:G.value.x,y2:G.value.y,stroke:"#409eff","stroke-width":"2","stroke-dasharray":"6,4","stroke-opacity":"0.7","pointer-events":"none"},null,8,Ie)):T("",!0),(d(!0),f(R,null,B(x.value.edges,t=>(d(),f("g",{key:`${t.from}|${t.to}`},[s("line",{x1:A(t.from,t.to,"start").x,y1:A(t.from,t.to,"start").y,x2:A(t.from,t.to,"end").x,y2:A(t.from,t.to,"end").y,stroke:"transparent","stroke-width":"14",style:{cursor:"pointer"},onClick:j(F=>te(t),["stop"])},null,8,Je),s("line",{x1:A(t.from,t.to,"start").x,y1:A(t.from,t.to,"start").y,x2:A(t.from,t.to,"end").x,y2:A(t.from,t.to,"end").y,stroke:Q(t.type),"stroke-width":Ve(t.strength),"stroke-opacity":"0.7","stroke-linecap":"round","pointer-events":"none",class:"graph-edge"},null,8,Ke),s("text",{x:(C(t.from).x+C(t.to).x)/2,y:(C(t.from).y+C(t.to).y)/2-6,"text-anchor":"middle","font-size":"10",fill:Q(t.type),"pointer-events":"none","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},w(t.type),9,Qe)]))),128)),(d(!0),f(R,null,B(x.value.nodes,t=>(d(),f("g",{key:t.id,transform:`translate(${C(t.id).x}, ${C(t.id).y})`,class:Te(["graph-node",{"node-selected":p.value===t.id},{"node-target":!!p.value&&p.value!==t.id}]),style:{cursor:"grab"},onMousedown:j(F=>xe(F,t.id),["stop"]),onClick:j(()=>be(t.id),["stop"])},[p.value===t.id?(d(),f("circle",et)):p.value?(d(),f("circle",tt)):T("",!0),e[19]||(e[19]=s("circle",{r:"30",fill:"rgba(0,0,0,0.07)",transform:"translate(2,3)"},null,-1)),s("circle",{r:"28",fill:Me(t.id),stroke:"#fff","stroke-width":"2.5"},null,8,lt),s("text",ot,w(Ee(t.id)),1),s("circle",{cx:"20",cy:"-20",r:"6",fill:t.status==="running"?"#67C23A":"#c0c4cc",stroke:"#fff","stroke-width":"1.5"},null,8,nt),s("text",st,w(t.name),1),s("text",at,w(t.id),1)],42,Ze))),128))],40,He)),x.value.edges.length?T("",!0):(d(),f("div",rt," 点击任意成员选中，再点击另一个成员即可创建关系连线 "))]))]),_:1})),[[ze,Y.value]]),x.value.nodes.length?(d(),de(N,{key:0,class:"legend-card"},{default:n(()=>[s("div",it,[e[22]||(e[22]=s("span",{class:"legend-title"},"布局规则：",-1)),s("span",ut,[o(r,null,{default:n(()=>[o(L)]),_:1}),e[20]||(e[20]=v(" 上方 = 上级",-1))]),e[23]||(e[23]=s("span",{class:"legend-item"},"— 同层 = 平级",-1)),s("span",dt,[o(r,null,{default:n(()=>[o(E)]),_:1}),e[21]||(e[21]=v(" 下方 = 下级",-1))]),e[24]||(e[24]=s("span",{class:"legend-divider"},"|",-1)),e[25]||(e[25]=s("span",{class:"legend-title"},"线粗：",-1)),(d(),f(R,null,B(I,(t,F)=>s("span",{key:F,class:"legend-item"},[(d(),f("svg",ct,[s("line",{x1:"0",y1:"4",x2:"28",y2:"4",stroke:"#64748b","stroke-width":t,"stroke-linecap":"round"},null,8,ft)])),v(" "+w(F),1)])),64)),e[26]||(e[26]=s("span",{class:"legend-divider"},"|",-1)),e[27]||(e[27]=s("span",{class:"legend-item"},[s("svg",{width:"12",height:"12"},[s("circle",{cx:"6",cy:"6",r:"5",fill:"#67C23A"})]),v(" 运行中 ")],-1)),e[28]||(e[28]=s("span",{class:"legend-item"},[s("svg",{width:"12",height:"12"},[s("circle",{cx:"6",cy:"6",r:"5",fill:"#c0c4cc"})]),v(" 空闲 ")],-1))])]),_:1})):T("",!0),o(ue,{modelValue:$.value,"onUpdate:modelValue":e[5]||(e[5]=t=>$.value=t),title:"建立关系",width:"400px","close-on-click-modal":!1},{footer:n(()=>[o(i,{onClick:e[4]||(e[4]=t=>$.value=!1)},{default:n(()=>[...e[29]||(e[29]=[v("取消",-1)])]),_:1}),o(i,{type:"primary",loading:b.value,onClick:Ne},{default:n(()=>[...e[30]||(e[30]=[v("建立",-1)])]),_:1},8,["loading"])]),default:n(()=>[s("div",mt,[s("span",pt,w(D(c.from)),1),o(r,{style:{color:"#909399","flex-shrink":"0"}},{default:n(()=>[o(le)]),_:1}),s("span",vt,w(D(c.to)),1)]),o(ie,{model:c,"label-width":"80px",style:{"margin-top":"20px"}},{default:n(()=>[o(S,{label:"关系类型"},{default:n(()=>[o(ne,{modelValue:c.type,"onUpdate:modelValue":e[1]||(e[1]=t=>c.type=t),style:{width:"100%"}},{default:n(()=>[(d(),f(R,null,B(J,t=>o(oe,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),o(S,{label:"关系程度"},{default:n(()=>[o(ae,{modelValue:c.strength,"onUpdate:modelValue":e[2]||(e[2]=t=>c.strength=t)},{default:n(()=>[(d(),f(R,null,B(K,t=>o(se,{key:t,value:t},{default:n(()=>[v(w(t),1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue"])]),_:1}),o(S,{label:"说明"},{default:n(()=>[o(re,{modelValue:c.desc,"onUpdate:modelValue":e[3]||(e[3]=t=>c.desc=t),placeholder:"可选描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(ue,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=t=>U.value=t),title:"编辑关系",width:"400px","close-on-click-modal":!1},{footer:n(()=>[o(i,{type:"danger",plain:"",loading:b.value,onClick:Be},{default:n(()=>[...e[31]||(e[31]=[v("删除关系",-1)])]),_:1},8,["loading"]),o(i,{onClick:e[9]||(e[9]=t=>U.value=!1)},{default:n(()=>[...e[32]||(e[32]=[v("取消",-1)])]),_:1}),o(i,{type:"primary",loading:b.value,onClick:Re},{default:n(()=>[...e[33]||(e[33]=[v("保存",-1)])]),_:1},8,["loading"])]),default:n(()=>[s("div",yt,[s("span",gt,w(D(u.from)),1),o(r,{style:{color:"#909399","flex-shrink":"0"}},{default:n(()=>[o(le)]),_:1}),s("span",_t,w(D(u.to)),1)]),o(ie,{model:u,"label-width":"80px",style:{"margin-top":"20px"}},{default:n(()=>[o(S,{label:"关系类型"},{default:n(()=>[o(ne,{modelValue:u.type,"onUpdate:modelValue":e[6]||(e[6]=t=>u.type=t),style:{width:"100%"}},{default:n(()=>[(d(),f(R,null,B(J,t=>o(oe,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),o(S,{label:"关系程度"},{default:n(()=>[o(ae,{modelValue:u.strength,"onUpdate:modelValue":e[7]||(e[7]=t=>u.strength=t)},{default:n(()=>[(d(),f(R,null,B(K,t=>o(se,{key:t,value:t},{default:n(()=>[v(w(t),1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue"])]),_:1}),o(S,{label:"说明"},{default:n(()=>[o(re,{modelValue:u.desc,"onUpdate:modelValue":e[8]||(e[8]=t=>u.desc=t),placeholder:"可选描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Vt=Xe(ht,[["__scopeId","data-v-aa801842"]]);export{Vt as default};
