import{d as He,i as We,c as r,b as s,a,w as n,h as p,l as _,N as Je,e as u,E as g,r as c,o as d,V as xe,F as k,m as L,j as x,U as be,p as Ce,t as i,f as D,J as ke,s as ze,n as Ve,k as z,W as Ke,M as Pe,g as qe,z as Te,R as Oe,u as Ge}from"./index-zUCvzzp9.js";import{b as Qe,l as Ie,i as K}from"./index-BclxA8EE.js";import{_ as Xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ye={class:"chats-page"},Ze={class:"page-header"},et={style:{margin:"0"}},tt={class:"filter-bar"},lt={style:{"font-size":"12px","font-family":"monospace",color:"#606266"}},at={style:{"font-size":"13px",color:"#909399"}},nt={style:{"font-size":"13px"}},st={class:"filter-bar"},ot={style:{display:"flex","flex-direction":"column",gap:"2px"}},it={style:{"font-weight":"500","font-size":"14px"}},dt={style:{"font-size":"12px",color:"#909399"}},ut={style:{"font-size":"13px",color:"#606266"}},rt={style:{"font-size":"13px"}},ct={style:{"font-weight":"600","font-size":"16px"}},pt={style:{"font-size":"12px",color:"#909399","margin-top":"4px"}},ft={key:0,style:{"text-align":"center",padding:"40px"}},vt={key:1,class:"message-list"},mt={class:"msg-avatar"},_t={class:"msg-body"},gt={class:"msg-meta"},yt={class:"msg-role"},ht={class:"msg-time"},wt=["innerHTML"],xt={style:{flex:"1","min-width":"0"}},bt={key:0,style:{display:"flex","align-items":"center",gap:"8px"}},Ct={style:{"font-weight":"600","font-size":"16px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},kt={key:1,style:{display:"flex","align-items":"center",gap:"8px"}},zt={style:{"font-size":"12px",color:"#909399","margin-top":"4px"}},Vt={key:0,style:{"text-align":"center",padding:"40px"}},Tt={key:1,class:"message-list"},It={key:0,class:"compact-marker"},$t={style:{"font-size":"12px",color:"#606266","line-height":"1.6"}},Lt={class:"msg-avatar"},Dt={class:"msg-body"},St={class:"msg-meta"},At={class:"msg-role"},Mt={class:"msg-time"},Nt={key:0,class:"hist-tool-timeline"},Et={class:"hist-tool-icon"},Ut={class:"hist-tool-name"},Rt={key:0,class:"hist-tool-summary"},Ft=["innerHTML"],Bt={style:{display:"flex","justify-content":"flex-end",gap:"10px",padding:"12px 0 0"}},P=50,jt=He({__name:"ChatsView",setup(Ht){const $e=Ge(),q=u([]),y=u(!1),O=u("channel");function ie(){O.value==="channel"?M():B()}const S=u([]),G=u(""),Q=u(""),A=u(""),Le=Te(()=>{let l=S.value;if(A.value){const e=A.value.toLowerCase();l=l.filter(o=>o.channelId.toLowerCase().includes(e)||o.agentName.toLowerCase().includes(e))}return l});async function M(){y.value=!0;try{const l=await Ie.globalList({agentId:G.value||void 0,channelType:Q.value||void 0});S.value=l.data||[]}catch{g.error("åŠ è½½æ¸ é“å¯¹è¯å¤±è´¥")}finally{y.value=!1}}const X=u(!1),Y=u(""),V=u(null),Z=u([]),ee=u(!1),te=u(0),le=u(1);async function de(l){V.value=l,Y.value=`${l.channelType==="telegram"?"Telegram":"Web"} Â· ${l.channelId}`,X.value=!0,le.value=1,await ue(l,1)}async function ue(l,e){ee.value=!0;try{const o=(e-1)*P,m=await Ie.messages(l.agentId,l.channelId,{limit:P,offset:o});Z.value=m.data.messages||[],te.value=m.data.total}catch{g.error("åŠ è½½æ¶ˆæ¯å¤±è´¥")}finally{ee.value=!1}}async function De(l){le.value=l,V.value&&await ue(V.value,l)}const N=u([]),ae=u(0),ne=u(""),E=u(""),U=u("lastAt"),T=u(!1),f=u(null),R=u([]),F=u(!1),I=u(!1),b=u(""),Se=Te(()=>{let l=N.value;if(E.value){const e=E.value.toLowerCase();l=l.filter(o=>(o.title||"").toLowerCase().includes(e)||o.id.toLowerCase().includes(e)||(o.agentName||"").toLowerCase().includes(e))}return U.value==="messageCount"?l=[...l].sort((e,o)=>o.messageCount-e.messageCount):U.value==="tokenEstimate"&&(l=[...l].sort((e,o)=>o.tokenEstimate-e.tokenEstimate)),l});async function B(){y.value=!0;try{const l=await K.list({agentId:ne.value||void 0,limit:200});N.value=l.data.sessions,ae.value=l.data.total}catch(l){g.error("åŠ è½½å¤±è´¥ï¼š"+(l.message||""))}finally{y.value=!1}}async function re(l){f.value=l,T.value=!0,I.value=!1,R.value=[],F.value=!0;try{const e=await K.get(l.agentId,l.id);R.value=e.data.messages}catch(e){g.error("åŠ è½½å¯¹è¯å¤±è´¥ï¼š"+(e.message||""))}finally{F.value=!1}}function ce(l){l&&$e.push(`/agents/${l.agentId}?resumeSession=${l.id}`)}async function Ae(l){try{await K.delete(l.agentId,l.id),g.success("å·²åˆ é™¤"),f.value?.id===l.id&&(T.value=!1),B()}catch(e){g.error("åˆ é™¤å¤±è´¥ï¼š"+(e.message||""))}}function Me(){b.value=f.value?.title||"",I.value=!0}async function pe(){if(f.value)try{await K.rename(f.value.agentId,f.value.id,b.value),f.value.title=b.value;const l=N.value.findIndex(e=>e.id===f.value.id);l>=0&&(N.value[l].title=b.value),I.value=!1,g.success("å·²é‡å‘½å")}catch(l){g.error("ä¿å­˜å¤±è´¥ï¼š"+(l.message||""))}}function Ne({row:l}){return f.value?.id===l.id?"active-row":""}function Ee(l){return{bash:"ğŸ’»",read:"ğŸ“„",write:"âœï¸",list_files:"ğŸ“",agent_spawn:"ğŸš€",agent_list:"ğŸ‘¥",agent_kill:"ğŸ›‘",read_file:"ğŸ“„",write_file:"âœï¸",project_read:"ğŸ“‚",project_write:"âœï¸",web_search:"ğŸ”",web_fetch:"ğŸŒ"}[l]??"ğŸ”§"}function Ue(l,e){try{const o=JSON.parse(e);if(l==="bash"||l==="exec")return(o.command??"").slice(0,40);if(l==="read"||l==="write")return(o.path??o.file_path??"").split("/").pop()??"";if(l==="agent_spawn")return`â†’ ${o.agentId??"?"}: ${(o.task??"").slice(0,30)}â€¦`;if(l==="agent_list")return"";if(l==="web_search")return(o.query??"").slice(0,40)}catch{}return e.slice(0,40)}function $(l){return l?(typeof l=="string"?new Date(l):new Date(l)).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"â€”"}function fe(l){if(!l)return"â€”";const e=typeof l=="string"?new Date(l).getTime():l,o=Date.now()-e;return o<6e4?"åˆšåˆš":o<36e5?`${Math.floor(o/6e4)} åˆ†é’Ÿå‰`:o<864e5?`${Math.floor(o/36e5)} å°æ—¶å‰`:o<7*864e5?`${Math.floor(o/864e5)} å¤©å‰`:$(e)}function ve(l){return l?l>=1e3?`${(l/1e3).toFixed(1)}k`:String(l):"0"}function me(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```[\s\S]*?```/g,e=>`<pre class="code-block">${e.slice(3,-3)}</pre>`).replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>")}return We(async()=>{const l=await Qe.list().catch(()=>({data:[]}));q.value=l.data||[],M()}),(l,e)=>{const o=c("el-icon"),m=c("el-button"),j=c("el-badge"),h=c("el-option"),H=c("el-select"),se=c("el-input"),W=c("el-tag"),v=c("el-table-column"),J=c("el-empty"),_e=c("el-table"),oe=c("el-card"),ge=c("el-tab-pane"),Re=c("el-popconfirm"),Fe=c("el-tabs"),ye=c("el-avatar"),Be=c("el-pagination"),he=c("el-drawer"),je=c("el-divider"),we=Oe("loading");return d(),r("div",Ye,[s("div",Ze,[s("div",null,[s("h2",et,[a(o,{style:{"vertical-align":"-2px","margin-right":"6px"}},{default:n(()=>[a(_(xe))]),_:1}),e[15]||(e[15]=p("å¯¹è¯ç®¡ç†",-1))]),e[16]||(e[16]=s("div",{style:{"font-size":"13px",color:"#909399","margin-top":"4px"}}," è·¨æ‰€æœ‰ AI æˆå‘˜çš„å¯¹è¯è®°å½• ",-1))]),a(m,{onClick:ie,loading:y.value,icon:_(Je)},{default:n(()=>[...e[17]||(e[17]=[p("åˆ·æ–°",-1)])]),_:1},8,["loading","icon"])]),a(Fe,{modelValue:O.value,"onUpdate:modelValue":e[8]||(e[8]=t=>O.value=t),onTabChange:ie},{default:n(()=>[a(ge,{label:"æ¸ é“å¯¹è¯",name:"channel"},{label:n(()=>[e[18]||(e[18]=s("span",null,"æ¸ é“å¯¹è¯",-1)),a(j,{value:S.value.length,hidden:!S.value.length,type:"primary",style:{"margin-left":"6px"}},null,8,["value","hidden"])]),default:n(()=>[s("div",tt,[a(H,{modelValue:G.value,"onUpdate:modelValue":e[0]||(e[0]=t=>G.value=t),placeholder:"å…¨éƒ¨æˆå‘˜",clearable:"",style:{width:"160px"},onChange:M},{default:n(()=>[(d(!0),r(k,null,L(q.value,t=>(d(),x(h,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(H,{modelValue:Q.value,"onUpdate:modelValue":e[1]||(e[1]=t=>Q.value=t),placeholder:"å…¨éƒ¨æ¸ é“ç±»å‹",clearable:"",style:{width:"160px"},onChange:M},{default:n(()=>[a(h,{label:"Telegram",value:"telegram"}),a(h,{label:"Web èŠå¤©é¡µ",value:"web"})]),_:1},8,["modelValue"]),a(se,{modelValue:A.value,"onUpdate:modelValue":e[2]||(e[2]=t=>A.value=t),placeholder:"æœç´¢æ¸ é“ IDâ€¦",clearable:"",style:{width:"200px"},"prefix-icon":_(be)},null,8,["modelValue","prefix-icon"])]),a(oe,{shadow:"never",style:{"margin-top":"12px"}},{default:n(()=>[Ce((d(),x(_e,{data:Le.value,stripe:"",onRowClick:de},{empty:n(()=>[a(J,{description:"æš‚æ— æ¸ é“å¯¹è¯è®°å½•"})]),default:n(()=>[a(v,{label:"AI æˆå‘˜",width:"130"},{default:n(({row:t})=>[a(W,{size:"small",type:"primary",effect:"plain"},{default:n(()=>[p(i(t.agentName),1)]),_:2},1024)]),_:1}),a(v,{label:"æ¸ é“ç±»å‹",width:"110"},{default:n(({row:t})=>[a(W,{type:t.channelType==="telegram"?"success":"warning",size:"small"},{default:n(()=>[p(i(t.channelType==="telegram"?"Telegram":t.channelType==="web"?"Web":t.channelType),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"æ¸ é“ ID","min-width":"200","show-overflow-tooltip":""},{default:n(({row:t})=>[s("span",lt,i(t.channelId),1)]),_:1}),a(v,{label:"æ¶ˆæ¯æ•°",width:"90",align:"center"},{default:n(({row:t})=>[a(j,{value:t.messageCount,type:"info"},null,8,["value"])]),_:1}),a(v,{label:"é¦–æ¡æ¶ˆæ¯",width:"145"},{default:n(({row:t})=>[s("span",at,i($(t.firstAt)),1)]),_:1}),a(v,{label:"æœ€åæ´»è·ƒ",width:"145"},{default:n(({row:t})=>[s("span",nt,i(fe(t.lastAt)),1)]),_:1}),a(v,{label:"æ“ä½œ",width:"80"},{default:n(({row:t})=>[a(m,{size:"small",onClick:D(w=>de(t),["stop"])},{default:n(()=>[...e[19]||(e[19]=[p("æŸ¥çœ‹",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[we,y.value]])]),_:1})]),_:1}),a(ge,{label:"é¢æ¿ä¼šè¯",name:"session"},{label:n(()=>[e[20]||(e[20]=s("span",null,"é¢æ¿ä¼šè¯",-1)),a(j,{value:ae.value,hidden:!ae.value,type:"info",style:{"margin-left":"6px"}},null,8,["value","hidden"])]),default:n(()=>[s("div",st,[a(H,{modelValue:ne.value,"onUpdate:modelValue":e[3]||(e[3]=t=>ne.value=t),placeholder:"å…¨éƒ¨æˆå‘˜",clearable:"",style:{width:"160px"},onChange:B},{default:n(()=>[(d(!0),r(k,null,L(q.value,t=>(d(),x(h,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(se,{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=t=>E.value=t),placeholder:"æœç´¢å¯¹è¯æ ‡é¢˜â€¦",clearable:"",style:{width:"220px"},"prefix-icon":_(be)},null,8,["modelValue","prefix-icon"]),a(H,{modelValue:U.value,"onUpdate:modelValue":e[5]||(e[5]=t=>U.value=t),style:{width:"130px"},onChange:B},{default:n(()=>[a(h,{label:"æœ€è¿‘æ´»è·ƒ",value:"lastAt"}),a(h,{label:"æ¶ˆæ¯æœ€å¤š",value:"messageCount"}),a(h,{label:"Token æœ€å¤š",value:"tokenEstimate"})]),_:1},8,["modelValue"])]),a(oe,{shadow:"never",style:{"margin-top":"12px"}},{default:n(()=>[Ce((d(),x(_e,{data:Se.value,stripe:"","row-class-name":Ne,onRowClick:re,style:{cursor:"pointer"}},{empty:n(()=>[a(J,{description:"æš‚æ— é¢æ¿ä¼šè¯"})]),default:n(()=>[a(v,{label:"å¯¹è¯æ ‡é¢˜","min-width":"220"},{default:n(({row:t})=>[s("div",ot,[s("span",it,i(t.title||"ï¼ˆæ— æ ‡é¢˜ï¼‰"),1),s("span",dt,"ID: "+i(t.id),1)])]),_:1}),a(v,{label:"AI æˆå‘˜",width:"130"},{default:n(({row:t})=>[a(W,{size:"small",type:"primary",effect:"plain"},{default:n(()=>[p(i(t.agentName||t.agentId),1)]),_:2},1024)]),_:1}),a(v,{label:"æ¶ˆæ¯æ•°",width:"90",align:"center"},{default:n(({row:t})=>[a(j,{value:t.messageCount,type:"info"},null,8,["value"])]),_:1}),a(v,{label:"Token ç”¨é‡",width:"130",align:"center"},{default:n(({row:t})=>[a(W,{type:t.tokenEstimate>6e4?"danger":t.tokenEstimate>3e4?"warning":"success",size:"small",effect:"plain"},{default:n(()=>[p(i(ve(t.tokenEstimate)),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"åˆ›å»ºæ—¶é—´",width:"145"},{default:n(({row:t})=>[s("span",ut,i($(t.createdAt)),1)]),_:1}),a(v,{label:"æœ€åæ´»è·ƒ",width:"145"},{default:n(({row:t})=>[s("span",rt,i(fe(t.lastAt)),1)]),_:1}),a(v,{label:"æ“ä½œ",width:"190",onClick:e[7]||(e[7]=D(()=>{},["stop"]))},{default:n(({row:t})=>[a(m,{size:"small",onClick:D(w=>re(t),["stop"])},{default:n(()=>[...e[21]||(e[21]=[p("æŸ¥çœ‹",-1)])]),_:1},8,["onClick"]),a(m,{size:"small",type:"primary",onClick:D(w=>ce(t),["stop"])},{default:n(()=>[...e[22]||(e[22]=[p("ç»§ç»­",-1)])]),_:1},8,["onClick"]),a(Re,{title:"ç¡®è®¤åˆ é™¤æ­¤å¯¹è¯ï¼Ÿ",onConfirm:w=>Ae(t),width:"200"},{reference:n(()=>[a(m,{size:"small",type:"danger",onClick:e[6]||(e[6]=D(()=>{},["stop"]))},{default:n(()=>[...e[23]||(e[23]=[p("åˆ é™¤",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[we,y.value]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(he,{modelValue:X.value,"onUpdate:modelValue":e[9]||(e[9]=t=>X.value=t),title:Y.value,size:"50%",direction:"rtl"},{header:n(()=>[s("div",null,[s("div",ct,i(Y.value),1),s("div",pt,i(V.value?.agentName)+" Â· "+i(V.value?.messageCount)+" æ¡æ¶ˆæ¯ ",1)])]),footer:n(()=>[te.value>P?(d(),x(Be,{key:0,"current-page":le.value,"page-size":P,total:te.value,layout:"prev, pager, next",onCurrentChange:De,small:""},null,8,["current-page","total"])):z("",!0)]),default:n(()=>[ee.value?(d(),r("div",ft,[a(o,{class:"is-loading",style:{"font-size":"32px",color:"#409eff"}},{default:n(()=>[a(_(ke))]),_:1}),e[24]||(e[24]=s("div",{style:{"margin-top":"12px",color:"#909399"}},"åŠ è½½ä¸­â€¦",-1))])):(d(),r("div",vt,[(d(!0),r(k,null,L(Z.value,(t,w)=>(d(),r("div",{key:w,class:ze(["message-item",`msg-${t.role}`])},[s("div",mt,[a(ye,{size:32,style:Ve({background:t.role==="user"?"#409eff":"#67c23a"})},{default:n(()=>[p(i(t.role==="user"?"ç”¨":"AI"),1)]),_:2},1032,["style"])]),s("div",_t,[s("div",gt,[s("span",yt,i(t.role==="user"?t.sender||"ç”¨æˆ·":"AI åŠ©æ‰‹"),1),s("span",ht,i($(new Date(t.ts).getTime())),1)]),s("div",{class:"msg-text",innerHTML:me(t.content)},null,8,wt)])],2))),128)),Z.value.length?z("",!0):(d(),x(J,{key:0,description:"æš‚æ— æ¶ˆæ¯"}))]))]),_:1},8,["modelValue","title"]),a(he,{modelValue:T.value,"onUpdate:modelValue":e[14]||(e[14]=t=>T.value=t),title:f.value?.title||"å¯¹è¯è¯¦æƒ…",size:"50%",direction:"rtl"},{header:n(()=>[s("div",xt,[I.value?(d(),r("div",kt,[a(se,{modelValue:b.value,"onUpdate:modelValue":e[10]||(e[10]=t=>b.value=t),size:"small",style:{flex:"1"},onKeyup:qe(pe,["enter"])},null,8,["modelValue"]),a(m,{type:"primary",size:"small",onClick:pe},{default:n(()=>[...e[25]||(e[25]=[p("ä¿å­˜",-1)])]),_:1}),a(m,{size:"small",onClick:e[11]||(e[11]=t=>I.value=!1)},{default:n(()=>[...e[26]||(e[26]=[p("å–æ¶ˆ",-1)])]),_:1})])):(d(),r("div",bt,[s("span",Ct,i(f.value?.title||"ï¼ˆæ— æ ‡é¢˜ï¼‰"),1),a(m,{icon:_(Pe),circle:"",size:"small",onClick:Me},null,8,["icon"])])),s("div",zt,i(f.value?.agentName)+" Â· "+i(f.value?.messageCount??0)+" æ¡æ¶ˆæ¯ Â· "+i(ve(f.value?.tokenEstimate??0))+" tokens ",1)])]),footer:n(()=>[s("div",Bt,[a(m,{onClick:e[12]||(e[12]=t=>T.value=!1)},{default:n(()=>[...e[31]||(e[31]=[p("å…³é—­",-1)])]),_:1}),a(m,{type:"primary",icon:_(xe),onClick:e[13]||(e[13]=t=>ce(f.value)),disabled:!f.value},{default:n(()=>[...e[32]||(e[32]=[p(" ç»§ç»­å¯¹è¯ ",-1)])]),_:1},8,["icon","disabled"])])]),default:n(()=>[F.value?(d(),r("div",Vt,[a(o,{class:"is-loading",style:{"font-size":"32px",color:"#409eff"}},{default:n(()=>[a(_(ke))]),_:1}),e[27]||(e[27]=s("div",{style:{"margin-top":"12px",color:"#909399"}},"åŠ è½½å¯¹è¯å†å²â€¦",-1))])):(d(),r("div",Tt,[(d(!0),r(k,null,L(R.value,(t,w)=>(d(),r("div",{key:w,class:ze(["message-item",`msg-${t.role}`])},[t.isCompact?(d(),r("div",It,[a(je,null,{default:n(()=>[a(o,null,{default:n(()=>[a(_(Ke))]),_:1}),e[28]||(e[28]=s("span",{style:{"margin-left":"6px","font-size":"12px",color:"#909399"}},"ä»¥ä¸Šå†…å®¹å·²å‹ç¼©",-1))]),_:1}),a(oe,{class:"compact-summary",shadow:"never"},{default:n(()=>[s("div",$t,[e[29]||(e[29]=s("strong",null,"æ‘˜è¦ï¼š",-1)),p(i(t.text),1)])]),_:2},1024)])):(d(),r(k,{key:1},[s("div",Lt,[a(ye,{size:32,style:Ve({background:t.role==="user"?"#409eff":"#67c23a"})},{default:n(()=>[p(i(t.role==="user"?"ç”¨":"AI"),1)]),_:2},1032,["style"])]),s("div",Dt,[s("div",St,[s("span",At,i(t.role==="user"?"ç”¨æˆ·":"AI åŠ©æ‰‹"),1),s("span",Mt,i($(t.timestamp)),1)]),t.toolCalls?.length?(d(),r("div",Nt,[(d(!0),r(k,null,L(t.toolCalls,C=>(d(),r("div",{key:C.id,class:"hist-tool-step"},[e[30]||(e[30]=s("span",{class:"hist-tool-dot"},"âœ“",-1)),s("span",Et,i(Ee(C.name)),1),s("code",Ut,i(C.name),1),C.input?(d(),r("span",Rt,i(Ue(C.name,C.input)),1)):z("",!0)]))),128))])):z("",!0),t.text?(d(),r("div",{key:1,class:"msg-text",innerHTML:me(t.text)},null,8,Ft)):z("",!0)])],64))],2))),128)),!R.value.length&&!F.value?(d(),x(J,{key:0,description:"æš‚æ— æ¶ˆæ¯è®°å½•"})):z("",!0)]))]),_:1},8,["modelValue","title"])])}}}),Pt=Xe(jt,[["__scopeId","data-v-2ca1ae7c"]]);export{Pt as default};
