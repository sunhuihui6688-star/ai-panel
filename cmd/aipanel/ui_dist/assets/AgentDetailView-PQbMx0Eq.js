import{d as pt,D as $l,i as mt,o,c as p,b as s,a as e,w as t,k as h,F as D,m as O,s as ul,t as f,j as k,h as i,f as yt,n as Re,p as Ke,G as it,v as Zt,l as S,e as r,z as Vl,E as m,H as ut,r as g,I as ea,A as la,B as nl,J as ta,K as hl,L as dt,M as rt,g as aa,N as na,x as ft,O as sa}from"./index-Dj9IjLKS.js";import{h as sl,f as Y,b as Yl,i as ol,j as il,k as oa,g as Cl,r as vt,e as Q,l as ct}from"./index-CSBCvw1g.js";import{A as gt}from"./AiChat-Dvv_GReB.js";import{_ as _t}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ia={class:"skill-studio"},ua={class:"studio-sidebar"},da={class:"sidebar-top"},ra={class:"sidebar-acts"},fa={class:"skill-list"},va={key:0,class:"list-empty"},ca=["onClick"],pa={class:"sk-icon"},ma={key:0},ya={class:"sk-info"},ga={class:"sk-name"},_a={class:"sk-id"},wa={class:"sk-right"},ba={key:0,class:"sk-streaming-dot",title:"AI 生成中…"},ka={class:"studio-editor"},xa={key:0,class:"editor-empty"},ha={class:"editor-toolbar"},Ca={class:"editor-breadcrumb"},$a={class:"crumb-name"},Va={class:"toolbar-acts"},za={class:"editor-body"},Ta={class:"file-tree"},Sa={class:"tree-title"},La={class:"tree-item tree-dir"},Ia=["onClick"],Ua={key:0,class:"tree-empty"},Da={key:0,class:"file-editor"},Fa={class:"file-editor-head"},Aa={style:{display:"flex","align-items":"center",gap:"10px"}},Na={style:{"font-size":"12px",color:"#909399"}},Ma={class:"json-preview"},Ba={key:1,class:"file-editor"},Pa={class:"file-editor-head"},Ea={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},ja={style:{"font-size":"11px",color:"#c0c4cc"}},Ra={key:2,class:"file-editor"},Ka={class:"file-editor-head"},Wa={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},Oa={style:{"font-size":"11px",color:"#c0c4cc"}},Ya=["placeholder"],Ja={class:"studio-chat"},qa={class:"chat-panel-head"},Ha={key:0,style:{"margin-left":"auto","font-size":"11px",color:"#c0c4cc"}},Ga={key:0,style:{"margin-left":"6px",color:"#e6a23c"}},Qa={class:"chat-wrap"},Xa=pt({__name:"SkillStudio",props:{agentId:{}},setup(Jl){const ie=Jl,_=ie.agentId,W=r([]),ue=r(!1),c=r(null),C=r("meta"),V=r({name:"",icon:"",category:"",description:"",version:"1.0.0",enabled:!0}),F=r(""),Ue=r(!1),ke=r(!1),We=r(!1),De=r(!1),ye=r(!1),X=r([]),Z=r(!1),J=r(""),de=r(!1),q=r(!1),Oe={};function dl(v,u){u?Oe[v]=u:delete Oe[v]}function Fe(v){return v?Oe[v]:null}const xe=r(new Set);function Ae(v,u){const z=new Set(xe.value);u?z.add(v):z.delete(v),xe.value=z}const re=r(new Set);$l(c,async v=>{v&&(re.value.has(v.id)||(re.value.add(v.id),await ut(),await Fe(v.id)?.resumeSession?.(`skill-studio-${v.id}`)))},{flush:"post"});const P=Vl(()=>{if(!c.value)return"你是一个技能配置助手，帮助用户设计和优化 AI 技能的系统提示词。";const v=JSON.stringify({id:c.value.id,name:c.value.name,icon:c.value.icon||"",category:c.value.category||"",description:c.value.description||"",version:c.value.version||"1.0.0",enabled:c.value.enabled,source:"local",installedAt:""},null,2);return`你是一个技能配置助手，正在帮助用户配置技能（ID: ${c.value.id}）。

## ⚠️ 文件路径规则（必须遵守）
所有文件必须在 skills/${c.value.id}/ 目录下：
- ✅ skills/${c.value.id}/SKILL.md
- ✅ skills/${c.value.id}/skill.json
- ✅ skills/${c.value.id}/tools/helper.py
- ❌ 任何其他路径

## ⚠️ 创建或更新技能时，必须同时写两个文件

### 1. skills/${c.value.id}/skill.json（技能元数据）
格式如下，修改 name/icon/category/description 字段：
\`\`\`json
${v}
\`\`\`

### 2. skills/${c.value.id}/SKILL.md（系统提示词）
当前内容：
\`\`\`markdown
${F.value||"（空）"}
\`\`\`

## 你可以帮助：
- 创建/优化技能：同时写 skill.json（名称、分类、描述）和 SKILL.md（提示词）
- 在技能目录下创建工具文件（Python 等）
- 测试技能效果（直接对话即可测试）`}),Ye=Vl(()=>c.value?ye.value?`新技能已创建（ID: ${c.value.id}）。告诉我你想要什么功能，我来帮你生成完整的 SKILL.md 内容，生成后直接点保存即可。`:`当前编辑「${c.value.name}」。你可以让我优化 SKILL.md、测试效果，或者直接对话体验当前技能。`:"选择一个技能后，我可以帮你优化配置、写 SKILL.md、测试效果。"),Je=Vl(()=>c.value?ye.value?[]:[`帮我优化「${c.value.name}」的 SKILL.md`,"这个技能怎么写效果更好？","用中文回答一道历史题，测试当前技能效果"]:["帮我设计一个代码审查技能","帮我写一个翻译助手的 SKILL.md"]);async function fe(){ue.value=!0;try{const v=await sl.list(_);if(W.value=v.data||[],c.value){const u=W.value.find(z=>z.id===c.value.id);u&&(c.value=u,qe(u))}}catch{}finally{ue.value=!1}}function qe(v){V.value={name:v.name,icon:v.icon||"",category:v.category||"",description:v.description||"",version:v.version||"1.0.0",enabled:v.enabled}}async function rl(v){c.value?.id!==v.id&&(c.value=v,qe(v),C.value="meta",ke.value=!1,F.value="",ye.value=!1,ge(),ve())}async function he(){c.value&&C.value!=="prompt"&&(C.value="prompt",F.value||await ve())}async function Ce(v,u,z){const x=await Y.read(_,v),M=Array.isArray(x.data)?x.data:[],H=[];for(const le of M){if(z===0&&le.name==="skill.json")continue;const te=u?`${u}/${le.name}`:le.name;if(H.push({name:le.name,path:te,isDir:le.isDir,depth:z}),le.isDir){const E=await Ce(`skills/${c.value.id}/${te}`,te,z+1);H.push(...E)}}return H}async function ge(){if(c.value){Z.value=!0;try{X.value=await Ce(`skills/${c.value.id}/`,"",0)}catch{X.value=[{name:"SKILL.md",path:"SKILL.md",isDir:!1,depth:0}]}finally{Z.value=!1}}}async function Ne(v,u){if(!u){if(v==="SKILL.md"){await he();return}C.value=v,de.value=!1,await ee()}}async function ee(){if(!(!c.value||!C.value||C.value==="meta"||C.value==="prompt")){q.value=!0;try{const v=await Y.read(_,`skills/${c.value.id}/${C.value}`);J.value=v.data?.content||"",de.value=!1}catch{J.value=""}finally{q.value=!1}}}async function _e(v){if(c.value)try{await Y.delete(_,`skills/${c.value.id}/${v}`),C.value===v&&(C.value="prompt"),await ge(),m.success("已删除")}catch{m.error("删除失败")}}async function He(){if(c.value){We.value=!0;try{C.value==="meta"||C.value==="prompt"?(await sl.update(ie.agentId,c.value.id,{name:V.value.name,icon:V.value.icon,category:V.value.category,description:V.value.description,enabled:V.value.enabled}),(C.value==="prompt"||F.value)&&(await Y.write(_,`skills/${c.value.id}/SKILL.md`,F.value),ke.value=!1),await fe()):(await Y.write(_,`skills/${c.value.id}/${C.value}`,J.value),de.value=!1),m.success("保存成功")}catch(v){m.error(v.response?.data?.error||"保存失败")}finally{We.value=!1}}}async function Ge(v,u){try{await sl.update(ie.agentId,v.id,{enabled:u}),await fe()}catch{m.error("操作失败")}}async function $e(){if(c.value)try{await sl.remove(ie.agentId,c.value.id),m.success("已删除"),c.value=null,await fe()}catch{m.error("删除失败")}}async function Ve(){if(De.value)return;De.value=!0;const v="skill_"+Date.now().toString(36);try{await sl.create(ie.agentId,{meta:{id:v,name:"新技能",icon:"",category:"",description:"",version:"1.0.0",enabled:!1,source:"local",installedAt:""},promptContent:""}),await fe();const u=W.value.find(z=>z.id===v);if(u){await rl(u),C.value="prompt",F.value="",ye.value=!0,await ut(),re.value.has(v)||(re.value.add(v),await Fe(v)?.resumeSession?.(`skill-studio-${v}`));const z=W.value.filter(x=>x.id!==v).map(x=>x.name).join("、")||"暂无";Fe(v)?.sendSilent?.(`【纯文字输出，不使用任何工具，不创建任何文件】当前已有技能：${z}。请推荐3个全新的、与已有技能不重复的技能方向，每条一句话，直接列出即可。`)}}catch(u){m.error(u.response?.data?.error||"创建失败")}finally{De.value=!1}}async function ze(v,u){v===c.value?.id&&(ye.value=!1),await fe(),v===c.value?.id&&(await Promise.all([ge(),ve()]),C.value!=="meta"&&C.value!=="prompt"&&await ee())}async function ve(){if(c.value){Ue.value=!0;try{const v=await Y.read(_,`skills/${c.value.id}/SKILL.md`);F.value=v.data?.content||"",ke.value=!1}catch{F.value=""}finally{Ue.value=!1}}}async function fl(){if(!c.value)return;F.value||await he();const v=`请用「${c.value.name}」技能效果回复：你好，请介绍一下你的功能。`;Fe(c.value?.id)?.fillInput?.(v),m.info("测试消息已填入右侧聊天框，点击发送即可测试")}return mt(fe),(v,u)=>{const z=g("Refresh"),x=g("el-icon"),M=g("el-button"),H=g("Plus"),le=g("Tools"),te=g("el-tag"),E=g("el-switch"),Qe=g("Setting"),A=g("FolderOpened"),zl=g("VideoPlay"),Tl=g("DocumentChecked"),vl=g("Delete"),cl=g("el-popconfirm"),pl=g("Folder"),we=g("Document"),ae=g("el-input"),ne=g("el-form-item"),Te=g("el-col"),Xe=g("el-row"),Se=g("el-collapse-item"),B=g("el-collapse"),Sl=g("el-form"),Ll=g("ChatLineRound");return o(),p("div",ia,[s("div",ua,[s("div",da,[u[13]||(u[13]=s("span",{class:"sidebar-title"},"技能库",-1)),s("div",ra,[e(M,{size:"small",loading:ue.value,circle:"",onClick:fe},{default:t(()=>[e(x,null,{default:t(()=>[e(z)]),_:1})]),_:1},8,["loading"]),e(M,{size:"small",type:"primary",circle:"",loading:De.value,onClick:Ve},{default:t(()=>[e(x,null,{default:t(()=>[e(H)]),_:1})]),_:1},8,["loading"])])]),s("div",fa,[!ue.value&&W.value.length===0?(o(),p("div",va,"暂无技能")):h("",!0),(o(!0),p(D,null,O(W.value,y=>(o(),p("div",{key:y.id,class:ul(["skill-item",{active:c.value?.id===y.id}]),onClick:se=>rl(y)},[s("span",pa,[y.icon?(o(),p("span",ma,f(y.icon),1)):(o(),k(x,{key:1},{default:t(()=>[e(le)]),_:1}))]),s("div",ya,[s("div",ga,f(y.name),1),s("div",_a,f(y.id),1)]),s("div",wa,[xe.value.has(y.id)?(o(),p("span",ba)):y.category?(o(),k(te,{key:1,size:"small",effect:"plain",style:{"margin-right":"6px","font-size":"11px"}},{default:t(()=>[i(f(y.category),1)]),_:2},1024)):h("",!0),e(E,{"model-value":y.enabled,size:"small",onChange:se=>Ge(y,se),onClick:u[0]||(u[0]=yt(()=>{},["stop"]))},null,8,["model-value","onChange"])])],10,ca))),128))])]),s("div",ka,[c.value?(o(),p(D,{key:1},[s("div",ha,[s("div",Ca,[e(x,{style:{color:"#909399"}},{default:t(()=>[e(A)]),_:1}),u[16]||(u[16]=s("span",{class:"crumb-sep"},"skills /",-1)),s("span",$a,f(c.value.id),1)]),s("div",Va,[e(M,{size:"small",onClick:fl},{default:t(()=>[e(x,null,{default:t(()=>[e(zl)]),_:1}),u[17]||(u[17]=i(" 测试 ",-1))]),_:1}),e(M,{size:"small",type:"primary",loading:We.value,onClick:He},{default:t(()=>[e(x,null,{default:t(()=>[e(Tl)]),_:1}),u[18]||(u[18]=i(" 保存 ",-1))]),_:1},8,["loading"]),e(cl,{title:"确认删除该技能？",onConfirm:$e},{reference:t(()=>[e(M,{size:"small",type:"danger",plain:""},{default:t(()=>[e(x,null,{default:t(()=>[e(vl)]),_:1})]),_:1})]),_:1})])]),s("div",za,[s("div",Ta,[s("div",Sa,[u[19]||(u[19]=i(" 目录 ",-1)),e(M,{link:"",size:"small",loading:Z.value,onClick:ge,style:{"margin-left":"auto",padding:"0"}},{default:t(()=>[e(x,null,{default:t(()=>[e(z)]),_:1})]),_:1},8,["loading"])]),s("div",La,[e(x,null,{default:t(()=>[e(pl)]),_:1}),s("span",null,f(c.value.id)+"/",1)]),s("div",{class:ul(["tree-item",{"tree-active":C.value==="meta"}]),onClick:u[1]||(u[1]=y=>C.value="meta")},[e(x,null,{default:t(()=>[e(we)]),_:1}),u[20]||(u[20]=s("span",null,"skill.json",-1))],2),(o(!0),p(D,null,O(X.value,y=>(o(),p("div",{key:y.path,class:ul(["tree-item",{"tree-active":C.value===(y.path==="SKILL.md"?"prompt":y.path),"tree-dir-row":y.isDir}]),style:Re({paddingLeft:`${12+y.depth*12}px`}),onClick:se=>Ne(y.path,y.isDir)},[y.isDir?(o(),k(x,{key:0,style:{color:"#e6a23c"}},{default:t(()=>[e(pl)]),_:1})):(o(),k(x,{key:1},{default:t(()=>[e(we)]),_:1})),s("span",null,f(y.name),1),y.path==="SKILL.md"&&c.value.enabled?(o(),k(te,{key:2,size:"small",type:"success",effect:"plain",style:{"margin-left":"4px","font-size":"10px"}},{default:t(()=>[...u[21]||(u[21]=[i("注入中",-1)])]),_:1})):h("",!0)],14,Ia))),128)),!Z.value&&X.value.length===0?(o(),p("div",Ua,"空目录")):h("",!0)]),C.value==="meta"?(o(),p("div",Da,[s("div",Fa,[e(x,null,{default:t(()=>[e(we)]),_:1}),u[22]||(u[22]=i(" skill.json ",-1)),u[23]||(u[23]=s("span",{class:"file-hint"},"技能元信息，影响列表展示和 runner 行为",-1))]),e(Sl,{model:V.value,"label-width":"72px",size:"small",style:{padding:"16px 20px"}},{default:t(()=>[e(ne,{label:"技能 ID"},{default:t(()=>[e(ae,{value:c.value.id,disabled:""},null,8,["value"])]),_:1}),e(Xe,{gutter:12},{default:t(()=>[e(Te,{span:14},{default:t(()=>[e(ne,{label:"名称"},{default:t(()=>[e(ae,{modelValue:V.value.name,"onUpdate:modelValue":u[2]||(u[2]=y=>V.value.name=y),placeholder:"如 翻译助手"},null,8,["modelValue"])]),_:1})]),_:1}),e(Te,{span:10},{default:t(()=>[e(ne,{label:"图标"},{default:t(()=>[e(ae,{modelValue:V.value.icon,"onUpdate:modelValue":u[3]||(u[3]=y=>V.value.icon=y),placeholder:"emoji"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(Xe,{gutter:12},{default:t(()=>[e(Te,{span:14},{default:t(()=>[e(ne,{label:"分类"},{default:t(()=>[e(ae,{modelValue:V.value.category,"onUpdate:modelValue":u[4]||(u[4]=y=>V.value.category=y),placeholder:"如 语言"},null,8,["modelValue"])]),_:1})]),_:1}),e(Te,{span:10},{default:t(()=>[e(ne,{label:"版本"},{default:t(()=>[e(ae,{modelValue:V.value.version,"onUpdate:modelValue":u[5]||(u[5]=y=>V.value.version=y),placeholder:"1.0.0"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(ne,{label:"描述"},{default:t(()=>[e(ae,{modelValue:V.value.description,"onUpdate:modelValue":u[6]||(u[6]=y=>V.value.description=y),type:"textarea",rows:2,placeholder:"简要描述技能功能"},null,8,["modelValue"])]),_:1}),e(ne,{label:"状态"},{default:t(()=>[s("div",Aa,[e(E,{modelValue:V.value.enabled,"onUpdate:modelValue":u[7]||(u[7]=y=>V.value.enabled=y)},null,8,["modelValue"]),s("span",Na,f(V.value.enabled?"已启用，SKILL.md 将注入系统提示":"已禁用"),1)])]),_:1}),e(B,{style:{"margin-top":"8px"}},{default:t(()=>[e(Se,{title:"查看 skill.json 原文"},{default:t(()=>[s("pre",Ma,f(JSON.stringify({id:c.value.id,...V.value},null,2)),1)]),_:1})]),_:1})]),_:1},8,["model"])])):C.value==="prompt"?(o(),p("div",Ba,[s("div",Pa,[e(x,null,{default:t(()=>[e(we)]),_:1}),u[25]||(u[25]=i(" SKILL.md ",-1)),u[26]||(u[26]=s("span",{class:"file-hint"},"注入到 AI System Prompt 的指令内容",-1)),s("div",Ea,[ke.value?(o(),k(te,{key:0,type:"warning",size:"small"},{default:t(()=>[...u[24]||(u[24]=[i("未保存",-1)])]),_:1})):h("",!0),s("span",ja,f(F.value.length)+" 字符",1),e(M,{size:"small",circle:"",loading:Ue.value,onClick:ve,title:"重新加载"},{default:t(()=>[e(x,null,{default:t(()=>[e(z)]),_:1})]),_:1},8,["loading"])])]),Ke(s("textarea",{"onUpdate:modelValue":u[8]||(u[8]=y=>F.value=y),class:"code-textarea",spellcheck:"false",placeholder:`# 技能名称

## 功能说明
描述该技能的用途…

## 行为规范
- 规范 1
- 规范 2`,onInput:u[9]||(u[9]=y=>ke.value=!0)},null,544),[[it,F.value]])])):(o(),p("div",Ra,[s("div",Ka,[e(x,null,{default:t(()=>[e(we)]),_:1}),i(" "+f(C.value)+" ",1),s("div",Wa,[de.value?(o(),k(te,{key:0,type:"warning",size:"small"},{default:t(()=>[...u[27]||(u[27]=[i("未保存",-1)])]),_:1})):h("",!0),s("span",Oa,f(J.value.length)+" 字符",1),e(M,{size:"small",circle:"",loading:q.value,onClick:ee,title:"重新加载"},{default:t(()=>[e(x,null,{default:t(()=>[e(z)]),_:1})]),_:1},8,["loading"]),e(cl,{title:"确认删除该文件？",onConfirm:u[10]||(u[10]=y=>_e(C.value))},{reference:t(()=>[e(M,{size:"small",circle:"",type:"danger",plain:""},{default:t(()=>[e(x,null,{default:t(()=>[e(vl)]),_:1})]),_:1})]),_:1})])]),Ke(s("textarea",{"onUpdate:modelValue":u[11]||(u[11]=y=>J.value=y),class:"code-textarea",spellcheck:"false",placeholder:`编辑 ${C.value} …`,onInput:u[12]||(u[12]=y=>de.value=!0)},null,40,Ya),[[it,J.value]])]))])],64)):(o(),p("div",xa,[e(x,{size:"48",color:"#c0c4cc"},{default:t(()=>[e(Qe)]),_:1}),u[15]||(u[15]=s("p",null,"从左侧选择一个技能开始编辑",-1)),e(M,{type:"primary",onClick:Ve},{default:t(()=>[e(x,null,{default:t(()=>[e(H)]),_:1}),u[14]||(u[14]=i(" 新建技能",-1))]),_:1})]))]),s("div",Ja,[s("div",qa,[e(x,null,{default:t(()=>[e(Ll)]),_:1}),u[28]||(u[28]=i(" AI 协作配置 ",-1)),c.value?(o(),p("span",Ha,[i(" 当前: "+f(c.value.name)+" ",1),xe.value.size>1?(o(),p("span",Ga," ("+f(xe.value.size)+" 个并行生成中) ",1)):h("",!0)])):h("",!0)]),s("div",Qa,[(o(!0),p(D,null,O(W.value,y=>Ke((o(),k(gt,{key:y.id,ref_for:!0,ref:se=>dl(y.id,se),"agent-id":S(_),context:c.value?.id===y.id?P.value:"",scenario:"skill-studio","skill-id":y.id,"welcome-message":c.value?.id===y.id?Ye.value:"",examples:c.value?.id===y.id?Je.value:[],compact:"",onResponse:se=>ze(y.id),onStreamingChange:se=>Ae(y.id,se)},null,8,["agent-id","context","skill-id","welcome-message","examples","onResponse","onStreamingChange"])),[[Zt,c.value?.id===y.id]])),128))])])])}}}),Za=_t(Xa,[["__scopeId","data-v-3a5bcde8"]]),en={class:"header-left"},ln={class:"chat-layout"},tn={class:"session-sidebar"},an={class:"session-sidebar-header"},nn={class:"session-list"},sn=["onClick"],on={class:"session-item-title"},un={class:"session-item-meta"},dn={key:0,class:"session-empty"},rn={class:"at-panel"},fn={key:0,class:"at-form"},vn={class:"chat-area"},cn={style:{display:"flex","align-items":"center",gap:"8px"}},pn={style:{"font-weight":"600"}},mn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"32px 0","font-size":"14px"}},yn={style:{display:"flex","align-items":"center",gap:"8px"}},gn={style:{"font-size":"13px"}},_n={style:{"font-size":"13px",color:"#606266"}},wn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"40px 0"}},bn={key:1,class:"relations-list"},kn={class:"relation-info"},xn={class:"relation-name"},hn={class:"relation-tags"},Cn={class:"relation-desc"},$n={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Vn={style:{display:"flex",gap:"8px","margin-top":"4px"}},zn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Tn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"16px 0","font-size":"13px"}},Sn={style:{"font-size":"12px"}},Ln={style:{"font-size":"12px",color:"#606266"}},In={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},Un={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},Dn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Fn={style:{"margin-bottom":"16px",display:"flex","align-items":"center",gap:"8px"}},An={class:"conv-drawer-body"},Nn={key:0,style:{"text-align":"center","margin-bottom":"12px"}},Mn={class:"conv-msg-list"},Bn={class:"conv-msg-meta"},Pn={class:"conv-msg-role"},En={key:0,class:"conv-msg-sender"},jn={class:"conv-msg-time"},Rn={class:"conv-msg-content"},Kn={key:0,class:"conv-msg-empty"},Wn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},On={style:{display:"flex",gap:"4px"}},Yn={style:{flex:"1","overflow-y":"auto"}},Jn={style:{display:"flex","align-items":"center",gap:"5px","line-height":"1.8",width:"100%"}},qn={style:{flex:"1",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},Hn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Gn={style:{"font-family":"monospace","font-size":"13px",color:"#606266"}},Qn={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},Xn={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},Zn={class:"channel-card-header"},es={class:"channel-card-left"},ls={class:"channel-card-name"},ts={key:0,class:"channel-bot-username"},as={class:"channel-card-actions"},ns={key:0,class:"channel-card-body"},ss={class:"channel-info-row"},os={class:"channel-info-value"},is={class:"channel-info-row"},us={class:"channel-info-value"},ds={key:1,class:"channel-card-body"},rs={class:"channel-info-row"},fs={class:"channel-info-value"},vs={style:{opacity:"0.6","font-size":"11px","margin-left":"3px"}},cs={class:"pending-section"},ps=["onClick"],ms={key:0,class:"pending-list"},ys={key:0,style:{"text-align":"center",padding:"12px"}},gs={class:"pending-user-info"},_s={class:"pending-user-name"},ws={key:0,class:"pending-user-username"},bs={class:"pending-user-id"},ks={class:"pending-user-actions"},xs={key:2,class:"pending-empty"},hs={style:{width:"100%"}},Cs={style:{display:"flex",gap:"6px","align-items":"center"}},$s={key:0,style:{"margin-top":"6px",display:"flex","align-items":"center",gap:"6px",color:"#909399","font-size":"13px"}},Vs={key:1,style:{"margin-top":"6px",color:"#67c23a","font-size":"13px"}},zs={key:2,style:{"margin-top":"6px",color:"#e6a23c","font-size":"13px"}},Ts={key:3,style:{"margin-top":"6px",color:"#f56c6c","font-size":"13px"}},Ss={key:4,style:{"margin-top":"4px"}},Ls={class:"channel-url-preview"},Is={class:"channel-url-text"},Us={class:"channel-url-preview"},Ds={class:"channel-url-text"},Fs=50,As=pt({__name:"AgentDetailView",setup(Jl){const ie=ea(),_=ie.params.id,W=r(null),ue=r("chat"),c=r(),C=r([]),V=r(!1),F=r();async function Ue(){V.value=!0;try{const n=await oa.list({agentId:_,limit:50});C.value=n.data.sessions}catch{}finally{V.value=!1}}function ke(n){F.value=n.id,c.value?.resumeSession(n.id)}function We(){F.value=void 0,c.value?.startNewSession()}function De(n){F.value=n,setTimeout(Ue,500)}function ye(n){if(!n)return"";const l=Date.now()-n;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分前`:l<864e5?`${Math.floor(l/36e5)}小时前`:`${Math.floor(l/864e5)}天前`}const X=r(!1),Z=r(""),J=r(""),de=r(!1),q=r([]);function Oe(){X.value=!X.value,X.value&&!q.value.length&&dl()}async function dl(){try{const n=await Yl.list();q.value=n.data.filter(l=>l.id!==_)}catch{q.value=[]}}function Fe(n){const l=q.value.find(d=>d.id===n);l&&c.value?.fillInput(`@${l.name}: `)}async function xe(){const n=Z.value,l=J.value.trim();if(!n||!l)return;const $=q.value.find(Le=>Le.id===n)?.name??n;de.value=!0;const j={role:"user",text:`→ 转发给 ${$}：
${l}`};c.value?.appendMessage(j);try{const L=(await Yl.message(n,l,_)).data.response,pe={role:"assistant",text:`← **${$}** 回复：

${L}`};c.value?.appendMessage(pe),J.value="",Z.value="",X.value=!1,m.success(`${$} 已回复`)}catch(Le){const L={role:"system",text:`[失败] 转发失败：${Le.response?.data?.error??Le.message??"网络错误"}`};c.value?.appendMessage(L),m.error("转发失败")}finally{de.value=!1}}const Ae=r(""),re=r(""),P=r({enabled:!1,schedule:"daily",keepTurns:3,focusHint:"",cronJobId:""}),Ye=r(!1),Je=r(!1);async function fe(){try{const n=await Cl.getConfig(_);P.value=n.data,ge()}catch{}}async function qe(){Ye.value=!0;try{const n=await Cl.setConfig(_,P.value);P.value=n.data,m.success(P.value.enabled?"自动记忆已开启":"自动记忆已关闭")}catch{m.error("保存失败")}finally{Ye.value=!1}}async function rl(){Je.value=!0;try{await Cl.consolidate(_),m.success("记忆整理已在后台启动（约需10~30秒），稍后自动刷新日志"),setTimeout(ge,1e4)}catch{m.error("整理失败")}finally{Je.value=!1}}const he=r([]),Ce=r(!1);async function ge(){Ce.value=!0;try{const n=await Cl.runLog(_);he.value=n.data||[]}catch{he.value=[]}finally{Ce.value=!1}}const Ne=r([]),ee=r(""),_e=r(""),He=r(!1),Ge=r([]),$e=r(!1),Ve=r(""),ze=r(!1),ve=r(""),fl=r([]),v=r(""),u=r(""),z=r(null),x=r(!1),M=r(!1),H=r("");function le(n){const l=n.split(".").pop()?.toLowerCase()||"";return["md","txt","rst"].includes(l)?"#409eff":["json","yaml","yml","toml"].includes(l)?"#67c23a":["go","py","js","ts","sh","bash"].includes(l)?"#e6a23c":["jpg","jpeg","png","gif","svg","webp"].includes(l)?"#f56c6c":n.startsWith(".")?"#c0c4cc":"#909399"}function te(n){const l=n.split("/").pop()||n,d=l.split(".").pop()?.toLowerCase()||"";return!d||d===l.toLowerCase()?"file":"."+d}const E=r([]),Qe=r(!1),A=r({agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""});async function zl(){try{const n=await vt.get(_);E.value=n.data.parsed||[]}catch{E.value=[]}}function Tl(n){const l=q.value.find(d=>d.id===n);A.value.agentName=l?l.name:n}async function vl(){if(!A.value.agentId)return;if(E.value.find(l=>l.agentId===A.value.agentId)){m.warning("该成员关系已存在，请先删除再重新添加");return}E.value.push({...A.value}),A.value={agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""},await we()}async function cl(n){E.value.splice(n,1),await we()}function pl(){if(E.value.length===0)return"";const n=`| 成员ID | 成员名称 | 关系类型 | 关系程度 | 说明 |
|--------|--------|--------|--------|------|`,l=E.value.map(d=>`| ${d.agentId} | ${d.agentName} | ${d.relationType} | ${d.strength} | ${d.desc||""} |`).join(`
`);return n+`
`+l}async function we(){Qe.value=!0;try{await vt.put(_,pl()),m.success("关系已保存")}catch{m.error("保存失败")}finally{Qe.value=!1}}function ae(n){const l=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399","#B45309","#7C3AED","#0891B2"];let d=0;for(let $=0;$<n.length;$++)d=n.charCodeAt($)+((d<<5)-d);return l[Math.abs(d)%l.length]??"#409EFF"}function ne(n){return n==="上级"?"danger":n==="下级"?"":n==="平级协作"?"success":"info"}function Te(n){return n==="核心"?"danger":n==="常用"?"warning":"info"}const Xe=r([]),Se=r(!1),B=r({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function Sl(n){return n==="running"?"success":n==="stopped"?"danger":"info"}function Ll(n){return n==="running"?"运行中":n==="stopped"?"已停止":"空闲"}function y(n){return n?n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB":"0 B"}function se(n){return new Date(n).toLocaleString()}function ql(n){return n?new Date(n).toLocaleString():""}const ce=r([]),Il=r(!1),Me=r(!1),oe=r(""),ml=r(""),Ul=r(!1),Dl=r(""),w=r({type:"telegram",name:"",enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""}),I=r({loading:!1,status:""});let Fl=null;function Al(n){return/^\*+$/.test(n)}async function Hl(){const n=w.value.botToken;if(!(!n||Al(n))){I.value={loading:!0,status:""};try{const d=(await Q.checkToken(_,n)).data;d.duplicate?I.value={loading:!1,status:"duplicate",usedBy:d.usedBy,usedByCh:d.usedByCh}:d.valid?(I.value={loading:!1,status:"ok",botName:d.botName},!w.value.name&&d.botName&&(w.value.name=d.botName)):I.value={loading:!1,status:"error",error:d.error||"Token 无效"}}catch{I.value={loading:!1,status:"error",error:"网络错误，请重试"}}}}$l(()=>w.value.type,n=>{oe.value||(ml.value=Nl(n))}),$l(()=>w.value.botToken,n=>{I.value={loading:!1,status:""},Fl&&clearTimeout(Fl),!(!n||Al(n)||n.length<20||!n.includes(":"))&&(Fl=setTimeout(Hl,800))});function Be(n,l){return l?`${window.location.origin}/chat/${n}/${l}`:`${window.location.origin}/chat/${n}`}function Gl(n){navigator.clipboard.writeText(n).then(()=>m.success("链接已复制"))}async function Pe(){Il.value=!0;try{const n=await Q.list(_);ce.value=n.data||[]}catch{ce.value=[]}finally{Il.value=!1}}function Nl(n){return n+"-"+Date.now().toString(36)}function wt(){oe.value="";const n=W.value?.name||"";ml.value=Nl("telegram"),w.value={type:"telegram",name:n,enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""},I.value={loading:!1,status:""},Me.value=!0}function bt(n){oe.value=n.id,w.value={type:n.type,name:n.name,enabled:n.enabled,botToken:n.config?.botToken||"",allowedFrom:n.config?.allowedFrom||"",webPassword:"",webWelcome:n.config?.welcomeMsg||"",webTitle:n.config?.title||""},I.value={loading:!1,status:""},Me.value=!0}async function kt(){if(!w.value.name||!w.value.type){m.warning("请填写名称和类型");return}if(I.value.status==="duplicate"){m.error(`Bot Token 已被成员「${I.value.usedBy}」使用，请更换`);return}Ul.value=!0;try{const n={};if(w.value.type==="telegram"?(w.value.botToken&&(n.botToken=w.value.botToken),w.value.allowedFrom&&(n.allowedFrom=w.value.allowedFrom)):w.value.type==="web"&&(w.value.webPassword&&(n.password=w.value.webPassword),w.value.webWelcome&&(n.welcomeMsg=w.value.webWelcome),w.value.webTitle&&(n.title=w.value.webTitle)),oe.value){const l=ce.value.map(d=>d.id!==oe.value?d:{...d,name:w.value.name,type:w.value.type,enabled:w.value.enabled,config:{...d.config,...n}});await Q.set(_,l)}else{const l={id:ml.value||Nl(w.value.type),name:w.value.name,type:w.value.type,enabled:w.value.enabled,config:n,status:"untested"};await Q.set(_,[...ce.value,l])}m.success(w.value.type==="web"?"保存成功，Web 聊天页立即生效":"保存成功，重启后新渠道生效"),Me.value=!1,await Pe()}catch(n){m.error(n.response?.data?.error||"保存失败")}finally{Ul.value=!1}}async function xt(){try{await Q.set(_,ce.value)}catch(n){m.error(n.response?.data?.error||"保存失败"),await Pe()}}async function ht(n){const l=ce.value.filter(d=>d.id!==n.id);try{await Q.set(_,l),ce.value=l,m.success("已删除")}catch{m.error("删除失败")}}async function Ct(n){Dl.value=n.id;try{const l=await Q.test(_,n.id);l.data.valid?m.success(l.data.botName?`测试成功 (@${l.data.botName})`:"测试成功"):m.error(l.data.error||"测试失败"),await Pe()}catch{m.error("测试请求失败")}finally{Dl.value=""}}const Ee=r({}),Ml=r({}),Ze=r(""),Bl=r("");async function yl(n){Ml.value[n]=!0;try{const l=await Q.listPending(_,n);Ee.value[n]=l.data||[]}catch{Ee.value[n]=[]}finally{Ml.value[n]=!1}}function $t(n){Ze.value===n?Ze.value="":(Ze.value=n,yl(n))}async function Vt(n,l){Bl.value=`${n}-${l}`;try{await Q.allowUser(_,n,l),m.success(`用户 ${l} 已加入白名单`),await yl(n),await Pe()}catch{m.error("操作失败")}finally{Bl.value=""}}async function zt(n,l){try{await Q.dismissUser(_,n,l),m.success("已忽略"),await yl(n)}catch{m.error("操作失败")}}async function Ql(n,l){try{await ft.confirm(`确定将用户 ${l} 从白名单中移除？移除后该用户将无法使用此 Bot。`,"移除白名单",{confirmButtonText:"确认移除",cancelButtonText:"取消",type:"warning"})}catch{return}try{await Q.removeAllowed(_,n,l),m.success(`用户 ${l} 已从白名单移除`),await Pe()}catch{m.error("操作失败")}}mt(async()=>{try{const d=await Yl.get(_);W.value=d.data}catch{m.error("加载 Agent 失败")}Tt(),zl(),dl(),fe(),gl(),_l(),Pe(),await Ue();const n=ie.query.tab;n&&(ue.value=n);const l=ie.query.resumeSession;l&&(F.value=l,await new Promise($=>setTimeout($,100)),c.value?.resumeSession(l),C.value.find($=>$.id===l)||(F.value=l))});async function Tt(){try{const[n,l]=await Promise.all([Y.read(_,"IDENTITY.md"),Y.read(_,"SOUL.md")]);Ae.value=n.data?.content||"",re.value=l.data?.content||""}catch{}el()}async function Pl(n,l){try{await Y.write(_,n,l),m.success(`${n} 已保存`)}catch{m.error(`保存 ${n} 失败`)}}async function el(){try{const n=await ol.tree(_);Ne.value=n.data||[]}catch{Ne.value=[]}}async function St(n){if(!n.isDir){ee.value=n.path,Ge.value=n.path.split("/");try{const l=await ol.readFile(_,n.path);_e.value=l.data?.content||""}catch{_e.value="(无法读取)"}}}async function Lt(){if(ee.value){He.value=!0;try{await ol.writeFile(_,ee.value,_e.value),m.success("记忆文件已保存"),el()}catch{m.error("保存失败")}finally{He.value=!1}}}async function It(){const n=Ve.value.trim();if(!n){m.warning("请输入路径");return}try{await ol.writeFile(_,n,`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`),m.success("文件已创建"),$e.value=!1,Ve.value="",el(),ee.value=n,Ge.value=n.split("/"),_e.value=`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`}catch{m.error("创建失败")}}async function Ut(){const n=ve.value.trim();if(!n){m.warning("请输入内容");return}try{await ol.dailyLog(_,n),m.success("日志已添加"),ze.value=!1,ve.value="",el()}catch{m.error("添加失败")}}async function gl(){try{const n=await Y.readTree(_);Array.isArray(n.data)&&(fl.value=n.data)}catch{}}async function Dt(n){if(!n.isDir){v.value=n.path||n.name,z.value=n,x.value=!1;try{const l=await Y.read(_,v.value);l.data?.encoding==="base64"?(x.value=!0,u.value=`[二进制文件 ${y(l.data.size)}]`):u.value=l.data?.content??""}catch{u.value=""}}}async function Ft(){if(v.value)try{await ft.confirm(`删除「${v.value}」？此操作不可恢复`,"删除文件",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}),await Y.delete(_,v.value),m.success("已删除"),v.value="",u.value="",z.value=null,gl()}catch(n){n!=="cancel"&&m.error("删除失败")}}async function Xl(){const n=H.value.trim();if(n)try{await Y.write(_,n,""),m.success(`已创建 ${n}`),M.value=!1,H.value="",await gl(),v.value=n,u.value="",z.value=null,x.value=!1}catch{m.error("创建失败")}}async function At(){v.value&&await Pl(v.value,u.value)}async function _l(){try{const n=await il.list(_);Xe.value=n.data||[]}catch{}}async function Nt(){try{await il.create({name:B.value.name,enabled:B.value.enabled,agentId:_,schedule:{kind:"cron",expr:B.value.expr,tz:B.value.tz},payload:{kind:"agentTurn",message:B.value.message},delivery:{mode:"announce"}}),m.success("任务创建成功"),Se.value=!1,_l()}catch(n){m.error(n.response?.data?.error||"创建失败")}}async function Mt(n){try{await il.update(n.id,n)}catch{m.error("更新失败")}}async function Zl(n){try{await il.run(n.id),m.success("已触发运行"),setTimeout(_l,2e3)}catch{m.error("运行失败")}}async function Bt(n){try{await il.delete(n.id),m.success("已删除"),_l()}catch{m.error("删除失败")}}const wl=r(!1),El=r([]),jl=r(!1),Rl=r(""),be=r([]),Kl=r(0),bl=r(0),Pt=Vl(()=>be.value.length<Kl.value),ll=r(!1);async function et(){wl.value=!0;try{const n=await ct.list(_);El.value=n.data}catch{m.error("加载对话渠道失败")}finally{wl.value=!1}}async function Et(n){Rl.value=n.channelId,be.value=[],Kl.value=0,bl.value=0,jl.value=!0,await lt()}async function lt(){ll.value=!0;try{const l=(await ct.messages(_,Rl.value,{limit:Fs,offset:bl.value})).data;Kl.value=l.total,bl.value===0?be.value=l.messages:be.value=[...l.messages,...be.value],bl.value+=l.messages.length}catch{m.error("加载消息失败")}finally{ll.value=!1}}async function jt(){await lt()}return $l(ue,n=>{n==="convlogs"&&El.value.length===0&&et()}),(n,l)=>{const d=g("el-button"),$=g("el-tag"),j=g("el-text"),Le=g("el-header"),L=g("el-option"),pe=g("el-select"),N=g("el-input"),me=g("el-tab-pane"),G=g("el-card"),K=g("el-col"),Ie=g("el-row"),T=g("el-form-item"),je=g("el-form"),tt=g("el-badge"),R=g("el-table-column"),kl=g("el-table"),tl=g("el-switch"),Rt=g("el-input-number"),U=g("el-icon"),at=g("el-tree"),xl=g("el-empty"),nt=g("el-breadcrumb-item"),Kt=g("el-breadcrumb"),al=g("el-dialog"),Wt=g("el-drawer"),Ot=g("Delete"),Yt=g("el-link"),Jt=g("CircleCheck"),qt=g("Warning"),Ht=g("CircleClose"),st=g("InfoFilled"),ot=g("Link"),Gt=g("el-tabs"),Qt=g("el-main"),Xt=g("el-container"),Wl=sa("loading");return o(),k(Xt,{class:"agent-detail"},{default:t(()=>[e(Le,{class:"detail-header"},{default:t(()=>[s("div",en,[e(d,{icon:S(la),onClick:l[0]||(l[0]=a=>n.$router.push("/agents")),circle:""},null,8,["icon"]),s("h2",null,f(W.value?.name||"..."),1),e($,{type:Sl(W.value?.status)},{default:t(()=>[i(f(Ll(W.value?.status)),1)]),_:1},8,["type"])]),e(j,{type:"info"},{default:t(()=>[i(f(W.value?.model),1)]),_:1})]),_:1}),e(Qt,null,{default:t(()=>[e(Gt,{modelValue:ue.value,"onUpdate:modelValue":l[49]||(l[49]=a=>ue.value=a),type:"border-card"},{default:t(()=>[e(me,{label:"对话",name:"chat"},{default:t(()=>[s("div",ln,[s("div",tn,[s("div",an,[l[51]||(l[51]=s("span",{class:"sidebar-title"},"历史对话",-1)),e(d,{size:"small",type:"primary",plain:"",onClick:We,icon:S(nl)},{default:t(()=>[...l[50]||(l[50]=[i("新建",-1)])]),_:1},8,["icon"])]),Ke((o(),p("div",nn,[(o(!0),p(D,null,O(C.value,a=>(o(),p("div",{key:a.id,class:ul(["session-item",{active:F.value===a.id}]),onClick:b=>ke(a)},[s("div",on,f(a.title||"新对话"),1),s("div",un,[s("span",null,f(ye(a.lastAt)),1),e($,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[i(f(a.messageCount)+" 条 ",1)]),_:2},1024),a.tokenEstimate>6e4?(o(),k($,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[i("~"+f(Math.round(a.tokenEstimate/1e3))+"k",1)]),_:2},1024)):h("",!0)])],10,sn))),128)),!V.value&&!C.value.length?(o(),p("div",dn," 还没有对话记录 ")):h("",!0)])),[[Wl,V.value]]),s("div",rn,[e(d,{size:"small",plain:"",class:"at-toggle-btn",onClick:Oe},{default:t(()=>[...l[52]||(l[52]=[s("span",{class:"at-icon"},"@",-1),i(" 其他成员 ",-1)])]),_:1}),X.value?(o(),p("div",fn,[e(pe,{modelValue:Z.value,"onUpdate:modelValue":l[1]||(l[1]=a=>Z.value=a),placeholder:"选择成员",size:"small",style:{width:"100%","margin-bottom":"6px"},onChange:Fe},{default:t(()=>[(o(!0),p(D,null,O(q.value,a=>(o(),k(L,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e(N,{modelValue:J.value,"onUpdate:modelValue":l[2]||(l[2]=a=>J.value=a),type:"textarea",rows:3,placeholder:"输入要转发的消息…",size:"small",style:{"margin-bottom":"6px"}},null,8,["modelValue"]),e(d,{type:"primary",size:"small",style:{width:"100%"},loading:de.value,disabled:!Z.value||!J.value.trim(),onClick:xe},{default:t(()=>[...l[53]||(l[53]=[i(" 转发 ",-1)])]),_:1},8,["loading","disabled"])])):h("",!0)])]),s("div",vn,[e(gt,{ref_key:"aiChatRef",ref:c,"agent-id":S(_),scenario:"agent-detail","welcome-message":`你好！我是 **${W.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:De},null,8,["agent-id","welcome-message"])])])]),_:1}),e(me,{label:"身份 & 灵魂",name:"identity"},{default:t(()=>[e(Ie,{gutter:20},{default:t(()=>[e(K,{span:12},{default:t(()=>[e(G,{header:"IDENTITY.md"},{default:t(()=>[e(N,{modelValue:Ae.value,"onUpdate:modelValue":l[3]||(l[3]=a=>Ae.value=a),type:"textarea",rows:15,onBlur:l[4]||(l[4]=a=>Pl("IDENTITY.md",Ae.value))},null,8,["modelValue"])]),_:1})]),_:1}),e(K,{span:12},{default:t(()=>[e(G,{header:"SOUL.md"},{default:t(()=>[e(N,{modelValue:re.value,"onUpdate:modelValue":l[5]||(l[5]=a=>re.value=a),type:"textarea",rows:15,onBlur:l[6]||(l[6]=a=>Pl("SOUL.md",re.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(me,{label:"关系",name:"relations"},{default:t(()=>[e(Ie,{gutter:20},{default:t(()=>[e(K,{span:14},{default:t(()=>[e(G,{style:{"margin-bottom":"16px"}},{header:t(()=>[...l[54]||(l[54]=[s("span",{style:{"font-weight":"600"}},"添加关系",-1)])]),default:t(()=>[e(je,{model:A.value,"label-position":"top",size:"default"},{default:t(()=>[e(Ie,{gutter:12},{default:t(()=>[e(K,{span:10},{default:t(()=>[e(T,{label:"关联成员"},{default:t(()=>[e(pe,{modelValue:A.value.agentId,"onUpdate:modelValue":l[7]||(l[7]=a=>A.value.agentId=a),placeholder:"选择系统成员",filterable:"",style:{width:"100%"},onChange:Tl},{default:t(()=>[(o(!0),p(D,null,O(q.value,a=>(o(),k(L,{key:a.id,label:a.name,value:a.id},{default:t(()=>[s("div",cn,[s("div",{style:Re([{width:"24px",height:"24px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"11px",color:"#fff","flex-shrink":"0"},{background:ae(a.id)}])},f(a.name.charAt(0)),5),s("span",null,f(a.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(K,{span:7},{default:t(()=>[e(T,{label:"关系类型"},{default:t(()=>[e(pe,{modelValue:A.value.relationType,"onUpdate:modelValue":l[8]||(l[8]=a=>A.value.relationType=a),style:{width:"100%"}},{default:t(()=>[e(L,{label:"上级",value:"上级"}),e(L,{label:"下级",value:"下级"}),e(L,{label:"平级协作",value:"平级协作"}),e(L,{label:"支持",value:"支持"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(K,{span:7},{default:t(()=>[e(T,{label:"协作程度"},{default:t(()=>[e(pe,{modelValue:A.value.strength,"onUpdate:modelValue":l[9]||(l[9]=a=>A.value.strength=a),style:{width:"100%"}},{default:t(()=>[e(L,{label:"核心",value:"核心"}),e(L,{label:"常用",value:"常用"}),e(L,{label:"偶尔",value:"偶尔"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(Ie,{gutter:12},{default:t(()=>[e(K,{span:18},{default:t(()=>[e(T,{label:"说明（选填）"},{default:t(()=>[e(N,{modelValue:A.value.desc,"onUpdate:modelValue":l[10]||(l[10]=a=>A.value.desc=a),placeholder:"简要描述这段关系..."},null,8,["modelValue"])]),_:1})]),_:1}),e(K,{span:6},{default:t(()=>[e(T,{label:" "},{default:t(()=>[e(d,{type:"primary",style:{width:"100%"},disabled:!A.value.agentId||!A.value.relationType||!A.value.strength,loading:Qe.value,onClick:vl},{default:t(()=>[...l[55]||(l[55]=[i(" 添加 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(G,null,{header:t(()=>[s("span",pn,[l[56]||(l[56]=i("已有关系 ",-1)),e(tt,{value:E.value.length,type:"info",style:{"margin-left":"4px"}},null,8,["value"])])]),default:t(()=>[E.value.length===0?(o(),p("div",mn," 暂无关系，请在上方添加 ")):(o(),k(kl,{key:1,data:E.value,size:"small",style:{width:"100%"}},{default:t(()=>[e(R,{label:"成员","min-width":"120"},{default:t(({row:a})=>[s("div",yn,[s("div",{style:Re([{width:"28px",height:"28px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"12px",color:"#fff","flex-shrink":"0"},{background:ae(a.agentId)}])},f(a.agentName.charAt(0)),5),s("span",gn,f(a.agentName),1)])]),_:1}),e(R,{label:"类型",width:"100"},{default:t(({row:a})=>[e($,{type:ne(a.relationType),size:"small"},{default:t(()=>[i(f(a.relationType),1)]),_:2},1032,["type"])]),_:1}),e(R,{label:"程度",width:"80"},{default:t(({row:a})=>[e($,{type:Te(a.strength),size:"small",effect:"plain"},{default:t(()=>[i(f(a.strength),1)]),_:2},1032,["type"])]),_:1}),e(R,{label:"说明","min-width":"120","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",_n,f(a.desc||"—"),1)]),_:1}),e(R,{label:"操作",width:"70",fixed:"right"},{default:t(({$index:a})=>[e(d,{type:"danger",link:"",size:"small",onClick:b=>cl(a)},{default:t(()=>[...l[57]||(l[57]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})]),_:1}),e(K,{span:10},{default:t(()=>[e(G,{header:"关系预览"},{default:t(()=>[E.value.length===0?(o(),p("div",wn," 暂无关系数据 ")):(o(),p("div",bn,[(o(!0),p(D,null,O(E.value,a=>(o(),p("div",{key:a.agentId,class:"relation-card"},[s("div",{class:"relation-avatar",style:Re({background:ae(a.agentId)})},f(a.agentName.charAt(0).toUpperCase()),5),s("div",kn,[s("div",xn,f(a.agentName),1),s("div",hn,[e($,{type:ne(a.relationType),size:"small"},{default:t(()=>[i(f(a.relationType),1)]),_:2},1032,["type"]),e($,{type:Te(a.strength),size:"small",effect:"plain"},{default:t(()=>[i(f(a.strength),1)]),_:2},1032,["type"])]),s("div",Cn,f(a.desc),1)])]))),128))]))]),_:1})]),_:1})]),_:1})]),_:1}),e(me,{label:"记忆",name:"memory"},{default:t(()=>[e(G,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",$n,[l[58]||(l[58]=s("span",{style:{"font-weight":"600"}},"自动记忆",-1)),e(tl,{modelValue:P.value.enabled,"onUpdate:modelValue":l[11]||(l[11]=a=>P.value.enabled=a),"active-text":"已开启","inactive-text":"已关闭",onChange:qe},null,8,["modelValue"])])]),default:t(()=>[e(je,{model:P.value,"label-position":"top",size:"small",disabled:!P.value.enabled},{default:t(()=>[e(Ie,{gutter:16},{default:t(()=>[e(K,{span:6},{default:t(()=>[e(T,{label:"整理频率"},{default:t(()=>[e(pe,{modelValue:P.value.schedule,"onUpdate:modelValue":l[12]||(l[12]=a=>P.value.schedule=a),style:{width:"100%"}},{default:t(()=>[e(L,{label:"每小时",value:"hourly"}),e(L,{label:"每6小时",value:"every6h"}),e(L,{label:"每天",value:"daily"}),e(L,{label:"每周",value:"weekly"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(K,{span:5},{default:t(()=>[e(T,{label:"每个会话保留轮数"},{default:t(()=>[e(Rt,{modelValue:P.value.keepTurns,"onUpdate:modelValue":l[13]||(l[13]=a=>P.value.keepTurns=a),min:1,max:20,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(K,{span:13},{default:t(()=>[e(T,{label:"记录重点（留空则自动）"},{default:t(()=>[e(N,{modelValue:P.value.focusHint,"onUpdate:modelValue":l[14]||(l[14]=a=>P.value.focusHint=a),placeholder:"例如：记录数学解题步骤和用户常见错误"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s("div",Vn,[e(d,{type:"primary",size:"small",loading:Ye.value,onClick:qe},{default:t(()=>[...l[59]||(l[59]=[i(" 保存设置 ",-1)])]),_:1},8,["loading"]),e(d,{size:"small",loading:Je.value,onClick:rl},{default:t(()=>[...l[60]||(l[60]=[i(" 立即整理 ",-1)])]),_:1},8,["loading"]),e(j,{type:"info",size:"small",style:{"align-self":"center","margin-left":"4px"}},{default:t(()=>[i(" 整理后：LLM提炼摘要写入 MEMORY.md，每个会话只保留最近 "+f(P.value.keepTurns)+" 轮对话 ",1)]),_:1})])]),_:1},8,["model","disabled"])]),_:1}),e(G,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",zn,[l[62]||(l[62]=s("span",{style:{"font-weight":"600"}},"整理日志",-1)),e(d,{size:"small",text:"",onClick:ge,loading:Ce.value},{default:t(()=>[...l[61]||(l[61]=[i("刷新",-1)])]),_:1},8,["loading"])])]),default:t(()=>[he.value.length===0&&!Ce.value?(o(),p("div",Tn," 暂无运行记录，点击「立即整理」触发第一次 ")):(o(),k(kl,{key:1,data:he.value.slice(0,20),size:"small"},{default:t(()=>[e(R,{label:"时间",width:"160"},{default:t(({row:a})=>[s("span",Sn,f(ql(a.timestamp)),1)]),_:1}),e(R,{label:"状态",width:"72"},{default:t(({row:a})=>[e($,{type:a.status==="ok"?"success":"danger",size:"small"},{default:t(()=>[i(f(a.status),1)]),_:2},1032,["type"])]),_:1}),e(R,{label:"结果","min-width":"200","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",Ln,f(a.message||"—"),1)]),_:1})]),_:1},8,["data"]))]),_:1}),s("div",In,[e(d,{type:"primary",size:"small",onClick:l[15]||(l[15]=a=>$e.value=!0)},{default:t(()=>[e(U,null,{default:t(()=>[e(S(nl))]),_:1}),l[63]||(l[63]=i(" 新建文件 ",-1))]),_:1}),e(d,{size:"small",onClick:l[16]||(l[16]=a=>ze.value=!0)},{default:t(()=>[e(U,null,{default:t(()=>[e(S(ta))]),_:1}),l[64]||(l[64]=i(" 添加日志 ",-1))]),_:1}),e(d,{size:"small",onClick:el},{default:t(()=>[e(U,null,{default:t(()=>[e(S(hl))]),_:1}),l[65]||(l[65]=i(" 刷新 ",-1))]),_:1})]),e(Ie,{gutter:16},{default:t(()=>[e(K,{span:7},{default:t(()=>[e(G,{header:"记忆目录",shadow:"hover"},{default:t(()=>[e(at,{data:Ne.value,props:{label:"name",children:"children",isLeaf:a=>!a.isDir},onNodeClick:St,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:t(({data:a})=>[s("span",Un,[a.isDir?(o(),k(U,{key:0,style:{color:"#E6A23C"}},{default:t(()=>[e(S(dt))]),_:1})):(o(),k(U,{key:1,style:{color:"#409EFF"}},{default:t(()=>[e(S(rt))]),_:1})),s("span",null,f(a.name),1),!a.isDir&&a.size?(o(),k(j,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:t(()=>[i(f(y(a.size)),1)]),_:2},1024)):h("",!0)])]),_:1},8,["data","props"]),Ne.value.length===0?(o(),k(xl,{key:0,description:"记忆树为空","image-size":40})):h("",!0)]),_:1})]),_:1}),e(K,{span:17},{default:t(()=>[e(G,{shadow:"hover"},{header:t(()=>[s("div",Dn,[e(Kt,{separator:"/"},{default:t(()=>[e(nt,null,{default:t(()=>[...l[66]||(l[66]=[i("memory",-1)])]),_:1}),(o(!0),p(D,null,O(Ge.value,(a,b)=>(o(),k(nt,{key:b},{default:t(()=>[i(f(a),1)]),_:2},1024))),128))]),_:1}),ee.value?(o(),k(d,{key:0,type:"primary",size:"small",onClick:Lt,loading:He.value},{default:t(()=>[...l[67]||(l[67]=[i("保存",-1)])]),_:1},8,["loading"])):h("",!0)])]),default:t(()=>[ee.value?(o(),k(N,{key:0,modelValue:_e.value,"onUpdate:modelValue":l[17]||(l[17]=a=>_e.value=a),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(o(),k(xl,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),e(al,{modelValue:$e.value,"onUpdate:modelValue":l[20]||(l[20]=a=>$e.value=a),title:"新建记忆文件",width:"480px"},{footer:t(()=>[e(d,{onClick:l[19]||(l[19]=a=>$e.value=!1)},{default:t(()=>[...l[69]||(l[69]=[i("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:It},{default:t(()=>[...l[70]||(l[70]=[i("创建",-1)])]),_:1})]),default:t(()=>[e(je,{"label-width":"80px"},{default:t(()=>[e(T,{label:"路径"},{default:t(()=>[e(N,{modelValue:Ve.value,"onUpdate:modelValue":l[18]||(l[18]=a=>Ve.value=a),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),e(j,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:t(()=>[...l[68]||(l[68]=[i("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(al,{modelValue:ze.value,"onUpdate:modelValue":l[23]||(l[23]=a=>ze.value=a),title:"添加今日日志",width:"600px"},{footer:t(()=>[e(d,{onClick:l[22]||(l[22]=a=>ze.value=!1)},{default:t(()=>[...l[71]||(l[71]=[i("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:Ut},{default:t(()=>[...l[72]||(l[72]=[i("提交",-1)])]),_:1})]),default:t(()=>[e(N,{modelValue:ve.value,"onUpdate:modelValue":l[21]||(l[21]=a=>ve.value=a),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),e(me,{label:"技能",name:"skills"},{default:t(()=>[e(Za,{"agent-id":S(_)},null,8,["agent-id"])]),_:1}),e(me,{label:"历史对话",name:"convlogs"},{default:t(()=>[s("div",Fn,[l[73]||(l[73]=s("span",{style:{"font-weight":"600","font-size":"15px"}},"渠道对话记录",-1)),e(d,{size:"small",icon:S(hl),circle:"",onClick:et,loading:wl.value},null,8,["icon","loading"])]),Ke((o(),k(kl,{data:El.value,stripe:"","empty-text":"暂无对话记录"},{default:t(()=>[e(R,{label:"渠道","min-width":"200"},{default:t(({row:a})=>[s("span",null,f(a.channelType==="telegram"?"Telegram":"Web")+" "+f(a.channelId),1)]),_:1}),e(R,{label:"消息数",width:"100"},{default:t(({row:a})=>[i(f(a.messageCount)+" 条",1)]),_:1}),e(R,{label:"最后活跃",width:"180"},{default:t(({row:a})=>[i(f(a.lastAt?new Date(a.lastAt).toLocaleString("zh-CN"):"-"),1)]),_:1}),e(R,{label:"操作",width:"100"},{default:t(({row:a})=>[e(d,{size:"small",type:"primary",plain:"",onClick:b=>Et(a)},{default:t(()=>[...l[74]||(l[74]=[i("查看",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Wl,wl.value]]),e(Wt,{modelValue:jl.value,"onUpdate:modelValue":l[24]||(l[24]=a=>jl.value=a),title:Rl.value+" 对话记录",direction:"rtl",size:"520px","destroy-on-close":!1},{default:t(()=>[s("div",An,[Pt.value?(o(),p("div",Nn,[e(d,{size:"small",plain:"",loading:ll.value,onClick:jt},{default:t(()=>[...l[75]||(l[75]=[i("加载更多",-1)])]),_:1},8,["loading"])])):h("",!0),Ke((o(),p("div",Mn,[(o(!0),p(D,null,O(be.value,(a,b)=>(o(),p("div",{key:b,class:ul(["conv-msg-item",a.role==="user"?"conv-msg-user":"conv-msg-assistant"])},[s("div",Bn,[s("span",Pn,f(a.role==="user"?"用户":"助手"),1),a.sender?(o(),p("span",En,f(a.sender),1)):h("",!0),s("span",jn,f(a.ts?new Date(a.ts).toLocaleString("zh-CN"):""),1)]),s("div",Rn,f(a.content),1)],2))),128)),!ll.value&&be.value.length===0?(o(),p("div",Kn," 暂无消息记录 ")):h("",!0)])),[[Wl,ll.value&&be.value.length===0]])])]),_:1},8,["modelValue","title"])]),_:1}),e(me,{label:"工作区",name:"workspace"},{default:t(()=>[e(Ie,{gutter:16},{default:t(()=>[e(K,{span:7},{default:t(()=>[e(G,{shadow:"never",style:{height:"calc(100vh - 200px)",display:"flex","flex-direction":"column"}},{header:t(()=>[s("div",Wn,[l[76]||(l[76]=s("span",null,"文件列表",-1)),s("div",On,[e(d,{text:"",size:"small",onClick:l[25]||(l[25]=a=>M.value=!0),title:"新建文件"},{default:t(()=>[e(U,null,{default:t(()=>[e(S(nl))]),_:1})]),_:1}),e(d,{text:"",size:"small",onClick:gl,title:"刷新"},{default:t(()=>[e(U,null,{default:t(()=>[e(S(hl))]),_:1})]),_:1})])])]),default:t(()=>[s("div",Yn,[e(at,{data:fl.value,props:{label:"name",children:"children"},onNodeClick:Dt,"highlight-current":"","default-expand-all":"",style:{"font-size":"13px"}},{default:t(({data:a})=>[s("span",Jn,[a.isDir?(o(),k(U,{key:0,style:{color:"#e6a23c","font-size":"14px"}},{default:t(()=>[e(S(dt))]),_:1})):(o(),k(U,{key:1,style:Re({color:le(a.name),fontSize:"14px"})},{default:t(()=>[e(S(rt))]),_:1},8,["style"])),s("span",qn,f(a.name),1),a.isDir?h("",!0):(o(),k(j,{key:2,type:"info",size:"small",style:{"flex-shrink":"0","font-size":"11px"}},{default:t(()=>[i(f(y(a.size)),1)]),_:2},1024))])]),_:1},8,["data"])])]),_:1})]),_:1}),e(K,{span:17},{default:t(()=>[e(G,{shadow:"never",style:{height:"calc(100vh - 200px)",display:"flex","flex-direction":"column"}},{header:t(()=>[s("div",Hn,[s("span",Gn,[i(f(v.value||"选择文件查看")+" ",1),v.value?(o(),k($,{key:0,size:"small",style:{"margin-left":"6px","font-size":"11px"}},{default:t(()=>[i(f(te(v.value)),1)]),_:1})):h("",!0)]),v.value?(o(),k(d,{key:0,text:"",size:"small",type:"danger",title:"删除文件",onClick:Ft},{default:t(()=>[e(U,null,{default:t(()=>[e(Ot)]),_:1})]),_:1})):h("",!0)])]),default:t(()=>[v.value?(o(),p(D,{key:0},[e(N,{modelValue:u.value,"onUpdate:modelValue":l[26]||(l[26]=a=>u.value=a),type:"textarea",autosize:!1,placeholder:x.value?"二进制文件，无法编辑":"（空文件）",readonly:x.value,style:{flex:"1","font-family":"monospace","font-size":"13px"},rows:22},null,8,["modelValue","placeholder","readonly"]),s("div",Qn,[e(d,{type:"primary",disabled:x.value,onClick:At},{default:t(()=>[...l[77]||(l[77]=[i("保存",-1)])]),_:1},8,["disabled"]),z.value?(o(),k(j,{key:0,type:"info",size:"small"},{default:t(()=>[i(f(y(z.value.size))+" · "+f(se(z.value.modTime)),1)]),_:1})):h("",!0)])],64)):(o(),k(xl,{key:1,description:"从左侧选择文件","image-size":60}))]),_:1})]),_:1})]),_:1}),e(al,{modelValue:M.value,"onUpdate:modelValue":l[29]||(l[29]=a=>M.value=a),title:"新建文件",width:"400px"},{footer:t(()=>[e(d,{onClick:l[28]||(l[28]=a=>M.value=!1)},{default:t(()=>[...l[78]||(l[78]=[i("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:Xl},{default:t(()=>[...l[79]||(l[79]=[i("创建",-1)])]),_:1})]),default:t(()=>[e(je,{"label-width":"80px"},{default:t(()=>[e(T,{label:"文件路径"},{default:t(()=>[e(N,{modelValue:H.value,"onUpdate:modelValue":l[27]||(l[27]=a=>H.value=a),placeholder:"例如: notes.md 或 idear/my-idea.md",onKeyup:aa(Xl,["enter"])},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(me,{label:"定时任务",name:"cron"},{default:t(()=>[e(d,{type:"primary",onClick:l[30]||(l[30]=a=>Se.value=!0),style:{"margin-bottom":"16px"}},{default:t(()=>[e(U,null,{default:t(()=>[e(S(nl))]),_:1}),l[80]||(l[80]=i(" 新建任务 ",-1))]),_:1}),e(kl,{data:Xe.value,stripe:""},{default:t(()=>[e(R,{prop:"name",label:"名称"}),e(R,{label:"调度"},{default:t(({row:a})=>[i(f(a.schedule?.expr)+" ("+f(a.schedule?.tz)+")",1)]),_:1}),e(R,{label:"最近运行",width:"180"},{default:t(({row:a})=>[a.state?.lastRunAtMs?(o(),p(D,{key:0},[e($,{type:a.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:t(()=>[i(f(a.state?.lastStatus),1)]),_:2},1032,["type"]),e(j,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:t(()=>[i(f(ql(a.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(o(),k(j,{key:1,type:"info",size:"small"},{default:t(()=>[...l[81]||(l[81]=[i("未运行",-1)])]),_:1}))]),_:1}),e(R,{label:"启用",width:"80"},{default:t(({row:a})=>[e(tl,{modelValue:a.enabled,"onUpdate:modelValue":b=>a.enabled=b,onChange:b=>Mt(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(R,{label:"操作",width:"220"},{default:t(({row:a})=>[a.payload?.message==="__MEMORY_CONSOLIDATE__"?(o(),p(D,{key:0},[e($,{type:"info",size:"small",style:{"margin-right":"8px"}},{default:t(()=>[...l[82]||(l[82]=[i("记忆管理",-1)])]),_:1}),e(d,{size:"small",onClick:b=>Zl(a)},{default:t(()=>[...l[83]||(l[83]=[i("立即运行",-1)])]),_:1},8,["onClick"])],64)):(o(),p(D,{key:1},[e(d,{size:"small",onClick:b=>Zl(a)},{default:t(()=>[...l[84]||(l[84]=[i("立即运行",-1)])]),_:1},8,["onClick"]),e(d,{size:"small",type:"danger",onClick:b=>Bt(a)},{default:t(()=>[...l[85]||(l[85]=[i("删除",-1)])]),_:1},8,["onClick"])],64))]),_:1})]),_:1},8,["data"]),e(al,{modelValue:Se.value,"onUpdate:modelValue":l[37]||(l[37]=a=>Se.value=a),title:"新建定时任务",width:"520px"},{footer:t(()=>[e(d,{onClick:l[36]||(l[36]=a=>Se.value=!1)},{default:t(()=>[...l[86]||(l[86]=[i("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:Nt},{default:t(()=>[...l[87]||(l[87]=[i("创建",-1)])]),_:1})]),default:t(()=>[e(je,{model:B.value,"label-width":"100px"},{default:t(()=>[e(T,{label:"名称"},{default:t(()=>[e(N,{modelValue:B.value.name,"onUpdate:modelValue":l[31]||(l[31]=a=>B.value.name=a)},null,8,["modelValue"])]),_:1}),e(T,{label:"Cron 表达式"},{default:t(()=>[e(N,{modelValue:B.value.expr,"onUpdate:modelValue":l[32]||(l[32]=a=>B.value.expr=a),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),e(T,{label:"时区"},{default:t(()=>[e(pe,{modelValue:B.value.tz,"onUpdate:modelValue":l[33]||(l[33]=a=>B.value.tz=a)},{default:t(()=>[e(L,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),e(L,{label:"UTC",value:"UTC"}),e(L,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),e(T,{label:"消息"},{default:t(()=>[e(N,{modelValue:B.value.message,"onUpdate:modelValue":l[34]||(l[34]=a=>B.value.message=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),e(T,{label:"启用"},{default:t(()=>[e(tl,{modelValue:B.value.enabled,"onUpdate:modelValue":l[35]||(l[35]=a=>B.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1}),e(me,{label:"渠道",name:"channels"},{default:t(()=>[s("div",Xn,[e(j,{type:"info",size:"small"},{default:t(()=>[...l[88]||(l[88]=[i("每个 AI 成员独立配置自己的消息通道（如 Telegram Bot Token）",-1)])]),_:1}),e(d,{type:"primary",size:"small",onClick:wt},{default:t(()=>[e(U,null,{default:t(()=>[e(S(nl))]),_:1}),l[89]||(l[89]=i(" 添加消息渠道 ",-1))]),_:1})]),(o(!0),p(D,null,O(ce.value,a=>(o(),p("div",{key:a.id,class:"channel-card"},[s("div",Zn,[s("div",es,[e($,{size:"small",style:{"margin-right":"8px"}},{default:t(()=>[i(f(a.type),1)]),_:2},1024),s("span",ls,f(a.name),1),a.config?.botName?(o(),p("span",ts,"@"+f(a.config.botName),1)):h("",!0),e($,{type:a.status==="ok"?"success":a.status==="error"?"danger":"info",size:"small",effect:"plain",style:{"margin-left":"8px"}},{default:t(()=>[i(f(a.status==="ok"?"✓ 正常":a.status==="error"?"✗ 错误":"未测试"),1)]),_:2},1032,["type"])]),s("div",as,[e(tl,{modelValue:a.enabled,"onUpdate:modelValue":b=>a.enabled=b,size:"small",onChange:xt,style:{"margin-right":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),e(d,{size:"small",onClick:b=>Ct(a),loading:Dl.value===a.id},{default:t(()=>[...l[90]||(l[90]=[i("测试连接",-1)])]),_:1},8,["onClick","loading"]),e(d,{size:"small",onClick:b=>bt(a)},{default:t(()=>[...l[91]||(l[91]=[i("编辑",-1)])]),_:1},8,["onClick"]),e(d,{size:"small",type:"danger",plain:"",onClick:b=>ht(a)},{default:t(()=>[...l[92]||(l[92]=[i("删除",-1)])]),_:1},8,["onClick"])])]),a.type==="web"?(o(),p("div",ns,[s("div",ss,[l[94]||(l[94]=s("span",{class:"channel-info-label"},"公开地址",-1)),s("span",os,[e(Yt,{href:Be(S(_),a.id),target:"_blank",type:"primary",style:{"font-size":"13px"}},{default:t(()=>[i(f(Be(S(_),a.id)),1)]),_:2},1032,["href"]),e(d,{size:"small",link:"",style:{"margin-left":"8px"},onClick:b=>Gl(Be(S(_),a.id))},{default:t(()=>[...l[93]||(l[93]=[i("复制",-1)])]),_:1},8,["onClick"])])]),s("div",is,[l[95]||(l[95]=s("span",{class:"channel-info-label"},"访问密码",-1)),s("span",us,[e($,{size:"small",type:a.config?.password?"warning":"info",effect:"plain"},{default:t(()=>[i(f(a.config?.password?"已设置":"无密码"),1)]),_:2},1032,["type"])])])])):h("",!0),a.type==="telegram"?(o(),p("div",ds,[s("div",rs,[l[97]||(l[97]=s("span",{class:"channel-info-label"},"白名单用户",-1)),s("span",fs,[a.allowedFromUsers?.length?(o(!0),p(D,{key:0},O(a.allowedFromUsers,b=>(o(),k($,{key:b.id,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:Ol=>Ql(a.id,b.id)},{default:t(()=>[i(f(b.username?"@"+b.username:b.firstName||String(b.id))+" ",1),s("span",vs,"("+f(b.id)+")",1)]),_:2},1032,["onClose"]))),128)):a.config?.allowedFrom?(o(!0),p(D,{key:1},O(a.config.allowedFrom.split(","),b=>(o(),k($,{key:b,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:Ol=>Ql(a.id,Number(b.trim()))},{default:t(()=>[i(f(b.trim()),1)]),_:2},1032,["onClose"]))),128)):(o(),k(j,{key:2,type:"warning",size:"small"},{default:t(()=>[...l[96]||(l[96]=[i("未设置（配对模式，向用户返回其 ID）",-1)])]),_:1}))])]),s("div",cs,[s("div",{class:"pending-section-header",onClick:b=>$t(a.id)},[l[99]||(l[99]=s("span",null,"待审核用户",-1)),e(tt,{value:(Ee.value[a.id]||[]).length,hidden:!(Ee.value[a.id]||[]).length,type:"warning",style:{"margin-left":"6px"}},null,8,["value","hidden"]),e(d,{size:"small",link:"",onClick:yt(b=>yl(a.id),["stop"]),style:{"margin-left":"8px"}},{default:t(()=>[...l[98]||(l[98]=[i("刷新",-1)])]),_:1},8,["onClick"]),e(U,{style:Re([{"margin-left":"4px",transition:"transform 0.2s"},{transform:Ze.value===a.id?"rotate(180deg)":""}])},{default:t(()=>[e(S(na))]),_:1},8,["style"])],8,ps),Ze.value===a.id?(o(),p("div",ms,[Ml.value[a.id]?(o(),p("div",ys,[e(j,{type:"info",size:"small"},{default:t(()=>[...l[100]||(l[100]=[i("加载中...",-1)])]),_:1})])):(Ee.value[a.id]||[]).length?(o(!0),p(D,{key:1},O(Ee.value[a.id],b=>(o(),p("div",{key:b.id,class:"pending-user-row"},[s("div",gs,[s("span",_s,f(b.firstName||"未知"),1),b.username?(o(),p("span",ws,"@"+f(b.username),1)):h("",!0),s("span",bs,"ID: "+f(b.id),1),e(j,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:t(()=>[i(f(ye(b.lastSeen)),1)]),_:2},1024)]),s("div",ks,[e(d,{size:"small",type:"success",plain:"",onClick:Ol=>Vt(a.id,b.id),loading:Bl.value===`${a.id}-${b.id}`},{default:t(()=>[...l[101]||(l[101]=[i("加入白名单",-1)])]),_:1},8,["onClick","loading"]),e(d,{size:"small",type:"danger",plain:"",onClick:Ol=>zt(a.id,b.id)},{default:t(()=>[...l[102]||(l[102]=[i("忽略",-1)])]),_:1},8,["onClick"])])]))),128)):(o(),p("div",xs," 暂无待审核用户。让用户向 Bot 发送 /start 即可出现在此处。 "))])):h("",!0)])])):h("",!0)]))),128)),!Il.value&&!ce.value.length?(o(),k(xl,{key:0,description:"暂无消息渠道，点击「添加消息渠道」开始配置","image-size":80,style:{"margin-top":"40px"}})):h("",!0),e(al,{modelValue:Me.value,"onUpdate:modelValue":l[48]||(l[48]=a=>Me.value=a),title:oe.value?"编辑消息渠道":"添加消息渠道",width:"540px"},{footer:t(()=>[e(d,{onClick:l[47]||(l[47]=a=>Me.value=!1)},{default:t(()=>[...l[112]||(l[112]=[i("取消",-1)])]),_:1}),e(d,{type:"primary",onClick:kt,loading:Ul.value},{default:t(()=>[...l[113]||(l[113]=[i("保存",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(je,{model:w.value,"label-width":"120px"},{default:t(()=>[e(T,{label:"类型",required:""},{default:t(()=>[e(pe,{modelValue:w.value.type,"onUpdate:modelValue":l[38]||(l[38]=a=>w.value.type=a),style:{width:"100%"}},{default:t(()=>[e(L,{label:"Telegram",value:"telegram"}),e(L,{label:"Web 聊天页",value:"web"}),e(L,{label:"iMessage",value:"imessage"}),e(L,{label:"WhatsApp",value:"whatsapp"})]),_:1},8,["modelValue"])]),_:1}),e(T,{label:"名称",required:""},{default:t(()=>[e(N,{modelValue:w.value.name,"onUpdate:modelValue":l[39]||(l[39]=a=>w.value.name=a),placeholder:"如：客服 Bot"},null,8,["modelValue"])]),_:1}),w.value.type==="telegram"?(o(),p(D,{key:0},[e(T,{label:"Bot Token",required:""},{default:t(()=>[s("div",hs,[s("div",Cs,[e(N,{modelValue:w.value.botToken,"onUpdate:modelValue":l[40]||(l[40]=a=>w.value.botToken=a),type:"password","show-password":"",placeholder:"从 @BotFather 获取",style:{flex:"1"},status:I.value.status==="error"?"error":I.value.status==="ok"?"success":""},null,8,["modelValue","status"]),e(d,{size:"default",loading:I.value.loading,type:I.value.status==="ok"?"success":I.value.status==="error"?"danger":"default",onClick:Hl,disabled:!w.value.botToken||Al(w.value.botToken)},{default:t(()=>[...l[103]||(l[103]=[i("验证",-1)])]),_:1},8,["loading","type","disabled"])]),I.value.loading?(o(),p("div",$s,[e(U,{class:"is-loading"},{default:t(()=>[e(S(hl))]),_:1}),l[104]||(l[104]=i(" 正在验证 Token… ",-1))])):I.value.status==="ok"?(o(),p("div",Vs,[e(U,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Jt)]),_:1}),l[105]||(l[105]=i("Token 有效，Bot 名称：",-1)),s("b",null,"@"+f(I.value.botName),1)])):I.value.status==="duplicate"?(o(),p("div",zs,[e(U,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(qt)]),_:1}),l[106]||(l[106]=i("此 Token 已被成员「",-1)),s("b",null,f(I.value.usedBy),1),i("」的渠道「"+f(I.value.usedByCh)+"」使用 ",1)])):I.value.status==="error"?(o(),p("div",Ts,[e(U,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Ht)]),_:1}),i(f(I.value.error),1)])):(o(),p("div",Ss,[e(j,{type:"info",size:"small"},{default:t(()=>[e(U,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(st)]),_:1}),l[107]||(l[107]=i("输入完成后自动验证，也可点右侧「验证」按钮手动触发",-1))]),_:1})]))])]),_:1}),e(T,{label:"白名单用户"},{default:t(()=>[e(N,{modelValue:w.value.allowedFrom,"onUpdate:modelValue":l[41]||(l[41]=a=>w.value.allowedFrom=a),placeholder:"填入 Telegram 用户 ID，多个用逗号分隔"},null,8,["modelValue"]),e(j,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[e(U,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(st)]),_:1}),l[108]||(l[108]=i("留空时 Bot 进入配对模式——向用户返回其 ID，引导联系管理员添加白名单 ",-1))]),_:1})]),_:1})],64)):h("",!0),w.value.type==="web"?(o(),p(D,{key:1},[oe.value?(o(),k(T,{key:0,label:"访问链接"},{default:t(()=>[s("div",Ls,[e(U,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(ot)]),_:1}),s("span",Is,f(Be(S(_),oe.value)),1),e(d,{size:"small",link:"",onClick:l[42]||(l[42]=a=>Gl(Be(S(_),oe.value)))},{default:t(()=>[...l[109]||(l[109]=[i("复制",-1)])]),_:1})])]),_:1})):h("",!0),oe.value?h("",!0):(o(),k(T,{key:1,label:"访问链接"},{default:t(()=>[s("div",Us,[e(U,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(ot)]),_:1}),s("span",Ds,f(Be(S(_),ml.value)),1),e($,{size:"small",type:"info",effect:"plain"},{default:t(()=>[...l[110]||(l[110]=[i("保存后生效",-1)])]),_:1})]),e(j,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[...l[111]||(l[111]=[i(" 每个 Web 渠道有独立链接，可同时开放多个入口 ",-1)])]),_:1})]),_:1})),e(T,{label:"访问密码"},{default:t(()=>[e(N,{modelValue:w.value.webPassword,"onUpdate:modelValue":l[43]||(l[43]=a=>w.value.webPassword=a),type:"password","show-password":"",placeholder:"留空则无需密码"},null,8,["modelValue"])]),_:1}),e(T,{label:"欢迎语"},{default:t(()=>[e(N,{modelValue:w.value.webWelcome,"onUpdate:modelValue":l[44]||(l[44]=a=>w.value.webWelcome=a),placeholder:"你好！有什么可以帮你的？"},null,8,["modelValue"])]),_:1}),e(T,{label:"页面标题"},{default:t(()=>[e(N,{modelValue:w.value.webTitle,"onUpdate:modelValue":l[45]||(l[45]=a=>w.value.webTitle=a),placeholder:"AI 助手"},null,8,["modelValue"])]),_:1})],64)):h("",!0),e(T,{label:"启用"},{default:t(()=>[e(tl,{modelValue:w.value.enabled,"onUpdate:modelValue":l[46]||(l[46]=a=>w.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),Es=_t(As,[["__scopeId","data-v-34593935"]]);export{Es as default};
