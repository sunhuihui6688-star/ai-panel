import{d as se,e as o,i as oe,c as i,b as a,n as x,t as h,p as j,G,g as J,k as M,F as ne,m as le,f as re,h as W,L as ie,z as ue,H as Z,o as u,s as ce}from"./index-CGA_a80X.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ve={class:"pub-chat-page"},fe={key:0,class:"password-gate"},he={class:"gate-card"},pe={class:"gate-name"},ge={key:0,class:"gate-error"},me=["disabled"],we={key:1,class:"closed-page"},ye={key:2,class:"chat-page"},be={class:"chat-header"},_e={class:"chat-header-left"},ke={class:"header-info"},Ie={class:"header-name"},Ce={key:0,class:"welcome-msg"},Se={class:"welcome-bubble"},$e=["innerHTML"],xe={key:1,class:"msg-row assistant"},Te={class:"msg-bubble streaming"},Pe=["innerHTML"],Fe={class:"input-area"},Me=["onKeydown"],Re=["disabled"],He={key:3,class:"loading-page"},Ee=se({__name:"PublicChatView",setup(Le){const V=ie(),w=V.params.agentId,y=V.params.channelId,b=y?`/pub/chat/${w}/${y}`:`/pub/chat/${w}`;function q(){const t=`chat-session-${w}-${y||"default"}`;let e=localStorage.getItem(t);return e||(e=Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,10),localStorage.setItem(t,e)),e}const R=q(),l=o(null),m=o(!1),H=o(!1),z=o(!1),p=o(!1),_=o(""),T=o(!1),d=o(""),B=`pub-session-id-${w}-${y||"default"}`,k=o(localStorage.getItem(B)??""),v=o([]),I=o(""),f=o(!1),n=o(""),P=o(),C=o(),S=ue(()=>(l.value?.name||"?").charAt(0).toUpperCase()),E=`chat-pw-${w}-${y||"default"}`;async function Q(){try{const t=await fetch(`${b}/info`);if(t.status===404||t.status===410){H.value=!0,m.value=!1;return}if(!t.ok){m.value=!0;return}const e=await t.json();if(l.value=e,e.title&&(document.title=e.title),z.value=e.hasPassword,!e.hasPassword)p.value=!0,await F();else{const s=sessionStorage.getItem(E);s?(d.value=s,p.value=!0,await F()):p.value=!1}m.value=!0}catch{m.value=!0}}async function F(){if(R)try{const t=new URLSearchParams({sessionToken:R}),e={};d.value&&(e["X-Chat-Password"]=d.value);const s=await fetch(`${b}/history?${t}`,{headers:e});if(!s.ok)return;const r=await s.json();r.sessionId&&(k.value=r.sessionId),Array.isArray(r.messages)&&r.messages.length>0&&(v.value=r.messages.map(g=>({role:g.role,content:g.content})),await $())}catch{}}async function D(){if(!_.value)return;const t=_.value;try{if((await fetch(`${b}/info`,{headers:{"X-Chat-Password":t}})).status===401){T.value=!0;return}}catch{}d.value=t,sessionStorage.setItem(E,t),p.value=!0,T.value=!1,await F()}async function K(){const t=I.value.trim();!t||f.value||(I.value="",Z(()=>U()),v.value.push({role:"user",content:t}),await $(),await Y(t))}async function N(t){if(!t.body)return!1;const e=t.body.getReader(),s=new TextDecoder;let r="",g=!1;for(;;){const{done:ae,value:te}=await e.read();if(ae)break;r+=s.decode(te,{stream:!0});const O=r.split(`

`);r=O.pop()??"";for(const L of O){const X=L.startsWith("data: ")?L.slice(6):L;if(X.trim())try{const c=JSON.parse(X);if(c.type==="text_delta")n.value+=c.text,await $();else if(c.type==="done"){c.sessionId&&(k.value=c.sessionId,localStorage.setItem(B,c.sessionId)),g=!0;break}else if(c.type==="idle"){g=!0;break}else c.type==="error"&&(n.value+=`
[é”™è¯¯: ${c.error??c.text}]`)}catch{}}if(g)break}return g}async function Y(t){f.value=!0,n.value="";const e={"Content-Type":"application/json"};d.value&&(e["X-Chat-Password"]=d.value);try{const s=await fetch(`${b}/stream`,{method:"POST",headers:e,body:JSON.stringify({message:t,sessionToken:R})});if(s.status===401){d.value="",sessionStorage.removeItem(E),p.value=!1,T.value=!0,f.value=!1,n.value="",v.value.pop();return}if(s.status===410){H.value=!0,m.value=!1;return}if(!s.ok)throw new Error("Request failed");await N(s)}catch{n.value+=`
[è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•]`}finally{n.value&&v.value.push({role:"assistant",content:n.value}),f.value=!1,n.value="",await $()}}async function ee(){if(!k.value)return;const t={};d.value&&(t["X-Chat-Password"]=d.value);try{const e=await fetch(`${b}/reconnect?sessionId=${encodeURIComponent(k.value)}`,{headers:t});if(!e.ok)return;if(f.value=!0,n.value="",await N(e),n.value){const s=v.value[v.value.length-1];(!s||s.role!=="assistant"||s.content!==n.value)&&v.value.push({role:"assistant",content:n.value})}f.value=!1,n.value="",await $(),await F()}catch{}}async function $(){await Z(),P.value&&(P.value.scrollTop=P.value.scrollHeight)}function U(){C.value&&(C.value.style.height="auto",C.value.style.height=Math.min(C.value.scrollHeight,140)+"px")}function A(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}return oe(async()=>{await Q(),p.value&&k.value&&await ee()}),(t,e)=>(u(),i("div",ve,[z.value&&!p.value?(u(),i("div",fe,[a("div",he,[a("div",{class:"gate-avatar",style:x({background:l.value?.avatarColor||"#409EFF"})},h(S.value),5),a("h2",pe,h(l.value?.name||"..."),1),e[2]||(e[2]=a("p",{class:"gate-hint"},"æ­¤å¯¹è¯å·²è®¾ç½®è®¿é—®å¯†ç ",-1)),j(a("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>_.value=s),type:"password",placeholder:"è¯·è¾“å…¥å¯†ç ",class:"gate-input",onKeydown:J(D,["enter"])},null,544),[[G,_.value]]),T.value?(u(),i("div",ge,"å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•")):M("",!0),a("button",{class:"gate-btn",onClick:D,disabled:!_.value},"è¿›å…¥å¯¹è¯",8,me)])])):H.value?(u(),i("div",we,[...e[3]||(e[3]=[a("div",{class:"closed-card"},[a("div",{class:"closed-icon"},"ğŸ”’"),a("h2",{class:"closed-title"},"æ­¤å¯¹è¯å·²å…³é—­"),a("p",{class:"closed-hint"},"è¯¥ Web æ¸ é“å·²è¢«åœç”¨ï¼Œæ— æ³•ç»§ç»­è®¿é—®ã€‚")],-1)])])):m.value?(u(),i("div",ye,[a("div",be,[a("div",_e,[a("div",{class:"header-avatar",style:x({background:l.value?.avatarColor||"#409EFF"})},h(S.value),5),a("div",ke,[a("div",Ie,h(l.value?.name),1),e[4]||(e[4]=a("div",{class:"header-subtitle"},"AI åŠ©æ‰‹ Â· ZyHive",-1))])])]),a("div",{class:"messages-area",ref_key:"messagesRef",ref:P},[v.value.length?M("",!0):(u(),i("div",Ce,[a("div",{class:"welcome-avatar",style:x({background:l.value?.avatarColor||"#409EFF"})},h(S.value),5),a("div",Se,h(l.value?.welcomeMsg||`ä½ å¥½ï¼æˆ‘æ˜¯ ${l.value?.name}ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ`),1)])),(u(!0),i(ne,null,le(v.value,(s,r)=>(u(),i("div",{key:r,class:ce(["msg-row",s.role])},[s.role==="assistant"?(u(),i("div",{key:0,class:"msg-avatar",style:x({background:l.value?.avatarColor||"#409EFF"})},h(S.value),5)):M("",!0),a("div",{class:"msg-bubble",innerHTML:A(s.content)},null,8,$e)],2))),128)),f.value?(u(),i("div",xe,[a("div",{class:"msg-avatar",style:x({background:l.value?.avatarColor||"#409EFF"})},h(S.value),5),a("div",Te,[a("span",{innerHTML:A(n.value)},null,8,Pe),e[5]||(e[5]=a("span",{class:"cursor"},"â–‹",-1))])])):M("",!0)],512),a("div",Fe,[j(a("textarea",{"onUpdate:modelValue":e[1]||(e[1]=s=>I.value=s),class:"input-box",placeholder:"è¾“å…¥æ¶ˆæ¯â€¦",rows:"1",onKeydown:J(re(K,["exact","prevent"]),["enter"]),onInput:U,ref_key:"inputRef",ref:C},null,40,Me),[[G,I.value]]),a("button",{class:"send-btn",onClick:K,disabled:!I.value.trim()||f.value},[...e[6]||(e[6]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},[a("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})],-1)])],8,Re)]),e[7]||(e[7]=a("div",{class:"chat-footer"},[W("Powered by "),a("a",{href:"https://github.com/sunhuihui6688-star/ai-panel",target:"_blank",class:"chat-footer-link"},"å¼•å·¢ Â· ZyHive"),W(" Â· Â© 2025 zyling")],-1))])):(u(),i("div",He,[...e[8]||(e[8]=[a("div",{class:"loading-spinner"},null,-1)])]))]))}}),Be=de(Ee,[["__scopeId","data-v-d0be2031"]]);export{Be as default};
