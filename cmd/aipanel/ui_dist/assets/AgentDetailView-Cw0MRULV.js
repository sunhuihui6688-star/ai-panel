import{d as lt,h as at,E as d,i as v,w as a,B as nt,g as s,r as i,o as r,a as t,f as m,k as _,y as ot,t as f,e as o,z as pe,m as st,c as g,F as G,l as fe,q as ut,j as C,C as it,D as rt,G as dt,H as mt,I as pt}from"./index-B6hLQsOT.js";import{b as ce,f as H,e as J,g as K,h as ft}from"./index-D1rS9gvS.js";import{A as ct}from"./AiChat-DRTgxql4.js";import{_ as vt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const yt={class:"header-left"},_t={class:"chat-layout"},gt={class:"session-sidebar"},wt={class:"session-sidebar-header"},bt={class:"session-list"},kt=["onClick"],Vt={class:"session-item-title"},Ct={class:"session-item-meta"},xt={key:0,class:"session-empty"},ht={class:"at-panel"},zt={key:0,class:"at-form"},$t={class:"chat-area"},At={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},St={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},Tt={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Ut={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},Dt=lt({__name:"AgentDetailView",setup(Ft){const ve=nt(),c=ve.params.id,z=s(null),ye=s("chat"),w=s(),W=s([]),Q=s(!1),$=s();async function _e(){Q.value=!0;try{const l=await ft.list({agentId:c,limit:50});W.value=l.data.sessions}catch{}finally{Q.value=!1}}function ze(l){$.value=l.id,w.value?.resumeSession(l.id)}function $e(){$.value=void 0,w.value?.startNewSession()}function Ae(l){$.value=l,setTimeout(_e,500)}function Se(l){if(!l)return"";const e=Date.now()-l;return e<6e4?"刚刚":e<36e5?`${Math.floor(e/6e4)}分前`:e<864e5?`${Math.floor(e/36e5)}小时前`:`${Math.floor(e/864e5)}天前`}const I=s(!1),E=s(""),B=s(""),se=s(!1),A=s([]);function Te(){I.value=!I.value,I.value&&!A.value.length&&Ue()}async function Ue(){try{const l=await ce.list();A.value=l.data.filter(e=>e.id!==c)}catch{A.value=[]}}function De(l){const e=A.value.find(u=>u.id===l);e&&w.value?.fillInput(`@${e.name}: `)}async function Fe(){const l=E.value,e=B.value.trim();if(!l||!e)return;const b=A.value.find(x=>x.id===l)?.name??l;se.value=!0;const k={role:"user",text:`→ 转发给 ${b}：
${e}`};w.value?.appendMessage(k);try{const V=(await ce.message(l,e,c)).data.response,oe={role:"assistant",text:`← **${b}** 回复：

${V}`};w.value?.appendMessage(oe),B.value="",E.value="",I.value=!1,d.success(`${b} 已回复`)}catch(x){const V={role:"system",text:`❌ 转发失败：${x.response?.data?.error??x.message??"网络错误"}`};w.value?.appendMessage(V),d.error("转发失败")}finally{se.value=!1}}const X=s(""),Z=s(""),ee=s([]),S=s(""),T=s(""),ue=s(!1),ie=s([]),L=s(!1),te=s(""),P=s(!1),le=s(""),ge=s([]),U=s(""),R=s(""),ae=s(null),we=s([]),Y=s(!1),p=s({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function Me(l){return l==="running"?"success":l==="stopped"?"danger":"info"}function Ne(l){return l==="running"?"运行中":l==="stopped"?"已停止":"空闲"}function be(l){return l?l<1024?l+" B":l<1048576?(l/1024).toFixed(1)+" KB":(l/1048576).toFixed(1)+" MB":"0 B"}function Ie(l){return new Date(l).toLocaleString()}function Ee(l){return l?new Date(l).toLocaleString():""}at(async()=>{try{const e=await ce.get(c);z.value=e.data}catch{d.error("加载 Agent 失败")}Be(),Oe(),ne(),await _e();const l=ve.query.resumeSession;l&&($.value=l,await new Promise(u=>setTimeout(u,100)),w.value?.resumeSession(l),W.value.find(u=>u.id===l)||($.value=l))});async function Be(){try{const[l,e]=await Promise.all([H.read(c,"IDENTITY.md"),H.read(c,"SOUL.md")]);X.value=l.data?.content||"",Z.value=e.data?.content||""}catch{}O()}async function re(l,e){try{await H.write(c,l,e),d.success(`${l} 已保存`)}catch{d.error(`保存 ${l} 失败`)}}async function O(){try{const l=await J.tree(c);ee.value=l.data||[]}catch{ee.value=[]}}async function Le(l){if(!l.isDir){S.value=l.path,ie.value=l.path.split("/");try{const e=await J.readFile(c,l.path);T.value=e.data?.content||""}catch{T.value="(无法读取)"}}}async function Pe(){if(S.value){ue.value=!0;try{await J.writeFile(c,S.value,T.value),d.success("记忆文件已保存"),O()}catch{d.error("保存失败")}finally{ue.value=!1}}}async function Re(){const l=te.value.trim();if(!l){d.warning("请输入路径");return}try{await J.writeFile(c,l,`# ${l.split("/").pop()?.replace(".md","")||"New File"}

`),d.success("文件已创建"),L.value=!1,te.value="",O(),S.value=l,ie.value=l.split("/"),T.value=`# ${l.split("/").pop()?.replace(".md","")||"New File"}

`}catch{d.error("创建失败")}}async function Ye(){const l=le.value.trim();if(!l){d.warning("请输入内容");return}try{await J.dailyLog(c,l),d.success("日志已添加"),P.value=!1,le.value="",O()}catch{d.error("添加失败")}}async function Oe(){try{const l=await H.read(c,"/");Array.isArray(l.data)&&(ge.value=l.data.map(e=>({name:e.name,isDir:e.isDir,size:e.size,modTime:e.modTime,path:e.name})))}catch{}}async function je(l){if(!l.isDir){U.value=l.path||l.name,ae.value=l;try{const e=await H.read(c,U.value);R.value=e.data?.content||""}catch{R.value="(无法读取)"}}}async function qe(){U.value&&await re(U.value,R.value)}async function ne(){try{const l=await K.list();we.value=l.data||[]}catch{}}async function Ge(){try{await K.create({name:p.value.name,enabled:p.value.enabled,schedule:{kind:"cron",expr:p.value.expr,tz:p.value.tz},payload:{kind:"agentTurn",message:p.value.message},delivery:{mode:"announce"}}),d.success("任务创建成功"),Y.value=!1,ne()}catch(l){d.error(l.response?.data?.error||"创建失败")}}async function He(l){try{await K.update(l.id,l)}catch{d.error("更新失败")}}async function Je(l){try{await K.run(l.id),d.success("已触发运行"),setTimeout(ne,2e3)}catch{d.error("运行失败")}}async function Ke(l){try{await K.delete(l.id),d.success("已删除"),ne()}catch{d.error("删除失败")}}return(l,e)=>{const u=i("el-button"),b=i("el-tag"),k=i("el-text"),x=i("el-header"),V=i("el-option"),oe=i("el-select"),y=i("el-input"),j=i("el-tab-pane"),D=i("el-card"),F=i("el-col"),de=i("el-row"),M=i("el-icon"),ke=i("el-tree"),Ve=i("el-empty"),Ce=i("el-breadcrumb-item"),We=i("el-breadcrumb"),N=i("el-form-item"),xe=i("el-form"),me=i("el-dialog"),q=i("el-table-column"),he=i("el-switch"),Qe=i("el-table"),Xe=i("el-tabs"),Ze=i("el-main"),et=i("el-container"),tt=pt("loading");return r(),v(et,{class:"agent-detail"},{default:a(()=>[t(x,{class:"detail-header"},{default:a(()=>[m("div",yt,[t(u,{icon:_(ot),onClick:e[0]||(e[0]=n=>l.$router.push("/agents")),circle:""},null,8,["icon"]),m("h2",null,f(z.value?.name||"..."),1),t(b,{type:Me(z.value?.status)},{default:a(()=>[o(f(Ne(z.value?.status)),1)]),_:1},8,["type"])]),t(k,{type:"info"},{default:a(()=>[o(f(z.value?.model),1)]),_:1})]),_:1}),t(Ze,null,{default:a(()=>[t(Xe,{modelValue:ye.value,"onUpdate:modelValue":e[25]||(e[25]=n=>ye.value=n),type:"border-card"},{default:a(()=>[t(j,{label:"对话",name:"chat"},{default:a(()=>[m("div",_t,[m("div",gt,[m("div",wt,[e[27]||(e[27]=m("span",{class:"sidebar-title"},"历史对话",-1)),t(u,{size:"small",type:"primary",plain:"",onClick:$e,icon:_(pe)},{default:a(()=>[...e[26]||(e[26]=[o("新建",-1)])]),_:1},8,["icon"])]),st((r(),g("div",bt,[(r(!0),g(G,null,fe(W.value,n=>(r(),g("div",{key:n.id,class:ut(["session-item",{active:$.value===n.id}]),onClick:h=>ze(n)},[m("div",Vt,f(n.title||"新对话"),1),m("div",Ct,[m("span",null,f(Se(n.lastAt)),1),t(b,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:a(()=>[o(f(n.messageCount)+" 条 ",1)]),_:2},1024),n.tokenEstimate>6e4?(r(),v(b,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:a(()=>[o("~"+f(Math.round(n.tokenEstimate/1e3))+"k",1)]),_:2},1024)):C("",!0)])],10,kt))),128)),!Q.value&&!W.value.length?(r(),g("div",xt," 还没有对话记录 ")):C("",!0)])),[[tt,Q.value]]),m("div",ht,[t(u,{size:"small",plain:"",class:"at-toggle-btn",onClick:Te},{default:a(()=>[...e[28]||(e[28]=[m("span",{class:"at-icon"},"@",-1),o(" 其他成员 ",-1)])]),_:1}),I.value?(r(),g("div",zt,[t(oe,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=n=>E.value=n),placeholder:"选择成员",size:"small",style:{width:"100%","margin-bottom":"6px"},onChange:De},{default:a(()=>[(r(!0),g(G,null,fe(A.value,n=>(r(),v(V,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(y,{modelValue:B.value,"onUpdate:modelValue":e[2]||(e[2]=n=>B.value=n),type:"textarea",rows:3,placeholder:"输入要转发的消息…",size:"small",style:{"margin-bottom":"6px"}},null,8,["modelValue"]),t(u,{type:"primary",size:"small",style:{width:"100%"},loading:se.value,disabled:!E.value||!B.value.trim(),onClick:Fe},{default:a(()=>[...e[29]||(e[29]=[o(" 转发 ",-1)])]),_:1},8,["loading","disabled"])])):C("",!0)])]),m("div",$t,[t(ct,{ref_key:"aiChatRef",ref:w,"agent-id":_(c),scenario:"agent-detail","welcome-message":`你好！我是 **${z.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:Ae},null,8,["agent-id","welcome-message"])])])]),_:1}),t(j,{label:"身份 & 灵魂",name:"identity"},{default:a(()=>[t(de,{gutter:20},{default:a(()=>[t(F,{span:12},{default:a(()=>[t(D,{header:"IDENTITY.md"},{default:a(()=>[t(y,{modelValue:X.value,"onUpdate:modelValue":e[3]||(e[3]=n=>X.value=n),type:"textarea",rows:15,onBlur:e[4]||(e[4]=n=>re("IDENTITY.md",X.value))},null,8,["modelValue"])]),_:1})]),_:1}),t(F,{span:12},{default:a(()=>[t(D,{header:"SOUL.md"},{default:a(()=>[t(y,{modelValue:Z.value,"onUpdate:modelValue":e[5]||(e[5]=n=>Z.value=n),type:"textarea",rows:15,onBlur:e[6]||(e[6]=n=>re("SOUL.md",Z.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(j,{label:"记忆",name:"memory"},{default:a(()=>[m("div",At,[t(u,{type:"primary",size:"small",onClick:e[7]||(e[7]=n=>L.value=!0)},{default:a(()=>[t(M,null,{default:a(()=>[t(_(pe))]),_:1}),e[30]||(e[30]=o(" 新建文件 ",-1))]),_:1}),t(u,{size:"small",onClick:e[8]||(e[8]=n=>P.value=!0)},{default:a(()=>[t(M,null,{default:a(()=>[t(_(it))]),_:1}),e[31]||(e[31]=o(" 添加日志 ",-1))]),_:1}),t(u,{size:"small",onClick:O},{default:a(()=>[t(M,null,{default:a(()=>[t(_(rt))]),_:1}),e[32]||(e[32]=o(" 刷新 ",-1))]),_:1})]),t(de,{gutter:16},{default:a(()=>[t(F,{span:7},{default:a(()=>[t(D,{header:"记忆目录",shadow:"hover"},{default:a(()=>[t(ke,{data:ee.value,props:{label:"name",children:"children",isLeaf:n=>!n.isDir},onNodeClick:Le,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:a(({data:n})=>[m("span",St,[n.isDir?(r(),v(M,{key:0,style:{color:"#E6A23C"}},{default:a(()=>[t(_(dt))]),_:1})):(r(),v(M,{key:1,style:{color:"#409EFF"}},{default:a(()=>[t(_(mt))]),_:1})),m("span",null,f(n.name),1),!n.isDir&&n.size?(r(),v(k,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:a(()=>[o(f(be(n.size)),1)]),_:2},1024)):C("",!0)])]),_:1},8,["data","props"]),ee.value.length===0?(r(),v(Ve,{key:0,description:"记忆树为空","image-size":40})):C("",!0)]),_:1})]),_:1}),t(F,{span:17},{default:a(()=>[t(D,{shadow:"hover"},{header:a(()=>[m("div",Tt,[t(We,{separator:"/"},{default:a(()=>[t(Ce,null,{default:a(()=>[...e[33]||(e[33]=[o("memory",-1)])]),_:1}),(r(!0),g(G,null,fe(ie.value,(n,h)=>(r(),v(Ce,{key:h},{default:a(()=>[o(f(n),1)]),_:2},1024))),128))]),_:1}),S.value?(r(),v(u,{key:0,type:"primary",size:"small",onClick:Pe,loading:ue.value},{default:a(()=>[...e[34]||(e[34]=[o("保存",-1)])]),_:1},8,["loading"])):C("",!0)])]),default:a(()=>[S.value?(r(),v(y,{key:0,modelValue:T.value,"onUpdate:modelValue":e[9]||(e[9]=n=>T.value=n),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(r(),v(Ve,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),t(me,{modelValue:L.value,"onUpdate:modelValue":e[12]||(e[12]=n=>L.value=n),title:"新建记忆文件",width:"480px"},{footer:a(()=>[t(u,{onClick:e[11]||(e[11]=n=>L.value=!1)},{default:a(()=>[...e[36]||(e[36]=[o("取消",-1)])]),_:1}),t(u,{type:"primary",onClick:Re},{default:a(()=>[...e[37]||(e[37]=[o("创建",-1)])]),_:1})]),default:a(()=>[t(xe,{"label-width":"80px"},{default:a(()=>[t(N,{label:"路径"},{default:a(()=>[t(y,{modelValue:te.value,"onUpdate:modelValue":e[10]||(e[10]=n=>te.value=n),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),t(k,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:a(()=>[...e[35]||(e[35]=[o("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(me,{modelValue:P.value,"onUpdate:modelValue":e[15]||(e[15]=n=>P.value=n),title:"添加今日日志",width:"600px"},{footer:a(()=>[t(u,{onClick:e[14]||(e[14]=n=>P.value=!1)},{default:a(()=>[...e[38]||(e[38]=[o("取消",-1)])]),_:1}),t(u,{type:"primary",onClick:Ye},{default:a(()=>[...e[39]||(e[39]=[o("提交",-1)])]),_:1})]),default:a(()=>[t(y,{modelValue:le.value,"onUpdate:modelValue":e[13]||(e[13]=n=>le.value=n),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),t(j,{label:"工作区",name:"workspace"},{default:a(()=>[t(de,{gutter:20},{default:a(()=>[t(F,{span:8},{default:a(()=>[t(D,{header:"文件列表"},{default:a(()=>[t(ke,{data:ge.value,props:{label:"name",children:"children"},onNodeClick:je,"highlight-current":"","default-expand-all":""},null,8,["data"])]),_:1})]),_:1}),t(F,{span:16},{default:a(()=>[t(D,{header:U.value||"选择文件查看"},{default:a(()=>[U.value?(r(),g(G,{key:0},[t(y,{modelValue:R.value,"onUpdate:modelValue":e[16]||(e[16]=n=>R.value=n),type:"textarea",rows:20},null,8,["modelValue"]),m("div",Ut,[t(u,{type:"primary",onClick:qe},{default:a(()=>[...e[40]||(e[40]=[o("保存",-1)])]),_:1}),ae.value?(r(),v(k,{key:0,type:"info",size:"small"},{default:a(()=>[o(f(be(ae.value.size))+" · "+f(Ie(ae.value.modTime)),1)]),_:1})):C("",!0)])],64)):C("",!0)]),_:1},8,["header"])]),_:1})]),_:1})]),_:1}),t(j,{label:"定时任务",name:"cron"},{default:a(()=>[t(u,{type:"primary",onClick:e[17]||(e[17]=n=>Y.value=!0),style:{"margin-bottom":"16px"}},{default:a(()=>[t(M,null,{default:a(()=>[t(_(pe))]),_:1}),e[41]||(e[41]=o(" 新建任务 ",-1))]),_:1}),t(Qe,{data:we.value,stripe:""},{default:a(()=>[t(q,{prop:"name",label:"名称"}),t(q,{label:"调度"},{default:a(({row:n})=>[o(f(n.schedule?.expr)+" ("+f(n.schedule?.tz)+")",1)]),_:1}),t(q,{label:"最近运行",width:"180"},{default:a(({row:n})=>[n.state?.lastRunAtMs?(r(),g(G,{key:0},[t(b,{type:n.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:a(()=>[o(f(n.state?.lastStatus),1)]),_:2},1032,["type"]),t(k,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:a(()=>[o(f(Ee(n.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(r(),v(k,{key:1,type:"info",size:"small"},{default:a(()=>[...e[42]||(e[42]=[o("未运行",-1)])]),_:1}))]),_:1}),t(q,{label:"启用",width:"80"},{default:a(({row:n})=>[t(he,{modelValue:n.enabled,"onUpdate:modelValue":h=>n.enabled=h,onChange:h=>He(n)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(q,{label:"操作",width:"200"},{default:a(({row:n})=>[t(u,{size:"small",onClick:h=>Je(n)},{default:a(()=>[...e[43]||(e[43]=[o("立即运行",-1)])]),_:1},8,["onClick"]),t(u,{size:"small",type:"danger",onClick:h=>Ke(n)},{default:a(()=>[...e[44]||(e[44]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),t(me,{modelValue:Y.value,"onUpdate:modelValue":e[24]||(e[24]=n=>Y.value=n),title:"新建定时任务",width:"520px"},{footer:a(()=>[t(u,{onClick:e[23]||(e[23]=n=>Y.value=!1)},{default:a(()=>[...e[45]||(e[45]=[o("取消",-1)])]),_:1}),t(u,{type:"primary",onClick:Ge},{default:a(()=>[...e[46]||(e[46]=[o("创建",-1)])]),_:1})]),default:a(()=>[t(xe,{model:p.value,"label-width":"100px"},{default:a(()=>[t(N,{label:"名称"},{default:a(()=>[t(y,{modelValue:p.value.name,"onUpdate:modelValue":e[18]||(e[18]=n=>p.value.name=n)},null,8,["modelValue"])]),_:1}),t(N,{label:"Cron 表达式"},{default:a(()=>[t(y,{modelValue:p.value.expr,"onUpdate:modelValue":e[19]||(e[19]=n=>p.value.expr=n),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),t(N,{label:"时区"},{default:a(()=>[t(oe,{modelValue:p.value.tz,"onUpdate:modelValue":e[20]||(e[20]=n=>p.value.tz=n)},{default:a(()=>[t(V,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),t(V,{label:"UTC",value:"UTC"}),t(V,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),t(N,{label:"消息"},{default:a(()=>[t(y,{modelValue:p.value.message,"onUpdate:modelValue":e[21]||(e[21]=n=>p.value.message=n),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),t(N,{label:"启用"},{default:a(()=>[t(he,{modelValue:p.value.enabled,"onUpdate:modelValue":e[22]||(e[22]=n=>p.value.enabled=n)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),Bt=vt(Dt,[["__scopeId","data-v-0f815e4d"]]);export{Bt as default};
