import{d as Q,i as Y,c as l,b as a,n as w,t as u,p as K,D as N,g as O,k as T,F as ee,m as ae,f as te,h as U,H as se,e as o,y as oe,G as j,o as r,s as ne}from"./index-BLoUhhO1.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const re={class:"pub-chat-page"},ie={key:0,class:"password-gate"},ue={class:"gate-card"},ce={class:"gate-name"},de={key:0,class:"gate-error"},ve=["disabled"],pe={key:1,class:"chat-page"},fe={class:"chat-header"},he={class:"chat-header-left"},ge={class:"header-info"},me={class:"header-name"},ye={key:0,class:"welcome-msg"},we={class:"welcome-bubble"},_e=["innerHTML"],be={key:1,class:"msg-row assistant"},ke={class:"msg-bubble streaming"},xe=["innerHTML"],Ce={class:"input-area"},Te=["onKeydown"],Ie=["disabled"],Se={key:2,class:"loading-page"},$e=Q({__name:"PublicChatView",setup(Fe){const H=se(),_=H.params.agentId,b=H.params.channelId,I=b?`/pub/chat/${_}/${b}`:`/pub/chat/${_}`;function A(){const t=`chat-session-${_}-${b||"default"}`;let e=localStorage.getItem(t);return e||(e=Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,10),localStorage.setItem(t,e)),e}const J=A(),n=o(null),k=o(!1),R=o(!1),c=o(!1),v=o(""),x=o(!1),p=o(""),f=o([]),h=o(""),d=o(!1),i=o(""),C=o(),g=o(),m=oe(()=>(n.value?.name||"?").charAt(0).toUpperCase()),S=`chat-pw-${_}-${b||"default"}`;async function X(){try{const t=await fetch(`${I}/info`);if(!t.ok){k.value=!0;return}const e=await t.json();if(n.value=e,e.title&&(document.title=e.title),R.value=e.hasPassword,!e.hasPassword)c.value=!0;else{const s=sessionStorage.getItem(S);s?(p.value=s,c.value=!0):c.value=!1}k.value=!0}catch{k.value=!0}}async function E(){if(!v.value)return;const t=v.value;try{if((await fetch(`${I}/info`,{headers:{"X-Chat-Password":t}})).status===401){x.value=!0;return}}catch{}p.value=t,sessionStorage.setItem(S,t),c.value=!0,x.value=!1}async function L(){const t=h.value.trim();!t||d.value||(h.value="",j(()=>V()),f.value.push({role:"user",content:t}),await $(),await Z(t))}async function Z(t){d.value=!0,i.value="";const e={"Content-Type":"application/json"};p.value&&(e["X-Chat-Password"]=p.value);try{const s=await fetch(`${I}/stream`,{method:"POST",headers:e,body:JSON.stringify({message:t,sessionToken:J})});if(s.status===401){p.value="",sessionStorage.removeItem(S),c.value=!1,x.value=!0,d.value=!1,i.value="",f.value.pop();return}if(!s.ok||!s.body)throw new Error("Request failed");const F=s.body.getReader(),q=new TextDecoder;let M="";for(;;){const{done:G,value:W}=await F.read();if(G)break;M+=q.decode(W,{stream:!0});const z=M.split(`

`);M=z.pop()??"";for(const P of z){const D=P.startsWith("data: ")?P.slice(6):P;if(D.trim())try{const y=JSON.parse(D);if(y.type==="text_delta")i.value+=y.text,await $();else{if(y.type==="done")break;y.type==="error"&&(i.value+=`
[错误: ${y.text}]`)}}catch{}}}}catch{i.value+=`
[连接错误，请重试]`}finally{i.value&&f.value.push({role:"assistant",content:i.value}),d.value=!1,i.value="",await $()}}async function $(){await j(),C.value&&(C.value.scrollTop=C.value.scrollHeight)}function V(){g.value&&(g.value.style.height="auto",g.value.style.height=Math.min(g.value.scrollHeight,140)+"px")}function B(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}return Y(X),(t,e)=>(r(),l("div",re,[R.value&&!c.value?(r(),l("div",ie,[a("div",ue,[a("div",{class:"gate-avatar",style:w({background:n.value?.avatarColor||"#409EFF"})},u(m.value),5),a("h2",ce,u(n.value?.name||"..."),1),e[2]||(e[2]=a("p",{class:"gate-hint"},"此对话已设置访问密码",-1)),K(a("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>v.value=s),type:"password",placeholder:"请输入密码",class:"gate-input",onKeydown:O(E,["enter"])},null,544),[[N,v.value]]),x.value?(r(),l("div",de,"密码错误，请重试")):T("",!0),a("button",{class:"gate-btn",onClick:E,disabled:!v.value},"进入对话",8,ve)])])):k.value?(r(),l("div",pe,[a("div",fe,[a("div",he,[a("div",{class:"header-avatar",style:w({background:n.value?.avatarColor||"#409EFF"})},u(m.value),5),a("div",ge,[a("div",me,u(n.value?.name),1),e[3]||(e[3]=a("div",{class:"header-subtitle"},"AI 助手 · ZyHive",-1))])])]),a("div",{class:"messages-area",ref_key:"messagesRef",ref:C},[f.value.length?T("",!0):(r(),l("div",ye,[a("div",{class:"welcome-avatar",style:w({background:n.value?.avatarColor||"#409EFF"})},u(m.value),5),a("div",we,u(n.value?.welcomeMsg||`你好！我是 ${n.value?.name}，有什么可以帮你的？`),1)])),(r(!0),l(ee,null,ae(f.value,(s,F)=>(r(),l("div",{key:F,class:ne(["msg-row",s.role])},[s.role==="assistant"?(r(),l("div",{key:0,class:"msg-avatar",style:w({background:n.value?.avatarColor||"#409EFF"})},u(m.value),5)):T("",!0),a("div",{class:"msg-bubble",innerHTML:B(s.content)},null,8,_e)],2))),128)),d.value?(r(),l("div",be,[a("div",{class:"msg-avatar",style:w({background:n.value?.avatarColor||"#409EFF"})},u(m.value),5),a("div",ke,[a("span",{innerHTML:B(i.value)},null,8,xe),e[4]||(e[4]=a("span",{class:"cursor"},"▋",-1))])])):T("",!0)],512),a("div",Ce,[K(a("textarea",{"onUpdate:modelValue":e[1]||(e[1]=s=>h.value=s),class:"input-box",placeholder:"输入消息…",rows:"1",onKeydown:O(te(L,["exact","prevent"]),["enter"]),onInput:V,ref_key:"inputRef",ref:g},null,40,Te),[[N,h.value]]),a("button",{class:"send-btn",onClick:L,disabled:!h.value.trim()||d.value},[...e[5]||(e[5]=[a("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},[a("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})],-1)])],8,Ie)]),e[6]||(e[6]=a("div",{class:"chat-footer"},[U("Powered by "),a("a",{href:"https://github.com/sunhuihui6688-star/ai-panel",target:"_blank",class:"chat-footer-link"},"引巢 · ZyHive"),U(" · © 2025 zyling")],-1))])):(r(),l("div",Se,[...e[7]||(e[7]=[a("div",{class:"loading-spinner"},null,-1)])]))]))}}),He=le($e,[["__scopeId","data-v-79d30a60"]]);export{He as default};
