import{d as ue,g as m,h as de,c as o,n as pe,s as he,f as n,t as p,l as u,F as k,j as C,e as L,p as ve,b as O,I as U,J as ge,m as fe,K as S,o as a}from"./index-Cedc6hYg.js";import{g as me}from"./index-BF1X9mkB.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={key:0,class:"chat-empty"},ke={key:0,class:"welcome-msg"},be={key:1,class:"examples"},xe=["onClick"],Ce={key:0,class:"msg-row user"},$e={class:"msg-bubble user"},we={key:0,class:"msg-images"},Me=["src","onClick"],Se={class:"msg-text"},Te={key:1,class:"msg-row assistant"},De={class:"msg-col"},Ie=["open"],Ae={class:"thinking-summary"},Ne={class:"thinking-len"},Fe={class:"thinking-content"},Je={class:"msg-bubble assistant"},Le={class:"tool-details"},Oe={class:"tool-summary"},Be={class:"tool-name"},Ee={key:0,class:"tool-status running"},Re={key:1,class:"tool-status done"},je={key:2,class:"tool-status error"},He={class:"tool-body"},Ke={key:0,class:"tool-section"},Pe={class:"tool-pre"},Ue={key:1,class:"tool-section"},Ve={class:"tool-pre result"},ze=["innerHTML"],We={key:1,class:"apply-card"},Ye={class:"apply-preview"},Ge={class:"apply-key"},qe={class:"apply-val"},Qe=["onClick"],Xe={class:"msg-actions"},Ze=["onClick","title"],et=["onClick"],tt=["onClick"],st={key:1,class:"option-chips"},nt=["onClick"],lt={key:2,class:"msg-row system"},ot={class:"msg-system"},at={key:1,class:"msg-row assistant"},it={class:"msg-col"},ct={key:0,class:"thinking-block",open:""},rt={class:"thinking-content"},ut={class:"msg-bubble assistant"},dt={key:0,class:"typing-dots"},pt=["innerHTML"],ht={key:2,class:"blink"},vt=["src"],gt={class:"chat-input-area"},ft={key:0,class:"attachments-bar"},mt=["src"],yt=["onClick"],_t={class:"input-row"},kt={class:"textarea-wrap"},bt=["placeholder","disabled","onKeydown"],xt={class:"input-actions"},Ct={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},$t=["disabled"],wt={key:0,class:"spinner"},Mt={key:1},St=ue({__name:"AiChat",props:{agentId:{},context:{},scenario:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply"],setup(v,{expose:V,emit:z}){const g=v,B=z,d=m(g.initialMessages?[...g.initialMessages]:[]),$=m(""),b=m([]),x=m(!1),f=m(""),w=m(""),T=m(null),D=m(""),I=m(),y=m(),W=fe(()=>({height:g.height??"100%","--bg":g.bgColor??"transparent"}));function _(){S(()=>{I.value&&(I.value.scrollTop=I.value.scrollHeight)})}function Y(){y.value&&(y.value.style.height="auto",y.value.style.height=Math.min(y.value.scrollHeight,160)+"px")}function E(s){$.value=s,S(()=>y.value?.focus())}function G(s){try{return JSON.stringify(JSON.parse(s),null,2)}catch{return s}}function q(s){navigator.clipboard?.writeText(s);const e=d.value.findIndex(t=>t.text===s);T.value=e,setTimeout(()=>{T.value=null},1500)}function Q(s){for(let e=s-1;e>=0;e--){const t=d.value[e];if(t&&t.role==="user"){const i=t.text,l=t.images??[];d.value.splice(e,d.value.length-e),P(i,l);return}}}function X(s){D.value=s}function j(s){return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(t,i,l)=>`<pre class="code-block${i?" lang-"+i:""}"><code>${l}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function Z(s){const e=s.split(`
`),t=[],i=/^([ğŸ™ğŸ˜„ğŸŒğŸ›ğŸ“šğŸ¨ğŸ’¼ğŸ¤–âš½ğŸ¯âœ…âŒğŸ”¥ğŸ’¡ğŸğŸš€ğŸŒŸğŸ’ğŸªğŸ­ğŸ¬ğŸ¤]|[\u{1F300}-\u{1FFFF}]|[\u{2600}-\u{27BF}])\s+(.{4,40})/u;for(const l of e){const c=l.replace(/^[-*â€¢]\s*/,"").trim();if(c.match(i)){const r=c.replace(/[ï¼š:ã€‚ï¼Œ,]$/,"").trim();r.length>=5&&t.push(r)}}return t.slice(0,5)}function ee(s){return s?/\{[\s\S]{30,}\}/.test(s)&&(s.includes('"name"')||s.includes('"identity"')||s.includes('"soul"')||s.includes('"IDENTITY"')||s.includes('"SOUL"')):!1}function te(s){const e=H(s.text);console.log("[AiChat] manualApply result:",e),e?(s.applyData=e,S(()=>B("apply",e))):alert("æœªèƒ½ä»æ¶ˆæ¯ä¸­æå–åˆ°é…ç½® JSONï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶")}function H(s){const e=s.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(e?.[1]){const i=A(e[1]);if(i)return i;const l=K(e[1]),c=A(l);if(c)return c}const t=[...s.matchAll(/(\{[^{}]{20,}\})/g)];for(let i=t.length-1;i>=0;i--){const l=t[i]?.[1];if(!l)continue;const c=A(l)??A(K(l));if(c)return c}return null}function A(s){try{const e=JSON.parse(s);if(e&&typeof e=="object"&&!Array.isArray(e)){const t=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(i=>t.includes(i)))return e}}catch{}return null}function K(s){let e="",t=!1,i=!1;for(let l=0;l<s.length;l++){const c=s[l];if(i){e+=c,i=!1;continue}if(c==="\\"&&t){e+=c,i=!0;continue}if(c==='"'){t=!t,e+=c;continue}if(t&&c===`
`){e+="\\n";continue}if(t&&c==="\r"){e+="\\r";continue}e+=c}return e}function se(s){const e=s.clipboardData?.items;if(e){for(const t of Array.from(e))if(t.type.startsWith("image/")){s.preventDefault();const i=t.getAsFile();i&&R(i)}}}function ne(s){const e=s.dataTransfer?.files;if(e)for(const t of Array.from(e))t.type.startsWith("image/")&&R(t)}function le(s){const e=s.target.files;if(e)for(const t of Array.from(e))R(t)}function R(s){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&b.value.push(e.result)},e.readAsDataURL(s)}function oe(s){b.value.splice(s,1)}function N(){const s=$.value.trim(),e=[...b.value];!s&&!e.length||x.value||($.value="",b.value=[],S(()=>{y.value&&(y.value.style.height="auto")}),B("message",s,e),P(s,e))}function P(s,e){d.value.push({role:"user",text:s,images:e.length?e:void 0}),_(),x.value=!0,f.value="",w.value="";const t={role:"assistant",text:"",toolCalls:[]};d.value.push(t);const i=d.value.length-1;let l="";const c=d.value.slice(0,-1).filter(r=>(r.role==="user"||r.role==="assistant")&&r.text).slice(-20).map(r=>({role:r.role,content:r.text})),F={context:g.context,scenario:g.scenario,images:e.length?e:void 0,history:c.length>0?c:void 0};me(g.agentId,s,r=>{switch(r.type){case"thinking_delta":w.value+=r.text,_();break;case"text":case"text_delta":f.value+=r.text,_();break;case"tool_call":{const h={id:r.tool_call?.id??String(Date.now()),name:r.tool_call?.name??"tool",input:r.tool_call?.input?JSON.stringify(r.tool_call.input):void 0,status:"running"};d.value[i].toolCalls.push(h),l=h.id,_();break}case"tool_result":{const h=d.value[i].toolCalls?.find(J=>J.id===l);h&&(h.result=r.text,h.status="done"),_();break}case"done":case"error":{const h=d.value[i];if(h.text=f.value,h.thinking=w.value||void 0,g.applyable){const M=H(f.value);M?(h.applyData=M,console.log("[AiChat] applyData extracted:",M)):console.log("[AiChat] no applyData found in text length:",f.value.length)}const J=Z(f.value);if(J.length>=2&&(h.options=J),r.type==="error"){h.text=`âŒ ${r.error}`;const M=h.toolCalls?.find(re=>re.status==="running");M&&(M.status="error")}x.value=!1,f.value="",w.value="",B("response",h.text),_();break}}},F)}function ae(){d.value=[]}function ie(s){d.value.push(s),_()}function ce(s){E(s),S(N)}return V({clearMessages:ae,appendMessage:ie,sendText:ce,messages:d}),de(()=>{_()}),(s,e)=>(a(),o("div",{class:he(["ai-chat",{compact:v.compact,"has-bg":v.bgColor}]),style:pe(W.value)},[n("div",{class:"chat-messages",ref_key:"msgListRef",ref:I},[d.value.length?u("",!0):(a(),o("div",_e,[v.welcomeMessage?(a(),o("div",ke,p(v.welcomeMessage),1)):u("",!0),v.examples.length?(a(),o("div",be,[(a(!0),o(k,null,C(v.examples,(t,i)=>(a(),o("div",{key:i,class:"example-chip",onClick:l=>E(t)},p(t),9,xe))),128))])):u("",!0)])),(a(!0),o(k,null,C(d.value,(t,i)=>(a(),o(k,{key:i},[t.role==="user"?(a(),o("div",Ce,[n("div",$e,[t.images?.length?(a(),o("div",we,[(a(!0),o(k,null,C(t.images,(l,c)=>(a(),o("img",{key:c,src:l,class:"msg-img",onClick:F=>X(l)},null,8,Me))),128))])):u("",!0),n("div",Se,p(t.text),1)])])):t.role==="assistant"?(a(),o("div",Te,[n("div",De,[t.thinking?(a(),o("details",{key:0,class:"thinking-block",open:v.showThinking},[n("summary",Ae,[e[3]||(e[3]=n("span",{class:"thinking-icon"},"ğŸ’­",-1)),e[4]||(e[4]=L(" æ€è€ƒè¿‡ç¨‹ ",-1)),n("span",Ne,p(t.thinking.length)+" å­—ç¬¦",1)]),n("pre",Fe,p(t.thinking),1)],8,Ie)):u("",!0),n("div",Je,[(a(!0),o(k,null,C(t.toolCalls,(l,c)=>(a(),o("div",{key:c,class:"tool-call-block"},[n("details",Le,[n("summary",Oe,[e[5]||(e[5]=n("span",{class:"tool-icon"},"ğŸ”§",-1)),n("span",Be,p(l.name),1),l.status==="running"?(a(),o("span",Ee,"è¿è¡Œä¸­â€¦")):l.status==="done"?(a(),o("span",Re,"å®Œæˆ")):l.status==="error"?(a(),o("span",je,"å¤±è´¥")):u("",!0)]),n("div",He,[l.input?(a(),o("div",Ke,[e[6]||(e[6]=n("div",{class:"tool-label"},"è¾“å…¥",-1)),n("pre",Pe,p(G(l.input)),1)])):u("",!0),l.result?(a(),o("div",Ue,[e[7]||(e[7]=n("div",{class:"tool-label"},"è¾“å‡º",-1)),n("pre",Ve,p(l.result.slice(0,800))+p(l.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):u("",!0)])])]))),128)),t.text?(a(),o("div",{key:0,class:"msg-text",innerHTML:j(t.text)},null,8,ze)):u("",!0),t.applyData&&g.applyable?(a(),o("div",We,[n("div",Ye,[(a(!0),o(k,null,C(t.applyData,(l,c)=>(a(),o("div",{key:c,class:"apply-row"},[n("span",Ge,p(c),1),n("span",qe,p(String(l).slice(0,60))+p(String(l).length>60?"â€¦":""),1)]))),128))]),n("button",{class:"apply-btn",onClick:l=>s.$emit("apply",t.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,Qe)])):u("",!0),n("div",Xe,[n("button",{class:"act-btn",onClick:l=>q(t.text),title:T.value===i?"å·²å¤åˆ¶":"å¤åˆ¶"},p(T.value===i?"âœ“":"â˜"),9,Ze),n("button",{class:"act-btn",onClick:l=>Q(i),title:"é‡è¯•"},"â†º",8,et),g.applyable&&!t.applyData&&ee(t.text)?(a(),o("button",{key:0,class:"act-btn apply-manual-btn",onClick:l=>te(t),title:"æ£€æµ‹åˆ°é…ç½® JSONï¼Œç‚¹å‡»åº”ç”¨"}," âš™ åº”ç”¨é…ç½® ",8,tt)):u("",!0)])]),t.options&&t.options.length?(a(),o("div",st,[(a(!0),o(k,null,C(t.options,(l,c)=>(a(),o("button",{key:c,class:"option-chip",onClick:F=>E(l)},p(l),9,nt))),128))])):u("",!0)])])):t.role==="system"?(a(),o("div",lt,[n("div",ot,p(t.text),1)])):u("",!0)],64))),128)),x.value?(a(),o("div",at,[n("div",it,[w.value&&v.showThinking?(a(),o("details",ct,[e[9]||(e[9]=n("summary",{class:"thinking-summary"},[n("span",{class:"thinking-icon"},"ğŸ’­"),L(" æ€è€ƒä¸­â€¦ ")],-1)),n("pre",rt,[L(p(w.value),1),e[8]||(e[8]=n("span",{class:"blink"},"â–Š",-1))])])):u("",!0),n("div",ut,[f.value?(a(),o("div",{key:1,class:"msg-text",innerHTML:j(f.value)},null,8,pt)):(a(),o("div",dt,[...e[10]||(e[10]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])),f.value?(a(),o("span",ht,"â–Š")):u("",!0)])])])):u("",!0)],512),D.value?(a(),o("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=t=>D.value="")},[n("img",{src:D.value,class:"img-preview-full"},null,8,vt)])):u("",!0),n("div",gt,[b.value.length?(a(),o("div",ft,[(a(!0),o(k,null,C(b.value,(t,i)=>(a(),o("div",{key:i,class:"attach-thumb"},[n("img",{src:t},null,8,mt),n("button",{class:"remove-attach",onClick:l=>oe(i)},"Ã—",8,yt)]))),128))])):u("",!0),n("div",_t,[n("div",kt,[ve(n("textarea",{ref_key:"inputRef",ref:y,"onUpdate:modelValue":e[1]||(e[1]=t=>$.value=t),placeholder:v.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:x.value,rows:"1",class:"chat-textarea",onKeydown:[U(O(N,["ctrl","prevent"]),["enter"]),U(O(N,["meta","prevent"]),["enter"])],onPaste:se,onInput:Y,onDragover:e[2]||(e[2]=O(()=>{},["prevent"])),onDrop:O(ne,["prevent"])},null,40,bt),[[ge,$.value]])]),n("div",xt,[n("label",Ct,[e[11]||(e[11]=L(" ğŸ“ ",-1)),n("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:le},null,32)]),n("button",{class:"send-btn",disabled:x.value||!$.value.trim()&&!b.value.length,onClick:N},[x.value?(a(),o("span",wt)):(a(),o("span",Mt,"â†‘"))],8,$t)])]),e[12]||(e[12]=n("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6))}}),At=ye(St,[["__scopeId","data-v-54e8c42d"]]);export{At as A};
