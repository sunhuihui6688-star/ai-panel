import{d as ht,D as $l,i as Ct,o as i,c,b as s,a as e,w as t,k as h,F,m as J,s as pl,t as v,j as k,h as o,f as Vt,n as We,p as Ye,G as yt,v as pa,l as L,e as d,z as Tl,E as m,H as gt,r as y,I as ma,A as ca,B as ul,J as ya,K as Vl,L as _t,M as wt,g as Ql,N as ga,x as bt,O as _a}from"./index-DwNtQzoA.js";import{h as dl,f as G,b as rl,m as wa,i as vl,j as fl,k as ba,g as zl,r as kt,e as ee,l as xt}from"./index-BpGprwnc.js";import{A as zt}from"./AiChat-CE76_FKV.js";import{_ as $t}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ka={class:"skill-studio"},xa={class:"studio-sidebar"},ha={class:"sidebar-top"},Ca={class:"sidebar-acts"},Va={class:"skill-list"},za={key:0,class:"list-empty"},$a=["onClick"],Ta={class:"sk-icon"},Sa={key:0},La={class:"sk-info"},Ua={class:"sk-name"},Ia={class:"sk-id"},Aa={class:"sk-right"},Da={key:0,class:"sk-streaming-dot",title:"AI 生成中…"},Fa={class:"studio-editor"},Na={key:0,class:"editor-empty"},Ma={class:"editor-toolbar"},Ba={class:"editor-breadcrumb"},Ea={class:"crumb-name"},ja={class:"toolbar-acts"},Pa={class:"editor-body"},Ka={class:"file-tree"},Ra={class:"tree-title"},Oa={class:"tree-item tree-dir"},Wa=["onClick"],Ya={key:0,class:"tree-empty"},Ha={key:0,class:"file-editor"},Ja={class:"file-editor-head"},qa={style:{display:"flex","align-items":"center",gap:"10px"}},Ga={style:{"font-size":"12px",color:"#909399"}},Qa={class:"json-preview"},Xa={key:1,class:"file-editor"},Za={class:"file-editor-head"},en={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},ln={style:{"font-size":"11px",color:"#c0c4cc"}},tn={key:2,class:"file-editor"},an={class:"file-editor-head"},nn={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},sn={style:{"font-size":"11px",color:"#c0c4cc"}},on=["placeholder"],un={class:"studio-chat"},dn={class:"chat-panel-head"},rn={key:0,style:{"margin-left":"auto","font-size":"11px",color:"#c0c4cc"}},vn={key:0,style:{"margin-left":"6px",color:"#e6a23c"}},fn={class:"chat-wrap"},pn=ht({__name:"SkillStudio",props:{agentId:{}},setup(Xl){const ve=Xl,g=ve.agentId,U=d([]),fe=d(!1),f=d(null),V=d("meta"),z=d({name:"",icon:"",category:"",description:"",version:"1.0.0",enabled:!0}),M=d(""),Ae=d(!1),Te=d(!1),He=d(!1),De=d(!1),ke=d(!1),le=d([]),te=d(!1),Q=d(""),pe=d(!1),X=d(!1),Je={};function ml(p,r){r?Je[p]=r:delete Je[p]}function Fe(p){return p?Je[p]:null}const Se=d(new Set);function Ne(p,r){const T=new Set(Se.value);r?T.add(p):T.delete(p),Se.value=T}const me=d(new Set);$l(f,async p=>{p&&(me.value.has(p.id)||(me.value.add(p.id),await gt(),await Fe(p.id)?.resumeSession?.(`skill-studio-${p.id}`)))},{flush:"post"});const qe=Tl(()=>{if(!f.value)return"你是一个技能配置助手，帮助用户设计和优化 AI 技能的系统提示词。";const p=JSON.stringify({id:f.value.id,name:f.value.name,icon:f.value.icon||"",category:f.value.category||"",description:f.value.description||"",version:f.value.version||"1.0.0",enabled:f.value.enabled,source:"local",installedAt:""},null,2);return`你是一个技能配置助手，正在帮助用户配置技能（ID: ${f.value.id}）。

## ⚠️ 文件路径规则（必须遵守）
所有文件必须在 skills/${f.value.id}/ 目录下：
- ✅ skills/${f.value.id}/SKILL.md
- ✅ skills/${f.value.id}/skill.json
- ✅ skills/${f.value.id}/tools/helper.py
- ❌ 任何其他路径

## ⚠️ 创建或更新技能时，必须同时写两个文件

### 1. skills/${f.value.id}/skill.json（技能元数据）
格式如下，修改 name/icon/category/description 字段：
\`\`\`json
${p}
\`\`\`

### 2. skills/${f.value.id}/SKILL.md（系统提示词）
当前内容：
\`\`\`markdown
${M.value||"（空）"}
\`\`\`

## 你可以帮助：
- 创建/优化技能：同时写 skill.json（名称、分类、描述）和 SKILL.md（提示词）
- 在技能目录下创建工具文件（Python 等）
- 测试技能效果（直接对话即可测试）`}),ce=Tl(()=>f.value?ke.value?`新技能已创建（ID: ${f.value.id}）。告诉我你想要什么功能，我来帮你生成完整的 SKILL.md 内容，生成后直接点保存即可。`:`当前编辑「${f.value.name}」。你可以让我优化 SKILL.md、测试效果，或者直接对话体验当前技能。`:"选择一个技能后，我可以帮你优化配置、写 SKILL.md、测试效果。"),Ge=Tl(()=>f.value?ke.value?[]:[`帮我优化「${f.value.name}」的 SKILL.md`,"这个技能怎么写效果更好？","用中文回答一道历史题，测试当前技能效果"]:["帮我设计一个代码审查技能","帮我写一个翻译助手的 SKILL.md"]);async function Y(){fe.value=!0;try{const p=await dl.list(g);if(U.value=p.data||[],f.value){const r=U.value.find(T=>T.id===f.value.id);r&&(f.value=r,xe(r))}}catch{}finally{fe.value=!1}}function xe(p){z.value={name:p.name,icon:p.icon||"",category:p.category||"",description:p.description||"",version:p.version||"1.0.0",enabled:p.enabled}}async function he(p){f.value?.id!==p.id&&(f.value=p,xe(p),V.value="meta",Te.value=!1,M.value="",ke.value=!1,Ce(),ye())}async function Me(){f.value&&V.value!=="prompt"&&(V.value="prompt",M.value||await ye())}async function cl(p,r,T){const x=await G.read(g,p),K=Array.isArray(x.data)?x.data:[],ae=[];for(const H of K){if(T===0&&H.name==="skill.json")continue;const q=r?`${r}/${H.name}`:H.name;if(ae.push({name:H.name,path:q,isDir:H.isDir,depth:T}),H.isDir){const ne=await cl(`skills/${f.value.id}/${q}`,q,T+1);ae.push(...ne)}}return ae}async function Ce(){if(f.value){te.value=!0;try{le.value=await cl(`skills/${f.value.id}/`,"",0)}catch{le.value=[{name:"SKILL.md",path:"SKILL.md",isDir:!1,depth:0}]}finally{te.value=!1}}}async function Sl(p,r){if(!r){if(p==="SKILL.md"){await Me();return}V.value=p,pe.value=!1,await Qe()}}async function Qe(){if(!(!f.value||!V.value||V.value==="meta"||V.value==="prompt")){X.value=!0;try{const p=await G.read(g,`skills/${f.value.id}/${V.value}`);Q.value=p.data?.content||"",pe.value=!1}catch{Q.value=""}finally{X.value=!1}}}async function j(p){if(f.value)try{await G.delete(g,`skills/${f.value.id}/${p}`),V.value===p&&(V.value="prompt"),await Ce(),m.success("已删除")}catch{m.error("删除失败")}}async function Xe(){if(f.value){He.value=!0;try{V.value==="meta"||V.value==="prompt"?(await dl.update(ve.agentId,f.value.id,{name:z.value.name,icon:z.value.icon,category:z.value.category,description:z.value.description,enabled:z.value.enabled}),(V.value==="prompt"||M.value)&&(await G.write(g,`skills/${f.value.id}/SKILL.md`,M.value),Te.value=!1),await Y()):(await G.write(g,`skills/${f.value.id}/${V.value}`,Q.value),pe.value=!1),m.success("保存成功")}catch(p){m.error(p.response?.data?.error||"保存失败")}finally{He.value=!1}}}async function Ze(p,r){try{await dl.update(ve.agentId,p.id,{enabled:r}),await Y()}catch{m.error("操作失败")}}async function Ll(){if(f.value)try{await dl.remove(ve.agentId,f.value.id),m.success("已删除"),f.value=null,await Y()}catch{m.error("删除失败")}}async function el(){if(De.value)return;De.value=!0;const p="skill_"+Date.now().toString(36);try{await dl.create(ve.agentId,{meta:{id:p,name:"新技能",icon:"",category:"",description:"",version:"1.0.0",enabled:!1,source:"local",installedAt:""},promptContent:""}),await Y();const r=U.value.find(T=>T.id===p);if(r){await he(r),V.value="prompt",M.value="",ke.value=!0,await gt(),me.value.has(p)||(me.value.add(p),await Fe(p)?.resumeSession?.(`skill-studio-${p}`));const T=U.value.filter(x=>x.id!==p).map(x=>x.name).join("、")||"暂无";Fe(p)?.sendSilent?.(`【纯文字输出，不使用任何工具，不创建任何文件】当前已有技能：${T}。请推荐3个全新的、与已有技能不重复的技能方向，每条一句话，直接列出即可。`)}}catch(r){m.error(r.response?.data?.error||"创建失败")}finally{De.value=!1}}async function Ul(p,r){p===f.value?.id&&(ke.value=!1),await Y(),p===f.value?.id&&(await Promise.all([Ce(),ye()]),V.value!=="meta"&&V.value!=="prompt"&&await Qe())}async function ye(){if(f.value){Ae.value=!0;try{const p=await G.read(g,`skills/${f.value.id}/SKILL.md`);M.value=p.data?.content||"",Te.value=!1}catch{M.value=""}finally{Ae.value=!1}}}async function Be(){if(!f.value)return;M.value||await Me();const p=`请用「${f.value.name}」技能效果回复：你好，请介绍一下你的功能。`;Fe(f.value?.id)?.fillInput?.(p),m.info("测试消息已填入右侧聊天框，点击发送即可测试")}return Ct(Y),(p,r)=>{const T=y("Refresh"),x=y("el-icon"),K=y("el-button"),ae=y("Plus"),H=y("Tools"),q=y("el-tag"),ne=y("el-switch"),Ee=y("Setting"),yl=y("FolderOpened"),R=y("VideoPlay"),se=y("DocumentChecked"),ge=y("Delete"),_e=y("el-popconfirm"),Ve=y("Folder"),oe=y("Document"),ze=y("el-input"),we=y("el-form-item"),P=y("el-col"),je=y("el-row"),B=y("el-collapse-item"),Il=y("el-collapse"),Al=y("el-form"),Dl=y("ChatLineRound");return i(),c("div",ka,[s("div",xa,[s("div",ha,[r[13]||(r[13]=s("span",{class:"sidebar-title"},"技能库",-1)),s("div",Ca,[e(K,{size:"small",loading:fe.value,circle:"",onClick:Y},{default:t(()=>[e(x,null,{default:t(()=>[e(T)]),_:1})]),_:1},8,["loading"]),e(K,{size:"small",type:"primary",circle:"",loading:De.value,onClick:el},{default:t(()=>[e(x,null,{default:t(()=>[e(ae)]),_:1})]),_:1},8,["loading"])])]),s("div",Va,[!fe.value&&U.value.length===0?(i(),c("div",za,"暂无技能")):h("",!0),(i(!0),c(F,null,J(U.value,_=>(i(),c("div",{key:_.id,class:pl(["skill-item",{active:f.value?.id===_.id}]),onClick:ie=>he(_)},[s("span",Ta,[_.icon?(i(),c("span",Sa,v(_.icon),1)):(i(),k(x,{key:1},{default:t(()=>[e(H)]),_:1}))]),s("div",La,[s("div",Ua,v(_.name),1),s("div",Ia,v(_.id),1)]),s("div",Aa,[Se.value.has(_.id)?(i(),c("span",Da)):_.category?(i(),k(q,{key:1,size:"small",effect:"plain",style:{"margin-right":"6px","font-size":"11px"}},{default:t(()=>[o(v(_.category),1)]),_:2},1024)):h("",!0),e(ne,{"model-value":_.enabled,size:"small",onChange:ie=>Ze(_,ie),onClick:r[0]||(r[0]=Vt(()=>{},["stop"]))},null,8,["model-value","onChange"])])],10,$a))),128))])]),s("div",Fa,[f.value?(i(),c(F,{key:1},[s("div",Ma,[s("div",Ba,[e(x,{style:{color:"#909399"}},{default:t(()=>[e(yl)]),_:1}),r[16]||(r[16]=s("span",{class:"crumb-sep"},"skills /",-1)),s("span",Ea,v(f.value.id),1)]),s("div",ja,[e(K,{size:"small",onClick:Be},{default:t(()=>[e(x,null,{default:t(()=>[e(R)]),_:1}),r[17]||(r[17]=o(" 测试 ",-1))]),_:1}),e(K,{size:"small",type:"primary",loading:He.value,onClick:Xe},{default:t(()=>[e(x,null,{default:t(()=>[e(se)]),_:1}),r[18]||(r[18]=o(" 保存 ",-1))]),_:1},8,["loading"]),e(_e,{title:"确认删除该技能？",onConfirm:Ll},{reference:t(()=>[e(K,{size:"small",type:"danger",plain:""},{default:t(()=>[e(x,null,{default:t(()=>[e(ge)]),_:1})]),_:1})]),_:1})])]),s("div",Pa,[s("div",Ka,[s("div",Ra,[r[19]||(r[19]=o(" 目录 ",-1)),e(K,{link:"",size:"small",loading:te.value,onClick:Ce,style:{"margin-left":"auto",padding:"0"}},{default:t(()=>[e(x,null,{default:t(()=>[e(T)]),_:1})]),_:1},8,["loading"])]),s("div",Oa,[e(x,null,{default:t(()=>[e(Ve)]),_:1}),s("span",null,v(f.value.id)+"/",1)]),s("div",{class:pl(["tree-item",{"tree-active":V.value==="meta"}]),onClick:r[1]||(r[1]=_=>V.value="meta")},[e(x,null,{default:t(()=>[e(oe)]),_:1}),r[20]||(r[20]=s("span",null,"skill.json",-1))],2),(i(!0),c(F,null,J(le.value,_=>(i(),c("div",{key:_.path,class:pl(["tree-item",{"tree-active":V.value===(_.path==="SKILL.md"?"prompt":_.path),"tree-dir-row":_.isDir}]),style:We({paddingLeft:`${12+_.depth*12}px`}),onClick:ie=>Sl(_.path,_.isDir)},[_.isDir?(i(),k(x,{key:0,style:{color:"#e6a23c"}},{default:t(()=>[e(Ve)]),_:1})):(i(),k(x,{key:1},{default:t(()=>[e(oe)]),_:1})),s("span",null,v(_.name),1),_.path==="SKILL.md"&&f.value.enabled?(i(),k(q,{key:2,size:"small",type:"success",effect:"plain",style:{"margin-left":"4px","font-size":"10px"}},{default:t(()=>[...r[21]||(r[21]=[o("注入中",-1)])]),_:1})):h("",!0)],14,Wa))),128)),!te.value&&le.value.length===0?(i(),c("div",Ya,"空目录")):h("",!0)]),V.value==="meta"?(i(),c("div",Ha,[s("div",Ja,[e(x,null,{default:t(()=>[e(oe)]),_:1}),r[22]||(r[22]=o(" skill.json ",-1)),r[23]||(r[23]=s("span",{class:"file-hint"},"技能元信息，影响列表展示和 runner 行为",-1))]),e(Al,{model:z.value,"label-width":"72px",size:"small",style:{padding:"16px 20px"}},{default:t(()=>[e(we,{label:"技能 ID"},{default:t(()=>[e(ze,{value:f.value.id,disabled:""},null,8,["value"])]),_:1}),e(je,{gutter:12},{default:t(()=>[e(P,{span:14},{default:t(()=>[e(we,{label:"名称"},{default:t(()=>[e(ze,{modelValue:z.value.name,"onUpdate:modelValue":r[2]||(r[2]=_=>z.value.name=_),placeholder:"如 翻译助手"},null,8,["modelValue"])]),_:1})]),_:1}),e(P,{span:10},{default:t(()=>[e(we,{label:"图标"},{default:t(()=>[e(ze,{modelValue:z.value.icon,"onUpdate:modelValue":r[3]||(r[3]=_=>z.value.icon=_),placeholder:"emoji"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(je,{gutter:12},{default:t(()=>[e(P,{span:14},{default:t(()=>[e(we,{label:"分类"},{default:t(()=>[e(ze,{modelValue:z.value.category,"onUpdate:modelValue":r[4]||(r[4]=_=>z.value.category=_),placeholder:"如 语言"},null,8,["modelValue"])]),_:1})]),_:1}),e(P,{span:10},{default:t(()=>[e(we,{label:"版本"},{default:t(()=>[e(ze,{modelValue:z.value.version,"onUpdate:modelValue":r[5]||(r[5]=_=>z.value.version=_),placeholder:"1.0.0"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(we,{label:"描述"},{default:t(()=>[e(ze,{modelValue:z.value.description,"onUpdate:modelValue":r[6]||(r[6]=_=>z.value.description=_),type:"textarea",rows:2,placeholder:"简要描述技能功能"},null,8,["modelValue"])]),_:1}),e(we,{label:"状态"},{default:t(()=>[s("div",qa,[e(ne,{modelValue:z.value.enabled,"onUpdate:modelValue":r[7]||(r[7]=_=>z.value.enabled=_)},null,8,["modelValue"]),s("span",Ga,v(z.value.enabled?"已启用，SKILL.md 将注入系统提示":"已禁用"),1)])]),_:1}),e(Il,{style:{"margin-top":"8px"}},{default:t(()=>[e(B,{title:"查看 skill.json 原文"},{default:t(()=>[s("pre",Qa,v(JSON.stringify({id:f.value.id,...z.value},null,2)),1)]),_:1})]),_:1})]),_:1},8,["model"])])):V.value==="prompt"?(i(),c("div",Xa,[s("div",Za,[e(x,null,{default:t(()=>[e(oe)]),_:1}),r[25]||(r[25]=o(" SKILL.md ",-1)),r[26]||(r[26]=s("span",{class:"file-hint"},"注入到 AI System Prompt 的指令内容",-1)),s("div",en,[Te.value?(i(),k(q,{key:0,type:"warning",size:"small"},{default:t(()=>[...r[24]||(r[24]=[o("未保存",-1)])]),_:1})):h("",!0),s("span",ln,v(M.value.length)+" 字符",1),e(K,{size:"small",circle:"",loading:Ae.value,onClick:ye,title:"重新加载"},{default:t(()=>[e(x,null,{default:t(()=>[e(T)]),_:1})]),_:1},8,["loading"])])]),Ye(s("textarea",{"onUpdate:modelValue":r[8]||(r[8]=_=>M.value=_),class:"code-textarea",spellcheck:"false",placeholder:`# 技能名称

## 功能说明
描述该技能的用途…

## 行为规范
- 规范 1
- 规范 2`,onInput:r[9]||(r[9]=_=>Te.value=!0)},null,544),[[yt,M.value]])])):(i(),c("div",tn,[s("div",an,[e(x,null,{default:t(()=>[e(oe)]),_:1}),o(" "+v(V.value)+" ",1),s("div",nn,[pe.value?(i(),k(q,{key:0,type:"warning",size:"small"},{default:t(()=>[...r[27]||(r[27]=[o("未保存",-1)])]),_:1})):h("",!0),s("span",sn,v(Q.value.length)+" 字符",1),e(K,{size:"small",circle:"",loading:X.value,onClick:Qe,title:"重新加载"},{default:t(()=>[e(x,null,{default:t(()=>[e(T)]),_:1})]),_:1},8,["loading"]),e(_e,{title:"确认删除该文件？",onConfirm:r[10]||(r[10]=_=>j(V.value))},{reference:t(()=>[e(K,{size:"small",circle:"",type:"danger",plain:""},{default:t(()=>[e(x,null,{default:t(()=>[e(ge)]),_:1})]),_:1})]),_:1})])]),Ye(s("textarea",{"onUpdate:modelValue":r[11]||(r[11]=_=>Q.value=_),class:"code-textarea",spellcheck:"false",placeholder:`编辑 ${V.value} …`,onInput:r[12]||(r[12]=_=>pe.value=!0)},null,40,on),[[yt,Q.value]])]))])],64)):(i(),c("div",Na,[e(x,{size:"48",color:"#c0c4cc"},{default:t(()=>[e(Ee)]),_:1}),r[15]||(r[15]=s("p",null,"从左侧选择一个技能开始编辑",-1)),e(K,{type:"primary",onClick:el},{default:t(()=>[e(x,null,{default:t(()=>[e(ae)]),_:1}),r[14]||(r[14]=o(" 新建技能",-1))]),_:1})]))]),s("div",un,[s("div",dn,[e(x,null,{default:t(()=>[e(Dl)]),_:1}),r[28]||(r[28]=o(" AI 协作配置 ",-1)),f.value?(i(),c("span",rn,[o(" 当前: "+v(f.value.name)+" ",1),Se.value.size>1?(i(),c("span",vn," ("+v(Se.value.size)+" 个并行生成中) ",1)):h("",!0)])):h("",!0)]),s("div",fn,[(i(!0),c(F,null,J(U.value,_=>Ye((i(),k(zt,{key:_.id,ref_for:!0,ref:ie=>ml(_.id,ie),"agent-id":L(g),context:f.value?.id===_.id?qe.value:"",scenario:"skill-studio","skill-id":_.id,"welcome-message":f.value?.id===_.id?ce.value:"",examples:f.value?.id===_.id?Ge.value:[],compact:"",onResponse:ie=>Ul(_.id),onStreamingChange:ie=>Ne(_.id,ie)},null,8,["agent-id","context","skill-id","welcome-message","examples","onResponse","onStreamingChange"])),[[pa,f.value?.id===_.id]])),128))])])])}}}),mn=$t(pn,[["__scopeId","data-v-3a5bcde8"]]),cn={class:"header-left"},yn={class:"chat-layout"},gn={class:"session-sidebar"},_n={class:"session-sidebar-header"},wn={class:"session-list"},bn=["onClick"],kn={class:"session-item-title"},xn={class:"session-item-meta"},hn={key:0,class:"session-empty"},Cn={class:"at-panel"},Vn={key:0,class:"at-form"},zn={class:"chat-area"},$n={style:{display:"flex","justify-content":"space-between",width:"100%"}},Tn={style:{color:"#999","font-size":"12px"}},Sn={style:{display:"flex","align-items":"center",gap:"8px"}},Ln={style:{"font-weight":"600"}},Un={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"32px 0","font-size":"14px"}},In={style:{display:"flex","align-items":"center",gap:"8px"}},An={style:{"font-size":"13px"}},Dn={style:{"font-size":"13px",color:"#606266"}},Fn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"40px 0"}},Nn={key:1,class:"relations-list"},Mn={class:"relation-info"},Bn={class:"relation-name"},En={class:"relation-tags"},jn={class:"relation-desc"},Pn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Kn={style:{display:"flex",gap:"8px","margin-top":"4px"}},Rn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},On={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"16px 0","font-size":"13px"}},Wn={style:{"font-size":"12px"}},Yn={style:{"font-size":"12px",color:"#606266"}},Hn={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},Jn={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},qn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Gn={style:{"margin-bottom":"16px",display:"flex","align-items":"center",gap:"8px"}},Qn={class:"conv-drawer-body"},Xn={key:0,style:{"text-align":"center","margin-bottom":"12px"}},Zn={class:"conv-msg-list"},es={class:"conv-msg-meta"},ls={class:"conv-msg-role"},ts={key:0,class:"conv-msg-sender"},as={class:"conv-msg-time"},ns={class:"conv-msg-content"},ss={key:0,class:"conv-msg-empty"},os={style:{display:"flex","align-items":"center","justify-content":"space-between"}},is={style:{display:"flex",gap:"4px"}},us={style:{flex:"1","overflow-y":"auto"}},ds={style:{display:"flex","align-items":"center",gap:"5px","line-height":"1.8",width:"100%"}},rs={style:{flex:"1",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},vs={style:{display:"flex","align-items":"center","justify-content":"space-between"}},fs={style:{"font-family":"monospace","font-size":"13px",color:"#606266"}},ps={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},ms={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},cs={class:"channel-card-header"},ys={class:"channel-card-left"},gs={class:"channel-card-name"},_s={key:0,class:"channel-bot-username"},ws={class:"channel-card-actions"},bs={key:0,class:"channel-card-body"},ks={class:"channel-info-row"},xs={class:"channel-info-value"},hs={class:"channel-info-row"},Cs={class:"channel-info-value"},Vs={key:1,class:"channel-card-body"},zs={class:"channel-info-row"},$s={class:"channel-info-value"},Ts={style:{opacity:"0.6","font-size":"11px","margin-left":"3px"}},Ss={class:"pending-section"},Ls=["onClick"],Us={key:0,class:"pending-list"},Is={key:0,style:{"text-align":"center",padding:"12px"}},As={class:"pending-user-info"},Ds={class:"pending-user-name"},Fs={key:0,class:"pending-user-username"},Ns={class:"pending-user-id"},Ms={class:"pending-user-actions"},Bs={key:2,class:"pending-empty"},Es={style:{width:"100%"}},js={style:{display:"flex",gap:"6px","align-items":"center"}},Ps={key:0,style:{"margin-top":"6px",display:"flex","align-items":"center",gap:"6px",color:"#909399","font-size":"13px"}},Ks={key:1,style:{"margin-top":"6px",color:"#67c23a","font-size":"13px"}},Rs={key:2,style:{"margin-top":"6px",color:"#e6a23c","font-size":"13px"}},Os={key:3,style:{"margin-top":"6px",color:"#f56c6c","font-size":"13px"}},Ws={key:4,style:{"margin-top":"4px"}},Ys={class:"channel-url-preview"},Hs={class:"channel-url-text"},Js={class:"channel-url-preview"},qs={class:"channel-url-text"},Gs={style:{padding:"20px","max-width":"800px"}},Qs={style:{display:"flex",gap:"8px","margin-bottom":"16px","align-items":"flex-start"}},Xs={style:{"font-size":"13px"}},Zs=50,eo=ht({__name:"AgentDetailView",setup(Xl){const ve=ma(),g=ve.params.id,U=d(null),fe=d("chat"),f=d(),V=d([]),z=d(!1),M=d();async function Ae(){z.value=!0;try{const n=await ba.list({agentId:g,limit:50});V.value=n.data.sessions}catch{}finally{z.value=!1}}function Te(n){M.value=n.id,f.value?.resumeSession(n.id)}function He(){M.value=void 0,f.value?.startNewSession()}function De(n){M.value=n,setTimeout(Ae,500)}function ke(n){if(!n)return"";const l=Date.now()-n;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分前`:l<864e5?`${Math.floor(l/36e5)}小时前`:`${Math.floor(l/864e5)}天前`}const le=d(!1),te=d(""),Q=d(""),pe=d(!1),X=d([]);function Je(){le.value=!le.value,le.value&&!X.value.length&&ml()}async function ml(){try{const n=await rl.list();X.value=n.data.filter(l=>l.id!==g)}catch{X.value=[]}}function Fe(n){const l=X.value.find(u=>u.id===n);l&&f.value?.fillInput(`@${l.name}: `)}async function Se(){const n=te.value,l=Q.value.trim();if(!n||!l)return;const C=X.value.find(Le=>Le.id===n)?.name??n;pe.value=!0;const E={role:"user",text:`→ 转发给 ${C}：
${l}`};f.value?.appendMessage(E);try{const S=(await rl.message(n,l,g)).data.response,de={role:"assistant",text:`← **${C}** 回复：

${S}`};f.value?.appendMessage(de),Q.value="",te.value="",le.value=!1,m.success(`${C} 已回复`)}catch(Le){const S={role:"system",text:`[失败] 转发失败：${Le.response?.data?.error??Le.message??"网络错误"}`};f.value?.appendMessage(S),m.error("转发失败")}finally{pe.value=!1}}const Ne=d(""),me=d(""),qe=d([]),ce=d(""),Ge=d(!1),Y=d([]),xe=d(""),he=d(""),Me=d(!1);function cl(){const n=U.value?.env||{};Y.value=Object.entries(n).map(([l,u])=>({key:l,value:u}))}function Ce(){const n=xe.value.trim();if(!n)return;const l=Y.value.findIndex(u=>u.key===n);l>=0?Y.value[l].value=he.value:Y.value.push({key:n,value:he.value}),xe.value="",he.value=""}function Sl(n){Y.value.splice(n,1)}async function Qe(){Me.value=!0;try{const n={};for(const{key:u,value:C}of Y.value)u.trim()&&(n[u.trim()]=C);const l=await rl.update(g,{env:n});U.value=l.data,m.success("环境变量已保存")}catch{m.error("保存失败")}finally{Me.value=!1}}const j=d({enabled:!1,schedule:"daily",keepTurns:3,focusHint:"",cronJobId:""}),Xe=d(!1),Ze=d(!1);async function Ll(){try{const n=await zl.getConfig(g);j.value=n.data,p()}catch{}}async function el(){Xe.value=!0;try{const n=await zl.setConfig(g,j.value);j.value=n.data,m.success(j.value.enabled?"自动记忆已开启":"自动记忆已关闭")}catch{m.error("保存失败")}finally{Xe.value=!1}}async function Ul(){Ze.value=!0;try{await zl.consolidate(g),m.success("记忆整理已在后台启动（约需10~30秒），稍后自动刷新日志"),setTimeout(p,1e4)}catch{m.error("整理失败")}finally{Ze.value=!1}}const ye=d([]),Be=d(!1);async function p(){Be.value=!0;try{const n=await zl.runLog(g);ye.value=n.data||[]}catch{ye.value=[]}finally{Be.value=!1}}const r=d([]),T=d(""),x=d(""),K=d(!1),ae=d([]),H=d(!1),q=d(""),ne=d(!1),Ee=d(""),yl=d([]),R=d(""),se=d(""),ge=d(null),_e=d(!1),Ve=d(!1),oe=d("");function ze(n){const l=n.split(".").pop()?.toLowerCase()||"";return["md","txt","rst"].includes(l)?"#409eff":["json","yaml","yml","toml"].includes(l)?"#67c23a":["go","py","js","ts","sh","bash"].includes(l)?"#e6a23c":["jpg","jpeg","png","gif","svg","webp"].includes(l)?"#f56c6c":n.startsWith(".")?"#c0c4cc":"#909399"}function we(n){const l=n.split("/").pop()||n,u=l.split(".").pop()?.toLowerCase()||"";return!u||u===l.toLowerCase()?"file":"."+u}const P=d([]),je=d(!1),B=d({agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""});async function Il(){try{const n=await kt.get(g);P.value=n.data.parsed||[]}catch{P.value=[]}}function Al(n){const l=X.value.find(u=>u.id===n);B.value.agentName=l?l.name:n}async function Dl(){if(!B.value.agentId)return;if(P.value.find(l=>l.agentId===B.value.agentId)){m.warning("该成员关系已存在，请先删除再重新添加");return}P.value.push({...B.value}),B.value={agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""},await Zl()}async function _(n){P.value.splice(n,1),await Zl()}function ie(){if(P.value.length===0)return"";const n=`| 成员ID | 成员名称 | 关系类型 | 关系程度 | 说明 |
|--------|--------|--------|--------|------|`,l=P.value.map(u=>`| ${u.agentId} | ${u.agentName} | ${u.relationType} | ${u.strength} | ${u.desc||""} |`).join(`
`);return n+`
`+l}async function Zl(){je.value=!0;try{await kt.put(g,ie()),m.success("关系已保存")}catch{m.error("保存失败")}finally{je.value=!1}}function Fl(n){const l=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399","#B45309","#7C3AED","#0891B2"];let u=0;for(let C=0;C<n.length;C++)u=n.charCodeAt(C)+((u<<5)-u);return l[Math.abs(u)%l.length]??"#409EFF"}function et(n){return n==="上级"?"danger":n==="下级"?"":n==="平级协作"?"success":"info"}function lt(n){return n==="核心"?"danger":n==="常用"?"warning":"info"}const tt=d([]),ll=d(!1),O=d({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function Tt(n){return n==="running"?"success":n==="stopped"?"danger":"info"}function St(n){return n==="running"?"运行中":n==="stopped"?"已停止":"空闲"}function gl(n){return n?n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB":"0 B"}function Lt(n){return new Date(n).toLocaleString()}function at(n){return n?new Date(n).toLocaleString():""}const be=d([]),Nl=d(!1),Pe=d(!1),ue=d(""),_l=d(""),Ml=d(!1),Bl=d(""),w=d({type:"telegram",name:"",enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""}),I=d({loading:!1,status:""});let El=null;function jl(n){return/^\*+$/.test(n)}async function nt(){const n=w.value.botToken;if(!(!n||jl(n))){I.value={loading:!0,status:""};try{const u=(await ee.checkToken(g,n)).data;u.duplicate?I.value={loading:!1,status:"duplicate",usedBy:u.usedBy,usedByCh:u.usedByCh}:u.valid?(I.value={loading:!1,status:"ok",botName:u.botName},!w.value.name&&u.botName&&(w.value.name=u.botName)):I.value={loading:!1,status:"error",error:u.error||"Token 无效"}}catch{I.value={loading:!1,status:"error",error:"网络错误，请重试"}}}}$l(()=>w.value.type,n=>{ue.value||(_l.value=Pl(n))}),$l(()=>w.value.botToken,n=>{I.value={loading:!1,status:""},El&&clearTimeout(El),!(!n||jl(n)||n.length<20||!n.includes(":"))&&(El=setTimeout(nt,800))});function Ke(n,l){return l?`${window.location.origin}/chat/${n}/${l}`:`${window.location.origin}/chat/${n}`}function st(n){navigator.clipboard.writeText(n).then(()=>m.success("链接已复制"))}async function Re(){Nl.value=!0;try{const n=await ee.list(g);be.value=n.data||[]}catch{be.value=[]}finally{Nl.value=!1}}function Pl(n){return n+"-"+Date.now().toString(36)}function Ut(){ue.value="";const n=U.value?.name||"";_l.value=Pl("telegram"),w.value={type:"telegram",name:n,enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""},I.value={loading:!1,status:""},Pe.value=!0}function It(n){ue.value=n.id,w.value={type:n.type,name:n.name,enabled:n.enabled,botToken:n.config?.botToken||"",allowedFrom:n.config?.allowedFrom||"",webPassword:"",webWelcome:n.config?.welcomeMsg||"",webTitle:n.config?.title||""},I.value={loading:!1,status:""},Pe.value=!0}async function At(){if(!w.value.name||!w.value.type){m.warning("请填写名称和类型");return}if(I.value.status==="duplicate"){m.error(`Bot Token 已被成员「${I.value.usedBy}」使用，请更换`);return}Ml.value=!0;try{const n={};if(w.value.type==="telegram"?(w.value.botToken&&(n.botToken=w.value.botToken),w.value.allowedFrom&&(n.allowedFrom=w.value.allowedFrom)):w.value.type==="web"&&(w.value.webPassword&&(n.password=w.value.webPassword),w.value.webWelcome&&(n.welcomeMsg=w.value.webWelcome),w.value.webTitle&&(n.title=w.value.webTitle)),ue.value){const l=be.value.map(u=>u.id!==ue.value?u:{...u,name:w.value.name,type:w.value.type,enabled:w.value.enabled,config:{...u.config,...n}});await ee.set(g,l)}else{const l={id:_l.value||Pl(w.value.type),name:w.value.name,type:w.value.type,enabled:w.value.enabled,config:n,status:"untested"};await ee.set(g,[...be.value,l])}m.success(w.value.type==="web"?"保存成功，Web 聊天页立即生效":"保存成功，重启后新渠道生效"),Pe.value=!1,await Re()}catch(n){m.error(n.response?.data?.error||"保存失败")}finally{Ml.value=!1}}async function Dt(){try{await ee.set(g,be.value)}catch(n){m.error(n.response?.data?.error||"保存失败"),await Re()}}async function Ft(n){const l=be.value.filter(u=>u.id!==n.id);try{await ee.set(g,l),be.value=l,m.success("已删除")}catch{m.error("删除失败")}}async function Nt(n){Bl.value=n.id;try{const l=await ee.test(g,n.id);l.data.valid?m.success(l.data.botName?`测试成功 (@${l.data.botName})`:"测试成功"):m.error(l.data.error||"测试失败"),await Re()}catch{m.error("测试请求失败")}finally{Bl.value=""}}const Oe=d({}),Kl=d({}),tl=d(""),Rl=d("");async function wl(n){Kl.value[n]=!0;try{const l=await ee.listPending(g,n);Oe.value[n]=l.data||[]}catch{Oe.value[n]=[]}finally{Kl.value[n]=!1}}function Mt(n){tl.value===n?tl.value="":(tl.value=n,wl(n))}async function Bt(n,l){Rl.value=`${n}-${l}`;try{await ee.allowUser(g,n,l),m.success(`用户 ${l} 已加入白名单`),await wl(n),await Re()}catch{m.error("操作失败")}finally{Rl.value=""}}async function Et(n,l){try{await ee.dismissUser(g,n,l),m.success("已忽略"),await wl(n)}catch{m.error("操作失败")}}async function ot(n,l){try{await bt.confirm(`确定将用户 ${l} 从白名单中移除？移除后该用户将无法使用此 Bot。`,"移除白名单",{confirmButtonText:"确认移除",cancelButtonText:"取消",type:"warning"})}catch{return}try{await ee.removeAllowed(g,n,l),m.success(`用户 ${l} 已从白名单移除`),await Re()}catch{m.error("操作失败")}}Ct(async()=>{try{const u=await rl.get(g);U.value=u.data}catch{m.error("加载 Agent 失败")}jt(),Pt(),Il(),ml(),Ll(),bl(),kl(),Re(),cl(),await Ae();const n=ve.query.tab;n&&(fe.value=n);const l=ve.query.resumeSession;l&&(M.value=l,await new Promise(C=>setTimeout(C,100)),f.value?.resumeSession(l),V.value.find(C=>C.id===l)||(M.value=l))});async function jt(){try{const[n,l]=await Promise.all([G.read(g,"IDENTITY.md"),G.read(g,"SOUL.md")]);Ne.value=n.data?.content||"",me.value=l.data?.content||""}catch{}al()}async function Ol(n,l){try{await G.write(g,n,l),m.success(`${n} 已保存`)}catch{m.error(`保存 ${n} 失败`)}}async function Pt(){try{const n=await wa.list();if(qe.value=n.data||[],U.value?.modelId)ce.value=U.value.modelId;else{const l=qe.value.find(u=>u.provider+"/"+u.model===U.value?.model||u.id===U.value?.model);ce.value=l?.id||""}}catch{}}async function Kt(){if(ce.value){Ge.value=!0;try{const n=await rl.update(g,{modelId:ce.value});U.value=n.data,m.success("模型已更新")}catch{m.error("更新失败")}finally{Ge.value=!1}}}async function al(){try{const n=await vl.tree(g);r.value=n.data||[]}catch{r.value=[]}}async function Rt(n){if(!n.isDir){T.value=n.path,ae.value=n.path.split("/");try{const l=await vl.readFile(g,n.path);x.value=l.data?.content||""}catch{x.value="(无法读取)"}}}async function Ot(){if(T.value){K.value=!0;try{await vl.writeFile(g,T.value,x.value),m.success("记忆文件已保存"),al()}catch{m.error("保存失败")}finally{K.value=!1}}}async function Wt(){const n=q.value.trim();if(!n){m.warning("请输入路径");return}try{await vl.writeFile(g,n,`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`),m.success("文件已创建"),H.value=!1,q.value="",al(),T.value=n,ae.value=n.split("/"),x.value=`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`}catch{m.error("创建失败")}}async function Yt(){const n=Ee.value.trim();if(!n){m.warning("请输入内容");return}try{await vl.dailyLog(g,n),m.success("日志已添加"),ne.value=!1,Ee.value="",al()}catch{m.error("添加失败")}}async function bl(){try{const n=await G.readTree(g);Array.isArray(n.data)&&(yl.value=n.data)}catch{}}async function Ht(n){if(!n.isDir){R.value=n.path||n.name,ge.value=n,_e.value=!1;try{const l=await G.read(g,R.value);l.data?.encoding==="base64"?(_e.value=!0,se.value=`[二进制文件 ${gl(l.data.size)}]`):se.value=l.data?.content??""}catch{se.value=""}}}async function Jt(){if(R.value)try{await bt.confirm(`删除「${R.value}」？此操作不可恢复`,"删除文件",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}),await G.delete(g,R.value),m.success("已删除"),R.value="",se.value="",ge.value=null,bl()}catch(n){n!=="cancel"&&m.error("删除失败")}}async function it(){const n=oe.value.trim();if(n)try{await G.write(g,n,""),m.success(`已创建 ${n}`),Ve.value=!1,oe.value="",await bl(),R.value=n,se.value="",ge.value=null,_e.value=!1}catch{m.error("创建失败")}}async function qt(){R.value&&await Ol(R.value,se.value)}async function kl(){try{const n=await fl.list(g);tt.value=n.data||[]}catch{}}async function Gt(){try{await fl.create({name:O.value.name,enabled:O.value.enabled,agentId:g,schedule:{kind:"cron",expr:O.value.expr,tz:O.value.tz},payload:{kind:"agentTurn",message:O.value.message},delivery:{mode:"announce"}}),m.success("任务创建成功"),ll.value=!1,kl()}catch(n){m.error(n.response?.data?.error||"创建失败")}}async function Qt(n){try{await fl.update(n.id,n)}catch{m.error("更新失败")}}async function ut(n){try{await fl.run(n.id),m.success("已触发运行"),setTimeout(kl,2e3)}catch{m.error("运行失败")}}async function Xt(n){try{await fl.delete(n.id),m.success("已删除"),kl()}catch{m.error("删除失败")}}const xl=d(!1),Wl=d([]),Yl=d(!1),Hl=d(""),$e=d([]),Jl=d(0),hl=d(0),Zt=Tl(()=>$e.value.length<Jl.value),nl=d(!1);async function dt(){xl.value=!0;try{const n=await xt.list(g);Wl.value=n.data}catch{m.error("加载对话渠道失败")}finally{xl.value=!1}}async function ea(n){Hl.value=n.channelId,$e.value=[],Jl.value=0,hl.value=0,Yl.value=!0,await rt()}async function rt(){nl.value=!0;try{const l=(await xt.messages(g,Hl.value,{limit:Zs,offset:hl.value})).data;Jl.value=l.total,hl.value===0?$e.value=l.messages:$e.value=[...l.messages,...$e.value],hl.value+=l.messages.length}catch{m.error("加载消息失败")}finally{nl.value=!1}}async function la(){await rt()}return $l(fe,n=>{n==="convlogs"&&Wl.value.length===0&&dt()}),(n,l)=>{const u=y("el-button"),C=y("el-tag"),E=y("el-text"),Le=y("el-header"),S=y("el-option"),de=y("el-select"),A=y("el-input"),re=y("el-tab-pane"),$=y("el-form-item"),Ue=y("el-form"),Z=y("el-card"),W=y("el-col"),Ie=y("el-row"),vt=y("el-badge"),N=y("el-table-column"),sl=y("el-table"),ol=y("el-switch"),ta=y("el-input-number"),D=y("el-icon"),ft=y("el-tree"),Cl=y("el-empty"),pt=y("el-breadcrumb-item"),aa=y("el-breadcrumb"),il=y("el-dialog"),na=y("el-drawer"),sa=y("Delete"),oa=y("el-link"),ia=y("CircleCheck"),ua=y("Warning"),da=y("CircleClose"),mt=y("InfoFilled"),ct=y("Link"),ra=y("el-tabs"),va=y("el-main"),fa=y("el-container"),ql=_a("loading");return i(),k(fa,{class:"agent-detail"},{default:t(()=>[e(Le,{class:"detail-header"},{default:t(()=>[s("div",cn,[e(u,{icon:L(ca),onClick:l[0]||(l[0]=a=>n.$router.push("/agents")),circle:""},null,8,["icon"]),s("h2",null,v(U.value?.name||"..."),1),e(C,{type:Tt(U.value?.status)},{default:t(()=>[o(v(St(U.value?.status)),1)]),_:1},8,["type"])]),e(E,{type:"info"},{default:t(()=>[o(v(U.value?.model),1)]),_:1})]),_:1}),e(va,null,{default:t(()=>[e(ra,{modelValue:fe.value,"onUpdate:modelValue":l[52]||(l[52]=a=>fe.value=a),type:"border-card"},{default:t(()=>[e(re,{label:"对话",name:"chat"},{default:t(()=>[s("div",yn,[s("div",gn,[s("div",_n,[l[54]||(l[54]=s("span",{class:"sidebar-title"},"历史对话",-1)),e(u,{size:"small",type:"primary",plain:"",onClick:He,icon:L(ul)},{default:t(()=>[...l[53]||(l[53]=[o("新建",-1)])]),_:1},8,["icon"])]),Ye((i(),c("div",wn,[(i(!0),c(F,null,J(V.value,a=>(i(),c("div",{key:a.id,class:pl(["session-item",{active:M.value===a.id}]),onClick:b=>Te(a)},[s("div",kn,v(a.title||"新对话"),1),s("div",xn,[s("span",null,v(ke(a.lastAt)),1),e(C,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[o(v(a.messageCount)+" 条 ",1)]),_:2},1024),a.tokenEstimate>6e4?(i(),k(C,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[o("~"+v(Math.round(a.tokenEstimate/1e3))+"k",1)]),_:2},1024)):h("",!0)])],10,bn))),128)),!z.value&&!V.value.length?(i(),c("div",hn," 还没有对话记录 ")):h("",!0)])),[[ql,z.value]]),s("div",Cn,[e(u,{size:"small",plain:"",class:"at-toggle-btn",onClick:Je},{default:t(()=>[...l[55]||(l[55]=[s("span",{class:"at-icon"},"@",-1),o(" 其他成员 ",-1)])]),_:1}),le.value?(i(),c("div",Vn,[e(de,{modelValue:te.value,"onUpdate:modelValue":l[1]||(l[1]=a=>te.value=a),placeholder:"选择成员",size:"small",style:{width:"100%","margin-bottom":"6px"},onChange:Fe},{default:t(()=>[(i(!0),c(F,null,J(X.value,a=>(i(),k(S,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e(A,{modelValue:Q.value,"onUpdate:modelValue":l[2]||(l[2]=a=>Q.value=a),type:"textarea",rows:3,placeholder:"输入要转发的消息…",size:"small",style:{"margin-bottom":"6px"}},null,8,["modelValue"]),e(u,{type:"primary",size:"small",style:{width:"100%"},loading:pe.value,disabled:!te.value||!Q.value.trim(),onClick:Se},{default:t(()=>[...l[56]||(l[56]=[o(" 转发 ",-1)])]),_:1},8,["loading","disabled"])])):h("",!0)])]),s("div",zn,[e(zt,{ref_key:"aiChatRef",ref:f,"agent-id":L(g),scenario:"agent-detail","welcome-message":`你好！我是 **${U.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:De},null,8,["agent-id","welcome-message"])])])]),_:1}),e(re,{label:"身份 & 灵魂",name:"identity"},{default:t(()=>[e(Z,{style:{"margin-bottom":"16px"}},{header:t(()=>[...l[57]||(l[57]=[s("span",{style:{"font-weight":"600"}},"基本设置",-1)])]),default:t(()=>[e(Ue,{"label-width":"80px",size:"default"},{default:t(()=>[e($,{label:"使用模型"},{default:t(()=>[e(de,{modelValue:ce.value,"onUpdate:modelValue":l[3]||(l[3]=a=>ce.value=a),placeholder:"选择模型",style:{width:"280px","margin-right":"10px"}},{default:t(()=>[(i(!0),c(F,null,J(qe.value,a=>(i(),k(S,{key:a.id,label:a.name||a.model,value:a.id},{default:t(()=>[s("div",$n,[s("span",null,v(a.name||a.model),1),s("span",Tn,v(a.provider),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),e(u,{type:"primary",loading:Ge.value,onClick:Kt,disabled:!ce.value},{default:t(()=>[...l[58]||(l[58]=[o("保存",-1)])]),_:1},8,["loading","disabled"]),U.value?.model?(i(),k(E,{key:0,type:"info",style:{"margin-left":"12px","font-size":"12px"}},{default:t(()=>[o(" 当前："+v(U.value.model),1)]),_:1})):h("",!0)]),_:1})]),_:1})]),_:1}),e(Ie,{gutter:20},{default:t(()=>[e(W,{span:12},{default:t(()=>[e(Z,{header:"IDENTITY.md"},{default:t(()=>[e(A,{modelValue:Ne.value,"onUpdate:modelValue":l[4]||(l[4]=a=>Ne.value=a),type:"textarea",rows:15,onBlur:l[5]||(l[5]=a=>Ol("IDENTITY.md",Ne.value))},null,8,["modelValue"])]),_:1})]),_:1}),e(W,{span:12},{default:t(()=>[e(Z,{header:"SOUL.md"},{default:t(()=>[e(A,{modelValue:me.value,"onUpdate:modelValue":l[6]||(l[6]=a=>me.value=a),type:"textarea",rows:15,onBlur:l[7]||(l[7]=a=>Ol("SOUL.md",me.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(re,{label:"关系",name:"relations"},{default:t(()=>[e(Ie,{gutter:20},{default:t(()=>[e(W,{span:14},{default:t(()=>[e(Z,{style:{"margin-bottom":"16px"}},{header:t(()=>[...l[59]||(l[59]=[s("span",{style:{"font-weight":"600"}},"添加关系",-1)])]),default:t(()=>[e(Ue,{model:B.value,"label-position":"top",size:"default"},{default:t(()=>[e(Ie,{gutter:12},{default:t(()=>[e(W,{span:10},{default:t(()=>[e($,{label:"关联成员"},{default:t(()=>[e(de,{modelValue:B.value.agentId,"onUpdate:modelValue":l[8]||(l[8]=a=>B.value.agentId=a),placeholder:"选择系统成员",filterable:"",style:{width:"100%"},onChange:Al},{default:t(()=>[(i(!0),c(F,null,J(X.value,a=>(i(),k(S,{key:a.id,label:a.name,value:a.id},{default:t(()=>[s("div",Sn,[s("div",{style:We([{width:"24px",height:"24px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"11px",color:"#fff","flex-shrink":"0"},{background:Fl(a.id)}])},v(a.name.charAt(0)),5),s("span",null,v(a.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(W,{span:7},{default:t(()=>[e($,{label:"关系类型"},{default:t(()=>[e(de,{modelValue:B.value.relationType,"onUpdate:modelValue":l[9]||(l[9]=a=>B.value.relationType=a),style:{width:"100%"}},{default:t(()=>[e(S,{label:"上级",value:"上级"}),e(S,{label:"下级",value:"下级"}),e(S,{label:"平级协作",value:"平级协作"}),e(S,{label:"支持",value:"支持"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(W,{span:7},{default:t(()=>[e($,{label:"协作程度"},{default:t(()=>[e(de,{modelValue:B.value.strength,"onUpdate:modelValue":l[10]||(l[10]=a=>B.value.strength=a),style:{width:"100%"}},{default:t(()=>[e(S,{label:"核心",value:"核心"}),e(S,{label:"常用",value:"常用"}),e(S,{label:"偶尔",value:"偶尔"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(Ie,{gutter:12},{default:t(()=>[e(W,{span:18},{default:t(()=>[e($,{label:"说明（选填）"},{default:t(()=>[e(A,{modelValue:B.value.desc,"onUpdate:modelValue":l[11]||(l[11]=a=>B.value.desc=a),placeholder:"简要描述这段关系..."},null,8,["modelValue"])]),_:1})]),_:1}),e(W,{span:6},{default:t(()=>[e($,{label:" "},{default:t(()=>[e(u,{type:"primary",style:{width:"100%"},disabled:!B.value.agentId||!B.value.relationType||!B.value.strength,loading:je.value,onClick:Dl},{default:t(()=>[...l[60]||(l[60]=[o(" 添加 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(Z,null,{header:t(()=>[s("span",Ln,[l[61]||(l[61]=o("已有关系 ",-1)),e(vt,{value:P.value.length,type:"info",style:{"margin-left":"4px"}},null,8,["value"])])]),default:t(()=>[P.value.length===0?(i(),c("div",Un," 暂无关系，请在上方添加 ")):(i(),k(sl,{key:1,data:P.value,size:"small",style:{width:"100%"}},{default:t(()=>[e(N,{label:"成员","min-width":"120"},{default:t(({row:a})=>[s("div",In,[s("div",{style:We([{width:"28px",height:"28px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"12px",color:"#fff","flex-shrink":"0"},{background:Fl(a.agentId)}])},v(a.agentName.charAt(0)),5),s("span",An,v(a.agentName),1)])]),_:1}),e(N,{label:"类型",width:"100"},{default:t(({row:a})=>[e(C,{type:et(a.relationType),size:"small"},{default:t(()=>[o(v(a.relationType),1)]),_:2},1032,["type"])]),_:1}),e(N,{label:"程度",width:"80"},{default:t(({row:a})=>[e(C,{type:lt(a.strength),size:"small",effect:"plain"},{default:t(()=>[o(v(a.strength),1)]),_:2},1032,["type"])]),_:1}),e(N,{label:"说明","min-width":"120","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",Dn,v(a.desc||"—"),1)]),_:1}),e(N,{label:"操作",width:"70",fixed:"right"},{default:t(({$index:a})=>[e(u,{type:"danger",link:"",size:"small",onClick:b=>_(a)},{default:t(()=>[...l[62]||(l[62]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})]),_:1}),e(W,{span:10},{default:t(()=>[e(Z,{header:"关系预览"},{default:t(()=>[P.value.length===0?(i(),c("div",Fn," 暂无关系数据 ")):(i(),c("div",Nn,[(i(!0),c(F,null,J(P.value,a=>(i(),c("div",{key:a.agentId,class:"relation-card"},[s("div",{class:"relation-avatar",style:We({background:Fl(a.agentId)})},v(a.agentName.charAt(0).toUpperCase()),5),s("div",Mn,[s("div",Bn,v(a.agentName),1),s("div",En,[e(C,{type:et(a.relationType),size:"small"},{default:t(()=>[o(v(a.relationType),1)]),_:2},1032,["type"]),e(C,{type:lt(a.strength),size:"small",effect:"plain"},{default:t(()=>[o(v(a.strength),1)]),_:2},1032,["type"])]),s("div",jn,v(a.desc),1)])]))),128))]))]),_:1})]),_:1})]),_:1})]),_:1}),e(re,{label:"记忆",name:"memory"},{default:t(()=>[e(Z,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",Pn,[l[63]||(l[63]=s("span",{style:{"font-weight":"600"}},"自动记忆",-1)),e(ol,{modelValue:j.value.enabled,"onUpdate:modelValue":l[12]||(l[12]=a=>j.value.enabled=a),"active-text":"已开启","inactive-text":"已关闭",onChange:el},null,8,["modelValue"])])]),default:t(()=>[e(Ue,{model:j.value,"label-position":"top",size:"small",disabled:!j.value.enabled},{default:t(()=>[e(Ie,{gutter:16},{default:t(()=>[e(W,{span:6},{default:t(()=>[e($,{label:"整理频率"},{default:t(()=>[e(de,{modelValue:j.value.schedule,"onUpdate:modelValue":l[13]||(l[13]=a=>j.value.schedule=a),style:{width:"100%"}},{default:t(()=>[e(S,{label:"每小时",value:"hourly"}),e(S,{label:"每6小时",value:"every6h"}),e(S,{label:"每天",value:"daily"}),e(S,{label:"每周",value:"weekly"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(W,{span:5},{default:t(()=>[e($,{label:"每个会话保留轮数"},{default:t(()=>[e(ta,{modelValue:j.value.keepTurns,"onUpdate:modelValue":l[14]||(l[14]=a=>j.value.keepTurns=a),min:1,max:20,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(W,{span:13},{default:t(()=>[e($,{label:"记录重点（留空则自动）"},{default:t(()=>[e(A,{modelValue:j.value.focusHint,"onUpdate:modelValue":l[15]||(l[15]=a=>j.value.focusHint=a),placeholder:"例如：记录数学解题步骤和用户常见错误"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s("div",Kn,[e(u,{type:"primary",size:"small",loading:Xe.value,onClick:el},{default:t(()=>[...l[64]||(l[64]=[o(" 保存设置 ",-1)])]),_:1},8,["loading"]),e(u,{size:"small",loading:Ze.value,onClick:Ul},{default:t(()=>[...l[65]||(l[65]=[o(" 立即整理 ",-1)])]),_:1},8,["loading"]),e(E,{type:"info",size:"small",style:{"align-self":"center","margin-left":"4px"}},{default:t(()=>[o(" 整理后：LLM提炼摘要写入 MEMORY.md，每个会话只保留最近 "+v(j.value.keepTurns)+" 轮对话 ",1)]),_:1})])]),_:1},8,["model","disabled"])]),_:1}),e(Z,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",Rn,[l[67]||(l[67]=s("span",{style:{"font-weight":"600"}},"整理日志",-1)),e(u,{size:"small",text:"",onClick:p,loading:Be.value},{default:t(()=>[...l[66]||(l[66]=[o("刷新",-1)])]),_:1},8,["loading"])])]),default:t(()=>[ye.value.length===0&&!Be.value?(i(),c("div",On," 暂无运行记录，点击「立即整理」触发第一次 ")):(i(),k(sl,{key:1,data:ye.value.slice(0,20),size:"small"},{default:t(()=>[e(N,{label:"时间",width:"160"},{default:t(({row:a})=>[s("span",Wn,v(at(a.timestamp)),1)]),_:1}),e(N,{label:"状态",width:"72"},{default:t(({row:a})=>[e(C,{type:a.status==="ok"?"success":"danger",size:"small"},{default:t(()=>[o(v(a.status),1)]),_:2},1032,["type"])]),_:1}),e(N,{label:"结果","min-width":"200","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",Yn,v(a.message||"—"),1)]),_:1})]),_:1},8,["data"]))]),_:1}),s("div",Hn,[e(u,{type:"primary",size:"small",onClick:l[16]||(l[16]=a=>H.value=!0)},{default:t(()=>[e(D,null,{default:t(()=>[e(L(ul))]),_:1}),l[68]||(l[68]=o(" 新建文件 ",-1))]),_:1}),e(u,{size:"small",onClick:l[17]||(l[17]=a=>ne.value=!0)},{default:t(()=>[e(D,null,{default:t(()=>[e(L(ya))]),_:1}),l[69]||(l[69]=o(" 添加日志 ",-1))]),_:1}),e(u,{size:"small",onClick:al},{default:t(()=>[e(D,null,{default:t(()=>[e(L(Vl))]),_:1}),l[70]||(l[70]=o(" 刷新 ",-1))]),_:1})]),e(Ie,{gutter:16},{default:t(()=>[e(W,{span:7},{default:t(()=>[e(Z,{header:"记忆目录",shadow:"hover"},{default:t(()=>[e(ft,{data:r.value,props:{label:"name",children:"children",isLeaf:a=>!a.isDir},onNodeClick:Rt,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:t(({data:a})=>[s("span",Jn,[a.isDir?(i(),k(D,{key:0,style:{color:"#E6A23C"}},{default:t(()=>[e(L(_t))]),_:1})):(i(),k(D,{key:1,style:{color:"#409EFF"}},{default:t(()=>[e(L(wt))]),_:1})),s("span",null,v(a.name),1),!a.isDir&&a.size?(i(),k(E,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:t(()=>[o(v(gl(a.size)),1)]),_:2},1024)):h("",!0)])]),_:1},8,["data","props"]),r.value.length===0?(i(),k(Cl,{key:0,description:"记忆树为空","image-size":40})):h("",!0)]),_:1})]),_:1}),e(W,{span:17},{default:t(()=>[e(Z,{shadow:"hover"},{header:t(()=>[s("div",qn,[e(aa,{separator:"/"},{default:t(()=>[e(pt,null,{default:t(()=>[...l[71]||(l[71]=[o("memory",-1)])]),_:1}),(i(!0),c(F,null,J(ae.value,(a,b)=>(i(),k(pt,{key:b},{default:t(()=>[o(v(a),1)]),_:2},1024))),128))]),_:1}),T.value?(i(),k(u,{key:0,type:"primary",size:"small",onClick:Ot,loading:K.value},{default:t(()=>[...l[72]||(l[72]=[o("保存",-1)])]),_:1},8,["loading"])):h("",!0)])]),default:t(()=>[T.value?(i(),k(A,{key:0,modelValue:x.value,"onUpdate:modelValue":l[18]||(l[18]=a=>x.value=a),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(i(),k(Cl,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),e(il,{modelValue:H.value,"onUpdate:modelValue":l[21]||(l[21]=a=>H.value=a),title:"新建记忆文件",width:"480px"},{footer:t(()=>[e(u,{onClick:l[20]||(l[20]=a=>H.value=!1)},{default:t(()=>[...l[74]||(l[74]=[o("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:Wt},{default:t(()=>[...l[75]||(l[75]=[o("创建",-1)])]),_:1})]),default:t(()=>[e(Ue,{"label-width":"80px"},{default:t(()=>[e($,{label:"路径"},{default:t(()=>[e(A,{modelValue:q.value,"onUpdate:modelValue":l[19]||(l[19]=a=>q.value=a),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),e(E,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:t(()=>[...l[73]||(l[73]=[o("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(il,{modelValue:ne.value,"onUpdate:modelValue":l[24]||(l[24]=a=>ne.value=a),title:"添加今日日志",width:"600px"},{footer:t(()=>[e(u,{onClick:l[23]||(l[23]=a=>ne.value=!1)},{default:t(()=>[...l[76]||(l[76]=[o("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:Yt},{default:t(()=>[...l[77]||(l[77]=[o("提交",-1)])]),_:1})]),default:t(()=>[e(A,{modelValue:Ee.value,"onUpdate:modelValue":l[22]||(l[22]=a=>Ee.value=a),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),e(re,{label:"技能",name:"skills"},{default:t(()=>[e(mn,{"agent-id":L(g)},null,8,["agent-id"])]),_:1}),e(re,{label:"历史对话",name:"convlogs"},{default:t(()=>[s("div",Gn,[l[78]||(l[78]=s("span",{style:{"font-weight":"600","font-size":"15px"}},"渠道对话记录",-1)),e(u,{size:"small",icon:L(Vl),circle:"",onClick:dt,loading:xl.value},null,8,["icon","loading"])]),Ye((i(),k(sl,{data:Wl.value,stripe:"","empty-text":"暂无对话记录"},{default:t(()=>[e(N,{label:"渠道","min-width":"200"},{default:t(({row:a})=>[s("span",null,v(a.channelType==="telegram"?"Telegram":"Web")+" "+v(a.channelId),1)]),_:1}),e(N,{label:"消息数",width:"100"},{default:t(({row:a})=>[o(v(a.messageCount)+" 条",1)]),_:1}),e(N,{label:"最后活跃",width:"180"},{default:t(({row:a})=>[o(v(a.lastAt?new Date(a.lastAt).toLocaleString("zh-CN"):"-"),1)]),_:1}),e(N,{label:"操作",width:"100"},{default:t(({row:a})=>[e(u,{size:"small",type:"primary",plain:"",onClick:b=>ea(a)},{default:t(()=>[...l[79]||(l[79]=[o("查看",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ql,xl.value]]),e(na,{modelValue:Yl.value,"onUpdate:modelValue":l[25]||(l[25]=a=>Yl.value=a),title:Hl.value+" 对话记录",direction:"rtl",size:"520px","destroy-on-close":!1},{default:t(()=>[s("div",Qn,[Zt.value?(i(),c("div",Xn,[e(u,{size:"small",plain:"",loading:nl.value,onClick:la},{default:t(()=>[...l[80]||(l[80]=[o("加载更多",-1)])]),_:1},8,["loading"])])):h("",!0),Ye((i(),c("div",Zn,[(i(!0),c(F,null,J($e.value,(a,b)=>(i(),c("div",{key:b,class:pl(["conv-msg-item",a.role==="user"?"conv-msg-user":"conv-msg-assistant"])},[s("div",es,[s("span",ls,v(a.role==="user"?"用户":"助手"),1),a.sender?(i(),c("span",ts,v(a.sender),1)):h("",!0),s("span",as,v(a.ts?new Date(a.ts).toLocaleString("zh-CN"):""),1)]),s("div",ns,v(a.content),1)],2))),128)),!nl.value&&$e.value.length===0?(i(),c("div",ss," 暂无消息记录 ")):h("",!0)])),[[ql,nl.value&&$e.value.length===0]])])]),_:1},8,["modelValue","title"])]),_:1}),e(re,{label:"工作区",name:"workspace"},{default:t(()=>[e(Ie,{gutter:16},{default:t(()=>[e(W,{span:7},{default:t(()=>[e(Z,{shadow:"never",style:{height:"calc(100vh - 200px)",display:"flex","flex-direction":"column"}},{header:t(()=>[s("div",os,[l[81]||(l[81]=s("span",null,"文件列表",-1)),s("div",is,[e(u,{text:"",size:"small",onClick:l[26]||(l[26]=a=>Ve.value=!0),title:"新建文件"},{default:t(()=>[e(D,null,{default:t(()=>[e(L(ul))]),_:1})]),_:1}),e(u,{text:"",size:"small",onClick:bl,title:"刷新"},{default:t(()=>[e(D,null,{default:t(()=>[e(L(Vl))]),_:1})]),_:1})])])]),default:t(()=>[s("div",us,[e(ft,{data:yl.value,props:{label:"name",children:"children"},onNodeClick:Ht,"highlight-current":"","default-expand-all":"",style:{"font-size":"13px"}},{default:t(({data:a})=>[s("span",ds,[a.isDir?(i(),k(D,{key:0,style:{color:"#e6a23c","font-size":"14px"}},{default:t(()=>[e(L(_t))]),_:1})):(i(),k(D,{key:1,style:We({color:ze(a.name),fontSize:"14px"})},{default:t(()=>[e(L(wt))]),_:1},8,["style"])),s("span",rs,v(a.name),1),a.isDir?h("",!0):(i(),k(E,{key:2,type:"info",size:"small",style:{"flex-shrink":"0","font-size":"11px"}},{default:t(()=>[o(v(gl(a.size)),1)]),_:2},1024))])]),_:1},8,["data"])])]),_:1})]),_:1}),e(W,{span:17},{default:t(()=>[e(Z,{shadow:"never",style:{height:"calc(100vh - 200px)",display:"flex","flex-direction":"column"}},{header:t(()=>[s("div",vs,[s("span",fs,[o(v(R.value||"选择文件查看")+" ",1),R.value?(i(),k(C,{key:0,size:"small",style:{"margin-left":"6px","font-size":"11px"}},{default:t(()=>[o(v(we(R.value)),1)]),_:1})):h("",!0)]),R.value?(i(),k(u,{key:0,text:"",size:"small",type:"danger",title:"删除文件",onClick:Jt},{default:t(()=>[e(D,null,{default:t(()=>[e(sa)]),_:1})]),_:1})):h("",!0)])]),default:t(()=>[R.value?(i(),c(F,{key:0},[e(A,{modelValue:se.value,"onUpdate:modelValue":l[27]||(l[27]=a=>se.value=a),type:"textarea",autosize:!1,placeholder:_e.value?"二进制文件，无法编辑":"（空文件）",readonly:_e.value,style:{flex:"1","font-family":"monospace","font-size":"13px"},rows:22},null,8,["modelValue","placeholder","readonly"]),s("div",ps,[e(u,{type:"primary",disabled:_e.value,onClick:qt},{default:t(()=>[...l[82]||(l[82]=[o("保存",-1)])]),_:1},8,["disabled"]),ge.value?(i(),k(E,{key:0,type:"info",size:"small"},{default:t(()=>[o(v(gl(ge.value.size))+" · "+v(Lt(ge.value.modTime)),1)]),_:1})):h("",!0)])],64)):(i(),k(Cl,{key:1,description:"从左侧选择文件","image-size":60}))]),_:1})]),_:1})]),_:1}),e(il,{modelValue:Ve.value,"onUpdate:modelValue":l[30]||(l[30]=a=>Ve.value=a),title:"新建文件",width:"400px"},{footer:t(()=>[e(u,{onClick:l[29]||(l[29]=a=>Ve.value=!1)},{default:t(()=>[...l[83]||(l[83]=[o("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:it},{default:t(()=>[...l[84]||(l[84]=[o("创建",-1)])]),_:1})]),default:t(()=>[e(Ue,{"label-width":"80px"},{default:t(()=>[e($,{label:"文件路径"},{default:t(()=>[e(A,{modelValue:oe.value,"onUpdate:modelValue":l[28]||(l[28]=a=>oe.value=a),placeholder:"例如: notes.md 或 idear/my-idea.md",onKeyup:Ql(it,["enter"])},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(re,{label:"定时任务",name:"cron"},{default:t(()=>[e(u,{type:"primary",onClick:l[31]||(l[31]=a=>ll.value=!0),style:{"margin-bottom":"16px"}},{default:t(()=>[e(D,null,{default:t(()=>[e(L(ul))]),_:1}),l[85]||(l[85]=o(" 新建任务 ",-1))]),_:1}),e(sl,{data:tt.value,stripe:""},{default:t(()=>[e(N,{prop:"name",label:"名称"}),e(N,{label:"调度"},{default:t(({row:a})=>[o(v(a.schedule?.expr)+" ("+v(a.schedule?.tz)+")",1)]),_:1}),e(N,{label:"最近运行",width:"180"},{default:t(({row:a})=>[a.state?.lastRunAtMs?(i(),c(F,{key:0},[e(C,{type:a.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:t(()=>[o(v(a.state?.lastStatus),1)]),_:2},1032,["type"]),e(E,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:t(()=>[o(v(at(a.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(i(),k(E,{key:1,type:"info",size:"small"},{default:t(()=>[...l[86]||(l[86]=[o("未运行",-1)])]),_:1}))]),_:1}),e(N,{label:"启用",width:"80"},{default:t(({row:a})=>[e(ol,{modelValue:a.enabled,"onUpdate:modelValue":b=>a.enabled=b,onChange:b=>Qt(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(N,{label:"操作",width:"220"},{default:t(({row:a})=>[a.payload?.message==="__MEMORY_CONSOLIDATE__"?(i(),c(F,{key:0},[e(C,{type:"info",size:"small",style:{"margin-right":"8px"}},{default:t(()=>[...l[87]||(l[87]=[o("记忆管理",-1)])]),_:1}),e(u,{size:"small",onClick:b=>ut(a)},{default:t(()=>[...l[88]||(l[88]=[o("立即运行",-1)])]),_:1},8,["onClick"])],64)):(i(),c(F,{key:1},[e(u,{size:"small",onClick:b=>ut(a)},{default:t(()=>[...l[89]||(l[89]=[o("立即运行",-1)])]),_:1},8,["onClick"]),e(u,{size:"small",type:"danger",onClick:b=>Xt(a)},{default:t(()=>[...l[90]||(l[90]=[o("删除",-1)])]),_:1},8,["onClick"])],64))]),_:1})]),_:1},8,["data"]),e(il,{modelValue:ll.value,"onUpdate:modelValue":l[38]||(l[38]=a=>ll.value=a),title:"新建定时任务",width:"520px"},{footer:t(()=>[e(u,{onClick:l[37]||(l[37]=a=>ll.value=!1)},{default:t(()=>[...l[91]||(l[91]=[o("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:Gt},{default:t(()=>[...l[92]||(l[92]=[o("创建",-1)])]),_:1})]),default:t(()=>[e(Ue,{model:O.value,"label-width":"100px"},{default:t(()=>[e($,{label:"名称"},{default:t(()=>[e(A,{modelValue:O.value.name,"onUpdate:modelValue":l[32]||(l[32]=a=>O.value.name=a)},null,8,["modelValue"])]),_:1}),e($,{label:"Cron 表达式"},{default:t(()=>[e(A,{modelValue:O.value.expr,"onUpdate:modelValue":l[33]||(l[33]=a=>O.value.expr=a),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),e($,{label:"时区"},{default:t(()=>[e(de,{modelValue:O.value.tz,"onUpdate:modelValue":l[34]||(l[34]=a=>O.value.tz=a)},{default:t(()=>[e(S,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),e(S,{label:"UTC",value:"UTC"}),e(S,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),e($,{label:"消息"},{default:t(()=>[e(A,{modelValue:O.value.message,"onUpdate:modelValue":l[35]||(l[35]=a=>O.value.message=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),e($,{label:"启用"},{default:t(()=>[e(ol,{modelValue:O.value.enabled,"onUpdate:modelValue":l[36]||(l[36]=a=>O.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1}),e(re,{label:"渠道",name:"channels"},{default:t(()=>[s("div",ms,[e(E,{type:"info",size:"small"},{default:t(()=>[...l[93]||(l[93]=[o("每个 AI 成员独立配置自己的消息通道（如 Telegram Bot Token）",-1)])]),_:1}),e(u,{type:"primary",size:"small",onClick:Ut},{default:t(()=>[e(D,null,{default:t(()=>[e(L(ul))]),_:1}),l[94]||(l[94]=o(" 添加消息渠道 ",-1))]),_:1})]),(i(!0),c(F,null,J(be.value,a=>(i(),c("div",{key:a.id,class:"channel-card"},[s("div",cs,[s("div",ys,[e(C,{size:"small",style:{"margin-right":"8px"}},{default:t(()=>[o(v(a.type),1)]),_:2},1024),s("span",gs,v(a.name),1),a.config?.botName?(i(),c("span",_s,"@"+v(a.config.botName),1)):h("",!0),e(C,{type:a.status==="ok"?"success":a.status==="error"?"danger":"info",size:"small",effect:"plain",style:{"margin-left":"8px"}},{default:t(()=>[o(v(a.status==="ok"?"✓ 正常":a.status==="error"?"✗ 错误":"未测试"),1)]),_:2},1032,["type"])]),s("div",ws,[e(ol,{modelValue:a.enabled,"onUpdate:modelValue":b=>a.enabled=b,size:"small",onChange:Dt,style:{"margin-right":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),e(u,{size:"small",onClick:b=>Nt(a),loading:Bl.value===a.id},{default:t(()=>[...l[95]||(l[95]=[o("测试连接",-1)])]),_:1},8,["onClick","loading"]),e(u,{size:"small",onClick:b=>It(a)},{default:t(()=>[...l[96]||(l[96]=[o("编辑",-1)])]),_:1},8,["onClick"]),e(u,{size:"small",type:"danger",plain:"",onClick:b=>Ft(a)},{default:t(()=>[...l[97]||(l[97]=[o("删除",-1)])]),_:1},8,["onClick"])])]),a.type==="web"?(i(),c("div",bs,[s("div",ks,[l[99]||(l[99]=s("span",{class:"channel-info-label"},"公开地址",-1)),s("span",xs,[e(oa,{href:Ke(L(g),a.id),target:"_blank",type:"primary",style:{"font-size":"13px"}},{default:t(()=>[o(v(Ke(L(g),a.id)),1)]),_:2},1032,["href"]),e(u,{size:"small",link:"",style:{"margin-left":"8px"},onClick:b=>st(Ke(L(g),a.id))},{default:t(()=>[...l[98]||(l[98]=[o("复制",-1)])]),_:1},8,["onClick"])])]),s("div",hs,[l[100]||(l[100]=s("span",{class:"channel-info-label"},"访问密码",-1)),s("span",Cs,[e(C,{size:"small",type:a.config?.password?"warning":"info",effect:"plain"},{default:t(()=>[o(v(a.config?.password?"已设置":"无密码"),1)]),_:2},1032,["type"])])])])):h("",!0),a.type==="telegram"?(i(),c("div",Vs,[s("div",zs,[l[102]||(l[102]=s("span",{class:"channel-info-label"},"白名单用户",-1)),s("span",$s,[a.allowedFromUsers?.length?(i(!0),c(F,{key:0},J(a.allowedFromUsers,b=>(i(),k(C,{key:b.id,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:Gl=>ot(a.id,b.id)},{default:t(()=>[o(v(b.username?"@"+b.username:b.firstName||String(b.id))+" ",1),s("span",Ts,"("+v(b.id)+")",1)]),_:2},1032,["onClose"]))),128)):a.config?.allowedFrom?(i(!0),c(F,{key:1},J(a.config.allowedFrom.split(","),b=>(i(),k(C,{key:b,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:Gl=>ot(a.id,Number(b.trim()))},{default:t(()=>[o(v(b.trim()),1)]),_:2},1032,["onClose"]))),128)):(i(),k(E,{key:2,type:"warning",size:"small"},{default:t(()=>[...l[101]||(l[101]=[o("未设置（配对模式，向用户返回其 ID）",-1)])]),_:1}))])]),s("div",Ss,[s("div",{class:"pending-section-header",onClick:b=>Mt(a.id)},[l[104]||(l[104]=s("span",null,"待审核用户",-1)),e(vt,{value:(Oe.value[a.id]||[]).length,hidden:!(Oe.value[a.id]||[]).length,type:"warning",style:{"margin-left":"6px"}},null,8,["value","hidden"]),e(u,{size:"small",link:"",onClick:Vt(b=>wl(a.id),["stop"]),style:{"margin-left":"8px"}},{default:t(()=>[...l[103]||(l[103]=[o("刷新",-1)])]),_:1},8,["onClick"]),e(D,{style:We([{"margin-left":"4px",transition:"transform 0.2s"},{transform:tl.value===a.id?"rotate(180deg)":""}])},{default:t(()=>[e(L(ga))]),_:1},8,["style"])],8,Ls),tl.value===a.id?(i(),c("div",Us,[Kl.value[a.id]?(i(),c("div",Is,[e(E,{type:"info",size:"small"},{default:t(()=>[...l[105]||(l[105]=[o("加载中...",-1)])]),_:1})])):(Oe.value[a.id]||[]).length?(i(!0),c(F,{key:1},J(Oe.value[a.id],b=>(i(),c("div",{key:b.id,class:"pending-user-row"},[s("div",As,[s("span",Ds,v(b.firstName||"未知"),1),b.username?(i(),c("span",Fs,"@"+v(b.username),1)):h("",!0),s("span",Ns,"ID: "+v(b.id),1),e(E,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:t(()=>[o(v(ke(b.lastSeen)),1)]),_:2},1024)]),s("div",Ms,[e(u,{size:"small",type:"success",plain:"",onClick:Gl=>Bt(a.id,b.id),loading:Rl.value===`${a.id}-${b.id}`},{default:t(()=>[...l[106]||(l[106]=[o("加入白名单",-1)])]),_:1},8,["onClick","loading"]),e(u,{size:"small",type:"danger",plain:"",onClick:Gl=>Et(a.id,b.id)},{default:t(()=>[...l[107]||(l[107]=[o("忽略",-1)])]),_:1},8,["onClick"])])]))),128)):(i(),c("div",Bs," 暂无待审核用户。让用户向 Bot 发送 /start 即可出现在此处。 "))])):h("",!0)])])):h("",!0)]))),128)),!Nl.value&&!be.value.length?(i(),k(Cl,{key:0,description:"暂无消息渠道，点击「添加消息渠道」开始配置","image-size":80,style:{"margin-top":"40px"}})):h("",!0),e(il,{modelValue:Pe.value,"onUpdate:modelValue":l[49]||(l[49]=a=>Pe.value=a),title:ue.value?"编辑消息渠道":"添加消息渠道",width:"540px"},{footer:t(()=>[e(u,{onClick:l[48]||(l[48]=a=>Pe.value=!1)},{default:t(()=>[...l[117]||(l[117]=[o("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:At,loading:Ml.value},{default:t(()=>[...l[118]||(l[118]=[o("保存",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(Ue,{model:w.value,"label-width":"120px"},{default:t(()=>[e($,{label:"类型",required:""},{default:t(()=>[e(de,{modelValue:w.value.type,"onUpdate:modelValue":l[39]||(l[39]=a=>w.value.type=a),style:{width:"100%"}},{default:t(()=>[e(S,{label:"Telegram",value:"telegram"}),e(S,{label:"Web 聊天页",value:"web"}),e(S,{label:"iMessage",value:"imessage"}),e(S,{label:"WhatsApp",value:"whatsapp"})]),_:1},8,["modelValue"])]),_:1}),e($,{label:"名称",required:""},{default:t(()=>[e(A,{modelValue:w.value.name,"onUpdate:modelValue":l[40]||(l[40]=a=>w.value.name=a),placeholder:"如：客服 Bot"},null,8,["modelValue"])]),_:1}),w.value.type==="telegram"?(i(),c(F,{key:0},[e($,{label:"Bot Token",required:""},{default:t(()=>[s("div",Es,[s("div",js,[e(A,{modelValue:w.value.botToken,"onUpdate:modelValue":l[41]||(l[41]=a=>w.value.botToken=a),type:"password","show-password":"",placeholder:"从 @BotFather 获取",style:{flex:"1"},status:I.value.status==="error"?"error":I.value.status==="ok"?"success":""},null,8,["modelValue","status"]),e(u,{size:"default",loading:I.value.loading,type:I.value.status==="ok"?"success":I.value.status==="error"?"danger":"default",onClick:nt,disabled:!w.value.botToken||jl(w.value.botToken)},{default:t(()=>[...l[108]||(l[108]=[o("验证",-1)])]),_:1},8,["loading","type","disabled"])]),I.value.loading?(i(),c("div",Ps,[e(D,{class:"is-loading"},{default:t(()=>[e(L(Vl))]),_:1}),l[109]||(l[109]=o(" 正在验证 Token… ",-1))])):I.value.status==="ok"?(i(),c("div",Ks,[e(D,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(ia)]),_:1}),l[110]||(l[110]=o("Token 有效，Bot 名称：",-1)),s("b",null,"@"+v(I.value.botName),1)])):I.value.status==="duplicate"?(i(),c("div",Rs,[e(D,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(ua)]),_:1}),l[111]||(l[111]=o("此 Token 已被成员「",-1)),s("b",null,v(I.value.usedBy),1),o("」的渠道「"+v(I.value.usedByCh)+"」使用 ",1)])):I.value.status==="error"?(i(),c("div",Os,[e(D,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(da)]),_:1}),o(v(I.value.error),1)])):(i(),c("div",Ws,[e(E,{type:"info",size:"small"},{default:t(()=>[e(D,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(mt)]),_:1}),l[112]||(l[112]=o("输入完成后自动验证，也可点右侧「验证」按钮手动触发",-1))]),_:1})]))])]),_:1}),e($,{label:"白名单用户"},{default:t(()=>[e(A,{modelValue:w.value.allowedFrom,"onUpdate:modelValue":l[42]||(l[42]=a=>w.value.allowedFrom=a),placeholder:"填入 Telegram 用户 ID，多个用逗号分隔"},null,8,["modelValue"]),e(E,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[e(D,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(mt)]),_:1}),l[113]||(l[113]=o("留空时 Bot 进入配对模式——向用户返回其 ID，引导联系管理员添加白名单 ",-1))]),_:1})]),_:1})],64)):h("",!0),w.value.type==="web"?(i(),c(F,{key:1},[ue.value?(i(),k($,{key:0,label:"访问链接"},{default:t(()=>[s("div",Ys,[e(D,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(ct)]),_:1}),s("span",Hs,v(Ke(L(g),ue.value)),1),e(u,{size:"small",link:"",onClick:l[43]||(l[43]=a=>st(Ke(L(g),ue.value)))},{default:t(()=>[...l[114]||(l[114]=[o("复制",-1)])]),_:1})])]),_:1})):h("",!0),ue.value?h("",!0):(i(),k($,{key:1,label:"访问链接"},{default:t(()=>[s("div",Js,[e(D,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(ct)]),_:1}),s("span",qs,v(Ke(L(g),_l.value)),1),e(C,{size:"small",type:"info",effect:"plain"},{default:t(()=>[...l[115]||(l[115]=[o("保存后生效",-1)])]),_:1})]),e(E,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[...l[116]||(l[116]=[o(" 每个 Web 渠道有独立链接，可同时开放多个入口 ",-1)])]),_:1})]),_:1})),e($,{label:"访问密码"},{default:t(()=>[e(A,{modelValue:w.value.webPassword,"onUpdate:modelValue":l[44]||(l[44]=a=>w.value.webPassword=a),type:"password","show-password":"",placeholder:"留空则无需密码"},null,8,["modelValue"])]),_:1}),e($,{label:"欢迎语"},{default:t(()=>[e(A,{modelValue:w.value.webWelcome,"onUpdate:modelValue":l[45]||(l[45]=a=>w.value.webWelcome=a),placeholder:"你好！有什么可以帮你的？"},null,8,["modelValue"])]),_:1}),e($,{label:"页面标题"},{default:t(()=>[e(A,{modelValue:w.value.webTitle,"onUpdate:modelValue":l[46]||(l[46]=a=>w.value.webTitle=a),placeholder:"AI 助手"},null,8,["modelValue"])]),_:1})],64)):h("",!0),e($,{label:"启用"},{default:t(()=>[e(ol,{modelValue:w.value.enabled,"onUpdate:modelValue":l[47]||(l[47]=a=>w.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1}),e(re,{label:"环境变量",name:"env"},{default:t(()=>[s("div",Gs,[l[122]||(l[122]=s("div",{style:{"margin-bottom":"16px"}},[s("h3",{style:{margin:"0 0 8px 0","font-size":"15px"}},"环境变量"),s("p",{style:{margin:"0",color:"#666","font-size":"13px"}},[o(" 配置此 AI 成员在执行 exec 命令时可用的环境变量，例如 GITHUB_TOKEN、GIT_AUTHOR_NAME 等。"),s("br"),o(" 这些变量会注入到 bash 工具的执行环境中，"),s("strong",null,"不受系统默认的 token 过滤影响"),o("。 ")])],-1)),s("div",Qs,[e(A,{modelValue:xe.value,"onUpdate:modelValue":l[50]||(l[50]=a=>xe.value=a),placeholder:"KEY（如 GITHUB_TOKEN）",style:{width:"220px","font-family":"monospace"},size:"small",onKeyup:Ql(Ce,["enter"])},null,8,["modelValue"]),e(A,{modelValue:he.value,"onUpdate:modelValue":l[51]||(l[51]=a=>he.value=a),placeholder:"VALUE",style:{flex:"1","font-family":"monospace"},size:"small",type:"password","show-password":"",onKeyup:Ql(Ce,["enter"])},null,8,["modelValue"]),e(u,{size:"small",type:"primary",onClick:Ce,disabled:!xe.value.trim()},{default:t(()=>[...l[119]||(l[119]=[o(" 添加 ",-1)])]),_:1},8,["disabled"])]),e(sl,{data:Y.value,size:"small",style:{width:"100%","margin-bottom":"16px"},"empty-text":"暂无环境变量"},{default:t(()=>[e(N,{label:"KEY","min-width":"200"},{default:t(({row:a})=>[s("code",Xs,v(a.key),1)]),_:1}),e(N,{label:"VALUE","min-width":"200"},{default:t(({row:a})=>[e(A,{modelValue:a.value,"onUpdate:modelValue":b=>a.value=b,type:"password","show-password":"",size:"small",style:{"font-family":"monospace"},placeholder:"（未设置）"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(N,{label:"操作",width:"80",fixed:"right"},{default:t(({$index:a})=>[e(u,{size:"small",type:"danger",link:"",onClick:b=>Sl(a)},{default:t(()=>[...l[120]||(l[120]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),e(u,{type:"primary",size:"small",loading:Me.value,onClick:Qe},{default:t(()=>[...l[121]||(l[121]=[o(" 保存环境变量 ",-1)])]),_:1},8,["loading"])])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),so=$t(eo,[["__scopeId","data-v-a0b134e4"]]);export{so as default};
