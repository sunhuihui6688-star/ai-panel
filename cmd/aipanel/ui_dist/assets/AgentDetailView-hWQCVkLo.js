import{d as at,h as nt,o as i,c as f,b as s,a as e,w as t,j as $,F as N,l as G,q as Ze,t as v,i as h,f as o,e as st,n as Xe,m as el,B as et,k as U,g as d,x as cl,E as p,r as c,C as Pl,D as Rt,y as jt,z as ml,G as Kt,H as El,I as Wt,J as Ot,K as Yt,L as qt,M as Jt}from"./index-YfszXhjF.js";import{g as He,f as Z,b as Rl,h as Ge,i as Qe,j as Ht,e as fl,r as lt,k as X,l as tt}from"./index-sb85_xT4.js";import{A as ot}from"./AiChat-Cs6_kZ1G.js";import{_ as it}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Gt={class:"skill-studio"},Qt={class:"studio-sidebar"},Xt={class:"sidebar-top"},Zt={class:"sidebar-acts"},ea={class:"skill-list"},la={key:0,class:"list-empty"},ta=["onClick"],aa={class:"sk-icon"},na={key:0},sa={class:"sk-info"},oa={class:"sk-name"},ia={class:"sk-id"},ua={class:"sk-right"},da={class:"studio-editor"},ra={key:0,class:"editor-empty"},va={class:"editor-toolbar"},ma={class:"editor-breadcrumb"},fa={class:"crumb-name"},ca={class:"toolbar-acts"},pa={class:"editor-body"},ya={class:"file-tree"},ga={class:"tree-title"},_a={class:"tree-item tree-dir"},ba=["onClick"],wa={key:0,class:"tree-empty"},ka={key:0,class:"file-editor"},xa={class:"file-editor-head"},ha={style:{display:"flex","align-items":"center",gap:"10px"}},Ca={style:{"font-size":"12px",color:"#909399"}},$a={class:"json-preview"},Va={key:1,class:"file-editor"},za={class:"file-editor-head"},Ta={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},Sa={style:{"font-size":"11px",color:"#c0c4cc"}},La={key:2,class:"file-editor"},Ia={class:"file-editor-head"},Ua={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},Da={style:{"font-size":"11px",color:"#c0c4cc"}},Aa=["placeholder"],Fa={class:"studio-chat"},Na={class:"chat-panel-head"},Ma={key:0,style:{"margin-left":"auto","font-size":"11px",color:"#c0c4cc"}},Ba={class:"chat-wrap"},Pa=at({__name:"SkillStudio",props:{agentId:{}},setup(jl){const se=jl,y=se.agentId,W=d([]),oe=d(!1),m=d(null),x=d("meta"),V=d({name:"",icon:"",category:"",description:"",version:"1.0.0",enabled:!0}),D=d(""),ze=d(!1),ke=d(!1),Pe=d(!1),Te=d(!1),ce=d(!1),O=d(null),ee=d([]),le=d(!1),te=d(""),Y=d(!1),Ee=d(!1),ie=d(null),pl=cl(()=>{if(!m.value)return"你是一个技能配置助手，帮助用户设计和优化 AI 技能的系统提示词。";const _=JSON.stringify({id:m.value.id,name:m.value.name,icon:m.value.icon||"",category:m.value.category||"",description:m.value.description||"",version:m.value.version||"1.0.0",enabled:m.value.enabled,source:"local",installedAt:""},null,2);return`你是一个技能配置助手，正在帮助用户配置技能（ID: ${m.value.id}）。

## ⚠️ 文件路径规则（必须遵守）
所有文件必须在 skills/${m.value.id}/ 目录下：
- ✅ skills/${m.value.id}/SKILL.md
- ✅ skills/${m.value.id}/skill.json
- ✅ skills/${m.value.id}/tools/helper.py
- ❌ 任何其他路径

## ⚠️ 创建或更新技能时，必须同时写两个文件

### 1. skills/${m.value.id}/skill.json（技能元数据）
格式如下，修改 name/icon/category/description 字段：
\`\`\`json
${_}
\`\`\`

### 2. skills/${m.value.id}/SKILL.md（系统提示词）
当前内容：
\`\`\`markdown
${D.value||"（空）"}
\`\`\`

## 你可以帮助：
- 创建/优化技能：同时写 skill.json（名称、分类、描述）和 SKILL.md（提示词）
- 在技能目录下创建工具文件（Python 等）
- 测试技能效果（直接对话即可测试）`}),yl=cl(()=>m.value?ce.value?`新技能已创建（ID: ${m.value.id}）。告诉我你想要什么功能，我来帮你生成完整的 SKILL.md 内容，生成后直接点保存即可。`:`当前编辑「${m.value.name}」。你可以让我优化 SKILL.md、测试效果，或者直接对话体验当前技能。`:"选择一个技能后，我可以帮你优化配置、写 SKILL.md、测试效果。"),Se=cl(()=>m.value?ce.value?[]:[`帮我优化「${m.value.name}」的 SKILL.md`,"这个技能怎么写效果更好？","用中文回答一道历史题，测试当前技能效果"]:["帮我设计一个代码审查技能","帮我写一个翻译助手的 SKILL.md"]);async function J(){oe.value=!0;try{const _=await He.list(y);if(W.value=_.data||[],m.value){const u=W.value.find(L=>L.id===m.value.id);u&&(m.value=u,M(u))}}catch{}finally{oe.value=!1}}function M(_){V.value={name:_.name,icon:_.icon||"",category:_.category||"",description:_.description||"",version:_.version||"1.0.0",enabled:_.enabled}}async function Le(_){const u=ie.value,L=`skill-studio-${_.id}`;m.value?.id!==_.id&&(m.value=_,M(_),x.value="meta",ke.value=!1,D.value="",ce.value=!1,xe(),ge(),u?.streaming?.value?O.value=L:(O.value=null,await u?.resumeSession?.(L)))}async function Ie(){m.value&&x.value!=="prompt"&&(x.value="prompt",D.value||await ge())}async function ll(_,u,L){const k=await Z.read(y,_),A=Array.isArray(k.data)?k.data:[],H=[];for(const q of A){if(L===0&&q.name==="skill.json")continue;const I=u?`${u}/${q.name}`:q.name;if(H.push({name:q.name,path:I,isDir:q.isDir,depth:L}),q.isDir){const _e=await ll(`skills/${m.value.id}/${I}`,I,L+1);H.push(..._e)}}return H}async function xe(){if(m.value){le.value=!0;try{ee.value=await ll(`skills/${m.value.id}/`,"",0)}catch{ee.value=[{name:"SKILL.md",path:"SKILL.md",isDir:!1,depth:0}]}finally{le.value=!1}}}async function gl(_,u){if(!u){if(_==="SKILL.md"){await Ie();return}x.value=_,Y.value=!1,await pe()}}async function pe(){if(!(!m.value||!x.value||x.value==="meta"||x.value==="prompt")){Ee.value=!0;try{const _=await Z.read(y,`skills/${m.value.id}/${x.value}`);te.value=_.data?.content||"",Y.value=!1}catch{te.value=""}finally{Ee.value=!1}}}async function Ue(_){if(m.value)try{await Z.delete(y,`skills/${m.value.id}/${_}`),x.value===_&&(x.value="prompt"),await xe(),p.success("已删除")}catch{p.error("删除失败")}}async function Re(){if(m.value){Pe.value=!0;try{x.value==="meta"||x.value==="prompt"?(await He.update(se.agentId,m.value.id,{name:V.value.name,icon:V.value.icon,category:V.value.category,description:V.value.description,enabled:V.value.enabled}),(x.value==="prompt"||D.value)&&(await Z.write(y,`skills/${m.value.id}/SKILL.md`,D.value),ke.value=!1),await J()):(await Z.write(y,`skills/${m.value.id}/${x.value}`,te.value),Y.value=!1),p.success("保存成功")}catch(_){p.error(_.response?.data?.error||"保存失败")}finally{Pe.value=!1}}}async function De(_,u){try{await He.update(se.agentId,_.id,{enabled:u}),await J()}catch{p.error("操作失败")}}async function ye(){if(m.value)try{await He.remove(se.agentId,m.value.id),p.success("已删除"),m.value=null,await J()}catch{p.error("删除失败")}}async function ue(){if(Te.value)return;Te.value=!0;const _="skill_"+Date.now().toString(36);try{await He.create(se.agentId,{meta:{id:_,name:"新技能",icon:"",category:"",description:"",version:"1.0.0",enabled:!1,source:"local",installedAt:""},promptContent:""}),await J();const u=W.value.find(L=>L.id===_);if(u){if(await Le(u),O.value){const k=O.value;O.value=null,await ie.value?.resumeSession?.(k)}x.value="prompt",D.value="",ce.value=!0;const L=W.value.filter(k=>k.id!==_).map(k=>k.name).join("、")||"暂无";ie.value?.sendSilent?.(`【纯文字输出，不使用任何工具，不创建任何文件】当前已有技能：${L}。请推荐3个全新的、与已有技能不重复的技能方向，每条一句话，直接列出即可。`)}}catch(u){p.error(u.response?.data?.error||"创建失败")}finally{Te.value=!1}}async function je(_){if(O.value){const u=O.value;O.value=null,await ie.value?.resumeSession?.(u);return}m.value&&(ce.value=!1,await Promise.all([J(),xe()]),await ge(),x.value!=="meta"&&x.value!=="prompt"&&await pe())}async function ge(){if(m.value){ze.value=!0;try{const _=await Z.read(y,`skills/${m.value.id}/SKILL.md`);D.value=_.data?.content||"",ke.value=!1}catch{D.value=""}finally{ze.value=!1}}}async function he(){if(!m.value)return;D.value||await Ie();const _=`请用「${m.value.name}」技能效果回复：你好，请介绍一下你的功能。`;ie.value?.fillInput?.(_),p.info("测试消息已填入右侧聊天框，点击发送即可测试")}return nt(J),(_,u)=>{const L=c("Refresh"),k=c("el-icon"),A=c("el-button"),H=c("Plus"),q=c("Tools"),I=c("el-tag"),_e=c("el-switch"),F=c("Setting"),_l=c("FolderOpened"),bl=c("VideoPlay"),wl=c("DocumentChecked"),tl=c("Delete"),al=c("el-popconfirm"),Ke=c("Folder"),de=c("Document"),re=c("el-input"),ae=c("el-form-item"),Ce=c("el-col"),be=c("el-row"),B=c("el-collapse-item"),kl=c("el-collapse"),xl=c("el-form"),nl=c("ChatLineRound");return i(),f("div",Gt,[s("div",Qt,[s("div",Xt,[u[13]||(u[13]=s("span",{class:"sidebar-title"},"技能库",-1)),s("div",Zt,[e(A,{size:"small",loading:oe.value,circle:"",onClick:J},{default:t(()=>[e(k,null,{default:t(()=>[e(L)]),_:1})]),_:1},8,["loading"]),e(A,{size:"small",type:"primary",circle:"",loading:Te.value,onClick:ue},{default:t(()=>[e(k,null,{default:t(()=>[e(H)]),_:1})]),_:1},8,["loading"])])]),s("div",ea,[!oe.value&&W.value.length===0?(i(),f("div",la,"暂无技能")):$("",!0),(i(!0),f(N,null,G(W.value,b=>(i(),f("div",{key:b.id,class:Ze(["skill-item",{active:m.value?.id===b.id}]),onClick:Ae=>Le(b)},[s("span",aa,[b.icon?(i(),f("span",na,v(b.icon),1)):(i(),h(k,{key:1},{default:t(()=>[e(q)]),_:1}))]),s("div",sa,[s("div",oa,v(b.name),1),s("div",ia,v(b.id),1)]),s("div",ua,[b.category?(i(),h(I,{key:0,size:"small",effect:"plain",style:{"margin-right":"6px","font-size":"11px"}},{default:t(()=>[o(v(b.category),1)]),_:2},1024)):$("",!0),e(_e,{"model-value":b.enabled,size:"small",onChange:Ae=>De(b,Ae),onClick:u[0]||(u[0]=st(()=>{},["stop"]))},null,8,["model-value","onChange"])])],10,ta))),128))])]),s("div",da,[m.value?(i(),f(N,{key:1},[s("div",va,[s("div",ma,[e(k,{style:{color:"#909399"}},{default:t(()=>[e(_l)]),_:1}),u[16]||(u[16]=s("span",{class:"crumb-sep"},"skills /",-1)),s("span",fa,v(m.value.id),1)]),s("div",ca,[e(A,{size:"small",onClick:he},{default:t(()=>[e(k,null,{default:t(()=>[e(bl)]),_:1}),u[17]||(u[17]=o(" 测试 ",-1))]),_:1}),e(A,{size:"small",type:"primary",loading:Pe.value,onClick:Re},{default:t(()=>[e(k,null,{default:t(()=>[e(wl)]),_:1}),u[18]||(u[18]=o(" 保存 ",-1))]),_:1},8,["loading"]),e(al,{title:"确认删除该技能？",onConfirm:ye},{reference:t(()=>[e(A,{size:"small",type:"danger",plain:""},{default:t(()=>[e(k,null,{default:t(()=>[e(tl)]),_:1})]),_:1})]),_:1})])]),s("div",pa,[s("div",ya,[s("div",ga,[u[19]||(u[19]=o(" 目录 ",-1)),e(A,{link:"",size:"small",loading:le.value,onClick:xe,style:{"margin-left":"auto",padding:"0"}},{default:t(()=>[e(k,null,{default:t(()=>[e(L)]),_:1})]),_:1},8,["loading"])]),s("div",_a,[e(k,null,{default:t(()=>[e(Ke)]),_:1}),s("span",null,v(m.value.id)+"/",1)]),s("div",{class:Ze(["tree-item",{"tree-active":x.value==="meta"}]),onClick:u[1]||(u[1]=b=>x.value="meta")},[e(k,null,{default:t(()=>[e(de)]),_:1}),u[20]||(u[20]=s("span",null,"skill.json",-1))],2),(i(!0),f(N,null,G(ee.value,b=>(i(),f("div",{key:b.path,class:Ze(["tree-item",{"tree-active":x.value===(b.path==="SKILL.md"?"prompt":b.path),"tree-dir-row":b.isDir}]),style:Xe({paddingLeft:`${12+b.depth*12}px`}),onClick:Ae=>gl(b.path,b.isDir)},[b.isDir?(i(),h(k,{key:0,style:{color:"#e6a23c"}},{default:t(()=>[e(Ke)]),_:1})):(i(),h(k,{key:1},{default:t(()=>[e(de)]),_:1})),s("span",null,v(b.name),1),b.path==="SKILL.md"&&m.value.enabled?(i(),h(I,{key:2,size:"small",type:"success",effect:"plain",style:{"margin-left":"4px","font-size":"10px"}},{default:t(()=>[...u[21]||(u[21]=[o("注入中",-1)])]),_:1})):$("",!0)],14,ba))),128)),!le.value&&ee.value.length===0?(i(),f("div",wa,"空目录")):$("",!0)]),x.value==="meta"?(i(),f("div",ka,[s("div",xa,[e(k,null,{default:t(()=>[e(de)]),_:1}),u[22]||(u[22]=o(" skill.json ",-1)),u[23]||(u[23]=s("span",{class:"file-hint"},"技能元信息，影响列表展示和 runner 行为",-1))]),e(xl,{model:V.value,"label-width":"72px",size:"small",style:{padding:"16px 20px"}},{default:t(()=>[e(ae,{label:"技能 ID"},{default:t(()=>[e(re,{value:m.value.id,disabled:""},null,8,["value"])]),_:1}),e(be,{gutter:12},{default:t(()=>[e(Ce,{span:14},{default:t(()=>[e(ae,{label:"名称"},{default:t(()=>[e(re,{modelValue:V.value.name,"onUpdate:modelValue":u[2]||(u[2]=b=>V.value.name=b),placeholder:"如 翻译助手"},null,8,["modelValue"])]),_:1})]),_:1}),e(Ce,{span:10},{default:t(()=>[e(ae,{label:"图标"},{default:t(()=>[e(re,{modelValue:V.value.icon,"onUpdate:modelValue":u[3]||(u[3]=b=>V.value.icon=b),placeholder:"emoji"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(be,{gutter:12},{default:t(()=>[e(Ce,{span:14},{default:t(()=>[e(ae,{label:"分类"},{default:t(()=>[e(re,{modelValue:V.value.category,"onUpdate:modelValue":u[4]||(u[4]=b=>V.value.category=b),placeholder:"如 语言"},null,8,["modelValue"])]),_:1})]),_:1}),e(Ce,{span:10},{default:t(()=>[e(ae,{label:"版本"},{default:t(()=>[e(re,{modelValue:V.value.version,"onUpdate:modelValue":u[5]||(u[5]=b=>V.value.version=b),placeholder:"1.0.0"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(ae,{label:"描述"},{default:t(()=>[e(re,{modelValue:V.value.description,"onUpdate:modelValue":u[6]||(u[6]=b=>V.value.description=b),type:"textarea",rows:2,placeholder:"简要描述技能功能"},null,8,["modelValue"])]),_:1}),e(ae,{label:"状态"},{default:t(()=>[s("div",ha,[e(_e,{modelValue:V.value.enabled,"onUpdate:modelValue":u[7]||(u[7]=b=>V.value.enabled=b)},null,8,["modelValue"]),s("span",Ca,v(V.value.enabled?"已启用，SKILL.md 将注入系统提示":"已禁用"),1)])]),_:1}),e(kl,{style:{"margin-top":"8px"}},{default:t(()=>[e(B,{title:"查看 skill.json 原文"},{default:t(()=>[s("pre",$a,v(JSON.stringify({id:m.value.id,...V.value},null,2)),1)]),_:1})]),_:1})]),_:1},8,["model"])])):x.value==="prompt"?(i(),f("div",Va,[s("div",za,[e(k,null,{default:t(()=>[e(de)]),_:1}),u[25]||(u[25]=o(" SKILL.md ",-1)),u[26]||(u[26]=s("span",{class:"file-hint"},"注入到 AI System Prompt 的指令内容",-1)),s("div",Ta,[ke.value?(i(),h(I,{key:0,type:"warning",size:"small"},{default:t(()=>[...u[24]||(u[24]=[o("未保存",-1)])]),_:1})):$("",!0),s("span",Sa,v(D.value.length)+" 字符",1),e(A,{size:"small",circle:"",loading:ze.value,onClick:ge,title:"重新加载"},{default:t(()=>[e(k,null,{default:t(()=>[e(L)]),_:1})]),_:1},8,["loading"])])]),el(s("textarea",{"onUpdate:modelValue":u[8]||(u[8]=b=>D.value=b),class:"code-textarea",spellcheck:"false",placeholder:`# 技能名称

## 功能说明
描述该技能的用途…

## 行为规范
- 规范 1
- 规范 2`,onInput:u[9]||(u[9]=b=>ke.value=!0)},null,544),[[et,D.value]])])):(i(),f("div",La,[s("div",Ia,[e(k,null,{default:t(()=>[e(de)]),_:1}),o(" "+v(x.value)+" ",1),s("div",Ua,[Y.value?(i(),h(I,{key:0,type:"warning",size:"small"},{default:t(()=>[...u[27]||(u[27]=[o("未保存",-1)])]),_:1})):$("",!0),s("span",Da,v(te.value.length)+" 字符",1),e(A,{size:"small",circle:"",loading:Ee.value,onClick:pe,title:"重新加载"},{default:t(()=>[e(k,null,{default:t(()=>[e(L)]),_:1})]),_:1},8,["loading"]),e(al,{title:"确认删除该文件？",onConfirm:u[10]||(u[10]=b=>Ue(x.value))},{reference:t(()=>[e(A,{size:"small",circle:"",type:"danger",plain:""},{default:t(()=>[e(k,null,{default:t(()=>[e(tl)]),_:1})]),_:1})]),_:1})])]),el(s("textarea",{"onUpdate:modelValue":u[11]||(u[11]=b=>te.value=b),class:"code-textarea",spellcheck:"false",placeholder:`编辑 ${x.value} …`,onInput:u[12]||(u[12]=b=>Y.value=!0)},null,40,Aa),[[et,te.value]])]))])],64)):(i(),f("div",ra,[e(k,{size:"48",color:"#c0c4cc"},{default:t(()=>[e(F)]),_:1}),u[15]||(u[15]=s("p",null,"从左侧选择一个技能开始编辑",-1)),e(A,{type:"primary",onClick:ue},{default:t(()=>[e(k,null,{default:t(()=>[e(H)]),_:1}),u[14]||(u[14]=o(" 新建技能",-1))]),_:1})]))]),s("div",Fa,[s("div",Na,[e(k,null,{default:t(()=>[e(nl)]),_:1}),u[28]||(u[28]=o(" AI 协作配置 ",-1)),m.value?(i(),f("span",Ma,"当前: "+v(m.value.name),1)):$("",!0)]),s("div",Ba,[e(ot,{ref_key:"aiChatRef",ref:ie,"agent-id":U(y),context:pl.value,scenario:"skill-studio","skill-id":m.value?.id,"welcome-message":yl.value,examples:Se.value,compact:"",onResponse:je},null,8,["agent-id","context","skill-id","welcome-message","examples"])])])])}}}),Ea=it(Pa,[["__scopeId","data-v-62c3ffb7"]]),Ra={class:"header-left"},ja={class:"chat-layout"},Ka={class:"session-sidebar"},Wa={class:"session-sidebar-header"},Oa={class:"session-list"},Ya=["onClick"],qa={class:"session-item-title"},Ja={class:"session-item-meta"},Ha={key:0,class:"session-empty"},Ga={class:"at-panel"},Qa={key:0,class:"at-form"},Xa={class:"chat-area"},Za={style:{display:"flex","align-items":"center",gap:"8px"}},en={style:{"font-weight":"600"}},ln={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"32px 0","font-size":"14px"}},tn={style:{display:"flex","align-items":"center",gap:"8px"}},an={style:{"font-size":"13px"}},nn={style:{"font-size":"13px",color:"#606266"}},sn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"40px 0"}},on={key:1,class:"relations-list"},un={class:"relation-info"},dn={class:"relation-name"},rn={class:"relation-tags"},vn={class:"relation-desc"},mn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},fn={style:{display:"flex",gap:"8px","margin-top":"4px"}},cn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},pn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"16px 0","font-size":"13px"}},yn={style:{"font-size":"12px"}},gn={style:{"font-size":"12px",color:"#606266"}},_n={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},bn={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},wn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},kn={style:{"margin-bottom":"16px",display:"flex","align-items":"center",gap:"8px"}},xn={class:"conv-drawer-body"},hn={key:0,style:{"text-align":"center","margin-bottom":"12px"}},Cn={class:"conv-msg-list"},$n={class:"conv-msg-meta"},Vn={class:"conv-msg-role"},zn={key:0,class:"conv-msg-sender"},Tn={class:"conv-msg-time"},Sn={class:"conv-msg-content"},Ln={key:0,class:"conv-msg-empty"},In={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},Un={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},Dn={class:"channel-card-header"},An={class:"channel-card-left"},Fn={class:"channel-card-name"},Nn={key:0,class:"channel-bot-username"},Mn={class:"channel-card-actions"},Bn={key:0,class:"channel-card-body"},Pn={class:"channel-info-row"},En={class:"channel-info-value"},Rn={class:"channel-info-row"},jn={class:"channel-info-value"},Kn={key:1,class:"channel-card-body"},Wn={class:"channel-info-row"},On={class:"channel-info-value"},Yn={style:{opacity:"0.6","font-size":"11px","margin-left":"3px"}},qn={class:"pending-section"},Jn=["onClick"],Hn={key:0,class:"pending-list"},Gn={key:0,style:{"text-align":"center",padding:"12px"}},Qn={class:"pending-user-info"},Xn={class:"pending-user-name"},Zn={key:0,class:"pending-user-username"},es={class:"pending-user-id"},ls={class:"pending-user-actions"},ts={key:2,class:"pending-empty"},as={style:{width:"100%"}},ns={style:{display:"flex",gap:"6px","align-items":"center"}},ss={key:0,style:{"margin-top":"6px",display:"flex","align-items":"center",gap:"6px",color:"#909399","font-size":"13px"}},os={key:1,style:{"margin-top":"6px",color:"#67c23a","font-size":"13px"}},is={key:2,style:{"margin-top":"6px",color:"#e6a23c","font-size":"13px"}},us={key:3,style:{"margin-top":"6px",color:"#f56c6c","font-size":"13px"}},ds={key:4,style:{"margin-top":"4px"}},rs={class:"channel-url-preview"},vs={class:"channel-url-text"},ms={class:"channel-url-preview"},fs={class:"channel-url-text"},cs=50,ps=at({__name:"AgentDetailView",setup(jl){const se=Rt(),y=se.params.id,W=d(null),oe=d("chat"),m=d(),x=d([]),V=d(!1),D=d();async function ze(){V.value=!0;try{const n=await Ht.list({agentId:y,limit:50});x.value=n.data.sessions}catch{}finally{V.value=!1}}function ke(n){D.value=n.id,m.value?.resumeSession(n.id)}function Pe(){D.value=void 0,m.value?.startNewSession()}function Te(n){D.value=n,setTimeout(ze,500)}function ce(n){if(!n)return"";const l=Date.now()-n;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分前`:l<864e5?`${Math.floor(l/36e5)}小时前`:`${Math.floor(l/864e5)}天前`}const O=d(!1),ee=d(""),le=d(""),te=d(!1),Y=d([]);function Ee(){O.value=!O.value,O.value&&!Y.value.length&&ie()}async function ie(){try{const n=await Rl.list();Y.value=n.data.filter(l=>l.id!==y)}catch{Y.value=[]}}function pl(n){const l=Y.value.find(r=>r.id===n);l&&m.value?.fillInput(`@${l.name}: `)}async function yl(){const n=ee.value,l=le.value.trim();if(!n||!l)return;const C=Y.value.find($e=>$e.id===n)?.name??n;te.value=!0;const R={role:"user",text:`→ 转发给 ${C}：
${l}`};m.value?.appendMessage(R);try{const z=(await Rl.message(n,l,y)).data.response,me={role:"assistant",text:`← **${C}** 回复：

${z}`};m.value?.appendMessage(me),le.value="",ee.value="",O.value=!1,p.success(`${C} 已回复`)}catch($e){const z={role:"system",text:`[失败] 转发失败：${$e.response?.data?.error??$e.message??"网络错误"}`};m.value?.appendMessage(z),p.error("转发失败")}finally{te.value=!1}}const Se=d(""),J=d(""),M=d({enabled:!1,schedule:"daily",keepTurns:3,focusHint:"",cronJobId:""}),Le=d(!1),Ie=d(!1);async function ll(){try{const n=await fl.getConfig(y);M.value=n.data,Re()}catch{}}async function xe(){Le.value=!0;try{const n=await fl.setConfig(y,M.value);M.value=n.data,p.success(M.value.enabled?"自动记忆已开启":"自动记忆已关闭")}catch{p.error("保存失败")}finally{Le.value=!1}}async function gl(){Ie.value=!0;try{await fl.consolidate(y),p.success("记忆整理已在后台启动（约需10~30秒），稍后自动刷新日志"),setTimeout(Re,1e4)}catch{p.error("整理失败")}finally{Ie.value=!1}}const pe=d([]),Ue=d(!1);async function Re(){Ue.value=!0;try{const n=await fl.runLog(y);pe.value=n.data||[]}catch{pe.value=[]}finally{Ue.value=!1}}const De=d([]),ye=d(""),ue=d(""),je=d(!1),ge=d([]),he=d(!1),_=d(""),u=d(!1),L=d(""),k=d([]),A=d(""),H=d(""),q=d(null),I=d([]),_e=d(!1),F=d({agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""});async function _l(){try{const n=await lt.get(y);I.value=n.data.parsed||[]}catch{I.value=[]}}function bl(n){const l=Y.value.find(r=>r.id===n);F.value.agentName=l?l.name:n}async function wl(){if(!F.value.agentId)return;if(I.value.find(l=>l.agentId===F.value.agentId)){p.warning("该成员关系已存在，请先删除再重新添加");return}I.value.push({...F.value}),F.value={agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""},await Ke()}async function tl(n){I.value.splice(n,1),await Ke()}function al(){if(I.value.length===0)return"";const n=`| 成员ID | 成员名称 | 关系类型 | 关系程度 | 说明 |
|--------|--------|--------|--------|------|`,l=I.value.map(r=>`| ${r.agentId} | ${r.agentName} | ${r.relationType} | ${r.strength} | ${r.desc||""} |`).join(`
`);return n+`
`+l}async function Ke(){_e.value=!0;try{await lt.put(y,al()),p.success("关系已保存")}catch{p.error("保存失败")}finally{_e.value=!1}}function de(n){const l=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399","#B45309","#7C3AED","#0891B2"];let r=0;for(let C=0;C<n.length;C++)r=n.charCodeAt(C)+((r<<5)-r);return l[Math.abs(r)%l.length]??"#409EFF"}function re(n){return n==="上级"?"danger":n==="下级"?"":n==="平级协作"?"success":"info"}function ae(n){return n==="核心"?"danger":n==="常用"?"warning":"info"}const Ce=d([]),be=d(!1),B=d({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function kl(n){return n==="running"?"success":n==="stopped"?"danger":"info"}function xl(n){return n==="running"?"运行中":n==="stopped"?"已停止":"空闲"}function nl(n){return n?n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB":"0 B"}function b(n){return new Date(n).toLocaleString()}function Ae(n){return n?new Date(n).toLocaleString():""}const ve=d([]),hl=d(!1),Fe=d(!1),ne=d(""),sl=d(""),Cl=d(!1),$l=d(""),g=d({type:"telegram",name:"",enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""}),S=d({loading:!1,status:""});let Vl=null;function zl(n){return/^\*+$/.test(n)}async function Kl(){const n=g.value.botToken;if(!(!n||zl(n))){S.value={loading:!0,status:""};try{const r=(await X.checkToken(y,n)).data;r.duplicate?S.value={loading:!1,status:"duplicate",usedBy:r.usedBy,usedByCh:r.usedByCh}:r.valid?(S.value={loading:!1,status:"ok",botName:r.botName},!g.value.name&&r.botName&&(g.value.name=r.botName)):S.value={loading:!1,status:"error",error:r.error||"Token 无效"}}catch{S.value={loading:!1,status:"error",error:"网络错误，请重试"}}}}Pl(()=>g.value.type,n=>{ne.value||(sl.value=Tl(n))}),Pl(()=>g.value.botToken,n=>{S.value={loading:!1,status:""},Vl&&clearTimeout(Vl),!(!n||zl(n)||n.length<20||!n.includes(":"))&&(Vl=setTimeout(Kl,800))});function Ne(n,l){return l?`${window.location.origin}/chat/${n}/${l}`:`${window.location.origin}/chat/${n}`}function Wl(n){navigator.clipboard.writeText(n).then(()=>p.success("链接已复制"))}async function Me(){hl.value=!0;try{const n=await X.list(y);ve.value=n.data||[]}catch{ve.value=[]}finally{hl.value=!1}}function Tl(n){return n+"-"+Date.now().toString(36)}function ut(){ne.value="";const n=W.value?.name||"";sl.value=Tl("telegram"),g.value={type:"telegram",name:n,enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""},S.value={loading:!1,status:""},Fe.value=!0}function dt(n){ne.value=n.id,g.value={type:n.type,name:n.name,enabled:n.enabled,botToken:n.config?.botToken||"",allowedFrom:n.config?.allowedFrom||"",webPassword:"",webWelcome:n.config?.welcomeMsg||"",webTitle:n.config?.title||""},S.value={loading:!1,status:""},Fe.value=!0}async function rt(){if(!g.value.name||!g.value.type){p.warning("请填写名称和类型");return}if(S.value.status==="duplicate"){p.error(`Bot Token 已被成员「${S.value.usedBy}」使用，请更换`);return}Cl.value=!0;try{const n={};if(g.value.type==="telegram"?(g.value.botToken&&(n.botToken=g.value.botToken),g.value.allowedFrom&&(n.allowedFrom=g.value.allowedFrom)):g.value.type==="web"&&(g.value.webPassword&&(n.password=g.value.webPassword),g.value.webWelcome&&(n.welcomeMsg=g.value.webWelcome),g.value.webTitle&&(n.title=g.value.webTitle)),ne.value){const l=ve.value.map(r=>r.id!==ne.value?r:{...r,name:g.value.name,type:g.value.type,enabled:g.value.enabled,config:{...r.config,...n}});await X.set(y,l)}else{const l={id:sl.value||Tl(g.value.type),name:g.value.name,type:g.value.type,enabled:g.value.enabled,config:n,status:"untested"};await X.set(y,[...ve.value,l])}p.success(g.value.type==="web"?"保存成功，Web 聊天页立即生效":"保存成功，重启后新渠道生效"),Fe.value=!1,await Me()}catch(n){p.error(n.response?.data?.error||"保存失败")}finally{Cl.value=!1}}async function vt(){try{await X.set(y,ve.value)}catch(n){p.error(n.response?.data?.error||"保存失败"),await Me()}}async function mt(n){const l=ve.value.filter(r=>r.id!==n.id);try{await X.set(y,l),ve.value=l,p.success("已删除")}catch{p.error("删除失败")}}async function ft(n){$l.value=n.id;try{const l=await X.test(y,n.id);l.data.valid?p.success(l.data.botName?`测试成功 (@${l.data.botName})`:"测试成功"):p.error(l.data.error||"测试失败"),await Me()}catch{p.error("测试请求失败")}finally{$l.value=""}}const Be=d({}),Sl=d({}),We=d(""),Ll=d("");async function ol(n){Sl.value[n]=!0;try{const l=await X.listPending(y,n);Be.value[n]=l.data||[]}catch{Be.value[n]=[]}finally{Sl.value[n]=!1}}function ct(n){We.value===n?We.value="":(We.value=n,ol(n))}async function pt(n,l){Ll.value=`${n}-${l}`;try{await X.allowUser(y,n,l),p.success(`用户 ${l} 已加入白名单`),await ol(n),await Me()}catch{p.error("操作失败")}finally{Ll.value=""}}async function yt(n,l){try{await X.dismissUser(y,n,l),p.success("已忽略"),await ol(n)}catch{p.error("操作失败")}}async function Ol(n,l){try{await qt.confirm(`确定将用户 ${l} 从白名单中移除？移除后该用户将无法使用此 Bot。`,"移除白名单",{confirmButtonText:"确认移除",cancelButtonText:"取消",type:"warning"})}catch{return}try{await X.removeAllowed(y,n,l),p.success(`用户 ${l} 已从白名单移除`),await Me()}catch{p.error("操作失败")}}nt(async()=>{try{const r=await Rl.get(y);W.value=r.data}catch{p.error("加载 Agent 失败")}gt(),_l(),ie(),ll(),xt(),il(),Me(),await ze();const n=se.query.tab;n&&(oe.value=n);const l=se.query.resumeSession;l&&(D.value=l,await new Promise(C=>setTimeout(C,100)),m.value?.resumeSession(l),x.value.find(C=>C.id===l)||(D.value=l))});async function gt(){try{const[n,l]=await Promise.all([Z.read(y,"IDENTITY.md"),Z.read(y,"SOUL.md")]);Se.value=n.data?.content||"",J.value=l.data?.content||""}catch{}Oe()}async function Il(n,l){try{await Z.write(y,n,l),p.success(`${n} 已保存`)}catch{p.error(`保存 ${n} 失败`)}}async function Oe(){try{const n=await Ge.tree(y);De.value=n.data||[]}catch{De.value=[]}}async function _t(n){if(!n.isDir){ye.value=n.path,ge.value=n.path.split("/");try{const l=await Ge.readFile(y,n.path);ue.value=l.data?.content||""}catch{ue.value="(无法读取)"}}}async function bt(){if(ye.value){je.value=!0;try{await Ge.writeFile(y,ye.value,ue.value),p.success("记忆文件已保存"),Oe()}catch{p.error("保存失败")}finally{je.value=!1}}}async function wt(){const n=_.value.trim();if(!n){p.warning("请输入路径");return}try{await Ge.writeFile(y,n,`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`),p.success("文件已创建"),he.value=!1,_.value="",Oe(),ye.value=n,ge.value=n.split("/"),ue.value=`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`}catch{p.error("创建失败")}}async function kt(){const n=L.value.trim();if(!n){p.warning("请输入内容");return}try{await Ge.dailyLog(y,n),p.success("日志已添加"),u.value=!1,L.value="",Oe()}catch{p.error("添加失败")}}async function xt(){try{const n=await Z.read(y,"/");Array.isArray(n.data)&&(k.value=n.data.map(l=>({name:l.name,isDir:l.isDir,size:l.size,modTime:l.modTime,path:l.name})))}catch{}}async function ht(n){if(!n.isDir){A.value=n.path||n.name,q.value=n;try{const l=await Z.read(y,A.value);H.value=l.data?.content||""}catch{H.value="(无法读取)"}}}async function Ct(){A.value&&await Il(A.value,H.value)}async function il(){try{const n=await Qe.list(y);Ce.value=n.data||[]}catch{}}async function $t(){try{await Qe.create({name:B.value.name,enabled:B.value.enabled,agentId:y,schedule:{kind:"cron",expr:B.value.expr,tz:B.value.tz},payload:{kind:"agentTurn",message:B.value.message},delivery:{mode:"announce"}}),p.success("任务创建成功"),be.value=!1,il()}catch(n){p.error(n.response?.data?.error||"创建失败")}}async function Vt(n){try{await Qe.update(n.id,n)}catch{p.error("更新失败")}}async function Yl(n){try{await Qe.run(n.id),p.success("已触发运行"),setTimeout(il,2e3)}catch{p.error("运行失败")}}async function zt(n){try{await Qe.delete(n.id),p.success("已删除"),il()}catch{p.error("删除失败")}}const ul=d(!1),Ul=d([]),Dl=d(!1),Al=d(""),we=d([]),Fl=d(0),dl=d(0),Tt=cl(()=>we.value.length<Fl.value),Ye=d(!1);async function ql(){ul.value=!0;try{const n=await tt.list(y);Ul.value=n.data}catch{p.error("加载对话渠道失败")}finally{ul.value=!1}}async function St(n){Al.value=n.channelId,we.value=[],Fl.value=0,dl.value=0,Dl.value=!0,await Jl()}async function Jl(){Ye.value=!0;try{const l=(await tt.messages(y,Al.value,{limit:cs,offset:dl.value})).data;Fl.value=l.total,dl.value===0?we.value=l.messages:we.value=[...l.messages,...we.value],dl.value+=l.messages.length}catch{p.error("加载消息失败")}finally{Ye.value=!1}}async function Lt(){await Jl()}return Pl(oe,n=>{n==="convlogs"&&Ul.value.length===0&&ql()}),(n,l)=>{const r=c("el-button"),C=c("el-tag"),R=c("el-text"),$e=c("el-header"),z=c("el-option"),me=c("el-select"),P=c("el-input"),fe=c("el-tab-pane"),Q=c("el-card"),j=c("el-col"),Ve=c("el-row"),T=c("el-form-item"),qe=c("el-form"),Hl=c("el-badge"),E=c("el-table-column"),rl=c("el-table"),Je=c("el-switch"),It=c("el-input-number"),K=c("el-icon"),Gl=c("el-tree"),Nl=c("el-empty"),Ql=c("el-breadcrumb-item"),Ut=c("el-breadcrumb"),vl=c("el-dialog"),Dt=c("el-drawer"),At=c("el-link"),Ft=c("CircleCheck"),Nt=c("Warning"),Mt=c("CircleClose"),Xl=c("InfoFilled"),Zl=c("Link"),Bt=c("el-tabs"),Pt=c("el-main"),Et=c("el-container"),Ml=Jt("loading");return i(),h(Et,{class:"agent-detail"},{default:t(()=>[e($e,{class:"detail-header"},{default:t(()=>[s("div",Ra,[e(r,{icon:U(jt),onClick:l[0]||(l[0]=a=>n.$router.push("/agents")),circle:""},null,8,["icon"]),s("h2",null,v(W.value?.name||"..."),1),e(C,{type:kl(W.value?.status)},{default:t(()=>[o(v(xl(W.value?.status)),1)]),_:1},8,["type"])]),e(R,{type:"info"},{default:t(()=>[o(v(W.value?.model),1)]),_:1})]),_:1}),e(Pt,null,{default:t(()=>[e(Bt,{modelValue:oe.value,"onUpdate:modelValue":l[45]||(l[45]=a=>oe.value=a),type:"border-card"},{default:t(()=>[e(fe,{label:"对话",name:"chat"},{default:t(()=>[s("div",ja,[s("div",Ka,[s("div",Wa,[l[47]||(l[47]=s("span",{class:"sidebar-title"},"历史对话",-1)),e(r,{size:"small",type:"primary",plain:"",onClick:Pe,icon:U(ml)},{default:t(()=>[...l[46]||(l[46]=[o("新建",-1)])]),_:1},8,["icon"])]),el((i(),f("div",Oa,[(i(!0),f(N,null,G(x.value,a=>(i(),f("div",{key:a.id,class:Ze(["session-item",{active:D.value===a.id}]),onClick:w=>ke(a)},[s("div",qa,v(a.title||"新对话"),1),s("div",Ja,[s("span",null,v(ce(a.lastAt)),1),e(C,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[o(v(a.messageCount)+" 条 ",1)]),_:2},1024),a.tokenEstimate>6e4?(i(),h(C,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[o("~"+v(Math.round(a.tokenEstimate/1e3))+"k",1)]),_:2},1024)):$("",!0)])],10,Ya))),128)),!V.value&&!x.value.length?(i(),f("div",Ha," 还没有对话记录 ")):$("",!0)])),[[Ml,V.value]]),s("div",Ga,[e(r,{size:"small",plain:"",class:"at-toggle-btn",onClick:Ee},{default:t(()=>[...l[48]||(l[48]=[s("span",{class:"at-icon"},"@",-1),o(" 其他成员 ",-1)])]),_:1}),O.value?(i(),f("div",Qa,[e(me,{modelValue:ee.value,"onUpdate:modelValue":l[1]||(l[1]=a=>ee.value=a),placeholder:"选择成员",size:"small",style:{width:"100%","margin-bottom":"6px"},onChange:pl},{default:t(()=>[(i(!0),f(N,null,G(Y.value,a=>(i(),h(z,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e(P,{modelValue:le.value,"onUpdate:modelValue":l[2]||(l[2]=a=>le.value=a),type:"textarea",rows:3,placeholder:"输入要转发的消息…",size:"small",style:{"margin-bottom":"6px"}},null,8,["modelValue"]),e(r,{type:"primary",size:"small",style:{width:"100%"},loading:te.value,disabled:!ee.value||!le.value.trim(),onClick:yl},{default:t(()=>[...l[49]||(l[49]=[o(" 转发 ",-1)])]),_:1},8,["loading","disabled"])])):$("",!0)])]),s("div",Xa,[e(ot,{ref_key:"aiChatRef",ref:m,"agent-id":U(y),scenario:"agent-detail","welcome-message":`你好！我是 **${W.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:Te},null,8,["agent-id","welcome-message"])])])]),_:1}),e(fe,{label:"身份 & 灵魂",name:"identity"},{default:t(()=>[e(Ve,{gutter:20},{default:t(()=>[e(j,{span:12},{default:t(()=>[e(Q,{header:"IDENTITY.md"},{default:t(()=>[e(P,{modelValue:Se.value,"onUpdate:modelValue":l[3]||(l[3]=a=>Se.value=a),type:"textarea",rows:15,onBlur:l[4]||(l[4]=a=>Il("IDENTITY.md",Se.value))},null,8,["modelValue"])]),_:1})]),_:1}),e(j,{span:12},{default:t(()=>[e(Q,{header:"SOUL.md"},{default:t(()=>[e(P,{modelValue:J.value,"onUpdate:modelValue":l[5]||(l[5]=a=>J.value=a),type:"textarea",rows:15,onBlur:l[6]||(l[6]=a=>Il("SOUL.md",J.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(fe,{label:"关系",name:"relations"},{default:t(()=>[e(Ve,{gutter:20},{default:t(()=>[e(j,{span:14},{default:t(()=>[e(Q,{style:{"margin-bottom":"16px"}},{header:t(()=>[...l[50]||(l[50]=[s("span",{style:{"font-weight":"600"}},"添加关系",-1)])]),default:t(()=>[e(qe,{model:F.value,"label-position":"top",size:"default"},{default:t(()=>[e(Ve,{gutter:12},{default:t(()=>[e(j,{span:10},{default:t(()=>[e(T,{label:"关联成员"},{default:t(()=>[e(me,{modelValue:F.value.agentId,"onUpdate:modelValue":l[7]||(l[7]=a=>F.value.agentId=a),placeholder:"选择系统成员",filterable:"",style:{width:"100%"},onChange:bl},{default:t(()=>[(i(!0),f(N,null,G(Y.value,a=>(i(),h(z,{key:a.id,label:a.name,value:a.id},{default:t(()=>[s("div",Za,[s("div",{style:Xe([{width:"24px",height:"24px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"11px",color:"#fff","flex-shrink":"0"},{background:de(a.id)}])},v(a.name.charAt(0)),5),s("span",null,v(a.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(j,{span:7},{default:t(()=>[e(T,{label:"关系类型"},{default:t(()=>[e(me,{modelValue:F.value.relationType,"onUpdate:modelValue":l[8]||(l[8]=a=>F.value.relationType=a),style:{width:"100%"}},{default:t(()=>[e(z,{label:"上级",value:"上级"}),e(z,{label:"下级",value:"下级"}),e(z,{label:"平级协作",value:"平级协作"}),e(z,{label:"支持",value:"支持"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(j,{span:7},{default:t(()=>[e(T,{label:"协作程度"},{default:t(()=>[e(me,{modelValue:F.value.strength,"onUpdate:modelValue":l[9]||(l[9]=a=>F.value.strength=a),style:{width:"100%"}},{default:t(()=>[e(z,{label:"核心",value:"核心"}),e(z,{label:"常用",value:"常用"}),e(z,{label:"偶尔",value:"偶尔"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(Ve,{gutter:12},{default:t(()=>[e(j,{span:18},{default:t(()=>[e(T,{label:"说明（选填）"},{default:t(()=>[e(P,{modelValue:F.value.desc,"onUpdate:modelValue":l[10]||(l[10]=a=>F.value.desc=a),placeholder:"简要描述这段关系..."},null,8,["modelValue"])]),_:1})]),_:1}),e(j,{span:6},{default:t(()=>[e(T,{label:" "},{default:t(()=>[e(r,{type:"primary",style:{width:"100%"},disabled:!F.value.agentId||!F.value.relationType||!F.value.strength,loading:_e.value,onClick:wl},{default:t(()=>[...l[51]||(l[51]=[o(" 添加 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(Q,null,{header:t(()=>[s("span",en,[l[52]||(l[52]=o("已有关系 ",-1)),e(Hl,{value:I.value.length,type:"info",style:{"margin-left":"4px"}},null,8,["value"])])]),default:t(()=>[I.value.length===0?(i(),f("div",ln," 暂无关系，请在上方添加 ")):(i(),h(rl,{key:1,data:I.value,size:"small",style:{width:"100%"}},{default:t(()=>[e(E,{label:"成员","min-width":"120"},{default:t(({row:a})=>[s("div",tn,[s("div",{style:Xe([{width:"28px",height:"28px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"12px",color:"#fff","flex-shrink":"0"},{background:de(a.agentId)}])},v(a.agentName.charAt(0)),5),s("span",an,v(a.agentName),1)])]),_:1}),e(E,{label:"类型",width:"100"},{default:t(({row:a})=>[e(C,{type:re(a.relationType),size:"small"},{default:t(()=>[o(v(a.relationType),1)]),_:2},1032,["type"])]),_:1}),e(E,{label:"程度",width:"80"},{default:t(({row:a})=>[e(C,{type:ae(a.strength),size:"small",effect:"plain"},{default:t(()=>[o(v(a.strength),1)]),_:2},1032,["type"])]),_:1}),e(E,{label:"说明","min-width":"120","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",nn,v(a.desc||"—"),1)]),_:1}),e(E,{label:"操作",width:"70",fixed:"right"},{default:t(({$index:a})=>[e(r,{type:"danger",link:"",size:"small",onClick:w=>tl(a)},{default:t(()=>[...l[53]||(l[53]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})]),_:1}),e(j,{span:10},{default:t(()=>[e(Q,{header:"关系预览"},{default:t(()=>[I.value.length===0?(i(),f("div",sn," 暂无关系数据 ")):(i(),f("div",on,[(i(!0),f(N,null,G(I.value,a=>(i(),f("div",{key:a.agentId,class:"relation-card"},[s("div",{class:"relation-avatar",style:Xe({background:de(a.agentId)})},v(a.agentName.charAt(0).toUpperCase()),5),s("div",un,[s("div",dn,v(a.agentName),1),s("div",rn,[e(C,{type:re(a.relationType),size:"small"},{default:t(()=>[o(v(a.relationType),1)]),_:2},1032,["type"]),e(C,{type:ae(a.strength),size:"small",effect:"plain"},{default:t(()=>[o(v(a.strength),1)]),_:2},1032,["type"])]),s("div",vn,v(a.desc),1)])]))),128))]))]),_:1})]),_:1})]),_:1})]),_:1}),e(fe,{label:"记忆",name:"memory"},{default:t(()=>[e(Q,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",mn,[l[54]||(l[54]=s("span",{style:{"font-weight":"600"}},"自动记忆",-1)),e(Je,{modelValue:M.value.enabled,"onUpdate:modelValue":l[11]||(l[11]=a=>M.value.enabled=a),"active-text":"已开启","inactive-text":"已关闭",onChange:xe},null,8,["modelValue"])])]),default:t(()=>[e(qe,{model:M.value,"label-position":"top",size:"small",disabled:!M.value.enabled},{default:t(()=>[e(Ve,{gutter:16},{default:t(()=>[e(j,{span:6},{default:t(()=>[e(T,{label:"整理频率"},{default:t(()=>[e(me,{modelValue:M.value.schedule,"onUpdate:modelValue":l[12]||(l[12]=a=>M.value.schedule=a),style:{width:"100%"}},{default:t(()=>[e(z,{label:"每小时",value:"hourly"}),e(z,{label:"每6小时",value:"every6h"}),e(z,{label:"每天",value:"daily"}),e(z,{label:"每周",value:"weekly"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(j,{span:5},{default:t(()=>[e(T,{label:"每个会话保留轮数"},{default:t(()=>[e(It,{modelValue:M.value.keepTurns,"onUpdate:modelValue":l[13]||(l[13]=a=>M.value.keepTurns=a),min:1,max:20,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(j,{span:13},{default:t(()=>[e(T,{label:"记录重点（留空则自动）"},{default:t(()=>[e(P,{modelValue:M.value.focusHint,"onUpdate:modelValue":l[14]||(l[14]=a=>M.value.focusHint=a),placeholder:"例如：记录数学解题步骤和用户常见错误"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s("div",fn,[e(r,{type:"primary",size:"small",loading:Le.value,onClick:xe},{default:t(()=>[...l[55]||(l[55]=[o(" 保存设置 ",-1)])]),_:1},8,["loading"]),e(r,{size:"small",loading:Ie.value,onClick:gl},{default:t(()=>[...l[56]||(l[56]=[o(" 立即整理 ",-1)])]),_:1},8,["loading"]),e(R,{type:"info",size:"small",style:{"align-self":"center","margin-left":"4px"}},{default:t(()=>[o(" 整理后：LLM提炼摘要写入 MEMORY.md，每个会话只保留最近 "+v(M.value.keepTurns)+" 轮对话 ",1)]),_:1})])]),_:1},8,["model","disabled"])]),_:1}),e(Q,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",cn,[l[58]||(l[58]=s("span",{style:{"font-weight":"600"}},"整理日志",-1)),e(r,{size:"small",text:"",onClick:Re,loading:Ue.value},{default:t(()=>[...l[57]||(l[57]=[o("刷新",-1)])]),_:1},8,["loading"])])]),default:t(()=>[pe.value.length===0&&!Ue.value?(i(),f("div",pn," 暂无运行记录，点击「立即整理」触发第一次 ")):(i(),h(rl,{key:1,data:pe.value.slice(0,20),size:"small"},{default:t(()=>[e(E,{label:"时间",width:"160"},{default:t(({row:a})=>[s("span",yn,v(Ae(a.timestamp)),1)]),_:1}),e(E,{label:"状态",width:"72"},{default:t(({row:a})=>[e(C,{type:a.status==="ok"?"success":"danger",size:"small"},{default:t(()=>[o(v(a.status),1)]),_:2},1032,["type"])]),_:1}),e(E,{label:"结果","min-width":"200","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",gn,v(a.message||"—"),1)]),_:1})]),_:1},8,["data"]))]),_:1}),s("div",_n,[e(r,{type:"primary",size:"small",onClick:l[15]||(l[15]=a=>he.value=!0)},{default:t(()=>[e(K,null,{default:t(()=>[e(U(ml))]),_:1}),l[59]||(l[59]=o(" 新建文件 ",-1))]),_:1}),e(r,{size:"small",onClick:l[16]||(l[16]=a=>u.value=!0)},{default:t(()=>[e(K,null,{default:t(()=>[e(U(Kt))]),_:1}),l[60]||(l[60]=o(" 添加日志 ",-1))]),_:1}),e(r,{size:"small",onClick:Oe},{default:t(()=>[e(K,null,{default:t(()=>[e(U(El))]),_:1}),l[61]||(l[61]=o(" 刷新 ",-1))]),_:1})]),e(Ve,{gutter:16},{default:t(()=>[e(j,{span:7},{default:t(()=>[e(Q,{header:"记忆目录",shadow:"hover"},{default:t(()=>[e(Gl,{data:De.value,props:{label:"name",children:"children",isLeaf:a=>!a.isDir},onNodeClick:_t,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:t(({data:a})=>[s("span",bn,[a.isDir?(i(),h(K,{key:0,style:{color:"#E6A23C"}},{default:t(()=>[e(U(Wt))]),_:1})):(i(),h(K,{key:1,style:{color:"#409EFF"}},{default:t(()=>[e(U(Ot))]),_:1})),s("span",null,v(a.name),1),!a.isDir&&a.size?(i(),h(R,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:t(()=>[o(v(nl(a.size)),1)]),_:2},1024)):$("",!0)])]),_:1},8,["data","props"]),De.value.length===0?(i(),h(Nl,{key:0,description:"记忆树为空","image-size":40})):$("",!0)]),_:1})]),_:1}),e(j,{span:17},{default:t(()=>[e(Q,{shadow:"hover"},{header:t(()=>[s("div",wn,[e(Ut,{separator:"/"},{default:t(()=>[e(Ql,null,{default:t(()=>[...l[62]||(l[62]=[o("memory",-1)])]),_:1}),(i(!0),f(N,null,G(ge.value,(a,w)=>(i(),h(Ql,{key:w},{default:t(()=>[o(v(a),1)]),_:2},1024))),128))]),_:1}),ye.value?(i(),h(r,{key:0,type:"primary",size:"small",onClick:bt,loading:je.value},{default:t(()=>[...l[63]||(l[63]=[o("保存",-1)])]),_:1},8,["loading"])):$("",!0)])]),default:t(()=>[ye.value?(i(),h(P,{key:0,modelValue:ue.value,"onUpdate:modelValue":l[17]||(l[17]=a=>ue.value=a),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(i(),h(Nl,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),e(vl,{modelValue:he.value,"onUpdate:modelValue":l[20]||(l[20]=a=>he.value=a),title:"新建记忆文件",width:"480px"},{footer:t(()=>[e(r,{onClick:l[19]||(l[19]=a=>he.value=!1)},{default:t(()=>[...l[65]||(l[65]=[o("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:wt},{default:t(()=>[...l[66]||(l[66]=[o("创建",-1)])]),_:1})]),default:t(()=>[e(qe,{"label-width":"80px"},{default:t(()=>[e(T,{label:"路径"},{default:t(()=>[e(P,{modelValue:_.value,"onUpdate:modelValue":l[18]||(l[18]=a=>_.value=a),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),e(R,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:t(()=>[...l[64]||(l[64]=[o("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(vl,{modelValue:u.value,"onUpdate:modelValue":l[23]||(l[23]=a=>u.value=a),title:"添加今日日志",width:"600px"},{footer:t(()=>[e(r,{onClick:l[22]||(l[22]=a=>u.value=!1)},{default:t(()=>[...l[67]||(l[67]=[o("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:kt},{default:t(()=>[...l[68]||(l[68]=[o("提交",-1)])]),_:1})]),default:t(()=>[e(P,{modelValue:L.value,"onUpdate:modelValue":l[21]||(l[21]=a=>L.value=a),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),e(fe,{label:"技能",name:"skills"},{default:t(()=>[e(Ea,{"agent-id":U(y)},null,8,["agent-id"])]),_:1}),e(fe,{label:"历史对话",name:"convlogs"},{default:t(()=>[s("div",kn,[l[69]||(l[69]=s("span",{style:{"font-weight":"600","font-size":"15px"}},"渠道对话记录",-1)),e(r,{size:"small",icon:U(El),circle:"",onClick:ql,loading:ul.value},null,8,["icon","loading"])]),el((i(),h(rl,{data:Ul.value,stripe:"","empty-text":"暂无对话记录"},{default:t(()=>[e(E,{label:"渠道","min-width":"200"},{default:t(({row:a})=>[s("span",null,v(a.channelType==="telegram"?"Telegram":"Web")+" "+v(a.channelId),1)]),_:1}),e(E,{label:"消息数",width:"100"},{default:t(({row:a})=>[o(v(a.messageCount)+" 条",1)]),_:1}),e(E,{label:"最后活跃",width:"180"},{default:t(({row:a})=>[o(v(a.lastAt?new Date(a.lastAt).toLocaleString("zh-CN"):"-"),1)]),_:1}),e(E,{label:"操作",width:"100"},{default:t(({row:a})=>[e(r,{size:"small",type:"primary",plain:"",onClick:w=>St(a)},{default:t(()=>[...l[70]||(l[70]=[o("查看",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ml,ul.value]]),e(Dt,{modelValue:Dl.value,"onUpdate:modelValue":l[24]||(l[24]=a=>Dl.value=a),title:Al.value+" 对话记录",direction:"rtl",size:"520px","destroy-on-close":!1},{default:t(()=>[s("div",xn,[Tt.value?(i(),f("div",hn,[e(r,{size:"small",plain:"",loading:Ye.value,onClick:Lt},{default:t(()=>[...l[71]||(l[71]=[o("加载更多",-1)])]),_:1},8,["loading"])])):$("",!0),el((i(),f("div",Cn,[(i(!0),f(N,null,G(we.value,(a,w)=>(i(),f("div",{key:w,class:Ze(["conv-msg-item",a.role==="user"?"conv-msg-user":"conv-msg-assistant"])},[s("div",$n,[s("span",Vn,v(a.role==="user"?"用户":"助手"),1),a.sender?(i(),f("span",zn,v(a.sender),1)):$("",!0),s("span",Tn,v(a.ts?new Date(a.ts).toLocaleString("zh-CN"):""),1)]),s("div",Sn,v(a.content),1)],2))),128)),!Ye.value&&we.value.length===0?(i(),f("div",Ln," 暂无消息记录 ")):$("",!0)])),[[Ml,Ye.value&&we.value.length===0]])])]),_:1},8,["modelValue","title"])]),_:1}),e(fe,{label:"工作区",name:"workspace"},{default:t(()=>[e(Ve,{gutter:20},{default:t(()=>[e(j,{span:8},{default:t(()=>[e(Q,{header:"文件列表"},{default:t(()=>[e(Gl,{data:k.value,props:{label:"name",children:"children"},onNodeClick:ht,"highlight-current":"","default-expand-all":""},null,8,["data"])]),_:1})]),_:1}),e(j,{span:16},{default:t(()=>[e(Q,{header:A.value||"选择文件查看"},{default:t(()=>[A.value?(i(),f(N,{key:0},[e(P,{modelValue:H.value,"onUpdate:modelValue":l[25]||(l[25]=a=>H.value=a),type:"textarea",rows:20},null,8,["modelValue"]),s("div",In,[e(r,{type:"primary",onClick:Ct},{default:t(()=>[...l[72]||(l[72]=[o("保存",-1)])]),_:1}),q.value?(i(),h(R,{key:0,type:"info",size:"small"},{default:t(()=>[o(v(nl(q.value.size))+" · "+v(b(q.value.modTime)),1)]),_:1})):$("",!0)])],64)):$("",!0)]),_:1},8,["header"])]),_:1})]),_:1})]),_:1}),e(fe,{label:"定时任务",name:"cron"},{default:t(()=>[e(r,{type:"primary",onClick:l[26]||(l[26]=a=>be.value=!0),style:{"margin-bottom":"16px"}},{default:t(()=>[e(K,null,{default:t(()=>[e(U(ml))]),_:1}),l[73]||(l[73]=o(" 新建任务 ",-1))]),_:1}),e(rl,{data:Ce.value,stripe:""},{default:t(()=>[e(E,{prop:"name",label:"名称"}),e(E,{label:"调度"},{default:t(({row:a})=>[o(v(a.schedule?.expr)+" ("+v(a.schedule?.tz)+")",1)]),_:1}),e(E,{label:"最近运行",width:"180"},{default:t(({row:a})=>[a.state?.lastRunAtMs?(i(),f(N,{key:0},[e(C,{type:a.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:t(()=>[o(v(a.state?.lastStatus),1)]),_:2},1032,["type"]),e(R,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:t(()=>[o(v(Ae(a.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(i(),h(R,{key:1,type:"info",size:"small"},{default:t(()=>[...l[74]||(l[74]=[o("未运行",-1)])]),_:1}))]),_:1}),e(E,{label:"启用",width:"80"},{default:t(({row:a})=>[e(Je,{modelValue:a.enabled,"onUpdate:modelValue":w=>a.enabled=w,onChange:w=>Vt(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(E,{label:"操作",width:"220"},{default:t(({row:a})=>[a.payload?.message==="__MEMORY_CONSOLIDATE__"?(i(),f(N,{key:0},[e(C,{type:"info",size:"small",style:{"margin-right":"8px"}},{default:t(()=>[...l[75]||(l[75]=[o("记忆管理",-1)])]),_:1}),e(r,{size:"small",onClick:w=>Yl(a)},{default:t(()=>[...l[76]||(l[76]=[o("立即运行",-1)])]),_:1},8,["onClick"])],64)):(i(),f(N,{key:1},[e(r,{size:"small",onClick:w=>Yl(a)},{default:t(()=>[...l[77]||(l[77]=[o("立即运行",-1)])]),_:1},8,["onClick"]),e(r,{size:"small",type:"danger",onClick:w=>zt(a)},{default:t(()=>[...l[78]||(l[78]=[o("删除",-1)])]),_:1},8,["onClick"])],64))]),_:1})]),_:1},8,["data"]),e(vl,{modelValue:be.value,"onUpdate:modelValue":l[33]||(l[33]=a=>be.value=a),title:"新建定时任务",width:"520px"},{footer:t(()=>[e(r,{onClick:l[32]||(l[32]=a=>be.value=!1)},{default:t(()=>[...l[79]||(l[79]=[o("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:$t},{default:t(()=>[...l[80]||(l[80]=[o("创建",-1)])]),_:1})]),default:t(()=>[e(qe,{model:B.value,"label-width":"100px"},{default:t(()=>[e(T,{label:"名称"},{default:t(()=>[e(P,{modelValue:B.value.name,"onUpdate:modelValue":l[27]||(l[27]=a=>B.value.name=a)},null,8,["modelValue"])]),_:1}),e(T,{label:"Cron 表达式"},{default:t(()=>[e(P,{modelValue:B.value.expr,"onUpdate:modelValue":l[28]||(l[28]=a=>B.value.expr=a),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),e(T,{label:"时区"},{default:t(()=>[e(me,{modelValue:B.value.tz,"onUpdate:modelValue":l[29]||(l[29]=a=>B.value.tz=a)},{default:t(()=>[e(z,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),e(z,{label:"UTC",value:"UTC"}),e(z,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),e(T,{label:"消息"},{default:t(()=>[e(P,{modelValue:B.value.message,"onUpdate:modelValue":l[30]||(l[30]=a=>B.value.message=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),e(T,{label:"启用"},{default:t(()=>[e(Je,{modelValue:B.value.enabled,"onUpdate:modelValue":l[31]||(l[31]=a=>B.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1}),e(fe,{label:"渠道",name:"channels"},{default:t(()=>[s("div",Un,[e(R,{type:"info",size:"small"},{default:t(()=>[...l[81]||(l[81]=[o("每个 AI 成员独立配置自己的消息通道（如 Telegram Bot Token）",-1)])]),_:1}),e(r,{type:"primary",size:"small",onClick:ut},{default:t(()=>[e(K,null,{default:t(()=>[e(U(ml))]),_:1}),l[82]||(l[82]=o(" 添加消息渠道 ",-1))]),_:1})]),(i(!0),f(N,null,G(ve.value,a=>(i(),f("div",{key:a.id,class:"channel-card"},[s("div",Dn,[s("div",An,[e(C,{size:"small",style:{"margin-right":"8px"}},{default:t(()=>[o(v(a.type),1)]),_:2},1024),s("span",Fn,v(a.name),1),a.config?.botName?(i(),f("span",Nn,"@"+v(a.config.botName),1)):$("",!0),e(C,{type:a.status==="ok"?"success":a.status==="error"?"danger":"info",size:"small",effect:"plain",style:{"margin-left":"8px"}},{default:t(()=>[o(v(a.status==="ok"?"✓ 正常":a.status==="error"?"✗ 错误":"未测试"),1)]),_:2},1032,["type"])]),s("div",Mn,[e(Je,{modelValue:a.enabled,"onUpdate:modelValue":w=>a.enabled=w,size:"small",onChange:vt,style:{"margin-right":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),e(r,{size:"small",onClick:w=>ft(a),loading:$l.value===a.id},{default:t(()=>[...l[83]||(l[83]=[o("测试连接",-1)])]),_:1},8,["onClick","loading"]),e(r,{size:"small",onClick:w=>dt(a)},{default:t(()=>[...l[84]||(l[84]=[o("编辑",-1)])]),_:1},8,["onClick"]),e(r,{size:"small",type:"danger",plain:"",onClick:w=>mt(a)},{default:t(()=>[...l[85]||(l[85]=[o("删除",-1)])]),_:1},8,["onClick"])])]),a.type==="web"?(i(),f("div",Bn,[s("div",Pn,[l[87]||(l[87]=s("span",{class:"channel-info-label"},"公开地址",-1)),s("span",En,[e(At,{href:Ne(U(y),a.id),target:"_blank",type:"primary",style:{"font-size":"13px"}},{default:t(()=>[o(v(Ne(U(y),a.id)),1)]),_:2},1032,["href"]),e(r,{size:"small",link:"",style:{"margin-left":"8px"},onClick:w=>Wl(Ne(U(y),a.id))},{default:t(()=>[...l[86]||(l[86]=[o("复制",-1)])]),_:1},8,["onClick"])])]),s("div",Rn,[l[88]||(l[88]=s("span",{class:"channel-info-label"},"访问密码",-1)),s("span",jn,[e(C,{size:"small",type:a.config?.password?"warning":"info",effect:"plain"},{default:t(()=>[o(v(a.config?.password?"已设置":"无密码"),1)]),_:2},1032,["type"])])])])):$("",!0),a.type==="telegram"?(i(),f("div",Kn,[s("div",Wn,[l[90]||(l[90]=s("span",{class:"channel-info-label"},"白名单用户",-1)),s("span",On,[a.allowedFromUsers?.length?(i(!0),f(N,{key:0},G(a.allowedFromUsers,w=>(i(),h(C,{key:w.id,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:Bl=>Ol(a.id,w.id)},{default:t(()=>[o(v(w.username?"@"+w.username:w.firstName||String(w.id))+" ",1),s("span",Yn,"("+v(w.id)+")",1)]),_:2},1032,["onClose"]))),128)):a.config?.allowedFrom?(i(!0),f(N,{key:1},G(a.config.allowedFrom.split(","),w=>(i(),h(C,{key:w,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:Bl=>Ol(a.id,Number(w.trim()))},{default:t(()=>[o(v(w.trim()),1)]),_:2},1032,["onClose"]))),128)):(i(),h(R,{key:2,type:"warning",size:"small"},{default:t(()=>[...l[89]||(l[89]=[o("未设置（配对模式，向用户返回其 ID）",-1)])]),_:1}))])]),s("div",qn,[s("div",{class:"pending-section-header",onClick:w=>ct(a.id)},[l[92]||(l[92]=s("span",null,"待审核用户",-1)),e(Hl,{value:(Be.value[a.id]||[]).length,hidden:!(Be.value[a.id]||[]).length,type:"warning",style:{"margin-left":"6px"}},null,8,["value","hidden"]),e(r,{size:"small",link:"",onClick:st(w=>ol(a.id),["stop"]),style:{"margin-left":"8px"}},{default:t(()=>[...l[91]||(l[91]=[o("刷新",-1)])]),_:1},8,["onClick"]),e(K,{style:Xe([{"margin-left":"4px",transition:"transform 0.2s"},{transform:We.value===a.id?"rotate(180deg)":""}])},{default:t(()=>[e(U(Yt))]),_:1},8,["style"])],8,Jn),We.value===a.id?(i(),f("div",Hn,[Sl.value[a.id]?(i(),f("div",Gn,[e(R,{type:"info",size:"small"},{default:t(()=>[...l[93]||(l[93]=[o("加载中...",-1)])]),_:1})])):(Be.value[a.id]||[]).length?(i(!0),f(N,{key:1},G(Be.value[a.id],w=>(i(),f("div",{key:w.id,class:"pending-user-row"},[s("div",Qn,[s("span",Xn,v(w.firstName||"未知"),1),w.username?(i(),f("span",Zn,"@"+v(w.username),1)):$("",!0),s("span",es,"ID: "+v(w.id),1),e(R,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:t(()=>[o(v(ce(w.lastSeen)),1)]),_:2},1024)]),s("div",ls,[e(r,{size:"small",type:"success",plain:"",onClick:Bl=>pt(a.id,w.id),loading:Ll.value===`${a.id}-${w.id}`},{default:t(()=>[...l[94]||(l[94]=[o("加入白名单",-1)])]),_:1},8,["onClick","loading"]),e(r,{size:"small",type:"danger",plain:"",onClick:Bl=>yt(a.id,w.id)},{default:t(()=>[...l[95]||(l[95]=[o("忽略",-1)])]),_:1},8,["onClick"])])]))),128)):(i(),f("div",ts," 暂无待审核用户。让用户向 Bot 发送 /start 即可出现在此处。 "))])):$("",!0)])])):$("",!0)]))),128)),!hl.value&&!ve.value.length?(i(),h(Nl,{key:0,description:"暂无消息渠道，点击「添加消息渠道」开始配置","image-size":80,style:{"margin-top":"40px"}})):$("",!0),e(vl,{modelValue:Fe.value,"onUpdate:modelValue":l[44]||(l[44]=a=>Fe.value=a),title:ne.value?"编辑消息渠道":"添加消息渠道",width:"540px"},{footer:t(()=>[e(r,{onClick:l[43]||(l[43]=a=>Fe.value=!1)},{default:t(()=>[...l[105]||(l[105]=[o("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:rt,loading:Cl.value},{default:t(()=>[...l[106]||(l[106]=[o("保存",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(qe,{model:g.value,"label-width":"120px"},{default:t(()=>[e(T,{label:"类型",required:""},{default:t(()=>[e(me,{modelValue:g.value.type,"onUpdate:modelValue":l[34]||(l[34]=a=>g.value.type=a),style:{width:"100%"}},{default:t(()=>[e(z,{label:"Telegram",value:"telegram"}),e(z,{label:"Web 聊天页",value:"web"}),e(z,{label:"iMessage",value:"imessage"}),e(z,{label:"WhatsApp",value:"whatsapp"})]),_:1},8,["modelValue"])]),_:1}),e(T,{label:"名称",required:""},{default:t(()=>[e(P,{modelValue:g.value.name,"onUpdate:modelValue":l[35]||(l[35]=a=>g.value.name=a),placeholder:"如：客服 Bot"},null,8,["modelValue"])]),_:1}),g.value.type==="telegram"?(i(),f(N,{key:0},[e(T,{label:"Bot Token",required:""},{default:t(()=>[s("div",as,[s("div",ns,[e(P,{modelValue:g.value.botToken,"onUpdate:modelValue":l[36]||(l[36]=a=>g.value.botToken=a),type:"password","show-password":"",placeholder:"从 @BotFather 获取",style:{flex:"1"},status:S.value.status==="error"?"error":S.value.status==="ok"?"success":""},null,8,["modelValue","status"]),e(r,{size:"default",loading:S.value.loading,type:S.value.status==="ok"?"success":S.value.status==="error"?"danger":"default",onClick:Kl,disabled:!g.value.botToken||zl(g.value.botToken)},{default:t(()=>[...l[96]||(l[96]=[o("验证",-1)])]),_:1},8,["loading","type","disabled"])]),S.value.loading?(i(),f("div",ss,[e(K,{class:"is-loading"},{default:t(()=>[e(U(El))]),_:1}),l[97]||(l[97]=o(" 正在验证 Token… ",-1))])):S.value.status==="ok"?(i(),f("div",os,[e(K,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Ft)]),_:1}),l[98]||(l[98]=o("Token 有效，Bot 名称：",-1)),s("b",null,"@"+v(S.value.botName),1)])):S.value.status==="duplicate"?(i(),f("div",is,[e(K,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Nt)]),_:1}),l[99]||(l[99]=o("此 Token 已被成员「",-1)),s("b",null,v(S.value.usedBy),1),o("」的渠道「"+v(S.value.usedByCh)+"」使用 ",1)])):S.value.status==="error"?(i(),f("div",us,[e(K,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Mt)]),_:1}),o(v(S.value.error),1)])):(i(),f("div",ds,[e(R,{type:"info",size:"small"},{default:t(()=>[e(K,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Xl)]),_:1}),l[100]||(l[100]=o("输入完成后自动验证，也可点右侧「验证」按钮手动触发",-1))]),_:1})]))])]),_:1}),e(T,{label:"白名单用户"},{default:t(()=>[e(P,{modelValue:g.value.allowedFrom,"onUpdate:modelValue":l[37]||(l[37]=a=>g.value.allowedFrom=a),placeholder:"填入 Telegram 用户 ID，多个用逗号分隔"},null,8,["modelValue"]),e(R,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[e(K,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Xl)]),_:1}),l[101]||(l[101]=o("留空时 Bot 进入配对模式——向用户返回其 ID，引导联系管理员添加白名单 ",-1))]),_:1})]),_:1})],64)):$("",!0),g.value.type==="web"?(i(),f(N,{key:1},[ne.value?(i(),h(T,{key:0,label:"访问链接"},{default:t(()=>[s("div",rs,[e(K,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(Zl)]),_:1}),s("span",vs,v(Ne(U(y),ne.value)),1),e(r,{size:"small",link:"",onClick:l[38]||(l[38]=a=>Wl(Ne(U(y),ne.value)))},{default:t(()=>[...l[102]||(l[102]=[o("复制",-1)])]),_:1})])]),_:1})):$("",!0),ne.value?$("",!0):(i(),h(T,{key:1,label:"访问链接"},{default:t(()=>[s("div",ms,[e(K,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(Zl)]),_:1}),s("span",fs,v(Ne(U(y),sl.value)),1),e(C,{size:"small",type:"info",effect:"plain"},{default:t(()=>[...l[103]||(l[103]=[o("保存后生效",-1)])]),_:1})]),e(R,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[...l[104]||(l[104]=[o(" 每个 Web 渠道有独立链接，可同时开放多个入口 ",-1)])]),_:1})]),_:1})),e(T,{label:"访问密码"},{default:t(()=>[e(P,{modelValue:g.value.webPassword,"onUpdate:modelValue":l[39]||(l[39]=a=>g.value.webPassword=a),type:"password","show-password":"",placeholder:"留空则无需密码"},null,8,["modelValue"])]),_:1}),e(T,{label:"欢迎语"},{default:t(()=>[e(P,{modelValue:g.value.webWelcome,"onUpdate:modelValue":l[40]||(l[40]=a=>g.value.webWelcome=a),placeholder:"你好！有什么可以帮你的？"},null,8,["modelValue"])]),_:1}),e(T,{label:"页面标题"},{default:t(()=>[e(P,{modelValue:g.value.webTitle,"onUpdate:modelValue":l[41]||(l[41]=a=>g.value.webTitle=a),placeholder:"AI 助手"},null,8,["modelValue"])]),_:1})],64)):$("",!0),e(T,{label:"启用"},{default:t(()=>[e(Je,{modelValue:g.value.enabled,"onUpdate:modelValue":l[42]||(l[42]=a=>g.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),ws=it(ps,[["__scopeId","data-v-385962f3"]]);export{ws as default};
