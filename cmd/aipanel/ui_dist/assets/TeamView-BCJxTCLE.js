import{d as we,o as m,c as h,F as j,b as n,t as N,a as l,w as a,k as Be,U as Xe,i as fe,f as v,j as F,l as oe,q as _e,n as Ye,x as ne,r as x,h as Fe,T as Oe,m as Pe,g as b,E as L,N as We,e as ee,p as ye,M as ge}from"./index-ChTFaCUg.js";import{r as Y}from"./index-B6ZRKErS.js";import{_ as Ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ge={class:"rel-pair"},He={class:"rel-node"},je={style:{display:"flex","flex-direction":"column","align-items":"center",gap:"2px","flex-shrink":"0"}},Ie={class:"rel-node"},qe={class:"type-grid"},Je=["onClick"],Ke={class:"type-card-top"},Qe={class:"type-desc"},Ze=we({__name:"RelTypeForm",props:{fromName:{},toName:{},type:{},strength:{},desc:{}},emits:["update:type","update:strength","update:desc","swap"],setup(R){const $=R,O=ne(()=>[{value:"上下级",color:"#7c3aed",desc:`${$.fromName} 是 ${$.toName} 的上级，箭头指向下级`},{value:"平级协作",color:"#409eff",desc:`${$.fromName} 与 ${$.toName} 并列合作，地位平等`},{value:"支持",color:"#67c23a",desc:`${$.fromName} 为 ${$.toName} 提供支持和辅助`},{value:"其他",color:"#909399",desc:`${$.fromName} 与 ${$.toName} 之间的其他关系`}]);return(D,d)=>{const z=x("el-icon"),I=x("el-button"),P=x("el-radio-button"),q=x("el-radio-group"),J=x("el-form-item"),le=x("el-input"),K=x("el-form");return m(),h(j,null,[n("div",Ge,[n("span",He,N(R.fromName),1),n("div",je,[l(z,{style:{color:"#c0c4cc","font-size":"16px"}},{default:a(()=>[l(Be(Xe))]),_:1}),R.type==="上下级"?(m(),fe(I,{key:0,size:"small",text:"",type:"primary",style:{padding:"0 4px","font-size":"11px",height:"18px","min-height":"0"},onClick:d[0]||(d[0]=w=>D.$emit("swap")),title:"交换上下级方向"},{default:a(()=>[...d[3]||(d[3]=[v(" ⇄ 翻转 ",-1)])]),_:1})):F("",!0)]),n("span",Ie,N(R.toName),1)]),n("div",qe,[(m(!0),h(j,null,oe(O.value,w=>(m(),h("div",{key:w.value,class:_e(["type-card",{active:R.type===w.value}]),onClick:me=>D.$emit("update:type",w.value)},[n("div",Ke,[n("span",{class:"type-tag",style:Ye({background:w.color+"18",color:w.color})},N(w.value),5)]),n("div",Qe,N(w.desc),1)],10,Je))),128))]),l(K,{"label-width":"72px",style:{"margin-top":"16px"}},{default:a(()=>[l(J,{label:"关系强度"},{default:a(()=>[l(q,{"model-value":R.strength,"onUpdate:modelValue":d[1]||(d[1]=w=>D.$emit("update:strength",w))},{default:a(()=>[l(P,{value:"核心"},{default:a(()=>[...d[4]||(d[4]=[v("核心",-1)])]),_:1}),l(P,{value:"常用"},{default:a(()=>[...d[5]||(d[5]=[v("常用",-1)])]),_:1}),l(P,{value:"偶尔"},{default:a(()=>[...d[6]||(d[6]=[v("偶尔",-1)])]),_:1})]),_:1},8,["model-value"])]),_:1}),l(J,{label:"说明"},{default:a(()=>[l(le,{"model-value":R.desc,"onUpdate:modelValue":d[2]||(d[2]=w=>D.$emit("update:desc",w)),placeholder:"可选备注"},null,8,["model-value"])]),_:1})]),_:1})],64)}}}),he=Ce(Ze,[["__scopeId","data-v-cf559621"]]),et={class:"team-view"},tt={class:"page-header"},ot={style:{display:"flex",gap:"8px"}},nt={key:0,class:"empty-state"},lt={key:0,class:"connect-banner"},st={style:{margin:"0 4px"}},rt=["width","height"],at=["x1","y1","x2","y2"],it=["x1","y1","x2","y2","onClick"],ut=["x1","y1","x2","y2","stroke","stroke-width","marker-end"],dt=["x","y","fill"],ct=["transform","onMousedown","onClick"],ft={key:0,r:"37",fill:"none",stroke:"#409eff","stroke-width":"2.5","stroke-dasharray":"7,3",class:"selection-ring"},mt={key:1,r:"33",fill:"rgba(64,158,255,0.06)",stroke:"#409eff","stroke-width":"1.5","stroke-opacity":"0.5"},pt=["fill"],vt={"text-anchor":"middle","dominant-baseline":"central",fill:"#fff","font-weight":"700","font-size":"15","font-family":"system-ui, sans-serif"},yt=["fill"],gt={"text-anchor":"middle",y:"46","font-size":"12",fill:"#303133","font-family":"system-ui, sans-serif","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},ht={"text-anchor":"middle",y:"58","font-size":"10",fill:"#909399","font-family":"system-ui, monospace"},xt={key:1,class:"no-edge-hint"},kt={class:"legend"},wt={class:"legend-item"},_t={class:"legend-item"},Ct={width:"28",height:"8"},Mt=["stroke-width"],ce=28,xe=160,te=90,ke=80,bt=we({__name:"TeamView",setup(R){const $=b(),O=b(),D=b(!1),d=b({nodes:[],edges:[]}),z=b(860),I={核心:4,常用:2.5,偶尔:1.5},P={上下级:"#7c3aed",上级:"#7c3aed",下级:"#7c3aed",平级协作:"#409eff",支持:"#67c23a",其他:"#909399"};function q(t){return P[t]??"#94a3b8"}function J(t){return t==="上下级"||t==="上级"||t==="下级"}function le(t,e){const r={};t.forEach(p=>{r[p.id]=0});const s=t.length+1,i=t.length+2;for(let p=0;p<i;p++){let k=!1;for(const _ of e){const V=Math.min(r[_.from]??0,s),T=r[_.to]??0;if(_.type==="上下级"){const M=Math.min(V+1,s);T<M&&(r[_.to]=M,k=!0)}else if(_.type==="上级"){const M=V-1;T>M&&(r[_.to]=M,k=!0)}else if(_.type==="下级"){const M=Math.min(V+1,s);T<M&&(r[_.to]=M,k=!0)}}if(!k)break}const y=Object.values(r),c=y.length?Math.min(...y):0;return t.forEach(p=>{r[p.id]=(r[p.id]??0)-c}),r}const K=ne(()=>le(d.value.nodes,d.value.edges)),w=ne(()=>{const t=Object.values(K.value).reduce((e,r)=>Math.max(e,r),0);return Math.max(600,te+t*xe+160)}),me=ne(()=>{const t=d.value.nodes,e=K.value,r=z.value,s={};t.forEach(y=>{const c=e[y.id]??0;s[c]||(s[c]=[]),s[c].push(y.id)});const i={};for(const[y,c]of Object.entries(s)){const p=Number(y),k=te+p*xe,_=r-ke*2,V=c.length>1?_/(c.length-1):0;c.forEach((T,M)=>{i[T]={x:Math.round(c.length===1?r/2:ke+M*V),y:Math.round(k)}})}return i}),Q=b({}),C=b(null),Z=b({x:400,y:te}),W=b(null);function E(t){return Q.value[t]??me.value[t]??{x:z.value/2,y:te}}function Me(t,e){t.preventDefault(),W.value=null;const r=E(e),s=se(t.clientX,t.clientY);C.value={id:e,startClientX:t.clientX,startClientY:t.clientY,offsetX:r.x-s.x,offsetY:r.y-s.y,moved:!1},document.addEventListener("mousemove",re),document.addEventListener("mouseup",ae)}function se(t,e){const r=$.value;if(!r)return{x:t,y:e};const s=r.getScreenCTM();if(!s){const c=r.getBoundingClientRect(),p=c.width>0?z.value/c.width:1,k=c.height>0?w.value/c.height:1;return{x:(t-c.left)*p,y:(e-c.top)*k}}const i=r.createSVGPoint();i.x=t,i.y=e;const y=i.matrixTransform(s.inverse());return{x:y.x,y:y.y}}function re(t){const e=se(t.clientX,t.clientY);if(Z.value=e,!C.value)return;const r=t.clientX-C.value.startClientX,s=t.clientY-C.value.startClientY;if((Math.abs(r)>4||Math.abs(s)>4)&&(C.value.moved=!0),!C.value.moved)return;const i=e.x+C.value.offsetX,y=e.y+C.value.offsetY,c=ce+4,p=1/0,k=ce+4,_=1/0;Q.value={...Q.value,[C.value.id]:{x:Math.round(Math.max(c,Math.min(p,i))),y:Math.round(Math.max(k,Math.min(_,y)))}}}function ae(){C.value?.moved&&(W.value=C.value.id),C.value=null,document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae)}function be(t){C.value||(Z.value=se(t.clientX,t.clientY))}function $e(){g.value=null}const g=b(null);function Ee(t){if(W.value===t){W.value=null;return}if(W.value=null,!g.value){g.value=t;return}if(g.value===t){g.value=null;return}const e=g.value;g.value=null,Re(e,t)}function S(t,e,r){const s=E(t),i=E(e),y=i.x-s.x,c=i.y-s.y,p=Math.sqrt(y*y+c*c)||1,k=ce+3;return r==="start"?{x:s.x+y/p*k,y:s.y+c/p*k}:{x:i.x-y/p*k,y:i.y-c/p*k}}function Ue(t){return I[t]??1.5}const pe=["#409EFF","#67C23A","#E6A23C","#F56C6C","#7C3AED","#0891B2","#B45309","#64748B"];function Le(t){let e=0;for(let r=0;r<t.length;r++)e=t.charCodeAt(r)+((e<<5)-e);return pe[Math.abs(e)%pe.length]??"#409EFF"}function Ne(t){return(t||"?").charAt(0).toUpperCase()}function A(t){return d.value.nodes.find(e=>e.id===t)?.name??t}function De(){Q.value={},L.success("已重置为自动布局")}const G=b(!1),f=ye({from:"",to:"",type:"平级协作",strength:"常用",desc:""}),U=b(!1);function Re(t,e){if(d.value.edges.some(s=>s.from===t&&s.to===e||s.from===e&&s.to===t)){const s=d.value.edges.find(i=>i.from===t&&i.to===e||i.from===e&&i.to===t);ve(s);return}f.from=t,f.to=e,f.type="平级协作",f.strength="常用",f.desc="",G.value=!0}async function Se(){if(!U.value){U.value=!0;try{await Y.putEdge(f.from,f.to,f.type,f.strength,f.desc),L.success("关系已建立"),G.value=!1,await X()}catch{L.error("保存失败")}finally{U.value=!1}}}const B=b(!1),u=ye({from:"",to:"",type:"平级协作",strength:"常用",desc:""});let ie="",ue="";function ve(t){u.from=t.from,u.to=t.to,u.type=t.type,u.strength=t.strength,u.desc=t.label,ie=t.from,ue=t.to,B.value=!0}async function ze(){if(!U.value){U.value=!0;try{(u.from!==ie||u.to!==ue)&&await Y.deleteEdge(ie,ue),await Y.putEdge(u.from,u.to,u.type,u.strength,u.desc),L.success("关系已更新"),B.value=!1,await X()}catch{L.error("保存失败")}finally{U.value=!1}}}async function Ae(){try{await ge.confirm(`删除 ${A(u.from)} ↔ ${A(u.to)} 的关系？`,"删除关系",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"})}catch{return}U.value=!0;try{await Y.deleteEdge(u.from,u.to),L.success("关系已删除"),B.value=!1,await X()}catch{L.error("删除失败")}finally{U.value=!1}}async function X(){D.value=!0;try{const t=await Y.graph();d.value=t.data}catch{L.error("加载图谱失败")}finally{D.value=!1}}async function Ve(){try{await ge.confirm("将清空所有成员的关系，不可恢复。确认吗？","清空所有关系",{confirmButtonText:"确认清空",cancelButtonText:"取消",type:"warning"})}catch{return}try{await Y.clearAll(),L.success("已清空所有成员关系"),await X()}catch{L.error("清空失败")}}let de=null;return Fe(()=>{X(),O.value&&(de=new ResizeObserver(t=>{const e=t[0]?.contentRect.width;e&&e>100&&(z.value=Math.floor(e))}),de.observe(O.value))}),Oe(()=>{de?.disconnect(),document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae)}),(t,e)=>{const r=x("Grid"),s=x("el-icon"),i=x("el-button"),y=x("Refresh"),c=x("Delete"),p=x("Share"),k=x("Link"),_=x("el-card"),V=x("ArrowUp"),T=x("ArrowDown"),M=x("el-dialog"),Te=We("loading");return m(),h("div",et,[n("div",tt,[e[16]||(e[16]=n("h2",null,"团队关系图谱",-1)),n("div",ot,[l(i,{size:"small",onClick:De},{default:a(()=>[l(s,null,{default:a(()=>[l(r)]),_:1}),e[13]||(e[13]=v(" 整理 ",-1))]),_:1}),l(i,{size:"small",onClick:X},{default:a(()=>[l(s,null,{default:a(()=>[l(y)]),_:1}),e[14]||(e[14]=v(" 刷新 ",-1))]),_:1}),l(i,{size:"small",type:"danger",plain:"",onClick:Ve},{default:a(()=>[l(s,null,{default:a(()=>[l(c)]),_:1}),e[15]||(e[15]=v(" 清空关系 ",-1))]),_:1})])]),Pe((m(),fe(_,{class:"graph-card"},{default:a(()=>[!D.value&&!d.value.nodes.length?(m(),h("div",nt,[l(s,{style:{"font-size":"64px",color:"#c0c4cc",display:"block",margin:"0 auto 16px"}},{default:a(()=>[l(p)]),_:1}),e[17]||(e[17]=n("p",{style:{color:"#909399","text-align":"center",margin:"0"}},"暂无成员数据",-1))])):(m(),h("div",{key:1,class:"graph-container",ref_key:"graphContainerRef",ref:O},[g.value?(m(),h("div",lt,[l(s,{style:{"margin-right":"6px"}},{default:a(()=>[l(k)]),_:1}),e[19]||(e[19]=v(" 连线模式：已选中 ",-1)),n("strong",st,N(A(g.value)),1),e[20]||(e[20]=v("，点击另一个成员建立关系 ",-1)),l(i,{size:"small",text:"",style:{"margin-left":"8px"},onClick:e[0]||(e[0]=o=>g.value=null)},{default:a(()=>[...e[18]||(e[18]=[v("取消",-1)])]),_:1})])):F("",!0),(m(),h("svg",{ref_key:"svgRef",ref:$,width:z.value,height:w.value,class:"graph-svg",onMousemove:be,onClick:ee($e,["self"]),style:{display:"block",width:"100%",overflow:"visible"}},[e[22]||(e[22]=n("defs",null,[n("pattern",{id:"smallGrid",width:"20",height:"20",patternUnits:"userSpaceOnUse"},[n("path",{d:"M 20 0 L 0 0 0 20",fill:"none",stroke:"#e8ecf0","stroke-width":"0.5"})]),n("pattern",{id:"grid",width:"100",height:"100",patternUnits:"userSpaceOnUse"},[n("rect",{width:"100",height:"100",fill:"url(#smallGrid)"}),n("path",{d:"M 100 0 L 0 0 0 100",fill:"none",stroke:"#dde1e7","stroke-width":"1"})]),n("marker",{id:"arrow-上下级",markerWidth:"10",markerHeight:"10",refX:"9",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse"},[n("path",{d:"M1,2 L1,8 L9,5 z",fill:"#7c3aed","fill-opacity":"0.85"})]),n("marker",{id:"arrow-上级",markerWidth:"10",markerHeight:"10",refX:"9",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse"},[n("path",{d:"M1,2 L1,8 L9,5 z",fill:"#7c3aed","fill-opacity":"0.85"})]),n("marker",{id:"arrow-下级",markerWidth:"10",markerHeight:"10",refX:"9",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse"},[n("path",{d:"M1,2 L1,8 L9,5 z",fill:"#7c3aed","fill-opacity":"0.85"})])],-1)),e[23]||(e[23]=n("rect",{width:"100%",height:"100%",fill:"url(#grid)",rx:"0"},null,-1)),g.value&&!C.value?(m(),h("line",{key:0,x1:E(g.value).x,y1:E(g.value).y,x2:Z.value.x,y2:Z.value.y,stroke:"#409eff","stroke-width":"2","stroke-dasharray":"6,4","stroke-opacity":"0.7","pointer-events":"none"},null,8,at)):F("",!0),(m(!0),h(j,null,oe(d.value.edges,o=>(m(),h("g",{key:`${o.from}|${o.to}`},[n("line",{x1:S(o.from,o.to,"start").x,y1:S(o.from,o.to,"start").y,x2:S(o.from,o.to,"end").x,y2:S(o.from,o.to,"end").y,stroke:"transparent","stroke-width":"14",style:{cursor:"pointer"},onClick:ee(H=>ve(o),["stop"])},null,8,it),n("line",{x1:S(o.from,o.to,"start").x,y1:S(o.from,o.to,"start").y,x2:S(o.from,o.to,"end").x,y2:S(o.from,o.to,"end").y,stroke:q(o.type),"stroke-width":Ue(o.strength),"stroke-opacity":"0.7","stroke-linecap":"round","marker-end":J(o.type)?`url(#arrow-${o.type})`:void 0,"pointer-events":"none",class:"graph-edge"},null,8,ut),n("text",{x:(E(o.from).x+E(o.to).x)/2,y:(E(o.from).y+E(o.to).y)/2-6,"text-anchor":"middle","font-size":"10",fill:q(o.type),"pointer-events":"none","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},N(o.type),9,dt)]))),128)),(m(!0),h(j,null,oe(d.value.nodes,o=>(m(),h("g",{key:o.id,transform:`translate(${E(o.id).x}, ${E(o.id).y})`,class:_e(["graph-node",{"node-selected":g.value===o.id},{"node-target":!!g.value&&g.value!==o.id}]),style:{cursor:"grab"},onMousedown:ee(H=>Me(H,o.id),["stop"]),onClick:ee(()=>Ee(o.id),["stop"])},[g.value===o.id?(m(),h("circle",ft)):g.value?(m(),h("circle",mt)):F("",!0),e[21]||(e[21]=n("circle",{r:"30",fill:"rgba(0,0,0,0.07)",transform:"translate(2,3)"},null,-1)),n("circle",{r:"28",fill:Le(o.id),stroke:"#fff","stroke-width":"2.5"},null,8,pt),n("text",vt,N(Ne(o.id)),1),n("circle",{cx:"20",cy:"-20",r:"6",fill:o.status==="running"?"#67C23A":"#c0c4cc",stroke:"#fff","stroke-width":"1.5"},null,8,yt),n("text",gt,N(o.name),1),n("text",ht,N(o.id),1)],42,ct))),128))],40,rt)),d.value.edges.length?F("",!0):(m(),h("div",xt," 点击任意成员选中，再点击另一个成员即可创建关系连线 "))],512))]),_:1})),[[Te,D.value]]),d.value.nodes.length?(m(),fe(_,{key:0,class:"legend-card"},{default:a(()=>[n("div",kt,[e[26]||(e[26]=n("span",{class:"legend-title"},"布局规则：",-1)),n("span",wt,[l(s,null,{default:a(()=>[l(V)]),_:1}),e[24]||(e[24]=v(" 上方 = 上级（箭头指下）",-1))]),e[27]||(e[27]=n("span",{class:"legend-item"},"— 同层 = 平级/协作",-1)),n("span",_t,[l(s,null,{default:a(()=>[l(T)]),_:1}),e[25]||(e[25]=v(" 下方 = 下级",-1))]),e[28]||(e[28]=n("span",{class:"legend-divider"},"|",-1)),e[29]||(e[29]=n("span",{class:"legend-title"},"线粗：",-1)),(m(),h(j,null,oe(I,(o,H)=>n("span",{key:H,class:"legend-item"},[(m(),h("svg",Ct,[n("line",{x1:"0",y1:"4",x2:"28",y2:"4",stroke:"#64748b","stroke-width":o,"stroke-linecap":"round"},null,8,Mt)])),v(" "+N(H),1)])),64)),e[30]||(e[30]=n("span",{class:"legend-divider"},"|",-1)),e[31]||(e[31]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#67C23A"})]),v(" 运行中 ")],-1)),e[32]||(e[32]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#c0c4cc"})]),v(" 空闲 ")],-1))])]),_:1})):F("",!0),l(M,{modelValue:G.value,"onUpdate:modelValue":e[6]||(e[6]=o=>G.value=o),title:"建立关系",width:"460px","close-on-click-modal":!1},{footer:a(()=>[l(i,{onClick:e[5]||(e[5]=o=>G.value=!1)},{default:a(()=>[...e[33]||(e[33]=[v("取消",-1)])]),_:1}),l(i,{type:"primary",loading:U.value,onClick:Se},{default:a(()=>[...e[34]||(e[34]=[v("建立",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(he,{"from-name":A(f.from),"to-name":A(f.to),type:f.type,"onUpdate:type":e[1]||(e[1]=o=>f.type=o),strength:f.strength,"onUpdate:strength":e[2]||(e[2]=o=>f.strength=o),desc:f.desc,"onUpdate:desc":e[3]||(e[3]=o=>f.desc=o),onSwap:e[4]||(e[4]=()=>{const o=f.from;f.from=f.to,f.to=o})},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"]),l(M,{modelValue:B.value,"onUpdate:modelValue":e[12]||(e[12]=o=>B.value=o),title:"编辑关系",width:"460px","close-on-click-modal":!1},{footer:a(()=>[l(i,{type:"danger",plain:"",loading:U.value,onClick:Ae},{default:a(()=>[...e[35]||(e[35]=[v("删除关系",-1)])]),_:1},8,["loading"]),l(i,{onClick:e[11]||(e[11]=o=>B.value=!1)},{default:a(()=>[...e[36]||(e[36]=[v("取消",-1)])]),_:1}),l(i,{type:"primary",loading:U.value,onClick:ze},{default:a(()=>[...e[37]||(e[37]=[v("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(he,{"from-name":A(u.from),"to-name":A(u.to),type:u.type,"onUpdate:type":e[7]||(e[7]=o=>u.type=o),strength:u.strength,"onUpdate:strength":e[8]||(e[8]=o=>u.strength=o),desc:u.desc,"onUpdate:desc":e[9]||(e[9]=o=>u.desc=o),onSwap:e[10]||(e[10]=()=>{const o=u.from;u.from=u.to,u.to=o})},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"])])}}}),Lt=Ce(bt,[["__scopeId","data-v-9282ed1f"]]);export{Lt as default};
