import{d as Re,h as Fe,c as f,f as s,a,w as n,k as m,G as Be,g as i,E as g,r,o as u,e as p,F as T,l as H,i as b,P as xe,m as be,t as d,b as I,Q as we,q as Ce,n as ke,j as se,R as He,S as je,D as Pe,M as We,x as ze,L as Ke,u as qe}from"./index-CdcKrFsV.js";import{b as Ge,l as Ve,j}from"./index-Do6KhBZp.js";import{_ as Qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Je={class:"chats-page"},Oe={class:"page-header"},Xe={class:"filter-bar"},Ye={style:{"font-size":"12px","font-family":"monospace",color:"#606266"}},Ze={style:{"font-size":"13px",color:"#909399"}},et={style:{"font-size":"13px"}},tt={class:"filter-bar"},lt={style:{display:"flex","flex-direction":"column",gap:"2px"}},at={style:{"font-weight":"500","font-size":"14px"}},nt={style:{"font-size":"12px",color:"#909399"}},st={style:{"font-size":"13px",color:"#606266"}},ot={style:{"font-size":"13px"}},it={style:{"font-weight":"600","font-size":"16px"}},dt={style:{"font-size":"12px",color:"#909399","margin-top":"4px"}},ut={key:0,style:{"text-align":"center",padding:"40px"}},rt={key:1,class:"message-list"},ct={class:"msg-avatar"},pt={class:"msg-body"},ft={class:"msg-meta"},vt={class:"msg-role"},mt={class:"msg-time"},gt=["innerHTML"],_t={style:{flex:"1","min-width":"0"}},yt={key:0,style:{display:"flex","align-items":"center",gap:"8px"}},ht={style:{"font-weight":"600","font-size":"16px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},xt={key:1,style:{display:"flex","align-items":"center",gap:"8px"}},bt={style:{"font-size":"12px",color:"#909399","margin-top":"4px"}},wt={key:0,style:{"text-align":"center",padding:"40px"}},Ct={key:1,class:"message-list"},kt={key:0,class:"compact-marker"},zt={style:{"font-size":"12px",color:"#606266","line-height":"1.6"}},Vt={class:"msg-avatar"},Tt={class:"msg-body"},It={class:"msg-meta"},Lt={class:"msg-role"},$t={class:"msg-time"},Dt=["innerHTML"],At={style:{display:"flex","justify-content":"flex-end",gap:"10px",padding:"12px 0 0"}},P=50,St=Re({__name:"ChatsView",setup(Mt){const Te=qe(),W=i([]),_=i(!1),K=i("channel");function oe(){K.value==="channel"?D():U()}const L=i([]),q=i(""),G=i(""),$=i(""),Ie=ze(()=>{let l=L.value;if($.value){const e=$.value.toLowerCase();l=l.filter(o=>o.channelId.toLowerCase().includes(e)||o.agentName.toLowerCase().includes(e))}return l});async function D(){_.value=!0;try{const l=await Ve.globalList({agentId:q.value||void 0,channelType:G.value||void 0});L.value=l.data||[]}catch{g.error("åŠ è½½æ¸ é“å¯¹è¯å¤±è´¥")}finally{_.value=!1}}const Q=i(!1),J=i(""),C=i(null),O=i([]),X=i(!1),Y=i(0),Z=i(1);async function ie(l){C.value=l,J.value=`${l.channelType==="telegram"?"âœˆ Telegram":"ğŸŒ Web"} Â· ${l.channelId}`,Q.value=!0,Z.value=1,await de(l,1)}async function de(l,e){X.value=!0;try{const o=(e-1)*P,y=await Ve.messages(l.agentId,l.channelId,{limit:P,offset:o});O.value=y.data.messages||[],Y.value=y.data.total}catch{g.error("åŠ è½½æ¶ˆæ¯å¤±è´¥")}finally{X.value=!1}}async function Le(l){Z.value=l,C.value&&await de(C.value,l)}const A=i([]),ee=i(0),te=i(""),S=i(""),M=i("lastAt"),k=i(!1),c=i(null),E=i([]),N=i(!1),z=i(!1),w=i(""),$e=ze(()=>{let l=A.value;if(S.value){const e=S.value.toLowerCase();l=l.filter(o=>(o.title||"").toLowerCase().includes(e)||o.id.toLowerCase().includes(e)||(o.agentName||"").toLowerCase().includes(e))}return M.value==="messageCount"?l=[...l].sort((e,o)=>o.messageCount-e.messageCount):M.value==="tokenEstimate"&&(l=[...l].sort((e,o)=>o.tokenEstimate-e.tokenEstimate)),l});async function U(){_.value=!0;try{const l=await j.list({agentId:te.value||void 0,limit:200});A.value=l.data.sessions,ee.value=l.data.total}catch(l){g.error("åŠ è½½å¤±è´¥ï¼š"+(l.message||""))}finally{_.value=!1}}async function ue(l){c.value=l,k.value=!0,z.value=!1,E.value=[],N.value=!0;try{const e=await j.get(l.agentId,l.id);E.value=e.data.messages}catch(e){g.error("åŠ è½½å¯¹è¯å¤±è´¥ï¼š"+(e.message||""))}finally{N.value=!1}}function re(l){l&&Te.push(`/agents/${l.agentId}?resumeSession=${l.id}`)}async function De(l){try{await j.delete(l.agentId,l.id),g.success("å·²åˆ é™¤"),c.value?.id===l.id&&(k.value=!1),U()}catch(e){g.error("åˆ é™¤å¤±è´¥ï¼š"+(e.message||""))}}function Ae(){w.value=c.value?.title||"",z.value=!0}async function ce(){if(c.value)try{await j.rename(c.value.agentId,c.value.id,w.value),c.value.title=w.value;const l=A.value.findIndex(e=>e.id===c.value.id);l>=0&&(A.value[l].title=w.value),z.value=!1,g.success("å·²é‡å‘½å")}catch(l){g.error("ä¿å­˜å¤±è´¥ï¼š"+(l.message||""))}}function Se({row:l}){return c.value?.id===l.id?"active-row":""}function V(l){return l?(typeof l=="string"?new Date(l):new Date(l)).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"â€”"}function pe(l){if(!l)return"â€”";const e=typeof l=="string"?new Date(l).getTime():l,o=Date.now()-e;return o<6e4?"åˆšåˆš":o<36e5?`${Math.floor(o/6e4)} åˆ†é’Ÿå‰`:o<864e5?`${Math.floor(o/36e5)} å°æ—¶å‰`:o<7*864e5?`${Math.floor(o/864e5)} å¤©å‰`:V(e)}function fe(l){return l?l>=1e3?`${(l/1e3).toFixed(1)}k`:String(l):"0"}function ve(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```[\s\S]*?```/g,e=>`<pre class="code-block">${e.slice(3,-3)}</pre>`).replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>")}return Fe(async()=>{const l=await Ge.list().catch(()=>({data:[]}));W.value=l.data||[],D()}),(l,e)=>{const o=r("el-button"),y=r("el-badge"),h=r("el-option"),R=r("el-select"),le=r("el-input"),F=r("el-tag"),v=r("el-table-column"),B=r("el-empty"),me=r("el-table"),ae=r("el-card"),ge=r("el-tab-pane"),Me=r("el-popconfirm"),Ee=r("el-tabs"),ne=r("el-icon"),_e=r("el-avatar"),Ne=r("el-pagination"),ye=r("el-drawer"),Ue=r("el-divider"),he=Ke("loading");return u(),f("div",Je,[s("div",Oe,[e[16]||(e[16]=s("div",null,[s("h2",{style:{margin:"0"}},"ğŸ’¬ å¯¹è¯ç®¡ç†"),s("div",{style:{"font-size":"13px",color:"#909399","margin-top":"4px"}}," è·¨æ‰€æœ‰ AI æˆå‘˜çš„å¯¹è¯è®°å½• ")],-1)),a(o,{onClick:oe,loading:_.value,icon:m(Be)},{default:n(()=>[...e[15]||(e[15]=[p("åˆ·æ–°",-1)])]),_:1},8,["loading","icon"])]),a(Ee,{modelValue:K.value,"onUpdate:modelValue":e[8]||(e[8]=t=>K.value=t),onTabChange:oe},{default:n(()=>[a(ge,{label:"æ¸ é“å¯¹è¯",name:"channel"},{label:n(()=>[e[17]||(e[17]=s("span",null,"æ¸ é“å¯¹è¯",-1)),a(y,{value:L.value.length,hidden:!L.value.length,type:"primary",style:{"margin-left":"6px"}},null,8,["value","hidden"])]),default:n(()=>[s("div",Xe,[a(R,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=t=>q.value=t),placeholder:"å…¨éƒ¨æˆå‘˜",clearable:"",style:{width:"160px"},onChange:D},{default:n(()=>[(u(!0),f(T,null,H(W.value,t=>(u(),b(h,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(R,{modelValue:G.value,"onUpdate:modelValue":e[1]||(e[1]=t=>G.value=t),placeholder:"å…¨éƒ¨æ¸ é“ç±»å‹",clearable:"",style:{width:"160px"},onChange:D},{default:n(()=>[a(h,{label:"Telegram",value:"telegram"}),a(h,{label:"Web èŠå¤©é¡µ",value:"web"})]),_:1},8,["modelValue"]),a(le,{modelValue:$.value,"onUpdate:modelValue":e[2]||(e[2]=t=>$.value=t),placeholder:"æœç´¢æ¸ é“ IDâ€¦",clearable:"",style:{width:"200px"},"prefix-icon":m(xe)},null,8,["modelValue","prefix-icon"])]),a(ae,{shadow:"never",style:{"margin-top":"12px"}},{default:n(()=>[be((u(),b(me,{data:Ie.value,stripe:"",onRowClick:ie},{empty:n(()=>[a(B,{description:"æš‚æ— æ¸ é“å¯¹è¯è®°å½•"})]),default:n(()=>[a(v,{label:"AI æˆå‘˜",width:"130"},{default:n(({row:t})=>[a(F,{size:"small",type:"primary",effect:"plain"},{default:n(()=>[p(d(t.agentName),1)]),_:2},1024)]),_:1}),a(v,{label:"æ¸ é“ç±»å‹",width:"110"},{default:n(({row:t})=>[a(F,{type:t.channelType==="telegram"?"success":"warning",size:"small"},{default:n(()=>[p(d(t.channelType==="telegram"?"âœˆ Telegram":t.channelType==="web"?"ğŸŒ Web":t.channelType),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"æ¸ é“ ID","min-width":"200","show-overflow-tooltip":""},{default:n(({row:t})=>[s("span",Ye,d(t.channelId),1)]),_:1}),a(v,{label:"æ¶ˆæ¯æ•°",width:"90",align:"center"},{default:n(({row:t})=>[a(y,{value:t.messageCount,type:"info"},null,8,["value"])]),_:1}),a(v,{label:"é¦–æ¡æ¶ˆæ¯",width:"145"},{default:n(({row:t})=>[s("span",Ze,d(V(t.firstAt)),1)]),_:1}),a(v,{label:"æœ€åæ´»è·ƒ",width:"145"},{default:n(({row:t})=>[s("span",et,d(pe(t.lastAt)),1)]),_:1}),a(v,{label:"æ“ä½œ",width:"80"},{default:n(({row:t})=>[a(o,{size:"small",onClick:I(x=>ie(t),["stop"])},{default:n(()=>[...e[18]||(e[18]=[p("æŸ¥çœ‹",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[he,_.value]])]),_:1})]),_:1}),a(ge,{label:"é¢æ¿ä¼šè¯",name:"session"},{label:n(()=>[e[19]||(e[19]=s("span",null,"é¢æ¿ä¼šè¯",-1)),a(y,{value:ee.value,hidden:!ee.value,type:"info",style:{"margin-left":"6px"}},null,8,["value","hidden"])]),default:n(()=>[s("div",tt,[a(R,{modelValue:te.value,"onUpdate:modelValue":e[3]||(e[3]=t=>te.value=t),placeholder:"å…¨éƒ¨æˆå‘˜",clearable:"",style:{width:"160px"},onChange:U},{default:n(()=>[(u(!0),f(T,null,H(W.value,t=>(u(),b(h,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(le,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=t=>S.value=t),placeholder:"æœç´¢å¯¹è¯æ ‡é¢˜â€¦",clearable:"",style:{width:"220px"},"prefix-icon":m(xe)},null,8,["modelValue","prefix-icon"]),a(R,{modelValue:M.value,"onUpdate:modelValue":e[5]||(e[5]=t=>M.value=t),style:{width:"130px"},onChange:U},{default:n(()=>[a(h,{label:"æœ€è¿‘æ´»è·ƒ",value:"lastAt"}),a(h,{label:"æ¶ˆæ¯æœ€å¤š",value:"messageCount"}),a(h,{label:"Token æœ€å¤š",value:"tokenEstimate"})]),_:1},8,["modelValue"])]),a(ae,{shadow:"never",style:{"margin-top":"12px"}},{default:n(()=>[be((u(),b(me,{data:$e.value,stripe:"","row-class-name":Se,onRowClick:ue,style:{cursor:"pointer"}},{empty:n(()=>[a(B,{description:"æš‚æ— é¢æ¿ä¼šè¯"})]),default:n(()=>[a(v,{label:"å¯¹è¯æ ‡é¢˜","min-width":"220"},{default:n(({row:t})=>[s("div",lt,[s("span",at,d(t.title||"ï¼ˆæ— æ ‡é¢˜ï¼‰"),1),s("span",nt,"ID: "+d(t.id),1)])]),_:1}),a(v,{label:"AI æˆå‘˜",width:"130"},{default:n(({row:t})=>[a(F,{size:"small",type:"primary",effect:"plain"},{default:n(()=>[p(d(t.agentName||t.agentId),1)]),_:2},1024)]),_:1}),a(v,{label:"æ¶ˆæ¯æ•°",width:"90",align:"center"},{default:n(({row:t})=>[a(y,{value:t.messageCount,type:"info"},null,8,["value"])]),_:1}),a(v,{label:"Token ç”¨é‡",width:"130",align:"center"},{default:n(({row:t})=>[a(F,{type:t.tokenEstimate>6e4?"danger":t.tokenEstimate>3e4?"warning":"success",size:"small",effect:"plain"},{default:n(()=>[p(d(fe(t.tokenEstimate)),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"åˆ›å»ºæ—¶é—´",width:"145"},{default:n(({row:t})=>[s("span",st,d(V(t.createdAt)),1)]),_:1}),a(v,{label:"æœ€åæ´»è·ƒ",width:"145"},{default:n(({row:t})=>[s("span",ot,d(pe(t.lastAt)),1)]),_:1}),a(v,{label:"æ“ä½œ",width:"190",onClick:e[7]||(e[7]=I(()=>{},["stop"]))},{default:n(({row:t})=>[a(o,{size:"small",onClick:I(x=>ue(t),["stop"])},{default:n(()=>[...e[20]||(e[20]=[p("æŸ¥çœ‹",-1)])]),_:1},8,["onClick"]),a(o,{size:"small",type:"primary",onClick:I(x=>re(t),["stop"])},{default:n(()=>[...e[21]||(e[21]=[p("ç»§ç»­",-1)])]),_:1},8,["onClick"]),a(Me,{title:"ç¡®è®¤åˆ é™¤æ­¤å¯¹è¯ï¼Ÿ",onConfirm:x=>De(t),width:"200"},{reference:n(()=>[a(o,{size:"small",type:"danger",onClick:e[6]||(e[6]=I(()=>{},["stop"]))},{default:n(()=>[...e[22]||(e[22]=[p("åˆ é™¤",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[he,_.value]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ye,{modelValue:Q.value,"onUpdate:modelValue":e[9]||(e[9]=t=>Q.value=t),title:J.value,size:"50%",direction:"rtl"},{header:n(()=>[s("div",null,[s("div",it,d(J.value),1),s("div",dt,d(C.value?.agentName)+" Â· "+d(C.value?.messageCount)+" æ¡æ¶ˆæ¯ ",1)])]),footer:n(()=>[Y.value>P?(u(),b(Ne,{key:0,"current-page":Z.value,"page-size":P,total:Y.value,layout:"prev, pager, next",onCurrentChange:Le,small:""},null,8,["current-page","total"])):se("",!0)]),default:n(()=>[X.value?(u(),f("div",ut,[a(ne,{class:"is-loading",style:{"font-size":"32px",color:"#409eff"}},{default:n(()=>[a(m(we))]),_:1}),e[23]||(e[23]=s("div",{style:{"margin-top":"12px",color:"#909399"}},"åŠ è½½ä¸­â€¦",-1))])):(u(),f("div",rt,[(u(!0),f(T,null,H(O.value,(t,x)=>(u(),f("div",{key:x,class:Ce(["message-item",`msg-${t.role}`])},[s("div",ct,[a(_e,{size:32,style:ke({background:t.role==="user"?"#409eff":"#67c23a"})},{default:n(()=>[p(d(t.role==="user"?"ç”¨":"AI"),1)]),_:2},1032,["style"])]),s("div",pt,[s("div",ft,[s("span",vt,d(t.role==="user"?t.sender||"ç”¨æˆ·":"AI åŠ©æ‰‹"),1),s("span",mt,d(V(new Date(t.ts).getTime())),1)]),s("div",{class:"msg-text",innerHTML:ve(t.content)},null,8,gt)])],2))),128)),O.value.length?se("",!0):(u(),b(B,{key:0,description:"æš‚æ— æ¶ˆæ¯"}))]))]),_:1},8,["modelValue","title"]),a(ye,{modelValue:k.value,"onUpdate:modelValue":e[14]||(e[14]=t=>k.value=t),title:c.value?.title||"å¯¹è¯è¯¦æƒ…",size:"50%",direction:"rtl"},{header:n(()=>[s("div",_t,[z.value?(u(),f("div",xt,[a(le,{modelValue:w.value,"onUpdate:modelValue":e[10]||(e[10]=t=>w.value=t),size:"small",style:{flex:"1"},onKeyup:We(ce,["enter"])},null,8,["modelValue"]),a(o,{type:"primary",size:"small",onClick:ce},{default:n(()=>[...e[24]||(e[24]=[p("ä¿å­˜",-1)])]),_:1}),a(o,{size:"small",onClick:e[11]||(e[11]=t=>z.value=!1)},{default:n(()=>[...e[25]||(e[25]=[p("å–æ¶ˆ",-1)])]),_:1})])):(u(),f("div",yt,[s("span",ht,d(c.value?.title||"ï¼ˆæ— æ ‡é¢˜ï¼‰"),1),a(o,{icon:m(Pe),circle:"",size:"small",onClick:Ae},null,8,["icon"])])),s("div",bt,d(c.value?.agentName)+" Â· "+d(c.value?.messageCount??0)+" æ¡æ¶ˆæ¯ Â· "+d(fe(c.value?.tokenEstimate??0))+" tokens ",1)])]),footer:n(()=>[s("div",At,[a(o,{onClick:e[12]||(e[12]=t=>k.value=!1)},{default:n(()=>[...e[29]||(e[29]=[p("å…³é—­",-1)])]),_:1}),a(o,{type:"primary",icon:m(je),onClick:e[13]||(e[13]=t=>re(c.value)),disabled:!c.value},{default:n(()=>[...e[30]||(e[30]=[p(" ç»§ç»­å¯¹è¯ ",-1)])]),_:1},8,["icon","disabled"])])]),default:n(()=>[N.value?(u(),f("div",wt,[a(ne,{class:"is-loading",style:{"font-size":"32px",color:"#409eff"}},{default:n(()=>[a(m(we))]),_:1}),e[26]||(e[26]=s("div",{style:{"margin-top":"12px",color:"#909399"}},"åŠ è½½å¯¹è¯å†å²â€¦",-1))])):(u(),f("div",Ct,[(u(!0),f(T,null,H(E.value,(t,x)=>(u(),f("div",{key:x,class:Ce(["message-item",`msg-${t.role}`])},[t.isCompact?(u(),f("div",kt,[a(Ue,null,{default:n(()=>[a(ne,null,{default:n(()=>[a(m(He))]),_:1}),e[27]||(e[27]=s("span",{style:{"margin-left":"6px","font-size":"12px",color:"#909399"}},"ä»¥ä¸Šå†…å®¹å·²å‹ç¼©",-1))]),_:1}),a(ae,{class:"compact-summary",shadow:"never"},{default:n(()=>[s("div",zt,[e[28]||(e[28]=s("strong",null,"æ‘˜è¦ï¼š",-1)),p(d(t.text),1)])]),_:2},1024)])):(u(),f(T,{key:1},[s("div",Vt,[a(_e,{size:32,style:ke({background:t.role==="user"?"#409eff":"#67c23a"})},{default:n(()=>[p(d(t.role==="user"?"ç”¨":"AI"),1)]),_:2},1032,["style"])]),s("div",Tt,[s("div",It,[s("span",Lt,d(t.role==="user"?"ç”¨æˆ·":"AI åŠ©æ‰‹"),1),s("span",$t,d(V(t.timestamp)),1)]),s("div",{class:"msg-text",innerHTML:ve(t.text)},null,8,Dt)])],64))],2))),128)),!E.value.length&&!N.value?(u(),b(B,{key:0,description:"æš‚æ— æ¶ˆæ¯è®°å½•"})):se("",!0)]))]),_:1},8,["modelValue","title"])])}}}),Rt=Qe(St,[["__scopeId","data-v-ba96bfd2"]]);export{Rt as default};
