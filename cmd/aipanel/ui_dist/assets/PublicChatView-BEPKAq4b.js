import{d as q,h as A,c as n,f as e,n as y,t as u,m as V,N as B,M as N,j as C,F as J,l as X,b as W,C as Z,g as o,x as G,O as z,o as r,q as Q}from"./index-DmlRbR38.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"pub-chat-page"},ae={key:0,class:"password-gate"},te={class:"gate-card"},se={class:"gate-name"},oe={key:0,class:"gate-error"},le=["disabled"],ne={key:1,class:"chat-page"},re={class:"chat-header"},ie={class:"chat-header-left"},ue={class:"header-info"},ce={class:"header-name"},de={key:0,class:"welcome-msg"},ve={class:"welcome-bubble"},pe=["innerHTML"],fe={key:1,class:"msg-row assistant"},he={class:"msg-bubble streaming"},ge=["innerHTML"],me={class:"input-area"},we=["onKeydown"],_e=["disabled"],ye={key:2,class:"loading-page"},be=q({__name:"PublicChatView",setup(ke){const c=Z().params.agentId,l=o(null),b=o(!1),$=o(!1),d=o(!1),p=o(""),k=o(!1),f=o(""),h=o([]),g=o(""),v=o(!1),i=o(""),x=o(),m=o(),w=G(()=>(l.value?.name||"?").charAt(0).toUpperCase());async function K(){try{const s=await fetch(`/pub/chat/${c}/info`);if(!s.ok){b.value=!0;return}const a=await s.json();if(l.value=a,a.title&&(document.title=a.title),$.value=a.hasPassword,!a.hasPassword)d.value=!0;else{const t=sessionStorage.getItem(`chat-pw-${c}`);t?(f.value=t,d.value=!0):d.value=!1}b.value=!0}catch{b.value=!0}}async function P(){if(!p.value)return;const s=p.value;try{if((await fetch(`/pub/chat/${c}/info`,{headers:{"X-Chat-Password":s}})).status===401){k.value=!0;return}}catch{}f.value=s,sessionStorage.setItem(`chat-pw-${c}`,s),d.value=!0,k.value=!1}async function R(){const s=g.value.trim();!s||v.value||(g.value="",z(()=>E()),h.value.push({role:"user",content:s}),await T(),await O(s))}async function O(s){v.value=!0,i.value="";const a={"Content-Type":"application/json"};f.value&&(a["X-Chat-Password"]=f.value);try{const t=await fetch(`/pub/chat/${c}/stream`,{method:"POST",headers:a,body:JSON.stringify({message:s})});if(t.status===401){f.value="",sessionStorage.removeItem(`chat-pw-${c}`),d.value=!1,k.value=!0,v.value=!1,i.value="",h.value.pop();return}if(!t.ok||!t.body)throw new Error("Request failed");const F=t.body.getReader(),j=new TextDecoder;let M="";for(;;){const{done:D,value:U}=await F.read();if(D)break;M+=j.decode(U,{stream:!0});const H=M.split(`

`);M=H.pop()??"";for(const I of H){const L=I.startsWith("data: ")?I.slice(6):I;if(L.trim())try{const _=JSON.parse(L);if(_.type==="text_delta")i.value+=_.text,await T();else{if(_.type==="done")break;_.type==="error"&&(i.value+=`
[错误: ${_.text}]`)}}catch{}}}}catch{i.value+=`
[连接错误，请重试]`}finally{i.value&&h.value.push({role:"assistant",content:i.value}),v.value=!1,i.value="",await T()}}async function T(){await z(),x.value&&(x.value.scrollTop=x.value.scrollHeight)}function E(){m.value&&(m.value.style.height="auto",m.value.style.height=Math.min(m.value.scrollHeight,140)+"px")}function S(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}return A(K),(s,a)=>(r(),n("div",ee,[$.value&&!d.value?(r(),n("div",ae,[e("div",te,[e("div",{class:"gate-avatar",style:y({background:l.value?.avatarColor||"#409EFF"})},u(w.value),5),e("h2",se,u(l.value?.name||"..."),1),a[2]||(a[2]=e("p",{class:"gate-hint"},"此对话已设置访问密码",-1)),V(e("input",{"onUpdate:modelValue":a[0]||(a[0]=t=>p.value=t),type:"password",placeholder:"请输入密码",class:"gate-input",onKeydown:N(P,["enter"])},null,544),[[B,p.value]]),k.value?(r(),n("div",oe,"密码错误，请重试")):C("",!0),e("button",{class:"gate-btn",onClick:P,disabled:!p.value},"进入对话",8,le)])])):b.value?(r(),n("div",ne,[e("div",re,[e("div",ie,[e("div",{class:"header-avatar",style:y({background:l.value?.avatarColor||"#409EFF"})},u(w.value),5),e("div",ue,[e("div",ce,u(l.value?.name),1),a[3]||(a[3]=e("div",{class:"header-subtitle"},"AI 助手 · ZyHive",-1))])])]),e("div",{class:"messages-area",ref_key:"messagesRef",ref:x},[h.value.length?C("",!0):(r(),n("div",de,[e("div",{class:"welcome-avatar",style:y({background:l.value?.avatarColor||"#409EFF"})},u(w.value),5),e("div",ve,u(l.value?.welcomeMsg||`你好！我是 ${l.value?.name}，有什么可以帮你的？`),1)])),(r(!0),n(J,null,X(h.value,(t,F)=>(r(),n("div",{key:F,class:Q(["msg-row",t.role])},[t.role==="assistant"?(r(),n("div",{key:0,class:"msg-avatar",style:y({background:l.value?.avatarColor||"#409EFF"})},u(w.value),5)):C("",!0),e("div",{class:"msg-bubble",innerHTML:S(t.content)},null,8,pe)],2))),128)),v.value?(r(),n("div",fe,[e("div",{class:"msg-avatar",style:y({background:l.value?.avatarColor||"#409EFF"})},u(w.value),5),e("div",he,[e("span",{innerHTML:S(i.value)},null,8,ge),a[4]||(a[4]=e("span",{class:"cursor"},"▋",-1))])])):C("",!0)],512),e("div",me,[V(e("textarea",{"onUpdate:modelValue":a[1]||(a[1]=t=>g.value=t),class:"input-box",placeholder:"输入消息…",rows:"1",onKeydown:N(W(R,["exact","prevent"]),["enter"]),onInput:E,ref_key:"inputRef",ref:m},null,40,we),[[B,g.value]]),e("button",{class:"send-btn",onClick:R,disabled:!g.value.trim()||v.value},[...a[5]||(a[5]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})],-1)])],8,_e)])])):(r(),n("div",ye,[...a[6]||(a[6]=[e("div",{class:"loading-spinner"},null,-1)])]))]))}}),Fe=Y(be,[["__scopeId","data-v-6b2e1cc0"]]);export{Fe as default};
