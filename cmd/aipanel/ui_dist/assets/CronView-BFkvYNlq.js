import{d as Z,h as ee,c as u,b as I,a as t,w as a,f as s,g as U,r as d,o as i,k as le,z as te,F as k,l as B,i as g,t as p,j as ae,x as ne,p as oe,E as f,u as se}from"./index-BT96GM_8.js";import{b as de,i as x}from"./index-B6ZRKErS.js";import{_ as ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue={class:"cron-page"},re={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},me={style:{margin:"0"}},pe={style:{"margin-bottom":"12px",display:"flex",gap:"10px","align-items":"center","flex-wrap":"wrap"}},fe={key:0,style:{"font-size":"13px",color:"#606266"}},_e={key:1,style:{color:"#c0c4cc","font-size":"12px"}},ye={style:{"font-size":"12px","font-family":"monospace"}},ce=Z({__name:"CronView",setup(ge){const F=se(),A=U([]),V=U([]),h=U(""),b=U(!1),L=ne(()=>{const o={};for(const e of V.value)o[e.id]=e.name;return o}),n=oe({agentId:"",name:"",remark:"",expr:"0 0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});ee(async()=>{const o=await de.list().catch(()=>({data:[]}));V.value=o.data||[],v()});async function v(){try{const o=await x.list(h.value||void 0);A.value=o.data||[]}catch{}}function R(o){return o?new Date(o).toLocaleString("zh-CN"):""}function S(o){return o.payload?.message==="__MEMORY_CONSOLIDATE__"}function M(o){o.agentId&&F.push({path:`/agents/${o.agentId}`,query:{tab:"cron"}})}function D(){n.agentId="",n.name="",n.remark="",n.expr="0 0 9 * * *",n.tz="Asia/Shanghai",n.message="",n.enabled=!0,b.value=!0}async function O(){try{await x.create({name:n.name,remark:n.remark||void 0,agentId:n.agentId||void 0,enabled:n.enabled,schedule:{kind:"cron",expr:n.expr,tz:n.tz},payload:{kind:"agentTurn",message:n.message},delivery:{mode:"announce"}}),f.success("创建成功"),b.value=!1,v()}catch(o){f.error(o.response?.data?.error||"创建失败")}}async function Y(o){try{await x.update(o.id,o)}catch{f.error("更新失败")}}async function j(o){try{await x.run(o.id),f.success("已触发"),setTimeout(v,2e3)}catch{f.error("触发失败")}}async function J(o){try{await x.delete(o.id),f.success("已删除"),v()}catch{f.error("删除失败")}}return(o,e)=>{const q=d("Timer"),T=d("el-icon"),_=d("el-button"),y=d("el-text"),N=d("el-radio-button"),G=d("el-radio-group"),r=d("el-table-column"),C=d("el-tag"),$=d("el-switch"),H=d("el-table"),K=d("el-empty"),P=d("el-card"),z=d("el-option"),E=d("el-select"),Q=d("InfoFilled"),m=d("el-form-item"),w=d("el-input"),W=d("el-form"),X=d("el-dialog");return i(),u("div",ue,[I("div",re,[I("h2",me,[t(T,{style:{"vertical-align":"-2px","margin-right":"6px"}},{default:a(()=>[t(q)]),_:1}),e[10]||(e[10]=s("定时任务",-1))]),t(_,{type:"primary",onClick:D},{default:a(()=>[t(T,null,{default:a(()=>[t(le(te))]),_:1}),e[11]||(e[11]=s(" 新建任务 ",-1))]),_:1})]),I("div",pe,[t(y,{type:"info",size:"small",style:{"margin-right":"2px"}},{default:a(()=>[...e[12]||(e[12]=[s("筛选成员：",-1)])]),_:1}),t(G,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=l=>h.value=l),size:"small",onChange:v},{default:a(()=>[t(N,{value:""},{default:a(()=>[...e[13]||(e[13]=[s("全部",-1)])]),_:1}),t(N,{value:"__global__"},{default:a(()=>[...e[14]||(e[14]=[s("全局任务",-1)])]),_:1}),(i(!0),u(k,null,B(V.value,l=>(i(),g(N,{key:l.id,value:l.id},{default:a(()=>[s(p(l.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),t(P,{shadow:"hover"},{default:a(()=>[t(H,{data:A.value,stripe:""},{default:a(()=>[t(r,{prop:"name",label:"名称","min-width":"150"}),t(r,{label:"所属成员",width:"120"},{default:a(({row:l})=>[l.agentId?(i(),g(C,{key:0,size:"small",type:"primary",style:{cursor:"pointer"},onClick:c=>M(l)},{default:a(()=>[s(p(L.value[l.agentId]||l.agentId),1)]),_:2},1032,["onClick"])):(i(),g(C,{key:1,size:"small",type:"info"},{default:a(()=>[...e[15]||(e[15]=[s("全局",-1)])]),_:1}))]),_:1}),t(r,{label:"备注","min-width":"150","show-overflow-tooltip":""},{default:a(({row:l})=>[l.remark?(i(),u("span",fe,p(l.remark),1)):(i(),u("span",_e,"—"))]),_:1}),t(r,{label:"调度","min-width":"160"},{default:a(({row:l})=>[I("span",ye,p(l.schedule?.expr),1),t(y,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:a(()=>[s("("+p(l.schedule?.tz)+")",1)]),_:2},1024)]),_:1}),t(r,{label:"最近运行",width:"170"},{default:a(({row:l})=>[l.state?.lastRunAtMs?(i(),u(k,{key:0},[t(C,{type:l.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:a(()=>[s(p(l.state?.lastStatus),1)]),_:2},1032,["type"]),t(y,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:a(()=>[s(p(R(l.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(i(),g(y,{key:1,type:"info",size:"small"},{default:a(()=>[...e[16]||(e[16]=[s("未运行",-1)])]),_:1}))]),_:1}),t(r,{label:"启用",width:"70"},{default:a(({row:l})=>[t($,{modelValue:l.enabled,"onUpdate:modelValue":c=>l.enabled=c,onChange:c=>Y(l),size:"small",disabled:S(l)},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"])]),_:1}),t(r,{label:"操作",width:"190"},{default:a(({row:l})=>[S(l)?(i(),u(k,{key:0},[t(C,{type:"info",size:"small",style:{"margin-right":"6px"}},{default:a(()=>[...e[17]||(e[17]=[s("记忆管理",-1)])]),_:1}),t(_,{size:"small",onClick:c=>M(l)},{default:a(()=>[...e[18]||(e[18]=[s("查看",-1)])]),_:1},8,["onClick"])],64)):(i(),u(k,{key:1},[t(_,{size:"small",onClick:c=>j(l)},{default:a(()=>[...e[19]||(e[19]=[s("立即运行",-1)])]),_:1},8,["onClick"]),t(_,{size:"small",type:"danger",onClick:c=>J(l)},{default:a(()=>[...e[20]||(e[20]=[s("删除",-1)])]),_:1},8,["onClick"])],64))]),_:1})]),_:1},8,["data"]),A.value.length===0?(i(),g(K,{key:0,description:"暂无定时任务"})):ae("",!0)]),_:1}),t(X,{modelValue:b.value,"onUpdate:modelValue":e[9]||(e[9]=l=>b.value=l),title:"新建定时任务",width:"520px"},{footer:a(()=>[t(_,{onClick:e[8]||(e[8]=l=>b.value=!1)},{default:a(()=>[...e[23]||(e[23]=[s("取消",-1)])]),_:1}),t(_,{type:"primary",onClick:O},{default:a(()=>[...e[24]||(e[24]=[s("创建",-1)])]),_:1})]),default:a(()=>[t(W,{model:n,"label-width":"110px"},{default:a(()=>[t(m,{label:"所属成员"},{default:a(()=>[t(E,{modelValue:n.agentId,"onUpdate:modelValue":e[1]||(e[1]=l=>n.agentId=l),placeholder:"不选则为全局任务",clearable:"",style:{width:"100%"}},{default:a(()=>[(i(!0),u(k,null,B(V.value,l=>(i(),g(z,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(y,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:a(()=>[t(T,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:a(()=>[t(Q)]),_:1}),e[21]||(e[21]=s("不选则为全局任务；选择成员后该任务只在成员的「定时任务」Tab 显示 ",-1))]),_:1})]),_:1}),t(m,{label:"名称"},{default:a(()=>[t(w,{modelValue:n.name,"onUpdate:modelValue":e[2]||(e[2]=l=>n.name=l),placeholder:"任务名称"},null,8,["modelValue"])]),_:1}),t(m,{label:"备注"},{default:a(()=>[t(w,{modelValue:n.remark,"onUpdate:modelValue":e[3]||(e[3]=l=>n.remark=l),placeholder:"可选，说明这个任务的用途"},null,8,["modelValue"])]),_:1}),t(m,{label:"Cron 表达式"},{default:a(()=>[t(w,{modelValue:n.expr,"onUpdate:modelValue":e[4]||(e[4]=l=>n.expr=l),placeholder:"0 9 * * *"},null,8,["modelValue"]),t(y,{type:"info",size:"small",style:{"margin-top":"4px",display:"block"}},{default:a(()=>[...e[22]||(e[22]=[s(" 格式：秒(可选) 分 时 日 月 周。例：0 0 9 * * * = 每天09:00 ",-1)])]),_:1})]),_:1}),t(m,{label:"时区"},{default:a(()=>[t(E,{modelValue:n.tz,"onUpdate:modelValue":e[5]||(e[5]=l=>n.tz=l),style:{width:"100%"}},{default:a(()=>[t(z,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),t(z,{label:"UTC",value:"UTC"}),t(z,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),t(m,{label:"消息内容"},{default:a(()=>[t(w,{modelValue:n.message,"onUpdate:modelValue":e[6]||(e[6]=l=>n.message=l),type:"textarea",rows:3,placeholder:"发送给 Agent 的消息内容"},null,8,["modelValue"])]),_:1}),t(m,{label:"启用"},{default:a(()=>[t($,{modelValue:n.enabled,"onUpdate:modelValue":e[7]||(e[7]=l=>n.enabled=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),xe=ie(ce,[["__scopeId","data-v-bffe9374"]]);export{xe as default};
