import{d as ke,g as _,h as be,c as o,n as xe,q as Ce,b as s,j as f,t as m,F as $,l as M,a as y,w as D,f as K,m as we,e as U,N as Q,B as $e,x as Se,O,r as A,o as n,i as X}from"./index-Ccgss3FR.js";import{n as Te,j as Ie}from"./index-sb85_xT4.js";import{_ as Me}from"./_plugin-vue_export-helper-DlAUqK2U.js";const De={key:0,class:"history-loading"},Ae={key:1,class:"chat-empty"},Ne={key:0,class:"welcome-msg"},Fe={key:1,class:"examples"},Le=["onClick"],Oe={key:0,class:"msg-row user"},Be={class:"msg-bubble user"},Je={key:0,class:"msg-images"},Re=["src","onClick"],Ee={class:"msg-text"},je={key:1,class:"msg-row assistant"},Pe={class:"msg-col"},He=["open"],Ve={class:"thinking-summary"},Ke={class:"thinking-len"},Ue={class:"thinking-content"},ze={class:"msg-bubble assistant"},We={class:"tool-details"},Ye={class:"tool-summary"},qe={class:"tool-name"},Ge={key:0,class:"tool-status running"},Qe={key:1,class:"tool-status done"},Xe={key:2,class:"tool-status error"},Ze={class:"tool-body"},et={key:0,class:"tool-section"},tt={class:"tool-pre"},st={key:1,class:"tool-section"},nt={class:"tool-pre result"},ot=["innerHTML"],lt={key:1,class:"apply-card"},at={class:"apply-preview"},it={class:"apply-key"},ct={class:"apply-val"},rt=["onClick"],ut={class:"msg-actions"},dt=["onClick","title"],pt=["onClick"],ht=["onClick"],ft={key:1,class:"option-chips"},vt=["onClick"],mt={key:2,class:"msg-row system"},gt={class:"msg-system"},_t={key:2,class:"msg-row assistant"},yt={class:"msg-col"},kt={key:0,class:"thinking-block",open:""},bt={class:"thinking-summary"},xt={class:"thinking-content"},Ct={class:"msg-bubble assistant"},wt={key:0,class:"typing-dots"},$t=["innerHTML"],St={key:2,class:"blink"},Tt=["src"],It={class:"chat-input-area"},Mt={key:0,class:"attachments-bar"},Dt=["src"],At=["onClick"],Nt={class:"input-row"},Ft={class:"textarea-wrap"},Lt=["placeholder","disabled","onKeydown"],Ot={class:"input-actions"},Bt={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},Jt=["disabled"],Rt={key:0,class:"spinner"},Et={key:1},jt=ke({__name:"AiChat",props:{agentId:{},sessionId:{},context:{},scenario:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply","session-change"],setup(k,{expose:Z,emit:ee}){const g=k,B=ee,p=_(g.initialMessages?[...g.initialMessages]:[]),N=_(""),S=_([]),T=_(!1),b=_(""),F=_(""),J=_(null),R=_(""),I=_(g.sessionId),L=_(!1),E=_(),C=_(),te=Se(()=>({height:g.height??"100%","--bg":g.bgColor??"transparent"}));function x(){O(()=>{E.value&&(E.value.scrollTop=E.value.scrollHeight)})}function se(){C.value&&(C.value.style.height="auto",C.value.style.height=Math.min(C.value.scrollHeight,160)+"px")}function j(t){N.value=t,O(()=>C.value?.focus())}function ne(t){try{return JSON.stringify(JSON.parse(t),null,2)}catch{return t}}function oe(t){navigator.clipboard?.writeText(t);const e=p.value.findIndex(a=>a.text===t);J.value=e,setTimeout(()=>{J.value=null},1500)}function le(t){for(let e=t-1;e>=0;e--){const a=p.value[e];if(a&&a.role==="user"){const l=a.text,h=a.images??[];p.value.splice(e,p.value.length-e),G(l,h);return}}}function ae(t){R.value=t}function W(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(a,l,h)=>`<pre class="code-block${l?" lang-"+l:""}"><code>${h}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function ie(t){const e=t.split(`
`),a=[],l=/^([ğŸ™ğŸ˜„ğŸŒğŸ›ğŸ“šğŸ¨ğŸ’¼ğŸ¤–âš½ğŸ¯âœ…âŒğŸ”¥ğŸ’¡ğŸğŸš€ğŸŒŸğŸ’ğŸªğŸ­ğŸ¬ğŸ¤]|[\u{1F300}-\u{1FFFF}]|[\u{2600}-\u{27BF}])\s+(.{4,40})/u;for(const h of e){const c=h.replace(/^[-*â€¢]\s*/,"").trim();if(c.match(l)){const d=c.replace(/[ï¼š:ã€‚ï¼Œ,]$/,"").trim();d.length>=5&&a.push(d)}}return a.slice(0,5)}function ce(t){return t?/\{[\s\S]{30,}\}/.test(t)&&(t.includes('"name"')||t.includes('"identity"')||t.includes('"soul"')||t.includes('"IDENTITY"')||t.includes('"SOUL"')):!1}function re(t){const e=Y(t.text);console.log("[AiChat] manualApply result:",e),e?(t.applyData=e,O(()=>B("apply",e))):alert("æœªèƒ½ä»æ¶ˆæ¯ä¸­æå–åˆ°é…ç½® JSONï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶")}function Y(t){const e=t.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(e?.[1]){const l=P(e[1]);if(l)return l;const h=q(e[1]),c=P(h);if(c)return c}const a=[...t.matchAll(/(\{[^{}]{20,}\})/g)];for(let l=a.length-1;l>=0;l--){const h=a[l]?.[1];if(!h)continue;const c=P(h)??P(q(h));if(c)return c}return null}function P(t){try{const e=JSON.parse(t);if(e&&typeof e=="object"&&!Array.isArray(e)){const a=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(l=>a.includes(l)))return e}}catch{}return null}function q(t){let e="",a=!1,l=!1;for(let h=0;h<t.length;h++){const c=t[h];if(l){e+=c,l=!1;continue}if(c==="\\"&&a){e+=c,l=!0;continue}if(c==='"'){a=!a,e+=c;continue}if(a&&c===`
`){e+="\\n";continue}if(a&&c==="\r"){e+="\\r";continue}e+=c}return e}function ue(t){const e=t.clipboardData?.items;if(e){for(const a of Array.from(e))if(a.type.startsWith("image/")){t.preventDefault();const l=a.getAsFile();l&&z(l)}}}function de(t){const e=t.dataTransfer?.files;if(e)for(const a of Array.from(e))a.type.startsWith("image/")&&z(a)}function pe(t){const e=t.target.files;if(e)for(const a of Array.from(e))z(a)}function z(t){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&S.value.push(e.result)},e.readAsDataURL(t)}function he(t){S.value.splice(t,1)}function H(){const t=N.value.trim(),e=[...S.value];!t&&!e.length||T.value||(N.value="",S.value=[],O(()=>{C.value&&(C.value.style.height="auto")}),B("message",t,e),G(t,e))}function G(t,e){p.value.push({role:"user",text:t,images:e.length?e:void 0}),x(),T.value=!0,b.value="",F.value="";const a={role:"assistant",text:"",toolCalls:[]};p.value.push(a);const l=p.value.length-1;let h="",c;if(I.value)c=void 0;else{const d=p.value.slice(0,-1).filter(u=>(u.role==="user"||u.role==="assistant")&&u.text).slice(-20).map(u=>({role:u.role,content:u.text}));c=d.length>0?d:void 0}const V={sessionId:I.value,context:g.context,scenario:g.scenario,images:e.length?e:void 0,history:c};Te(g.agentId,t,d=>{switch(d.type){case"thinking_delta":F.value+=d.text,x();break;case"text":case"text_delta":b.value+=d.text,x();break;case"tool_call":{const u={id:d.tool_call?.id??String(Date.now()),name:d.tool_call?.name??"tool",input:d.tool_call?.input?JSON.stringify(d.tool_call.input):void 0,status:"running"};p.value[l].toolCalls.push(u),h=u.id,x();break}case"tool_result":{const u=p.value[l].toolCalls?.find(i=>i.id===h);u&&(u.result=d.text,u.status="done"),x();break}case"done":case"error":{if(d.type==="done"&&d.sessionId){const v=!I.value;I.value=d.sessionId,v&&B("session-change",d.sessionId)}const u=p.value[l];if(u.text=b.value,u.thinking=F.value||void 0,g.applyable){const v=Y(b.value);v?(u.applyData=v,console.log("[AiChat] applyData extracted:",v)):console.log("[AiChat] no applyData found in text length:",b.value.length)}const i=ie(b.value);if(i.length>=2&&(u.options=i),d.type==="error"){u.text=`[é”™è¯¯] ${d.error}`;const v=u.toolCalls?.find(r=>r.status==="running");v&&(v.status="error")}T.value=!1,b.value="",F.value="",B("response",u.text),x();break}}},V)}function fe(){p.value=[]}function ve(t){p.value.push(t),x()}async function me(t){I.value=t,p.value=[],L.value=!0;try{const a=(await Ie.get(g.agentId,t)).data.messages??[],l=[];a.some(c=>c.isCompact||c.role==="compaction")&&l.push({role:"system",text:"æ›´æ—©çš„å†…å®¹å·²å‹ç¼©"});for(const c of a)c.role!=="compaction"&&l.push({role:c.role,text:c.text});p.value=l,x()}catch(e){e?.response?.status===404?p.value=[]:(console.error("[AiChat] resumeSession failed",e),p.value=[{role:"system",text:"å†å²åŠ è½½å¤±è´¥ï¼Œç»§ç»­å¯¹è¯ä»å¯æ¥ç»­"}])}finally{L.value=!1}}function ge(){I.value=void 0,p.value=[]}function _e(t){j(t),O(H)}return Z({clearMessages:fe,appendMessage:ve,sendText:_e,fillInput:j,messages:p,currentSessionId:I,resumeSession:me,startNewSession:ge}),be(()=>{x()}),(t,e)=>{const a=A("ChatRound"),l=A("el-icon"),h=A("Tools"),c=A("Check"),V=A("CopyDocument"),d=A("Setting"),u=A("Paperclip");return n(),o("div",{class:Ce(["ai-chat",{compact:k.compact,"has-bg":k.bgColor}]),style:xe(te.value)},[s("div",{class:"chat-messages",ref_key:"msgListRef",ref:E},[L.value?(n(),o("div",De,[...e[3]||(e[3]=[s("div",{class:"history-loading-dots"},[s("span"),s("span"),s("span")],-1),s("div",{class:"history-loading-text"},"åŠ è½½å†å²å¯¹è¯â€¦",-1)])])):f("",!0),!p.value.length&&!L.value?(n(),o("div",Ae,[k.welcomeMessage?(n(),o("div",Ne,m(k.welcomeMessage),1)):f("",!0),k.examples.length?(n(),o("div",Fe,[(n(!0),o($,null,M(k.examples,(i,v)=>(n(),o("div",{key:v,class:"example-chip",onClick:r=>j(i)},m(i),9,Le))),128))])):f("",!0)])):f("",!0),(n(!0),o($,null,M(p.value,(i,v)=>(n(),o($,{key:v},[i.role==="user"?(n(),o("div",Oe,[s("div",Be,[i.images?.length?(n(),o("div",Je,[(n(!0),o($,null,M(i.images,(r,w)=>(n(),o("img",{key:w,src:r,class:"msg-img",onClick:ye=>ae(r)},null,8,Re))),128))])):f("",!0),s("div",Ee,m(i.text),1)])])):i.role==="assistant"?(n(),o("div",je,[s("div",Pe,[i.thinking?(n(),o("details",{key:0,class:"thinking-block",open:k.showThinking},[s("summary",Ve,[y(l,{class:"thinking-icon"},{default:D(()=>[y(a)]),_:1}),e[4]||(e[4]=K(" æ€è€ƒè¿‡ç¨‹ ",-1)),s("span",Ke,m(i.thinking.length)+" å­—ç¬¦",1)]),s("pre",Ue,m(i.thinking),1)],8,He)):f("",!0),s("div",ze,[(n(!0),o($,null,M(i.toolCalls,(r,w)=>(n(),o("div",{key:w,class:"tool-call-block"},[s("details",We,[s("summary",Ye,[y(l,{class:"tool-icon"},{default:D(()=>[y(h)]),_:1}),s("span",qe,m(r.name),1),r.status==="running"?(n(),o("span",Ge,"è¿è¡Œä¸­â€¦")):r.status==="done"?(n(),o("span",Qe,"å®Œæˆ")):r.status==="error"?(n(),o("span",Xe,"å¤±è´¥")):f("",!0)]),s("div",Ze,[r.input?(n(),o("div",et,[e[5]||(e[5]=s("div",{class:"tool-label"},"è¾“å…¥",-1)),s("pre",tt,m(ne(r.input)),1)])):f("",!0),r.result?(n(),o("div",st,[e[6]||(e[6]=s("div",{class:"tool-label"},"è¾“å‡º",-1)),s("pre",nt,m(r.result.slice(0,800))+m(r.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):f("",!0)])])]))),128)),i.text?(n(),o("div",{key:0,class:"msg-text",innerHTML:W(i.text)},null,8,ot)):f("",!0),i.applyData&&g.applyable?(n(),o("div",lt,[s("div",at,[(n(!0),o($,null,M(i.applyData,(r,w)=>(n(),o("div",{key:w,class:"apply-row"},[s("span",it,m(w),1),s("span",ct,m(String(r).slice(0,60))+m(String(r).length>60?"â€¦":""),1)]))),128))]),s("button",{class:"apply-btn",onClick:r=>t.$emit("apply",i.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,rt)])):f("",!0),s("div",ut,[s("button",{class:"act-btn",onClick:r=>oe(i.text),title:J.value===v?"å·²å¤åˆ¶":"å¤åˆ¶"},[J.value===v?(n(),X(l,{key:0},{default:D(()=>[y(c)]),_:1})):(n(),X(l,{key:1},{default:D(()=>[y(V)]),_:1}))],8,dt),s("button",{class:"act-btn",onClick:r=>le(v),title:"é‡è¯•"},"â†º",8,pt),g.applyable&&!i.applyData&&ce(i.text)?(n(),o("button",{key:0,class:"act-btn apply-manual-btn",onClick:r=>re(i),title:"æ£€æµ‹åˆ°é…ç½® JSONï¼Œç‚¹å‡»åº”ç”¨"},[y(l,null,{default:D(()=>[y(d)]),_:1}),e[7]||(e[7]=K(" åº”ç”¨é…ç½® ",-1))],8,ht)):f("",!0)])]),i.options&&i.options.length?(n(),o("div",ft,[(n(!0),o($,null,M(i.options,(r,w)=>(n(),o("button",{key:w,class:"option-chip",onClick:ye=>j(r)},m(r),9,vt))),128))])):f("",!0)])])):i.role==="system"?(n(),o("div",mt,[s("div",gt,m(i.text),1)])):f("",!0)],64))),128)),T.value?(n(),o("div",_t,[s("div",yt,[F.value&&k.showThinking?(n(),o("details",kt,[s("summary",bt,[y(l,{class:"thinking-icon"},{default:D(()=>[y(a)]),_:1}),e[8]||(e[8]=K(" æ€è€ƒä¸­â€¦ ",-1))]),s("pre",xt,[K(m(F.value),1),e[9]||(e[9]=s("span",{class:"blink"},"â–Š",-1))])])):f("",!0),s("div",Ct,[b.value?(n(),o("div",{key:1,class:"msg-text",innerHTML:W(b.value)},null,8,$t)):(n(),o("div",wt,[...e[10]||(e[10]=[s("span",null,null,-1),s("span",null,null,-1),s("span",null,null,-1)])])),b.value?(n(),o("span",St,"â–Š")):f("",!0)])])])):f("",!0)],512),R.value?(n(),o("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=i=>R.value="")},[s("img",{src:R.value,class:"img-preview-full"},null,8,Tt)])):f("",!0),s("div",It,[S.value.length?(n(),o("div",Mt,[(n(!0),o($,null,M(S.value,(i,v)=>(n(),o("div",{key:v,class:"attach-thumb"},[s("img",{src:i},null,8,Dt),s("button",{class:"remove-attach",onClick:r=>he(v)},"Ã—",8,At)]))),128))])):f("",!0),s("div",Nt,[s("div",Ft,[we(s("textarea",{ref_key:"inputRef",ref:C,"onUpdate:modelValue":e[1]||(e[1]=i=>N.value=i),placeholder:k.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:T.value||L.value,rows:"1",class:"chat-textarea",onKeydown:[Q(U(H,["ctrl","prevent"]),["enter"]),Q(U(H,["meta","prevent"]),["enter"])],onPaste:ue,onInput:se,onDragover:e[2]||(e[2]=U(()=>{},["prevent"])),onDrop:U(de,["prevent"])},null,40,Lt),[[$e,N.value]])]),s("div",Ot,[s("label",Bt,[y(l,null,{default:D(()=>[y(u)]),_:1}),s("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:pe},null,32)]),s("button",{class:"send-btn",disabled:T.value||L.value||!N.value.trim()&&!S.value.length,onClick:H},[T.value?(n(),o("span",Rt)):(n(),o("span",Et,"â†‘"))],8,Jt)])]),e[11]||(e[11]=s("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6)}}}),Kt=Me(jt,[["__scopeId","data-v-543f996a"]]);export{Kt as A};
