import{d as Fe,h as Be,c as f,b as s,a,w as n,f as c,k as g,I as He,g as i,E as _,r,o as u,Q as xe,F as T,l as j,i as w,P as we,m as be,t as d,e as I,R as Ce,q as ke,n as ze,j as se,S as je,H as Pe,O as We,x as Ve,N as Ke,u as qe}from"./index-DOQftSxo.js";import{b as Oe,l as Te,j as P}from"./index-DOB2ih9P.js";import{_ as Qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ge={class:"chats-page"},Je={class:"page-header"},Xe={style:{margin:"0"}},Ye={class:"filter-bar"},Ze={style:{"font-size":"12px","font-family":"monospace",color:"#606266"}},et={style:{"font-size":"13px",color:"#909399"}},tt={style:{"font-size":"13px"}},lt={class:"filter-bar"},at={style:{display:"flex","flex-direction":"column",gap:"2px"}},nt={style:{"font-weight":"500","font-size":"14px"}},st={style:{"font-size":"12px",color:"#909399"}},ot={style:{"font-size":"13px",color:"#606266"}},it={style:{"font-size":"13px"}},dt={style:{"font-weight":"600","font-size":"16px"}},ut={style:{"font-size":"12px",color:"#909399","margin-top":"4px"}},rt={key:0,style:{"text-align":"center",padding:"40px"}},ct={key:1,class:"message-list"},pt={class:"msg-avatar"},ft={class:"msg-body"},vt={class:"msg-meta"},mt={class:"msg-role"},gt={class:"msg-time"},_t=["innerHTML"],yt={style:{flex:"1","min-width":"0"}},ht={key:0,style:{display:"flex","align-items":"center",gap:"8px"}},xt={style:{"font-weight":"600","font-size":"16px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},wt={key:1,style:{display:"flex","align-items":"center",gap:"8px"}},bt={style:{"font-size":"12px",color:"#909399","margin-top":"4px"}},Ct={key:0,style:{"text-align":"center",padding:"40px"}},kt={key:1,class:"message-list"},zt={key:0,class:"compact-marker"},Vt={style:{"font-size":"12px",color:"#606266","line-height":"1.6"}},Tt={class:"msg-avatar"},It={class:"msg-body"},$t={class:"msg-meta"},Lt={class:"msg-role"},Dt={class:"msg-time"},At=["innerHTML"],St={style:{display:"flex","justify-content":"flex-end",gap:"10px",padding:"12px 0 0"}},W=50,Mt=Fe({__name:"ChatsView",setup(Nt){const Ie=qe(),K=i([]),y=i(!1),q=i("channel");function oe(){q.value==="channel"?D():U()}const $=i([]),O=i(""),Q=i(""),L=i(""),$e=Ve(()=>{let l=$.value;if(L.value){const e=L.value.toLowerCase();l=l.filter(o=>o.channelId.toLowerCase().includes(e)||o.agentName.toLowerCase().includes(e))}return l});async function D(){y.value=!0;try{const l=await Te.globalList({agentId:O.value||void 0,channelType:Q.value||void 0});$.value=l.data||[]}catch{_.error("加载渠道对话失败")}finally{y.value=!1}}const G=i(!1),J=i(""),C=i(null),X=i([]),Y=i(!1),Z=i(0),ee=i(1);async function ie(l){C.value=l,J.value=`${l.channelType==="telegram"?"Telegram":"Web"} · ${l.channelId}`,G.value=!0,ee.value=1,await de(l,1)}async function de(l,e){Y.value=!0;try{const o=(e-1)*W,m=await Te.messages(l.agentId,l.channelId,{limit:W,offset:o});X.value=m.data.messages||[],Z.value=m.data.total}catch{_.error("加载消息失败")}finally{Y.value=!1}}async function Le(l){ee.value=l,C.value&&await de(C.value,l)}const A=i([]),te=i(0),le=i(""),S=i(""),M=i("lastAt"),k=i(!1),p=i(null),N=i([]),E=i(!1),z=i(!1),b=i(""),De=Ve(()=>{let l=A.value;if(S.value){const e=S.value.toLowerCase();l=l.filter(o=>(o.title||"").toLowerCase().includes(e)||o.id.toLowerCase().includes(e)||(o.agentName||"").toLowerCase().includes(e))}return M.value==="messageCount"?l=[...l].sort((e,o)=>o.messageCount-e.messageCount):M.value==="tokenEstimate"&&(l=[...l].sort((e,o)=>o.tokenEstimate-e.tokenEstimate)),l});async function U(){y.value=!0;try{const l=await P.list({agentId:le.value||void 0,limit:200});A.value=l.data.sessions,te.value=l.data.total}catch(l){_.error("加载失败："+(l.message||""))}finally{y.value=!1}}async function ue(l){p.value=l,k.value=!0,z.value=!1,N.value=[],E.value=!0;try{const e=await P.get(l.agentId,l.id);N.value=e.data.messages}catch(e){_.error("加载对话失败："+(e.message||""))}finally{E.value=!1}}function re(l){l&&Ie.push(`/agents/${l.agentId}?resumeSession=${l.id}`)}async function Ae(l){try{await P.delete(l.agentId,l.id),_.success("已删除"),p.value?.id===l.id&&(k.value=!1),U()}catch(e){_.error("删除失败："+(e.message||""))}}function Se(){b.value=p.value?.title||"",z.value=!0}async function ce(){if(p.value)try{await P.rename(p.value.agentId,p.value.id,b.value),p.value.title=b.value;const l=A.value.findIndex(e=>e.id===p.value.id);l>=0&&(A.value[l].title=b.value),z.value=!1,_.success("已重命名")}catch(l){_.error("保存失败："+(l.message||""))}}function Me({row:l}){return p.value?.id===l.id?"active-row":""}function V(l){return l?(typeof l=="string"?new Date(l):new Date(l)).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"—"}function pe(l){if(!l)return"—";const e=typeof l=="string"?new Date(l).getTime():l,o=Date.now()-e;return o<6e4?"刚刚":o<36e5?`${Math.floor(o/6e4)} 分钟前`:o<864e5?`${Math.floor(o/36e5)} 小时前`:o<7*864e5?`${Math.floor(o/864e5)} 天前`:V(e)}function fe(l){return l?l>=1e3?`${(l/1e3).toFixed(1)}k`:String(l):"0"}function ve(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```[\s\S]*?```/g,e=>`<pre class="code-block">${e.slice(3,-3)}</pre>`).replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>")}return Be(async()=>{const l=await Oe.list().catch(()=>({data:[]}));K.value=l.data||[],D()}),(l,e)=>{const o=r("el-icon"),m=r("el-button"),R=r("el-badge"),h=r("el-option"),F=r("el-select"),ae=r("el-input"),B=r("el-tag"),v=r("el-table-column"),H=r("el-empty"),me=r("el-table"),ne=r("el-card"),ge=r("el-tab-pane"),Ne=r("el-popconfirm"),Ee=r("el-tabs"),_e=r("el-avatar"),Ue=r("el-pagination"),ye=r("el-drawer"),Re=r("el-divider"),he=Ke("loading");return u(),f("div",Ge,[s("div",Je,[s("div",null,[s("h2",Xe,[a(o,{style:{"vertical-align":"-2px","margin-right":"6px"}},{default:n(()=>[a(g(xe))]),_:1}),e[15]||(e[15]=c("对话管理",-1))]),e[16]||(e[16]=s("div",{style:{"font-size":"13px",color:"#909399","margin-top":"4px"}}," 跨所有 AI 成员的对话记录 ",-1))]),a(m,{onClick:oe,loading:y.value,icon:g(He)},{default:n(()=>[...e[17]||(e[17]=[c("刷新",-1)])]),_:1},8,["loading","icon"])]),a(Ee,{modelValue:q.value,"onUpdate:modelValue":e[8]||(e[8]=t=>q.value=t),onTabChange:oe},{default:n(()=>[a(ge,{label:"渠道对话",name:"channel"},{label:n(()=>[e[18]||(e[18]=s("span",null,"渠道对话",-1)),a(R,{value:$.value.length,hidden:!$.value.length,type:"primary",style:{"margin-left":"6px"}},null,8,["value","hidden"])]),default:n(()=>[s("div",Ye,[a(F,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=t=>O.value=t),placeholder:"全部成员",clearable:"",style:{width:"160px"},onChange:D},{default:n(()=>[(u(!0),f(T,null,j(K.value,t=>(u(),w(h,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(F,{modelValue:Q.value,"onUpdate:modelValue":e[1]||(e[1]=t=>Q.value=t),placeholder:"全部渠道类型",clearable:"",style:{width:"160px"},onChange:D},{default:n(()=>[a(h,{label:"Telegram",value:"telegram"}),a(h,{label:"Web 聊天页",value:"web"})]),_:1},8,["modelValue"]),a(ae,{modelValue:L.value,"onUpdate:modelValue":e[2]||(e[2]=t=>L.value=t),placeholder:"搜索渠道 ID…",clearable:"",style:{width:"200px"},"prefix-icon":g(we)},null,8,["modelValue","prefix-icon"])]),a(ne,{shadow:"never",style:{"margin-top":"12px"}},{default:n(()=>[be((u(),w(me,{data:$e.value,stripe:"",onRowClick:ie},{empty:n(()=>[a(H,{description:"暂无渠道对话记录"})]),default:n(()=>[a(v,{label:"AI 成员",width:"130"},{default:n(({row:t})=>[a(B,{size:"small",type:"primary",effect:"plain"},{default:n(()=>[c(d(t.agentName),1)]),_:2},1024)]),_:1}),a(v,{label:"渠道类型",width:"110"},{default:n(({row:t})=>[a(B,{type:t.channelType==="telegram"?"success":"warning",size:"small"},{default:n(()=>[c(d(t.channelType==="telegram"?"Telegram":t.channelType==="web"?"Web":t.channelType),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"渠道 ID","min-width":"200","show-overflow-tooltip":""},{default:n(({row:t})=>[s("span",Ze,d(t.channelId),1)]),_:1}),a(v,{label:"消息数",width:"90",align:"center"},{default:n(({row:t})=>[a(R,{value:t.messageCount,type:"info"},null,8,["value"])]),_:1}),a(v,{label:"首条消息",width:"145"},{default:n(({row:t})=>[s("span",et,d(V(t.firstAt)),1)]),_:1}),a(v,{label:"最后活跃",width:"145"},{default:n(({row:t})=>[s("span",tt,d(pe(t.lastAt)),1)]),_:1}),a(v,{label:"操作",width:"80"},{default:n(({row:t})=>[a(m,{size:"small",onClick:I(x=>ie(t),["stop"])},{default:n(()=>[...e[19]||(e[19]=[c("查看",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[he,y.value]])]),_:1})]),_:1}),a(ge,{label:"面板会话",name:"session"},{label:n(()=>[e[20]||(e[20]=s("span",null,"面板会话",-1)),a(R,{value:te.value,hidden:!te.value,type:"info",style:{"margin-left":"6px"}},null,8,["value","hidden"])]),default:n(()=>[s("div",lt,[a(F,{modelValue:le.value,"onUpdate:modelValue":e[3]||(e[3]=t=>le.value=t),placeholder:"全部成员",clearable:"",style:{width:"160px"},onChange:U},{default:n(()=>[(u(!0),f(T,null,j(K.value,t=>(u(),w(h,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(ae,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=t=>S.value=t),placeholder:"搜索对话标题…",clearable:"",style:{width:"220px"},"prefix-icon":g(we)},null,8,["modelValue","prefix-icon"]),a(F,{modelValue:M.value,"onUpdate:modelValue":e[5]||(e[5]=t=>M.value=t),style:{width:"130px"},onChange:U},{default:n(()=>[a(h,{label:"最近活跃",value:"lastAt"}),a(h,{label:"消息最多",value:"messageCount"}),a(h,{label:"Token 最多",value:"tokenEstimate"})]),_:1},8,["modelValue"])]),a(ne,{shadow:"never",style:{"margin-top":"12px"}},{default:n(()=>[be((u(),w(me,{data:De.value,stripe:"","row-class-name":Me,onRowClick:ue,style:{cursor:"pointer"}},{empty:n(()=>[a(H,{description:"暂无面板会话"})]),default:n(()=>[a(v,{label:"对话标题","min-width":"220"},{default:n(({row:t})=>[s("div",at,[s("span",nt,d(t.title||"（无标题）"),1),s("span",st,"ID: "+d(t.id),1)])]),_:1}),a(v,{label:"AI 成员",width:"130"},{default:n(({row:t})=>[a(B,{size:"small",type:"primary",effect:"plain"},{default:n(()=>[c(d(t.agentName||t.agentId),1)]),_:2},1024)]),_:1}),a(v,{label:"消息数",width:"90",align:"center"},{default:n(({row:t})=>[a(R,{value:t.messageCount,type:"info"},null,8,["value"])]),_:1}),a(v,{label:"Token 用量",width:"130",align:"center"},{default:n(({row:t})=>[a(B,{type:t.tokenEstimate>6e4?"danger":t.tokenEstimate>3e4?"warning":"success",size:"small",effect:"plain"},{default:n(()=>[c(d(fe(t.tokenEstimate)),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"创建时间",width:"145"},{default:n(({row:t})=>[s("span",ot,d(V(t.createdAt)),1)]),_:1}),a(v,{label:"最后活跃",width:"145"},{default:n(({row:t})=>[s("span",it,d(pe(t.lastAt)),1)]),_:1}),a(v,{label:"操作",width:"190",onClick:e[7]||(e[7]=I(()=>{},["stop"]))},{default:n(({row:t})=>[a(m,{size:"small",onClick:I(x=>ue(t),["stop"])},{default:n(()=>[...e[21]||(e[21]=[c("查看",-1)])]),_:1},8,["onClick"]),a(m,{size:"small",type:"primary",onClick:I(x=>re(t),["stop"])},{default:n(()=>[...e[22]||(e[22]=[c("继续",-1)])]),_:1},8,["onClick"]),a(Ne,{title:"确认删除此对话？",onConfirm:x=>Ae(t),width:"200"},{reference:n(()=>[a(m,{size:"small",type:"danger",onClick:e[6]||(e[6]=I(()=>{},["stop"]))},{default:n(()=>[...e[23]||(e[23]=[c("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:1})]),_:1},8,["data"])),[[he,y.value]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ye,{modelValue:G.value,"onUpdate:modelValue":e[9]||(e[9]=t=>G.value=t),title:J.value,size:"50%",direction:"rtl"},{header:n(()=>[s("div",null,[s("div",dt,d(J.value),1),s("div",ut,d(C.value?.agentName)+" · "+d(C.value?.messageCount)+" 条消息 ",1)])]),footer:n(()=>[Z.value>W?(u(),w(Ue,{key:0,"current-page":ee.value,"page-size":W,total:Z.value,layout:"prev, pager, next",onCurrentChange:Le,small:""},null,8,["current-page","total"])):se("",!0)]),default:n(()=>[Y.value?(u(),f("div",rt,[a(o,{class:"is-loading",style:{"font-size":"32px",color:"#409eff"}},{default:n(()=>[a(g(Ce))]),_:1}),e[24]||(e[24]=s("div",{style:{"margin-top":"12px",color:"#909399"}},"加载中…",-1))])):(u(),f("div",ct,[(u(!0),f(T,null,j(X.value,(t,x)=>(u(),f("div",{key:x,class:ke(["message-item",`msg-${t.role}`])},[s("div",pt,[a(_e,{size:32,style:ze({background:t.role==="user"?"#409eff":"#67c23a"})},{default:n(()=>[c(d(t.role==="user"?"用":"AI"),1)]),_:2},1032,["style"])]),s("div",ft,[s("div",vt,[s("span",mt,d(t.role==="user"?t.sender||"用户":"AI 助手"),1),s("span",gt,d(V(new Date(t.ts).getTime())),1)]),s("div",{class:"msg-text",innerHTML:ve(t.content)},null,8,_t)])],2))),128)),X.value.length?se("",!0):(u(),w(H,{key:0,description:"暂无消息"}))]))]),_:1},8,["modelValue","title"]),a(ye,{modelValue:k.value,"onUpdate:modelValue":e[14]||(e[14]=t=>k.value=t),title:p.value?.title||"对话详情",size:"50%",direction:"rtl"},{header:n(()=>[s("div",yt,[z.value?(u(),f("div",wt,[a(ae,{modelValue:b.value,"onUpdate:modelValue":e[10]||(e[10]=t=>b.value=t),size:"small",style:{flex:"1"},onKeyup:We(ce,["enter"])},null,8,["modelValue"]),a(m,{type:"primary",size:"small",onClick:ce},{default:n(()=>[...e[25]||(e[25]=[c("保存",-1)])]),_:1}),a(m,{size:"small",onClick:e[11]||(e[11]=t=>z.value=!1)},{default:n(()=>[...e[26]||(e[26]=[c("取消",-1)])]),_:1})])):(u(),f("div",ht,[s("span",xt,d(p.value?.title||"（无标题）"),1),a(m,{icon:g(Pe),circle:"",size:"small",onClick:Se},null,8,["icon"])])),s("div",bt,d(p.value?.agentName)+" · "+d(p.value?.messageCount??0)+" 条消息 · "+d(fe(p.value?.tokenEstimate??0))+" tokens ",1)])]),footer:n(()=>[s("div",St,[a(m,{onClick:e[12]||(e[12]=t=>k.value=!1)},{default:n(()=>[...e[30]||(e[30]=[c("关闭",-1)])]),_:1}),a(m,{type:"primary",icon:g(xe),onClick:e[13]||(e[13]=t=>re(p.value)),disabled:!p.value},{default:n(()=>[...e[31]||(e[31]=[c(" 继续对话 ",-1)])]),_:1},8,["icon","disabled"])])]),default:n(()=>[E.value?(u(),f("div",Ct,[a(o,{class:"is-loading",style:{"font-size":"32px",color:"#409eff"}},{default:n(()=>[a(g(Ce))]),_:1}),e[27]||(e[27]=s("div",{style:{"margin-top":"12px",color:"#909399"}},"加载对话历史…",-1))])):(u(),f("div",kt,[(u(!0),f(T,null,j(N.value,(t,x)=>(u(),f("div",{key:x,class:ke(["message-item",`msg-${t.role}`])},[t.isCompact?(u(),f("div",zt,[a(Re,null,{default:n(()=>[a(o,null,{default:n(()=>[a(g(je))]),_:1}),e[28]||(e[28]=s("span",{style:{"margin-left":"6px","font-size":"12px",color:"#909399"}},"以上内容已压缩",-1))]),_:1}),a(ne,{class:"compact-summary",shadow:"never"},{default:n(()=>[s("div",Vt,[e[29]||(e[29]=s("strong",null,"摘要：",-1)),c(d(t.text),1)])]),_:2},1024)])):(u(),f(T,{key:1},[s("div",Tt,[a(_e,{size:32,style:ze({background:t.role==="user"?"#409eff":"#67c23a"})},{default:n(()=>[c(d(t.role==="user"?"用":"AI"),1)]),_:2},1032,["style"])]),s("div",It,[s("div",$t,[s("span",Lt,d(t.role==="user"?"用户":"AI 助手"),1),s("span",Dt,d(V(t.timestamp)),1)]),s("div",{class:"msg-text",innerHTML:ve(t.text)},null,8,At)])],64))],2))),128)),!N.value.length&&!E.value?(u(),w(H,{key:0,description:"暂无消息记录"})):se("",!0)]))]),_:1},8,["modelValue","title"])])}}}),Ft=Qe(Mt,[["__scopeId","data-v-0815c39a"]]);export{Ft as default};
