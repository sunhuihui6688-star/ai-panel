import{d as se,g as v,h as le,c as n,n as ne,s as ae,f as t,t as u,l as r,F as C,j as M,e as A,p as oe,b as L,I as E,J as ie,m as re,K as B,o as a}from"./index-BQdGW9yg.js";import{g as ce}from"./index-BF1X9mkB.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";const de={key:0,class:"chat-empty"},pe={key:0,class:"welcome-msg"},he={key:1,class:"examples"},ve=["onClick"],ge={key:0,class:"msg-row user"},me={class:"msg-bubble user"},_e={key:0,class:"msg-images"},fe=["src","onClick"],ye={class:"msg-text"},ke={key:1,class:"msg-row assistant"},be={class:"msg-col"},xe=["open"],Ce={class:"thinking-summary"},$e={class:"thinking-len"},we={class:"thinking-content"},Me={class:"msg-bubble assistant"},Te={class:"tool-details"},Se={class:"tool-summary"},De={class:"tool-name"},Ie={key:0,class:"tool-status running"},Ae={key:1,class:"tool-status done"},Le={key:2,class:"tool-status error"},Be={class:"tool-body"},Ne={key:0,class:"tool-section"},Fe={class:"tool-pre"},He={key:1,class:"tool-section"},Je={class:"tool-pre result"},Re=["innerHTML"],Ee={key:1,class:"apply-card"},Ke={class:"apply-preview"},Oe={class:"apply-key"},Ve={class:"apply-val"},je=["onClick"],ze={class:"msg-actions"},Pe=["onClick","title"],Ue=["onClick"],We={key:2,class:"msg-row system"},Ge={class:"msg-system"},qe={key:1,class:"msg-row assistant"},Qe={class:"msg-col"},Xe={key:0,class:"thinking-block",open:""},Ye={class:"thinking-content"},Ze={class:"msg-bubble assistant"},et={key:0,class:"typing-dots"},tt=["innerHTML"],st={key:2,class:"blink"},lt=["src"],nt={class:"chat-input-area"},at={key:0,class:"attachments-bar"},ot=["src"],it=["onClick"],rt={class:"input-row"},ct={class:"textarea-wrap"},ut=["placeholder","disabled","onKeydown"],dt={class:"input-actions"},pt={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},ht=["disabled"],vt={key:0,class:"spinner"},gt={key:1},mt=se({__name:"AiChat",props:{agentId:{},context:{},scenario:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply"],setup(h,{expose:K,emit:O}){const m=h,F=O,c=v(m.initialMessages?[...m.initialMessages]:[]),$=v(""),k=v([]),b=v(!1),g=v(""),w=v(""),T=v(null),S=v(""),D=v(),_=v(),V=re(()=>({height:m.height??"100%","--bg":m.bgColor??"transparent"}));function f(){B(()=>{D.value&&(D.value.scrollTop=D.value.scrollHeight)})}function j(){_.value&&(_.value.style.height="auto",_.value.style.height=Math.min(_.value.scrollHeight,160)+"px")}function H(l){$.value=l,B(()=>_.value?.focus())}function z(l){try{return JSON.stringify(JSON.parse(l),null,2)}catch{return l}}function P(l){navigator.clipboard?.writeText(l);const e=c.value.findIndex(s=>s.text===l);T.value=e,setTimeout(()=>{T.value=null},1500)}function U(l){for(let e=l-1;e>=0;e--){const s=c.value[e];if(s&&s.role==="user"){const i=s.text,o=s.images??[];c.value.splice(e,c.value.length-e),R(i,o);return}}}function W(l){S.value=l}function J(l){return l?l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(s,i,o)=>`<pre class="code-block${i?" lang-"+i:""}"><code>${o}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function G(l){const e=l.clipboardData?.items;if(e){for(const s of Array.from(e))if(s.type.startsWith("image/")){l.preventDefault();const i=s.getAsFile();i&&N(i)}}}function q(l){const e=l.dataTransfer?.files;if(e)for(const s of Array.from(e))s.type.startsWith("image/")&&N(s)}function Q(l){const e=l.target.files;if(e)for(const s of Array.from(e))N(s)}function N(l){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&k.value.push(e.result)},e.readAsDataURL(l)}function X(l){k.value.splice(l,1)}function I(){const l=$.value.trim(),e=[...k.value];!l&&!e.length||b.value||($.value="",k.value=[],B(()=>{_.value&&(_.value.style.height="auto")}),F("message",l,e),R(l,e))}function R(l,e){c.value.push({role:"user",text:l,images:e.length?e:void 0}),f(),b.value=!0,g.value="",w.value="";const s={role:"assistant",text:"",toolCalls:[]};c.value.push(s);const i=c.value.length-1;let o="";const y={context:m.context,scenario:m.scenario,images:e.length?e:void 0};ce(m.agentId,l,p=>{switch(p.type){case"thinking_delta":w.value+=p.text,f();break;case"text":case"text_delta":g.value+=p.text,f();break;case"tool_call":{const d={id:p.tool_call?.id??String(Date.now()),name:p.tool_call?.name??"tool",input:p.tool_call?.input?JSON.stringify(p.tool_call.input):void 0,status:"running"};c.value[i].toolCalls.push(d),o=d.id,f();break}case"tool_result":{const d=c.value[i].toolCalls?.find(x=>x.id===o);d&&(d.result=p.text,d.status="done"),f();break}case"done":case"error":{const d=c.value[i];if(d.text=g.value,d.thinking=w.value||void 0,m.applyable){const x=g.value.match(/```json\s*([\s\S]+?)\s*```/);if(x)try{d.applyData=JSON.parse(x[1]),d.text=g.value.replace(/```json[\s\S]+?```/,"").trim()}catch{}}if(p.type==="error"){d.text=`âŒ ${p.error}`;const x=d.toolCalls?.find(te=>te.status==="running");x&&(x.status="error")}b.value=!1,g.value="",w.value="",F("response",d.text),f();break}}},y)}function Y(){c.value=[]}function Z(l){c.value.push(l),f()}function ee(l){H(l),B(I)}return K({clearMessages:Y,appendMessage:Z,sendText:ee,messages:c}),le(()=>{f()}),(l,e)=>(a(),n("div",{class:ae(["ai-chat",{compact:h.compact,"has-bg":h.bgColor}]),style:ne(V.value)},[t("div",{class:"chat-messages",ref_key:"msgListRef",ref:D},[c.value.length?r("",!0):(a(),n("div",de,[h.welcomeMessage?(a(),n("div",pe,u(h.welcomeMessage),1)):r("",!0),h.examples.length?(a(),n("div",he,[(a(!0),n(C,null,M(h.examples,(s,i)=>(a(),n("div",{key:i,class:"example-chip",onClick:o=>H(s)},u(s),9,ve))),128))])):r("",!0)])),(a(!0),n(C,null,M(c.value,(s,i)=>(a(),n(C,{key:i},[s.role==="user"?(a(),n("div",ge,[t("div",me,[s.images?.length?(a(),n("div",_e,[(a(!0),n(C,null,M(s.images,(o,y)=>(a(),n("img",{key:y,src:o,class:"msg-img",onClick:p=>W(o)},null,8,fe))),128))])):r("",!0),t("div",ye,u(s.text),1)])])):s.role==="assistant"?(a(),n("div",ke,[t("div",be,[s.thinking?(a(),n("details",{key:0,class:"thinking-block",open:h.showThinking},[t("summary",Ce,[e[3]||(e[3]=t("span",{class:"thinking-icon"},"ğŸ’­",-1)),e[4]||(e[4]=A(" æ€è€ƒè¿‡ç¨‹ ",-1)),t("span",$e,u(s.thinking.length)+" å­—ç¬¦",1)]),t("pre",we,u(s.thinking),1)],8,xe)):r("",!0),t("div",Me,[(a(!0),n(C,null,M(s.toolCalls,(o,y)=>(a(),n("div",{key:y,class:"tool-call-block"},[t("details",Te,[t("summary",Se,[e[5]||(e[5]=t("span",{class:"tool-icon"},"ğŸ”§",-1)),t("span",De,u(o.name),1),o.status==="running"?(a(),n("span",Ie,"è¿è¡Œä¸­â€¦")):o.status==="done"?(a(),n("span",Ae,"å®Œæˆ")):o.status==="error"?(a(),n("span",Le,"å¤±è´¥")):r("",!0)]),t("div",Be,[o.input?(a(),n("div",Ne,[e[6]||(e[6]=t("div",{class:"tool-label"},"è¾“å…¥",-1)),t("pre",Fe,u(z(o.input)),1)])):r("",!0),o.result?(a(),n("div",He,[e[7]||(e[7]=t("div",{class:"tool-label"},"è¾“å‡º",-1)),t("pre",Je,u(o.result.slice(0,800))+u(o.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):r("",!0)])])]))),128)),s.text?(a(),n("div",{key:0,class:"msg-text",innerHTML:J(s.text)},null,8,Re)):r("",!0),s.applyData?(a(),n("div",Ee,[t("div",Ke,[(a(!0),n(C,null,M(s.applyData,(o,y)=>(a(),n("div",{key:y,class:"apply-row"},[t("span",Oe,u(y),1),t("span",Ve,u(String(o).slice(0,50))+u(String(o).length>50?"â€¦":""),1)]))),128))]),t("button",{class:"apply-btn",onClick:o=>l.$emit("apply",s.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,je)])):r("",!0),t("div",ze,[t("button",{class:"act-btn",onClick:o=>P(s.text),title:T.value===i?"å·²å¤åˆ¶":"å¤åˆ¶"},u(T.value===i?"âœ“":"â˜"),9,Pe),t("button",{class:"act-btn",onClick:o=>U(i),title:"é‡è¯•"},"â†º",8,Ue)])])])])):s.role==="system"?(a(),n("div",We,[t("div",Ge,u(s.text),1)])):r("",!0)],64))),128)),b.value?(a(),n("div",qe,[t("div",Qe,[w.value&&h.showThinking?(a(),n("details",Xe,[e[9]||(e[9]=t("summary",{class:"thinking-summary"},[t("span",{class:"thinking-icon"},"ğŸ’­"),A(" æ€è€ƒä¸­â€¦ ")],-1)),t("pre",Ye,[A(u(w.value),1),e[8]||(e[8]=t("span",{class:"blink"},"â–Š",-1))])])):r("",!0),t("div",Ze,[g.value?(a(),n("div",{key:1,class:"msg-text",innerHTML:J(g.value)},null,8,tt)):(a(),n("div",et,[...e[10]||(e[10]=[t("span",null,null,-1),t("span",null,null,-1),t("span",null,null,-1)])])),g.value?(a(),n("span",st,"â–Š")):r("",!0)])])])):r("",!0)],512),S.value?(a(),n("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=s=>S.value="")},[t("img",{src:S.value,class:"img-preview-full"},null,8,lt)])):r("",!0),t("div",nt,[k.value.length?(a(),n("div",at,[(a(!0),n(C,null,M(k.value,(s,i)=>(a(),n("div",{key:i,class:"attach-thumb"},[t("img",{src:s},null,8,ot),t("button",{class:"remove-attach",onClick:o=>X(i)},"Ã—",8,it)]))),128))])):r("",!0),t("div",rt,[t("div",ct,[oe(t("textarea",{ref_key:"inputRef",ref:_,"onUpdate:modelValue":e[1]||(e[1]=s=>$.value=s),placeholder:h.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:b.value,rows:"1",class:"chat-textarea",onKeydown:[E(L(I,["ctrl","prevent"]),["enter"]),E(L(I,["meta","prevent"]),["enter"])],onPaste:G,onInput:j,onDragover:e[2]||(e[2]=L(()=>{},["prevent"])),onDrop:L(q,["prevent"])},null,40,ut),[[ie,$.value]])]),t("div",dt,[t("label",pt,[e[11]||(e[11]=A(" ğŸ“ ",-1)),t("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:Q},null,32)]),t("button",{class:"send-btn",disabled:b.value||!$.value.trim()&&!k.value.length,onClick:I},[b.value?(a(),n("span",vt)):(a(),n("span",gt,"â†‘"))],8,ht)])]),e[12]||(e[12]=t("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6))}}),kt=ue(mt,[["__scopeId","data-v-2127c8c2"]]);export{kt as A};
