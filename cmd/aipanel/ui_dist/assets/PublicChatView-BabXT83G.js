import{d as q,h as A,c as n,f as e,n as m,t as u,m as B,M as N,L as S,j as b,F as J,l as W,b as X,C as Z,g as s,x as G,N as z,o as r,q as Q}from"./index-UFzGNFqv.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"pub-chat-page"},ae={key:0,class:"password-gate"},te={class:"gate-card"},se={class:"gate-name"},oe={key:0,class:"gate-error"},le=["disabled"],ne={key:1,class:"chat-page"},re={class:"chat-header"},ie={class:"chat-header-left"},ue={class:"header-info"},ce={class:"header-name"},de={key:0,class:"welcome-msg"},ve={class:"welcome-bubble"},pe=["innerHTML"],fe={key:1,class:"msg-row assistant"},he={class:"msg-bubble streaming"},ge=["innerHTML"],me={class:"input-area"},_e=["onKeydown"],ye=["disabled"],we={key:2,class:"loading-page"},be=q({__name:"PublicChatView",setup(ke){const R=Z().params.agentId,o=s(null),_=s(!1),E=s(!1),y=s(!1),d=s(""),k=s(!1),x=s(""),v=s([]),p=s(""),c=s(!1),i=s(""),w=s(),f=s(),h=G(()=>(o.value?.name||"?").charAt(0).toUpperCase());async function K(){try{const l=await fetch(`/pub/chat/${R}/info`);if(!l.ok){_.value=!0;return}const a=await l.json();o.value=a,a.title&&(document.title=a.title),E.value=a.hasPassword,y.value=!a.hasPassword,_.value=!0}catch{_.value=!0}}function L(){d.value&&(x.value=d.value,y.value=!0,k.value=!1)}async function P(){const l=p.value.trim();!l||c.value||(p.value="",z(()=>H()),v.value.push({role:"user",content:l}),await C(),await j(l))}async function j(l){c.value=!0,i.value="";const a={"Content-Type":"application/json"};x.value&&(a["X-Chat-Password"]=x.value);try{const t=await fetch(`/pub/chat/${R}/stream`,{method:"POST",headers:a,body:JSON.stringify({message:l})});if(t.status===401){y.value=!1,k.value=!0,c.value=!1,i.value="",v.value.pop();return}if(!t.ok||!t.body)throw new Error("Request failed");const T=t.body.getReader(),D=new TextDecoder;let F="";for(;;){const{done:O,value:U}=await T.read();if(O)break;F+=D.decode(U,{stream:!0});const V=F.split(`

`);F=V.pop()??"";for(const M of V){const $=M.startsWith("data: ")?M.slice(6):M;if($.trim())try{const g=JSON.parse($);if(g.type==="text_delta")i.value+=g.text,await C();else{if(g.type==="done")break;g.type==="error"&&(i.value+=`
[错误: ${g.text}]`)}}catch{}}}}catch{i.value+=`
[连接错误，请重试]`}finally{i.value&&v.value.push({role:"assistant",content:i.value}),c.value=!1,i.value="",await C()}}async function C(){await z(),w.value&&(w.value.scrollTop=w.value.scrollHeight)}function H(){f.value&&(f.value.style.height="auto",f.value.style.height=Math.min(f.value.scrollHeight,140)+"px")}function I(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\n/g,"<br>")}return A(K),(l,a)=>(r(),n("div",ee,[E.value&&!y.value?(r(),n("div",ae,[e("div",te,[e("div",{class:"gate-avatar",style:m({background:o.value?.avatarColor||"#409EFF"})},u(h.value),5),e("h2",se,u(o.value?.name||"..."),1),a[2]||(a[2]=e("p",{class:"gate-hint"},"此对话已设置访问密码",-1)),B(e("input",{"onUpdate:modelValue":a[0]||(a[0]=t=>d.value=t),type:"password",placeholder:"请输入密码",class:"gate-input",onKeydown:S(L,["enter"])},null,544),[[N,d.value]]),k.value?(r(),n("div",oe,"密码错误，请重试")):b("",!0),e("button",{class:"gate-btn",onClick:L,disabled:!d.value},"进入对话",8,le)])])):_.value?(r(),n("div",ne,[e("div",re,[e("div",ie,[e("div",{class:"header-avatar",style:m({background:o.value?.avatarColor||"#409EFF"})},u(h.value),5),e("div",ue,[e("div",ce,u(o.value?.name),1),a[3]||(a[3]=e("div",{class:"header-subtitle"},"AI 助手 · ZyHive",-1))])])]),e("div",{class:"messages-area",ref_key:"messagesRef",ref:w},[v.value.length?b("",!0):(r(),n("div",de,[e("div",{class:"welcome-avatar",style:m({background:o.value?.avatarColor||"#409EFF"})},u(h.value),5),e("div",ve,u(o.value?.welcomeMsg||`你好！我是 ${o.value?.name}，有什么可以帮你的？`),1)])),(r(!0),n(J,null,W(v.value,(t,T)=>(r(),n("div",{key:T,class:Q(["msg-row",t.role])},[t.role==="assistant"?(r(),n("div",{key:0,class:"msg-avatar",style:m({background:o.value?.avatarColor||"#409EFF"})},u(h.value),5)):b("",!0),e("div",{class:"msg-bubble",innerHTML:I(t.content)},null,8,pe)],2))),128)),c.value?(r(),n("div",fe,[e("div",{class:"msg-avatar",style:m({background:o.value?.avatarColor||"#409EFF"})},u(h.value),5),e("div",he,[e("span",{innerHTML:I(i.value)},null,8,ge),a[4]||(a[4]=e("span",{class:"cursor"},"▋",-1))])])):b("",!0)],512),e("div",me,[B(e("textarea",{"onUpdate:modelValue":a[1]||(a[1]=t=>p.value=t),class:"input-box",placeholder:"输入消息…",rows:"1",onKeydown:S(X(P,["exact","prevent"]),["enter"]),onInput:H,ref_key:"inputRef",ref:f},null,40,_e),[[N,p.value]]),e("button",{class:"send-btn",onClick:P,disabled:!p.value.trim()||c.value},[...a[5]||(a[5]=[e("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})],-1)])],8,ye)])])):(r(),n("div",we,[...a[6]||(a[6]=[e("div",{class:"loading-spinner"},null,-1)])]))]))}}),Fe=Y(be,[["__scopeId","data-v-659cebda"]]);export{Fe as default};
