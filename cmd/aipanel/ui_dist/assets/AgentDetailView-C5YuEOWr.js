import{d as it,D as xl,i as ut,o,c,b as s,a as e,w as t,k as C,F as D,m as O,s as sl,t as v,j as x,h as i,f as dt,n as nl,p as Me,G as lt,v as Wt,l as L,e as d,z as hl,E as g,H as tt,r as y,I as Ot,A as Yt,B as bl,J as Jt,K as wl,L as at,M as nt,N as qt,x as Ht,O as Gt}from"./index-ds8ggqbD.js";import{g as ll,f as X,b as Rl,h as tl,i as al,j as Qt,e as kl,r as st,k as Q,l as ot}from"./index-CDWofbfP.js";import{A as rt}from"./AiChat-CxXisNCd.js";import{_ as vt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Xt={class:"skill-studio"},Zt={class:"studio-sidebar"},ea={class:"sidebar-top"},la={class:"sidebar-acts"},ta={class:"skill-list"},aa={key:0,class:"list-empty"},na=["onClick"],sa={class:"sk-icon"},oa={key:0},ia={class:"sk-info"},ua={class:"sk-name"},da={class:"sk-id"},ra={class:"sk-right"},va={key:0,class:"sk-streaming-dot",title:"AI 生成中…"},fa={class:"studio-editor"},ma={key:0,class:"editor-empty"},ca={class:"editor-toolbar"},pa={class:"editor-breadcrumb"},ya={class:"crumb-name"},ga={class:"toolbar-acts"},_a={class:"editor-body"},ba={class:"file-tree"},wa={class:"tree-title"},ka={class:"tree-item tree-dir"},xa=["onClick"],ha={key:0,class:"tree-empty"},Ca={key:0,class:"file-editor"},$a={class:"file-editor-head"},Va={style:{display:"flex","align-items":"center",gap:"10px"}},za={style:{"font-size":"12px",color:"#909399"}},Ta={class:"json-preview"},Sa={key:1,class:"file-editor"},La={class:"file-editor-head"},Ia={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},Ua={style:{"font-size":"11px",color:"#c0c4cc"}},Aa={key:2,class:"file-editor"},Da={class:"file-editor-head"},Fa={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},Na={style:{"font-size":"11px",color:"#c0c4cc"}},Ma=["placeholder"],Ba={class:"studio-chat"},Pa={class:"chat-panel-head"},Ea={key:0,style:{"margin-left":"auto","font-size":"11px",color:"#c0c4cc"}},Ra={key:0,style:{"margin-left":"6px",color:"#e6a23c"}},ja={class:"chat-wrap"},Ka=it({__name:"SkillStudio",props:{agentId:{}},setup(jl){const ne=jl,_=ne.agentId,W=d([]),se=d(!1),f=d(null),h=d("meta"),V=d({name:"",icon:"",category:"",description:"",version:"1.0.0",enabled:!0}),F=d(""),Ve=d(!1),ge=d(!1),Be=d(!1),ze=d(!1),me=d(!1),Z=d([]),ee=d(!1),Y=d(""),oe=d(!1),J=d(!1),Pe={};function ol(m,u){u?Pe[m]=u:delete Pe[m]}function Te(m){return m?Pe[m]:null}const _e=d(new Set);function Se(m,u){const I=new Set(_e.value);u?I.add(m):I.delete(m),_e.value=I}const ie=d(new Set);xl(f,async m=>{m&&(ie.value.has(m.id)||(ie.value.add(m.id),await tt(),await Te(m.id)?.resumeSession?.(`skill-studio-${m.id}`)))},{flush:"post"});const P=hl(()=>{if(!f.value)return"你是一个技能配置助手，帮助用户设计和优化 AI 技能的系统提示词。";const m=JSON.stringify({id:f.value.id,name:f.value.name,icon:f.value.icon||"",category:f.value.category||"",description:f.value.description||"",version:f.value.version||"1.0.0",enabled:f.value.enabled,source:"local",installedAt:""},null,2);return`你是一个技能配置助手，正在帮助用户配置技能（ID: ${f.value.id}）。

## ⚠️ 文件路径规则（必须遵守）
所有文件必须在 skills/${f.value.id}/ 目录下：
- ✅ skills/${f.value.id}/SKILL.md
- ✅ skills/${f.value.id}/skill.json
- ✅ skills/${f.value.id}/tools/helper.py
- ❌ 任何其他路径

## ⚠️ 创建或更新技能时，必须同时写两个文件

### 1. skills/${f.value.id}/skill.json（技能元数据）
格式如下，修改 name/icon/category/description 字段：
\`\`\`json
${m}
\`\`\`

### 2. skills/${f.value.id}/SKILL.md（系统提示词）
当前内容：
\`\`\`markdown
${F.value||"（空）"}
\`\`\`

## 你可以帮助：
- 创建/优化技能：同时写 skill.json（名称、分类、描述）和 SKILL.md（提示词）
- 在技能目录下创建工具文件（Python 等）
- 测试技能效果（直接对话即可测试）`}),Ee=hl(()=>f.value?me.value?`新技能已创建（ID: ${f.value.id}）。告诉我你想要什么功能，我来帮你生成完整的 SKILL.md 内容，生成后直接点保存即可。`:`当前编辑「${f.value.name}」。你可以让我优化 SKILL.md、测试效果，或者直接对话体验当前技能。`:"选择一个技能后，我可以帮你优化配置、写 SKILL.md、测试效果。"),Re=hl(()=>f.value?me.value?[]:[`帮我优化「${f.value.name}」的 SKILL.md`,"这个技能怎么写效果更好？","用中文回答一道历史题，测试当前技能效果"]:["帮我设计一个代码审查技能","帮我写一个翻译助手的 SKILL.md"]);async function ue(){se.value=!0;try{const m=await ll.list(_);if(W.value=m.data||[],f.value){const u=W.value.find(I=>I.id===f.value.id);u&&(f.value=u,je(u))}}catch{}finally{se.value=!1}}function je(m){V.value={name:m.name,icon:m.icon||"",category:m.category||"",description:m.description||"",version:m.version||"1.0.0",enabled:m.enabled}}async function il(m){f.value?.id!==m.id&&(f.value=m,je(m),h.value="meta",ge.value=!1,F.value="",me.value=!1,ce(),de())}async function be(){f.value&&h.value!=="prompt"&&(h.value="prompt",F.value||await de())}async function we(m,u,I){const k=await X.read(_,m),j=Array.isArray(k.data)?k.data:[],z=[];for(const te of j){if(I===0&&te.name==="skill.json")continue;const ae=u?`${u}/${te.name}`:te.name;if(z.push({name:te.name,path:ae,isDir:te.isDir,depth:I}),te.isDir){const Ie=await we(`skills/${f.value.id}/${ae}`,ae,I+1);z.push(...Ie)}}return z}async function ce(){if(f.value){ee.value=!0;try{Z.value=await we(`skills/${f.value.id}/`,"",0)}catch{Z.value=[{name:"SKILL.md",path:"SKILL.md",isDir:!1,depth:0}]}finally{ee.value=!1}}}async function Le(m,u){if(!u){if(m==="SKILL.md"){await be();return}h.value=m,oe.value=!1,await le()}}async function le(){if(!(!f.value||!h.value||h.value==="meta"||h.value==="prompt")){J.value=!0;try{const m=await X.read(_,`skills/${f.value.id}/${h.value}`);Y.value=m.data?.content||"",oe.value=!1}catch{Y.value=""}finally{J.value=!1}}}async function pe(m){if(f.value)try{await X.delete(_,`skills/${f.value.id}/${m}`),h.value===m&&(h.value="prompt"),await ce(),g.success("已删除")}catch{g.error("删除失败")}}async function Ke(){if(f.value){Be.value=!0;try{h.value==="meta"||h.value==="prompt"?(await ll.update(ne.agentId,f.value.id,{name:V.value.name,icon:V.value.icon,category:V.value.category,description:V.value.description,enabled:V.value.enabled}),(h.value==="prompt"||F.value)&&(await X.write(_,`skills/${f.value.id}/SKILL.md`,F.value),ge.value=!1),await ue()):(await X.write(_,`skills/${f.value.id}/${h.value}`,Y.value),oe.value=!1),g.success("保存成功")}catch(m){g.error(m.response?.data?.error||"保存失败")}finally{Be.value=!1}}}async function We(m,u){try{await ll.update(ne.agentId,m.id,{enabled:u}),await ue()}catch{g.error("操作失败")}}async function ke(){if(f.value)try{await ll.remove(ne.agentId,f.value.id),g.success("已删除"),f.value=null,await ue()}catch{g.error("删除失败")}}async function xe(){if(ze.value)return;ze.value=!0;const m="skill_"+Date.now().toString(36);try{await ll.create(ne.agentId,{meta:{id:m,name:"新技能",icon:"",category:"",description:"",version:"1.0.0",enabled:!1,source:"local",installedAt:""},promptContent:""}),await ue();const u=W.value.find(I=>I.id===m);if(u){await il(u),h.value="prompt",F.value="",me.value=!0,await tt(),ie.value.has(m)||(ie.value.add(m),await Te(m)?.resumeSession?.(`skill-studio-${m}`));const I=W.value.filter(k=>k.id!==m).map(k=>k.name).join("、")||"暂无";Te(m)?.sendSilent?.(`【纯文字输出，不使用任何工具，不创建任何文件】当前已有技能：${I}。请推荐3个全新的、与已有技能不重复的技能方向，每条一句话，直接列出即可。`)}}catch(u){g.error(u.response?.data?.error||"创建失败")}finally{ze.value=!1}}async function he(m,u){m===f.value?.id&&(me.value=!1),await ue(),m===f.value?.id&&(await Promise.all([ce(),de()]),h.value!=="meta"&&h.value!=="prompt"&&await le())}async function de(){if(f.value){Ve.value=!0;try{const m=await X.read(_,`skills/${f.value.id}/SKILL.md`);F.value=m.data?.content||"",ge.value=!1}catch{F.value=""}finally{Ve.value=!1}}}async function ul(){if(!f.value)return;F.value||await be();const m=`请用「${f.value.name}」技能效果回复：你好，请介绍一下你的功能。`;Te(f.value?.id)?.fillInput?.(m),g.info("测试消息已填入右侧聊天框，点击发送即可测试")}return ut(ue),(m,u)=>{const I=y("Refresh"),k=y("el-icon"),j=y("el-button"),z=y("Plus"),te=y("Tools"),ae=y("el-tag"),Ie=y("el-switch"),Cl=y("Setting"),$l=y("FolderOpened"),dl=y("VideoPlay"),Oe=y("DocumentChecked"),Ye=y("Delete"),Je=y("el-popconfirm"),qe=y("Folder"),q=y("Document"),U=y("el-input"),re=y("el-form-item"),Ue=y("el-col"),Ae=y("el-row"),Vl=y("el-collapse-item"),rl=y("el-collapse"),H=y("el-form"),He=y("ChatLineRound");return o(),c("div",Xt,[s("div",Zt,[s("div",ea,[u[13]||(u[13]=s("span",{class:"sidebar-title"},"技能库",-1)),s("div",la,[e(j,{size:"small",loading:se.value,circle:"",onClick:ue},{default:t(()=>[e(k,null,{default:t(()=>[e(I)]),_:1})]),_:1},8,["loading"]),e(j,{size:"small",type:"primary",circle:"",loading:ze.value,onClick:xe},{default:t(()=>[e(k,null,{default:t(()=>[e(z)]),_:1})]),_:1},8,["loading"])])]),s("div",ta,[!se.value&&W.value.length===0?(o(),c("div",aa,"暂无技能")):C("",!0),(o(!0),c(D,null,O(W.value,p=>(o(),c("div",{key:p.id,class:sl(["skill-item",{active:f.value?.id===p.id}]),onClick:N=>il(p)},[s("span",sa,[p.icon?(o(),c("span",oa,v(p.icon),1)):(o(),x(k,{key:1},{default:t(()=>[e(te)]),_:1}))]),s("div",ia,[s("div",ua,v(p.name),1),s("div",da,v(p.id),1)]),s("div",ra,[_e.value.has(p.id)?(o(),c("span",va)):p.category?(o(),x(ae,{key:1,size:"small",effect:"plain",style:{"margin-right":"6px","font-size":"11px"}},{default:t(()=>[i(v(p.category),1)]),_:2},1024)):C("",!0),e(Ie,{"model-value":p.enabled,size:"small",onChange:N=>We(p,N),onClick:u[0]||(u[0]=dt(()=>{},["stop"]))},null,8,["model-value","onChange"])])],10,na))),128))])]),s("div",fa,[f.value?(o(),c(D,{key:1},[s("div",ca,[s("div",pa,[e(k,{style:{color:"#909399"}},{default:t(()=>[e($l)]),_:1}),u[16]||(u[16]=s("span",{class:"crumb-sep"},"skills /",-1)),s("span",ya,v(f.value.id),1)]),s("div",ga,[e(j,{size:"small",onClick:ul},{default:t(()=>[e(k,null,{default:t(()=>[e(dl)]),_:1}),u[17]||(u[17]=i(" 测试 ",-1))]),_:1}),e(j,{size:"small",type:"primary",loading:Be.value,onClick:Ke},{default:t(()=>[e(k,null,{default:t(()=>[e(Oe)]),_:1}),u[18]||(u[18]=i(" 保存 ",-1))]),_:1},8,["loading"]),e(Je,{title:"确认删除该技能？",onConfirm:ke},{reference:t(()=>[e(j,{size:"small",type:"danger",plain:""},{default:t(()=>[e(k,null,{default:t(()=>[e(Ye)]),_:1})]),_:1})]),_:1})])]),s("div",_a,[s("div",ba,[s("div",wa,[u[19]||(u[19]=i(" 目录 ",-1)),e(j,{link:"",size:"small",loading:ee.value,onClick:ce,style:{"margin-left":"auto",padding:"0"}},{default:t(()=>[e(k,null,{default:t(()=>[e(I)]),_:1})]),_:1},8,["loading"])]),s("div",ka,[e(k,null,{default:t(()=>[e(qe)]),_:1}),s("span",null,v(f.value.id)+"/",1)]),s("div",{class:sl(["tree-item",{"tree-active":h.value==="meta"}]),onClick:u[1]||(u[1]=p=>h.value="meta")},[e(k,null,{default:t(()=>[e(q)]),_:1}),u[20]||(u[20]=s("span",null,"skill.json",-1))],2),(o(!0),c(D,null,O(Z.value,p=>(o(),c("div",{key:p.path,class:sl(["tree-item",{"tree-active":h.value===(p.path==="SKILL.md"?"prompt":p.path),"tree-dir-row":p.isDir}]),style:nl({paddingLeft:`${12+p.depth*12}px`}),onClick:N=>Le(p.path,p.isDir)},[p.isDir?(o(),x(k,{key:0,style:{color:"#e6a23c"}},{default:t(()=>[e(qe)]),_:1})):(o(),x(k,{key:1},{default:t(()=>[e(q)]),_:1})),s("span",null,v(p.name),1),p.path==="SKILL.md"&&f.value.enabled?(o(),x(ae,{key:2,size:"small",type:"success",effect:"plain",style:{"margin-left":"4px","font-size":"10px"}},{default:t(()=>[...u[21]||(u[21]=[i("注入中",-1)])]),_:1})):C("",!0)],14,xa))),128)),!ee.value&&Z.value.length===0?(o(),c("div",ha,"空目录")):C("",!0)]),h.value==="meta"?(o(),c("div",Ca,[s("div",$a,[e(k,null,{default:t(()=>[e(q)]),_:1}),u[22]||(u[22]=i(" skill.json ",-1)),u[23]||(u[23]=s("span",{class:"file-hint"},"技能元信息，影响列表展示和 runner 行为",-1))]),e(H,{model:V.value,"label-width":"72px",size:"small",style:{padding:"16px 20px"}},{default:t(()=>[e(re,{label:"技能 ID"},{default:t(()=>[e(U,{value:f.value.id,disabled:""},null,8,["value"])]),_:1}),e(Ae,{gutter:12},{default:t(()=>[e(Ue,{span:14},{default:t(()=>[e(re,{label:"名称"},{default:t(()=>[e(U,{modelValue:V.value.name,"onUpdate:modelValue":u[2]||(u[2]=p=>V.value.name=p),placeholder:"如 翻译助手"},null,8,["modelValue"])]),_:1})]),_:1}),e(Ue,{span:10},{default:t(()=>[e(re,{label:"图标"},{default:t(()=>[e(U,{modelValue:V.value.icon,"onUpdate:modelValue":u[3]||(u[3]=p=>V.value.icon=p),placeholder:"emoji"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(Ae,{gutter:12},{default:t(()=>[e(Ue,{span:14},{default:t(()=>[e(re,{label:"分类"},{default:t(()=>[e(U,{modelValue:V.value.category,"onUpdate:modelValue":u[4]||(u[4]=p=>V.value.category=p),placeholder:"如 语言"},null,8,["modelValue"])]),_:1})]),_:1}),e(Ue,{span:10},{default:t(()=>[e(re,{label:"版本"},{default:t(()=>[e(U,{modelValue:V.value.version,"onUpdate:modelValue":u[5]||(u[5]=p=>V.value.version=p),placeholder:"1.0.0"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(re,{label:"描述"},{default:t(()=>[e(U,{modelValue:V.value.description,"onUpdate:modelValue":u[6]||(u[6]=p=>V.value.description=p),type:"textarea",rows:2,placeholder:"简要描述技能功能"},null,8,["modelValue"])]),_:1}),e(re,{label:"状态"},{default:t(()=>[s("div",Va,[e(Ie,{modelValue:V.value.enabled,"onUpdate:modelValue":u[7]||(u[7]=p=>V.value.enabled=p)},null,8,["modelValue"]),s("span",za,v(V.value.enabled?"已启用，SKILL.md 将注入系统提示":"已禁用"),1)])]),_:1}),e(rl,{style:{"margin-top":"8px"}},{default:t(()=>[e(Vl,{title:"查看 skill.json 原文"},{default:t(()=>[s("pre",Ta,v(JSON.stringify({id:f.value.id,...V.value},null,2)),1)]),_:1})]),_:1})]),_:1},8,["model"])])):h.value==="prompt"?(o(),c("div",Sa,[s("div",La,[e(k,null,{default:t(()=>[e(q)]),_:1}),u[25]||(u[25]=i(" SKILL.md ",-1)),u[26]||(u[26]=s("span",{class:"file-hint"},"注入到 AI System Prompt 的指令内容",-1)),s("div",Ia,[ge.value?(o(),x(ae,{key:0,type:"warning",size:"small"},{default:t(()=>[...u[24]||(u[24]=[i("未保存",-1)])]),_:1})):C("",!0),s("span",Ua,v(F.value.length)+" 字符",1),e(j,{size:"small",circle:"",loading:Ve.value,onClick:de,title:"重新加载"},{default:t(()=>[e(k,null,{default:t(()=>[e(I)]),_:1})]),_:1},8,["loading"])])]),Me(s("textarea",{"onUpdate:modelValue":u[8]||(u[8]=p=>F.value=p),class:"code-textarea",spellcheck:"false",placeholder:`# 技能名称

## 功能说明
描述该技能的用途…

## 行为规范
- 规范 1
- 规范 2`,onInput:u[9]||(u[9]=p=>ge.value=!0)},null,544),[[lt,F.value]])])):(o(),c("div",Aa,[s("div",Da,[e(k,null,{default:t(()=>[e(q)]),_:1}),i(" "+v(h.value)+" ",1),s("div",Fa,[oe.value?(o(),x(ae,{key:0,type:"warning",size:"small"},{default:t(()=>[...u[27]||(u[27]=[i("未保存",-1)])]),_:1})):C("",!0),s("span",Na,v(Y.value.length)+" 字符",1),e(j,{size:"small",circle:"",loading:J.value,onClick:le,title:"重新加载"},{default:t(()=>[e(k,null,{default:t(()=>[e(I)]),_:1})]),_:1},8,["loading"]),e(Je,{title:"确认删除该文件？",onConfirm:u[10]||(u[10]=p=>pe(h.value))},{reference:t(()=>[e(j,{size:"small",circle:"",type:"danger",plain:""},{default:t(()=>[e(k,null,{default:t(()=>[e(Ye)]),_:1})]),_:1})]),_:1})])]),Me(s("textarea",{"onUpdate:modelValue":u[11]||(u[11]=p=>Y.value=p),class:"code-textarea",spellcheck:"false",placeholder:`编辑 ${h.value} …`,onInput:u[12]||(u[12]=p=>oe.value=!0)},null,40,Ma),[[lt,Y.value]])]))])],64)):(o(),c("div",ma,[e(k,{size:"48",color:"#c0c4cc"},{default:t(()=>[e(Cl)]),_:1}),u[15]||(u[15]=s("p",null,"从左侧选择一个技能开始编辑",-1)),e(j,{type:"primary",onClick:xe},{default:t(()=>[e(k,null,{default:t(()=>[e(z)]),_:1}),u[14]||(u[14]=i(" 新建技能",-1))]),_:1})]))]),s("div",Ba,[s("div",Pa,[e(k,null,{default:t(()=>[e(He)]),_:1}),u[28]||(u[28]=i(" AI 协作配置 ",-1)),f.value?(o(),c("span",Ea,[i(" 当前: "+v(f.value.name)+" ",1),_e.value.size>1?(o(),c("span",Ra," ("+v(_e.value.size)+" 个并行生成中) ",1)):C("",!0)])):C("",!0)]),s("div",ja,[(o(!0),c(D,null,O(W.value,p=>Me((o(),x(rt,{key:p.id,ref_for:!0,ref:N=>ol(p.id,N),"agent-id":L(_),context:f.value?.id===p.id?P.value:"",scenario:"skill-studio","skill-id":p.id,"welcome-message":f.value?.id===p.id?Ee.value:"",examples:f.value?.id===p.id?Re.value:[],compact:"",onResponse:N=>he(p.id),onStreamingChange:N=>Se(p.id,N)},null,8,["agent-id","context","skill-id","welcome-message","examples","onResponse","onStreamingChange"])),[[Wt,f.value?.id===p.id]])),128))])])])}}}),Wa=vt(Ka,[["__scopeId","data-v-3a5bcde8"]]),Oa={class:"header-left"},Ya={class:"chat-layout"},Ja={class:"session-sidebar"},qa={class:"session-sidebar-header"},Ha={class:"session-list"},Ga=["onClick"],Qa={class:"session-item-title"},Xa={class:"session-item-meta"},Za={key:0,class:"session-empty"},en={class:"at-panel"},ln={key:0,class:"at-form"},tn={class:"chat-area"},an={style:{display:"flex","align-items":"center",gap:"8px"}},nn={style:{"font-weight":"600"}},sn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"32px 0","font-size":"14px"}},on={style:{display:"flex","align-items":"center",gap:"8px"}},un={style:{"font-size":"13px"}},dn={style:{"font-size":"13px",color:"#606266"}},rn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"40px 0"}},vn={key:1,class:"relations-list"},fn={class:"relation-info"},mn={class:"relation-name"},cn={class:"relation-tags"},pn={class:"relation-desc"},yn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},gn={style:{display:"flex",gap:"8px","margin-top":"4px"}},_n={style:{display:"flex","align-items":"center","justify-content":"space-between"}},bn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"16px 0","font-size":"13px"}},wn={style:{"font-size":"12px"}},kn={style:{"font-size":"12px",color:"#606266"}},xn={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},hn={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},Cn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},$n={style:{"margin-bottom":"16px",display:"flex","align-items":"center",gap:"8px"}},Vn={class:"conv-drawer-body"},zn={key:0,style:{"text-align":"center","margin-bottom":"12px"}},Tn={class:"conv-msg-list"},Sn={class:"conv-msg-meta"},Ln={class:"conv-msg-role"},In={key:0,class:"conv-msg-sender"},Un={class:"conv-msg-time"},An={class:"conv-msg-content"},Dn={key:0,class:"conv-msg-empty"},Fn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Nn={style:{flex:"1","overflow-y":"auto"}},Mn={style:{display:"flex","align-items":"center",gap:"5px","line-height":"1.8"}},Bn={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},Pn={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},En={class:"channel-card-header"},Rn={class:"channel-card-left"},jn={class:"channel-card-name"},Kn={key:0,class:"channel-bot-username"},Wn={class:"channel-card-actions"},On={key:0,class:"channel-card-body"},Yn={class:"channel-info-row"},Jn={class:"channel-info-value"},qn={class:"channel-info-row"},Hn={class:"channel-info-value"},Gn={key:1,class:"channel-card-body"},Qn={class:"channel-info-row"},Xn={class:"channel-info-value"},Zn={style:{opacity:"0.6","font-size":"11px","margin-left":"3px"}},es={class:"pending-section"},ls=["onClick"],ts={key:0,class:"pending-list"},as={key:0,style:{"text-align":"center",padding:"12px"}},ns={class:"pending-user-info"},ss={class:"pending-user-name"},os={key:0,class:"pending-user-username"},is={class:"pending-user-id"},us={class:"pending-user-actions"},ds={key:2,class:"pending-empty"},rs={style:{width:"100%"}},vs={style:{display:"flex",gap:"6px","align-items":"center"}},fs={key:0,style:{"margin-top":"6px",display:"flex","align-items":"center",gap:"6px",color:"#909399","font-size":"13px"}},ms={key:1,style:{"margin-top":"6px",color:"#67c23a","font-size":"13px"}},cs={key:2,style:{"margin-top":"6px",color:"#e6a23c","font-size":"13px"}},ps={key:3,style:{"margin-top":"6px",color:"#f56c6c","font-size":"13px"}},ys={key:4,style:{"margin-top":"4px"}},gs={class:"channel-url-preview"},_s={class:"channel-url-text"},bs={class:"channel-url-preview"},ws={class:"channel-url-text"},ks=50,xs=it({__name:"AgentDetailView",setup(jl){const ne=Ot(),_=ne.params.id,W=d(null),se=d("chat"),f=d(),h=d([]),V=d(!1),F=d();async function Ve(){V.value=!0;try{const n=await Qt.list({agentId:_,limit:50});h.value=n.data.sessions}catch{}finally{V.value=!1}}function ge(n){F.value=n.id,f.value?.resumeSession(n.id)}function Be(){F.value=void 0,f.value?.startNewSession()}function ze(n){F.value=n,setTimeout(Ve,500)}function me(n){if(!n)return"";const l=Date.now()-n;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分前`:l<864e5?`${Math.floor(l/36e5)}小时前`:`${Math.floor(l/864e5)}天前`}const Z=d(!1),ee=d(""),Y=d(""),oe=d(!1),J=d([]);function Pe(){Z.value=!Z.value,Z.value&&!J.value.length&&ol()}async function ol(){try{const n=await Rl.list();J.value=n.data.filter(l=>l.id!==_)}catch{J.value=[]}}function Te(n){const l=J.value.find(r=>r.id===n);l&&f.value?.fillInput(`@${l.name}: `)}async function _e(){const n=ee.value,l=Y.value.trim();if(!n||!l)return;const $=J.value.find(Ce=>Ce.id===n)?.name??n;oe.value=!0;const E={role:"user",text:`→ 转发给 ${$}：
${l}`};f.value?.appendMessage(E);try{const T=(await Rl.message(n,l,_)).data.response,ve={role:"assistant",text:`← **${$}** 回复：

${T}`};f.value?.appendMessage(ve),Y.value="",ee.value="",Z.value=!1,g.success(`${$} 已回复`)}catch(Ce){const T={role:"system",text:`[失败] 转发失败：${Ce.response?.data?.error??Ce.message??"网络错误"}`};f.value?.appendMessage(T),g.error("转发失败")}finally{oe.value=!1}}const Se=d(""),ie=d(""),P=d({enabled:!1,schedule:"daily",keepTurns:3,focusHint:"",cronJobId:""}),Ee=d(!1),Re=d(!1);async function ue(){try{const n=await kl.getConfig(_);P.value=n.data,ce()}catch{}}async function je(){Ee.value=!0;try{const n=await kl.setConfig(_,P.value);P.value=n.data,g.success(P.value.enabled?"自动记忆已开启":"自动记忆已关闭")}catch{g.error("保存失败")}finally{Ee.value=!1}}async function il(){Re.value=!0;try{await kl.consolidate(_),g.success("记忆整理已在后台启动（约需10~30秒），稍后自动刷新日志"),setTimeout(ce,1e4)}catch{g.error("整理失败")}finally{Re.value=!1}}const be=d([]),we=d(!1);async function ce(){we.value=!0;try{const n=await kl.runLog(_);be.value=n.data||[]}catch{be.value=[]}finally{we.value=!1}}const Le=d([]),le=d(""),pe=d(""),Ke=d(!1),We=d([]),ke=d(!1),xe=d(""),he=d(!1),de=d(""),ul=d([]),m=d(""),u=d(""),I=d(null),k=d([]),j=d(!1),z=d({agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""});async function te(){try{const n=await st.get(_);k.value=n.data.parsed||[]}catch{k.value=[]}}function ae(n){const l=J.value.find(r=>r.id===n);z.value.agentName=l?l.name:n}async function Ie(){if(!z.value.agentId)return;if(k.value.find(l=>l.agentId===z.value.agentId)){g.warning("该成员关系已存在，请先删除再重新添加");return}k.value.push({...z.value}),z.value={agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""},await dl()}async function Cl(n){k.value.splice(n,1),await dl()}function $l(){if(k.value.length===0)return"";const n=`| 成员ID | 成员名称 | 关系类型 | 关系程度 | 说明 |
|--------|--------|--------|--------|------|`,l=k.value.map(r=>`| ${r.agentId} | ${r.agentName} | ${r.relationType} | ${r.strength} | ${r.desc||""} |`).join(`
`);return n+`
`+l}async function dl(){j.value=!0;try{await st.put(_,$l()),g.success("关系已保存")}catch{g.error("保存失败")}finally{j.value=!1}}function Oe(n){const l=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399","#B45309","#7C3AED","#0891B2"];let r=0;for(let $=0;$<n.length;$++)r=n.charCodeAt($)+((r<<5)-r);return l[Math.abs(r)%l.length]??"#409EFF"}function Ye(n){return n==="上级"?"danger":n==="下级"?"":n==="平级协作"?"success":"info"}function Je(n){return n==="核心"?"danger":n==="常用"?"warning":"info"}const qe=d([]),q=d(!1),U=d({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function re(n){return n==="running"?"success":n==="stopped"?"danger":"info"}function Ue(n){return n==="running"?"运行中":n==="stopped"?"已停止":"空闲"}function Ae(n){return n?n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB":"0 B"}function Vl(n){return new Date(n).toLocaleString()}function rl(n){return n?new Date(n).toLocaleString():""}const H=d([]),He=d(!1),p=d(!1),N=d(""),vl=d(""),zl=d(!1),Tl=d(""),b=d({type:"telegram",name:"",enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""}),A=d({loading:!1,status:""});let Sl=null;function Ll(n){return/^\*+$/.test(n)}async function Kl(){const n=b.value.botToken;if(!(!n||Ll(n))){A.value={loading:!0,status:""};try{const r=(await Q.checkToken(_,n)).data;r.duplicate?A.value={loading:!1,status:"duplicate",usedBy:r.usedBy,usedByCh:r.usedByCh}:r.valid?(A.value={loading:!1,status:"ok",botName:r.botName},!b.value.name&&r.botName&&(b.value.name=r.botName)):A.value={loading:!1,status:"error",error:r.error||"Token 无效"}}catch{A.value={loading:!1,status:"error",error:"网络错误，请重试"}}}}xl(()=>b.value.type,n=>{N.value||(vl.value=Il(n))}),xl(()=>b.value.botToken,n=>{A.value={loading:!1,status:""},Sl&&clearTimeout(Sl),!(!n||Ll(n)||n.length<20||!n.includes(":"))&&(Sl=setTimeout(Kl,800))});function De(n,l){return l?`${window.location.origin}/chat/${n}/${l}`:`${window.location.origin}/chat/${n}`}function Wl(n){navigator.clipboard.writeText(n).then(()=>g.success("链接已复制"))}async function Fe(){He.value=!0;try{const n=await Q.list(_);H.value=n.data||[]}catch{H.value=[]}finally{He.value=!1}}function Il(n){return n+"-"+Date.now().toString(36)}function ft(){N.value="";const n=W.value?.name||"";vl.value=Il("telegram"),b.value={type:"telegram",name:n,enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""},A.value={loading:!1,status:""},p.value=!0}function mt(n){N.value=n.id,b.value={type:n.type,name:n.name,enabled:n.enabled,botToken:n.config?.botToken||"",allowedFrom:n.config?.allowedFrom||"",webPassword:"",webWelcome:n.config?.welcomeMsg||"",webTitle:n.config?.title||""},A.value={loading:!1,status:""},p.value=!0}async function ct(){if(!b.value.name||!b.value.type){g.warning("请填写名称和类型");return}if(A.value.status==="duplicate"){g.error(`Bot Token 已被成员「${A.value.usedBy}」使用，请更换`);return}zl.value=!0;try{const n={};if(b.value.type==="telegram"?(b.value.botToken&&(n.botToken=b.value.botToken),b.value.allowedFrom&&(n.allowedFrom=b.value.allowedFrom)):b.value.type==="web"&&(b.value.webPassword&&(n.password=b.value.webPassword),b.value.webWelcome&&(n.welcomeMsg=b.value.webWelcome),b.value.webTitle&&(n.title=b.value.webTitle)),N.value){const l=H.value.map(r=>r.id!==N.value?r:{...r,name:b.value.name,type:b.value.type,enabled:b.value.enabled,config:{...r.config,...n}});await Q.set(_,l)}else{const l={id:vl.value||Il(b.value.type),name:b.value.name,type:b.value.type,enabled:b.value.enabled,config:n,status:"untested"};await Q.set(_,[...H.value,l])}g.success(b.value.type==="web"?"保存成功，Web 聊天页立即生效":"保存成功，重启后新渠道生效"),p.value=!1,await Fe()}catch(n){g.error(n.response?.data?.error||"保存失败")}finally{zl.value=!1}}async function pt(){try{await Q.set(_,H.value)}catch(n){g.error(n.response?.data?.error||"保存失败"),await Fe()}}async function yt(n){const l=H.value.filter(r=>r.id!==n.id);try{await Q.set(_,l),H.value=l,g.success("已删除")}catch{g.error("删除失败")}}async function gt(n){Tl.value=n.id;try{const l=await Q.test(_,n.id);l.data.valid?g.success(l.data.botName?`测试成功 (@${l.data.botName})`:"测试成功"):g.error(l.data.error||"测试失败"),await Fe()}catch{g.error("测试请求失败")}finally{Tl.value=""}}const Ne=d({}),Ul=d({}),Ge=d(""),Al=d("");async function fl(n){Ul.value[n]=!0;try{const l=await Q.listPending(_,n);Ne.value[n]=l.data||[]}catch{Ne.value[n]=[]}finally{Ul.value[n]=!1}}function _t(n){Ge.value===n?Ge.value="":(Ge.value=n,fl(n))}async function bt(n,l){Al.value=`${n}-${l}`;try{await Q.allowUser(_,n,l),g.success(`用户 ${l} 已加入白名单`),await fl(n),await Fe()}catch{g.error("操作失败")}finally{Al.value=""}}async function wt(n,l){try{await Q.dismissUser(_,n,l),g.success("已忽略"),await fl(n)}catch{g.error("操作失败")}}async function Ol(n,l){try{await Ht.confirm(`确定将用户 ${l} 从白名单中移除？移除后该用户将无法使用此 Bot。`,"移除白名单",{confirmButtonText:"确认移除",cancelButtonText:"取消",type:"warning"})}catch{return}try{await Q.removeAllowed(_,n,l),g.success(`用户 ${l} 已从白名单移除`),await Fe()}catch{g.error("操作失败")}}ut(async()=>{try{const r=await Rl.get(_);W.value=r.data}catch{g.error("加载 Agent 失败")}kt(),te(),ol(),ue(),Yl(),ml(),Fe(),await Ve();const n=ne.query.tab;n&&(se.value=n);const l=ne.query.resumeSession;l&&(F.value=l,await new Promise($=>setTimeout($,100)),f.value?.resumeSession(l),h.value.find($=>$.id===l)||(F.value=l))});async function kt(){try{const[n,l]=await Promise.all([X.read(_,"IDENTITY.md"),X.read(_,"SOUL.md")]);Se.value=n.data?.content||"",ie.value=l.data?.content||""}catch{}Qe()}async function Dl(n,l){try{await X.write(_,n,l),g.success(`${n} 已保存`)}catch{g.error(`保存 ${n} 失败`)}}async function Qe(){try{const n=await tl.tree(_);Le.value=n.data||[]}catch{Le.value=[]}}async function xt(n){if(!n.isDir){le.value=n.path,We.value=n.path.split("/");try{const l=await tl.readFile(_,n.path);pe.value=l.data?.content||""}catch{pe.value="(无法读取)"}}}async function ht(){if(le.value){Ke.value=!0;try{await tl.writeFile(_,le.value,pe.value),g.success("记忆文件已保存"),Qe()}catch{g.error("保存失败")}finally{Ke.value=!1}}}async function Ct(){const n=xe.value.trim();if(!n){g.warning("请输入路径");return}try{await tl.writeFile(_,n,`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`),g.success("文件已创建"),ke.value=!1,xe.value="",Qe(),le.value=n,We.value=n.split("/"),pe.value=`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`}catch{g.error("创建失败")}}async function $t(){const n=de.value.trim();if(!n){g.warning("请输入内容");return}try{await tl.dailyLog(_,n),g.success("日志已添加"),he.value=!1,de.value="",Qe()}catch{g.error("添加失败")}}async function Yl(){try{const n=await X.readTree(_);Array.isArray(n.data)&&(ul.value=n.data)}catch{}}async function Vt(n){if(!n.isDir){m.value=n.path||n.name,I.value=n;try{const l=await X.read(_,m.value);u.value=l.data?.content||""}catch{u.value="(无法读取)"}}}async function zt(){m.value&&await Dl(m.value,u.value)}async function ml(){try{const n=await al.list(_);qe.value=n.data||[]}catch{}}async function Tt(){try{await al.create({name:U.value.name,enabled:U.value.enabled,agentId:_,schedule:{kind:"cron",expr:U.value.expr,tz:U.value.tz},payload:{kind:"agentTurn",message:U.value.message},delivery:{mode:"announce"}}),g.success("任务创建成功"),q.value=!1,ml()}catch(n){g.error(n.response?.data?.error||"创建失败")}}async function St(n){try{await al.update(n.id,n)}catch{g.error("更新失败")}}async function Jl(n){try{await al.run(n.id),g.success("已触发运行"),setTimeout(ml,2e3)}catch{g.error("运行失败")}}async function Lt(n){try{await al.delete(n.id),g.success("已删除"),ml()}catch{g.error("删除失败")}}const cl=d(!1),Fl=d([]),Nl=d(!1),Ml=d(""),ye=d([]),Bl=d(0),pl=d(0),It=hl(()=>ye.value.length<Bl.value),Xe=d(!1);async function ql(){cl.value=!0;try{const n=await ot.list(_);Fl.value=n.data}catch{g.error("加载对话渠道失败")}finally{cl.value=!1}}async function Ut(n){Ml.value=n.channelId,ye.value=[],Bl.value=0,pl.value=0,Nl.value=!0,await Hl()}async function Hl(){Xe.value=!0;try{const l=(await ot.messages(_,Ml.value,{limit:ks,offset:pl.value})).data;Bl.value=l.total,pl.value===0?ye.value=l.messages:ye.value=[...l.messages,...ye.value],pl.value+=l.messages.length}catch{g.error("加载消息失败")}finally{Xe.value=!1}}async function At(){await Hl()}return xl(se,n=>{n==="convlogs"&&Fl.value.length===0&&ql()}),(n,l)=>{const r=y("el-button"),$=y("el-tag"),E=y("el-text"),Ce=y("el-header"),T=y("el-option"),ve=y("el-select"),B=y("el-input"),fe=y("el-tab-pane"),G=y("el-card"),K=y("el-col"),$e=y("el-row"),S=y("el-form-item"),Ze=y("el-form"),Gl=y("el-badge"),R=y("el-table-column"),yl=y("el-table"),el=y("el-switch"),Dt=y("el-input-number"),M=y("el-icon"),Ql=y("el-tree"),gl=y("el-empty"),Xl=y("el-breadcrumb-item"),Ft=y("el-breadcrumb"),_l=y("el-dialog"),Nt=y("el-drawer"),Mt=y("el-link"),Bt=y("CircleCheck"),Pt=y("Warning"),Et=y("CircleClose"),Zl=y("InfoFilled"),et=y("Link"),Rt=y("el-tabs"),jt=y("el-main"),Kt=y("el-container"),Pl=Gt("loading");return o(),x(Kt,{class:"agent-detail"},{default:t(()=>[e(Ce,{class:"detail-header"},{default:t(()=>[s("div",Oa,[e(r,{icon:L(Yt),onClick:l[0]||(l[0]=a=>n.$router.push("/agents")),circle:""},null,8,["icon"]),s("h2",null,v(W.value?.name||"..."),1),e($,{type:re(W.value?.status)},{default:t(()=>[i(v(Ue(W.value?.status)),1)]),_:1},8,["type"])]),e(E,{type:"info"},{default:t(()=>[i(v(W.value?.model),1)]),_:1})]),_:1}),e(jt,null,{default:t(()=>[e(Rt,{modelValue:se.value,"onUpdate:modelValue":l[45]||(l[45]=a=>se.value=a),type:"border-card"},{default:t(()=>[e(fe,{label:"对话",name:"chat"},{default:t(()=>[s("div",Ya,[s("div",Ja,[s("div",qa,[l[47]||(l[47]=s("span",{class:"sidebar-title"},"历史对话",-1)),e(r,{size:"small",type:"primary",plain:"",onClick:Be,icon:L(bl)},{default:t(()=>[...l[46]||(l[46]=[i("新建",-1)])]),_:1},8,["icon"])]),Me((o(),c("div",Ha,[(o(!0),c(D,null,O(h.value,a=>(o(),c("div",{key:a.id,class:sl(["session-item",{active:F.value===a.id}]),onClick:w=>ge(a)},[s("div",Qa,v(a.title||"新对话"),1),s("div",Xa,[s("span",null,v(me(a.lastAt)),1),e($,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[i(v(a.messageCount)+" 条 ",1)]),_:2},1024),a.tokenEstimate>6e4?(o(),x($,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[i("~"+v(Math.round(a.tokenEstimate/1e3))+"k",1)]),_:2},1024)):C("",!0)])],10,Ga))),128)),!V.value&&!h.value.length?(o(),c("div",Za," 还没有对话记录 ")):C("",!0)])),[[Pl,V.value]]),s("div",en,[e(r,{size:"small",plain:"",class:"at-toggle-btn",onClick:Pe},{default:t(()=>[...l[48]||(l[48]=[s("span",{class:"at-icon"},"@",-1),i(" 其他成员 ",-1)])]),_:1}),Z.value?(o(),c("div",ln,[e(ve,{modelValue:ee.value,"onUpdate:modelValue":l[1]||(l[1]=a=>ee.value=a),placeholder:"选择成员",size:"small",style:{width:"100%","margin-bottom":"6px"},onChange:Te},{default:t(()=>[(o(!0),c(D,null,O(J.value,a=>(o(),x(T,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e(B,{modelValue:Y.value,"onUpdate:modelValue":l[2]||(l[2]=a=>Y.value=a),type:"textarea",rows:3,placeholder:"输入要转发的消息…",size:"small",style:{"margin-bottom":"6px"}},null,8,["modelValue"]),e(r,{type:"primary",size:"small",style:{width:"100%"},loading:oe.value,disabled:!ee.value||!Y.value.trim(),onClick:_e},{default:t(()=>[...l[49]||(l[49]=[i(" 转发 ",-1)])]),_:1},8,["loading","disabled"])])):C("",!0)])]),s("div",tn,[e(rt,{ref_key:"aiChatRef",ref:f,"agent-id":L(_),scenario:"agent-detail","welcome-message":`你好！我是 **${W.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:ze},null,8,["agent-id","welcome-message"])])])]),_:1}),e(fe,{label:"身份 & 灵魂",name:"identity"},{default:t(()=>[e($e,{gutter:20},{default:t(()=>[e(K,{span:12},{default:t(()=>[e(G,{header:"IDENTITY.md"},{default:t(()=>[e(B,{modelValue:Se.value,"onUpdate:modelValue":l[3]||(l[3]=a=>Se.value=a),type:"textarea",rows:15,onBlur:l[4]||(l[4]=a=>Dl("IDENTITY.md",Se.value))},null,8,["modelValue"])]),_:1})]),_:1}),e(K,{span:12},{default:t(()=>[e(G,{header:"SOUL.md"},{default:t(()=>[e(B,{modelValue:ie.value,"onUpdate:modelValue":l[5]||(l[5]=a=>ie.value=a),type:"textarea",rows:15,onBlur:l[6]||(l[6]=a=>Dl("SOUL.md",ie.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(fe,{label:"关系",name:"relations"},{default:t(()=>[e($e,{gutter:20},{default:t(()=>[e(K,{span:14},{default:t(()=>[e(G,{style:{"margin-bottom":"16px"}},{header:t(()=>[...l[50]||(l[50]=[s("span",{style:{"font-weight":"600"}},"添加关系",-1)])]),default:t(()=>[e(Ze,{model:z.value,"label-position":"top",size:"default"},{default:t(()=>[e($e,{gutter:12},{default:t(()=>[e(K,{span:10},{default:t(()=>[e(S,{label:"关联成员"},{default:t(()=>[e(ve,{modelValue:z.value.agentId,"onUpdate:modelValue":l[7]||(l[7]=a=>z.value.agentId=a),placeholder:"选择系统成员",filterable:"",style:{width:"100%"},onChange:ae},{default:t(()=>[(o(!0),c(D,null,O(J.value,a=>(o(),x(T,{key:a.id,label:a.name,value:a.id},{default:t(()=>[s("div",an,[s("div",{style:nl([{width:"24px",height:"24px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"11px",color:"#fff","flex-shrink":"0"},{background:Oe(a.id)}])},v(a.name.charAt(0)),5),s("span",null,v(a.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(K,{span:7},{default:t(()=>[e(S,{label:"关系类型"},{default:t(()=>[e(ve,{modelValue:z.value.relationType,"onUpdate:modelValue":l[8]||(l[8]=a=>z.value.relationType=a),style:{width:"100%"}},{default:t(()=>[e(T,{label:"上级",value:"上级"}),e(T,{label:"下级",value:"下级"}),e(T,{label:"平级协作",value:"平级协作"}),e(T,{label:"支持",value:"支持"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(K,{span:7},{default:t(()=>[e(S,{label:"协作程度"},{default:t(()=>[e(ve,{modelValue:z.value.strength,"onUpdate:modelValue":l[9]||(l[9]=a=>z.value.strength=a),style:{width:"100%"}},{default:t(()=>[e(T,{label:"核心",value:"核心"}),e(T,{label:"常用",value:"常用"}),e(T,{label:"偶尔",value:"偶尔"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e($e,{gutter:12},{default:t(()=>[e(K,{span:18},{default:t(()=>[e(S,{label:"说明（选填）"},{default:t(()=>[e(B,{modelValue:z.value.desc,"onUpdate:modelValue":l[10]||(l[10]=a=>z.value.desc=a),placeholder:"简要描述这段关系..."},null,8,["modelValue"])]),_:1})]),_:1}),e(K,{span:6},{default:t(()=>[e(S,{label:" "},{default:t(()=>[e(r,{type:"primary",style:{width:"100%"},disabled:!z.value.agentId||!z.value.relationType||!z.value.strength,loading:j.value,onClick:Ie},{default:t(()=>[...l[51]||(l[51]=[i(" 添加 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(G,null,{header:t(()=>[s("span",nn,[l[52]||(l[52]=i("已有关系 ",-1)),e(Gl,{value:k.value.length,type:"info",style:{"margin-left":"4px"}},null,8,["value"])])]),default:t(()=>[k.value.length===0?(o(),c("div",sn," 暂无关系，请在上方添加 ")):(o(),x(yl,{key:1,data:k.value,size:"small",style:{width:"100%"}},{default:t(()=>[e(R,{label:"成员","min-width":"120"},{default:t(({row:a})=>[s("div",on,[s("div",{style:nl([{width:"28px",height:"28px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"12px",color:"#fff","flex-shrink":"0"},{background:Oe(a.agentId)}])},v(a.agentName.charAt(0)),5),s("span",un,v(a.agentName),1)])]),_:1}),e(R,{label:"类型",width:"100"},{default:t(({row:a})=>[e($,{type:Ye(a.relationType),size:"small"},{default:t(()=>[i(v(a.relationType),1)]),_:2},1032,["type"])]),_:1}),e(R,{label:"程度",width:"80"},{default:t(({row:a})=>[e($,{type:Je(a.strength),size:"small",effect:"plain"},{default:t(()=>[i(v(a.strength),1)]),_:2},1032,["type"])]),_:1}),e(R,{label:"说明","min-width":"120","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",dn,v(a.desc||"—"),1)]),_:1}),e(R,{label:"操作",width:"70",fixed:"right"},{default:t(({$index:a})=>[e(r,{type:"danger",link:"",size:"small",onClick:w=>Cl(a)},{default:t(()=>[...l[53]||(l[53]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})]),_:1}),e(K,{span:10},{default:t(()=>[e(G,{header:"关系预览"},{default:t(()=>[k.value.length===0?(o(),c("div",rn," 暂无关系数据 ")):(o(),c("div",vn,[(o(!0),c(D,null,O(k.value,a=>(o(),c("div",{key:a.agentId,class:"relation-card"},[s("div",{class:"relation-avatar",style:nl({background:Oe(a.agentId)})},v(a.agentName.charAt(0).toUpperCase()),5),s("div",fn,[s("div",mn,v(a.agentName),1),s("div",cn,[e($,{type:Ye(a.relationType),size:"small"},{default:t(()=>[i(v(a.relationType),1)]),_:2},1032,["type"]),e($,{type:Je(a.strength),size:"small",effect:"plain"},{default:t(()=>[i(v(a.strength),1)]),_:2},1032,["type"])]),s("div",pn,v(a.desc),1)])]))),128))]))]),_:1})]),_:1})]),_:1})]),_:1}),e(fe,{label:"记忆",name:"memory"},{default:t(()=>[e(G,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",yn,[l[54]||(l[54]=s("span",{style:{"font-weight":"600"}},"自动记忆",-1)),e(el,{modelValue:P.value.enabled,"onUpdate:modelValue":l[11]||(l[11]=a=>P.value.enabled=a),"active-text":"已开启","inactive-text":"已关闭",onChange:je},null,8,["modelValue"])])]),default:t(()=>[e(Ze,{model:P.value,"label-position":"top",size:"small",disabled:!P.value.enabled},{default:t(()=>[e($e,{gutter:16},{default:t(()=>[e(K,{span:6},{default:t(()=>[e(S,{label:"整理频率"},{default:t(()=>[e(ve,{modelValue:P.value.schedule,"onUpdate:modelValue":l[12]||(l[12]=a=>P.value.schedule=a),style:{width:"100%"}},{default:t(()=>[e(T,{label:"每小时",value:"hourly"}),e(T,{label:"每6小时",value:"every6h"}),e(T,{label:"每天",value:"daily"}),e(T,{label:"每周",value:"weekly"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(K,{span:5},{default:t(()=>[e(S,{label:"每个会话保留轮数"},{default:t(()=>[e(Dt,{modelValue:P.value.keepTurns,"onUpdate:modelValue":l[13]||(l[13]=a=>P.value.keepTurns=a),min:1,max:20,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(K,{span:13},{default:t(()=>[e(S,{label:"记录重点（留空则自动）"},{default:t(()=>[e(B,{modelValue:P.value.focusHint,"onUpdate:modelValue":l[14]||(l[14]=a=>P.value.focusHint=a),placeholder:"例如：记录数学解题步骤和用户常见错误"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s("div",gn,[e(r,{type:"primary",size:"small",loading:Ee.value,onClick:je},{default:t(()=>[...l[55]||(l[55]=[i(" 保存设置 ",-1)])]),_:1},8,["loading"]),e(r,{size:"small",loading:Re.value,onClick:il},{default:t(()=>[...l[56]||(l[56]=[i(" 立即整理 ",-1)])]),_:1},8,["loading"]),e(E,{type:"info",size:"small",style:{"align-self":"center","margin-left":"4px"}},{default:t(()=>[i(" 整理后：LLM提炼摘要写入 MEMORY.md，每个会话只保留最近 "+v(P.value.keepTurns)+" 轮对话 ",1)]),_:1})])]),_:1},8,["model","disabled"])]),_:1}),e(G,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",_n,[l[58]||(l[58]=s("span",{style:{"font-weight":"600"}},"整理日志",-1)),e(r,{size:"small",text:"",onClick:ce,loading:we.value},{default:t(()=>[...l[57]||(l[57]=[i("刷新",-1)])]),_:1},8,["loading"])])]),default:t(()=>[be.value.length===0&&!we.value?(o(),c("div",bn," 暂无运行记录，点击「立即整理」触发第一次 ")):(o(),x(yl,{key:1,data:be.value.slice(0,20),size:"small"},{default:t(()=>[e(R,{label:"时间",width:"160"},{default:t(({row:a})=>[s("span",wn,v(rl(a.timestamp)),1)]),_:1}),e(R,{label:"状态",width:"72"},{default:t(({row:a})=>[e($,{type:a.status==="ok"?"success":"danger",size:"small"},{default:t(()=>[i(v(a.status),1)]),_:2},1032,["type"])]),_:1}),e(R,{label:"结果","min-width":"200","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",kn,v(a.message||"—"),1)]),_:1})]),_:1},8,["data"]))]),_:1}),s("div",xn,[e(r,{type:"primary",size:"small",onClick:l[15]||(l[15]=a=>ke.value=!0)},{default:t(()=>[e(M,null,{default:t(()=>[e(L(bl))]),_:1}),l[59]||(l[59]=i(" 新建文件 ",-1))]),_:1}),e(r,{size:"small",onClick:l[16]||(l[16]=a=>he.value=!0)},{default:t(()=>[e(M,null,{default:t(()=>[e(L(Jt))]),_:1}),l[60]||(l[60]=i(" 添加日志 ",-1))]),_:1}),e(r,{size:"small",onClick:Qe},{default:t(()=>[e(M,null,{default:t(()=>[e(L(wl))]),_:1}),l[61]||(l[61]=i(" 刷新 ",-1))]),_:1})]),e($e,{gutter:16},{default:t(()=>[e(K,{span:7},{default:t(()=>[e(G,{header:"记忆目录",shadow:"hover"},{default:t(()=>[e(Ql,{data:Le.value,props:{label:"name",children:"children",isLeaf:a=>!a.isDir},onNodeClick:xt,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:t(({data:a})=>[s("span",hn,[a.isDir?(o(),x(M,{key:0,style:{color:"#E6A23C"}},{default:t(()=>[e(L(at))]),_:1})):(o(),x(M,{key:1,style:{color:"#409EFF"}},{default:t(()=>[e(L(nt))]),_:1})),s("span",null,v(a.name),1),!a.isDir&&a.size?(o(),x(E,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:t(()=>[i(v(Ae(a.size)),1)]),_:2},1024)):C("",!0)])]),_:1},8,["data","props"]),Le.value.length===0?(o(),x(gl,{key:0,description:"记忆树为空","image-size":40})):C("",!0)]),_:1})]),_:1}),e(K,{span:17},{default:t(()=>[e(G,{shadow:"hover"},{header:t(()=>[s("div",Cn,[e(Ft,{separator:"/"},{default:t(()=>[e(Xl,null,{default:t(()=>[...l[62]||(l[62]=[i("memory",-1)])]),_:1}),(o(!0),c(D,null,O(We.value,(a,w)=>(o(),x(Xl,{key:w},{default:t(()=>[i(v(a),1)]),_:2},1024))),128))]),_:1}),le.value?(o(),x(r,{key:0,type:"primary",size:"small",onClick:ht,loading:Ke.value},{default:t(()=>[...l[63]||(l[63]=[i("保存",-1)])]),_:1},8,["loading"])):C("",!0)])]),default:t(()=>[le.value?(o(),x(B,{key:0,modelValue:pe.value,"onUpdate:modelValue":l[17]||(l[17]=a=>pe.value=a),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(o(),x(gl,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),e(_l,{modelValue:ke.value,"onUpdate:modelValue":l[20]||(l[20]=a=>ke.value=a),title:"新建记忆文件",width:"480px"},{footer:t(()=>[e(r,{onClick:l[19]||(l[19]=a=>ke.value=!1)},{default:t(()=>[...l[65]||(l[65]=[i("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:Ct},{default:t(()=>[...l[66]||(l[66]=[i("创建",-1)])]),_:1})]),default:t(()=>[e(Ze,{"label-width":"80px"},{default:t(()=>[e(S,{label:"路径"},{default:t(()=>[e(B,{modelValue:xe.value,"onUpdate:modelValue":l[18]||(l[18]=a=>xe.value=a),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),e(E,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:t(()=>[...l[64]||(l[64]=[i("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(_l,{modelValue:he.value,"onUpdate:modelValue":l[23]||(l[23]=a=>he.value=a),title:"添加今日日志",width:"600px"},{footer:t(()=>[e(r,{onClick:l[22]||(l[22]=a=>he.value=!1)},{default:t(()=>[...l[67]||(l[67]=[i("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:$t},{default:t(()=>[...l[68]||(l[68]=[i("提交",-1)])]),_:1})]),default:t(()=>[e(B,{modelValue:de.value,"onUpdate:modelValue":l[21]||(l[21]=a=>de.value=a),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),e(fe,{label:"技能",name:"skills"},{default:t(()=>[e(Wa,{"agent-id":L(_)},null,8,["agent-id"])]),_:1}),e(fe,{label:"历史对话",name:"convlogs"},{default:t(()=>[s("div",$n,[l[69]||(l[69]=s("span",{style:{"font-weight":"600","font-size":"15px"}},"渠道对话记录",-1)),e(r,{size:"small",icon:L(wl),circle:"",onClick:ql,loading:cl.value},null,8,["icon","loading"])]),Me((o(),x(yl,{data:Fl.value,stripe:"","empty-text":"暂无对话记录"},{default:t(()=>[e(R,{label:"渠道","min-width":"200"},{default:t(({row:a})=>[s("span",null,v(a.channelType==="telegram"?"Telegram":"Web")+" "+v(a.channelId),1)]),_:1}),e(R,{label:"消息数",width:"100"},{default:t(({row:a})=>[i(v(a.messageCount)+" 条",1)]),_:1}),e(R,{label:"最后活跃",width:"180"},{default:t(({row:a})=>[i(v(a.lastAt?new Date(a.lastAt).toLocaleString("zh-CN"):"-"),1)]),_:1}),e(R,{label:"操作",width:"100"},{default:t(({row:a})=>[e(r,{size:"small",type:"primary",plain:"",onClick:w=>Ut(a)},{default:t(()=>[...l[70]||(l[70]=[i("查看",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Pl,cl.value]]),e(Nt,{modelValue:Nl.value,"onUpdate:modelValue":l[24]||(l[24]=a=>Nl.value=a),title:Ml.value+" 对话记录",direction:"rtl",size:"520px","destroy-on-close":!1},{default:t(()=>[s("div",Vn,[It.value?(o(),c("div",zn,[e(r,{size:"small",plain:"",loading:Xe.value,onClick:At},{default:t(()=>[...l[71]||(l[71]=[i("加载更多",-1)])]),_:1},8,["loading"])])):C("",!0),Me((o(),c("div",Tn,[(o(!0),c(D,null,O(ye.value,(a,w)=>(o(),c("div",{key:w,class:sl(["conv-msg-item",a.role==="user"?"conv-msg-user":"conv-msg-assistant"])},[s("div",Sn,[s("span",Ln,v(a.role==="user"?"用户":"助手"),1),a.sender?(o(),c("span",In,v(a.sender),1)):C("",!0),s("span",Un,v(a.ts?new Date(a.ts).toLocaleString("zh-CN"):""),1)]),s("div",An,v(a.content),1)],2))),128)),!Xe.value&&ye.value.length===0?(o(),c("div",Dn," 暂无消息记录 ")):C("",!0)])),[[Pl,Xe.value&&ye.value.length===0]])])]),_:1},8,["modelValue","title"])]),_:1}),e(fe,{label:"工作区",name:"workspace"},{default:t(()=>[e($e,{gutter:16},{default:t(()=>[e(K,{span:7},{default:t(()=>[e(G,{shadow:"never",style:{height:"calc(100vh - 200px)",display:"flex","flex-direction":"column"}},{header:t(()=>[s("div",Fn,[l[72]||(l[72]=s("span",null,"文件列表",-1)),e(r,{text:"",size:"small",onClick:Yl},{default:t(()=>[e(M,null,{default:t(()=>[e(L(wl))]),_:1})]),_:1})])]),default:t(()=>[s("div",Nn,[e(Ql,{data:ul.value,props:{label:"name",children:"children"},onNodeClick:Vt,"highlight-current":"","default-expand-all":"",style:{"font-size":"13px"}},{default:t(({data:a})=>[s("span",Mn,[a.isDir?(o(),x(M,{key:0,style:{color:"#e6a23c","font-size":"14px"}},{default:t(()=>[e(L(at))]),_:1})):(o(),x(M,{key:1,style:{color:"#909399","font-size":"14px"}},{default:t(()=>[e(L(nt))]),_:1})),s("span",null,v(a.name),1),a.isDir?C("",!0):(o(),x(E,{key:2,type:"info",size:"small",style:{"margin-left":"4px"}},{default:t(()=>[i(v(Ae(a.size)),1)]),_:2},1024))])]),_:1},8,["data"])])]),_:1})]),_:1}),e(K,{span:17},{default:t(()=>[e(G,{shadow:"never",header:m.value||"选择文件查看",style:{height:"calc(100vh - 200px)",display:"flex","flex-direction":"column"}},{default:t(()=>[m.value?(o(),c(D,{key:0},[e(B,{modelValue:u.value,"onUpdate:modelValue":l[25]||(l[25]=a=>u.value=a),type:"textarea",autosize:!1,style:{flex:"1","font-family":"monospace","font-size":"13px"},rows:22},null,8,["modelValue"]),s("div",Bn,[e(r,{type:"primary",onClick:zt},{default:t(()=>[...l[73]||(l[73]=[i("保存",-1)])]),_:1}),I.value?(o(),x(E,{key:0,type:"info",size:"small"},{default:t(()=>[i(v(Ae(I.value.size))+" · "+v(Vl(I.value.modTime)),1)]),_:1})):C("",!0)])],64)):(o(),x(gl,{key:1,description:"从左侧选择文件","image-size":60}))]),_:1},8,["header"])]),_:1})]),_:1})]),_:1}),e(fe,{label:"定时任务",name:"cron"},{default:t(()=>[e(r,{type:"primary",onClick:l[26]||(l[26]=a=>q.value=!0),style:{"margin-bottom":"16px"}},{default:t(()=>[e(M,null,{default:t(()=>[e(L(bl))]),_:1}),l[74]||(l[74]=i(" 新建任务 ",-1))]),_:1}),e(yl,{data:qe.value,stripe:""},{default:t(()=>[e(R,{prop:"name",label:"名称"}),e(R,{label:"调度"},{default:t(({row:a})=>[i(v(a.schedule?.expr)+" ("+v(a.schedule?.tz)+")",1)]),_:1}),e(R,{label:"最近运行",width:"180"},{default:t(({row:a})=>[a.state?.lastRunAtMs?(o(),c(D,{key:0},[e($,{type:a.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:t(()=>[i(v(a.state?.lastStatus),1)]),_:2},1032,["type"]),e(E,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:t(()=>[i(v(rl(a.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(o(),x(E,{key:1,type:"info",size:"small"},{default:t(()=>[...l[75]||(l[75]=[i("未运行",-1)])]),_:1}))]),_:1}),e(R,{label:"启用",width:"80"},{default:t(({row:a})=>[e(el,{modelValue:a.enabled,"onUpdate:modelValue":w=>a.enabled=w,onChange:w=>St(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(R,{label:"操作",width:"220"},{default:t(({row:a})=>[a.payload?.message==="__MEMORY_CONSOLIDATE__"?(o(),c(D,{key:0},[e($,{type:"info",size:"small",style:{"margin-right":"8px"}},{default:t(()=>[...l[76]||(l[76]=[i("记忆管理",-1)])]),_:1}),e(r,{size:"small",onClick:w=>Jl(a)},{default:t(()=>[...l[77]||(l[77]=[i("立即运行",-1)])]),_:1},8,["onClick"])],64)):(o(),c(D,{key:1},[e(r,{size:"small",onClick:w=>Jl(a)},{default:t(()=>[...l[78]||(l[78]=[i("立即运行",-1)])]),_:1},8,["onClick"]),e(r,{size:"small",type:"danger",onClick:w=>Lt(a)},{default:t(()=>[...l[79]||(l[79]=[i("删除",-1)])]),_:1},8,["onClick"])],64))]),_:1})]),_:1},8,["data"]),e(_l,{modelValue:q.value,"onUpdate:modelValue":l[33]||(l[33]=a=>q.value=a),title:"新建定时任务",width:"520px"},{footer:t(()=>[e(r,{onClick:l[32]||(l[32]=a=>q.value=!1)},{default:t(()=>[...l[80]||(l[80]=[i("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:Tt},{default:t(()=>[...l[81]||(l[81]=[i("创建",-1)])]),_:1})]),default:t(()=>[e(Ze,{model:U.value,"label-width":"100px"},{default:t(()=>[e(S,{label:"名称"},{default:t(()=>[e(B,{modelValue:U.value.name,"onUpdate:modelValue":l[27]||(l[27]=a=>U.value.name=a)},null,8,["modelValue"])]),_:1}),e(S,{label:"Cron 表达式"},{default:t(()=>[e(B,{modelValue:U.value.expr,"onUpdate:modelValue":l[28]||(l[28]=a=>U.value.expr=a),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),e(S,{label:"时区"},{default:t(()=>[e(ve,{modelValue:U.value.tz,"onUpdate:modelValue":l[29]||(l[29]=a=>U.value.tz=a)},{default:t(()=>[e(T,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),e(T,{label:"UTC",value:"UTC"}),e(T,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),e(S,{label:"消息"},{default:t(()=>[e(B,{modelValue:U.value.message,"onUpdate:modelValue":l[30]||(l[30]=a=>U.value.message=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),e(S,{label:"启用"},{default:t(()=>[e(el,{modelValue:U.value.enabled,"onUpdate:modelValue":l[31]||(l[31]=a=>U.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1}),e(fe,{label:"渠道",name:"channels"},{default:t(()=>[s("div",Pn,[e(E,{type:"info",size:"small"},{default:t(()=>[...l[82]||(l[82]=[i("每个 AI 成员独立配置自己的消息通道（如 Telegram Bot Token）",-1)])]),_:1}),e(r,{type:"primary",size:"small",onClick:ft},{default:t(()=>[e(M,null,{default:t(()=>[e(L(bl))]),_:1}),l[83]||(l[83]=i(" 添加消息渠道 ",-1))]),_:1})]),(o(!0),c(D,null,O(H.value,a=>(o(),c("div",{key:a.id,class:"channel-card"},[s("div",En,[s("div",Rn,[e($,{size:"small",style:{"margin-right":"8px"}},{default:t(()=>[i(v(a.type),1)]),_:2},1024),s("span",jn,v(a.name),1),a.config?.botName?(o(),c("span",Kn,"@"+v(a.config.botName),1)):C("",!0),e($,{type:a.status==="ok"?"success":a.status==="error"?"danger":"info",size:"small",effect:"plain",style:{"margin-left":"8px"}},{default:t(()=>[i(v(a.status==="ok"?"✓ 正常":a.status==="error"?"✗ 错误":"未测试"),1)]),_:2},1032,["type"])]),s("div",Wn,[e(el,{modelValue:a.enabled,"onUpdate:modelValue":w=>a.enabled=w,size:"small",onChange:pt,style:{"margin-right":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),e(r,{size:"small",onClick:w=>gt(a),loading:Tl.value===a.id},{default:t(()=>[...l[84]||(l[84]=[i("测试连接",-1)])]),_:1},8,["onClick","loading"]),e(r,{size:"small",onClick:w=>mt(a)},{default:t(()=>[...l[85]||(l[85]=[i("编辑",-1)])]),_:1},8,["onClick"]),e(r,{size:"small",type:"danger",plain:"",onClick:w=>yt(a)},{default:t(()=>[...l[86]||(l[86]=[i("删除",-1)])]),_:1},8,["onClick"])])]),a.type==="web"?(o(),c("div",On,[s("div",Yn,[l[88]||(l[88]=s("span",{class:"channel-info-label"},"公开地址",-1)),s("span",Jn,[e(Mt,{href:De(L(_),a.id),target:"_blank",type:"primary",style:{"font-size":"13px"}},{default:t(()=>[i(v(De(L(_),a.id)),1)]),_:2},1032,["href"]),e(r,{size:"small",link:"",style:{"margin-left":"8px"},onClick:w=>Wl(De(L(_),a.id))},{default:t(()=>[...l[87]||(l[87]=[i("复制",-1)])]),_:1},8,["onClick"])])]),s("div",qn,[l[89]||(l[89]=s("span",{class:"channel-info-label"},"访问密码",-1)),s("span",Hn,[e($,{size:"small",type:a.config?.password?"warning":"info",effect:"plain"},{default:t(()=>[i(v(a.config?.password?"已设置":"无密码"),1)]),_:2},1032,["type"])])])])):C("",!0),a.type==="telegram"?(o(),c("div",Gn,[s("div",Qn,[l[91]||(l[91]=s("span",{class:"channel-info-label"},"白名单用户",-1)),s("span",Xn,[a.allowedFromUsers?.length?(o(!0),c(D,{key:0},O(a.allowedFromUsers,w=>(o(),x($,{key:w.id,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:El=>Ol(a.id,w.id)},{default:t(()=>[i(v(w.username?"@"+w.username:w.firstName||String(w.id))+" ",1),s("span",Zn,"("+v(w.id)+")",1)]),_:2},1032,["onClose"]))),128)):a.config?.allowedFrom?(o(!0),c(D,{key:1},O(a.config.allowedFrom.split(","),w=>(o(),x($,{key:w,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:El=>Ol(a.id,Number(w.trim()))},{default:t(()=>[i(v(w.trim()),1)]),_:2},1032,["onClose"]))),128)):(o(),x(E,{key:2,type:"warning",size:"small"},{default:t(()=>[...l[90]||(l[90]=[i("未设置（配对模式，向用户返回其 ID）",-1)])]),_:1}))])]),s("div",es,[s("div",{class:"pending-section-header",onClick:w=>_t(a.id)},[l[93]||(l[93]=s("span",null,"待审核用户",-1)),e(Gl,{value:(Ne.value[a.id]||[]).length,hidden:!(Ne.value[a.id]||[]).length,type:"warning",style:{"margin-left":"6px"}},null,8,["value","hidden"]),e(r,{size:"small",link:"",onClick:dt(w=>fl(a.id),["stop"]),style:{"margin-left":"8px"}},{default:t(()=>[...l[92]||(l[92]=[i("刷新",-1)])]),_:1},8,["onClick"]),e(M,{style:nl([{"margin-left":"4px",transition:"transform 0.2s"},{transform:Ge.value===a.id?"rotate(180deg)":""}])},{default:t(()=>[e(L(qt))]),_:1},8,["style"])],8,ls),Ge.value===a.id?(o(),c("div",ts,[Ul.value[a.id]?(o(),c("div",as,[e(E,{type:"info",size:"small"},{default:t(()=>[...l[94]||(l[94]=[i("加载中...",-1)])]),_:1})])):(Ne.value[a.id]||[]).length?(o(!0),c(D,{key:1},O(Ne.value[a.id],w=>(o(),c("div",{key:w.id,class:"pending-user-row"},[s("div",ns,[s("span",ss,v(w.firstName||"未知"),1),w.username?(o(),c("span",os,"@"+v(w.username),1)):C("",!0),s("span",is,"ID: "+v(w.id),1),e(E,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:t(()=>[i(v(me(w.lastSeen)),1)]),_:2},1024)]),s("div",us,[e(r,{size:"small",type:"success",plain:"",onClick:El=>bt(a.id,w.id),loading:Al.value===`${a.id}-${w.id}`},{default:t(()=>[...l[95]||(l[95]=[i("加入白名单",-1)])]),_:1},8,["onClick","loading"]),e(r,{size:"small",type:"danger",plain:"",onClick:El=>wt(a.id,w.id)},{default:t(()=>[...l[96]||(l[96]=[i("忽略",-1)])]),_:1},8,["onClick"])])]))),128)):(o(),c("div",ds," 暂无待审核用户。让用户向 Bot 发送 /start 即可出现在此处。 "))])):C("",!0)])])):C("",!0)]))),128)),!He.value&&!H.value.length?(o(),x(gl,{key:0,description:"暂无消息渠道，点击「添加消息渠道」开始配置","image-size":80,style:{"margin-top":"40px"}})):C("",!0),e(_l,{modelValue:p.value,"onUpdate:modelValue":l[44]||(l[44]=a=>p.value=a),title:N.value?"编辑消息渠道":"添加消息渠道",width:"540px"},{footer:t(()=>[e(r,{onClick:l[43]||(l[43]=a=>p.value=!1)},{default:t(()=>[...l[106]||(l[106]=[i("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:ct,loading:zl.value},{default:t(()=>[...l[107]||(l[107]=[i("保存",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(Ze,{model:b.value,"label-width":"120px"},{default:t(()=>[e(S,{label:"类型",required:""},{default:t(()=>[e(ve,{modelValue:b.value.type,"onUpdate:modelValue":l[34]||(l[34]=a=>b.value.type=a),style:{width:"100%"}},{default:t(()=>[e(T,{label:"Telegram",value:"telegram"}),e(T,{label:"Web 聊天页",value:"web"}),e(T,{label:"iMessage",value:"imessage"}),e(T,{label:"WhatsApp",value:"whatsapp"})]),_:1},8,["modelValue"])]),_:1}),e(S,{label:"名称",required:""},{default:t(()=>[e(B,{modelValue:b.value.name,"onUpdate:modelValue":l[35]||(l[35]=a=>b.value.name=a),placeholder:"如：客服 Bot"},null,8,["modelValue"])]),_:1}),b.value.type==="telegram"?(o(),c(D,{key:0},[e(S,{label:"Bot Token",required:""},{default:t(()=>[s("div",rs,[s("div",vs,[e(B,{modelValue:b.value.botToken,"onUpdate:modelValue":l[36]||(l[36]=a=>b.value.botToken=a),type:"password","show-password":"",placeholder:"从 @BotFather 获取",style:{flex:"1"},status:A.value.status==="error"?"error":A.value.status==="ok"?"success":""},null,8,["modelValue","status"]),e(r,{size:"default",loading:A.value.loading,type:A.value.status==="ok"?"success":A.value.status==="error"?"danger":"default",onClick:Kl,disabled:!b.value.botToken||Ll(b.value.botToken)},{default:t(()=>[...l[97]||(l[97]=[i("验证",-1)])]),_:1},8,["loading","type","disabled"])]),A.value.loading?(o(),c("div",fs,[e(M,{class:"is-loading"},{default:t(()=>[e(L(wl))]),_:1}),l[98]||(l[98]=i(" 正在验证 Token… ",-1))])):A.value.status==="ok"?(o(),c("div",ms,[e(M,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Bt)]),_:1}),l[99]||(l[99]=i("Token 有效，Bot 名称：",-1)),s("b",null,"@"+v(A.value.botName),1)])):A.value.status==="duplicate"?(o(),c("div",cs,[e(M,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Pt)]),_:1}),l[100]||(l[100]=i("此 Token 已被成员「",-1)),s("b",null,v(A.value.usedBy),1),i("」的渠道「"+v(A.value.usedByCh)+"」使用 ",1)])):A.value.status==="error"?(o(),c("div",ps,[e(M,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Et)]),_:1}),i(v(A.value.error),1)])):(o(),c("div",ys,[e(E,{type:"info",size:"small"},{default:t(()=>[e(M,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Zl)]),_:1}),l[101]||(l[101]=i("输入完成后自动验证，也可点右侧「验证」按钮手动触发",-1))]),_:1})]))])]),_:1}),e(S,{label:"白名单用户"},{default:t(()=>[e(B,{modelValue:b.value.allowedFrom,"onUpdate:modelValue":l[37]||(l[37]=a=>b.value.allowedFrom=a),placeholder:"填入 Telegram 用户 ID，多个用逗号分隔"},null,8,["modelValue"]),e(E,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[e(M,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Zl)]),_:1}),l[102]||(l[102]=i("留空时 Bot 进入配对模式——向用户返回其 ID，引导联系管理员添加白名单 ",-1))]),_:1})]),_:1})],64)):C("",!0),b.value.type==="web"?(o(),c(D,{key:1},[N.value?(o(),x(S,{key:0,label:"访问链接"},{default:t(()=>[s("div",gs,[e(M,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(et)]),_:1}),s("span",_s,v(De(L(_),N.value)),1),e(r,{size:"small",link:"",onClick:l[38]||(l[38]=a=>Wl(De(L(_),N.value)))},{default:t(()=>[...l[103]||(l[103]=[i("复制",-1)])]),_:1})])]),_:1})):C("",!0),N.value?C("",!0):(o(),x(S,{key:1,label:"访问链接"},{default:t(()=>[s("div",bs,[e(M,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(et)]),_:1}),s("span",ws,v(De(L(_),vl.value)),1),e($,{size:"small",type:"info",effect:"plain"},{default:t(()=>[...l[104]||(l[104]=[i("保存后生效",-1)])]),_:1})]),e(E,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[...l[105]||(l[105]=[i(" 每个 Web 渠道有独立链接，可同时开放多个入口 ",-1)])]),_:1})]),_:1})),e(S,{label:"访问密码"},{default:t(()=>[e(B,{modelValue:b.value.webPassword,"onUpdate:modelValue":l[39]||(l[39]=a=>b.value.webPassword=a),type:"password","show-password":"",placeholder:"留空则无需密码"},null,8,["modelValue"])]),_:1}),e(S,{label:"欢迎语"},{default:t(()=>[e(B,{modelValue:b.value.webWelcome,"onUpdate:modelValue":l[40]||(l[40]=a=>b.value.webWelcome=a),placeholder:"你好！有什么可以帮你的？"},null,8,["modelValue"])]),_:1}),e(S,{label:"页面标题"},{default:t(()=>[e(B,{modelValue:b.value.webTitle,"onUpdate:modelValue":l[41]||(l[41]=a=>b.value.webTitle=a),placeholder:"AI 助手"},null,8,["modelValue"])]),_:1})],64)):C("",!0),e(S,{label:"启用"},{default:t(()=>[e(el,{modelValue:b.value.enabled,"onUpdate:modelValue":l[42]||(l[42]=a=>b.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),zs=vt(xs,[["__scopeId","data-v-f85470f5"]]);export{zs as default};
