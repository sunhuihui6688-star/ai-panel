import{d as Ge,h as He,E as r,k as v,w as l,B as Je,g as u,r as s,o as i,a as t,f,i as _,y as Ke,t as p,e as o,z as oe,p as We,c as w,F as q,j as ye,s as qe,l as k,C as Qe,D as Xe,G as Ze,H as et,I as tt}from"./index-DhZJP__V.js";import{b as lt,f as I,d as B,e as L,g as at}from"./index-C6G0aGO3.js";import{A as nt}from"./AiChat-C7w3fHV-.js";import{_ as ot}from"./_plugin-vue_export-helper-DlAUqK2U.js";const st={class:"header-left"},ut={class:"chat-layout"},it={class:"session-sidebar"},rt={class:"session-sidebar-header"},dt={class:"session-list"},mt=["onClick"],pt={class:"session-item-title"},ft={class:"session-item-meta"},ct={key:0,class:"session-empty"},vt={class:"chat-area"},yt={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},_t={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},gt={style:{display:"flex","align-items":"center","justify-content":"space-between"}},wt={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},kt=Ge({__name:"AgentDetailView",setup(bt){const c=Je().params.id,b=u(null),se=u("chat"),Q=u(),X=u([]),R=u(!1),Y=u();async function ue(){R.value=!0;try{const a=await at.list({agentId:c,limit:50});X.value=a.data.sessions}catch{}finally{R.value=!1}}function _e(a){Y.value=a.id,Q.value?.resumeSession(a.id)}function ge(){Y.value=void 0,Q.value?.startNewSession()}function we(a){Y.value=a,setTimeout(ue,500)}function ke(a){if(!a)return"";const e=Date.now()-a;return e<6e4?"刚刚":e<36e5?`${Math.floor(e/6e4)}分前`:e<864e5?`${Math.floor(e/36e5)}小时前`:`${Math.floor(e/864e5)}天前`}const j=u(""),O=u(""),P=u([]),V=u(""),C=u(""),Z=u(!1),ee=u([]),U=u(!1),G=u(""),$=u(!1),H=u(""),ie=u([]),x=u(""),S=u(""),J=u(null),re=u([]),A=u(!1),d=u({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function be(a){return a==="running"?"success":a==="stopped"?"danger":"info"}function Ve(a){return a==="running"?"运行中":a==="stopped"?"已停止":"空闲"}function de(a){return a?a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB":"0 B"}function Ce(a){return new Date(a).toLocaleString()}function xe(a){return a?new Date(a).toLocaleString():""}He(async()=>{try{const a=await lt.get(c);b.value=a.data}catch{r.error("加载 Agent 失败")}ze(),Ue(),K(),ue()});async function ze(){try{const[a,e]=await Promise.all([I.read(c,"IDENTITY.md"),I.read(c,"SOUL.md")]);j.value=a.data?.content||"",O.value=e.data?.content||""}catch{}N()}async function te(a,e){try{await I.write(c,a,e),r.success(`${a} 已保存`)}catch{r.error(`保存 ${a} 失败`)}}async function N(){try{const a=await B.tree(c);P.value=a.data||[]}catch{P.value=[]}}async function he(a){if(!a.isDir){V.value=a.path,ee.value=a.path.split("/");try{const e=await B.readFile(c,a.path);C.value=e.data?.content||""}catch{C.value="(无法读取)"}}}async function De(){if(V.value){Z.value=!0;try{await B.writeFile(c,V.value,C.value),r.success("记忆文件已保存"),N()}catch{r.error("保存失败")}finally{Z.value=!1}}}async function Fe(){const a=G.value.trim();if(!a){r.warning("请输入路径");return}try{await B.writeFile(c,a,`# ${a.split("/").pop()?.replace(".md","")||"New File"}

`),r.success("文件已创建"),U.value=!1,G.value="",N(),V.value=a,ee.value=a.split("/"),C.value=`# ${a.split("/").pop()?.replace(".md","")||"New File"}

`}catch{r.error("创建失败")}}async function Te(){const a=H.value.trim();if(!a){r.warning("请输入内容");return}try{await B.dailyLog(c,a),r.success("日志已添加"),$.value=!1,H.value="",N()}catch{r.error("添加失败")}}async function Ue(){try{const a=await I.read(c,"/");Array.isArray(a.data)&&(ie.value=a.data.map(e=>({name:e.name,isDir:e.isDir,size:e.size,modTime:e.modTime,path:e.name})))}catch{}}async function $e(a){if(!a.isDir){x.value=a.path||a.name,J.value=a;try{const e=await I.read(c,x.value);S.value=e.data?.content||""}catch{S.value="(无法读取)"}}}async function Se(){x.value&&await te(x.value,S.value)}async function K(){try{const a=await L.list();re.value=a.data||[]}catch{}}async function Ae(){try{await L.create({name:d.value.name,enabled:d.value.enabled,schedule:{kind:"cron",expr:d.value.expr,tz:d.value.tz},payload:{kind:"agentTurn",message:d.value.message},delivery:{mode:"announce"}}),r.success("任务创建成功"),A.value=!1,K()}catch(a){r.error(a.response?.data?.error||"创建失败")}}async function Ne(a){try{await L.update(a.id,a)}catch{r.error("更新失败")}}async function Ee(a){try{await L.run(a.id),r.success("已触发运行"),setTimeout(K,2e3)}catch{r.error("运行失败")}}async function Me(a){try{await L.delete(a.id),r.success("已删除"),K()}catch{r.error("删除失败")}}return(a,e)=>{const m=s("el-button"),W=s("el-tag"),z=s("el-text"),Ie=s("el-header"),E=s("el-tab-pane"),y=s("el-input"),h=s("el-card"),D=s("el-col"),le=s("el-row"),F=s("el-icon"),me=s("el-tree"),pe=s("el-empty"),fe=s("el-breadcrumb-item"),Be=s("el-breadcrumb"),T=s("el-form-item"),ce=s("el-form"),ae=s("el-dialog"),M=s("el-table-column"),ve=s("el-switch"),Le=s("el-table"),ne=s("el-option"),Re=s("el-select"),Ye=s("el-tabs"),je=s("el-main"),Oe=s("el-container"),Pe=tt("loading");return i(),v(Oe,{class:"agent-detail"},{default:l(()=>[t(Ie,{class:"detail-header"},{default:l(()=>[f("div",st,[t(m,{icon:_(Ke),onClick:e[0]||(e[0]=n=>a.$router.push("/agents")),circle:""},null,8,["icon"]),f("h2",null,p(b.value?.name||"..."),1),t(W,{type:be(b.value?.status)},{default:l(()=>[o(p(Ve(b.value?.status)),1)]),_:1},8,["type"])]),t(z,{type:"info"},{default:l(()=>[o(p(b.value?.model),1)]),_:1})]),_:1}),t(je,null,{default:l(()=>[t(Ye,{modelValue:se.value,"onUpdate:modelValue":e[23]||(e[23]=n=>se.value=n),type:"border-card"},{default:l(()=>[t(E,{label:"对话",name:"chat"},{default:l(()=>[f("div",ut,[f("div",it,[f("div",rt,[e[25]||(e[25]=f("span",{class:"sidebar-title"},"历史对话",-1)),t(m,{size:"small",type:"primary",plain:"",onClick:ge,icon:_(oe)},{default:l(()=>[...e[24]||(e[24]=[o("新建",-1)])]),_:1},8,["icon"])]),We((i(),w("div",dt,[(i(!0),w(q,null,ye(X.value,n=>(i(),w("div",{key:n.id,class:qe(["session-item",{active:Y.value===n.id}]),onClick:g=>_e(n)},[f("div",pt,p(n.title||"新对话"),1),f("div",ft,[f("span",null,p(ke(n.lastAt)),1),t(W,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:l(()=>[o(p(n.messageCount)+" 条 ",1)]),_:2},1024),n.tokenEstimate>6e4?(i(),v(W,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:l(()=>[o("~"+p(Math.round(n.tokenEstimate/1e3))+"k",1)]),_:2},1024)):k("",!0)])],10,mt))),128)),!R.value&&!X.value.length?(i(),w("div",ct," 还没有对话记录 ")):k("",!0)])),[[Pe,R.value]])]),f("div",vt,[t(nt,{ref_key:"aiChatRef",ref:Q,"agent-id":_(c),scenario:"agent-detail","welcome-message":`你好！我是 **${b.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:we},null,8,["agent-id","welcome-message"])])])]),_:1}),t(E,{label:"身份 & 灵魂",name:"identity"},{default:l(()=>[t(le,{gutter:20},{default:l(()=>[t(D,{span:12},{default:l(()=>[t(h,{header:"IDENTITY.md"},{default:l(()=>[t(y,{modelValue:j.value,"onUpdate:modelValue":e[1]||(e[1]=n=>j.value=n),type:"textarea",rows:15,onBlur:e[2]||(e[2]=n=>te("IDENTITY.md",j.value))},null,8,["modelValue"])]),_:1})]),_:1}),t(D,{span:12},{default:l(()=>[t(h,{header:"SOUL.md"},{default:l(()=>[t(y,{modelValue:O.value,"onUpdate:modelValue":e[3]||(e[3]=n=>O.value=n),type:"textarea",rows:15,onBlur:e[4]||(e[4]=n=>te("SOUL.md",O.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(E,{label:"记忆",name:"memory"},{default:l(()=>[f("div",yt,[t(m,{type:"primary",size:"small",onClick:e[5]||(e[5]=n=>U.value=!0)},{default:l(()=>[t(F,null,{default:l(()=>[t(_(oe))]),_:1}),e[26]||(e[26]=o(" 新建文件 ",-1))]),_:1}),t(m,{size:"small",onClick:e[6]||(e[6]=n=>$.value=!0)},{default:l(()=>[t(F,null,{default:l(()=>[t(_(Qe))]),_:1}),e[27]||(e[27]=o(" 添加日志 ",-1))]),_:1}),t(m,{size:"small",onClick:N},{default:l(()=>[t(F,null,{default:l(()=>[t(_(Xe))]),_:1}),e[28]||(e[28]=o(" 刷新 ",-1))]),_:1})]),t(le,{gutter:16},{default:l(()=>[t(D,{span:7},{default:l(()=>[t(h,{header:"记忆目录",shadow:"hover"},{default:l(()=>[t(me,{data:P.value,props:{label:"name",children:"children",isLeaf:n=>!n.isDir},onNodeClick:he,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:l(({data:n})=>[f("span",_t,[n.isDir?(i(),v(F,{key:0,style:{color:"#E6A23C"}},{default:l(()=>[t(_(Ze))]),_:1})):(i(),v(F,{key:1,style:{color:"#409EFF"}},{default:l(()=>[t(_(et))]),_:1})),f("span",null,p(n.name),1),!n.isDir&&n.size?(i(),v(z,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:l(()=>[o(p(de(n.size)),1)]),_:2},1024)):k("",!0)])]),_:1},8,["data","props"]),P.value.length===0?(i(),v(pe,{key:0,description:"记忆树为空","image-size":40})):k("",!0)]),_:1})]),_:1}),t(D,{span:17},{default:l(()=>[t(h,{shadow:"hover"},{header:l(()=>[f("div",gt,[t(Be,{separator:"/"},{default:l(()=>[t(fe,null,{default:l(()=>[...e[29]||(e[29]=[o("memory",-1)])]),_:1}),(i(!0),w(q,null,ye(ee.value,(n,g)=>(i(),v(fe,{key:g},{default:l(()=>[o(p(n),1)]),_:2},1024))),128))]),_:1}),V.value?(i(),v(m,{key:0,type:"primary",size:"small",onClick:De,loading:Z.value},{default:l(()=>[...e[30]||(e[30]=[o("保存",-1)])]),_:1},8,["loading"])):k("",!0)])]),default:l(()=>[V.value?(i(),v(y,{key:0,modelValue:C.value,"onUpdate:modelValue":e[7]||(e[7]=n=>C.value=n),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(i(),v(pe,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),t(ae,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=n=>U.value=n),title:"新建记忆文件",width:"480px"},{footer:l(()=>[t(m,{onClick:e[9]||(e[9]=n=>U.value=!1)},{default:l(()=>[...e[32]||(e[32]=[o("取消",-1)])]),_:1}),t(m,{type:"primary",onClick:Fe},{default:l(()=>[...e[33]||(e[33]=[o("创建",-1)])]),_:1})]),default:l(()=>[t(ce,{"label-width":"80px"},{default:l(()=>[t(T,{label:"路径"},{default:l(()=>[t(y,{modelValue:G.value,"onUpdate:modelValue":e[8]||(e[8]=n=>G.value=n),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),t(z,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:l(()=>[...e[31]||(e[31]=[o("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(ae,{modelValue:$.value,"onUpdate:modelValue":e[13]||(e[13]=n=>$.value=n),title:"添加今日日志",width:"600px"},{footer:l(()=>[t(m,{onClick:e[12]||(e[12]=n=>$.value=!1)},{default:l(()=>[...e[34]||(e[34]=[o("取消",-1)])]),_:1}),t(m,{type:"primary",onClick:Te},{default:l(()=>[...e[35]||(e[35]=[o("提交",-1)])]),_:1})]),default:l(()=>[t(y,{modelValue:H.value,"onUpdate:modelValue":e[11]||(e[11]=n=>H.value=n),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),t(E,{label:"工作区",name:"workspace"},{default:l(()=>[t(le,{gutter:20},{default:l(()=>[t(D,{span:8},{default:l(()=>[t(h,{header:"文件列表"},{default:l(()=>[t(me,{data:ie.value,props:{label:"name",children:"children"},onNodeClick:$e,"highlight-current":"","default-expand-all":""},null,8,["data"])]),_:1})]),_:1}),t(D,{span:16},{default:l(()=>[t(h,{header:x.value||"选择文件查看"},{default:l(()=>[x.value?(i(),w(q,{key:0},[t(y,{modelValue:S.value,"onUpdate:modelValue":e[14]||(e[14]=n=>S.value=n),type:"textarea",rows:20},null,8,["modelValue"]),f("div",wt,[t(m,{type:"primary",onClick:Se},{default:l(()=>[...e[36]||(e[36]=[o("保存",-1)])]),_:1}),J.value?(i(),v(z,{key:0,type:"info",size:"small"},{default:l(()=>[o(p(de(J.value.size))+" · "+p(Ce(J.value.modTime)),1)]),_:1})):k("",!0)])],64)):k("",!0)]),_:1},8,["header"])]),_:1})]),_:1})]),_:1}),t(E,{label:"定时任务",name:"cron"},{default:l(()=>[t(m,{type:"primary",onClick:e[15]||(e[15]=n=>A.value=!0),style:{"margin-bottom":"16px"}},{default:l(()=>[t(F,null,{default:l(()=>[t(_(oe))]),_:1}),e[37]||(e[37]=o(" 新建任务 ",-1))]),_:1}),t(Le,{data:re.value,stripe:""},{default:l(()=>[t(M,{prop:"name",label:"名称"}),t(M,{label:"调度"},{default:l(({row:n})=>[o(p(n.schedule?.expr)+" ("+p(n.schedule?.tz)+")",1)]),_:1}),t(M,{label:"最近运行",width:"180"},{default:l(({row:n})=>[n.state?.lastRunAtMs?(i(),w(q,{key:0},[t(W,{type:n.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:l(()=>[o(p(n.state?.lastStatus),1)]),_:2},1032,["type"]),t(z,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:l(()=>[o(p(xe(n.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(i(),v(z,{key:1,type:"info",size:"small"},{default:l(()=>[...e[38]||(e[38]=[o("未运行",-1)])]),_:1}))]),_:1}),t(M,{label:"启用",width:"80"},{default:l(({row:n})=>[t(ve,{modelValue:n.enabled,"onUpdate:modelValue":g=>n.enabled=g,onChange:g=>Ne(n)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(M,{label:"操作",width:"200"},{default:l(({row:n})=>[t(m,{size:"small",onClick:g=>Ee(n)},{default:l(()=>[...e[39]||(e[39]=[o("立即运行",-1)])]),_:1},8,["onClick"]),t(m,{size:"small",type:"danger",onClick:g=>Me(n)},{default:l(()=>[...e[40]||(e[40]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),t(ae,{modelValue:A.value,"onUpdate:modelValue":e[22]||(e[22]=n=>A.value=n),title:"新建定时任务",width:"520px"},{footer:l(()=>[t(m,{onClick:e[21]||(e[21]=n=>A.value=!1)},{default:l(()=>[...e[41]||(e[41]=[o("取消",-1)])]),_:1}),t(m,{type:"primary",onClick:Ae},{default:l(()=>[...e[42]||(e[42]=[o("创建",-1)])]),_:1})]),default:l(()=>[t(ce,{model:d.value,"label-width":"100px"},{default:l(()=>[t(T,{label:"名称"},{default:l(()=>[t(y,{modelValue:d.value.name,"onUpdate:modelValue":e[16]||(e[16]=n=>d.value.name=n)},null,8,["modelValue"])]),_:1}),t(T,{label:"Cron 表达式"},{default:l(()=>[t(y,{modelValue:d.value.expr,"onUpdate:modelValue":e[17]||(e[17]=n=>d.value.expr=n),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),t(T,{label:"时区"},{default:l(()=>[t(Re,{modelValue:d.value.tz,"onUpdate:modelValue":e[18]||(e[18]=n=>d.value.tz=n)},{default:l(()=>[t(ne,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),t(ne,{label:"UTC",value:"UTC"}),t(ne,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),t(T,{label:"消息"},{default:l(()=>[t(y,{modelValue:d.value.message,"onUpdate:modelValue":e[19]||(e[19]=n=>d.value.message=n),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),t(T,{label:"启用"},{default:l(()=>[t(ve,{modelValue:d.value.enabled,"onUpdate:modelValue":e[20]||(e[20]=n=>d.value.enabled=n)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),Dt=ot(kt,[["__scopeId","data-v-12215f10"]]);export{Dt as default};
