import{d as Ge,h as He,E as d,i as v,w as l,B as Je,g as u,r as s,o as r,a as t,f,k as _,y as Ke,t as p,e as o,z as oe,m as We,c as w,F as X,l as _e,q as Qe,j as b,C as Xe,D as Ze,G as et,H as tt,I as lt}from"./index-DX-xuzVJ.js";import{b as at,f as B,e as L,g as R,h as nt}from"./index-BmzlEx1S.js";import{A as ot}from"./AiChat-DbuGwXdb.js";import{_ as st}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ut={class:"header-left"},it={class:"chat-layout"},rt={class:"session-sidebar"},dt={class:"session-sidebar-header"},mt={class:"session-list"},pt=["onClick"],ft={class:"session-item-title"},ct={class:"session-item-meta"},vt={key:0,class:"session-empty"},yt={class:"chat-area"},_t={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},gt={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},wt={style:{display:"flex","align-items":"center","justify-content":"space-between"}},bt={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},kt=Ge({__name:"AgentDetailView",setup(Vt){const se=Je(),c=se.params.id,k=u(null),ue=u("chat"),Y=u(),P=u([]),j=u(!1),V=u();async function ie(){j.value=!0;try{const a=await nt.list({agentId:c,limit:50});P.value=a.data.sessions}catch{}finally{j.value=!1}}function ge(a){V.value=a.id,Y.value?.resumeSession(a.id)}function we(){V.value=void 0,Y.value?.startNewSession()}function be(a){V.value=a,setTimeout(ie,500)}function ke(a){if(!a)return"";const e=Date.now()-a;return e<6e4?"刚刚":e<36e5?`${Math.floor(e/6e4)}分前`:e<864e5?`${Math.floor(e/36e5)}小时前`:`${Math.floor(e/864e5)}天前`}const O=u(""),q=u(""),G=u([]),C=u(""),x=u(""),Z=u(!1),ee=u([]),U=u(!1),H=u(""),$=u(!1),J=u(""),re=u([]),z=u(""),A=u(""),K=u(null),de=u([]),N=u(!1),m=u({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function Ve(a){return a==="running"?"success":a==="stopped"?"danger":"info"}function Ce(a){return a==="running"?"运行中":a==="stopped"?"已停止":"空闲"}function me(a){return a?a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB":"0 B"}function xe(a){return new Date(a).toLocaleString()}function ze(a){return a?new Date(a).toLocaleString():""}He(async()=>{try{const e=await at.get(c);k.value=e.data}catch{d.error("加载 Agent 失败")}he(),Ue(),W(),await ie();const a=se.query.resumeSession;a&&(V.value=a,await new Promise(i=>setTimeout(i,100)),Y.value?.resumeSession(a),P.value.find(i=>i.id===a)||(V.value=a))});async function he(){try{const[a,e]=await Promise.all([B.read(c,"IDENTITY.md"),B.read(c,"SOUL.md")]);O.value=a.data?.content||"",q.value=e.data?.content||""}catch{}E()}async function te(a,e){try{await B.write(c,a,e),d.success(`${a} 已保存`)}catch{d.error(`保存 ${a} 失败`)}}async function E(){try{const a=await L.tree(c);G.value=a.data||[]}catch{G.value=[]}}async function De(a){if(!a.isDir){C.value=a.path,ee.value=a.path.split("/");try{const e=await L.readFile(c,a.path);x.value=e.data?.content||""}catch{x.value="(无法读取)"}}}async function Fe(){if(C.value){Z.value=!0;try{await L.writeFile(c,C.value,x.value),d.success("记忆文件已保存"),E()}catch{d.error("保存失败")}finally{Z.value=!1}}}async function Se(){const a=H.value.trim();if(!a){d.warning("请输入路径");return}try{await L.writeFile(c,a,`# ${a.split("/").pop()?.replace(".md","")||"New File"}

`),d.success("文件已创建"),U.value=!1,H.value="",E(),C.value=a,ee.value=a.split("/"),x.value=`# ${a.split("/").pop()?.replace(".md","")||"New File"}

`}catch{d.error("创建失败")}}async function Te(){const a=J.value.trim();if(!a){d.warning("请输入内容");return}try{await L.dailyLog(c,a),d.success("日志已添加"),$.value=!1,J.value="",E()}catch{d.error("添加失败")}}async function Ue(){try{const a=await B.read(c,"/");Array.isArray(a.data)&&(re.value=a.data.map(e=>({name:e.name,isDir:e.isDir,size:e.size,modTime:e.modTime,path:e.name})))}catch{}}async function $e(a){if(!a.isDir){z.value=a.path||a.name,K.value=a;try{const e=await B.read(c,z.value);A.value=e.data?.content||""}catch{A.value="(无法读取)"}}}async function Ae(){z.value&&await te(z.value,A.value)}async function W(){try{const a=await R.list();de.value=a.data||[]}catch{}}async function Ne(){try{await R.create({name:m.value.name,enabled:m.value.enabled,schedule:{kind:"cron",expr:m.value.expr,tz:m.value.tz},payload:{kind:"agentTurn",message:m.value.message},delivery:{mode:"announce"}}),d.success("任务创建成功"),N.value=!1,W()}catch(a){d.error(a.response?.data?.error||"创建失败")}}async function Ee(a){try{await R.update(a.id,a)}catch{d.error("更新失败")}}async function Me(a){try{await R.run(a.id),d.success("已触发运行"),setTimeout(W,2e3)}catch{d.error("运行失败")}}async function Ie(a){try{await R.delete(a.id),d.success("已删除"),W()}catch{d.error("删除失败")}}return(a,e)=>{const i=s("el-button"),Q=s("el-tag"),h=s("el-text"),Be=s("el-header"),M=s("el-tab-pane"),y=s("el-input"),D=s("el-card"),F=s("el-col"),le=s("el-row"),S=s("el-icon"),pe=s("el-tree"),fe=s("el-empty"),ce=s("el-breadcrumb-item"),Le=s("el-breadcrumb"),T=s("el-form-item"),ve=s("el-form"),ae=s("el-dialog"),I=s("el-table-column"),ye=s("el-switch"),Re=s("el-table"),ne=s("el-option"),Ye=s("el-select"),Pe=s("el-tabs"),je=s("el-main"),Oe=s("el-container"),qe=lt("loading");return r(),v(Oe,{class:"agent-detail"},{default:l(()=>[t(Be,{class:"detail-header"},{default:l(()=>[f("div",ut,[t(i,{icon:_(Ke),onClick:e[0]||(e[0]=n=>a.$router.push("/agents")),circle:""},null,8,["icon"]),f("h2",null,p(k.value?.name||"..."),1),t(Q,{type:Ve(k.value?.status)},{default:l(()=>[o(p(Ce(k.value?.status)),1)]),_:1},8,["type"])]),t(h,{type:"info"},{default:l(()=>[o(p(k.value?.model),1)]),_:1})]),_:1}),t(je,null,{default:l(()=>[t(Pe,{modelValue:ue.value,"onUpdate:modelValue":e[23]||(e[23]=n=>ue.value=n),type:"border-card"},{default:l(()=>[t(M,{label:"对话",name:"chat"},{default:l(()=>[f("div",it,[f("div",rt,[f("div",dt,[e[25]||(e[25]=f("span",{class:"sidebar-title"},"历史对话",-1)),t(i,{size:"small",type:"primary",plain:"",onClick:we,icon:_(oe)},{default:l(()=>[...e[24]||(e[24]=[o("新建",-1)])]),_:1},8,["icon"])]),We((r(),w("div",mt,[(r(!0),w(X,null,_e(P.value,n=>(r(),w("div",{key:n.id,class:Qe(["session-item",{active:V.value===n.id}]),onClick:g=>ge(n)},[f("div",ft,p(n.title||"新对话"),1),f("div",ct,[f("span",null,p(ke(n.lastAt)),1),t(Q,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:l(()=>[o(p(n.messageCount)+" 条 ",1)]),_:2},1024),n.tokenEstimate>6e4?(r(),v(Q,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:l(()=>[o("~"+p(Math.round(n.tokenEstimate/1e3))+"k",1)]),_:2},1024)):b("",!0)])],10,pt))),128)),!j.value&&!P.value.length?(r(),w("div",vt," 还没有对话记录 ")):b("",!0)])),[[qe,j.value]])]),f("div",yt,[t(ot,{ref_key:"aiChatRef",ref:Y,"agent-id":_(c),scenario:"agent-detail","welcome-message":`你好！我是 **${k.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:be},null,8,["agent-id","welcome-message"])])])]),_:1}),t(M,{label:"身份 & 灵魂",name:"identity"},{default:l(()=>[t(le,{gutter:20},{default:l(()=>[t(F,{span:12},{default:l(()=>[t(D,{header:"IDENTITY.md"},{default:l(()=>[t(y,{modelValue:O.value,"onUpdate:modelValue":e[1]||(e[1]=n=>O.value=n),type:"textarea",rows:15,onBlur:e[2]||(e[2]=n=>te("IDENTITY.md",O.value))},null,8,["modelValue"])]),_:1})]),_:1}),t(F,{span:12},{default:l(()=>[t(D,{header:"SOUL.md"},{default:l(()=>[t(y,{modelValue:q.value,"onUpdate:modelValue":e[3]||(e[3]=n=>q.value=n),type:"textarea",rows:15,onBlur:e[4]||(e[4]=n=>te("SOUL.md",q.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(M,{label:"记忆",name:"memory"},{default:l(()=>[f("div",_t,[t(i,{type:"primary",size:"small",onClick:e[5]||(e[5]=n=>U.value=!0)},{default:l(()=>[t(S,null,{default:l(()=>[t(_(oe))]),_:1}),e[26]||(e[26]=o(" 新建文件 ",-1))]),_:1}),t(i,{size:"small",onClick:e[6]||(e[6]=n=>$.value=!0)},{default:l(()=>[t(S,null,{default:l(()=>[t(_(Xe))]),_:1}),e[27]||(e[27]=o(" 添加日志 ",-1))]),_:1}),t(i,{size:"small",onClick:E},{default:l(()=>[t(S,null,{default:l(()=>[t(_(Ze))]),_:1}),e[28]||(e[28]=o(" 刷新 ",-1))]),_:1})]),t(le,{gutter:16},{default:l(()=>[t(F,{span:7},{default:l(()=>[t(D,{header:"记忆目录",shadow:"hover"},{default:l(()=>[t(pe,{data:G.value,props:{label:"name",children:"children",isLeaf:n=>!n.isDir},onNodeClick:De,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:l(({data:n})=>[f("span",gt,[n.isDir?(r(),v(S,{key:0,style:{color:"#E6A23C"}},{default:l(()=>[t(_(et))]),_:1})):(r(),v(S,{key:1,style:{color:"#409EFF"}},{default:l(()=>[t(_(tt))]),_:1})),f("span",null,p(n.name),1),!n.isDir&&n.size?(r(),v(h,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:l(()=>[o(p(me(n.size)),1)]),_:2},1024)):b("",!0)])]),_:1},8,["data","props"]),G.value.length===0?(r(),v(fe,{key:0,description:"记忆树为空","image-size":40})):b("",!0)]),_:1})]),_:1}),t(F,{span:17},{default:l(()=>[t(D,{shadow:"hover"},{header:l(()=>[f("div",wt,[t(Le,{separator:"/"},{default:l(()=>[t(ce,null,{default:l(()=>[...e[29]||(e[29]=[o("memory",-1)])]),_:1}),(r(!0),w(X,null,_e(ee.value,(n,g)=>(r(),v(ce,{key:g},{default:l(()=>[o(p(n),1)]),_:2},1024))),128))]),_:1}),C.value?(r(),v(i,{key:0,type:"primary",size:"small",onClick:Fe,loading:Z.value},{default:l(()=>[...e[30]||(e[30]=[o("保存",-1)])]),_:1},8,["loading"])):b("",!0)])]),default:l(()=>[C.value?(r(),v(y,{key:0,modelValue:x.value,"onUpdate:modelValue":e[7]||(e[7]=n=>x.value=n),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(r(),v(fe,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),t(ae,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=n=>U.value=n),title:"新建记忆文件",width:"480px"},{footer:l(()=>[t(i,{onClick:e[9]||(e[9]=n=>U.value=!1)},{default:l(()=>[...e[32]||(e[32]=[o("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:Se},{default:l(()=>[...e[33]||(e[33]=[o("创建",-1)])]),_:1})]),default:l(()=>[t(ve,{"label-width":"80px"},{default:l(()=>[t(T,{label:"路径"},{default:l(()=>[t(y,{modelValue:H.value,"onUpdate:modelValue":e[8]||(e[8]=n=>H.value=n),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),t(h,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:l(()=>[...e[31]||(e[31]=[o("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(ae,{modelValue:$.value,"onUpdate:modelValue":e[13]||(e[13]=n=>$.value=n),title:"添加今日日志",width:"600px"},{footer:l(()=>[t(i,{onClick:e[12]||(e[12]=n=>$.value=!1)},{default:l(()=>[...e[34]||(e[34]=[o("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:Te},{default:l(()=>[...e[35]||(e[35]=[o("提交",-1)])]),_:1})]),default:l(()=>[t(y,{modelValue:J.value,"onUpdate:modelValue":e[11]||(e[11]=n=>J.value=n),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),t(M,{label:"工作区",name:"workspace"},{default:l(()=>[t(le,{gutter:20},{default:l(()=>[t(F,{span:8},{default:l(()=>[t(D,{header:"文件列表"},{default:l(()=>[t(pe,{data:re.value,props:{label:"name",children:"children"},onNodeClick:$e,"highlight-current":"","default-expand-all":""},null,8,["data"])]),_:1})]),_:1}),t(F,{span:16},{default:l(()=>[t(D,{header:z.value||"选择文件查看"},{default:l(()=>[z.value?(r(),w(X,{key:0},[t(y,{modelValue:A.value,"onUpdate:modelValue":e[14]||(e[14]=n=>A.value=n),type:"textarea",rows:20},null,8,["modelValue"]),f("div",bt,[t(i,{type:"primary",onClick:Ae},{default:l(()=>[...e[36]||(e[36]=[o("保存",-1)])]),_:1}),K.value?(r(),v(h,{key:0,type:"info",size:"small"},{default:l(()=>[o(p(me(K.value.size))+" · "+p(xe(K.value.modTime)),1)]),_:1})):b("",!0)])],64)):b("",!0)]),_:1},8,["header"])]),_:1})]),_:1})]),_:1}),t(M,{label:"定时任务",name:"cron"},{default:l(()=>[t(i,{type:"primary",onClick:e[15]||(e[15]=n=>N.value=!0),style:{"margin-bottom":"16px"}},{default:l(()=>[t(S,null,{default:l(()=>[t(_(oe))]),_:1}),e[37]||(e[37]=o(" 新建任务 ",-1))]),_:1}),t(Re,{data:de.value,stripe:""},{default:l(()=>[t(I,{prop:"name",label:"名称"}),t(I,{label:"调度"},{default:l(({row:n})=>[o(p(n.schedule?.expr)+" ("+p(n.schedule?.tz)+")",1)]),_:1}),t(I,{label:"最近运行",width:"180"},{default:l(({row:n})=>[n.state?.lastRunAtMs?(r(),w(X,{key:0},[t(Q,{type:n.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:l(()=>[o(p(n.state?.lastStatus),1)]),_:2},1032,["type"]),t(h,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:l(()=>[o(p(ze(n.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(r(),v(h,{key:1,type:"info",size:"small"},{default:l(()=>[...e[38]||(e[38]=[o("未运行",-1)])]),_:1}))]),_:1}),t(I,{label:"启用",width:"80"},{default:l(({row:n})=>[t(ye,{modelValue:n.enabled,"onUpdate:modelValue":g=>n.enabled=g,onChange:g=>Ee(n)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(I,{label:"操作",width:"200"},{default:l(({row:n})=>[t(i,{size:"small",onClick:g=>Me(n)},{default:l(()=>[...e[39]||(e[39]=[o("立即运行",-1)])]),_:1},8,["onClick"]),t(i,{size:"small",type:"danger",onClick:g=>Ie(n)},{default:l(()=>[...e[40]||(e[40]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),t(ae,{modelValue:N.value,"onUpdate:modelValue":e[22]||(e[22]=n=>N.value=n),title:"新建定时任务",width:"520px"},{footer:l(()=>[t(i,{onClick:e[21]||(e[21]=n=>N.value=!1)},{default:l(()=>[...e[41]||(e[41]=[o("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:Ne},{default:l(()=>[...e[42]||(e[42]=[o("创建",-1)])]),_:1})]),default:l(()=>[t(ve,{model:m.value,"label-width":"100px"},{default:l(()=>[t(T,{label:"名称"},{default:l(()=>[t(y,{modelValue:m.value.name,"onUpdate:modelValue":e[16]||(e[16]=n=>m.value.name=n)},null,8,["modelValue"])]),_:1}),t(T,{label:"Cron 表达式"},{default:l(()=>[t(y,{modelValue:m.value.expr,"onUpdate:modelValue":e[17]||(e[17]=n=>m.value.expr=n),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),t(T,{label:"时区"},{default:l(()=>[t(Ye,{modelValue:m.value.tz,"onUpdate:modelValue":e[18]||(e[18]=n=>m.value.tz=n)},{default:l(()=>[t(ne,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),t(ne,{label:"UTC",value:"UTC"}),t(ne,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),t(T,{label:"消息"},{default:l(()=>[t(y,{modelValue:m.value.message,"onUpdate:modelValue":e[19]||(e[19]=n=>m.value.message=n),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),t(T,{label:"启用"},{default:l(()=>[t(ye,{modelValue:m.value.enabled,"onUpdate:modelValue":e[20]||(e[20]=n=>m.value.enabled=n)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),Dt=st(kt,[["__scopeId","data-v-07f101b5"]]);export{Dt as default};
