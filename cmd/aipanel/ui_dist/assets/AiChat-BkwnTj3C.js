import{d as ve,g as f,h as fe,c as o,n as ge,q as me,f as n,j as p,t as h,F as b,l as $,e as R,m as ye,b as j,J as z,K as _e,x as ke,L as T,o as a}from"./index-Bd0oUap9.js";import{j as be,i as xe}from"./index-BP-QbRJU.js";import{_ as Ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const we={key:0,class:"history-loading"},$e={key:1,class:"chat-empty"},Se={key:0,class:"welcome-msg"},Ie={key:1,class:"examples"},Me=["onClick"],Te={key:0,class:"msg-row user"},De={class:"msg-bubble user"},Ae={key:0,class:"msg-images"},Ne=["src","onClick"],Le={class:"msg-text"},Fe={key:1,class:"msg-row assistant"},Je={class:"msg-col"},Oe=["open"],Be={class:"thinking-summary"},Ee={class:"thinking-len"},Re={class:"thinking-content"},je={class:"msg-bubble assistant"},He={class:"tool-details"},Ke={class:"tool-summary"},Pe={class:"tool-name"},Ue={key:0,class:"tool-status running"},Ve={key:1,class:"tool-status done"},ze={key:2,class:"tool-status error"},We={class:"tool-body"},Ye={key:0,class:"tool-section"},qe={class:"tool-pre"},Ge={key:1,class:"tool-section"},Qe={class:"tool-pre result"},Xe=["innerHTML"],Ze={key:1,class:"apply-card"},et={class:"apply-preview"},tt={class:"apply-key"},st={class:"apply-val"},nt=["onClick"],lt={class:"msg-actions"},ot=["onClick","title"],at=["onClick"],it=["onClick"],ct={key:1,class:"option-chips"},rt=["onClick"],ut={key:2,class:"msg-row system"},dt={class:"msg-system"},pt={key:2,class:"msg-row assistant"},ht={class:"msg-col"},vt={key:0,class:"thinking-block",open:""},ft={class:"thinking-content"},gt={class:"msg-bubble assistant"},mt={key:0,class:"typing-dots"},yt=["innerHTML"],_t={key:2,class:"blink"},kt=["src"],bt={class:"chat-input-area"},xt={key:0,class:"attachments-bar"},Ct=["src"],wt=["onClick"],$t={class:"input-row"},St={class:"textarea-wrap"},It=["placeholder","disabled","onKeydown"],Mt={class:"input-actions"},Tt={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},Dt=["disabled"],At={key:0,class:"spinner"},Nt={key:1},Lt=ve({__name:"AiChat",props:{agentId:{},sessionId:{},context:{},scenario:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply","session-change"],setup(g,{expose:W,emit:Y}){const v=g,D=Y,u=f(v.initialMessages?[...v.initialMessages]:[]),S=f(""),x=f([]),C=f(!1),m=f(""),I=f(""),A=f(null),N=f(""),w=f(v.sessionId),M=f(!1),L=f(),_=f(),q=ke(()=>({height:v.height??"100%","--bg":v.bgColor??"transparent"}));function y(){T(()=>{L.value&&(L.value.scrollTop=L.value.scrollHeight)})}function G(){_.value&&(_.value.style.height="auto",_.value.style.height=Math.min(_.value.scrollHeight,160)+"px")}function F(s){S.value=s,T(()=>_.value?.focus())}function Q(s){try{return JSON.stringify(JSON.parse(s),null,2)}catch{return s}}function X(s){navigator.clipboard?.writeText(s);const e=u.value.findIndex(t=>t.text===s);A.value=e,setTimeout(()=>{A.value=null},1500)}function Z(s){for(let e=s-1;e>=0;e--){const t=u.value[e];if(t&&t.role==="user"){const i=t.text,l=t.images??[];u.value.splice(e,u.value.length-e),V(i,l);return}}}function ee(s){N.value=s}function K(s){return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(t,i,l)=>`<pre class="code-block${i?" lang-"+i:""}"><code>${l}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function te(s){const e=s.split(`
`),t=[],i=/^([ğŸ™ğŸ˜„ğŸŒğŸ›ğŸ“šğŸ¨ğŸ’¼ğŸ¤–âš½ğŸ¯âœ…âŒğŸ”¥ğŸ’¡ğŸğŸš€ğŸŒŸğŸ’ğŸªğŸ­ğŸ¬ğŸ¤]|[\u{1F300}-\u{1FFFF}]|[\u{2600}-\u{27BF}])\s+(.{4,40})/u;for(const l of e){const c=l.replace(/^[-*â€¢]\s*/,"").trim();if(c.match(i)){const d=c.replace(/[ï¼š:ã€‚ï¼Œ,]$/,"").trim();d.length>=5&&t.push(d)}}return t.slice(0,5)}function se(s){return s?/\{[\s\S]{30,}\}/.test(s)&&(s.includes('"name"')||s.includes('"identity"')||s.includes('"soul"')||s.includes('"IDENTITY"')||s.includes('"SOUL"')):!1}function ne(s){const e=P(s.text);console.log("[AiChat] manualApply result:",e),e?(s.applyData=e,T(()=>D("apply",e))):alert("æœªèƒ½ä»æ¶ˆæ¯ä¸­æå–åˆ°é…ç½® JSONï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶")}function P(s){const e=s.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(e?.[1]){const i=J(e[1]);if(i)return i;const l=U(e[1]),c=J(l);if(c)return c}const t=[...s.matchAll(/(\{[^{}]{20,}\})/g)];for(let i=t.length-1;i>=0;i--){const l=t[i]?.[1];if(!l)continue;const c=J(l)??J(U(l));if(c)return c}return null}function J(s){try{const e=JSON.parse(s);if(e&&typeof e=="object"&&!Array.isArray(e)){const t=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(i=>t.includes(i)))return e}}catch{}return null}function U(s){let e="",t=!1,i=!1;for(let l=0;l<s.length;l++){const c=s[l];if(i){e+=c,i=!1;continue}if(c==="\\"&&t){e+=c,i=!0;continue}if(c==='"'){t=!t,e+=c;continue}if(t&&c===`
`){e+="\\n";continue}if(t&&c==="\r"){e+="\\r";continue}e+=c}return e}function le(s){const e=s.clipboardData?.items;if(e){for(const t of Array.from(e))if(t.type.startsWith("image/")){s.preventDefault();const i=t.getAsFile();i&&H(i)}}}function oe(s){const e=s.dataTransfer?.files;if(e)for(const t of Array.from(e))t.type.startsWith("image/")&&H(t)}function ae(s){const e=s.target.files;if(e)for(const t of Array.from(e))H(t)}function H(s){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&x.value.push(e.result)},e.readAsDataURL(s)}function ie(s){x.value.splice(s,1)}function O(){const s=S.value.trim(),e=[...x.value];!s&&!e.length||C.value||(S.value="",x.value=[],T(()=>{_.value&&(_.value.style.height="auto")}),D("message",s,e),V(s,e))}function V(s,e){u.value.push({role:"user",text:s,images:e.length?e:void 0}),y(),C.value=!0,m.value="",I.value="";const t={role:"assistant",text:"",toolCalls:[]};u.value.push(t);const i=u.value.length-1;let l="",c;if(w.value)c=void 0;else{const d=u.value.slice(0,-1).filter(r=>(r.role==="user"||r.role==="assistant")&&r.text).slice(-20).map(r=>({role:r.role,content:r.text}));c=d.length>0?d:void 0}const B={sessionId:w.value,context:v.context,scenario:v.scenario,images:e.length?e:void 0,history:c};be(v.agentId,s,d=>{switch(d.type){case"thinking_delta":I.value+=d.text,y();break;case"text":case"text_delta":m.value+=d.text,y();break;case"tool_call":{const r={id:d.tool_call?.id??String(Date.now()),name:d.tool_call?.name??"tool",input:d.tool_call?.input?JSON.stringify(d.tool_call.input):void 0,status:"running"};u.value[i].toolCalls.push(r),l=r.id,y();break}case"tool_result":{const r=u.value[i].toolCalls?.find(E=>E.id===l);r&&(r.result=d.text,r.status="done"),y();break}case"done":case"error":{if(d.type==="done"&&d.sessionId){const k=!w.value;w.value=d.sessionId,k&&D("session-change",d.sessionId)}const r=u.value[i];if(r.text=m.value,r.thinking=I.value||void 0,v.applyable){const k=P(m.value);k?(r.applyData=k,console.log("[AiChat] applyData extracted:",k)):console.log("[AiChat] no applyData found in text length:",m.value.length)}const E=te(m.value);if(E.length>=2&&(r.options=E),d.type==="error"){r.text=`âŒ ${d.error}`;const k=r.toolCalls?.find(he=>he.status==="running");k&&(k.status="error")}C.value=!1,m.value="",I.value="",D("response",r.text),y();break}}},B)}function ce(){u.value=[]}function re(s){u.value.push(s),y()}async function ue(s){w.value=s,u.value=[],M.value=!0;try{const t=(await xe.get(v.agentId,s)).data.messages??[],i=[];t.some(c=>c.isCompact||c.role==="compaction")&&i.push({role:"system",text:"ğŸ“¦ æ›´æ—©çš„å†…å®¹å·²å‹ç¼©"});for(const c of t)c.role!=="compaction"&&i.push({role:c.role,text:c.text});u.value=i,y()}catch(e){console.error("[AiChat] resumeSession failed",e),u.value=[{role:"system",text:"âš ï¸ å†å²åŠ è½½å¤±è´¥ï¼Œç»§ç»­å¯¹è¯ä»å¯æ¥ç»­"}]}finally{M.value=!1}}function de(){w.value=void 0,u.value=[]}function pe(s){F(s),T(O)}return W({clearMessages:ce,appendMessage:re,sendText:pe,fillInput:F,messages:u,currentSessionId:w,resumeSession:ue,startNewSession:de}),fe(()=>{y()}),(s,e)=>(a(),o("div",{class:me(["ai-chat",{compact:g.compact,"has-bg":g.bgColor}]),style:ge(q.value)},[n("div",{class:"chat-messages",ref_key:"msgListRef",ref:L},[M.value?(a(),o("div",we,[...e[3]||(e[3]=[n("div",{class:"history-loading-dots"},[n("span"),n("span"),n("span")],-1),n("div",{class:"history-loading-text"},"åŠ è½½å†å²å¯¹è¯â€¦",-1)])])):p("",!0),!u.value.length&&!M.value?(a(),o("div",$e,[g.welcomeMessage?(a(),o("div",Se,h(g.welcomeMessage),1)):p("",!0),g.examples.length?(a(),o("div",Ie,[(a(!0),o(b,null,$(g.examples,(t,i)=>(a(),o("div",{key:i,class:"example-chip",onClick:l=>F(t)},h(t),9,Me))),128))])):p("",!0)])):p("",!0),(a(!0),o(b,null,$(u.value,(t,i)=>(a(),o(b,{key:i},[t.role==="user"?(a(),o("div",Te,[n("div",De,[t.images?.length?(a(),o("div",Ae,[(a(!0),o(b,null,$(t.images,(l,c)=>(a(),o("img",{key:c,src:l,class:"msg-img",onClick:B=>ee(l)},null,8,Ne))),128))])):p("",!0),n("div",Le,h(t.text),1)])])):t.role==="assistant"?(a(),o("div",Fe,[n("div",Je,[t.thinking?(a(),o("details",{key:0,class:"thinking-block",open:g.showThinking},[n("summary",Be,[e[4]||(e[4]=n("span",{class:"thinking-icon"},"ğŸ’­",-1)),e[5]||(e[5]=R(" æ€è€ƒè¿‡ç¨‹ ",-1)),n("span",Ee,h(t.thinking.length)+" å­—ç¬¦",1)]),n("pre",Re,h(t.thinking),1)],8,Oe)):p("",!0),n("div",je,[(a(!0),o(b,null,$(t.toolCalls,(l,c)=>(a(),o("div",{key:c,class:"tool-call-block"},[n("details",He,[n("summary",Ke,[e[6]||(e[6]=n("span",{class:"tool-icon"},"ğŸ”§",-1)),n("span",Pe,h(l.name),1),l.status==="running"?(a(),o("span",Ue,"è¿è¡Œä¸­â€¦")):l.status==="done"?(a(),o("span",Ve,"å®Œæˆ")):l.status==="error"?(a(),o("span",ze,"å¤±è´¥")):p("",!0)]),n("div",We,[l.input?(a(),o("div",Ye,[e[7]||(e[7]=n("div",{class:"tool-label"},"è¾“å…¥",-1)),n("pre",qe,h(Q(l.input)),1)])):p("",!0),l.result?(a(),o("div",Ge,[e[8]||(e[8]=n("div",{class:"tool-label"},"è¾“å‡º",-1)),n("pre",Qe,h(l.result.slice(0,800))+h(l.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):p("",!0)])])]))),128)),t.text?(a(),o("div",{key:0,class:"msg-text",innerHTML:K(t.text)},null,8,Xe)):p("",!0),t.applyData&&v.applyable?(a(),o("div",Ze,[n("div",et,[(a(!0),o(b,null,$(t.applyData,(l,c)=>(a(),o("div",{key:c,class:"apply-row"},[n("span",tt,h(c),1),n("span",st,h(String(l).slice(0,60))+h(String(l).length>60?"â€¦":""),1)]))),128))]),n("button",{class:"apply-btn",onClick:l=>s.$emit("apply",t.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,nt)])):p("",!0),n("div",lt,[n("button",{class:"act-btn",onClick:l=>X(t.text),title:A.value===i?"å·²å¤åˆ¶":"å¤åˆ¶"},h(A.value===i?"âœ“":"â˜"),9,ot),n("button",{class:"act-btn",onClick:l=>Z(i),title:"é‡è¯•"},"â†º",8,at),v.applyable&&!t.applyData&&se(t.text)?(a(),o("button",{key:0,class:"act-btn apply-manual-btn",onClick:l=>ne(t),title:"æ£€æµ‹åˆ°é…ç½® JSONï¼Œç‚¹å‡»åº”ç”¨"}," âš™ åº”ç”¨é…ç½® ",8,it)):p("",!0)])]),t.options&&t.options.length?(a(),o("div",ct,[(a(!0),o(b,null,$(t.options,(l,c)=>(a(),o("button",{key:c,class:"option-chip",onClick:B=>F(l)},h(l),9,rt))),128))])):p("",!0)])])):t.role==="system"?(a(),o("div",ut,[n("div",dt,h(t.text),1)])):p("",!0)],64))),128)),C.value?(a(),o("div",pt,[n("div",ht,[I.value&&g.showThinking?(a(),o("details",vt,[e[10]||(e[10]=n("summary",{class:"thinking-summary"},[n("span",{class:"thinking-icon"},"ğŸ’­"),R(" æ€è€ƒä¸­â€¦ ")],-1)),n("pre",ft,[R(h(I.value),1),e[9]||(e[9]=n("span",{class:"blink"},"â–Š",-1))])])):p("",!0),n("div",gt,[m.value?(a(),o("div",{key:1,class:"msg-text",innerHTML:K(m.value)},null,8,yt)):(a(),o("div",mt,[...e[11]||(e[11]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])),m.value?(a(),o("span",_t,"â–Š")):p("",!0)])])])):p("",!0)],512),N.value?(a(),o("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=t=>N.value="")},[n("img",{src:N.value,class:"img-preview-full"},null,8,kt)])):p("",!0),n("div",bt,[x.value.length?(a(),o("div",xt,[(a(!0),o(b,null,$(x.value,(t,i)=>(a(),o("div",{key:i,class:"attach-thumb"},[n("img",{src:t},null,8,Ct),n("button",{class:"remove-attach",onClick:l=>ie(i)},"Ã—",8,wt)]))),128))])):p("",!0),n("div",$t,[n("div",St,[ye(n("textarea",{ref_key:"inputRef",ref:_,"onUpdate:modelValue":e[1]||(e[1]=t=>S.value=t),placeholder:g.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:C.value||M.value,rows:"1",class:"chat-textarea",onKeydown:[z(j(O,["ctrl","prevent"]),["enter"]),z(j(O,["meta","prevent"]),["enter"])],onPaste:le,onInput:G,onDragover:e[2]||(e[2]=j(()=>{},["prevent"])),onDrop:j(oe,["prevent"])},null,40,It),[[_e,S.value]])]),n("div",Mt,[n("label",Tt,[e[12]||(e[12]=R(" ğŸ“ ",-1)),n("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:ae},null,32)]),n("button",{class:"send-btn",disabled:C.value||M.value||!S.value.trim()&&!x.value.length,onClick:O},[C.value?(a(),o("span",At)):(a(),o("span",Nt,"â†‘"))],8,Dt)])]),e[13]||(e[13]=n("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6))}}),Bt=Ce(Lt,[["__scopeId","data-v-11710133"]]);export{Bt as A};
