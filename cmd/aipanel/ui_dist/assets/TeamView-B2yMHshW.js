import{d as ye,o as f,c as y,F as H,b as n,t as N,a as s,w as a,k as Be,U as Le,l as ee,q as ge,n as Ve,f as m,x as te,r as g,h as ze,T as Fe,m as Te,i as de,j as W,g as b,E,N as Xe,e as Q,p as ce,M as fe}from"./index-BT96GM_8.js";import{r as G}from"./index-B6ZRKErS.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ye={class:"rel-pair"},Se={class:"rel-node"},Oe={class:"rel-node"},Pe={class:"type-grid"},je=["onClick"],We={class:"type-card-top"},Ge={class:"type-desc"},qe=ye({__name:"RelTypeForm",props:{fromName:{},toName:{},type:{},strength:{},desc:{}},emits:["update:type","update:strength","update:desc"],setup(U){const _=U,Y=te(()=>[{value:"上级",color:"#f56c6c",desc:`${_.toName} 是 ${_.fromName} 的上级，负责领导和管理`},{value:"下级",color:"#e6a23c",desc:`${_.toName} 是 ${_.fromName} 的下级，接受指导和分配任务`},{value:"平级协作",color:"#409eff",desc:`${_.fromName} 与 ${_.toName} 并列合作，地位平等`},{value:"支持",color:"#67c23a",desc:`${_.toName} 为 ${_.fromName} 提供支持和辅助`}]);return(D,d)=>{const B=g("el-icon"),z=g("el-radio-button"),oe=g("el-radio-group"),S=g("el-form-item"),ne=g("el-input"),I=g("el-form");return f(),y(H,null,[n("div",Ye,[n("span",Se,N(U.fromName),1),s(B,{style:{color:"#c0c4cc","flex-shrink":"0","font-size":"18px"}},{default:a(()=>[s(Be(Le))]),_:1}),n("span",Oe,N(U.toName),1)]),n("div",Pe,[(f(!0),y(H,null,ee(Y.value,k=>(f(),y("div",{key:k.value,class:ge(["type-card",{active:U.type===k.value}]),onClick:re=>D.$emit("update:type",k.value)},[n("div",We,[n("span",{class:"type-tag",style:Ve({background:k.color+"18",color:k.color})},N(k.value),5)]),n("div",Ge,N(k.desc),1)],10,je))),128))]),s(I,{"label-width":"72px",style:{"margin-top":"16px"}},{default:a(()=>[s(S,{label:"关系强度"},{default:a(()=>[s(oe,{"model-value":U.strength,"onUpdate:modelValue":d[0]||(d[0]=k=>D.$emit("update:strength",k))},{default:a(()=>[s(z,{value:"核心"},{default:a(()=>[...d[2]||(d[2]=[m("核心",-1)])]),_:1}),s(z,{value:"常用"},{default:a(()=>[...d[3]||(d[3]=[m("常用",-1)])]),_:1}),s(z,{value:"偶尔"},{default:a(()=>[...d[4]||(d[4]=[m("偶尔",-1)])]),_:1})]),_:1},8,["model-value"])]),_:1}),s(S,{label:"说明"},{default:a(()=>[s(ne,{"model-value":U.desc,"onUpdate:modelValue":d[1]||(d[1]=k=>D.$emit("update:desc",k)),placeholder:"可选备注"},null,8,["model-value"])]),_:1})]),_:1})],64)}}}),me=he(qe,[["__scopeId","data-v-0bce55d0"]]),He={class:"team-view"},Ie={class:"page-header"},Je={style:{display:"flex",gap:"8px"}},Ke={key:0,class:"empty-state"},Qe={key:0,class:"connect-banner"},Ze={style:{margin:"0 4px"}},et=["width","height"],tt=["x1","y1","x2","y2"],ot=["x1","y1","x2","y2","onClick"],nt=["x1","y1","x2","y2","stroke","stroke-width"],st=["x","y","fill"],lt=["transform","onMousedown","onClick"],at={key:0,r:"37",fill:"none",stroke:"#409eff","stroke-width":"2.5","stroke-dasharray":"7,3",class:"selection-ring"},rt={key:1,r:"33",fill:"rgba(64,158,255,0.06)",stroke:"#409eff","stroke-width":"1.5","stroke-opacity":"0.5"},it=["fill"],ut={"text-anchor":"middle","dominant-baseline":"central",fill:"#fff","font-weight":"700","font-size":"15","font-family":"system-ui, sans-serif"},dt=["fill"],ct={"text-anchor":"middle",y:"46","font-size":"12",fill:"#303133","font-family":"system-ui, sans-serif","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},ft={"text-anchor":"middle",y:"58","font-size":"10",fill:"#909399","font-family":"system-ui, monospace"},mt={key:1,class:"no-edge-hint"},vt={class:"legend"},pt={class:"legend-item"},yt={class:"legend-item"},gt={width:"28",height:"8"},ht=["stroke-width"],q=28,ve=160,Z=90,pe=80,xt=ye({__name:"TeamView",setup(U){const _=b(),Y=b(),D=b(!1),d=b({nodes:[],edges:[]}),B=b(860),z={核心:4,常用:2.5,偶尔:1.5},oe={上级:"#f56c6c",下级:"#e6a23c",平级协作:"#409eff",支持:"#67c23a"};function S(o){return oe[o]??"#94a3b8"}function ne(o,e){const r={};o.forEach(u=>{r[u.id]=0});const l=o.length+2;for(let u=0;u<l;u++){let C=!1;for(const x of e){const V=r[x.from]??0,X=r[x.to]??0;if(x.type==="上级"){const R=V-1;X>R&&(r[x.to]=R,C=!0)}else if(x.type==="下级"){const R=V+1;X<R&&(r[x.to]=R,C=!0)}}if(!C)break}const i=Object.values(r),h=i.length?Math.min(...i):0;return o.forEach(u=>{r[u.id]=(r[u.id]??0)-h}),r}const I=te(()=>ne(d.value.nodes,d.value.edges)),k=te(()=>{const o=Object.values(I.value).reduce((e,r)=>Math.max(e,r),0);return Math.max(600,Z+o*ve+160)}),re=te(()=>{const o=d.value.nodes,e=I.value,r=B.value,l={};o.forEach(h=>{const u=e[h.id]??0;l[u]||(l[u]=[]),l[u].push(h.id)});const i={};for(const[h,u]of Object.entries(l)){const C=Number(h),x=Z+C*ve,V=r-pe*2,X=u.length>1?V/(u.length-1):0;u.forEach((R,K)=>{i[R]={x:Math.round(u.length===1?r/2:pe+K*X),y:Math.round(x)}})}return i}),O=b({}),w=b(null),J=b({x:400,y:Z});function M(o){return O.value[o]??re.value[o]??{x:B.value/2,y:Z}}function xe(o,e){o.preventDefault();const r=M(e);w.value={id:e,startClientX:o.clientX,startClientY:o.clientY,startNodeX:r.x,startNodeY:r.y,moved:!1},document.addEventListener("mousemove",se),document.addEventListener("mouseup",le)}function se(o){if(_.value){const l=_.value.getBoundingClientRect();J.value={x:o.clientX-l.left,y:o.clientY-l.top}}if(!w.value)return;const e=o.clientX-w.value.startClientX,r=o.clientY-w.value.startClientY;if((Math.abs(e)>4||Math.abs(r)>4)&&(w.value.moved=!0),w.value.moved){const l=q+4,i=B.value-q-4,h=q+4,u=k.value-q-24;O.value={...O.value,[w.value.id]:{x:Math.round(Math.max(l,Math.min(i,w.value.startNodeX+e))),y:Math.round(Math.max(h,Math.min(u,w.value.startNodeY+r)))}}}}function le(){w.value=null,document.removeEventListener("mousemove",se),document.removeEventListener("mouseup",le)}function _e(o){if(!w.value&&_.value){const e=_.value.getBoundingClientRect();J.value={x:o.clientX-e.left,y:o.clientY-e.top}}}function ke(){v.value=null}const v=b(null);function we(o){if(w.value?.moved)return;if(!v.value){v.value=o;return}if(v.value===o){v.value=null;return}const e=v.value;v.value=null,Ee(e,o)}function A(o,e,r){const l=M(o),i=M(e),h=i.x-l.x,u=i.y-l.y,C=Math.sqrt(h*h+u*u)||1,x=q+3;return r==="start"?{x:l.x+h/C*x,y:l.y+u/C*x}:{x:i.x-h/C*x,y:i.y-u/C*x}}function Ce(o){return z[o]??1.5}const ie=["#409EFF","#67C23A","#E6A23C","#F56C6C","#7C3AED","#0891B2","#B45309","#64748B"];function be(o){let e=0;for(let r=0;r<o.length;r++)e=o.charCodeAt(r)+((e<<5)-e);return ie[Math.abs(e)%ie.length]??"#409EFF"}function Me(o){return(o||"?").charAt(0).toUpperCase()}function L(o){return d.value.nodes.find(e=>e.id===o)?.name??o}function $e(){O.value={},E.success("已重置为自动布局")}const P=b(!1),p=ce({from:"",to:"",type:"平级协作",strength:"常用",desc:""}),$=b(!1);function Ee(o,e){if(d.value.edges.some(l=>l.from===o&&l.to===e||l.from===e&&l.to===o)){const l=d.value.edges.find(i=>i.from===o&&i.to===e||i.from===e&&i.to===o);ue(l);return}p.from=o,p.to=e,p.type="平级协作",p.strength="常用",p.desc="",P.value=!0}async function Ne(){if(!$.value){$.value=!0;try{await G.putEdge(p.from,p.to,p.type,p.strength,p.desc),E.success("关系已建立"),P.value=!1,await T()}catch{E.error("保存失败")}finally{$.value=!1}}}const F=b(!1),c=ce({from:"",to:"",type:"平级协作",strength:"常用",desc:""});function ue(o){c.from=o.from,c.to=o.to,c.type=o.type,c.strength=o.strength,c.desc=o.label,F.value=!0}async function Re(){if(!$.value){$.value=!0;try{await G.putEdge(c.from,c.to,c.type,c.strength,c.desc),E.success("关系已更新"),F.value=!1,await T()}catch{E.error("保存失败")}finally{$.value=!1}}}async function De(){try{await fe.confirm(`删除 ${L(c.from)} ↔ ${L(c.to)} 的关系？`,"删除关系",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"})}catch{return}$.value=!0;try{await G.deleteEdge(c.from,c.to),E.success("关系已删除"),F.value=!1,await T()}catch{E.error("删除失败")}finally{$.value=!1}}async function T(){D.value=!0;try{const o=await G.graph();d.value=o.data}catch{E.error("加载图谱失败")}finally{D.value=!1}}async function Ae(){try{await fe.confirm("将清空所有成员的关系，不可恢复。确认吗？","清空所有关系",{confirmButtonText:"确认清空",cancelButtonText:"取消",type:"warning"})}catch{return}try{await G.clearAll(),E.success("已清空所有成员关系"),await T()}catch{E.error("清空失败")}}let ae=null;return ze(()=>{T(),Y.value&&(ae=new ResizeObserver(o=>{const e=o[0]?.contentRect.width;e&&e>100&&(B.value=Math.floor(e),O.value={})}),ae.observe(Y.value))}),Fe(()=>{ae?.disconnect(),document.removeEventListener("mousemove",se),document.removeEventListener("mouseup",le)}),(o,e)=>{const r=g("Grid"),l=g("el-icon"),i=g("el-button"),h=g("Refresh"),u=g("Delete"),C=g("Share"),x=g("Link"),V=g("el-card"),X=g("ArrowUp"),R=g("ArrowDown"),K=g("el-dialog"),Ue=Xe("loading");return f(),y("div",He,[n("div",Ie,[e[14]||(e[14]=n("h2",null,"团队关系图谱",-1)),n("div",Je,[s(i,{size:"small",onClick:$e},{default:a(()=>[s(l,null,{default:a(()=>[s(r)]),_:1}),e[11]||(e[11]=m(" 整理 ",-1))]),_:1}),s(i,{size:"small",onClick:T},{default:a(()=>[s(l,null,{default:a(()=>[s(h)]),_:1}),e[12]||(e[12]=m(" 刷新 ",-1))]),_:1}),s(i,{size:"small",type:"danger",plain:"",onClick:Ae},{default:a(()=>[s(l,null,{default:a(()=>[s(u)]),_:1}),e[13]||(e[13]=m(" 清空关系 ",-1))]),_:1})])]),Te((f(),de(V,{class:"graph-card"},{default:a(()=>[!D.value&&!d.value.nodes.length?(f(),y("div",Ke,[s(l,{style:{"font-size":"64px",color:"#c0c4cc",display:"block",margin:"0 auto 16px"}},{default:a(()=>[s(C)]),_:1}),e[15]||(e[15]=n("p",{style:{color:"#909399","text-align":"center",margin:"0"}},"暂无成员数据",-1))])):(f(),y("div",{key:1,class:"graph-container",ref_key:"graphContainerRef",ref:Y},[v.value?(f(),y("div",Qe,[s(l,{style:{"margin-right":"6px"}},{default:a(()=>[s(x)]),_:1}),e[17]||(e[17]=m(" 连线模式：已选中 ",-1)),n("strong",Ze,N(L(v.value)),1),e[18]||(e[18]=m("，点击另一个成员建立关系 ",-1)),s(i,{size:"small",text:"",style:{"margin-left":"8px"},onClick:e[0]||(e[0]=t=>v.value=null)},{default:a(()=>[...e[16]||(e[16]=[m("取消",-1)])]),_:1})])):W("",!0),(f(),y("svg",{ref_key:"svgRef",ref:_,width:B.value,height:k.value,class:"graph-svg",onMousemove:_e,onClick:Q(ke,["self"]),style:{display:"block",width:"100%"}},[v.value?(f(),y("line",{key:0,x1:M(v.value).x,y1:M(v.value).y,x2:J.value.x,y2:J.value.y,stroke:"#409eff","stroke-width":"2","stroke-dasharray":"6,4","stroke-opacity":"0.7","pointer-events":"none"},null,8,tt)):W("",!0),(f(!0),y(H,null,ee(d.value.edges,t=>(f(),y("g",{key:`${t.from}|${t.to}`},[n("line",{x1:A(t.from,t.to,"start").x,y1:A(t.from,t.to,"start").y,x2:A(t.from,t.to,"end").x,y2:A(t.from,t.to,"end").y,stroke:"transparent","stroke-width":"14",style:{cursor:"pointer"},onClick:Q(j=>ue(t),["stop"])},null,8,ot),n("line",{x1:A(t.from,t.to,"start").x,y1:A(t.from,t.to,"start").y,x2:A(t.from,t.to,"end").x,y2:A(t.from,t.to,"end").y,stroke:S(t.type),"stroke-width":Ce(t.strength),"stroke-opacity":"0.7","stroke-linecap":"round","pointer-events":"none",class:"graph-edge"},null,8,nt),n("text",{x:(M(t.from).x+M(t.to).x)/2,y:(M(t.from).y+M(t.to).y)/2-6,"text-anchor":"middle","font-size":"10",fill:S(t.type),"pointer-events":"none","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},N(t.type),9,st)]))),128)),(f(!0),y(H,null,ee(d.value.nodes,t=>(f(),y("g",{key:t.id,transform:`translate(${M(t.id).x}, ${M(t.id).y})`,class:ge(["graph-node",{"node-selected":v.value===t.id},{"node-target":!!v.value&&v.value!==t.id}]),style:{cursor:"grab"},onMousedown:Q(j=>xe(j,t.id),["stop"]),onClick:Q(()=>we(t.id),["stop"])},[v.value===t.id?(f(),y("circle",at)):v.value?(f(),y("circle",rt)):W("",!0),e[19]||(e[19]=n("circle",{r:"30",fill:"rgba(0,0,0,0.07)",transform:"translate(2,3)"},null,-1)),n("circle",{r:"28",fill:be(t.id),stroke:"#fff","stroke-width":"2.5"},null,8,it),n("text",ut,N(Me(t.id)),1),n("circle",{cx:"20",cy:"-20",r:"6",fill:t.status==="running"?"#67C23A":"#c0c4cc",stroke:"#fff","stroke-width":"1.5"},null,8,dt),n("text",ct,N(t.name),1),n("text",ft,N(t.id),1)],42,lt))),128))],40,et)),d.value.edges.length?W("",!0):(f(),y("div",mt," 点击任意成员选中，再点击另一个成员即可创建关系连线 "))],512))]),_:1})),[[Ue,D.value]]),d.value.nodes.length?(f(),de(V,{key:0,class:"legend-card"},{default:a(()=>[n("div",vt,[e[22]||(e[22]=n("span",{class:"legend-title"},"布局规则：",-1)),n("span",pt,[s(l,null,{default:a(()=>[s(X)]),_:1}),e[20]||(e[20]=m(" 上方 = 上级",-1))]),e[23]||(e[23]=n("span",{class:"legend-item"},"— 同层 = 平级",-1)),n("span",yt,[s(l,null,{default:a(()=>[s(R)]),_:1}),e[21]||(e[21]=m(" 下方 = 下级",-1))]),e[24]||(e[24]=n("span",{class:"legend-divider"},"|",-1)),e[25]||(e[25]=n("span",{class:"legend-title"},"线粗：",-1)),(f(),y(H,null,ee(z,(t,j)=>n("span",{key:j,class:"legend-item"},[(f(),y("svg",gt,[n("line",{x1:"0",y1:"4",x2:"28",y2:"4",stroke:"#64748b","stroke-width":t,"stroke-linecap":"round"},null,8,ht)])),m(" "+N(j),1)])),64)),e[26]||(e[26]=n("span",{class:"legend-divider"},"|",-1)),e[27]||(e[27]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#67C23A"})]),m(" 运行中 ")],-1)),e[28]||(e[28]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#c0c4cc"})]),m(" 空闲 ")],-1))])]),_:1})):W("",!0),s(K,{modelValue:P.value,"onUpdate:modelValue":e[5]||(e[5]=t=>P.value=t),title:"建立关系",width:"460px","close-on-click-modal":!1},{footer:a(()=>[s(i,{onClick:e[4]||(e[4]=t=>P.value=!1)},{default:a(()=>[...e[29]||(e[29]=[m("取消",-1)])]),_:1}),s(i,{type:"primary",loading:$.value,onClick:Ne},{default:a(()=>[...e[30]||(e[30]=[m("建立",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(me,{"from-name":L(p.from),"to-name":L(p.to),type:p.type,"onUpdate:type":e[1]||(e[1]=t=>p.type=t),strength:p.strength,"onUpdate:strength":e[2]||(e[2]=t=>p.strength=t),desc:p.desc,"onUpdate:desc":e[3]||(e[3]=t=>p.desc=t)},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"]),s(K,{modelValue:F.value,"onUpdate:modelValue":e[10]||(e[10]=t=>F.value=t),title:"编辑关系",width:"460px","close-on-click-modal":!1},{footer:a(()=>[s(i,{type:"danger",plain:"",loading:$.value,onClick:De},{default:a(()=>[...e[31]||(e[31]=[m("删除关系",-1)])]),_:1},8,["loading"]),s(i,{onClick:e[9]||(e[9]=t=>F.value=!1)},{default:a(()=>[...e[32]||(e[32]=[m("取消",-1)])]),_:1}),s(i,{type:"primary",loading:$.value,onClick:Re},{default:a(()=>[...e[33]||(e[33]=[m("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(me,{"from-name":L(c.from),"to-name":L(c.to),type:c.type,"onUpdate:type":e[6]||(e[6]=t=>c.type=t),strength:c.strength,"onUpdate:strength":e[7]||(e[7]=t=>c.strength=t),desc:c.desc,"onUpdate:desc":e[8]||(e[8]=t=>c.desc=t)},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"])])}}}),Ct=he(xt,[["__scopeId","data-v-312e4292"]]);export{Ct as default};
