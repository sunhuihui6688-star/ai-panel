import{d as Ce,g as y,B as xe,h as we,c as a,n as $e,q as Se,b as n,j as f,t as g,F as I,l as M,a as k,w as A,f as K,m as Ie,e as U,O as X,C as Te,x as De,D as J,r as N,o,i as Z}from"./index-jtxkIkwB.js";import{n as Me,j as Ae}from"./index-B6ZRKErS.js";import{_ as Ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Be={key:0,class:"history-loading"},Oe={key:1,class:"chat-empty"},Fe={key:0,class:"welcome-msg"},Le={key:1,class:"examples"},Je=["onClick"],Re={key:0,class:"msg-row user"},Ee={class:"msg-bubble user"},je={key:0,class:"msg-images"},Pe=["src","onClick"],He={class:"msg-text"},Ve={key:1,class:"msg-row assistant"},Ke={class:"msg-col"},Ue=["open"],We={class:"thinking-summary"},ze={class:"thinking-len"},Ye={class:"thinking-content"},qe={class:"msg-bubble assistant"},Ge={class:"tool-details"},Qe={class:"tool-summary"},Xe={class:"tool-name"},Ze={key:0,class:"tool-status running"},et={key:1,class:"tool-status done"},tt={key:2,class:"tool-status error"},st={class:"tool-body"},nt={key:0,class:"tool-section"},ot={class:"tool-pre"},lt={key:1,class:"tool-section"},at={class:"tool-pre result"},it=["innerHTML"],ct={key:1,class:"apply-card"},rt={class:"apply-preview"},ut={class:"apply-key"},dt={class:"apply-val"},pt=["onClick"],ht={class:"msg-actions"},ft=["onClick","title"],vt=["onClick"],gt=["onClick"],mt={key:1,class:"option-chips"},_t=["onClick"],yt={key:2,class:"msg-row system"},kt={class:"msg-system"},bt={key:2,class:"msg-row assistant"},Ct={class:"msg-col"},xt={key:0,class:"thinking-block",open:""},wt={class:"thinking-summary"},$t={class:"thinking-content"},St={class:"msg-bubble assistant"},It={key:0,class:"typing-dots"},Tt=["innerHTML"],Dt={key:2,class:"blink"},Mt=["src"],At={class:"chat-input-area"},Nt={key:0,class:"attachments-bar"},Bt=["src"],Ot=["onClick"],Ft={class:"input-row"},Lt={class:"textarea-wrap"},Jt=["placeholder","disabled","onKeydown"],Rt={class:"input-actions"},Et={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},jt=["disabled"],Pt={key:0,class:"spinner"},Ht={key:1},Vt=Ce({__name:"AiChat",props:{agentId:{},sessionId:{},context:{},scenario:{},skillId:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply","session-change","streaming-change"],setup(b,{expose:ee,emit:te}){const _=b,L=te,h=y(_.initialMessages?[..._.initialMessages]:[]),B=y(""),T=y([]),$=y(!1);xe($,t=>L("streaming-change",t));const C=y(""),O=y(""),R=y(null),E=y(""),D=y(_.sessionId),F=y(!1),j=y(),S=y(),se=De(()=>({height:_.height??"100%","--bg":_.bgColor??"transparent"}));function x(){J(()=>{j.value&&(j.value.scrollTop=j.value.scrollHeight)})}function ne(){S.value&&(S.value.style.height="auto",S.value.style.height=Math.min(S.value.scrollHeight,160)+"px")}function P(t){B.value=t,J(()=>S.value?.focus())}function oe(t){try{return JSON.stringify(JSON.parse(t),null,2)}catch{return t}}function le(t){navigator.clipboard?.writeText(t);const e=h.value.findIndex(l=>l.text===t);R.value=e,setTimeout(()=>{R.value=null},1500)}function ae(t){for(let e=t-1;e>=0;e--){const l=h.value[e];if(l&&l.role==="user"){const i=l.text,p=l.images??[];h.value.splice(e,h.value.length-e),z(i,p);return}}}function ie(t){E.value=t}function Y(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(l,i,p)=>`<pre class="code-block${i?" lang-"+i:""}"><code>${p}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function ce(t){const e=t.split(`
`),l=[],i=/^([ğŸ™ğŸ˜„ğŸŒğŸ›ğŸ“šğŸ¨ğŸ’¼ğŸ¤–âš½ğŸ¯âœ…âŒğŸ”¥ğŸ’¡ğŸğŸš€ğŸŒŸğŸ’ğŸªğŸ­ğŸ¬ğŸ¤]|[\u{1F300}-\u{1FFFF}]|[\u{2600}-\u{27BF}])\s+(.{4,40})/u;for(const p of e){const r=p.replace(/^[-*â€¢]\s*/,"").trim();if(r.match(i)){const v=r.replace(/[ï¼š:ã€‚ï¼Œ,]$/,"").trim();v.length>=5&&l.push(v)}}return l.slice(0,5)}function re(t){return t?/\{[\s\S]{30,}\}/.test(t)&&(t.includes('"name"')||t.includes('"identity"')||t.includes('"soul"')||t.includes('"IDENTITY"')||t.includes('"SOUL"')):!1}function ue(t){const e=G(t.text);console.log("[AiChat] manualApply result:",e),e?(t.applyData=e,J(()=>L("apply",e))):alert("æœªèƒ½ä»æ¶ˆæ¯ä¸­æå–åˆ°é…ç½® JSONï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶")}function q(t,e=0){const l=t.indexOf("{",e);if(l===-1)return null;let i=0,p=!1,r=!1;for(let u=l;u<t.length;u++){const v=t[u];if(r){r=!1;continue}if(v==="\\"&&p){r=!0;continue}if(v==='"'){p=!p;continue}if(!p){if(v==="{")i++;else if(v==="}"&&(i--,i===0))return{raw:t.slice(l,u+1),end:u+1}}}return null}function G(t){const e=/```(?:json)?\s*\n?([\s\S]*?)```/g,l=[];let i;for(;(i=e.exec(t))!==null;){const u=(i[1]??"").trim();u.startsWith("{")&&l.push(u)}for(let u=l.length-1;u>=0;u--){const v=l[u],d=q(v);if(!d)continue;const s=H(d.raw)??H(Q(d.raw));if(s)return s}const p=[];let r=0;for(;r<t.length;){const u=q(t,r);if(!u)break;p.push(u.raw),r=u.end}for(let u=p.length-1;u>=0;u--){const v=p[u],d=H(v)??H(Q(v));if(d)return d}return null}function H(t){try{const e=JSON.parse(t);if(e&&typeof e=="object"&&!Array.isArray(e)){const l=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(i=>l.includes(i)))return e}}catch{}return null}function Q(t){let e="",l=!1,i=!1;for(let p=0;p<t.length;p++){const r=t[p];if(i){e+=r,i=!1;continue}if(r==="\\"&&l){e+=r,i=!0;continue}if(r==='"'){l=!l,e+=r;continue}if(l&&r===`
`){e+="\\n";continue}if(l&&r==="\r"){e+="\\r";continue}e+=r}return e}function de(t){const e=t.clipboardData?.items;if(e){for(const l of Array.from(e))if(l.type.startsWith("image/")){t.preventDefault();const i=l.getAsFile();i&&W(i)}}}function pe(t){const e=t.dataTransfer?.files;if(e)for(const l of Array.from(e))l.type.startsWith("image/")&&W(l)}function he(t){const e=t.target.files;if(e)for(const l of Array.from(e))W(l)}function W(t){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&T.value.push(e.result)},e.readAsDataURL(t)}function fe(t){T.value.splice(t,1)}function V(){const t=B.value.trim(),e=[...T.value];!t&&!e.length||$.value||(B.value="",T.value=[],J(()=>{S.value&&(S.value.style.height="auto")}),L("message",t,e),z(t,e))}function z(t,e,l=!1){l||(h.value.push({role:"user",text:t,images:e.length?e:void 0}),x()),$.value=!0,C.value="",O.value="";const i={role:"assistant",text:"",toolCalls:[]};h.value.push(i),l&&x();const p=h.value.length-1;let r="",u;if(D.value)u=void 0;else{const d=h.value.slice(0,-1).filter(s=>(s.role==="user"||s.role==="assistant")&&s.text).slice(-20).map(s=>({role:s.role,content:s.text}));u=d.length>0?d:void 0}const v={sessionId:D.value,context:_.context,scenario:_.scenario,skillId:_.skillId,images:e.length?e:void 0,history:u};Me(_.agentId,t,d=>{switch(d.type){case"thinking_delta":O.value+=d.text,x();break;case"text":case"text_delta":C.value+=d.text,x();break;case"tool_call":{const s={id:d.tool_call?.id??String(Date.now()),name:d.tool_call?.name??"tool",input:d.tool_call?.input?JSON.stringify(d.tool_call.input):void 0,status:"running"};h.value[p].toolCalls.push(s),r=s.id,x();break}case"tool_result":{const s=h.value[p].toolCalls?.find(m=>m.id===r);s&&(s.result=d.text,s.status="done"),x();break}case"done":case"error":{if(d.type==="done"&&d.sessionId){const c=!D.value;D.value=d.sessionId,c&&L("session-change",d.sessionId)}const s=h.value[p];if(s.text=C.value,s.thinking=O.value||void 0,_.applyable){const c=G(C.value);c?(s.applyData=c,console.log("[AiChat] applyData extracted:",c)):console.log("[AiChat] no applyData found in text length:",C.value.length)}const m=ce(C.value);if(m.length>=2&&(s.options=m),d.type==="error"){s.text=`[é”™è¯¯] ${d.error}`;const c=s.toolCalls?.find(w=>w.status==="running");c&&(c.status="error")}$.value=!1,C.value="",O.value="",L("response",s.text),x();break}}},v)}function ve(){h.value=[]}function ge(t){h.value.push(t),x()}async function me(t){D.value=t,h.value=[],F.value=!0;try{const l=(await Ae.get(_.agentId,t)).data.messages??[],i=[];l.some(r=>r.isCompact||r.role==="compaction")&&i.push({role:"system",text:"æ›´æ—©çš„å†…å®¹å·²å‹ç¼©"});for(const r of l)r.role!=="compaction"&&i.push({role:r.role,text:r.text});h.value=i,x()}catch(e){e?.response?.status===404?h.value=[]:(console.error("[AiChat] resumeSession failed",e),h.value=[{role:"system",text:"å†å²åŠ è½½å¤±è´¥ï¼Œç»§ç»­å¯¹è¯ä»å¯æ¥ç»­"}])}finally{F.value=!1}}function _e(){D.value=void 0,h.value=[]}function ye(t){P(t),J(V)}function ke(t){z(t,[],!0)}return ee({clearMessages:ve,appendMessage:ge,sendText:ye,sendSilent:ke,fillInput:P,messages:h,streaming:$,currentSessionId:D,resumeSession:me,startNewSession:_e}),we(()=>{x()}),(t,e)=>{const l=N("ChatRound"),i=N("el-icon"),p=N("Tools"),r=N("Check"),u=N("CopyDocument"),v=N("Setting"),d=N("Paperclip");return o(),a("div",{class:Se(["ai-chat",{compact:b.compact,"has-bg":b.bgColor}]),style:$e(se.value)},[n("div",{class:"chat-messages",ref_key:"msgListRef",ref:j},[F.value?(o(),a("div",Be,[...e[3]||(e[3]=[n("div",{class:"history-loading-dots"},[n("span"),n("span"),n("span")],-1),n("div",{class:"history-loading-text"},"åŠ è½½å†å²å¯¹è¯â€¦",-1)])])):f("",!0),!h.value.length&&!F.value?(o(),a("div",Oe,[b.welcomeMessage?(o(),a("div",Fe,g(b.welcomeMessage),1)):f("",!0),b.examples.length?(o(),a("div",Le,[(o(!0),a(I,null,M(b.examples,(s,m)=>(o(),a("div",{key:m,class:"example-chip",onClick:c=>P(s)},g(s),9,Je))),128))])):f("",!0)])):f("",!0),(o(!0),a(I,null,M(h.value,(s,m)=>(o(),a(I,{key:m},[s.role==="user"?(o(),a("div",Re,[n("div",Ee,[s.images?.length?(o(),a("div",je,[(o(!0),a(I,null,M(s.images,(c,w)=>(o(),a("img",{key:w,src:c,class:"msg-img",onClick:be=>ie(c)},null,8,Pe))),128))])):f("",!0),n("div",He,g(s.text),1)])])):s.role==="assistant"?(o(),a("div",Ve,[n("div",Ke,[s.thinking?(o(),a("details",{key:0,class:"thinking-block",open:b.showThinking},[n("summary",We,[k(i,{class:"thinking-icon"},{default:A(()=>[k(l)]),_:1}),e[4]||(e[4]=K(" æ€è€ƒè¿‡ç¨‹ ",-1)),n("span",ze,g(s.thinking.length)+" å­—ç¬¦",1)]),n("pre",Ye,g(s.thinking),1)],8,Ue)):f("",!0),n("div",qe,[(o(!0),a(I,null,M(s.toolCalls,(c,w)=>(o(),a("div",{key:w,class:"tool-call-block"},[n("details",Ge,[n("summary",Qe,[k(i,{class:"tool-icon"},{default:A(()=>[k(p)]),_:1}),n("span",Xe,g(c.name),1),c.status==="running"?(o(),a("span",Ze,"è¿è¡Œä¸­â€¦")):c.status==="done"?(o(),a("span",et,"å®Œæˆ")):c.status==="error"?(o(),a("span",tt,"å¤±è´¥")):f("",!0)]),n("div",st,[c.input?(o(),a("div",nt,[e[5]||(e[5]=n("div",{class:"tool-label"},"è¾“å…¥",-1)),n("pre",ot,g(oe(c.input)),1)])):f("",!0),c.result?(o(),a("div",lt,[e[6]||(e[6]=n("div",{class:"tool-label"},"è¾“å‡º",-1)),n("pre",at,g(c.result.slice(0,800))+g(c.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):f("",!0)])])]))),128)),s.text?(o(),a("div",{key:0,class:"msg-text",innerHTML:Y(s.text)},null,8,it)):f("",!0),s.applyData&&_.applyable?(o(),a("div",ct,[n("div",rt,[(o(!0),a(I,null,M(s.applyData,(c,w)=>(o(),a("div",{key:w,class:"apply-row"},[n("span",ut,g(w),1),n("span",dt,g(String(c).slice(0,60))+g(String(c).length>60?"â€¦":""),1)]))),128))]),n("button",{class:"apply-btn",onClick:c=>t.$emit("apply",s.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,pt)])):f("",!0),n("div",ht,[n("button",{class:"act-btn",onClick:c=>le(s.text),title:R.value===m?"å·²å¤åˆ¶":"å¤åˆ¶"},[R.value===m?(o(),Z(i,{key:0},{default:A(()=>[k(r)]),_:1})):(o(),Z(i,{key:1},{default:A(()=>[k(u)]),_:1}))],8,ft),n("button",{class:"act-btn",onClick:c=>ae(m),title:"é‡è¯•"},"â†º",8,vt),_.applyable&&!s.applyData&&re(s.text)?(o(),a("button",{key:0,class:"act-btn apply-manual-btn",onClick:c=>ue(s),title:"æ£€æµ‹åˆ°é…ç½® JSONï¼Œç‚¹å‡»åº”ç”¨"},[k(i,null,{default:A(()=>[k(v)]),_:1}),e[7]||(e[7]=K(" åº”ç”¨é…ç½® ",-1))],8,gt)):f("",!0)])]),s.options&&s.options.length?(o(),a("div",mt,[(o(!0),a(I,null,M(s.options,(c,w)=>(o(),a("button",{key:w,class:"option-chip",onClick:be=>P(c)},g(c),9,_t))),128))])):f("",!0)])])):s.role==="system"?(o(),a("div",yt,[n("div",kt,g(s.text),1)])):f("",!0)],64))),128)),$.value?(o(),a("div",bt,[n("div",Ct,[O.value&&b.showThinking?(o(),a("details",xt,[n("summary",wt,[k(i,{class:"thinking-icon"},{default:A(()=>[k(l)]),_:1}),e[8]||(e[8]=K(" æ€è€ƒä¸­â€¦ ",-1))]),n("pre",$t,[K(g(O.value),1),e[9]||(e[9]=n("span",{class:"blink"},"â–Š",-1))])])):f("",!0),n("div",St,[C.value?(o(),a("div",{key:1,class:"msg-text",innerHTML:Y(C.value)},null,8,Tt)):(o(),a("div",It,[...e[10]||(e[10]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])),C.value?(o(),a("span",Dt,"â–Š")):f("",!0)])])])):f("",!0)],512),E.value?(o(),a("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=s=>E.value="")},[n("img",{src:E.value,class:"img-preview-full"},null,8,Mt)])):f("",!0),n("div",At,[T.value.length?(o(),a("div",Nt,[(o(!0),a(I,null,M(T.value,(s,m)=>(o(),a("div",{key:m,class:"attach-thumb"},[n("img",{src:s},null,8,Bt),n("button",{class:"remove-attach",onClick:c=>fe(m)},"Ã—",8,Ot)]))),128))])):f("",!0),n("div",Ft,[n("div",Lt,[Ie(n("textarea",{ref_key:"inputRef",ref:S,"onUpdate:modelValue":e[1]||(e[1]=s=>B.value=s),placeholder:b.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:$.value||F.value,rows:"1",class:"chat-textarea",onKeydown:[X(U(V,["ctrl","prevent"]),["enter"]),X(U(V,["meta","prevent"]),["enter"])],onPaste:de,onInput:ne,onDragover:e[2]||(e[2]=U(()=>{},["prevent"])),onDrop:U(pe,["prevent"])},null,40,Jt),[[Te,B.value]])]),n("div",Rt,[n("label",Et,[k(i,null,{default:A(()=>[k(d)]),_:1}),n("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:he},null,32)]),n("button",{class:"send-btn",disabled:$.value||F.value||!B.value.trim()&&!T.value.length,onClick:V},[$.value?(o(),a("span",Pt)):(o(),a("span",Ht,"â†‘"))],8,jt)])]),e[11]||(e[11]=n("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6)}}}),zt=Ne(Vt,[["__scopeId","data-v-03c8aff2"]]);export{zt as A};
