import{d as gt,o as m,c as g,F as H,b as n,t as U,a as s,w as i,k as Vt,U as St,l as et,q as ht,n as Tt,f as v,x as ot,r as x,h as zt,T as Bt,m as Xt,i as ct,j,g as C,E as N,N as Ft,e as Z,p as ft,M as mt}from"./index-rI2FvUi2.js";import{r as W}from"./index-B6ZRKErS.js";import{_ as xt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Yt={class:"rel-pair"},Ot={class:"rel-node"},Pt={class:"rel-node"},Gt={class:"type-grid"},jt=["onClick"],Wt={class:"type-card-top"},qt={class:"type-desc"},Ht=gt({__name:"RelTypeForm",props:{fromName:{},toName:{},type:{},strength:{},desc:{}},emits:["update:type","update:strength","update:desc"],setup(V){const M=V,F=ot(()=>[{value:"上级",color:"#f56c6c",desc:`${M.toName} 是 ${M.fromName} 的上级，负责领导和管理`},{value:"下级",color:"#e6a23c",desc:`${M.toName} 是 ${M.fromName} 的下级，接受指导和分配任务`},{value:"平级协作",color:"#409eff",desc:`${M.fromName} 与 ${M.toName} 并列合作，地位平等`},{value:"支持",color:"#67c23a",desc:`${M.toName} 为 ${M.fromName} 提供支持和辅助`}]);return(R,d)=>{const S=x("el-icon"),z=x("el-radio-button"),nt=x("el-radio-group"),Y=x("el-form-item"),st=x("el-input"),I=x("el-form");return m(),g(H,null,[n("div",Yt,[n("span",Ot,U(V.fromName),1),s(S,{style:{color:"#c0c4cc","flex-shrink":"0","font-size":"18px"}},{default:i(()=>[s(Vt(St))]),_:1}),n("span",Pt,U(V.toName),1)]),n("div",Gt,[(m(!0),g(H,null,et(F.value,k=>(m(),g("div",{key:k.value,class:ht(["type-card",{active:V.type===k.value}]),onClick:it=>R.$emit("update:type",k.value)},[n("div",Wt,[n("span",{class:"type-tag",style:Tt({background:k.color+"18",color:k.color})},U(k.value),5)]),n("div",qt,U(k.desc),1)],10,jt))),128))]),s(I,{"label-width":"72px",style:{"margin-top":"16px"}},{default:i(()=>[s(Y,{label:"关系强度"},{default:i(()=>[s(nt,{"model-value":V.strength,"onUpdate:modelValue":d[0]||(d[0]=k=>R.$emit("update:strength",k))},{default:i(()=>[s(z,{value:"核心"},{default:i(()=>[...d[2]||(d[2]=[v("核心",-1)])]),_:1}),s(z,{value:"常用"},{default:i(()=>[...d[3]||(d[3]=[v("常用",-1)])]),_:1}),s(z,{value:"偶尔"},{default:i(()=>[...d[4]||(d[4]=[v("偶尔",-1)])]),_:1})]),_:1},8,["model-value"])]),_:1}),s(Y,{label:"说明"},{default:i(()=>[s(st,{"model-value":V.desc,"onUpdate:modelValue":d[1]||(d[1]=k=>R.$emit("update:desc",k)),placeholder:"可选备注"},null,8,["model-value"])]),_:1})]),_:1})],64)}}}),vt=xt(Ht,[["__scopeId","data-v-0bce55d0"]]),It={class:"team-view"},Jt={class:"page-header"},Kt={style:{display:"flex",gap:"8px"}},Qt={key:0,class:"empty-state"},Zt={key:0,class:"connect-banner"},te={style:{margin:"0 4px"}},ee=["width","height"],oe=["x1","y1","x2","y2"],ne=["x1","y1","x2","y2","onClick"],se=["x1","y1","x2","y2","stroke","stroke-width"],le=["x","y","fill"],ae=["transform","onMousedown","onClick"],re={key:0,r:"37",fill:"none",stroke:"#409eff","stroke-width":"2.5","stroke-dasharray":"7,3",class:"selection-ring"},ie={key:1,r:"33",fill:"rgba(64,158,255,0.06)",stroke:"#409eff","stroke-width":"1.5","stroke-opacity":"0.5"},ue=["fill"],de={"text-anchor":"middle","dominant-baseline":"central",fill:"#fff","font-weight":"700","font-size":"15","font-family":"system-ui, sans-serif"},ce=["fill"],fe={"text-anchor":"middle",y:"46","font-size":"12",fill:"#303133","font-family":"system-ui, sans-serif","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},me={"text-anchor":"middle",y:"58","font-size":"10",fill:"#909399","font-family":"system-ui, monospace"},ve={key:1,class:"no-edge-hint"},pe={class:"legend"},ye={class:"legend-item"},ge={class:"legend-item"},he={width:"28",height:"8"},xe=["stroke-width"],q=28,pt=160,tt=90,yt=80,ke=gt({__name:"TeamView",setup(V){const M=C(),F=C(),R=C(!1),d=C({nodes:[],edges:[]}),S=C(860),z={核心:4,常用:2.5,偶尔:1.5},nt={上级:"#f56c6c",下级:"#e6a23c",平级协作:"#409eff",支持:"#67c23a"};function Y(e){return nt[e]??"#94a3b8"}function st(e,t){const l={};e.forEach(u=>{l[u.id]=0});const a=e.length+2;for(let u=0;u<a;u++){let w=!1;for(const h of t){const D=l[h.from]??0,L=l[h.to]??0;if(h.type==="上级"){const E=D-1;L>E&&(l[h.to]=E,w=!0)}else if(h.type==="下级"){const E=D+1;L<E&&(l[h.to]=E,w=!0)}}if(!w)break}const r=Object.values(l),f=r.length?Math.min(...r):0;return e.forEach(u=>{l[u.id]=(l[u.id]??0)-f}),l}const I=ot(()=>st(d.value.nodes,d.value.edges)),k=ot(()=>{const e=Object.values(I.value).reduce((t,l)=>Math.max(t,l),0);return Math.max(600,tt+e*pt+160)}),it=ot(()=>{const e=d.value.nodes,t=I.value,l=S.value,a={};e.forEach(f=>{const u=t[f.id]??0;a[u]||(a[u]=[]),a[u].push(f.id)});const r={};for(const[f,u]of Object.entries(a)){const w=Number(f),h=tt+w*pt,D=l-yt*2,L=u.length>1?D/(u.length-1):0;u.forEach((E,Q)=>{r[E]={x:Math.round(u.length===1?l/2:yt+Q*L),y:Math.round(h)}})}return r}),O=C({}),_=C(null),J=C({x:400,y:tt});function b(e){return O.value[e]??it.value[e]??{x:S.value/2,y:tt}}function kt(e,t){e.preventDefault();const l=b(t);_.value={id:t,startClientX:e.clientX,startClientY:e.clientY,startNodeX:l.x,startNodeY:l.y,moved:!1},document.addEventListener("mousemove",lt),document.addEventListener("mouseup",at)}function K(e,t){const l=M.value;if(!l)return{x:e,y:t};const a=l.getScreenCTM();if(!a)return{x:e,y:t};const r=a.inverse(),f=l.createSVGPoint();f.x=e,f.y=t;const u=f.matrixTransform(r);return{x:u.x,y:u.y}}function lt(e){const t=K(e.clientX,e.clientY);if(J.value=t,!_.value)return;const l=e.clientX-_.value.startClientX,a=e.clientY-_.value.startClientY;if((Math.abs(l)>4||Math.abs(a)>4)&&(_.value.moved=!0),_.value.moved){const r=K(_.value.startClientX,_.value.startClientY),f=K(e.clientX,e.clientY),u=_.value.startNodeX+(f.x-r.x),w=_.value.startNodeY+(f.y-r.y),h=q+4,D=S.value-q-4,L=q+4,E=k.value-q-24;O.value={...O.value,[_.value.id]:{x:Math.round(Math.max(h,Math.min(D,u))),y:Math.round(Math.max(L,Math.min(E,w)))}}}}function at(){_.value=null,document.removeEventListener("mousemove",lt),document.removeEventListener("mouseup",at)}function _t(e){_.value||(J.value=K(e.clientX,e.clientY))}function wt(){p.value=null}const p=C(null);function Ct(e){if(_.value?.moved)return;if(!p.value){p.value=e;return}if(p.value===e){p.value=null;return}const t=p.value;p.value=null,Nt(t,e)}function A(e,t,l){const a=b(e),r=b(t),f=r.x-a.x,u=r.y-a.y,w=Math.sqrt(f*f+u*u)||1,h=q+3;return l==="start"?{x:a.x+f/w*h,y:a.y+u/w*h}:{x:r.x-f/w*h,y:r.y-u/w*h}}function Mt(e){return z[e]??1.5}const ut=["#409EFF","#67C23A","#E6A23C","#F56C6C","#7C3AED","#0891B2","#B45309","#64748B"];function bt(e){let t=0;for(let l=0;l<e.length;l++)t=e.charCodeAt(l)+((t<<5)-t);return ut[Math.abs(t)%ut.length]??"#409EFF"}function $t(e){return(e||"?").charAt(0).toUpperCase()}function T(e){return d.value.nodes.find(t=>t.id===e)?.name??e}function Et(){O.value={},N.success("已重置为自动布局")}const P=C(!1),y=ft({from:"",to:"",type:"平级协作",strength:"常用",desc:""}),$=C(!1);function Nt(e,t){if(d.value.edges.some(a=>a.from===e&&a.to===t||a.from===t&&a.to===e)){const a=d.value.edges.find(r=>r.from===e&&r.to===t||r.from===t&&r.to===e);dt(a);return}y.from=e,y.to=t,y.type="平级协作",y.strength="常用",y.desc="",P.value=!0}async function Ut(){if(!$.value){$.value=!0;try{await W.putEdge(y.from,y.to,y.type,y.strength,y.desc),N.success("关系已建立"),P.value=!1,await X()}catch{N.error("保存失败")}finally{$.value=!1}}}const B=C(!1),c=ft({from:"",to:"",type:"平级协作",strength:"常用",desc:""});function dt(e){c.from=e.from,c.to=e.to,c.type=e.type,c.strength=e.strength,c.desc=e.label,B.value=!0}async function Dt(){if(!$.value){$.value=!0;try{await W.putEdge(c.from,c.to,c.type,c.strength,c.desc),N.success("关系已更新"),B.value=!1,await X()}catch{N.error("保存失败")}finally{$.value=!1}}}async function Rt(){try{await mt.confirm(`删除 ${T(c.from)} ↔ ${T(c.to)} 的关系？`,"删除关系",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"})}catch{return}$.value=!0;try{await W.deleteEdge(c.from,c.to),N.success("关系已删除"),B.value=!1,await X()}catch{N.error("删除失败")}finally{$.value=!1}}async function X(){R.value=!0;try{const e=await W.graph();d.value=e.data}catch{N.error("加载图谱失败")}finally{R.value=!1}}async function At(){try{await mt.confirm("将清空所有成员的关系，不可恢复。确认吗？","清空所有关系",{confirmButtonText:"确认清空",cancelButtonText:"取消",type:"warning"})}catch{return}try{await W.clearAll(),N.success("已清空所有成员关系"),await X()}catch{N.error("清空失败")}}let rt=null;return zt(()=>{X(),F.value&&(rt=new ResizeObserver(e=>{const t=e[0]?.contentRect.width;t&&t>100&&(S.value=Math.floor(t),O.value={})}),rt.observe(F.value))}),Bt(()=>{rt?.disconnect(),document.removeEventListener("mousemove",lt),document.removeEventListener("mouseup",at)}),(e,t)=>{const l=x("Grid"),a=x("el-icon"),r=x("el-button"),f=x("Refresh"),u=x("Delete"),w=x("Share"),h=x("Link"),D=x("el-card"),L=x("ArrowUp"),E=x("ArrowDown"),Q=x("el-dialog"),Lt=Ft("loading");return m(),g("div",It,[n("div",Jt,[t[14]||(t[14]=n("h2",null,"团队关系图谱",-1)),n("div",Kt,[s(r,{size:"small",onClick:Et},{default:i(()=>[s(a,null,{default:i(()=>[s(l)]),_:1}),t[11]||(t[11]=v(" 整理 ",-1))]),_:1}),s(r,{size:"small",onClick:X},{default:i(()=>[s(a,null,{default:i(()=>[s(f)]),_:1}),t[12]||(t[12]=v(" 刷新 ",-1))]),_:1}),s(r,{size:"small",type:"danger",plain:"",onClick:At},{default:i(()=>[s(a,null,{default:i(()=>[s(u)]),_:1}),t[13]||(t[13]=v(" 清空关系 ",-1))]),_:1})])]),Xt((m(),ct(D,{class:"graph-card"},{default:i(()=>[!R.value&&!d.value.nodes.length?(m(),g("div",Qt,[s(a,{style:{"font-size":"64px",color:"#c0c4cc",display:"block",margin:"0 auto 16px"}},{default:i(()=>[s(w)]),_:1}),t[15]||(t[15]=n("p",{style:{color:"#909399","text-align":"center",margin:"0"}},"暂无成员数据",-1))])):(m(),g("div",{key:1,class:"graph-container",ref_key:"graphContainerRef",ref:F},[p.value?(m(),g("div",Zt,[s(a,{style:{"margin-right":"6px"}},{default:i(()=>[s(h)]),_:1}),t[17]||(t[17]=v(" 连线模式：已选中 ",-1)),n("strong",te,U(T(p.value)),1),t[18]||(t[18]=v("，点击另一个成员建立关系 ",-1)),s(r,{size:"small",text:"",style:{"margin-left":"8px"},onClick:t[0]||(t[0]=o=>p.value=null)},{default:i(()=>[...t[16]||(t[16]=[v("取消",-1)])]),_:1})])):j("",!0),(m(),g("svg",{ref_key:"svgRef",ref:M,width:S.value,height:k.value,class:"graph-svg",onMousemove:_t,onClick:Z(wt,["self"]),style:{display:"block"}},[t[20]||(t[20]=n("defs",null,[n("pattern",{id:"smallGrid",width:"20",height:"20",patternUnits:"userSpaceOnUse"},[n("path",{d:"M 20 0 L 0 0 0 20",fill:"none",stroke:"#e8ecf0","stroke-width":"0.5"})]),n("pattern",{id:"grid",width:"100",height:"100",patternUnits:"userSpaceOnUse"},[n("rect",{width:"100",height:"100",fill:"url(#smallGrid)"}),n("path",{d:"M 100 0 L 0 0 0 100",fill:"none",stroke:"#dde1e7","stroke-width":"1"})])],-1)),t[21]||(t[21]=n("rect",{width:"100%",height:"100%",fill:"url(#grid)",rx:"0"},null,-1)),p.value?(m(),g("line",{key:0,x1:b(p.value).x,y1:b(p.value).y,x2:J.value.x,y2:J.value.y,stroke:"#409eff","stroke-width":"2","stroke-dasharray":"6,4","stroke-opacity":"0.7","pointer-events":"none"},null,8,oe)):j("",!0),(m(!0),g(H,null,et(d.value.edges,o=>(m(),g("g",{key:`${o.from}|${o.to}`},[n("line",{x1:A(o.from,o.to,"start").x,y1:A(o.from,o.to,"start").y,x2:A(o.from,o.to,"end").x,y2:A(o.from,o.to,"end").y,stroke:"transparent","stroke-width":"14",style:{cursor:"pointer"},onClick:Z(G=>dt(o),["stop"])},null,8,ne),n("line",{x1:A(o.from,o.to,"start").x,y1:A(o.from,o.to,"start").y,x2:A(o.from,o.to,"end").x,y2:A(o.from,o.to,"end").y,stroke:Y(o.type),"stroke-width":Mt(o.strength),"stroke-opacity":"0.7","stroke-linecap":"round","pointer-events":"none",class:"graph-edge"},null,8,se),n("text",{x:(b(o.from).x+b(o.to).x)/2,y:(b(o.from).y+b(o.to).y)/2-6,"text-anchor":"middle","font-size":"10",fill:Y(o.type),"pointer-events":"none","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},U(o.type),9,le)]))),128)),(m(!0),g(H,null,et(d.value.nodes,o=>(m(),g("g",{key:o.id,transform:`translate(${b(o.id).x}, ${b(o.id).y})`,class:ht(["graph-node",{"node-selected":p.value===o.id},{"node-target":!!p.value&&p.value!==o.id}]),style:{cursor:"grab"},onMousedown:Z(G=>kt(G,o.id),["stop"]),onClick:Z(()=>Ct(o.id),["stop"])},[p.value===o.id?(m(),g("circle",re)):p.value?(m(),g("circle",ie)):j("",!0),t[19]||(t[19]=n("circle",{r:"30",fill:"rgba(0,0,0,0.07)",transform:"translate(2,3)"},null,-1)),n("circle",{r:"28",fill:bt(o.id),stroke:"#fff","stroke-width":"2.5"},null,8,ue),n("text",de,U($t(o.id)),1),n("circle",{cx:"20",cy:"-20",r:"6",fill:o.status==="running"?"#67C23A":"#c0c4cc",stroke:"#fff","stroke-width":"1.5"},null,8,ce),n("text",fe,U(o.name),1),n("text",me,U(o.id),1)],42,ae))),128))],40,ee)),d.value.edges.length?j("",!0):(m(),g("div",ve," 点击任意成员选中，再点击另一个成员即可创建关系连线 "))],512))]),_:1})),[[Lt,R.value]]),d.value.nodes.length?(m(),ct(D,{key:0,class:"legend-card"},{default:i(()=>[n("div",pe,[t[24]||(t[24]=n("span",{class:"legend-title"},"布局规则：",-1)),n("span",ye,[s(a,null,{default:i(()=>[s(L)]),_:1}),t[22]||(t[22]=v(" 上方 = 上级",-1))]),t[25]||(t[25]=n("span",{class:"legend-item"},"— 同层 = 平级",-1)),n("span",ge,[s(a,null,{default:i(()=>[s(E)]),_:1}),t[23]||(t[23]=v(" 下方 = 下级",-1))]),t[26]||(t[26]=n("span",{class:"legend-divider"},"|",-1)),t[27]||(t[27]=n("span",{class:"legend-title"},"线粗：",-1)),(m(),g(H,null,et(z,(o,G)=>n("span",{key:G,class:"legend-item"},[(m(),g("svg",he,[n("line",{x1:"0",y1:"4",x2:"28",y2:"4",stroke:"#64748b","stroke-width":o,"stroke-linecap":"round"},null,8,xe)])),v(" "+U(G),1)])),64)),t[28]||(t[28]=n("span",{class:"legend-divider"},"|",-1)),t[29]||(t[29]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#67C23A"})]),v(" 运行中 ")],-1)),t[30]||(t[30]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#c0c4cc"})]),v(" 空闲 ")],-1))])]),_:1})):j("",!0),s(Q,{modelValue:P.value,"onUpdate:modelValue":t[5]||(t[5]=o=>P.value=o),title:"建立关系",width:"460px","close-on-click-modal":!1},{footer:i(()=>[s(r,{onClick:t[4]||(t[4]=o=>P.value=!1)},{default:i(()=>[...t[31]||(t[31]=[v("取消",-1)])]),_:1}),s(r,{type:"primary",loading:$.value,onClick:Ut},{default:i(()=>[...t[32]||(t[32]=[v("建立",-1)])]),_:1},8,["loading"])]),default:i(()=>[s(vt,{"from-name":T(y.from),"to-name":T(y.to),type:y.type,"onUpdate:type":t[1]||(t[1]=o=>y.type=o),strength:y.strength,"onUpdate:strength":t[2]||(t[2]=o=>y.strength=o),desc:y.desc,"onUpdate:desc":t[3]||(t[3]=o=>y.desc=o)},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"]),s(Q,{modelValue:B.value,"onUpdate:modelValue":t[10]||(t[10]=o=>B.value=o),title:"编辑关系",width:"460px","close-on-click-modal":!1},{footer:i(()=>[s(r,{type:"danger",plain:"",loading:$.value,onClick:Rt},{default:i(()=>[...t[33]||(t[33]=[v("删除关系",-1)])]),_:1},8,["loading"]),s(r,{onClick:t[9]||(t[9]=o=>B.value=!1)},{default:i(()=>[...t[34]||(t[34]=[v("取消",-1)])]),_:1}),s(r,{type:"primary",loading:$.value,onClick:Dt},{default:i(()=>[...t[35]||(t[35]=[v("保存",-1)])]),_:1},8,["loading"])]),default:i(()=>[s(vt,{"from-name":T(c.from),"to-name":T(c.to),type:c.type,"onUpdate:type":t[6]||(t[6]=o=>c.type=o),strength:c.strength,"onUpdate:strength":t[7]||(t[7]=o=>c.strength=o),desc:c.desc,"onUpdate:desc":t[8]||(t[8]=o=>c.desc=o)},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"])])}}}),Me=xt(ke,[["__scopeId","data-v-5012cf28"]]);export{Me as default};
