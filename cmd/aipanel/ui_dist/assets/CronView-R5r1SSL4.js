import{e as c}from"./index-C6G0aGO3.js";import{d as j,h as q,c as w,f as x,a as e,w as a,g as z,r as o,o as y,e as d,t as b,F as J,k as U,l as L,q as G,E as u}from"./index-XZilKoIS.js";const H={class:"cron-page"},I={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"20px"}},W=j({__name:"CronView",setup(K){const g=z([]),m=z(!1),n=G({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});q(_);async function _(){try{const s=await c.list();g.value=s.data||[]}catch{}}function A(s){return s?new Date(s).toLocaleString():""}async function N(){try{await c.create({name:n.name,enabled:n.enabled,schedule:{kind:"cron",expr:n.expr,tz:n.tz},payload:{kind:"agentTurn",message:n.message},delivery:{mode:"announce"}}),u.success("创建成功"),m.value=!1,_()}catch(s){u.error(s.response?.data?.error||"创建失败")}}async function S(s){try{await c.update(s.id,s)}catch{u.error("更新失败")}}async function h(s){try{await c.run(s.id),u.success("已触发"),setTimeout(_,2e3)}catch{u.error("失败")}}async function T(s){try{await c.delete(s.id),u.success("已删除"),_()}catch{u.error("删除失败")}}return(s,t)=>{const $=o("Plus"),B=o("el-icon"),r=o("el-button"),i=o("el-table-column"),M=o("el-tag"),C=o("el-text"),k=o("el-switch"),E=o("el-table"),D=o("el-empty"),F=o("el-card"),V=o("el-input"),p=o("el-form-item"),v=o("el-option"),P=o("el-select"),R=o("el-form"),Y=o("el-dialog");return y(),w("div",H,[x("div",I,[t[9]||(t[9]=x("h2",{style:{margin:"0"}},"⏰ 定时任务",-1)),e(r,{type:"primary",onClick:t[0]||(t[0]=l=>m.value=!0)},{default:a(()=>[e(B,null,{default:a(()=>[e($)]),_:1}),t[8]||(t[8]=d(" 新建任务 ",-1))]),_:1})]),e(F,{shadow:"hover"},{default:a(()=>[e(E,{data:g.value,stripe:""},{default:a(()=>[e(i,{prop:"name",label:"名称","min-width":"160"}),e(i,{label:"调度","min-width":"200"},{default:a(({row:l})=>[d(b(l.schedule?.expr)+" ("+b(l.schedule?.tz)+")",1)]),_:1}),e(i,{label:"最近运行",width:"200"},{default:a(({row:l})=>[l.state?.lastRunAtMs?(y(),w(J,{key:0},[e(M,{type:l.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:a(()=>[d(b(l.state?.lastStatus),1)]),_:2},1032,["type"]),e(C,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:a(()=>[d(b(A(l.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(y(),U(C,{key:1,type:"info",size:"small"},{default:a(()=>[...t[10]||(t[10]=[d("未运行",-1)])]),_:1}))]),_:1}),e(i,{label:"启用",width:"80"},{default:a(({row:l})=>[e(k,{modelValue:l.enabled,"onUpdate:modelValue":f=>l.enabled=f,onChange:f=>S(l),size:"small"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(i,{label:"操作",width:"200"},{default:a(({row:l})=>[e(r,{size:"small",onClick:f=>h(l)},{default:a(()=>[...t[11]||(t[11]=[d("立即运行",-1)])]),_:1},8,["onClick"]),e(r,{size:"small",type:"danger",onClick:f=>T(l)},{default:a(()=>[...t[12]||(t[12]=[d("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),g.value.length===0?(y(),U(D,{key:0,description:"暂无定时任务"})):L("",!0)]),_:1}),e(Y,{modelValue:m.value,"onUpdate:modelValue":t[7]||(t[7]=l=>m.value=l),title:"新建定时任务",width:"520px"},{footer:a(()=>[e(r,{onClick:t[6]||(t[6]=l=>m.value=!1)},{default:a(()=>[...t[13]||(t[13]=[d("取消",-1)])]),_:1}),e(r,{type:"primary",onClick:N},{default:a(()=>[...t[14]||(t[14]=[d("创建",-1)])]),_:1})]),default:a(()=>[e(R,{model:n,"label-width":"100px"},{default:a(()=>[e(p,{label:"名称"},{default:a(()=>[e(V,{modelValue:n.name,"onUpdate:modelValue":t[1]||(t[1]=l=>n.name=l)},null,8,["modelValue"])]),_:1}),e(p,{label:"Cron 表达式"},{default:a(()=>[e(V,{modelValue:n.expr,"onUpdate:modelValue":t[2]||(t[2]=l=>n.expr=l),placeholder:"0 9 * * *"},null,8,["modelValue"])]),_:1}),e(p,{label:"时区"},{default:a(()=>[e(P,{modelValue:n.tz,"onUpdate:modelValue":t[3]||(t[3]=l=>n.tz=l)},{default:a(()=>[e(v,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),e(v,{label:"UTC",value:"UTC"}),e(v,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),e(p,{label:"消息"},{default:a(()=>[e(V,{modelValue:n.message,"onUpdate:modelValue":t[4]||(t[4]=l=>n.message=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),e(p,{label:"启用"},{default:a(()=>[e(k,{modelValue:n.enabled,"onUpdate:modelValue":t[5]||(t[5]=l=>n.enabled=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});export{W as default};
