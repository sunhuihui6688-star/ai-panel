import{d as ql,h as Hl,E as m,i as w,w as a,B as Jl,g as u,r as v,o as i,a as l,f as d,k as F,y as Wl,t as r,e as s,z as Ve,m as tl,c as g,F as T,l as J,q as Gl,j as I,n as je,C as Kl,D as Ql,G as Xl,H as Zl,I as ea}from"./index-NN8rIs10.js";import{b as Oe,f as ue,g as ie,h as de,i as la,e as xe,r as nl,j as W}from"./index-CSvBSDR2.js";import{A as aa}from"./AiChat-B_Fvy3gp.js";import{_ as ta}from"./_plugin-vue_export-helper-DlAUqK2U.js";const na={class:"header-left"},oa={class:"chat-layout"},sa={class:"session-sidebar"},ua={class:"session-sidebar-header"},ia={class:"session-list"},da=["onClick"],ra={class:"session-item-title"},ma={class:"session-item-meta"},fa={key:0,class:"session-empty"},pa={class:"at-panel"},va={key:0,class:"at-form"},ya={class:"chat-area"},ca={style:{display:"flex","align-items":"center",gap:"8px"}},ga={style:{"font-weight":"600"}},_a={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"32px 0","font-size":"14px"}},ba={style:{display:"flex","align-items":"center",gap:"8px"}},wa={style:{"font-size":"13px"}},ka={style:{"font-size":"13px",color:"#606266"}},Ca={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"40px 0"}},ha={key:1,class:"relations-list"},Va={class:"relation-info"},xa={class:"relation-name"},za={class:"relation-tags"},Ta={class:"relation-desc"},Aa={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Ua={style:{display:"flex",gap:"8px","margin-top":"4px"}},$a={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Fa={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"16px 0","font-size":"13px"}},Ia={style:{"font-size":"12px"}},Sa={style:{"font-size":"12px",color:"#606266"}},Ma={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},Da={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},Na={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Ea={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},La={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},Ba=ql({__name:"AgentDetailView",setup(Ra){const ze=Jl(),p=ze.params.id,j=u(null),Te=u("chat"),D=u(),re=u([]),me=u(!1),O=u();async function Pe(){me.value=!0;try{const n=await la.list({agentId:p,limit:50});re.value=n.data.sessions}catch{}finally{me.value=!1}}function ol(n){O.value=n.id,D.value?.resumeSession(n.id)}function sl(){O.value=void 0,D.value?.startNewSession()}function ul(n){O.value=n,setTimeout(Pe,500)}function il(n){if(!n)return"";const e=Date.now()-n;return e<6e4?"刚刚":e<36e5?`${Math.floor(e/6e4)}分前`:e<864e5?`${Math.floor(e/36e5)}小时前`:`${Math.floor(e/864e5)}天前`}const G=u(!1),K=u(""),Q=u(""),Ae=u(!1),N=u([]);function dl(){G.value=!G.value,G.value&&!N.value.length&&Ye()}async function Ye(){try{const n=await Oe.list();N.value=n.data.filter(e=>e.id!==p)}catch{N.value=[]}}function rl(n){const e=N.value.find(o=>o.id===n);e&&D.value?.fillInput(`@${e.name}: `)}async function ml(){const n=K.value,e=Q.value.trim();if(!n||!e)return;const y=N.value.find(E=>E.id===n)?.name??n;Ae.value=!0;const U={role:"user",text:`→ 转发给 ${y}：
${e}`};D.value?.appendMessage(U);try{const c=(await Oe.message(n,e,p)).data.response,M={role:"assistant",text:`← **${y}** 回复：

${c}`};D.value?.appendMessage(M),Q.value="",K.value="",G.value=!1,m.success(`${y} 已回复`)}catch(E){const c={role:"system",text:`❌ 转发失败：${E.response?.data?.error??E.message??"网络错误"}`};D.value?.appendMessage(c),m.error("转发失败")}finally{Ae.value=!1}}const fe=u(""),pe=u(""),x=u({enabled:!1,schedule:"daily",keepTurns:3,focusHint:"",cronJobId:""}),Ue=u(!1),$e=u(!1);async function fl(){try{const n=await xe.getConfig(p);x.value=n.data,Fe()}catch{}}async function qe(){Ue.value=!0;try{const n=await xe.setConfig(p,x.value);x.value=n.data,m.success(x.value.enabled?"自动记忆已开启":"自动记忆已关闭")}catch{m.error("保存失败")}finally{Ue.value=!1}}async function pl(){$e.value=!0;try{await xe.consolidate(p),m.success("记忆整理已在后台启动（约需10~30秒），稍后自动刷新日志"),setTimeout(Fe,1e4)}catch{m.error("整理失败")}finally{$e.value=!1}}const ve=u([]),ye=u(!1);async function Fe(){ye.value=!0;try{const n=await xe.runLog(p);ve.value=n.data||[]}catch{ve.value=[]}finally{ye.value=!1}}const ce=u([]),P=u(""),Y=u(""),Ie=u(!1),Se=u([]),X=u(!1),ge=u(""),Z=u(!1),_e=u(""),He=u([]),q=u(""),ee=u(""),be=u(null),A=u([]),Me=u(!1),k=u({agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""});async function vl(){try{const n=await nl.get(p);A.value=n.data.parsed||[]}catch{A.value=[]}}function yl(n){const e=N.value.find(o=>o.id===n);k.value.agentName=e?e.name:n}async function cl(){if(!k.value.agentId)return;if(A.value.find(e=>e.agentId===k.value.agentId)){m.warning("该成员关系已存在，请先删除再重新添加");return}A.value.push({...k.value}),k.value={agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""},await Je()}async function gl(n){A.value.splice(n,1),await Je()}function _l(){if(A.value.length===0)return"";const n=`| 成员ID | 成员名称 | 关系类型 | 关系程度 | 说明 |
|--------|--------|--------|--------|------|`,e=A.value.map(o=>`| ${o.agentId} | ${o.agentName} | ${o.relationType} | ${o.strength} | ${o.desc||""} |`).join(`
`);return n+`
`+e}async function Je(){Me.value=!0;try{await nl.put(p,_l()),m.success("关系已保存")}catch{m.error("保存失败")}finally{Me.value=!1}}function De(n){const e=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399","#B45309","#7C3AED","#0891B2"];let o=0;for(let y=0;y<n.length;y++)o=n.charCodeAt(y)+((o<<5)-o);return e[Math.abs(o)%e.length]??"#409EFF"}function We(n){return n==="上级"?"danger":n==="下级"?"":n==="平级协作"?"success":"info"}function Ge(n){return n==="核心"?"danger":n==="常用"?"warning":"info"}const Ke=u([]),le=u(!1),C=u({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function bl(n){return n==="running"?"success":n==="stopped"?"danger":"info"}function wl(n){return n==="running"?"运行中":n==="stopped"?"已停止":"空闲"}function Qe(n){return n?n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB":"0 B"}function kl(n){return new Date(n).toLocaleString()}function Xe(n){return n?new Date(n).toLocaleString():""}const S=u([]),we=u(!1),H=u(!1),ae=u(""),Ne=u(!1),Ee=u(""),f=u({type:"telegram",name:"",enabled:!0,botToken:"",allowedFrom:""});async function Le(){we.value=!0;try{const n=await W.list(p);S.value=n.data||[]}catch{S.value=[]}finally{we.value=!1}}function Cl(){ae.value="",f.value={type:"telegram",name:"",enabled:!0,botToken:"",allowedFrom:""},H.value=!0}function hl(n){ae.value=n.id,f.value={type:n.type,name:n.name,enabled:n.enabled,botToken:n.config?.botToken||"",allowedFrom:n.config?.allowedFrom||""},H.value=!0}async function Vl(){if(!f.value.name||!f.value.type){m.warning("请填写名称和类型");return}Ne.value=!0;try{const n={};if(f.value.type==="telegram"&&(f.value.botToken&&(n.botToken=f.value.botToken),f.value.allowedFrom&&(n.allowedFrom=f.value.allowedFrom)),ae.value){const e=S.value.map(o=>o.id!==ae.value?o:{...o,name:f.value.name,type:f.value.type,enabled:f.value.enabled,config:{...o.config,...n}});await W.set(p,e)}else{const e={id:f.value.type+"-"+Date.now().toString(36),name:f.value.name,type:f.value.type,enabled:f.value.enabled,config:n,status:"untested"};await W.set(p,[...S.value,e])}m.success("保存成功，重启后新渠道生效"),H.value=!1,await Le()}catch(n){m.error(n.response?.data?.error||"保存失败")}finally{Ne.value=!1}}async function xl(){try{await W.set(p,S.value)}catch{m.error("保存失败")}}async function zl(n){const e=S.value.filter(o=>o.id!==n.id);try{await W.set(p,e),S.value=e,m.success("已删除")}catch{m.error("删除失败")}}async function Tl(n){Ee.value=n.id;try{const e=await W.test(p,n.id);e.data.valid?m.success(e.data.botName?`测试成功 (@${e.data.botName})`:"测试成功"):m.error(e.data.error||"测试失败"),await Le()}catch{m.error("测试请求失败")}finally{Ee.value=""}}Hl(async()=>{try{const o=await Oe.get(p);j.value=o.data}catch{m.error("加载 Agent 失败")}Al(),vl(),Ye(),fl(),Sl(),ke(),Le(),await Pe();const n=ze.query.tab;n&&(Te.value=n);const e=ze.query.resumeSession;e&&(O.value=e,await new Promise(y=>setTimeout(y,100)),D.value?.resumeSession(e),re.value.find(y=>y.id===e)||(O.value=e))});async function Al(){try{const[n,e]=await Promise.all([ue.read(p,"IDENTITY.md"),ue.read(p,"SOUL.md")]);fe.value=n.data?.content||"",pe.value=e.data?.content||""}catch{}te()}async function Be(n,e){try{await ue.write(p,n,e),m.success(`${n} 已保存`)}catch{m.error(`保存 ${n} 失败`)}}async function te(){try{const n=await ie.tree(p);ce.value=n.data||[]}catch{ce.value=[]}}async function Ul(n){if(!n.isDir){P.value=n.path,Se.value=n.path.split("/");try{const e=await ie.readFile(p,n.path);Y.value=e.data?.content||""}catch{Y.value="(无法读取)"}}}async function $l(){if(P.value){Ie.value=!0;try{await ie.writeFile(p,P.value,Y.value),m.success("记忆文件已保存"),te()}catch{m.error("保存失败")}finally{Ie.value=!1}}}async function Fl(){const n=ge.value.trim();if(!n){m.warning("请输入路径");return}try{await ie.writeFile(p,n,`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`),m.success("文件已创建"),X.value=!1,ge.value="",te(),P.value=n,Se.value=n.split("/"),Y.value=`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`}catch{m.error("创建失败")}}async function Il(){const n=_e.value.trim();if(!n){m.warning("请输入内容");return}try{await ie.dailyLog(p,n),m.success("日志已添加"),Z.value=!1,_e.value="",te()}catch{m.error("添加失败")}}async function Sl(){try{const n=await ue.read(p,"/");Array.isArray(n.data)&&(He.value=n.data.map(e=>({name:e.name,isDir:e.isDir,size:e.size,modTime:e.modTime,path:e.name})))}catch{}}async function Ml(n){if(!n.isDir){q.value=n.path||n.name,be.value=n;try{const e=await ue.read(p,q.value);ee.value=e.data?.content||""}catch{ee.value="(无法读取)"}}}async function Dl(){q.value&&await Be(q.value,ee.value)}async function ke(){try{const n=await de.list();Ke.value=n.data||[]}catch{}}async function Nl(){try{await de.create({name:C.value.name,enabled:C.value.enabled,schedule:{kind:"cron",expr:C.value.expr,tz:C.value.tz},payload:{kind:"agentTurn",message:C.value.message},delivery:{mode:"announce"}}),m.success("任务创建成功"),le.value=!1,ke()}catch(n){m.error(n.response?.data?.error||"创建失败")}}async function El(n){try{await de.update(n.id,n)}catch{m.error("更新失败")}}async function Ze(n){try{await de.run(n.id),m.success("已触发运行"),setTimeout(ke,2e3)}catch{m.error("运行失败")}}async function Ll(n){try{await de.delete(n.id),m.success("已删除"),ke()}catch{m.error("删除失败")}}return(n,e)=>{const o=v("el-button"),y=v("el-tag"),U=v("el-text"),E=v("el-header"),c=v("el-option"),M=v("el-select"),z=v("el-input"),L=v("el-tab-pane"),$=v("el-card"),h=v("el-col"),B=v("el-row"),_=v("el-form-item"),ne=v("el-form"),Bl=v("el-badge"),b=v("el-table-column"),Ce=v("el-table"),oe=v("el-switch"),Rl=v("el-input-number"),R=v("el-icon"),el=v("el-tree"),Re=v("el-empty"),ll=v("el-breadcrumb-item"),jl=v("el-breadcrumb"),he=v("el-dialog"),Ol=v("el-tabs"),Pl=v("el-main"),Yl=v("el-container"),al=ea("loading");return i(),w(Yl,{class:"agent-detail"},{default:a(()=>[l(E,{class:"detail-header"},{default:a(()=>[d("div",na,[l(o,{icon:F(Wl),onClick:e[0]||(e[0]=t=>n.$router.push("/agents")),circle:""},null,8,["icon"]),d("h2",null,r(j.value?.name||"..."),1),l(y,{type:bl(j.value?.status)},{default:a(()=>[s(r(wl(j.value?.status)),1)]),_:1},8,["type"])]),l(U,{type:"info"},{default:a(()=>[s(r(j.value?.model),1)]),_:1})]),_:1}),l(Pl,null,{default:a(()=>[l(Ol,{modelValue:Te.value,"onUpdate:modelValue":e[40]||(e[40]=t=>Te.value=t),type:"border-card"},{default:a(()=>[l(L,{label:"对话",name:"chat"},{default:a(()=>[d("div",oa,[d("div",sa,[d("div",ua,[e[42]||(e[42]=d("span",{class:"sidebar-title"},"历史对话",-1)),l(o,{size:"small",type:"primary",plain:"",onClick:sl,icon:F(Ve)},{default:a(()=>[...e[41]||(e[41]=[s("新建",-1)])]),_:1},8,["icon"])]),tl((i(),g("div",ia,[(i(!0),g(T,null,J(re.value,t=>(i(),g("div",{key:t.id,class:Gl(["session-item",{active:O.value===t.id}]),onClick:V=>ol(t)},[d("div",ra,r(t.title||"新对话"),1),d("div",ma,[d("span",null,r(il(t.lastAt)),1),l(y,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:a(()=>[s(r(t.messageCount)+" 条 ",1)]),_:2},1024),t.tokenEstimate>6e4?(i(),w(y,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:a(()=>[s("~"+r(Math.round(t.tokenEstimate/1e3))+"k",1)]),_:2},1024)):I("",!0)])],10,da))),128)),!me.value&&!re.value.length?(i(),g("div",fa," 还没有对话记录 ")):I("",!0)])),[[al,me.value]]),d("div",pa,[l(o,{size:"small",plain:"",class:"at-toggle-btn",onClick:dl},{default:a(()=>[...e[43]||(e[43]=[d("span",{class:"at-icon"},"@",-1),s(" 其他成员 ",-1)])]),_:1}),G.value?(i(),g("div",va,[l(M,{modelValue:K.value,"onUpdate:modelValue":e[1]||(e[1]=t=>K.value=t),placeholder:"选择成员",size:"small",style:{width:"100%","margin-bottom":"6px"},onChange:rl},{default:a(()=>[(i(!0),g(T,null,J(N.value,t=>(i(),w(c,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(z,{modelValue:Q.value,"onUpdate:modelValue":e[2]||(e[2]=t=>Q.value=t),type:"textarea",rows:3,placeholder:"输入要转发的消息…",size:"small",style:{"margin-bottom":"6px"}},null,8,["modelValue"]),l(o,{type:"primary",size:"small",style:{width:"100%"},loading:Ae.value,disabled:!K.value||!Q.value.trim(),onClick:ml},{default:a(()=>[...e[44]||(e[44]=[s(" 转发 ",-1)])]),_:1},8,["loading","disabled"])])):I("",!0)])]),d("div",ya,[l(aa,{ref_key:"aiChatRef",ref:D,"agent-id":F(p),scenario:"agent-detail","welcome-message":`你好！我是 **${j.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:ul},null,8,["agent-id","welcome-message"])])])]),_:1}),l(L,{label:"身份 & 灵魂",name:"identity"},{default:a(()=>[l(B,{gutter:20},{default:a(()=>[l(h,{span:12},{default:a(()=>[l($,{header:"IDENTITY.md"},{default:a(()=>[l(z,{modelValue:fe.value,"onUpdate:modelValue":e[3]||(e[3]=t=>fe.value=t),type:"textarea",rows:15,onBlur:e[4]||(e[4]=t=>Be("IDENTITY.md",fe.value))},null,8,["modelValue"])]),_:1})]),_:1}),l(h,{span:12},{default:a(()=>[l($,{header:"SOUL.md"},{default:a(()=>[l(z,{modelValue:pe.value,"onUpdate:modelValue":e[5]||(e[5]=t=>pe.value=t),type:"textarea",rows:15,onBlur:e[6]||(e[6]=t=>Be("SOUL.md",pe.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),l(L,{label:"关系",name:"relations"},{default:a(()=>[l(B,{gutter:20},{default:a(()=>[l(h,{span:14},{default:a(()=>[l($,{style:{"margin-bottom":"16px"}},{header:a(()=>[...e[45]||(e[45]=[d("span",{style:{"font-weight":"600"}},"添加关系",-1)])]),default:a(()=>[l(ne,{model:k.value,"label-position":"top",size:"default"},{default:a(()=>[l(B,{gutter:12},{default:a(()=>[l(h,{span:10},{default:a(()=>[l(_,{label:"关联成员"},{default:a(()=>[l(M,{modelValue:k.value.agentId,"onUpdate:modelValue":e[7]||(e[7]=t=>k.value.agentId=t),placeholder:"选择系统成员",filterable:"",style:{width:"100%"},onChange:yl},{default:a(()=>[(i(!0),g(T,null,J(N.value,t=>(i(),w(c,{key:t.id,label:t.name,value:t.id},{default:a(()=>[d("div",ca,[d("div",{style:je([{width:"24px",height:"24px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"11px",color:"#fff","flex-shrink":"0"},{background:De(t.id)}])},r(t.name.charAt(0)),5),d("span",null,r(t.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(h,{span:7},{default:a(()=>[l(_,{label:"关系类型"},{default:a(()=>[l(M,{modelValue:k.value.relationType,"onUpdate:modelValue":e[8]||(e[8]=t=>k.value.relationType=t),style:{width:"100%"}},{default:a(()=>[l(c,{label:"上级",value:"上级"}),l(c,{label:"下级",value:"下级"}),l(c,{label:"平级协作",value:"平级协作"}),l(c,{label:"支持",value:"支持"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(h,{span:7},{default:a(()=>[l(_,{label:"协作程度"},{default:a(()=>[l(M,{modelValue:k.value.strength,"onUpdate:modelValue":e[9]||(e[9]=t=>k.value.strength=t),style:{width:"100%"}},{default:a(()=>[l(c,{label:"核心",value:"核心"}),l(c,{label:"常用",value:"常用"}),l(c,{label:"偶尔",value:"偶尔"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(B,{gutter:12},{default:a(()=>[l(h,{span:18},{default:a(()=>[l(_,{label:"说明（选填）"},{default:a(()=>[l(z,{modelValue:k.value.desc,"onUpdate:modelValue":e[10]||(e[10]=t=>k.value.desc=t),placeholder:"简要描述这段关系..."},null,8,["modelValue"])]),_:1})]),_:1}),l(h,{span:6},{default:a(()=>[l(_,{label:" "},{default:a(()=>[l(o,{type:"primary",style:{width:"100%"},disabled:!k.value.agentId||!k.value.relationType||!k.value.strength,loading:Me.value,onClick:cl},{default:a(()=>[...e[46]||(e[46]=[s(" 添加 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l($,null,{header:a(()=>[d("span",ga,[e[47]||(e[47]=s("已有关系 ",-1)),l(Bl,{value:A.value.length,type:"info",style:{"margin-left":"4px"}},null,8,["value"])])]),default:a(()=>[A.value.length===0?(i(),g("div",_a," 暂无关系，请在上方添加 ")):(i(),w(Ce,{key:1,data:A.value,size:"small",style:{width:"100%"}},{default:a(()=>[l(b,{label:"成员","min-width":"120"},{default:a(({row:t})=>[d("div",ba,[d("div",{style:je([{width:"28px",height:"28px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"12px",color:"#fff","flex-shrink":"0"},{background:De(t.agentId)}])},r(t.agentName.charAt(0)),5),d("span",wa,r(t.agentName),1)])]),_:1}),l(b,{label:"类型",width:"100"},{default:a(({row:t})=>[l(y,{type:We(t.relationType),size:"small"},{default:a(()=>[s(r(t.relationType),1)]),_:2},1032,["type"])]),_:1}),l(b,{label:"程度",width:"80"},{default:a(({row:t})=>[l(y,{type:Ge(t.strength),size:"small",effect:"plain"},{default:a(()=>[s(r(t.strength),1)]),_:2},1032,["type"])]),_:1}),l(b,{label:"说明","min-width":"120","show-overflow-tooltip":""},{default:a(({row:t})=>[d("span",ka,r(t.desc||"—"),1)]),_:1}),l(b,{label:"操作",width:"70",fixed:"right"},{default:a(({$index:t})=>[l(o,{type:"danger",link:"",size:"small",onClick:V=>gl(t)},{default:a(()=>[...e[48]||(e[48]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})]),_:1}),l(h,{span:10},{default:a(()=>[l($,{header:"关系预览"},{default:a(()=>[A.value.length===0?(i(),g("div",Ca," 暂无关系数据 ")):(i(),g("div",ha,[(i(!0),g(T,null,J(A.value,t=>(i(),g("div",{key:t.agentId,class:"relation-card"},[d("div",{class:"relation-avatar",style:je({background:De(t.agentId)})},r(t.agentName.charAt(0).toUpperCase()),5),d("div",Va,[d("div",xa,r(t.agentName),1),d("div",za,[l(y,{type:We(t.relationType),size:"small"},{default:a(()=>[s(r(t.relationType),1)]),_:2},1032,["type"]),l(y,{type:Ge(t.strength),size:"small",effect:"plain"},{default:a(()=>[s(r(t.strength),1)]),_:2},1032,["type"])]),d("div",Ta,r(t.desc),1)])]))),128))]))]),_:1})]),_:1})]),_:1})]),_:1}),l(L,{label:"记忆",name:"memory"},{default:a(()=>[l($,{style:{"margin-bottom":"16px"},shadow:"never"},{header:a(()=>[d("div",Aa,[e[49]||(e[49]=d("span",{style:{"font-weight":"600"}},"自动记忆",-1)),l(oe,{modelValue:x.value.enabled,"onUpdate:modelValue":e[11]||(e[11]=t=>x.value.enabled=t),"active-text":"已开启","inactive-text":"已关闭",onChange:qe},null,8,["modelValue"])])]),default:a(()=>[l(ne,{model:x.value,"label-position":"top",size:"small",disabled:!x.value.enabled},{default:a(()=>[l(B,{gutter:16},{default:a(()=>[l(h,{span:6},{default:a(()=>[l(_,{label:"整理频率"},{default:a(()=>[l(M,{modelValue:x.value.schedule,"onUpdate:modelValue":e[12]||(e[12]=t=>x.value.schedule=t),style:{width:"100%"}},{default:a(()=>[l(c,{label:"每小时",value:"hourly"}),l(c,{label:"每6小时",value:"every6h"}),l(c,{label:"每天",value:"daily"}),l(c,{label:"每周",value:"weekly"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(h,{span:5},{default:a(()=>[l(_,{label:"每个会话保留轮数"},{default:a(()=>[l(Rl,{modelValue:x.value.keepTurns,"onUpdate:modelValue":e[13]||(e[13]=t=>x.value.keepTurns=t),min:1,max:20,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(h,{span:13},{default:a(()=>[l(_,{label:"记录重点（留空则自动）"},{default:a(()=>[l(z,{modelValue:x.value.focusHint,"onUpdate:modelValue":e[14]||(e[14]=t=>x.value.focusHint=t),placeholder:"例如：记录数学解题步骤和用户常见错误"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),d("div",Ua,[l(o,{type:"primary",size:"small",loading:Ue.value,onClick:qe},{default:a(()=>[...e[50]||(e[50]=[s(" 保存设置 ",-1)])]),_:1},8,["loading"]),l(o,{size:"small",loading:$e.value,onClick:pl},{default:a(()=>[...e[51]||(e[51]=[s(" 立即整理 ",-1)])]),_:1},8,["loading"]),l(U,{type:"info",size:"small",style:{"align-self":"center","margin-left":"4px"}},{default:a(()=>[s(" 整理后：LLM提炼摘要写入 MEMORY.md，每个会话只保留最近 "+r(x.value.keepTurns)+" 轮对话 ",1)]),_:1})])]),_:1},8,["model","disabled"])]),_:1}),l($,{style:{"margin-bottom":"16px"},shadow:"never"},{header:a(()=>[d("div",$a,[e[53]||(e[53]=d("span",{style:{"font-weight":"600"}},"整理日志",-1)),l(o,{size:"small",text:"",onClick:Fe,loading:ye.value},{default:a(()=>[...e[52]||(e[52]=[s("刷新",-1)])]),_:1},8,["loading"])])]),default:a(()=>[ve.value.length===0&&!ye.value?(i(),g("div",Fa," 暂无运行记录，点击「立即整理」触发第一次 ")):(i(),w(Ce,{key:1,data:ve.value.slice(0,20),size:"small"},{default:a(()=>[l(b,{label:"时间",width:"160"},{default:a(({row:t})=>[d("span",Ia,r(Xe(t.timestamp)),1)]),_:1}),l(b,{label:"状态",width:"72"},{default:a(({row:t})=>[l(y,{type:t.status==="ok"?"success":"danger",size:"small"},{default:a(()=>[s(r(t.status),1)]),_:2},1032,["type"])]),_:1}),l(b,{label:"结果","min-width":"200","show-overflow-tooltip":""},{default:a(({row:t})=>[d("span",Sa,r(t.message||"—"),1)]),_:1})]),_:1},8,["data"]))]),_:1}),d("div",Ma,[l(o,{type:"primary",size:"small",onClick:e[15]||(e[15]=t=>X.value=!0)},{default:a(()=>[l(R,null,{default:a(()=>[l(F(Ve))]),_:1}),e[54]||(e[54]=s(" 新建文件 ",-1))]),_:1}),l(o,{size:"small",onClick:e[16]||(e[16]=t=>Z.value=!0)},{default:a(()=>[l(R,null,{default:a(()=>[l(F(Kl))]),_:1}),e[55]||(e[55]=s(" 添加日志 ",-1))]),_:1}),l(o,{size:"small",onClick:te},{default:a(()=>[l(R,null,{default:a(()=>[l(F(Ql))]),_:1}),e[56]||(e[56]=s(" 刷新 ",-1))]),_:1})]),l(B,{gutter:16},{default:a(()=>[l(h,{span:7},{default:a(()=>[l($,{header:"记忆目录",shadow:"hover"},{default:a(()=>[l(el,{data:ce.value,props:{label:"name",children:"children",isLeaf:t=>!t.isDir},onNodeClick:Ul,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:a(({data:t})=>[d("span",Da,[t.isDir?(i(),w(R,{key:0,style:{color:"#E6A23C"}},{default:a(()=>[l(F(Xl))]),_:1})):(i(),w(R,{key:1,style:{color:"#409EFF"}},{default:a(()=>[l(F(Zl))]),_:1})),d("span",null,r(t.name),1),!t.isDir&&t.size?(i(),w(U,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:a(()=>[s(r(Qe(t.size)),1)]),_:2},1024)):I("",!0)])]),_:1},8,["data","props"]),ce.value.length===0?(i(),w(Re,{key:0,description:"记忆树为空","image-size":40})):I("",!0)]),_:1})]),_:1}),l(h,{span:17},{default:a(()=>[l($,{shadow:"hover"},{header:a(()=>[d("div",Na,[l(jl,{separator:"/"},{default:a(()=>[l(ll,null,{default:a(()=>[...e[57]||(e[57]=[s("memory",-1)])]),_:1}),(i(!0),g(T,null,J(Se.value,(t,V)=>(i(),w(ll,{key:V},{default:a(()=>[s(r(t),1)]),_:2},1024))),128))]),_:1}),P.value?(i(),w(o,{key:0,type:"primary",size:"small",onClick:$l,loading:Ie.value},{default:a(()=>[...e[58]||(e[58]=[s("保存",-1)])]),_:1},8,["loading"])):I("",!0)])]),default:a(()=>[P.value?(i(),w(z,{key:0,modelValue:Y.value,"onUpdate:modelValue":e[17]||(e[17]=t=>Y.value=t),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(i(),w(Re,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),l(he,{modelValue:X.value,"onUpdate:modelValue":e[20]||(e[20]=t=>X.value=t),title:"新建记忆文件",width:"480px"},{footer:a(()=>[l(o,{onClick:e[19]||(e[19]=t=>X.value=!1)},{default:a(()=>[...e[60]||(e[60]=[s("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:Fl},{default:a(()=>[...e[61]||(e[61]=[s("创建",-1)])]),_:1})]),default:a(()=>[l(ne,{"label-width":"80px"},{default:a(()=>[l(_,{label:"路径"},{default:a(()=>[l(z,{modelValue:ge.value,"onUpdate:modelValue":e[18]||(e[18]=t=>ge.value=t),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),l(U,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:a(()=>[...e[59]||(e[59]=[s("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(he,{modelValue:Z.value,"onUpdate:modelValue":e[23]||(e[23]=t=>Z.value=t),title:"添加今日日志",width:"600px"},{footer:a(()=>[l(o,{onClick:e[22]||(e[22]=t=>Z.value=!1)},{default:a(()=>[...e[62]||(e[62]=[s("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:Il},{default:a(()=>[...e[63]||(e[63]=[s("提交",-1)])]),_:1})]),default:a(()=>[l(z,{modelValue:_e.value,"onUpdate:modelValue":e[21]||(e[21]=t=>_e.value=t),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),l(L,{label:"工作区",name:"workspace"},{default:a(()=>[l(B,{gutter:20},{default:a(()=>[l(h,{span:8},{default:a(()=>[l($,{header:"文件列表"},{default:a(()=>[l(el,{data:He.value,props:{label:"name",children:"children"},onNodeClick:Ml,"highlight-current":"","default-expand-all":""},null,8,["data"])]),_:1})]),_:1}),l(h,{span:16},{default:a(()=>[l($,{header:q.value||"选择文件查看"},{default:a(()=>[q.value?(i(),g(T,{key:0},[l(z,{modelValue:ee.value,"onUpdate:modelValue":e[24]||(e[24]=t=>ee.value=t),type:"textarea",rows:20},null,8,["modelValue"]),d("div",Ea,[l(o,{type:"primary",onClick:Dl},{default:a(()=>[...e[64]||(e[64]=[s("保存",-1)])]),_:1}),be.value?(i(),w(U,{key:0,type:"info",size:"small"},{default:a(()=>[s(r(Qe(be.value.size))+" · "+r(kl(be.value.modTime)),1)]),_:1})):I("",!0)])],64)):I("",!0)]),_:1},8,["header"])]),_:1})]),_:1})]),_:1}),l(L,{label:"定时任务",name:"cron"},{default:a(()=>[l(o,{type:"primary",onClick:e[25]||(e[25]=t=>le.value=!0),style:{"margin-bottom":"16px"}},{default:a(()=>[l(R,null,{default:a(()=>[l(F(Ve))]),_:1}),e[65]||(e[65]=s(" 新建任务 ",-1))]),_:1}),l(Ce,{data:Ke.value,stripe:""},{default:a(()=>[l(b,{prop:"name",label:"名称"}),l(b,{label:"调度"},{default:a(({row:t})=>[s(r(t.schedule?.expr)+" ("+r(t.schedule?.tz)+")",1)]),_:1}),l(b,{label:"最近运行",width:"180"},{default:a(({row:t})=>[t.state?.lastRunAtMs?(i(),g(T,{key:0},[l(y,{type:t.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:a(()=>[s(r(t.state?.lastStatus),1)]),_:2},1032,["type"]),l(U,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:a(()=>[s(r(Xe(t.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(i(),w(U,{key:1,type:"info",size:"small"},{default:a(()=>[...e[66]||(e[66]=[s("未运行",-1)])]),_:1}))]),_:1}),l(b,{label:"启用",width:"80"},{default:a(({row:t})=>[l(oe,{modelValue:t.enabled,"onUpdate:modelValue":V=>t.enabled=V,onChange:V=>El(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(b,{label:"操作",width:"220"},{default:a(({row:t})=>[t.payload?.message==="__MEMORY_CONSOLIDATE__"?(i(),g(T,{key:0},[l(y,{type:"info",size:"small",style:{"margin-right":"8px"}},{default:a(()=>[...e[67]||(e[67]=[s("记忆管理",-1)])]),_:1}),l(o,{size:"small",onClick:V=>Ze(t)},{default:a(()=>[...e[68]||(e[68]=[s("立即运行",-1)])]),_:1},8,["onClick"])],64)):(i(),g(T,{key:1},[l(o,{size:"small",onClick:V=>Ze(t)},{default:a(()=>[...e[69]||(e[69]=[s("立即运行",-1)])]),_:1},8,["onClick"]),l(o,{size:"small",type:"danger",onClick:V=>Ll(t)},{default:a(()=>[...e[70]||(e[70]=[s("删除",-1)])]),_:1},8,["onClick"])],64))]),_:1})]),_:1},8,["data"]),l(he,{modelValue:le.value,"onUpdate:modelValue":e[32]||(e[32]=t=>le.value=t),title:"新建定时任务",width:"520px"},{footer:a(()=>[l(o,{onClick:e[31]||(e[31]=t=>le.value=!1)},{default:a(()=>[...e[71]||(e[71]=[s("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:Nl},{default:a(()=>[...e[72]||(e[72]=[s("创建",-1)])]),_:1})]),default:a(()=>[l(ne,{model:C.value,"label-width":"100px"},{default:a(()=>[l(_,{label:"名称"},{default:a(()=>[l(z,{modelValue:C.value.name,"onUpdate:modelValue":e[26]||(e[26]=t=>C.value.name=t)},null,8,["modelValue"])]),_:1}),l(_,{label:"Cron 表达式"},{default:a(()=>[l(z,{modelValue:C.value.expr,"onUpdate:modelValue":e[27]||(e[27]=t=>C.value.expr=t),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),l(_,{label:"时区"},{default:a(()=>[l(M,{modelValue:C.value.tz,"onUpdate:modelValue":e[28]||(e[28]=t=>C.value.tz=t)},{default:a(()=>[l(c,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),l(c,{label:"UTC",value:"UTC"}),l(c,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),l(_,{label:"消息"},{default:a(()=>[l(z,{modelValue:C.value.message,"onUpdate:modelValue":e[29]||(e[29]=t=>C.value.message=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),l(_,{label:"启用"},{default:a(()=>[l(oe,{modelValue:C.value.enabled,"onUpdate:modelValue":e[30]||(e[30]=t=>C.value.enabled=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1}),l(L,{label:"渠道",name:"channels"},{default:a(()=>[d("div",La,[l(U,{type:"info",size:"small"},{default:a(()=>[...e[73]||(e[73]=[s("每个 AI 成员独立配置自己的消息通道（如 Telegram Bot Token）",-1)])]),_:1}),l(o,{type:"primary",size:"small",onClick:Cl},{default:a(()=>[l(R,null,{default:a(()=>[l(F(Ve))]),_:1}),e[74]||(e[74]=s(" 添加渠道 ",-1))]),_:1})]),tl((i(),w(Ce,{data:S.value,stripe:""},{default:a(()=>[l(b,{label:"类型",width:"110"},{default:a(({row:t})=>[l(y,{size:"small"},{default:a(()=>[s(r(t.type),1)]),_:2},1024)]),_:1}),l(b,{prop:"name",label:"名称","min-width":"140"}),l(b,{label:"配置","min-width":"200"},{default:a(({row:t})=>[l(U,{type:"info",size:"small"},{default:a(()=>[(i(!0),g(T,null,J(t.config,(V,se)=>(i(),g("span",{key:se,style:{"margin-right":"8px"}},[!String(se).toLowerCase().includes("token")&&!String(se).toLowerCase().includes("key")?(i(),g(T,{key:0},[s(r(se)+": "+r(V),1)],64)):(i(),g(T,{key:1},[s(r(se)+": •••••• ",1)],64))]))),128))]),_:2},1024)]),_:1}),l(b,{label:"启用",width:"80"},{default:a(({row:t})=>[l(oe,{modelValue:t.enabled,"onUpdate:modelValue":V=>t.enabled=V,size:"small",onChange:xl},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(b,{label:"状态",width:"90"},{default:a(({row:t})=>[l(y,{type:t.status==="ok"?"success":t.status==="error"?"danger":"info",size:"small"},{default:a(()=>[s(r(t.status==="ok"?"✓ 正常":t.status==="error"?"✗ 错误":"? 未测试"),1)]),_:2},1032,["type"])]),_:1}),l(b,{label:"操作",width:"190"},{default:a(({row:t})=>[l(o,{size:"small",onClick:V=>Tl(t),loading:Ee.value===t.id},{default:a(()=>[...e[75]||(e[75]=[s("测试",-1)])]),_:1},8,["onClick","loading"]),l(o,{size:"small",onClick:V=>hl(t)},{default:a(()=>[...e[76]||(e[76]=[s("编辑",-1)])]),_:1},8,["onClick"]),l(o,{size:"small",type:"danger",onClick:V=>zl(t)},{default:a(()=>[...e[77]||(e[77]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[al,we.value]]),!we.value&&!S.value.length?(i(),w(Re,{key:0,description:"暂无渠道，点击「添加渠道」开始配置","image-size":80,style:{"margin-top":"40px"}})):I("",!0),l(he,{modelValue:H.value,"onUpdate:modelValue":e[39]||(e[39]=t=>H.value=t),title:ae.value?"编辑渠道":"添加渠道",width:"520px"},{footer:a(()=>[l(o,{onClick:e[38]||(e[38]=t=>H.value=!1)},{default:a(()=>[...e[79]||(e[79]=[s("取消",-1)])]),_:1}),l(o,{type:"primary",onClick:Vl,loading:Ne.value},{default:a(()=>[...e[80]||(e[80]=[s("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(ne,{model:f.value,"label-width":"120px"},{default:a(()=>[l(_,{label:"类型",required:""},{default:a(()=>[l(M,{modelValue:f.value.type,"onUpdate:modelValue":e[33]||(e[33]=t=>f.value.type=t),style:{width:"100%"}},{default:a(()=>[l(c,{label:"Telegram",value:"telegram"}),l(c,{label:"iMessage",value:"imessage"}),l(c,{label:"WhatsApp",value:"whatsapp"})]),_:1},8,["modelValue"])]),_:1}),l(_,{label:"名称",required:""},{default:a(()=>[l(z,{modelValue:f.value.name,"onUpdate:modelValue":e[34]||(e[34]=t=>f.value.name=t),placeholder:"如 我的 Telegram Bot"},null,8,["modelValue"])]),_:1}),f.value.type==="telegram"?(i(),g(T,{key:0},[l(_,{label:"Bot Token",required:""},{default:a(()=>[l(z,{modelValue:f.value.botToken,"onUpdate:modelValue":e[35]||(e[35]=t=>f.value.botToken=t),type:"password","show-password":"",placeholder:"从 @BotFather 获取"},null,8,["modelValue"])]),_:1}),l(_,{label:"允许的用户"},{default:a(()=>[l(z,{modelValue:f.value.allowedFrom,"onUpdate:modelValue":e[36]||(e[36]=t=>f.value.allowedFrom=t),placeholder:"逗号分隔的 Telegram 用户 ID（留空=全部）"},null,8,["modelValue"]),l(U,{type:"info",size:"small"},{default:a(()=>[...e[78]||(e[78]=[s("留空则接受任何人发送的消息",-1)])]),_:1})]),_:1})],64)):I("",!0),l(_,{label:"启用"},{default:a(()=>[l(oe,{modelValue:f.value.enabled,"onUpdate:modelValue":e[37]||(e[37]=t=>f.value.enabled=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),qa=ta(Ba,[["__scopeId","data-v-55b0f7a4"]]);export{qa as default};
