import{d as L,h as q,c as f,f as C,a as e,w as a,g as A,r as s,o as r,k as G,z as H,e as d,t as y,F as z,i as N,j as K,p as P,E as i,u as Q}from"./index-tr2PN4cz.js";import{h as g}from"./index-CTYBXBE4.js";const W={class:"cron-page"},X={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"20px"}},Z={key:0,style:{"font-size":"13px",color:"#606266"}},ee={key:1,style:{color:"#c0c4cc","font-size":"12px"}},te={style:{"font-size":"12px","font-family":"monospace"}},ne=L({__name:"CronView",setup(le){const S=Q(),v=A([]),_=A(!1),o=P({name:"",remark:"",expr:"0 0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});q(b);async function b(){try{const n=await g.list();v.value=n.data||[]}catch{}}function T(n){return n?new Date(n).toLocaleString("zh-CN"):""}function w(n){return n.payload?.message==="__MEMORY_CONSOLIDATE__"}function M(n){n.agentId&&S.push({path:`/agents/${n.agentId}`,query:{tab:"memory"}})}async function $(){try{await g.create({name:o.name,remark:o.remark||void 0,enabled:o.enabled,schedule:{kind:"cron",expr:o.expr,tz:o.tz},payload:{kind:"agentTurn",message:o.message},delivery:{mode:"announce"}}),i.success("创建成功"),_.value=!1,Object.assign(o,{name:"",remark:"",expr:"0 0 9 * * *",message:"",enabled:!0}),b()}catch(n){i.error(n.response?.data?.error||"创建失败")}}async function E(n){try{await g.update(n.id,n)}catch{i.error("更新失败")}}async function B(n){try{await g.run(n.id),i.success("已触发"),setTimeout(b,2e3)}catch{i.error("触发失败")}}async function O(n){try{await g.delete(n.id),i.success("已删除"),b()}catch{i.error("删除失败")}}return(n,t)=>{const R=s("el-icon"),u=s("el-button"),m=s("el-table-column"),k=s("el-text"),h=s("el-tag"),U=s("el-switch"),j=s("el-table"),D=s("el-empty"),I=s("el-card"),V=s("el-input"),p=s("el-form-item"),x=s("el-option"),Y=s("el-select"),F=s("el-form"),J=s("el-dialog");return r(),f("div",W,[C("div",X,[t[10]||(t[10]=C("h2",{style:{margin:"0"}},"⏰ 定时任务",-1)),e(u,{type:"primary",onClick:t[0]||(t[0]=l=>_.value=!0)},{default:a(()=>[e(R,null,{default:a(()=>[e(G(H))]),_:1}),t[9]||(t[9]=d(" 新建任务 ",-1))]),_:1})]),e(I,{shadow:"hover"},{default:a(()=>[e(j,{data:v.value,stripe:""},{default:a(()=>[e(m,{prop:"name",label:"名称","min-width":"160"}),e(m,{label:"备注","min-width":"180","show-overflow-tooltip":""},{default:a(({row:l})=>[l.remark?(r(),f("span",Z,y(l.remark),1)):(r(),f("span",ee,"—"))]),_:1}),e(m,{label:"调度","min-width":"160"},{default:a(({row:l})=>[C("span",te,y(l.schedule?.expr),1),e(k,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:a(()=>[d("("+y(l.schedule?.tz)+")",1)]),_:2},1024)]),_:1}),e(m,{label:"最近运行",width:"180"},{default:a(({row:l})=>[l.state?.lastRunAtMs?(r(),f(z,{key:0},[e(h,{type:l.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:a(()=>[d(y(l.state?.lastStatus),1)]),_:2},1032,["type"]),e(k,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:a(()=>[d(y(T(l.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(r(),N(k,{key:1,type:"info",size:"small"},{default:a(()=>[...t[11]||(t[11]=[d("未运行",-1)])]),_:1}))]),_:1}),e(m,{label:"启用",width:"70"},{default:a(({row:l})=>[e(U,{modelValue:l.enabled,"onUpdate:modelValue":c=>l.enabled=c,onChange:c=>E(l),size:"small",disabled:w(l)},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"])]),_:1}),e(m,{label:"操作",width:"180"},{default:a(({row:l})=>[w(l)?(r(),f(z,{key:0},[e(h,{type:"info",size:"small",style:{"margin-right":"6px"}},{default:a(()=>[...t[12]||(t[12]=[d("记忆管理",-1)])]),_:1}),e(u,{size:"small",onClick:c=>M(l)},{default:a(()=>[...t[13]||(t[13]=[d("查看",-1)])]),_:1},8,["onClick"])],64)):(r(),f(z,{key:1},[e(u,{size:"small",onClick:c=>B(l)},{default:a(()=>[...t[14]||(t[14]=[d("立即运行",-1)])]),_:1},8,["onClick"]),e(u,{size:"small",type:"danger",onClick:c=>O(l)},{default:a(()=>[...t[15]||(t[15]=[d("删除",-1)])]),_:1},8,["onClick"])],64))]),_:1})]),_:1},8,["data"]),v.value.length===0?(r(),N(D,{key:0,description:"暂无定时任务"})):K("",!0)]),_:1}),e(J,{modelValue:_.value,"onUpdate:modelValue":t[8]||(t[8]=l=>_.value=l),title:"新建定时任务",width:"520px"},{footer:a(()=>[e(u,{onClick:t[7]||(t[7]=l=>_.value=!1)},{default:a(()=>[...t[17]||(t[17]=[d("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:$},{default:a(()=>[...t[18]||(t[18]=[d("创建",-1)])]),_:1})]),default:a(()=>[e(F,{model:o,"label-width":"100px"},{default:a(()=>[e(p,{label:"名称"},{default:a(()=>[e(V,{modelValue:o.name,"onUpdate:modelValue":t[1]||(t[1]=l=>o.name=l),placeholder:"任务名称"},null,8,["modelValue"])]),_:1}),e(p,{label:"备注"},{default:a(()=>[e(V,{modelValue:o.remark,"onUpdate:modelValue":t[2]||(t[2]=l=>o.remark=l),placeholder:"可选，说明这个任务的用途"},null,8,["modelValue"])]),_:1}),e(p,{label:"Cron 表达式"},{default:a(()=>[e(V,{modelValue:o.expr,"onUpdate:modelValue":t[3]||(t[3]=l=>o.expr=l),placeholder:"0 9 * * *"},null,8,["modelValue"]),e(k,{type:"info",size:"small",style:{"margin-top":"4px",display:"block"}},{default:a(()=>[...t[16]||(t[16]=[d(" 格式：秒(可选) 分 时 日 月 周。例：0 0 9 * * * = 每天09:00 ",-1)])]),_:1})]),_:1}),e(p,{label:"时区"},{default:a(()=>[e(Y,{modelValue:o.tz,"onUpdate:modelValue":t[4]||(t[4]=l=>o.tz=l)},{default:a(()=>[e(x,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),e(x,{label:"UTC",value:"UTC"}),e(x,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),e(p,{label:"消息"},{default:a(()=>[e(V,{modelValue:o.message,"onUpdate:modelValue":t[5]||(t[5]=l=>o.message=l),type:"textarea",rows:3,placeholder:"发送给 Agent 的消息内容"},null,8,["modelValue"])]),_:1}),e(p,{label:"启用"},{default:a(()=>[e(U,{modelValue:o.enabled,"onUpdate:modelValue":t[6]||(t[6]=l=>o.enabled=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});export{ne as default};
