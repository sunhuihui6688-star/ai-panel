import{d as xe,o as p,c as h,F as H,b as n,t as N,a as s,w as u,k as Ve,U as Be,i as de,f as v,j as X,l as oe,q as ke,n as Te,x as ne,r as x,h as Xe,T as Ye,m as Oe,g as C,E as L,N as Fe,e as ee,p as pe,M as ve}from"./index-B7IpLqft.js";import{r as G}from"./index-B6ZRKErS.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe={class:"rel-pair"},We={class:"rel-node"},Ge={style:{display:"flex","flex-direction":"column","align-items":"center",gap:"2px","flex-shrink":"0"}},He={class:"rel-node"},je={class:"type-grid"},Ie=["onClick"],qe={class:"type-card-top"},Je={class:"type-desc"},Ke=xe({__name:"RelTypeForm",props:{fromName:{},toName:{},type:{},strength:{},desc:{}},emits:["update:type","update:strength","update:desc","swap"],setup(R){const b=R,Y=ne(()=>[{value:"上下级",color:"#7c3aed",desc:`${b.fromName} 是 ${b.toName} 的上级，箭头指向下级`},{value:"平级协作",color:"#409eff",desc:`${b.fromName} 与 ${b.toName} 并列合作，地位平等`},{value:"支持",color:"#67c23a",desc:`${b.fromName} 为 ${b.toName} 提供支持和辅助`},{value:"其他",color:"#909399",desc:`${b.fromName} 与 ${b.toName} 之间的其他关系`}]);return(D,d)=>{const z=x("el-icon"),j=x("el-button"),O=x("el-radio-button"),I=x("el-radio-group"),q=x("el-form-item"),se=x("el-input"),J=x("el-form");return p(),h(H,null,[n("div",Pe,[n("span",We,N(R.fromName),1),n("div",Ge,[s(z,{style:{color:"#c0c4cc","font-size":"16px"}},{default:u(()=>[s(Ve(Be))]),_:1}),R.type==="上下级"?(p(),de(j,{key:0,size:"small",text:"",type:"primary",style:{padding:"0 4px","font-size":"11px",height:"18px","min-height":"0"},onClick:d[0]||(d[0]=w=>D.$emit("swap")),title:"交换上下级方向"},{default:u(()=>[...d[3]||(d[3]=[v(" ⇄ 翻转 ",-1)])]),_:1})):X("",!0)]),n("span",He,N(R.toName),1)]),n("div",je,[(p(!0),h(H,null,oe(Y.value,w=>(p(),h("div",{key:w.value,class:ke(["type-card",{active:R.type===w.value}]),onClick:ce=>D.$emit("update:type",w.value)},[n("div",qe,[n("span",{class:"type-tag",style:Te({background:w.color+"18",color:w.color})},N(w.value),5)]),n("div",Je,N(w.desc),1)],10,Ie))),128))]),s(J,{"label-width":"72px",style:{"margin-top":"16px"}},{default:u(()=>[s(q,{label:"关系强度"},{default:u(()=>[s(I,{"model-value":R.strength,"onUpdate:modelValue":d[1]||(d[1]=w=>D.$emit("update:strength",w))},{default:u(()=>[s(O,{value:"核心"},{default:u(()=>[...d[4]||(d[4]=[v("核心",-1)])]),_:1}),s(O,{value:"常用"},{default:u(()=>[...d[5]||(d[5]=[v("常用",-1)])]),_:1}),s(O,{value:"偶尔"},{default:u(()=>[...d[6]||(d[6]=[v("偶尔",-1)])]),_:1})]),_:1},8,["model-value"])]),_:1}),s(q,{label:"说明"},{default:u(()=>[s(se,{"model-value":R.desc,"onUpdate:modelValue":d[2]||(d[2]=w=>D.$emit("update:desc",w)),placeholder:"可选备注"},null,8,["model-value"])]),_:1})]),_:1})],64)}}}),ye=we(Ke,[["__scopeId","data-v-cf559621"]]),Qe={class:"team-view"},Ze={class:"page-header"},et={style:{display:"flex",gap:"8px"}},tt={key:0,class:"empty-state"},ot={key:0,class:"connect-banner"},nt={style:{margin:"0 4px"}},st=["width","height"],lt=["x1","y1","x2","y2"],rt=["x1","y1","x2","y2","onClick"],at=["x1","y1","x2","y2","stroke","stroke-width","marker-end"],it=["x","y","fill"],ut=["transform","onMousedown","onClick"],dt={key:0,r:"37",fill:"none",stroke:"#409eff","stroke-width":"2.5","stroke-dasharray":"7,3",class:"selection-ring"},ct={key:1,r:"33",fill:"rgba(64,158,255,0.06)",stroke:"#409eff","stroke-width":"1.5","stroke-opacity":"0.5"},ft=["fill"],mt={"text-anchor":"middle","dominant-baseline":"central",fill:"#fff","font-weight":"700","font-size":"15","font-family":"system-ui, sans-serif"},pt=["fill"],vt={"text-anchor":"middle",y:"46","font-size":"12",fill:"#303133","font-family":"system-ui, sans-serif","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},yt={"text-anchor":"middle",y:"58","font-size":"10",fill:"#909399","font-family":"system-ui, monospace"},gt={key:1,class:"no-edge-hint"},ht={class:"legend"},xt={class:"legend-item"},kt={class:"legend-item"},wt={width:"28",height:"8"},_t=["stroke-width"],ue=28,ge=160,te=90,he=80,Ct=xe({__name:"TeamView",setup(R){const b=C(),Y=C(),D=C(!1),d=C({nodes:[],edges:[]}),z=C(860),j={核心:4,常用:2.5,偶尔:1.5},O={上下级:"#7c3aed",上级:"#7c3aed",下级:"#7c3aed",平级协作:"#409eff",支持:"#67c23a",其他:"#909399"};function I(t){return O[t]??"#94a3b8"}function q(t){return t==="上下级"||t==="上级"||t==="下级"}function se(t,e){const l={};t.forEach(a=>{l[a.id]=0});const r=t.length+2;for(let a=0;a<r;a++){let k=!1;for(const m of e){const U=l[m.from]??0,V=l[m.to]??0;if(m.type==="上下级"){const M=U+1;V<M&&(l[m.to]=M,k=!0)}else if(m.type==="上级"){const M=U-1;V>M&&(l[m.to]=M,k=!0)}else if(m.type==="下级"){const M=U+1;V<M&&(l[m.to]=M,k=!0)}}if(!k)break}const i=Object.values(l),g=i.length?Math.min(...i):0;return t.forEach(a=>{l[a.id]=(l[a.id]??0)-g}),l}const J=ne(()=>se(d.value.nodes,d.value.edges)),w=ne(()=>{const t=Object.values(J.value).reduce((e,l)=>Math.max(e,l),0);return Math.max(600,te+t*ge+160)}),ce=ne(()=>{const t=d.value.nodes,e=J.value,l=z.value,r={};t.forEach(g=>{const a=e[g.id]??0;r[a]||(r[a]=[]),r[a].push(g.id)});const i={};for(const[g,a]of Object.entries(r)){const k=Number(g),m=te+k*ge,U=l-he*2,V=a.length>1?U/(a.length-1):0;a.forEach((M,Z)=>{i[M]={x:Math.round(a.length===1?l/2:he+Z*V),y:Math.round(m)}})}return i}),K=C({}),_=C(null),Q=C({x:400,y:te}),F=C(null);function $(t){return K.value[t]??ce.value[t]??{x:z.value/2,y:te}}function _e(t,e){t.preventDefault(),F.value=null;const l=$(e),r=le(t.clientX,t.clientY);_.value={id:e,startClientX:t.clientX,startClientY:t.clientY,offsetX:l.x-r.x,offsetY:l.y-r.y,moved:!1},document.addEventListener("mousemove",re),document.addEventListener("mouseup",ae)}function le(t,e){const l=b.value;if(!l)return{x:t,y:e};const r=l.getScreenCTM();if(!r){const a=l.getBoundingClientRect(),k=a.width>0?z.value/a.width:1,m=a.height>0?w.value/a.height:1;return{x:(t-a.left)*k,y:(e-a.top)*m}}const i=l.createSVGPoint();i.x=t,i.y=e;const g=i.matrixTransform(r.inverse());return{x:g.x,y:g.y}}function re(t){const e=le(t.clientX,t.clientY);if(Q.value=e,!_.value)return;const l=t.clientX-_.value.startClientX,r=t.clientY-_.value.startClientY;if((Math.abs(l)>4||Math.abs(r)>4)&&(_.value.moved=!0),!_.value.moved)return;const i=e.x+_.value.offsetX,g=e.y+_.value.offsetY,a=ue+4,k=1/0,m=ue+4,U=1/0;K.value={...K.value,[_.value.id]:{x:Math.round(Math.max(a,Math.min(k,i))),y:Math.round(Math.max(m,Math.min(U,g)))}}}function ae(){_.value?.moved&&(F.value=_.value.id),_.value=null,document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae)}function Ce(t){_.value||(Q.value=le(t.clientX,t.clientY))}function Me(){y.value=null}const y=C(null);function be(t){if(F.value===t){F.value=null;return}if(F.value=null,!y.value){y.value=t;return}if(y.value===t){y.value=null;return}const e=y.value;y.value=null,Ne(e,t)}function S(t,e,l){const r=$(t),i=$(e),g=i.x-r.x,a=i.y-r.y,k=Math.sqrt(g*g+a*a)||1,m=ue+3;return l==="start"?{x:r.x+g/k*m,y:r.y+a/k*m}:{x:i.x-g/k*m,y:i.y-a/k*m}}function $e(t){return j[t]??1.5}const fe=["#409EFF","#67C23A","#E6A23C","#F56C6C","#7C3AED","#0891B2","#B45309","#64748B"];function Ee(t){let e=0;for(let l=0;l<t.length;l++)e=t.charCodeAt(l)+((e<<5)-e);return fe[Math.abs(e)%fe.length]??"#409EFF"}function Ue(t){return(t||"?").charAt(0).toUpperCase()}function A(t){return d.value.nodes.find(e=>e.id===t)?.name??t}function Le(){K.value={},L.success("已重置为自动布局")}const P=C(!1),f=pe({from:"",to:"",type:"平级协作",strength:"常用",desc:""}),E=C(!1);function Ne(t,e){if(d.value.edges.some(r=>r.from===t&&r.to===e||r.from===e&&r.to===t)){const r=d.value.edges.find(i=>i.from===t&&i.to===e||i.from===e&&i.to===t);me(r);return}f.from=t,f.to=e,f.type="平级协作",f.strength="常用",f.desc="",P.value=!0}async function De(){if(!E.value){E.value=!0;try{await G.putEdge(f.from,f.to,f.type,f.strength,f.desc),L.success("关系已建立"),P.value=!1,await T()}catch{L.error("保存失败")}finally{E.value=!1}}}const B=C(!1),c=pe({from:"",to:"",type:"平级协作",strength:"常用",desc:""});function me(t){c.from=t.from,c.to=t.to,c.type=t.type,c.strength=t.strength,c.desc=t.label,B.value=!0}async function Re(){if(!E.value){E.value=!0;try{await G.putEdge(c.from,c.to,c.type,c.strength,c.desc),L.success("关系已更新"),B.value=!1,await T()}catch{L.error("保存失败")}finally{E.value=!1}}}async function Se(){try{await ve.confirm(`删除 ${A(c.from)} ↔ ${A(c.to)} 的关系？`,"删除关系",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"})}catch{return}E.value=!0;try{await G.deleteEdge(c.from,c.to),L.success("关系已删除"),B.value=!1,await T()}catch{L.error("删除失败")}finally{E.value=!1}}async function T(){D.value=!0;try{const t=await G.graph();d.value=t.data}catch{L.error("加载图谱失败")}finally{D.value=!1}}async function ze(){try{await ve.confirm("将清空所有成员的关系，不可恢复。确认吗？","清空所有关系",{confirmButtonText:"确认清空",cancelButtonText:"取消",type:"warning"})}catch{return}try{await G.clearAll(),L.success("已清空所有成员关系"),await T()}catch{L.error("清空失败")}}let ie=null;return Xe(()=>{T(),Y.value&&(ie=new ResizeObserver(t=>{const e=t[0]?.contentRect.width;e&&e>100&&(z.value=Math.floor(e))}),ie.observe(Y.value))}),Ye(()=>{ie?.disconnect(),document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae)}),(t,e)=>{const l=x("Grid"),r=x("el-icon"),i=x("el-button"),g=x("Refresh"),a=x("Delete"),k=x("Share"),m=x("Link"),U=x("el-card"),V=x("ArrowUp"),M=x("ArrowDown"),Z=x("el-dialog"),Ae=Fe("loading");return p(),h("div",Qe,[n("div",Ze,[e[16]||(e[16]=n("h2",null,"团队关系图谱",-1)),n("div",et,[s(i,{size:"small",onClick:Le},{default:u(()=>[s(r,null,{default:u(()=>[s(l)]),_:1}),e[13]||(e[13]=v(" 整理 ",-1))]),_:1}),s(i,{size:"small",onClick:T},{default:u(()=>[s(r,null,{default:u(()=>[s(g)]),_:1}),e[14]||(e[14]=v(" 刷新 ",-1))]),_:1}),s(i,{size:"small",type:"danger",plain:"",onClick:ze},{default:u(()=>[s(r,null,{default:u(()=>[s(a)]),_:1}),e[15]||(e[15]=v(" 清空关系 ",-1))]),_:1})])]),Oe((p(),de(U,{class:"graph-card"},{default:u(()=>[!D.value&&!d.value.nodes.length?(p(),h("div",tt,[s(r,{style:{"font-size":"64px",color:"#c0c4cc",display:"block",margin:"0 auto 16px"}},{default:u(()=>[s(k)]),_:1}),e[17]||(e[17]=n("p",{style:{color:"#909399","text-align":"center",margin:"0"}},"暂无成员数据",-1))])):(p(),h("div",{key:1,class:"graph-container",ref_key:"graphContainerRef",ref:Y},[y.value?(p(),h("div",ot,[s(r,{style:{"margin-right":"6px"}},{default:u(()=>[s(m)]),_:1}),e[19]||(e[19]=v(" 连线模式：已选中 ",-1)),n("strong",nt,N(A(y.value)),1),e[20]||(e[20]=v("，点击另一个成员建立关系 ",-1)),s(i,{size:"small",text:"",style:{"margin-left":"8px"},onClick:e[0]||(e[0]=o=>y.value=null)},{default:u(()=>[...e[18]||(e[18]=[v("取消",-1)])]),_:1})])):X("",!0),(p(),h("svg",{ref_key:"svgRef",ref:b,width:z.value,height:w.value,class:"graph-svg",onMousemove:Ce,onClick:ee(Me,["self"]),style:{display:"block",width:"100%",overflow:"visible"}},[e[22]||(e[22]=n("defs",null,[n("pattern",{id:"smallGrid",width:"20",height:"20",patternUnits:"userSpaceOnUse"},[n("path",{d:"M 20 0 L 0 0 0 20",fill:"none",stroke:"#e8ecf0","stroke-width":"0.5"})]),n("pattern",{id:"grid",width:"100",height:"100",patternUnits:"userSpaceOnUse"},[n("rect",{width:"100",height:"100",fill:"url(#smallGrid)"}),n("path",{d:"M 100 0 L 0 0 0 100",fill:"none",stroke:"#dde1e7","stroke-width":"1"})]),n("marker",{id:"arrow-上下级",markerWidth:"10",markerHeight:"10",refX:"9",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse"},[n("path",{d:"M1,2 L1,8 L9,5 z",fill:"#7c3aed","fill-opacity":"0.85"})]),n("marker",{id:"arrow-上级",markerWidth:"10",markerHeight:"10",refX:"9",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse"},[n("path",{d:"M1,2 L1,8 L9,5 z",fill:"#7c3aed","fill-opacity":"0.85"})]),n("marker",{id:"arrow-下级",markerWidth:"10",markerHeight:"10",refX:"9",refY:"5",orient:"auto",markerUnits:"userSpaceOnUse"},[n("path",{d:"M1,2 L1,8 L9,5 z",fill:"#7c3aed","fill-opacity":"0.85"})])],-1)),e[23]||(e[23]=n("rect",{width:"100%",height:"100%",fill:"url(#grid)",rx:"0"},null,-1)),y.value&&!_.value?(p(),h("line",{key:0,x1:$(y.value).x,y1:$(y.value).y,x2:Q.value.x,y2:Q.value.y,stroke:"#409eff","stroke-width":"2","stroke-dasharray":"6,4","stroke-opacity":"0.7","pointer-events":"none"},null,8,lt)):X("",!0),(p(!0),h(H,null,oe(d.value.edges,o=>(p(),h("g",{key:`${o.from}|${o.to}`},[n("line",{x1:S(o.from,o.to,"start").x,y1:S(o.from,o.to,"start").y,x2:S(o.from,o.to,"end").x,y2:S(o.from,o.to,"end").y,stroke:"transparent","stroke-width":"14",style:{cursor:"pointer"},onClick:ee(W=>me(o),["stop"])},null,8,rt),n("line",{x1:S(o.from,o.to,"start").x,y1:S(o.from,o.to,"start").y,x2:S(o.from,o.to,"end").x,y2:S(o.from,o.to,"end").y,stroke:I(o.type),"stroke-width":$e(o.strength),"stroke-opacity":"0.7","stroke-linecap":"round","marker-end":q(o.type)?`url(#arrow-${o.type})`:void 0,"pointer-events":"none",class:"graph-edge"},null,8,at),n("text",{x:($(o.from).x+$(o.to).x)/2,y:($(o.from).y+$(o.to).y)/2-6,"text-anchor":"middle","font-size":"10",fill:I(o.type),"pointer-events":"none","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},N(o.type),9,it)]))),128)),(p(!0),h(H,null,oe(d.value.nodes,o=>(p(),h("g",{key:o.id,transform:`translate(${$(o.id).x}, ${$(o.id).y})`,class:ke(["graph-node",{"node-selected":y.value===o.id},{"node-target":!!y.value&&y.value!==o.id}]),style:{cursor:"grab"},onMousedown:ee(W=>_e(W,o.id),["stop"]),onClick:ee(()=>be(o.id),["stop"])},[y.value===o.id?(p(),h("circle",dt)):y.value?(p(),h("circle",ct)):X("",!0),e[21]||(e[21]=n("circle",{r:"30",fill:"rgba(0,0,0,0.07)",transform:"translate(2,3)"},null,-1)),n("circle",{r:"28",fill:Ee(o.id),stroke:"#fff","stroke-width":"2.5"},null,8,ft),n("text",mt,N(Ue(o.id)),1),n("circle",{cx:"20",cy:"-20",r:"6",fill:o.status==="running"?"#67C23A":"#c0c4cc",stroke:"#fff","stroke-width":"1.5"},null,8,pt),n("text",vt,N(o.name),1),n("text",yt,N(o.id),1)],42,ut))),128))],40,st)),d.value.edges.length?X("",!0):(p(),h("div",gt," 点击任意成员选中，再点击另一个成员即可创建关系连线 "))],512))]),_:1})),[[Ae,D.value]]),d.value.nodes.length?(p(),de(U,{key:0,class:"legend-card"},{default:u(()=>[n("div",ht,[e[26]||(e[26]=n("span",{class:"legend-title"},"布局规则：",-1)),n("span",xt,[s(r,null,{default:u(()=>[s(V)]),_:1}),e[24]||(e[24]=v(" 上方 = 上级（箭头指下）",-1))]),e[27]||(e[27]=n("span",{class:"legend-item"},"— 同层 = 平级/协作",-1)),n("span",kt,[s(r,null,{default:u(()=>[s(M)]),_:1}),e[25]||(e[25]=v(" 下方 = 下级",-1))]),e[28]||(e[28]=n("span",{class:"legend-divider"},"|",-1)),e[29]||(e[29]=n("span",{class:"legend-title"},"线粗：",-1)),(p(),h(H,null,oe(j,(o,W)=>n("span",{key:W,class:"legend-item"},[(p(),h("svg",wt,[n("line",{x1:"0",y1:"4",x2:"28",y2:"4",stroke:"#64748b","stroke-width":o,"stroke-linecap":"round"},null,8,_t)])),v(" "+N(W),1)])),64)),e[30]||(e[30]=n("span",{class:"legend-divider"},"|",-1)),e[31]||(e[31]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#67C23A"})]),v(" 运行中 ")],-1)),e[32]||(e[32]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#c0c4cc"})]),v(" 空闲 ")],-1))])]),_:1})):X("",!0),s(Z,{modelValue:P.value,"onUpdate:modelValue":e[6]||(e[6]=o=>P.value=o),title:"建立关系",width:"460px","close-on-click-modal":!1},{footer:u(()=>[s(i,{onClick:e[5]||(e[5]=o=>P.value=!1)},{default:u(()=>[...e[33]||(e[33]=[v("取消",-1)])]),_:1}),s(i,{type:"primary",loading:E.value,onClick:De},{default:u(()=>[...e[34]||(e[34]=[v("建立",-1)])]),_:1},8,["loading"])]),default:u(()=>[s(ye,{"from-name":A(f.from),"to-name":A(f.to),type:f.type,"onUpdate:type":e[1]||(e[1]=o=>f.type=o),strength:f.strength,"onUpdate:strength":e[2]||(e[2]=o=>f.strength=o),desc:f.desc,"onUpdate:desc":e[3]||(e[3]=o=>f.desc=o),onSwap:e[4]||(e[4]=()=>{const o=f.from;f.from=f.to,f.to=o})},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"]),s(Z,{modelValue:B.value,"onUpdate:modelValue":e[12]||(e[12]=o=>B.value=o),title:"编辑关系",width:"460px","close-on-click-modal":!1},{footer:u(()=>[s(i,{type:"danger",plain:"",loading:E.value,onClick:Se},{default:u(()=>[...e[35]||(e[35]=[v("删除关系",-1)])]),_:1},8,["loading"]),s(i,{onClick:e[11]||(e[11]=o=>B.value=!1)},{default:u(()=>[...e[36]||(e[36]=[v("取消",-1)])]),_:1}),s(i,{type:"primary",loading:E.value,onClick:Re},{default:u(()=>[...e[37]||(e[37]=[v("保存",-1)])]),_:1},8,["loading"])]),default:u(()=>[s(ye,{"from-name":A(c.from),"to-name":A(c.to),type:c.type,"onUpdate:type":e[7]||(e[7]=o=>c.type=o),strength:c.strength,"onUpdate:strength":e[8]||(e[8]=o=>c.strength=o),desc:c.desc,"onUpdate:desc":e[9]||(e[9]=o=>c.desc=o),onSwap:e[10]||(e[10]=()=>{const o=c.from;c.from=c.to,c.to=o})},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"])])}}}),Et=we(Ct,[["__scopeId","data-v-e9e122a0"]]);export{Et as default};
