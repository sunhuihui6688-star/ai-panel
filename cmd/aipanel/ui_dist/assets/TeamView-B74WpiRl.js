import{d as ct,o as d,c as p,F as G,b as n,t as A,a as s,w as a,k as Dt,U as Rt,l as I,q as ft,n as Ut,f as c,x as J,r as y,h as Vt,m as Bt,i as lt,j as O,g as M,E,N as zt,e as q,p as at,M as rt}from"./index-Cdf1qXez.js";import{r as j}from"./index-B6ZRKErS.js";import{_ as mt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ft={class:"rel-pair"},Lt={class:"rel-node"},St={class:"rel-node"},Tt={class:"type-grid"},Xt=["onClick"],Pt={class:"type-card-top"},Yt={class:"type-desc"},Ot=ct({__name:"RelTypeForm",props:{fromName:{},toName:{},type:{},strength:{},desc:{}},emits:["update:type","update:strength","update:desc"],setup(U){const b=U,z=J(()=>[{value:"上级",color:"#f56c6c",desc:`${b.toName} 是 ${b.fromName} 的上级，负责领导和管理`},{value:"下级",color:"#e6a23c",desc:`${b.toName} 是 ${b.fromName} 的下级，接受指导和分配任务`},{value:"平级协作",color:"#409eff",desc:`${b.fromName} 与 ${b.toName} 并列合作，地位平等`},{value:"支持",color:"#67c23a",desc:`${b.toName} 为 ${b.fromName} 提供支持和辅助`}]);return(g,k)=>{const K=y("el-icon"),F=y("el-radio-button"),Q=y("el-radio-group"),X=y("el-form-item"),Z=y("el-input"),tt=y("el-form");return d(),p(G,null,[n("div",Ft,[n("span",Lt,A(U.fromName),1),s(K,{style:{color:"#c0c4cc","flex-shrink":"0","font-size":"18px"}},{default:a(()=>[s(Dt(Rt))]),_:1}),n("span",St,A(U.toName),1)]),n("div",Tt,[(d(!0),p(G,null,I(z.value,x=>(d(),p("div",{key:x.value,class:ft(["type-card",{active:U.type===x.value}]),onClick:w=>g.$emit("update:type",x.value)},[n("div",Pt,[n("span",{class:"type-tag",style:Ut({background:x.color+"18",color:x.color})},A(x.value),5)]),n("div",Yt,A(x.desc),1)],10,Xt))),128))]),s(tt,{"label-width":"72px",style:{"margin-top":"16px"}},{default:a(()=>[s(X,{label:"关系强度"},{default:a(()=>[s(Q,{"model-value":U.strength,"onUpdate:modelValue":k[0]||(k[0]=x=>g.$emit("update:strength",x))},{default:a(()=>[s(F,{value:"核心"},{default:a(()=>[...k[2]||(k[2]=[c("核心",-1)])]),_:1}),s(F,{value:"常用"},{default:a(()=>[...k[3]||(k[3]=[c("常用",-1)])]),_:1}),s(F,{value:"偶尔"},{default:a(()=>[...k[4]||(k[4]=[c("偶尔",-1)])]),_:1})]),_:1},8,["model-value"])]),_:1}),s(X,{label:"说明"},{default:a(()=>[s(Z,{"model-value":U.desc,"onUpdate:modelValue":k[1]||(k[1]=x=>g.$emit("update:desc",x)),placeholder:"可选备注"},null,8,["model-value"])]),_:1})]),_:1})],64)}}}),it=mt(Ot,[["__scopeId","data-v-0bce55d0"]]),jt={class:"team-view"},Wt={class:"page-header"},Gt={style:{display:"flex",gap:"8px"}},qt={key:0,class:"empty-state"},Ht={key:1,class:"graph-container"},It={key:0,class:"connect-banner"},Jt={style:{margin:"0 4px"}},Kt=["height"],Qt=["x1","y1","x2","y2"],Zt=["x1","y1","x2","y2","onClick"],te=["x1","y1","x2","y2","stroke","stroke-width"],ee=["x","y","fill"],oe=["transform","onMousedown","onClick"],ne={key:0,r:"37",fill:"none",stroke:"#409eff","stroke-width":"2.5","stroke-dasharray":"7,3",class:"selection-ring"},se={key:1,r:"33",fill:"rgba(64,158,255,0.06)",stroke:"#409eff","stroke-width":"1.5","stroke-opacity":"0.5"},le=["fill"],ae={"text-anchor":"middle","dominant-baseline":"central",fill:"#fff","font-weight":"700","font-size":"15","font-family":"system-ui, sans-serif"},re=["fill"],ie={"text-anchor":"middle",y:"46","font-size":"12",fill:"#303133","font-family":"system-ui, sans-serif","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},ue={"text-anchor":"middle",y:"58","font-size":"10",fill:"#909399","font-family":"system-ui, monospace"},de={key:1,class:"no-edge-hint"},ce={class:"legend"},fe={class:"legend-item"},me={class:"legend-item"},pe={width:"28",height:"8"},ve=["stroke-width"],W=860,ye=28,ut=160,H=90,dt=80,ge=ct({__name:"TeamView",setup(U){const b=M(),z=M(!1),g=M({nodes:[],edges:[]}),k={核心:4,常用:2.5,偶尔:1.5},K={上级:"#f56c6c",下级:"#e6a23c",平级协作:"#409eff",支持:"#67c23a"};function F(o){return K[o]??"#94a3b8"}function Q(o,t){const l={};o.forEach(_=>{l[_.id]=0});const r=o.length+2;for(let _=0;_<r;_++){let C=!1;for(const h of t){const B=l[h.from]??0,T=l[h.to]??0;if(h.type==="上级"){const D=B-1;T>D&&(l[h.to]=D,C=!0)}else if(h.type==="下级"){const D=B+1;T<D&&(l[h.to]=D,C=!0)}}if(!C)break}const i=Object.values(l),v=i.length?Math.min(...i):0;return o.forEach(_=>{l[_.id]=(l[_.id]??0)-v}),l}const X=J(()=>Q(g.value.nodes,g.value.edges)),Z=J(()=>{const o=Object.values(X.value).reduce((t,l)=>Math.max(t,l),0);return Math.max(400,H+o*ut+160)}),tt=J(()=>{const o=g.value.nodes,t=X.value,l={};o.forEach(i=>{const v=t[i.id]??0;l[v]||(l[v]=[]),l[v].push(i.id)});const r={};for(const[i,v]of Object.entries(l)){const _=Number(i),C=H+_*ut,h=W-dt*2,B=v.length>1?h/(v.length-1):0;v.forEach((T,D)=>{r[T]={x:Math.round(v.length===1?W/2:dt+D*B),y:Math.round(C)}})}return r}),x=M({}),w=M(null),et=M({x:W/2,y:H});function $(o){return x.value[o]??tt.value[o]??{x:W/2,y:H}}function pt(o,t){const l=$(t);w.value={id:t,startClientX:o.clientX,startClientY:o.clientY,startNodeX:l.x,startNodeY:l.y,moved:!1}}function vt(o){const t=b.value.getBoundingClientRect();if(et.value={x:o.clientX-t.left,y:o.clientY-t.top},!w.value)return;const l=o.clientX-w.value.startClientX,r=o.clientY-w.value.startClientY;(Math.abs(l)>4||Math.abs(r)>4)&&(w.value.moved=!0),w.value.moved&&(x.value={...x.value,[w.value.id]:{x:w.value.startNodeX+l,y:w.value.startNodeY+r}})}function yt(){w.value=null}function gt(){w.value=null}function xt(){f.value=null}const f=M(null);function _t(o){if(w.value?.moved)return;if(!f.value){f.value=o;return}if(f.value===o){f.value=null;return}const t=f.value;f.value=null,bt(t,o)}function R(o,t,l){const r=$(o),i=$(t),v=i.x-r.x,_=i.y-r.y,C=Math.sqrt(v*v+_*_)||1,h=ye+3;return l==="start"?{x:r.x+v/C*h,y:r.y+_/C*h}:{x:i.x-v/C*h,y:i.y-_/C*h}}function ht(o){return k[o]??1.5}const ot=["#409EFF","#67C23A","#E6A23C","#F56C6C","#7C3AED","#0891B2","#B45309","#64748B"];function kt(o){let t=0;for(let l=0;l<o.length;l++)t=o.charCodeAt(l)+((t<<5)-t);return ot[Math.abs(t)%ot.length]??"#409EFF"}function wt(o){return(o||"?").charAt(0).toUpperCase()}function V(o){return g.value.nodes.find(t=>t.id===o)?.name??o}function Ct(){x.value={},E.success("已重置为自动布局")}const P=M(!1),m=at({from:"",to:"",type:"平级协作",strength:"常用",desc:""}),N=M(!1);function bt(o,t){if(g.value.edges.some(r=>r.from===o&&r.to===t||r.from===t&&r.to===o)){const r=g.value.edges.find(i=>i.from===o&&i.to===t||i.from===t&&i.to===o);nt(r);return}m.from=o,m.to=t,m.type="平级协作",m.strength="常用",m.desc="",P.value=!0}async function $t(){if(!N.value){N.value=!0;try{await j.putEdge(m.from,m.to,m.type,m.strength,m.desc),E.success("关系已建立"),P.value=!1,await S()}catch{E.error("保存失败")}finally{N.value=!1}}}const L=M(!1),u=at({from:"",to:"",type:"平级协作",strength:"常用",desc:""});function nt(o){u.from=o.from,u.to=o.to,u.type=o.type,u.strength=o.strength,u.desc=o.label,L.value=!0}async function Nt(){if(!N.value){N.value=!0;try{await j.putEdge(u.from,u.to,u.type,u.strength,u.desc),E.success("关系已更新"),L.value=!1,await S()}catch{E.error("保存失败")}finally{N.value=!1}}}async function Mt(){try{await rt.confirm(`删除 ${V(u.from)} ↔ ${V(u.to)} 的关系？`,"删除关系",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"})}catch{return}N.value=!0;try{await j.deleteEdge(u.from,u.to),E.success("关系已删除"),L.value=!1,await S()}catch{E.error("删除失败")}finally{N.value=!1}}async function S(){z.value=!0;try{const o=await j.graph();g.value=o.data}catch{E.error("加载图谱失败")}finally{z.value=!1}}async function Et(){try{await rt.confirm("将清空所有成员的关系，不可恢复。确认吗？","清空所有关系",{confirmButtonText:"确认清空",cancelButtonText:"取消",type:"warning"})}catch{return}try{await j.clearAll(),E.success("已清空所有成员关系"),await S()}catch{E.error("清空失败")}}return Vt(S),(o,t)=>{const l=y("Grid"),r=y("el-icon"),i=y("el-button"),v=y("Refresh"),_=y("Delete"),C=y("Share"),h=y("Link"),B=y("el-card"),T=y("ArrowUp"),D=y("ArrowDown"),st=y("el-dialog"),At=zt("loading");return d(),p("div",jt,[n("div",Wt,[t[14]||(t[14]=n("h2",null,"团队关系图谱",-1)),n("div",Gt,[s(i,{size:"small",onClick:Ct},{default:a(()=>[s(r,null,{default:a(()=>[s(l)]),_:1}),t[11]||(t[11]=c(" 整理 ",-1))]),_:1}),s(i,{size:"small",onClick:S},{default:a(()=>[s(r,null,{default:a(()=>[s(v)]),_:1}),t[12]||(t[12]=c(" 刷新 ",-1))]),_:1}),s(i,{size:"small",type:"danger",plain:"",onClick:Et},{default:a(()=>[s(r,null,{default:a(()=>[s(_)]),_:1}),t[13]||(t[13]=c(" 清空关系 ",-1))]),_:1})])]),Bt((d(),lt(B,{class:"graph-card"},{default:a(()=>[!z.value&&!g.value.nodes.length?(d(),p("div",qt,[s(r,{style:{"font-size":"64px",color:"#c0c4cc",display:"block",margin:"0 auto 16px"}},{default:a(()=>[s(C)]),_:1}),t[15]||(t[15]=n("p",{style:{color:"#909399","text-align":"center",margin:"0"}},"暂无成员数据",-1))])):(d(),p("div",Ht,[f.value?(d(),p("div",It,[s(r,{style:{"margin-right":"6px"}},{default:a(()=>[s(h)]),_:1}),t[17]||(t[17]=c(" 连线模式：已选中 ",-1)),n("strong",Jt,A(V(f.value)),1),t[18]||(t[18]=c("，点击另一个成员建立关系 ",-1)),s(i,{size:"small",text:"",style:{"margin-left":"8px"},onClick:t[0]||(t[0]=e=>f.value=null)},{default:a(()=>[...t[16]||(t[16]=[c("取消",-1)])]),_:1})])):O("",!0),(d(),p("svg",{ref_key:"svgRef",ref:b,width:W,height:Z.value,class:"graph-svg",onMousemove:vt,onMouseup:yt,onMouseleave:gt,onClick:q(xt,["self"])},[f.value?(d(),p("line",{key:0,x1:$(f.value).x,y1:$(f.value).y,x2:et.value.x,y2:et.value.y,stroke:"#409eff","stroke-width":"2","stroke-dasharray":"6,4","stroke-opacity":"0.7","pointer-events":"none"},null,8,Qt)):O("",!0),(d(!0),p(G,null,I(g.value.edges,e=>(d(),p("g",{key:`${e.from}|${e.to}`},[n("line",{x1:R(e.from,e.to,"start").x,y1:R(e.from,e.to,"start").y,x2:R(e.from,e.to,"end").x,y2:R(e.from,e.to,"end").y,stroke:"transparent","stroke-width":"14",style:{cursor:"pointer"},onClick:q(Y=>nt(e),["stop"])},null,8,Zt),n("line",{x1:R(e.from,e.to,"start").x,y1:R(e.from,e.to,"start").y,x2:R(e.from,e.to,"end").x,y2:R(e.from,e.to,"end").y,stroke:F(e.type),"stroke-width":ht(e.strength),"stroke-opacity":"0.7","stroke-linecap":"round","pointer-events":"none",class:"graph-edge"},null,8,te),n("text",{x:($(e.from).x+$(e.to).x)/2,y:($(e.from).y+$(e.to).y)/2-6,"text-anchor":"middle","font-size":"10",fill:F(e.type),"pointer-events":"none","paint-order":"stroke",stroke:"#f5f7fa","stroke-width":"3"},A(e.type),9,ee)]))),128)),(d(!0),p(G,null,I(g.value.nodes,e=>(d(),p("g",{key:e.id,transform:`translate(${$(e.id).x}, ${$(e.id).y})`,class:ft(["graph-node",{"node-selected":f.value===e.id},{"node-target":!!f.value&&f.value!==e.id}]),style:{cursor:"grab"},onMousedown:q(Y=>pt(Y,e.id),["stop"]),onClick:q(()=>_t(e.id),["stop"])},[f.value===e.id?(d(),p("circle",ne)):f.value?(d(),p("circle",se)):O("",!0),t[19]||(t[19]=n("circle",{r:"30",fill:"rgba(0,0,0,0.07)",transform:"translate(2,3)"},null,-1)),n("circle",{r:"28",fill:kt(e.id),stroke:"#fff","stroke-width":"2.5"},null,8,le),n("text",ae,A(wt(e.id)),1),n("circle",{cx:"20",cy:"-20",r:"6",fill:e.status==="running"?"#67C23A":"#c0c4cc",stroke:"#fff","stroke-width":"1.5"},null,8,re),n("text",ie,A(e.name),1),n("text",ue,A(e.id),1)],42,oe))),128))],40,Kt)),g.value.edges.length?O("",!0):(d(),p("div",de," 点击任意成员选中，再点击另一个成员即可创建关系连线 "))]))]),_:1})),[[At,z.value]]),g.value.nodes.length?(d(),lt(B,{key:0,class:"legend-card"},{default:a(()=>[n("div",ce,[t[22]||(t[22]=n("span",{class:"legend-title"},"布局规则：",-1)),n("span",fe,[s(r,null,{default:a(()=>[s(T)]),_:1}),t[20]||(t[20]=c(" 上方 = 上级",-1))]),t[23]||(t[23]=n("span",{class:"legend-item"},"— 同层 = 平级",-1)),n("span",me,[s(r,null,{default:a(()=>[s(D)]),_:1}),t[21]||(t[21]=c(" 下方 = 下级",-1))]),t[24]||(t[24]=n("span",{class:"legend-divider"},"|",-1)),t[25]||(t[25]=n("span",{class:"legend-title"},"线粗：",-1)),(d(),p(G,null,I(k,(e,Y)=>n("span",{key:Y,class:"legend-item"},[(d(),p("svg",pe,[n("line",{x1:"0",y1:"4",x2:"28",y2:"4",stroke:"#64748b","stroke-width":e,"stroke-linecap":"round"},null,8,ve)])),c(" "+A(Y),1)])),64)),t[26]||(t[26]=n("span",{class:"legend-divider"},"|",-1)),t[27]||(t[27]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#67C23A"})]),c(" 运行中 ")],-1)),t[28]||(t[28]=n("span",{class:"legend-item"},[n("svg",{width:"12",height:"12"},[n("circle",{cx:"6",cy:"6",r:"5",fill:"#c0c4cc"})]),c(" 空闲 ")],-1))])]),_:1})):O("",!0),s(st,{modelValue:P.value,"onUpdate:modelValue":t[5]||(t[5]=e=>P.value=e),title:"建立关系",width:"460px","close-on-click-modal":!1},{footer:a(()=>[s(i,{onClick:t[4]||(t[4]=e=>P.value=!1)},{default:a(()=>[...t[29]||(t[29]=[c("取消",-1)])]),_:1}),s(i,{type:"primary",loading:N.value,onClick:$t},{default:a(()=>[...t[30]||(t[30]=[c("建立",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(it,{"from-name":V(m.from),"to-name":V(m.to),type:m.type,"onUpdate:type":t[1]||(t[1]=e=>m.type=e),strength:m.strength,"onUpdate:strength":t[2]||(t[2]=e=>m.strength=e),desc:m.desc,"onUpdate:desc":t[3]||(t[3]=e=>m.desc=e)},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"]),s(st,{modelValue:L.value,"onUpdate:modelValue":t[10]||(t[10]=e=>L.value=e),title:"编辑关系",width:"460px","close-on-click-modal":!1},{footer:a(()=>[s(i,{type:"danger",plain:"",loading:N.value,onClick:Mt},{default:a(()=>[...t[31]||(t[31]=[c("删除关系",-1)])]),_:1},8,["loading"]),s(i,{onClick:t[9]||(t[9]=e=>L.value=!1)},{default:a(()=>[...t[32]||(t[32]=[c("取消",-1)])]),_:1}),s(i,{type:"primary",loading:N.value,onClick:Nt},{default:a(()=>[...t[33]||(t[33]=[c("保存",-1)])]),_:1},8,["loading"])]),default:a(()=>[s(it,{"from-name":V(u.from),"to-name":V(u.to),type:u.type,"onUpdate:type":t[6]||(t[6]=e=>u.type=e),strength:u.strength,"onUpdate:strength":t[7]||(t[7]=e=>u.strength=e),desc:u.desc,"onUpdate:desc":t[8]||(t[8]=e=>u.desc=e)},null,8,["from-name","to-name","type","strength","desc"])]),_:1},8,["modelValue"])])}}}),ke=mt(ge,[["__scopeId","data-v-d0be8a4c"]]);export{ke as default};
