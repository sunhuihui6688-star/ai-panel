import{d as oe,g as f,h as ie,c as l,n as re,s as ce,f as n,t as d,l as c,F as k,j as M,e as N,p as ue,b as J,I as K,J as de,m as pe,K as L,o as a}from"./index-DHBEgYOu.js";import{g as he}from"./index-BF1X9mkB.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ge={key:0,class:"chat-empty"},fe={key:0,class:"welcome-msg"},me={key:1,class:"examples"},ye=["onClick"],_e={key:0,class:"msg-row user"},ke={class:"msg-bubble user"},be={key:0,class:"msg-images"},xe=["src","onClick"],we={class:"msg-text"},Ce={key:1,class:"msg-row assistant"},$e={class:"msg-col"},Me=["open"],Se={class:"thinking-summary"},Te={class:"thinking-len"},Ie={class:"thinking-content"},De={class:"msg-bubble assistant"},Ae={class:"tool-details"},Ne={class:"tool-summary"},Je={class:"tool-name"},Le={key:0,class:"tool-status running"},Ee={key:1,class:"tool-status done"},Oe={key:2,class:"tool-status error"},je={class:"tool-body"},Be={key:0,class:"tool-section"},Re={class:"tool-pre"},Fe={key:1,class:"tool-section"},He={class:"tool-pre result"},Ke=["innerHTML"],Pe={key:0,class:"apply-card"},Ve={class:"apply-preview"},Ue={class:"apply-key"},ze={class:"apply-val"},We=["onClick"],Ge={class:"msg-actions"},Ye=["onClick","title"],qe=["onClick"],Qe={key:2,class:"msg-row system"},Xe={class:"msg-system"},Ze={key:1,class:"msg-row assistant"},et={class:"msg-col"},tt={key:0,class:"thinking-block",open:""},st={class:"thinking-content"},nt={class:"msg-bubble assistant"},lt={key:0,class:"typing-dots"},at=["innerHTML"],ot={key:2,class:"blink"},it=["src"],rt={class:"chat-input-area"},ct={key:0,class:"attachments-bar"},ut=["src"],dt=["onClick"],pt={class:"input-row"},ht={class:"textarea-wrap"},vt=["placeholder","disabled","onKeydown"],gt={class:"input-actions"},ft={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},mt=["disabled"],yt={key:0,class:"spinner"},_t={key:1},kt=oe({__name:"AiChat",props:{agentId:{},context:{},scenario:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply"],setup(v,{expose:P,emit:V}){const g=v,j=V,u=f(g.initialMessages?[...g.initialMessages]:[]),C=f(""),b=f([]),x=f(!1),m=f(""),$=f(""),S=f(null),T=f(""),I=f(),y=f(),U=pe(()=>({height:g.height??"100%","--bg":g.bgColor??"transparent"}));function _(){L(()=>{I.value&&(I.value.scrollTop=I.value.scrollHeight)})}function z(){y.value&&(y.value.style.height="auto",y.value.style.height=Math.min(y.value.scrollHeight,160)+"px")}function B(s){C.value=s,L(()=>y.value?.focus())}function W(s){try{return JSON.stringify(JSON.parse(s),null,2)}catch{return s}}function G(s){navigator.clipboard?.writeText(s);const e=u.value.findIndex(t=>t.text===s);S.value=e,setTimeout(()=>{S.value=null},1500)}function Y(s){for(let e=s-1;e>=0;e--){const t=u.value[e];if(t&&t.role==="user"){const i=t.text,o=t.images??[];u.value.splice(e,u.value.length-e),H(i,o);return}}}function q(s){T.value=s}function R(s){return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(t,i,o)=>`<pre class="code-block${i?" lang-"+i:""}"><code>${o}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function E(s){return s.role!=="assistant"?null:s.applyData?s.applyData:!g.applyable||!s.text?null:Q(s.text)}function Q(s){const e=s.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(e?.[1]){const i=D(e[1]);if(i)return i;const o=F(e[1]),r=D(o);if(r)return r}const t=[...s.matchAll(/(\{[^{}]{20,}\})/g)];for(let i=t.length-1;i>=0;i--){const o=t[i]?.[1];if(!o)continue;const r=D(o)??D(F(o));if(r)return r}return null}function D(s){try{const e=JSON.parse(s);if(e&&typeof e=="object"&&!Array.isArray(e)){const t=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(i=>t.includes(i)))return e}}catch{}return null}function F(s){let e="",t=!1,i=!1;for(let o=0;o<s.length;o++){const r=s[o];if(i){e+=r,i=!1;continue}if(r==="\\"&&t){e+=r,i=!0;continue}if(r==='"'){t=!t,e+=r;continue}if(t&&r===`
`){e+="\\n";continue}if(t&&r==="\r"){e+="\\r";continue}e+=r}return e}function X(s){const e=s.clipboardData?.items;if(e){for(const t of Array.from(e))if(t.type.startsWith("image/")){s.preventDefault();const i=t.getAsFile();i&&O(i)}}}function Z(s){const e=s.dataTransfer?.files;if(e)for(const t of Array.from(e))t.type.startsWith("image/")&&O(t)}function ee(s){const e=s.target.files;if(e)for(const t of Array.from(e))O(t)}function O(s){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&b.value.push(e.result)},e.readAsDataURL(s)}function te(s){b.value.splice(s,1)}function A(){const s=C.value.trim(),e=[...b.value];!s&&!e.length||x.value||(C.value="",b.value=[],L(()=>{y.value&&(y.value.style.height="auto")}),j("message",s,e),H(s,e))}function H(s,e){u.value.push({role:"user",text:s,images:e.length?e:void 0}),_(),x.value=!0,m.value="",$.value="";const t={role:"assistant",text:"",toolCalls:[]};u.value.push(t);const i=u.value.length-1;let o="";const r={context:g.context,scenario:g.scenario,images:e.length?e:void 0};he(g.agentId,s,h=>{switch(h.type){case"thinking_delta":$.value+=h.text,_();break;case"text":case"text_delta":m.value+=h.text,_();break;case"tool_call":{const p={id:h.tool_call?.id??String(Date.now()),name:h.tool_call?.name??"tool",input:h.tool_call?.input?JSON.stringify(h.tool_call.input):void 0,status:"running"};u.value[i].toolCalls.push(p),o=p.id,_();break}case"tool_result":{const p=u.value[i].toolCalls?.find(w=>w.id===o);p&&(p.result=h.text,p.status="done"),_();break}case"done":case"error":{const p=u.value[i];if(p.text=m.value,p.thinking=$.value||void 0,g.applyable){const w=m.value.match(/```json\s*([\s\S]+?)\s*```/);if(w)try{p.applyData=JSON.parse(w[1]),p.text=m.value.replace(/```json[\s\S]+?```/,"").trim()}catch{}}if(h.type==="error"){p.text=`âŒ ${h.error}`;const w=p.toolCalls?.find(ae=>ae.status==="running");w&&(w.status="error")}x.value=!1,m.value="",$.value="",j("response",p.text),_();break}}},r)}function se(){u.value=[]}function ne(s){u.value.push(s),_()}function le(s){B(s),L(A)}return P({clearMessages:se,appendMessage:ne,sendText:le,messages:u}),ie(()=>{_()}),(s,e)=>(a(),l("div",{class:ce(["ai-chat",{compact:v.compact,"has-bg":v.bgColor}]),style:re(U.value)},[n("div",{class:"chat-messages",ref_key:"msgListRef",ref:I},[u.value.length?c("",!0):(a(),l("div",ge,[v.welcomeMessage?(a(),l("div",fe,d(v.welcomeMessage),1)):c("",!0),v.examples.length?(a(),l("div",me,[(a(!0),l(k,null,M(v.examples,(t,i)=>(a(),l("div",{key:i,class:"example-chip",onClick:o=>B(t)},d(t),9,ye))),128))])):c("",!0)])),(a(!0),l(k,null,M(u.value,(t,i)=>(a(),l(k,{key:i},[t.role==="user"?(a(),l("div",_e,[n("div",ke,[t.images?.length?(a(),l("div",be,[(a(!0),l(k,null,M(t.images,(o,r)=>(a(),l("img",{key:r,src:o,class:"msg-img",onClick:h=>q(o)},null,8,xe))),128))])):c("",!0),n("div",we,d(t.text),1)])])):t.role==="assistant"?(a(),l("div",Ce,[n("div",$e,[t.thinking?(a(),l("details",{key:0,class:"thinking-block",open:v.showThinking},[n("summary",Se,[e[3]||(e[3]=n("span",{class:"thinking-icon"},"ğŸ’­",-1)),e[4]||(e[4]=N(" æ€è€ƒè¿‡ç¨‹ ",-1)),n("span",Te,d(t.thinking.length)+" å­—ç¬¦",1)]),n("pre",Ie,d(t.thinking),1)],8,Me)):c("",!0),n("div",De,[(a(!0),l(k,null,M(t.toolCalls,(o,r)=>(a(),l("div",{key:r,class:"tool-call-block"},[n("details",Ae,[n("summary",Ne,[e[5]||(e[5]=n("span",{class:"tool-icon"},"ğŸ”§",-1)),n("span",Je,d(o.name),1),o.status==="running"?(a(),l("span",Le,"è¿è¡Œä¸­â€¦")):o.status==="done"?(a(),l("span",Ee,"å®Œæˆ")):o.status==="error"?(a(),l("span",Oe,"å¤±è´¥")):c("",!0)]),n("div",je,[o.input?(a(),l("div",Be,[e[6]||(e[6]=n("div",{class:"tool-label"},"è¾“å…¥",-1)),n("pre",Re,d(W(o.input)),1)])):c("",!0),o.result?(a(),l("div",Fe,[e[7]||(e[7]=n("div",{class:"tool-label"},"è¾“å‡º",-1)),n("pre",He,d(o.result.slice(0,800))+d(o.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):c("",!0)])])]))),128)),t.text?(a(),l("div",{key:0,class:"msg-text",innerHTML:R(t.text)},null,8,Ke)):c("",!0),g.applyable?(a(),l(k,{key:1},[E(t)?(a(),l("div",Pe,[n("div",Ve,[(a(!0),l(k,null,M(E(t),(o,r)=>(a(),l("div",{key:r,class:"apply-row"},[n("span",Ue,d(r),1),n("span",ze,d(String(o).slice(0,60))+d(String(o).length>60?"â€¦":""),1)]))),128))]),n("button",{class:"apply-btn",onClick:o=>s.$emit("apply",E(t))}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,We)])):c("",!0)],64)):c("",!0),n("div",Ge,[n("button",{class:"act-btn",onClick:o=>G(t.text),title:S.value===i?"å·²å¤åˆ¶":"å¤åˆ¶"},d(S.value===i?"âœ“":"â˜"),9,Ye),n("button",{class:"act-btn",onClick:o=>Y(i),title:"é‡è¯•"},"â†º",8,qe)])])])])):t.role==="system"?(a(),l("div",Qe,[n("div",Xe,d(t.text),1)])):c("",!0)],64))),128)),x.value?(a(),l("div",Ze,[n("div",et,[$.value&&v.showThinking?(a(),l("details",tt,[e[9]||(e[9]=n("summary",{class:"thinking-summary"},[n("span",{class:"thinking-icon"},"ğŸ’­"),N(" æ€è€ƒä¸­â€¦ ")],-1)),n("pre",st,[N(d($.value),1),e[8]||(e[8]=n("span",{class:"blink"},"â–Š",-1))])])):c("",!0),n("div",nt,[m.value?(a(),l("div",{key:1,class:"msg-text",innerHTML:R(m.value)},null,8,at)):(a(),l("div",lt,[...e[10]||(e[10]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])),m.value?(a(),l("span",ot,"â–Š")):c("",!0)])])])):c("",!0)],512),T.value?(a(),l("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=t=>T.value="")},[n("img",{src:T.value,class:"img-preview-full"},null,8,it)])):c("",!0),n("div",rt,[b.value.length?(a(),l("div",ct,[(a(!0),l(k,null,M(b.value,(t,i)=>(a(),l("div",{key:i,class:"attach-thumb"},[n("img",{src:t},null,8,ut),n("button",{class:"remove-attach",onClick:o=>te(i)},"Ã—",8,dt)]))),128))])):c("",!0),n("div",pt,[n("div",ht,[ue(n("textarea",{ref_key:"inputRef",ref:y,"onUpdate:modelValue":e[1]||(e[1]=t=>C.value=t),placeholder:v.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:x.value,rows:"1",class:"chat-textarea",onKeydown:[K(J(A,["ctrl","prevent"]),["enter"]),K(J(A,["meta","prevent"]),["enter"])],onPaste:X,onInput:z,onDragover:e[2]||(e[2]=J(()=>{},["prevent"])),onDrop:J(Z,["prevent"])},null,40,vt),[[de,C.value]])]),n("div",gt,[n("label",ft,[e[11]||(e[11]=N(" ğŸ“ ",-1)),n("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:ee},null,32)]),n("button",{class:"send-btn",disabled:x.value||!C.value.trim()&&!b.value.length,onClick:A},[x.value?(a(),l("span",yt)):(a(),l("span",_t,"â†‘"))],8,mt)])]),e[12]||(e[12]=n("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6))}}),Ct=ve(kt,[["__scopeId","data-v-d7bf637b"]]);export{Ct as A};
