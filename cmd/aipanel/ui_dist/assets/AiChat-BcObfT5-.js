import{d as ie,g as f,h as ce,c as a,n as re,s as ue,f as n,t as d,l as r,F as C,j as S,e as J,p as de,b as L,I as K,J as pe,m as he,K as T,o}from"./index-BvuqVUT4.js";import{g as ge}from"./index-BF1X9mkB.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const fe={key:0,class:"chat-empty"},me={key:0,class:"welcome-msg"},ye={key:1,class:"examples"},_e=["onClick"],ke={key:0,class:"msg-row user"},be={class:"msg-bubble user"},xe={key:0,class:"msg-images"},Ce=["src","onClick"],we={class:"msg-text"},$e={key:1,class:"msg-row assistant"},Se={class:"msg-col"},Te=["open"],Me={class:"thinking-summary"},De={class:"thinking-len"},Ie={class:"thinking-content"},Ae={class:"msg-bubble assistant"},Ne={class:"tool-details"},Je={class:"tool-summary"},Le={class:"tool-name"},Oe={key:0,class:"tool-status running"},Ee={key:1,class:"tool-status done"},Be={key:2,class:"tool-status error"},Re={class:"tool-body"},Fe={key:0,class:"tool-section"},He={class:"tool-pre"},je={key:1,class:"tool-section"},Ke={class:"tool-pre result"},Pe=["innerHTML"],Ue={key:1,class:"apply-card"},Ve={class:"apply-preview"},ze={class:"apply-key"},We={class:"apply-val"},Ye=["onClick"],Ge={class:"msg-actions"},qe=["onClick","title"],Qe=["onClick"],Xe=["onClick"],Ze={key:2,class:"msg-row system"},et={class:"msg-system"},tt={key:1,class:"msg-row assistant"},st={class:"msg-col"},nt={key:0,class:"thinking-block",open:""},lt={class:"thinking-content"},at={class:"msg-bubble assistant"},ot={key:0,class:"typing-dots"},it=["innerHTML"],ct={key:2,class:"blink"},rt=["src"],ut={class:"chat-input-area"},dt={key:0,class:"attachments-bar"},pt=["src"],ht=["onClick"],gt={class:"input-row"},vt={class:"textarea-wrap"},ft=["placeholder","disabled","onKeydown"],mt={class:"input-actions"},yt={class:"icon-btn",title:"ä¸Šä¼ å›¾ç‰‡"},_t=["disabled"],kt={key:0,class:"spinner"},bt={key:1},xt=ie({__name:"AiChat",props:{agentId:{},context:{},scenario:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply"],setup(g,{expose:P,emit:U}){const v=g,O=U,u=f(v.initialMessages?[...v.initialMessages]:[]),w=f(""),b=f([]),x=f(!1),m=f(""),$=f(""),M=f(null),D=f(""),I=f(),y=f(),V=he(()=>({height:v.height??"100%","--bg":v.bgColor??"transparent"}));function _(){T(()=>{I.value&&(I.value.scrollTop=I.value.scrollHeight)})}function z(){y.value&&(y.value.style.height="auto",y.value.style.height=Math.min(y.value.scrollHeight,160)+"px")}function B(t){w.value=t,T(()=>y.value?.focus())}function W(t){try{return JSON.stringify(JSON.parse(t),null,2)}catch{return t}}function Y(t){navigator.clipboard?.writeText(t);const e=u.value.findIndex(s=>s.text===t);M.value=e,setTimeout(()=>{M.value=null},1500)}function G(t){for(let e=t-1;e>=0;e--){const s=u.value[e];if(s&&s.role==="user"){const i=s.text,l=s.images??[];u.value.splice(e,u.value.length-e),j(i,l);return}}}function q(t){D.value=t}function R(t){return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(s,i,l)=>`<pre class="code-block${i?" lang-"+i:""}"><code>${l}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function Q(t){return t?/\{[\s\S]{30,}\}/.test(t)&&(t.includes('"name"')||t.includes('"identity"')||t.includes('"soul"')||t.includes('"IDENTITY"')||t.includes('"SOUL"')):!1}function X(t){const e=F(t.text);console.log("[AiChat] manualApply result:",e),e?(t.applyData=e,T(()=>O("apply",e))):alert("æœªèƒ½ä»æ¶ˆæ¯ä¸­æå–åˆ°é…ç½® JSONï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶")}function F(t){const e=t.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(e?.[1]){const i=A(e[1]);if(i)return i;const l=H(e[1]),c=A(l);if(c)return c}const s=[...t.matchAll(/(\{[^{}]{20,}\})/g)];for(let i=s.length-1;i>=0;i--){const l=s[i]?.[1];if(!l)continue;const c=A(l)??A(H(l));if(c)return c}return null}function A(t){try{const e=JSON.parse(t);if(e&&typeof e=="object"&&!Array.isArray(e)){const s=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(i=>s.includes(i)))return e}}catch{}return null}function H(t){let e="",s=!1,i=!1;for(let l=0;l<t.length;l++){const c=t[l];if(i){e+=c,i=!1;continue}if(c==="\\"&&s){e+=c,i=!0;continue}if(c==='"'){s=!s,e+=c;continue}if(s&&c===`
`){e+="\\n";continue}if(s&&c==="\r"){e+="\\r";continue}e+=c}return e}function Z(t){const e=t.clipboardData?.items;if(e){for(const s of Array.from(e))if(s.type.startsWith("image/")){t.preventDefault();const i=s.getAsFile();i&&E(i)}}}function ee(t){const e=t.dataTransfer?.files;if(e)for(const s of Array.from(e))s.type.startsWith("image/")&&E(s)}function te(t){const e=t.target.files;if(e)for(const s of Array.from(e))E(s)}function E(t){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&b.value.push(e.result)},e.readAsDataURL(t)}function se(t){b.value.splice(t,1)}function N(){const t=w.value.trim(),e=[...b.value];!t&&!e.length||x.value||(w.value="",b.value=[],T(()=>{y.value&&(y.value.style.height="auto")}),O("message",t,e),j(t,e))}function j(t,e){u.value.push({role:"user",text:t,images:e.length?e:void 0}),_(),x.value=!0,m.value="",$.value="";const s={role:"assistant",text:"",toolCalls:[]};u.value.push(s);const i=u.value.length-1;let l="";const c={context:v.context,scenario:v.scenario,images:e.length?e:void 0};ge(v.agentId,t,h=>{switch(h.type){case"thinking_delta":$.value+=h.text,_();break;case"text":case"text_delta":m.value+=h.text,_();break;case"tool_call":{const p={id:h.tool_call?.id??String(Date.now()),name:h.tool_call?.name??"tool",input:h.tool_call?.input?JSON.stringify(h.tool_call.input):void 0,status:"running"};u.value[i].toolCalls.push(p),l=p.id,_();break}case"tool_result":{const p=u.value[i].toolCalls?.find(k=>k.id===l);p&&(p.result=h.text,p.status="done"),_();break}case"done":case"error":{const p=u.value[i];if(p.text=m.value,p.thinking=$.value||void 0,v.applyable){const k=F(m.value);k?(p.applyData=k,console.log("[AiChat] applyData extracted:",k)):console.log("[AiChat] no applyData found in text length:",m.value.length)}if(h.type==="error"){p.text=`âŒ ${h.error}`;const k=p.toolCalls?.find(oe=>oe.status==="running");k&&(k.status="error")}x.value=!1,m.value="",$.value="",O("response",p.text),_();break}}},c)}function ne(){u.value=[]}function le(t){u.value.push(t),_()}function ae(t){B(t),T(N)}return P({clearMessages:ne,appendMessage:le,sendText:ae,messages:u}),ce(()=>{_()}),(t,e)=>(o(),a("div",{class:ue(["ai-chat",{compact:g.compact,"has-bg":g.bgColor}]),style:re(V.value)},[n("div",{class:"chat-messages",ref_key:"msgListRef",ref:I},[u.value.length?r("",!0):(o(),a("div",fe,[g.welcomeMessage?(o(),a("div",me,d(g.welcomeMessage),1)):r("",!0),g.examples.length?(o(),a("div",ye,[(o(!0),a(C,null,S(g.examples,(s,i)=>(o(),a("div",{key:i,class:"example-chip",onClick:l=>B(s)},d(s),9,_e))),128))])):r("",!0)])),(o(!0),a(C,null,S(u.value,(s,i)=>(o(),a(C,{key:i},[s.role==="user"?(o(),a("div",ke,[n("div",be,[s.images?.length?(o(),a("div",xe,[(o(!0),a(C,null,S(s.images,(l,c)=>(o(),a("img",{key:c,src:l,class:"msg-img",onClick:h=>q(l)},null,8,Ce))),128))])):r("",!0),n("div",we,d(s.text),1)])])):s.role==="assistant"?(o(),a("div",$e,[n("div",Se,[s.thinking?(o(),a("details",{key:0,class:"thinking-block",open:g.showThinking},[n("summary",Me,[e[3]||(e[3]=n("span",{class:"thinking-icon"},"ğŸ’­",-1)),e[4]||(e[4]=J(" æ€è€ƒè¿‡ç¨‹ ",-1)),n("span",De,d(s.thinking.length)+" å­—ç¬¦",1)]),n("pre",Ie,d(s.thinking),1)],8,Te)):r("",!0),n("div",Ae,[(o(!0),a(C,null,S(s.toolCalls,(l,c)=>(o(),a("div",{key:c,class:"tool-call-block"},[n("details",Ne,[n("summary",Je,[e[5]||(e[5]=n("span",{class:"tool-icon"},"ğŸ”§",-1)),n("span",Le,d(l.name),1),l.status==="running"?(o(),a("span",Oe,"è¿è¡Œä¸­â€¦")):l.status==="done"?(o(),a("span",Ee,"å®Œæˆ")):l.status==="error"?(o(),a("span",Be,"å¤±è´¥")):r("",!0)]),n("div",Re,[l.input?(o(),a("div",Fe,[e[6]||(e[6]=n("div",{class:"tool-label"},"è¾“å…¥",-1)),n("pre",He,d(W(l.input)),1)])):r("",!0),l.result?(o(),a("div",je,[e[7]||(e[7]=n("div",{class:"tool-label"},"è¾“å‡º",-1)),n("pre",Ke,d(l.result.slice(0,800))+d(l.result.length>800?`
â€¦(æˆªæ–­)`:""),1)])):r("",!0)])])]))),128)),s.text?(o(),a("div",{key:0,class:"msg-text",innerHTML:R(s.text)},null,8,Pe)):r("",!0),s.applyData&&v.applyable?(o(),a("div",Ue,[n("div",Ve,[(o(!0),a(C,null,S(s.applyData,(l,c)=>(o(),a("div",{key:c,class:"apply-row"},[n("span",ze,d(c),1),n("span",We,d(String(l).slice(0,60))+d(String(l).length>60?"â€¦":""),1)]))),128))]),n("button",{class:"apply-btn",onClick:l=>t.$emit("apply",s.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,Ye)])):r("",!0),n("div",Ge,[n("button",{class:"act-btn",onClick:l=>Y(s.text),title:M.value===i?"å·²å¤åˆ¶":"å¤åˆ¶"},d(M.value===i?"âœ“":"â˜"),9,qe),n("button",{class:"act-btn",onClick:l=>G(i),title:"é‡è¯•"},"â†º",8,Qe),v.applyable&&!s.applyData&&Q(s.text)?(o(),a("button",{key:0,class:"act-btn apply-manual-btn",onClick:l=>X(s),title:"æ£€æµ‹åˆ°é…ç½® JSONï¼Œç‚¹å‡»åº”ç”¨"}," âš™ åº”ç”¨é…ç½® ",8,Xe)):r("",!0)])])])])):s.role==="system"?(o(),a("div",Ze,[n("div",et,d(s.text),1)])):r("",!0)],64))),128)),x.value?(o(),a("div",tt,[n("div",st,[$.value&&g.showThinking?(o(),a("details",nt,[e[9]||(e[9]=n("summary",{class:"thinking-summary"},[n("span",{class:"thinking-icon"},"ğŸ’­"),J(" æ€è€ƒä¸­â€¦ ")],-1)),n("pre",lt,[J(d($.value),1),e[8]||(e[8]=n("span",{class:"blink"},"â–Š",-1))])])):r("",!0),n("div",at,[m.value?(o(),a("div",{key:1,class:"msg-text",innerHTML:R(m.value)},null,8,it)):(o(),a("div",ot,[...e[10]||(e[10]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])),m.value?(o(),a("span",ct,"â–Š")):r("",!0)])])])):r("",!0)],512),D.value?(o(),a("div",{key:0,class:"img-preview-mask",onClick:e[0]||(e[0]=s=>D.value="")},[n("img",{src:D.value,class:"img-preview-full"},null,8,rt)])):r("",!0),n("div",ut,[b.value.length?(o(),a("div",dt,[(o(!0),a(C,null,S(b.value,(s,i)=>(o(),a("div",{key:i,class:"attach-thumb"},[n("img",{src:s},null,8,pt),n("button",{class:"remove-attach",onClick:l=>se(i)},"Ã—",8,ht)]))),128))])):r("",!0),n("div",gt,[n("div",vt,[de(n("textarea",{ref_key:"inputRef",ref:y,"onUpdate:modelValue":e[1]||(e[1]=s=>w.value=s),placeholder:g.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter å‘é€)",disabled:x.value,rows:"1",class:"chat-textarea",onKeydown:[K(L(N,["ctrl","prevent"]),["enter"]),K(L(N,["meta","prevent"]),["enter"])],onPaste:Z,onInput:z,onDragover:e[2]||(e[2]=L(()=>{},["prevent"])),onDrop:L(ee,["prevent"])},null,40,ft),[[pe,w.value]])]),n("div",mt,[n("label",yt,[e[11]||(e[11]=J(" ğŸ“ ",-1)),n("input",{type:"file",accept:"image/*",multiple:"",hidden:"",onChange:te},null,32)]),n("button",{class:"send-btn",disabled:x.value||!w.value.trim()&&!b.value.length,onClick:N},[x.value?(o(),a("span",kt)):(o(),a("span",bt,"â†‘"))],8,_t)])]),e[12]||(e[12]=n("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒç²˜è´´å›¾ç‰‡",-1))])],6))}}),St=ve(xt,[["__scopeId","data-v-2709d756"]]);export{St as A};
