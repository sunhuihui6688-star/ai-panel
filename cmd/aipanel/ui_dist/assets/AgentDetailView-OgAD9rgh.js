import{d as mt,D as Sl,i as yt,o,c as m,b as s,a as e,w as t,k as h,F as N,m as Y,s as dl,t as f,j as x,h as i,f as gt,n as We,p as Oe,G as ut,v as na,l as S,e as r,z as Ll,E as y,H as dt,r as g,I as sa,A as oa,B as sl,J as ia,K as $l,L as rt,M as ft,g as ua,N as da,x as vt,O as ra}from"./index-BK19_pMu.js";import{h as ol,f as q,b as zl,m as fa,i as il,j as ul,k as va,g as Tl,r as pt,e as X,l as ct}from"./index-CSBCvw1g.js";import{A as _t}from"./AiChat-BZFSec0u.js";import{_ as wt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const pa={class:"skill-studio"},ca={class:"studio-sidebar"},ma={class:"sidebar-top"},ya={class:"sidebar-acts"},ga={class:"skill-list"},_a={key:0,class:"list-empty"},wa=["onClick"],ba={class:"sk-icon"},ka={key:0},xa={class:"sk-info"},ha={class:"sk-name"},Ca={class:"sk-id"},Va={class:"sk-right"},$a={key:0,class:"sk-streaming-dot",title:"AI 生成中…"},za={class:"studio-editor"},Ta={key:0,class:"editor-empty"},Sa={class:"editor-toolbar"},La={class:"editor-breadcrumb"},Ia={class:"crumb-name"},Ua={class:"toolbar-acts"},Da={class:"editor-body"},Fa={class:"file-tree"},Aa={class:"tree-title"},Na={class:"tree-item tree-dir"},Ma=["onClick"],Ba={key:0,class:"tree-empty"},Pa={key:0,class:"file-editor"},ja={class:"file-editor-head"},Ea={style:{display:"flex","align-items":"center",gap:"10px"}},Ra={style:{"font-size":"12px",color:"#909399"}},Ka={class:"json-preview"},Wa={key:1,class:"file-editor"},Oa={class:"file-editor-head"},Ya={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},Ja={style:{"font-size":"11px",color:"#c0c4cc"}},qa={key:2,class:"file-editor"},Ha={class:"file-editor-head"},Ga={style:{"margin-left":"auto",display:"flex","align-items":"center",gap:"8px"}},Qa={style:{"font-size":"11px",color:"#c0c4cc"}},Xa=["placeholder"],Za={class:"studio-chat"},en={class:"chat-panel-head"},ln={key:0,style:{"margin-left":"auto","font-size":"11px",color:"#c0c4cc"}},tn={key:0,style:{"margin-left":"6px",color:"#e6a23c"}},an={class:"chat-wrap"},nn=mt({__name:"SkillStudio",props:{agentId:{}},setup(ql){const se=ql,_=se.agentId,U=r([]),oe=r(!1),v=r(null),C=r("meta"),$=r({name:"",icon:"",category:"",description:"",version:"1.0.0",enabled:!0}),B=r(""),Te=r(!1),be=r(!1),Ye=r(!1),Se=r(!1),ce=r(!1),Z=r([]),ee=r(!1),H=r(""),ie=r(!1),G=r(!1),Je={};function rl(c,d){d?Je[c]=d:delete Je[c]}function Le(c){return c?Je[c]:null}const ke=r(new Set);function Ie(c,d){const D=new Set(ke.value);d?D.add(c):D.delete(c),ke.value=D}const ue=r(new Set);Sl(v,async c=>{c&&(ue.value.has(c.id)||(ue.value.add(c.id),await dt(),await Le(c.id)?.resumeSession?.(`skill-studio-${c.id}`)))},{flush:"post"});const qe=Ll(()=>{if(!v.value)return"你是一个技能配置助手，帮助用户设计和优化 AI 技能的系统提示词。";const c=JSON.stringify({id:v.value.id,name:v.value.name,icon:v.value.icon||"",category:v.value.category||"",description:v.value.description||"",version:v.value.version||"1.0.0",enabled:v.value.enabled,source:"local",installedAt:""},null,2);return`你是一个技能配置助手，正在帮助用户配置技能（ID: ${v.value.id}）。

## ⚠️ 文件路径规则（必须遵守）
所有文件必须在 skills/${v.value.id}/ 目录下：
- ✅ skills/${v.value.id}/SKILL.md
- ✅ skills/${v.value.id}/skill.json
- ✅ skills/${v.value.id}/tools/helper.py
- ❌ 任何其他路径

## ⚠️ 创建或更新技能时，必须同时写两个文件

### 1. skills/${v.value.id}/skill.json（技能元数据）
格式如下，修改 name/icon/category/description 字段：
\`\`\`json
${c}
\`\`\`

### 2. skills/${v.value.id}/SKILL.md（系统提示词）
当前内容：
\`\`\`markdown
${B.value||"（空）"}
\`\`\`

## 你可以帮助：
- 创建/优化技能：同时写 skill.json（名称、分类、描述）和 SKILL.md（提示词）
- 在技能目录下创建工具文件（Python 等）
- 测试技能效果（直接对话即可测试）`}),de=Ll(()=>v.value?ce.value?`新技能已创建（ID: ${v.value.id}）。告诉我你想要什么功能，我来帮你生成完整的 SKILL.md 内容，生成后直接点保存即可。`:`当前编辑「${v.value.name}」。你可以让我优化 SKILL.md、测试效果，或者直接对话体验当前技能。`:"选择一个技能后，我可以帮你优化配置、写 SKILL.md、测试效果。"),He=Ll(()=>v.value?ce.value?[]:[`帮我优化「${v.value.name}」的 SKILL.md`,"这个技能怎么写效果更好？","用中文回答一道历史题，测试当前技能效果"]:["帮我设计一个代码审查技能","帮我写一个翻译助手的 SKILL.md"]);async function L(){oe.value=!0;try{const c=await ol.list(_);if(U.value=c.data||[],v.value){const d=U.value.find(D=>D.id===v.value.id);d&&(v.value=d,Ue(d))}}catch{}finally{oe.value=!1}}function Ue(c){$.value={name:c.name,icon:c.icon||"",category:c.category||"",description:c.description||"",version:c.version||"1.0.0",enabled:c.enabled}}async function De(c){v.value?.id!==c.id&&(v.value=c,Ue(c),C.value="meta",be.value=!1,B.value="",ce.value=!1,Fe(),le())}async function fl(){v.value&&C.value!=="prompt"&&(C.value="prompt",B.value||await le())}async function Ge(c,d,D){const b=await q.read(_,c),F=Array.isArray(b.data)?b.data:[],J=[];for(const K of F){if(D===0&&K.name==="skill.json")continue;const W=d?`${d}/${K.name}`:K.name;if(J.push({name:K.name,path:W,isDir:K.isDir,depth:D}),K.isDir){const re=await Ge(`skills/${v.value.id}/${W}`,W,D+1);J.push(...re)}}return J}async function Fe(){if(v.value){ee.value=!0;try{Z.value=await Ge(`skills/${v.value.id}/`,"",0)}catch{Z.value=[{name:"SKILL.md",path:"SKILL.md",isDir:!1,depth:0}]}finally{ee.value=!1}}}async function Ae(c,d){if(!d){if(c==="SKILL.md"){await fl();return}C.value=c,ie.value=!1,await me()}}async function me(){if(!(!v.value||!C.value||C.value==="meta"||C.value==="prompt")){G.value=!0;try{const c=await q.read(_,`skills/${v.value.id}/${C.value}`);H.value=c.data?.content||"",ie.value=!1}catch{H.value=""}finally{G.value=!1}}}async function Qe(c){if(v.value)try{await q.delete(_,`skills/${v.value.id}/${c}`),C.value===c&&(C.value="prompt"),await Fe(),y.success("已删除")}catch{y.error("删除失败")}}async function Ne(){if(v.value){Ye.value=!0;try{C.value==="meta"||C.value==="prompt"?(await ol.update(se.agentId,v.value.id,{name:$.value.name,icon:$.value.icon,category:$.value.category,description:$.value.description,enabled:$.value.enabled}),(C.value==="prompt"||B.value)&&(await q.write(_,`skills/${v.value.id}/SKILL.md`,B.value),be.value=!1),await L()):(await q.write(_,`skills/${v.value.id}/${C.value}`,H.value),ie.value=!1),y.success("保存成功")}catch(c){y.error(c.response?.data?.error||"保存失败")}finally{Ye.value=!1}}}async function ye(c,d){try{await ol.update(se.agentId,c.id,{enabled:d}),await L()}catch{y.error("操作失败")}}async function ge(){if(v.value)try{await ol.remove(se.agentId,v.value.id),y.success("已删除"),v.value=null,await L()}catch{y.error("删除失败")}}async function Me(){if(Se.value)return;Se.value=!0;const c="skill_"+Date.now().toString(36);try{await ol.create(se.agentId,{meta:{id:c,name:"新技能",icon:"",category:"",description:"",version:"1.0.0",enabled:!1,source:"local",installedAt:""},promptContent:""}),await L();const d=U.value.find(D=>D.id===c);if(d){await De(d),C.value="prompt",B.value="",ce.value=!0,await dt(),ue.value.has(c)||(ue.value.add(c),await Le(c)?.resumeSession?.(`skill-studio-${c}`));const D=U.value.filter(b=>b.id!==c).map(b=>b.name).join("、")||"暂无";Le(c)?.sendSilent?.(`【纯文字输出，不使用任何工具，不创建任何文件】当前已有技能：${D}。请推荐3个全新的、与已有技能不重复的技能方向，每条一句话，直接列出即可。`)}}catch(d){y.error(d.response?.data?.error||"创建失败")}finally{Se.value=!1}}async function Xe(c,d){c===v.value?.id&&(ce.value=!1),await L(),c===v.value?.id&&(await Promise.all([Fe(),le()]),C.value!=="meta"&&C.value!=="prompt"&&await me())}async function le(){if(v.value){Te.value=!0;try{const c=await q.read(_,`skills/${v.value.id}/SKILL.md`);B.value=c.data?.content||"",be.value=!1}catch{B.value=""}finally{Te.value=!1}}}async function Be(){if(!v.value)return;B.value||await fl();const c=`请用「${v.value.name}」技能效果回复：你好，请介绍一下你的功能。`;Le(v.value?.id)?.fillInput?.(c),y.info("测试消息已填入右侧聊天框，点击发送即可测试")}return yt(L),(c,d)=>{const D=g("Refresh"),b=g("el-icon"),F=g("el-button"),J=g("Plus"),K=g("Tools"),W=g("el-tag"),re=g("el-switch"),Il=g("Setting"),Ul=g("FolderOpened"),O=g("VideoPlay"),Ze=g("DocumentChecked"),M=g("Delete"),vl=g("el-popconfirm"),pl=g("Folder"),xe=g("Document"),_e=g("el-input"),fe=g("el-form-item"),he=g("el-col"),Pe=g("el-row"),cl=g("el-collapse-item"),ml=g("el-collapse"),yl=g("el-form"),Ce=g("ChatLineRound");return o(),m("div",pa,[s("div",ca,[s("div",ma,[d[13]||(d[13]=s("span",{class:"sidebar-title"},"技能库",-1)),s("div",ya,[e(F,{size:"small",loading:oe.value,circle:"",onClick:L},{default:t(()=>[e(b,null,{default:t(()=>[e(D)]),_:1})]),_:1},8,["loading"]),e(F,{size:"small",type:"primary",circle:"",loading:Se.value,onClick:Me},{default:t(()=>[e(b,null,{default:t(()=>[e(J)]),_:1})]),_:1},8,["loading"])])]),s("div",ga,[!oe.value&&U.value.length===0?(o(),m("div",_a,"暂无技能")):h("",!0),(o(!0),m(N,null,Y(U.value,p=>(o(),m("div",{key:p.id,class:dl(["skill-item",{active:v.value?.id===p.id}]),onClick:te=>De(p)},[s("span",ba,[p.icon?(o(),m("span",ka,f(p.icon),1)):(o(),x(b,{key:1},{default:t(()=>[e(K)]),_:1}))]),s("div",xa,[s("div",ha,f(p.name),1),s("div",Ca,f(p.id),1)]),s("div",Va,[ke.value.has(p.id)?(o(),m("span",$a)):p.category?(o(),x(W,{key:1,size:"small",effect:"plain",style:{"margin-right":"6px","font-size":"11px"}},{default:t(()=>[i(f(p.category),1)]),_:2},1024)):h("",!0),e(re,{"model-value":p.enabled,size:"small",onChange:te=>ye(p,te),onClick:d[0]||(d[0]=gt(()=>{},["stop"]))},null,8,["model-value","onChange"])])],10,wa))),128))])]),s("div",za,[v.value?(o(),m(N,{key:1},[s("div",Sa,[s("div",La,[e(b,{style:{color:"#909399"}},{default:t(()=>[e(Ul)]),_:1}),d[16]||(d[16]=s("span",{class:"crumb-sep"},"skills /",-1)),s("span",Ia,f(v.value.id),1)]),s("div",Ua,[e(F,{size:"small",onClick:Be},{default:t(()=>[e(b,null,{default:t(()=>[e(O)]),_:1}),d[17]||(d[17]=i(" 测试 ",-1))]),_:1}),e(F,{size:"small",type:"primary",loading:Ye.value,onClick:Ne},{default:t(()=>[e(b,null,{default:t(()=>[e(Ze)]),_:1}),d[18]||(d[18]=i(" 保存 ",-1))]),_:1},8,["loading"]),e(vl,{title:"确认删除该技能？",onConfirm:ge},{reference:t(()=>[e(F,{size:"small",type:"danger",plain:""},{default:t(()=>[e(b,null,{default:t(()=>[e(M)]),_:1})]),_:1})]),_:1})])]),s("div",Da,[s("div",Fa,[s("div",Aa,[d[19]||(d[19]=i(" 目录 ",-1)),e(F,{link:"",size:"small",loading:ee.value,onClick:Fe,style:{"margin-left":"auto",padding:"0"}},{default:t(()=>[e(b,null,{default:t(()=>[e(D)]),_:1})]),_:1},8,["loading"])]),s("div",Na,[e(b,null,{default:t(()=>[e(pl)]),_:1}),s("span",null,f(v.value.id)+"/",1)]),s("div",{class:dl(["tree-item",{"tree-active":C.value==="meta"}]),onClick:d[1]||(d[1]=p=>C.value="meta")},[e(b,null,{default:t(()=>[e(xe)]),_:1}),d[20]||(d[20]=s("span",null,"skill.json",-1))],2),(o(!0),m(N,null,Y(Z.value,p=>(o(),m("div",{key:p.path,class:dl(["tree-item",{"tree-active":C.value===(p.path==="SKILL.md"?"prompt":p.path),"tree-dir-row":p.isDir}]),style:We({paddingLeft:`${12+p.depth*12}px`}),onClick:te=>Ae(p.path,p.isDir)},[p.isDir?(o(),x(b,{key:0,style:{color:"#e6a23c"}},{default:t(()=>[e(pl)]),_:1})):(o(),x(b,{key:1},{default:t(()=>[e(xe)]),_:1})),s("span",null,f(p.name),1),p.path==="SKILL.md"&&v.value.enabled?(o(),x(W,{key:2,size:"small",type:"success",effect:"plain",style:{"margin-left":"4px","font-size":"10px"}},{default:t(()=>[...d[21]||(d[21]=[i("注入中",-1)])]),_:1})):h("",!0)],14,Ma))),128)),!ee.value&&Z.value.length===0?(o(),m("div",Ba,"空目录")):h("",!0)]),C.value==="meta"?(o(),m("div",Pa,[s("div",ja,[e(b,null,{default:t(()=>[e(xe)]),_:1}),d[22]||(d[22]=i(" skill.json ",-1)),d[23]||(d[23]=s("span",{class:"file-hint"},"技能元信息，影响列表展示和 runner 行为",-1))]),e(yl,{model:$.value,"label-width":"72px",size:"small",style:{padding:"16px 20px"}},{default:t(()=>[e(fe,{label:"技能 ID"},{default:t(()=>[e(_e,{value:v.value.id,disabled:""},null,8,["value"])]),_:1}),e(Pe,{gutter:12},{default:t(()=>[e(he,{span:14},{default:t(()=>[e(fe,{label:"名称"},{default:t(()=>[e(_e,{modelValue:$.value.name,"onUpdate:modelValue":d[2]||(d[2]=p=>$.value.name=p),placeholder:"如 翻译助手"},null,8,["modelValue"])]),_:1})]),_:1}),e(he,{span:10},{default:t(()=>[e(fe,{label:"图标"},{default:t(()=>[e(_e,{modelValue:$.value.icon,"onUpdate:modelValue":d[3]||(d[3]=p=>$.value.icon=p),placeholder:"emoji"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(Pe,{gutter:12},{default:t(()=>[e(he,{span:14},{default:t(()=>[e(fe,{label:"分类"},{default:t(()=>[e(_e,{modelValue:$.value.category,"onUpdate:modelValue":d[4]||(d[4]=p=>$.value.category=p),placeholder:"如 语言"},null,8,["modelValue"])]),_:1})]),_:1}),e(he,{span:10},{default:t(()=>[e(fe,{label:"版本"},{default:t(()=>[e(_e,{modelValue:$.value.version,"onUpdate:modelValue":d[5]||(d[5]=p=>$.value.version=p),placeholder:"1.0.0"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(fe,{label:"描述"},{default:t(()=>[e(_e,{modelValue:$.value.description,"onUpdate:modelValue":d[6]||(d[6]=p=>$.value.description=p),type:"textarea",rows:2,placeholder:"简要描述技能功能"},null,8,["modelValue"])]),_:1}),e(fe,{label:"状态"},{default:t(()=>[s("div",Ea,[e(re,{modelValue:$.value.enabled,"onUpdate:modelValue":d[7]||(d[7]=p=>$.value.enabled=p)},null,8,["modelValue"]),s("span",Ra,f($.value.enabled?"已启用，SKILL.md 将注入系统提示":"已禁用"),1)])]),_:1}),e(ml,{style:{"margin-top":"8px"}},{default:t(()=>[e(cl,{title:"查看 skill.json 原文"},{default:t(()=>[s("pre",Ka,f(JSON.stringify({id:v.value.id,...$.value},null,2)),1)]),_:1})]),_:1})]),_:1},8,["model"])])):C.value==="prompt"?(o(),m("div",Wa,[s("div",Oa,[e(b,null,{default:t(()=>[e(xe)]),_:1}),d[25]||(d[25]=i(" SKILL.md ",-1)),d[26]||(d[26]=s("span",{class:"file-hint"},"注入到 AI System Prompt 的指令内容",-1)),s("div",Ya,[be.value?(o(),x(W,{key:0,type:"warning",size:"small"},{default:t(()=>[...d[24]||(d[24]=[i("未保存",-1)])]),_:1})):h("",!0),s("span",Ja,f(B.value.length)+" 字符",1),e(F,{size:"small",circle:"",loading:Te.value,onClick:le,title:"重新加载"},{default:t(()=>[e(b,null,{default:t(()=>[e(D)]),_:1})]),_:1},8,["loading"])])]),Oe(s("textarea",{"onUpdate:modelValue":d[8]||(d[8]=p=>B.value=p),class:"code-textarea",spellcheck:"false",placeholder:`# 技能名称

## 功能说明
描述该技能的用途…

## 行为规范
- 规范 1
- 规范 2`,onInput:d[9]||(d[9]=p=>be.value=!0)},null,544),[[ut,B.value]])])):(o(),m("div",qa,[s("div",Ha,[e(b,null,{default:t(()=>[e(xe)]),_:1}),i(" "+f(C.value)+" ",1),s("div",Ga,[ie.value?(o(),x(W,{key:0,type:"warning",size:"small"},{default:t(()=>[...d[27]||(d[27]=[i("未保存",-1)])]),_:1})):h("",!0),s("span",Qa,f(H.value.length)+" 字符",1),e(F,{size:"small",circle:"",loading:G.value,onClick:me,title:"重新加载"},{default:t(()=>[e(b,null,{default:t(()=>[e(D)]),_:1})]),_:1},8,["loading"]),e(vl,{title:"确认删除该文件？",onConfirm:d[10]||(d[10]=p=>Qe(C.value))},{reference:t(()=>[e(F,{size:"small",circle:"",type:"danger",plain:""},{default:t(()=>[e(b,null,{default:t(()=>[e(M)]),_:1})]),_:1})]),_:1})])]),Oe(s("textarea",{"onUpdate:modelValue":d[11]||(d[11]=p=>H.value=p),class:"code-textarea",spellcheck:"false",placeholder:`编辑 ${C.value} …`,onInput:d[12]||(d[12]=p=>ie.value=!0)},null,40,Xa),[[ut,H.value]])]))])],64)):(o(),m("div",Ta,[e(b,{size:"48",color:"#c0c4cc"},{default:t(()=>[e(Il)]),_:1}),d[15]||(d[15]=s("p",null,"从左侧选择一个技能开始编辑",-1)),e(F,{type:"primary",onClick:Me},{default:t(()=>[e(b,null,{default:t(()=>[e(J)]),_:1}),d[14]||(d[14]=i(" 新建技能",-1))]),_:1})]))]),s("div",Za,[s("div",en,[e(b,null,{default:t(()=>[e(Ce)]),_:1}),d[28]||(d[28]=i(" AI 协作配置 ",-1)),v.value?(o(),m("span",ln,[i(" 当前: "+f(v.value.name)+" ",1),ke.value.size>1?(o(),m("span",tn," ("+f(ke.value.size)+" 个并行生成中) ",1)):h("",!0)])):h("",!0)]),s("div",an,[(o(!0),m(N,null,Y(U.value,p=>Oe((o(),x(_t,{key:p.id,ref_for:!0,ref:te=>rl(p.id,te),"agent-id":S(_),context:v.value?.id===p.id?qe.value:"",scenario:"skill-studio","skill-id":p.id,"welcome-message":v.value?.id===p.id?de.value:"",examples:v.value?.id===p.id?He.value:[],compact:"",onResponse:te=>Xe(p.id),onStreamingChange:te=>Ie(p.id,te)},null,8,["agent-id","context","skill-id","welcome-message","examples","onResponse","onStreamingChange"])),[[na,v.value?.id===p.id]])),128))])])])}}}),sn=wt(nn,[["__scopeId","data-v-3a5bcde8"]]),on={class:"header-left"},un={class:"chat-layout"},dn={class:"session-sidebar"},rn={class:"session-sidebar-header"},fn={class:"session-list"},vn=["onClick"],pn={class:"session-item-title"},cn={class:"session-item-meta"},mn={key:0,class:"session-empty"},yn={class:"at-panel"},gn={key:0,class:"at-form"},_n={class:"chat-area"},wn={style:{display:"flex","justify-content":"space-between",width:"100%"}},bn={style:{color:"#999","font-size":"12px"}},kn={style:{display:"flex","align-items":"center",gap:"8px"}},xn={style:{"font-weight":"600"}},hn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"32px 0","font-size":"14px"}},Cn={style:{display:"flex","align-items":"center",gap:"8px"}},Vn={style:{"font-size":"13px"}},$n={style:{"font-size":"13px",color:"#606266"}},zn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"40px 0"}},Tn={key:1,class:"relations-list"},Sn={class:"relation-info"},Ln={class:"relation-name"},In={class:"relation-tags"},Un={class:"relation-desc"},Dn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Fn={style:{display:"flex",gap:"8px","margin-top":"4px"}},An={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Nn={key:0,style:{"text-align":"center",color:"#c0c4cc",padding:"16px 0","font-size":"13px"}},Mn={style:{"font-size":"12px"}},Bn={style:{"font-size":"12px",color:"#606266"}},Pn={class:"memory-toolbar",style:{"margin-bottom":"12px",display:"flex",gap:"8px"}},jn={style:{display:"flex","align-items":"center",gap:"4px","font-size":"13px"}},En={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Rn={style:{"margin-bottom":"16px",display:"flex","align-items":"center",gap:"8px"}},Kn={class:"conv-drawer-body"},Wn={key:0,style:{"text-align":"center","margin-bottom":"12px"}},On={class:"conv-msg-list"},Yn={class:"conv-msg-meta"},Jn={class:"conv-msg-role"},qn={key:0,class:"conv-msg-sender"},Hn={class:"conv-msg-time"},Gn={class:"conv-msg-content"},Qn={key:0,class:"conv-msg-empty"},Xn={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Zn={style:{display:"flex",gap:"4px"}},es={style:{flex:"1","overflow-y":"auto"}},ls={style:{display:"flex","align-items":"center",gap:"5px","line-height":"1.8",width:"100%"}},ts={style:{flex:"1",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},as={style:{display:"flex","align-items":"center","justify-content":"space-between"}},ns={style:{"font-family":"monospace","font-size":"13px",color:"#606266"}},ss={style:{"margin-top":"8px",display:"flex",gap:"8px","align-items":"center"}},os={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"16px"}},is={class:"channel-card-header"},us={class:"channel-card-left"},ds={class:"channel-card-name"},rs={key:0,class:"channel-bot-username"},fs={class:"channel-card-actions"},vs={key:0,class:"channel-card-body"},ps={class:"channel-info-row"},cs={class:"channel-info-value"},ms={class:"channel-info-row"},ys={class:"channel-info-value"},gs={key:1,class:"channel-card-body"},_s={class:"channel-info-row"},ws={class:"channel-info-value"},bs={style:{opacity:"0.6","font-size":"11px","margin-left":"3px"}},ks={class:"pending-section"},xs=["onClick"],hs={key:0,class:"pending-list"},Cs={key:0,style:{"text-align":"center",padding:"12px"}},Vs={class:"pending-user-info"},$s={class:"pending-user-name"},zs={key:0,class:"pending-user-username"},Ts={class:"pending-user-id"},Ss={class:"pending-user-actions"},Ls={key:2,class:"pending-empty"},Is={style:{width:"100%"}},Us={style:{display:"flex",gap:"6px","align-items":"center"}},Ds={key:0,style:{"margin-top":"6px",display:"flex","align-items":"center",gap:"6px",color:"#909399","font-size":"13px"}},Fs={key:1,style:{"margin-top":"6px",color:"#67c23a","font-size":"13px"}},As={key:2,style:{"margin-top":"6px",color:"#e6a23c","font-size":"13px"}},Ns={key:3,style:{"margin-top":"6px",color:"#f56c6c","font-size":"13px"}},Ms={key:4,style:{"margin-top":"4px"}},Bs={class:"channel-url-preview"},Ps={class:"channel-url-text"},js={class:"channel-url-preview"},Es={class:"channel-url-text"},Rs=50,Ks=mt({__name:"AgentDetailView",setup(ql){const se=sa(),_=se.params.id,U=r(null),oe=r("chat"),v=r(),C=r([]),$=r(!1),B=r();async function Te(){$.value=!0;try{const n=await va.list({agentId:_,limit:50});C.value=n.data.sessions}catch{}finally{$.value=!1}}function be(n){B.value=n.id,v.value?.resumeSession(n.id)}function Ye(){B.value=void 0,v.value?.startNewSession()}function Se(n){B.value=n,setTimeout(Te,500)}function ce(n){if(!n)return"";const l=Date.now()-n;return l<6e4?"刚刚":l<36e5?`${Math.floor(l/6e4)}分前`:l<864e5?`${Math.floor(l/36e5)}小时前`:`${Math.floor(l/864e5)}天前`}const Z=r(!1),ee=r(""),H=r(""),ie=r(!1),G=r([]);function Je(){Z.value=!Z.value,Z.value&&!G.value.length&&rl()}async function rl(){try{const n=await zl.list();G.value=n.data.filter(l=>l.id!==_)}catch{G.value=[]}}function Le(n){const l=G.value.find(u=>u.id===n);l&&v.value?.fillInput(`@${l.name}: `)}async function ke(){const n=ee.value,l=H.value.trim();if(!n||!l)return;const V=G.value.find(Ve=>Ve.id===n)?.name??n;ie.value=!0;const j={role:"user",text:`→ 转发给 ${V}：
${l}`};v.value?.appendMessage(j);try{const T=(await zl.message(n,l,_)).data.response,ne={role:"assistant",text:`← **${V}** 回复：

${T}`};v.value?.appendMessage(ne),H.value="",ee.value="",Z.value=!1,y.success(`${V} 已回复`)}catch(Ve){const T={role:"system",text:`[失败] 转发失败：${Ve.response?.data?.error??Ve.message??"网络错误"}`};v.value?.appendMessage(T),y.error("转发失败")}finally{ie.value=!1}}const Ie=r(""),ue=r(""),qe=r([]),de=r(""),He=r(!1),L=r({enabled:!1,schedule:"daily",keepTurns:3,focusHint:"",cronJobId:""}),Ue=r(!1),De=r(!1);async function fl(){try{const n=await Tl.getConfig(_);L.value=n.data,Qe()}catch{}}async function Ge(){Ue.value=!0;try{const n=await Tl.setConfig(_,L.value);L.value=n.data,y.success(L.value.enabled?"自动记忆已开启":"自动记忆已关闭")}catch{y.error("保存失败")}finally{Ue.value=!1}}async function Fe(){De.value=!0;try{await Tl.consolidate(_),y.success("记忆整理已在后台启动（约需10~30秒），稍后自动刷新日志"),setTimeout(Qe,1e4)}catch{y.error("整理失败")}finally{De.value=!1}}const Ae=r([]),me=r(!1);async function Qe(){me.value=!0;try{const n=await Tl.runLog(_);Ae.value=n.data||[]}catch{Ae.value=[]}finally{me.value=!1}}const Ne=r([]),ye=r(""),ge=r(""),Me=r(!1),Xe=r([]),le=r(!1),Be=r(""),c=r(!1),d=r(""),D=r([]),b=r(""),F=r(""),J=r(null),K=r(!1),W=r(!1),re=r("");function Il(n){const l=n.split(".").pop()?.toLowerCase()||"";return["md","txt","rst"].includes(l)?"#409eff":["json","yaml","yml","toml"].includes(l)?"#67c23a":["go","py","js","ts","sh","bash"].includes(l)?"#e6a23c":["jpg","jpeg","png","gif","svg","webp"].includes(l)?"#f56c6c":n.startsWith(".")?"#c0c4cc":"#909399"}function Ul(n){const l=n.split("/").pop()||n,u=l.split(".").pop()?.toLowerCase()||"";return!u||u===l.toLowerCase()?"file":"."+u}const O=r([]),Ze=r(!1),M=r({agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""});async function vl(){try{const n=await pt.get(_);O.value=n.data.parsed||[]}catch{O.value=[]}}function pl(n){const l=G.value.find(u=>u.id===n);M.value.agentName=l?l.name:n}async function xe(){if(!M.value.agentId)return;if(O.value.find(l=>l.agentId===M.value.agentId)){y.warning("该成员关系已存在，请先删除再重新添加");return}O.value.push({...M.value}),M.value={agentId:"",agentName:"",relationType:"平级协作",strength:"常用",desc:""},await he()}async function _e(n){O.value.splice(n,1),await he()}function fe(){if(O.value.length===0)return"";const n=`| 成员ID | 成员名称 | 关系类型 | 关系程度 | 说明 |
|--------|--------|--------|--------|------|`,l=O.value.map(u=>`| ${u.agentId} | ${u.agentName} | ${u.relationType} | ${u.strength} | ${u.desc||""} |`).join(`
`);return n+`
`+l}async function he(){Ze.value=!0;try{await pt.put(_,fe()),y.success("关系已保存")}catch{y.error("保存失败")}finally{Ze.value=!1}}function Pe(n){const l=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399","#B45309","#7C3AED","#0891B2"];let u=0;for(let V=0;V<n.length;V++)u=n.charCodeAt(V)+((u<<5)-u);return l[Math.abs(u)%l.length]??"#409EFF"}function cl(n){return n==="上级"?"danger":n==="下级"?"":n==="平级协作"?"success":"info"}function ml(n){return n==="核心"?"danger":n==="常用"?"warning":"info"}const yl=r([]),Ce=r(!1),p=r({name:"",expr:"0 9 * * *",tz:"Asia/Shanghai",message:"",enabled:!0});function te(n){return n==="running"?"success":n==="stopped"?"danger":"info"}function bt(n){return n==="running"?"运行中":n==="stopped"?"已停止":"空闲"}function gl(n){return n?n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB":"0 B"}function kt(n){return new Date(n).toLocaleString()}function Hl(n){return n?new Date(n).toLocaleString():""}const ve=r([]),Dl=r(!1),je=r(!1),ae=r(""),_l=r(""),Fl=r(!1),Al=r(""),w=r({type:"telegram",name:"",enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""}),I=r({loading:!1,status:""});let Nl=null;function Ml(n){return/^\*+$/.test(n)}async function Gl(){const n=w.value.botToken;if(!(!n||Ml(n))){I.value={loading:!0,status:""};try{const u=(await X.checkToken(_,n)).data;u.duplicate?I.value={loading:!1,status:"duplicate",usedBy:u.usedBy,usedByCh:u.usedByCh}:u.valid?(I.value={loading:!1,status:"ok",botName:u.botName},!w.value.name&&u.botName&&(w.value.name=u.botName)):I.value={loading:!1,status:"error",error:u.error||"Token 无效"}}catch{I.value={loading:!1,status:"error",error:"网络错误，请重试"}}}}Sl(()=>w.value.type,n=>{ae.value||(_l.value=Bl(n))}),Sl(()=>w.value.botToken,n=>{I.value={loading:!1,status:""},Nl&&clearTimeout(Nl),!(!n||Ml(n)||n.length<20||!n.includes(":"))&&(Nl=setTimeout(Gl,800))});function Ee(n,l){return l?`${window.location.origin}/chat/${n}/${l}`:`${window.location.origin}/chat/${n}`}function Ql(n){navigator.clipboard.writeText(n).then(()=>y.success("链接已复制"))}async function Re(){Dl.value=!0;try{const n=await X.list(_);ve.value=n.data||[]}catch{ve.value=[]}finally{Dl.value=!1}}function Bl(n){return n+"-"+Date.now().toString(36)}function xt(){ae.value="";const n=U.value?.name||"";_l.value=Bl("telegram"),w.value={type:"telegram",name:n,enabled:!0,botToken:"",allowedFrom:"",webPassword:"",webWelcome:"",webTitle:""},I.value={loading:!1,status:""},je.value=!0}function ht(n){ae.value=n.id,w.value={type:n.type,name:n.name,enabled:n.enabled,botToken:n.config?.botToken||"",allowedFrom:n.config?.allowedFrom||"",webPassword:"",webWelcome:n.config?.welcomeMsg||"",webTitle:n.config?.title||""},I.value={loading:!1,status:""},je.value=!0}async function Ct(){if(!w.value.name||!w.value.type){y.warning("请填写名称和类型");return}if(I.value.status==="duplicate"){y.error(`Bot Token 已被成员「${I.value.usedBy}」使用，请更换`);return}Fl.value=!0;try{const n={};if(w.value.type==="telegram"?(w.value.botToken&&(n.botToken=w.value.botToken),w.value.allowedFrom&&(n.allowedFrom=w.value.allowedFrom)):w.value.type==="web"&&(w.value.webPassword&&(n.password=w.value.webPassword),w.value.webWelcome&&(n.welcomeMsg=w.value.webWelcome),w.value.webTitle&&(n.title=w.value.webTitle)),ae.value){const l=ve.value.map(u=>u.id!==ae.value?u:{...u,name:w.value.name,type:w.value.type,enabled:w.value.enabled,config:{...u.config,...n}});await X.set(_,l)}else{const l={id:_l.value||Bl(w.value.type),name:w.value.name,type:w.value.type,enabled:w.value.enabled,config:n,status:"untested"};await X.set(_,[...ve.value,l])}y.success(w.value.type==="web"?"保存成功，Web 聊天页立即生效":"保存成功，重启后新渠道生效"),je.value=!1,await Re()}catch(n){y.error(n.response?.data?.error||"保存失败")}finally{Fl.value=!1}}async function Vt(){try{await X.set(_,ve.value)}catch(n){y.error(n.response?.data?.error||"保存失败"),await Re()}}async function $t(n){const l=ve.value.filter(u=>u.id!==n.id);try{await X.set(_,l),ve.value=l,y.success("已删除")}catch{y.error("删除失败")}}async function zt(n){Al.value=n.id;try{const l=await X.test(_,n.id);l.data.valid?y.success(l.data.botName?`测试成功 (@${l.data.botName})`:"测试成功"):y.error(l.data.error||"测试失败"),await Re()}catch{y.error("测试请求失败")}finally{Al.value=""}}const Ke=r({}),Pl=r({}),el=r(""),jl=r("");async function wl(n){Pl.value[n]=!0;try{const l=await X.listPending(_,n);Ke.value[n]=l.data||[]}catch{Ke.value[n]=[]}finally{Pl.value[n]=!1}}function Tt(n){el.value===n?el.value="":(el.value=n,wl(n))}async function St(n,l){jl.value=`${n}-${l}`;try{await X.allowUser(_,n,l),y.success(`用户 ${l} 已加入白名单`),await wl(n),await Re()}catch{y.error("操作失败")}finally{jl.value=""}}async function Lt(n,l){try{await X.dismissUser(_,n,l),y.success("已忽略"),await wl(n)}catch{y.error("操作失败")}}async function Xl(n,l){try{await vt.confirm(`确定将用户 ${l} 从白名单中移除？移除后该用户将无法使用此 Bot。`,"移除白名单",{confirmButtonText:"确认移除",cancelButtonText:"取消",type:"warning"})}catch{return}try{await X.removeAllowed(_,n,l),y.success(`用户 ${l} 已从白名单移除`),await Re()}catch{y.error("操作失败")}}yt(async()=>{try{const u=await zl.get(_);U.value=u.data}catch{y.error("加载 Agent 失败")}It(),Ut(),vl(),rl(),fl(),bl(),kl(),Re(),await Te();const n=se.query.tab;n&&(oe.value=n);const l=se.query.resumeSession;l&&(B.value=l,await new Promise(V=>setTimeout(V,100)),v.value?.resumeSession(l),C.value.find(V=>V.id===l)||(B.value=l))});async function It(){try{const[n,l]=await Promise.all([q.read(_,"IDENTITY.md"),q.read(_,"SOUL.md")]);Ie.value=n.data?.content||"",ue.value=l.data?.content||""}catch{}ll()}async function El(n,l){try{await q.write(_,n,l),y.success(`${n} 已保存`)}catch{y.error(`保存 ${n} 失败`)}}async function Ut(){try{const n=await fa.list();if(qe.value=n.data||[],U.value?.modelId)de.value=U.value.modelId;else{const l=qe.value.find(u=>u.provider+"/"+u.model===U.value?.model||u.id===U.value?.model);de.value=l?.id||""}}catch{}}async function Dt(){if(de.value){He.value=!0;try{const n=await zl.update(_,{modelId:de.value});U.value=n.data,y.success("模型已更新")}catch{y.error("更新失败")}finally{He.value=!1}}}async function ll(){try{const n=await il.tree(_);Ne.value=n.data||[]}catch{Ne.value=[]}}async function Ft(n){if(!n.isDir){ye.value=n.path,Xe.value=n.path.split("/");try{const l=await il.readFile(_,n.path);ge.value=l.data?.content||""}catch{ge.value="(无法读取)"}}}async function At(){if(ye.value){Me.value=!0;try{await il.writeFile(_,ye.value,ge.value),y.success("记忆文件已保存"),ll()}catch{y.error("保存失败")}finally{Me.value=!1}}}async function Nt(){const n=Be.value.trim();if(!n){y.warning("请输入路径");return}try{await il.writeFile(_,n,`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`),y.success("文件已创建"),le.value=!1,Be.value="",ll(),ye.value=n,Xe.value=n.split("/"),ge.value=`# ${n.split("/").pop()?.replace(".md","")||"New File"}

`}catch{y.error("创建失败")}}async function Mt(){const n=d.value.trim();if(!n){y.warning("请输入内容");return}try{await il.dailyLog(_,n),y.success("日志已添加"),c.value=!1,d.value="",ll()}catch{y.error("添加失败")}}async function bl(){try{const n=await q.readTree(_);Array.isArray(n.data)&&(D.value=n.data)}catch{}}async function Bt(n){if(!n.isDir){b.value=n.path||n.name,J.value=n,K.value=!1;try{const l=await q.read(_,b.value);l.data?.encoding==="base64"?(K.value=!0,F.value=`[二进制文件 ${gl(l.data.size)}]`):F.value=l.data?.content??""}catch{F.value=""}}}async function Pt(){if(b.value)try{await vt.confirm(`删除「${b.value}」？此操作不可恢复`,"删除文件",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}),await q.delete(_,b.value),y.success("已删除"),b.value="",F.value="",J.value=null,bl()}catch(n){n!=="cancel"&&y.error("删除失败")}}async function Zl(){const n=re.value.trim();if(n)try{await q.write(_,n,""),y.success(`已创建 ${n}`),W.value=!1,re.value="",await bl(),b.value=n,F.value="",J.value=null,K.value=!1}catch{y.error("创建失败")}}async function jt(){b.value&&await El(b.value,F.value)}async function kl(){try{const n=await ul.list(_);yl.value=n.data||[]}catch{}}async function Et(){try{await ul.create({name:p.value.name,enabled:p.value.enabled,agentId:_,schedule:{kind:"cron",expr:p.value.expr,tz:p.value.tz},payload:{kind:"agentTurn",message:p.value.message},delivery:{mode:"announce"}}),y.success("任务创建成功"),Ce.value=!1,kl()}catch(n){y.error(n.response?.data?.error||"创建失败")}}async function Rt(n){try{await ul.update(n.id,n)}catch{y.error("更新失败")}}async function et(n){try{await ul.run(n.id),y.success("已触发运行"),setTimeout(kl,2e3)}catch{y.error("运行失败")}}async function Kt(n){try{await ul.delete(n.id),y.success("已删除"),kl()}catch{y.error("删除失败")}}const xl=r(!1),Rl=r([]),Kl=r(!1),Wl=r(""),we=r([]),Ol=r(0),hl=r(0),Wt=Ll(()=>we.value.length<Ol.value),tl=r(!1);async function lt(){xl.value=!0;try{const n=await ct.list(_);Rl.value=n.data}catch{y.error("加载对话渠道失败")}finally{xl.value=!1}}async function Ot(n){Wl.value=n.channelId,we.value=[],Ol.value=0,hl.value=0,Kl.value=!0,await tt()}async function tt(){tl.value=!0;try{const l=(await ct.messages(_,Wl.value,{limit:Rs,offset:hl.value})).data;Ol.value=l.total,hl.value===0?we.value=l.messages:we.value=[...l.messages,...we.value],hl.value+=l.messages.length}catch{y.error("加载消息失败")}finally{tl.value=!1}}async function Yt(){await tt()}return Sl(oe,n=>{n==="convlogs"&&Rl.value.length===0&&lt()}),(n,l)=>{const u=g("el-button"),V=g("el-tag"),j=g("el-text"),Ve=g("el-header"),T=g("el-option"),ne=g("el-select"),P=g("el-input"),pe=g("el-tab-pane"),z=g("el-form-item"),$e=g("el-form"),Q=g("el-card"),R=g("el-col"),ze=g("el-row"),at=g("el-badge"),E=g("el-table-column"),Cl=g("el-table"),al=g("el-switch"),Jt=g("el-input-number"),A=g("el-icon"),nt=g("el-tree"),Vl=g("el-empty"),st=g("el-breadcrumb-item"),qt=g("el-breadcrumb"),nl=g("el-dialog"),Ht=g("el-drawer"),Gt=g("Delete"),Qt=g("el-link"),Xt=g("CircleCheck"),Zt=g("Warning"),ea=g("CircleClose"),ot=g("InfoFilled"),it=g("Link"),la=g("el-tabs"),ta=g("el-main"),aa=g("el-container"),Yl=ra("loading");return o(),x(aa,{class:"agent-detail"},{default:t(()=>[e(Ve,{class:"detail-header"},{default:t(()=>[s("div",on,[e(u,{icon:S(oa),onClick:l[0]||(l[0]=a=>n.$router.push("/agents")),circle:""},null,8,["icon"]),s("h2",null,f(U.value?.name||"..."),1),e(V,{type:te(U.value?.status)},{default:t(()=>[i(f(bt(U.value?.status)),1)]),_:1},8,["type"])]),e(j,{type:"info"},{default:t(()=>[i(f(U.value?.model),1)]),_:1})]),_:1}),e(ta,null,{default:t(()=>[e(la,{modelValue:oe.value,"onUpdate:modelValue":l[50]||(l[50]=a=>oe.value=a),type:"border-card"},{default:t(()=>[e(pe,{label:"对话",name:"chat"},{default:t(()=>[s("div",un,[s("div",dn,[s("div",rn,[l[52]||(l[52]=s("span",{class:"sidebar-title"},"历史对话",-1)),e(u,{size:"small",type:"primary",plain:"",onClick:Ye,icon:S(sl)},{default:t(()=>[...l[51]||(l[51]=[i("新建",-1)])]),_:1},8,["icon"])]),Oe((o(),m("div",fn,[(o(!0),m(N,null,Y(C.value,a=>(o(),m("div",{key:a.id,class:dl(["session-item",{active:B.value===a.id}]),onClick:k=>be(a)},[s("div",pn,f(a.title||"新对话"),1),s("div",cn,[s("span",null,f(ce(a.lastAt)),1),e(V,{size:"small",type:"info",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[i(f(a.messageCount)+" 条 ",1)]),_:2},1024),a.tokenEstimate>6e4?(o(),x(V,{key:0,size:"small",type:"warning",effect:"plain",style:{"font-size":"10px",padding:"0 4px"}},{default:t(()=>[i("~"+f(Math.round(a.tokenEstimate/1e3))+"k",1)]),_:2},1024)):h("",!0)])],10,vn))),128)),!$.value&&!C.value.length?(o(),m("div",mn," 还没有对话记录 ")):h("",!0)])),[[Yl,$.value]]),s("div",yn,[e(u,{size:"small",plain:"",class:"at-toggle-btn",onClick:Je},{default:t(()=>[...l[53]||(l[53]=[s("span",{class:"at-icon"},"@",-1),i(" 其他成员 ",-1)])]),_:1}),Z.value?(o(),m("div",gn,[e(ne,{modelValue:ee.value,"onUpdate:modelValue":l[1]||(l[1]=a=>ee.value=a),placeholder:"选择成员",size:"small",style:{width:"100%","margin-bottom":"6px"},onChange:Le},{default:t(()=>[(o(!0),m(N,null,Y(G.value,a=>(o(),x(T,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e(P,{modelValue:H.value,"onUpdate:modelValue":l[2]||(l[2]=a=>H.value=a),type:"textarea",rows:3,placeholder:"输入要转发的消息…",size:"small",style:{"margin-bottom":"6px"}},null,8,["modelValue"]),e(u,{type:"primary",size:"small",style:{width:"100%"},loading:ie.value,disabled:!ee.value||!H.value.trim(),onClick:ke},{default:t(()=>[...l[54]||(l[54]=[i(" 转发 ",-1)])]),_:1},8,["loading","disabled"])])):h("",!0)])]),s("div",_n,[e(_t,{ref_key:"aiChatRef",ref:v,"agent-id":S(_),scenario:"agent-detail","welcome-message":`你好！我是 **${U.value?.name||"AI"}**，有什么可以帮你的？`,height:"calc(100vh - 145px)","show-thinking":!0,onSessionChange:Se},null,8,["agent-id","welcome-message"])])])]),_:1}),e(pe,{label:"身份 & 灵魂",name:"identity"},{default:t(()=>[e(Q,{style:{"margin-bottom":"16px"}},{header:t(()=>[...l[55]||(l[55]=[s("span",{style:{"font-weight":"600"}},"基本设置",-1)])]),default:t(()=>[e($e,{"label-width":"80px",size:"default"},{default:t(()=>[e(z,{label:"使用模型"},{default:t(()=>[e(ne,{modelValue:de.value,"onUpdate:modelValue":l[3]||(l[3]=a=>de.value=a),placeholder:"选择模型",style:{width:"280px","margin-right":"10px"}},{default:t(()=>[(o(!0),m(N,null,Y(qe.value,a=>(o(),x(T,{key:a.id,label:a.name||a.model,value:a.id},{default:t(()=>[s("div",wn,[s("span",null,f(a.name||a.model),1),s("span",bn,f(a.provider),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),e(u,{type:"primary",loading:He.value,onClick:Dt,disabled:!de.value},{default:t(()=>[...l[56]||(l[56]=[i("保存",-1)])]),_:1},8,["loading","disabled"]),U.value?.model?(o(),x(j,{key:0,type:"info",style:{"margin-left":"12px","font-size":"12px"}},{default:t(()=>[i(" 当前："+f(U.value.model),1)]),_:1})):h("",!0)]),_:1})]),_:1})]),_:1}),e(ze,{gutter:20},{default:t(()=>[e(R,{span:12},{default:t(()=>[e(Q,{header:"IDENTITY.md"},{default:t(()=>[e(P,{modelValue:Ie.value,"onUpdate:modelValue":l[4]||(l[4]=a=>Ie.value=a),type:"textarea",rows:15,onBlur:l[5]||(l[5]=a=>El("IDENTITY.md",Ie.value))},null,8,["modelValue"])]),_:1})]),_:1}),e(R,{span:12},{default:t(()=>[e(Q,{header:"SOUL.md"},{default:t(()=>[e(P,{modelValue:ue.value,"onUpdate:modelValue":l[6]||(l[6]=a=>ue.value=a),type:"textarea",rows:15,onBlur:l[7]||(l[7]=a=>El("SOUL.md",ue.value))},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(pe,{label:"关系",name:"relations"},{default:t(()=>[e(ze,{gutter:20},{default:t(()=>[e(R,{span:14},{default:t(()=>[e(Q,{style:{"margin-bottom":"16px"}},{header:t(()=>[...l[57]||(l[57]=[s("span",{style:{"font-weight":"600"}},"添加关系",-1)])]),default:t(()=>[e($e,{model:M.value,"label-position":"top",size:"default"},{default:t(()=>[e(ze,{gutter:12},{default:t(()=>[e(R,{span:10},{default:t(()=>[e(z,{label:"关联成员"},{default:t(()=>[e(ne,{modelValue:M.value.agentId,"onUpdate:modelValue":l[8]||(l[8]=a=>M.value.agentId=a),placeholder:"选择系统成员",filterable:"",style:{width:"100%"},onChange:pl},{default:t(()=>[(o(!0),m(N,null,Y(G.value,a=>(o(),x(T,{key:a.id,label:a.name,value:a.id},{default:t(()=>[s("div",kn,[s("div",{style:We([{width:"24px",height:"24px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"11px",color:"#fff","flex-shrink":"0"},{background:Pe(a.id)}])},f(a.name.charAt(0)),5),s("span",null,f(a.name),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(R,{span:7},{default:t(()=>[e(z,{label:"关系类型"},{default:t(()=>[e(ne,{modelValue:M.value.relationType,"onUpdate:modelValue":l[9]||(l[9]=a=>M.value.relationType=a),style:{width:"100%"}},{default:t(()=>[e(T,{label:"上级",value:"上级"}),e(T,{label:"下级",value:"下级"}),e(T,{label:"平级协作",value:"平级协作"}),e(T,{label:"支持",value:"支持"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(R,{span:7},{default:t(()=>[e(z,{label:"协作程度"},{default:t(()=>[e(ne,{modelValue:M.value.strength,"onUpdate:modelValue":l[10]||(l[10]=a=>M.value.strength=a),style:{width:"100%"}},{default:t(()=>[e(T,{label:"核心",value:"核心"}),e(T,{label:"常用",value:"常用"}),e(T,{label:"偶尔",value:"偶尔"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(ze,{gutter:12},{default:t(()=>[e(R,{span:18},{default:t(()=>[e(z,{label:"说明（选填）"},{default:t(()=>[e(P,{modelValue:M.value.desc,"onUpdate:modelValue":l[11]||(l[11]=a=>M.value.desc=a),placeholder:"简要描述这段关系..."},null,8,["modelValue"])]),_:1})]),_:1}),e(R,{span:6},{default:t(()=>[e(z,{label:" "},{default:t(()=>[e(u,{type:"primary",style:{width:"100%"},disabled:!M.value.agentId||!M.value.relationType||!M.value.strength,loading:Ze.value,onClick:xe},{default:t(()=>[...l[58]||(l[58]=[i(" 添加 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(Q,null,{header:t(()=>[s("span",xn,[l[59]||(l[59]=i("已有关系 ",-1)),e(at,{value:O.value.length,type:"info",style:{"margin-left":"4px"}},null,8,["value"])])]),default:t(()=>[O.value.length===0?(o(),m("div",hn," 暂无关系，请在上方添加 ")):(o(),x(Cl,{key:1,data:O.value,size:"small",style:{width:"100%"}},{default:t(()=>[e(E,{label:"成员","min-width":"120"},{default:t(({row:a})=>[s("div",Cn,[s("div",{style:We([{width:"28px",height:"28px","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"12px",color:"#fff","flex-shrink":"0"},{background:Pe(a.agentId)}])},f(a.agentName.charAt(0)),5),s("span",Vn,f(a.agentName),1)])]),_:1}),e(E,{label:"类型",width:"100"},{default:t(({row:a})=>[e(V,{type:cl(a.relationType),size:"small"},{default:t(()=>[i(f(a.relationType),1)]),_:2},1032,["type"])]),_:1}),e(E,{label:"程度",width:"80"},{default:t(({row:a})=>[e(V,{type:ml(a.strength),size:"small",effect:"plain"},{default:t(()=>[i(f(a.strength),1)]),_:2},1032,["type"])]),_:1}),e(E,{label:"说明","min-width":"120","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",$n,f(a.desc||"—"),1)]),_:1}),e(E,{label:"操作",width:"70",fixed:"right"},{default:t(({$index:a})=>[e(u,{type:"danger",link:"",size:"small",onClick:k=>_e(a)},{default:t(()=>[...l[60]||(l[60]=[i("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]))]),_:1})]),_:1}),e(R,{span:10},{default:t(()=>[e(Q,{header:"关系预览"},{default:t(()=>[O.value.length===0?(o(),m("div",zn," 暂无关系数据 ")):(o(),m("div",Tn,[(o(!0),m(N,null,Y(O.value,a=>(o(),m("div",{key:a.agentId,class:"relation-card"},[s("div",{class:"relation-avatar",style:We({background:Pe(a.agentId)})},f(a.agentName.charAt(0).toUpperCase()),5),s("div",Sn,[s("div",Ln,f(a.agentName),1),s("div",In,[e(V,{type:cl(a.relationType),size:"small"},{default:t(()=>[i(f(a.relationType),1)]),_:2},1032,["type"]),e(V,{type:ml(a.strength),size:"small",effect:"plain"},{default:t(()=>[i(f(a.strength),1)]),_:2},1032,["type"])]),s("div",Un,f(a.desc),1)])]))),128))]))]),_:1})]),_:1})]),_:1})]),_:1}),e(pe,{label:"记忆",name:"memory"},{default:t(()=>[e(Q,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",Dn,[l[61]||(l[61]=s("span",{style:{"font-weight":"600"}},"自动记忆",-1)),e(al,{modelValue:L.value.enabled,"onUpdate:modelValue":l[12]||(l[12]=a=>L.value.enabled=a),"active-text":"已开启","inactive-text":"已关闭",onChange:Ge},null,8,["modelValue"])])]),default:t(()=>[e($e,{model:L.value,"label-position":"top",size:"small",disabled:!L.value.enabled},{default:t(()=>[e(ze,{gutter:16},{default:t(()=>[e(R,{span:6},{default:t(()=>[e(z,{label:"整理频率"},{default:t(()=>[e(ne,{modelValue:L.value.schedule,"onUpdate:modelValue":l[13]||(l[13]=a=>L.value.schedule=a),style:{width:"100%"}},{default:t(()=>[e(T,{label:"每小时",value:"hourly"}),e(T,{label:"每6小时",value:"every6h"}),e(T,{label:"每天",value:"daily"}),e(T,{label:"每周",value:"weekly"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(R,{span:5},{default:t(()=>[e(z,{label:"每个会话保留轮数"},{default:t(()=>[e(Jt,{modelValue:L.value.keepTurns,"onUpdate:modelValue":l[14]||(l[14]=a=>L.value.keepTurns=a),min:1,max:20,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(R,{span:13},{default:t(()=>[e(z,{label:"记录重点（留空则自动）"},{default:t(()=>[e(P,{modelValue:L.value.focusHint,"onUpdate:modelValue":l[15]||(l[15]=a=>L.value.focusHint=a),placeholder:"例如：记录数学解题步骤和用户常见错误"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s("div",Fn,[e(u,{type:"primary",size:"small",loading:Ue.value,onClick:Ge},{default:t(()=>[...l[62]||(l[62]=[i(" 保存设置 ",-1)])]),_:1},8,["loading"]),e(u,{size:"small",loading:De.value,onClick:Fe},{default:t(()=>[...l[63]||(l[63]=[i(" 立即整理 ",-1)])]),_:1},8,["loading"]),e(j,{type:"info",size:"small",style:{"align-self":"center","margin-left":"4px"}},{default:t(()=>[i(" 整理后：LLM提炼摘要写入 MEMORY.md，每个会话只保留最近 "+f(L.value.keepTurns)+" 轮对话 ",1)]),_:1})])]),_:1},8,["model","disabled"])]),_:1}),e(Q,{style:{"margin-bottom":"16px"},shadow:"never"},{header:t(()=>[s("div",An,[l[65]||(l[65]=s("span",{style:{"font-weight":"600"}},"整理日志",-1)),e(u,{size:"small",text:"",onClick:Qe,loading:me.value},{default:t(()=>[...l[64]||(l[64]=[i("刷新",-1)])]),_:1},8,["loading"])])]),default:t(()=>[Ae.value.length===0&&!me.value?(o(),m("div",Nn," 暂无运行记录，点击「立即整理」触发第一次 ")):(o(),x(Cl,{key:1,data:Ae.value.slice(0,20),size:"small"},{default:t(()=>[e(E,{label:"时间",width:"160"},{default:t(({row:a})=>[s("span",Mn,f(Hl(a.timestamp)),1)]),_:1}),e(E,{label:"状态",width:"72"},{default:t(({row:a})=>[e(V,{type:a.status==="ok"?"success":"danger",size:"small"},{default:t(()=>[i(f(a.status),1)]),_:2},1032,["type"])]),_:1}),e(E,{label:"结果","min-width":"200","show-overflow-tooltip":""},{default:t(({row:a})=>[s("span",Bn,f(a.message||"—"),1)]),_:1})]),_:1},8,["data"]))]),_:1}),s("div",Pn,[e(u,{type:"primary",size:"small",onClick:l[16]||(l[16]=a=>le.value=!0)},{default:t(()=>[e(A,null,{default:t(()=>[e(S(sl))]),_:1}),l[66]||(l[66]=i(" 新建文件 ",-1))]),_:1}),e(u,{size:"small",onClick:l[17]||(l[17]=a=>c.value=!0)},{default:t(()=>[e(A,null,{default:t(()=>[e(S(ia))]),_:1}),l[67]||(l[67]=i(" 添加日志 ",-1))]),_:1}),e(u,{size:"small",onClick:ll},{default:t(()=>[e(A,null,{default:t(()=>[e(S($l))]),_:1}),l[68]||(l[68]=i(" 刷新 ",-1))]),_:1})]),e(ze,{gutter:16},{default:t(()=>[e(R,{span:7},{default:t(()=>[e(Q,{header:"记忆目录",shadow:"hover"},{default:t(()=>[e(nt,{data:Ne.value,props:{label:"name",children:"children",isLeaf:a=>!a.isDir},onNodeClick:Ft,"highlight-current":"","default-expand-all":"","expand-on-click-node":!1},{default:t(({data:a})=>[s("span",jn,[a.isDir?(o(),x(A,{key:0,style:{color:"#E6A23C"}},{default:t(()=>[e(S(rt))]),_:1})):(o(),x(A,{key:1,style:{color:"#409EFF"}},{default:t(()=>[e(S(ft))]),_:1})),s("span",null,f(a.name),1),!a.isDir&&a.size?(o(),x(j,{key:2,type:"info",size:"small",style:{"margin-left":"auto"}},{default:t(()=>[i(f(gl(a.size)),1)]),_:2},1024)):h("",!0)])]),_:1},8,["data","props"]),Ne.value.length===0?(o(),x(Vl,{key:0,description:"记忆树为空","image-size":40})):h("",!0)]),_:1})]),_:1}),e(R,{span:17},{default:t(()=>[e(Q,{shadow:"hover"},{header:t(()=>[s("div",En,[e(qt,{separator:"/"},{default:t(()=>[e(st,null,{default:t(()=>[...l[69]||(l[69]=[i("memory",-1)])]),_:1}),(o(!0),m(N,null,Y(Xe.value,(a,k)=>(o(),x(st,{key:k},{default:t(()=>[i(f(a),1)]),_:2},1024))),128))]),_:1}),ye.value?(o(),x(u,{key:0,type:"primary",size:"small",onClick:At,loading:Me.value},{default:t(()=>[...l[70]||(l[70]=[i("保存",-1)])]),_:1},8,["loading"])):h("",!0)])]),default:t(()=>[ye.value?(o(),x(P,{key:0,modelValue:ge.value,"onUpdate:modelValue":l[18]||(l[18]=a=>ge.value=a),type:"textarea",rows:22,style:{"font-family":"monospace"}},null,8,["modelValue"])):(o(),x(Vl,{key:1,description:"点击左侧文件查看和编辑","image-size":60}))]),_:1})]),_:1})]),_:1}),e(nl,{modelValue:le.value,"onUpdate:modelValue":l[21]||(l[21]=a=>le.value=a),title:"新建记忆文件",width:"480px"},{footer:t(()=>[e(u,{onClick:l[20]||(l[20]=a=>le.value=!1)},{default:t(()=>[...l[72]||(l[72]=[i("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:Nt},{default:t(()=>[...l[73]||(l[73]=[i("创建",-1)])]),_:1})]),default:t(()=>[e($e,{"label-width":"80px"},{default:t(()=>[e(z,{label:"路径"},{default:t(()=>[e(P,{modelValue:Be.value,"onUpdate:modelValue":l[19]||(l[19]=a=>Be.value=a),placeholder:"例如: projects/my-project.md 或 topics/cooking.md"},null,8,["modelValue"]),e(j,{type:"info",size:"small",style:{"margin-top":"4px"}},{default:t(()=>[...l[71]||(l[71]=[i("相对于 memory/ 目录",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(nl,{modelValue:c.value,"onUpdate:modelValue":l[24]||(l[24]=a=>c.value=a),title:"添加今日日志",width:"600px"},{footer:t(()=>[e(u,{onClick:l[23]||(l[23]=a=>c.value=!1)},{default:t(()=>[...l[74]||(l[74]=[i("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:Mt},{default:t(()=>[...l[75]||(l[75]=[i("提交",-1)])]),_:1})]),default:t(()=>[e(P,{modelValue:d.value,"onUpdate:modelValue":l[22]||(l[22]=a=>d.value=a),type:"textarea",rows:10,placeholder:"记录今天的重要事项、学习心得、待办..."},null,8,["modelValue"])]),_:1},8,["modelValue"])]),_:1}),e(pe,{label:"技能",name:"skills"},{default:t(()=>[e(sn,{"agent-id":S(_)},null,8,["agent-id"])]),_:1}),e(pe,{label:"历史对话",name:"convlogs"},{default:t(()=>[s("div",Rn,[l[76]||(l[76]=s("span",{style:{"font-weight":"600","font-size":"15px"}},"渠道对话记录",-1)),e(u,{size:"small",icon:S($l),circle:"",onClick:lt,loading:xl.value},null,8,["icon","loading"])]),Oe((o(),x(Cl,{data:Rl.value,stripe:"","empty-text":"暂无对话记录"},{default:t(()=>[e(E,{label:"渠道","min-width":"200"},{default:t(({row:a})=>[s("span",null,f(a.channelType==="telegram"?"Telegram":"Web")+" "+f(a.channelId),1)]),_:1}),e(E,{label:"消息数",width:"100"},{default:t(({row:a})=>[i(f(a.messageCount)+" 条",1)]),_:1}),e(E,{label:"最后活跃",width:"180"},{default:t(({row:a})=>[i(f(a.lastAt?new Date(a.lastAt).toLocaleString("zh-CN"):"-"),1)]),_:1}),e(E,{label:"操作",width:"100"},{default:t(({row:a})=>[e(u,{size:"small",type:"primary",plain:"",onClick:k=>Ot(a)},{default:t(()=>[...l[77]||(l[77]=[i("查看",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Yl,xl.value]]),e(Ht,{modelValue:Kl.value,"onUpdate:modelValue":l[25]||(l[25]=a=>Kl.value=a),title:Wl.value+" 对话记录",direction:"rtl",size:"520px","destroy-on-close":!1},{default:t(()=>[s("div",Kn,[Wt.value?(o(),m("div",Wn,[e(u,{size:"small",plain:"",loading:tl.value,onClick:Yt},{default:t(()=>[...l[78]||(l[78]=[i("加载更多",-1)])]),_:1},8,["loading"])])):h("",!0),Oe((o(),m("div",On,[(o(!0),m(N,null,Y(we.value,(a,k)=>(o(),m("div",{key:k,class:dl(["conv-msg-item",a.role==="user"?"conv-msg-user":"conv-msg-assistant"])},[s("div",Yn,[s("span",Jn,f(a.role==="user"?"用户":"助手"),1),a.sender?(o(),m("span",qn,f(a.sender),1)):h("",!0),s("span",Hn,f(a.ts?new Date(a.ts).toLocaleString("zh-CN"):""),1)]),s("div",Gn,f(a.content),1)],2))),128)),!tl.value&&we.value.length===0?(o(),m("div",Qn," 暂无消息记录 ")):h("",!0)])),[[Yl,tl.value&&we.value.length===0]])])]),_:1},8,["modelValue","title"])]),_:1}),e(pe,{label:"工作区",name:"workspace"},{default:t(()=>[e(ze,{gutter:16},{default:t(()=>[e(R,{span:7},{default:t(()=>[e(Q,{shadow:"never",style:{height:"calc(100vh - 200px)",display:"flex","flex-direction":"column"}},{header:t(()=>[s("div",Xn,[l[79]||(l[79]=s("span",null,"文件列表",-1)),s("div",Zn,[e(u,{text:"",size:"small",onClick:l[26]||(l[26]=a=>W.value=!0),title:"新建文件"},{default:t(()=>[e(A,null,{default:t(()=>[e(S(sl))]),_:1})]),_:1}),e(u,{text:"",size:"small",onClick:bl,title:"刷新"},{default:t(()=>[e(A,null,{default:t(()=>[e(S($l))]),_:1})]),_:1})])])]),default:t(()=>[s("div",es,[e(nt,{data:D.value,props:{label:"name",children:"children"},onNodeClick:Bt,"highlight-current":"","default-expand-all":"",style:{"font-size":"13px"}},{default:t(({data:a})=>[s("span",ls,[a.isDir?(o(),x(A,{key:0,style:{color:"#e6a23c","font-size":"14px"}},{default:t(()=>[e(S(rt))]),_:1})):(o(),x(A,{key:1,style:We({color:Il(a.name),fontSize:"14px"})},{default:t(()=>[e(S(ft))]),_:1},8,["style"])),s("span",ts,f(a.name),1),a.isDir?h("",!0):(o(),x(j,{key:2,type:"info",size:"small",style:{"flex-shrink":"0","font-size":"11px"}},{default:t(()=>[i(f(gl(a.size)),1)]),_:2},1024))])]),_:1},8,["data"])])]),_:1})]),_:1}),e(R,{span:17},{default:t(()=>[e(Q,{shadow:"never",style:{height:"calc(100vh - 200px)",display:"flex","flex-direction":"column"}},{header:t(()=>[s("div",as,[s("span",ns,[i(f(b.value||"选择文件查看")+" ",1),b.value?(o(),x(V,{key:0,size:"small",style:{"margin-left":"6px","font-size":"11px"}},{default:t(()=>[i(f(Ul(b.value)),1)]),_:1})):h("",!0)]),b.value?(o(),x(u,{key:0,text:"",size:"small",type:"danger",title:"删除文件",onClick:Pt},{default:t(()=>[e(A,null,{default:t(()=>[e(Gt)]),_:1})]),_:1})):h("",!0)])]),default:t(()=>[b.value?(o(),m(N,{key:0},[e(P,{modelValue:F.value,"onUpdate:modelValue":l[27]||(l[27]=a=>F.value=a),type:"textarea",autosize:!1,placeholder:K.value?"二进制文件，无法编辑":"（空文件）",readonly:K.value,style:{flex:"1","font-family":"monospace","font-size":"13px"},rows:22},null,8,["modelValue","placeholder","readonly"]),s("div",ss,[e(u,{type:"primary",disabled:K.value,onClick:jt},{default:t(()=>[...l[80]||(l[80]=[i("保存",-1)])]),_:1},8,["disabled"]),J.value?(o(),x(j,{key:0,type:"info",size:"small"},{default:t(()=>[i(f(gl(J.value.size))+" · "+f(kt(J.value.modTime)),1)]),_:1})):h("",!0)])],64)):(o(),x(Vl,{key:1,description:"从左侧选择文件","image-size":60}))]),_:1})]),_:1})]),_:1}),e(nl,{modelValue:W.value,"onUpdate:modelValue":l[30]||(l[30]=a=>W.value=a),title:"新建文件",width:"400px"},{footer:t(()=>[e(u,{onClick:l[29]||(l[29]=a=>W.value=!1)},{default:t(()=>[...l[81]||(l[81]=[i("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:Zl},{default:t(()=>[...l[82]||(l[82]=[i("创建",-1)])]),_:1})]),default:t(()=>[e($e,{"label-width":"80px"},{default:t(()=>[e(z,{label:"文件路径"},{default:t(()=>[e(P,{modelValue:re.value,"onUpdate:modelValue":l[28]||(l[28]=a=>re.value=a),placeholder:"例如: notes.md 或 idear/my-idea.md",onKeyup:ua(Zl,["enter"])},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(pe,{label:"定时任务",name:"cron"},{default:t(()=>[e(u,{type:"primary",onClick:l[31]||(l[31]=a=>Ce.value=!0),style:{"margin-bottom":"16px"}},{default:t(()=>[e(A,null,{default:t(()=>[e(S(sl))]),_:1}),l[83]||(l[83]=i(" 新建任务 ",-1))]),_:1}),e(Cl,{data:yl.value,stripe:""},{default:t(()=>[e(E,{prop:"name",label:"名称"}),e(E,{label:"调度"},{default:t(({row:a})=>[i(f(a.schedule?.expr)+" ("+f(a.schedule?.tz)+")",1)]),_:1}),e(E,{label:"最近运行",width:"180"},{default:t(({row:a})=>[a.state?.lastRunAtMs?(o(),m(N,{key:0},[e(V,{type:a.state?.lastStatus==="ok"?"success":"danger",size:"small"},{default:t(()=>[i(f(a.state?.lastStatus),1)]),_:2},1032,["type"]),e(j,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:t(()=>[i(f(Hl(a.state?.lastRunAtMs)),1)]),_:2},1024)],64)):(o(),x(j,{key:1,type:"info",size:"small"},{default:t(()=>[...l[84]||(l[84]=[i("未运行",-1)])]),_:1}))]),_:1}),e(E,{label:"启用",width:"80"},{default:t(({row:a})=>[e(al,{modelValue:a.enabled,"onUpdate:modelValue":k=>a.enabled=k,onChange:k=>Rt(a)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(E,{label:"操作",width:"220"},{default:t(({row:a})=>[a.payload?.message==="__MEMORY_CONSOLIDATE__"?(o(),m(N,{key:0},[e(V,{type:"info",size:"small",style:{"margin-right":"8px"}},{default:t(()=>[...l[85]||(l[85]=[i("记忆管理",-1)])]),_:1}),e(u,{size:"small",onClick:k=>et(a)},{default:t(()=>[...l[86]||(l[86]=[i("立即运行",-1)])]),_:1},8,["onClick"])],64)):(o(),m(N,{key:1},[e(u,{size:"small",onClick:k=>et(a)},{default:t(()=>[...l[87]||(l[87]=[i("立即运行",-1)])]),_:1},8,["onClick"]),e(u,{size:"small",type:"danger",onClick:k=>Kt(a)},{default:t(()=>[...l[88]||(l[88]=[i("删除",-1)])]),_:1},8,["onClick"])],64))]),_:1})]),_:1},8,["data"]),e(nl,{modelValue:Ce.value,"onUpdate:modelValue":l[38]||(l[38]=a=>Ce.value=a),title:"新建定时任务",width:"520px"},{footer:t(()=>[e(u,{onClick:l[37]||(l[37]=a=>Ce.value=!1)},{default:t(()=>[...l[89]||(l[89]=[i("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:Et},{default:t(()=>[...l[90]||(l[90]=[i("创建",-1)])]),_:1})]),default:t(()=>[e($e,{model:p.value,"label-width":"100px"},{default:t(()=>[e(z,{label:"名称"},{default:t(()=>[e(P,{modelValue:p.value.name,"onUpdate:modelValue":l[32]||(l[32]=a=>p.value.name=a)},null,8,["modelValue"])]),_:1}),e(z,{label:"Cron 表达式"},{default:t(()=>[e(P,{modelValue:p.value.expr,"onUpdate:modelValue":l[33]||(l[33]=a=>p.value.expr=a),placeholder:"30 3 * * *"},null,8,["modelValue"])]),_:1}),e(z,{label:"时区"},{default:t(()=>[e(ne,{modelValue:p.value.tz,"onUpdate:modelValue":l[34]||(l[34]=a=>p.value.tz=a)},{default:t(()=>[e(T,{label:"Asia/Shanghai",value:"Asia/Shanghai"}),e(T,{label:"UTC",value:"UTC"}),e(T,{label:"America/New_York",value:"America/New_York"})]),_:1},8,["modelValue"])]),_:1}),e(z,{label:"消息"},{default:t(()=>[e(P,{modelValue:p.value.message,"onUpdate:modelValue":l[35]||(l[35]=a=>p.value.message=a),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),e(z,{label:"启用"},{default:t(()=>[e(al,{modelValue:p.value.enabled,"onUpdate:modelValue":l[36]||(l[36]=a=>p.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1}),e(pe,{label:"渠道",name:"channels"},{default:t(()=>[s("div",os,[e(j,{type:"info",size:"small"},{default:t(()=>[...l[91]||(l[91]=[i("每个 AI 成员独立配置自己的消息通道（如 Telegram Bot Token）",-1)])]),_:1}),e(u,{type:"primary",size:"small",onClick:xt},{default:t(()=>[e(A,null,{default:t(()=>[e(S(sl))]),_:1}),l[92]||(l[92]=i(" 添加消息渠道 ",-1))]),_:1})]),(o(!0),m(N,null,Y(ve.value,a=>(o(),m("div",{key:a.id,class:"channel-card"},[s("div",is,[s("div",us,[e(V,{size:"small",style:{"margin-right":"8px"}},{default:t(()=>[i(f(a.type),1)]),_:2},1024),s("span",ds,f(a.name),1),a.config?.botName?(o(),m("span",rs,"@"+f(a.config.botName),1)):h("",!0),e(V,{type:a.status==="ok"?"success":a.status==="error"?"danger":"info",size:"small",effect:"plain",style:{"margin-left":"8px"}},{default:t(()=>[i(f(a.status==="ok"?"✓ 正常":a.status==="error"?"✗ 错误":"未测试"),1)]),_:2},1032,["type"])]),s("div",fs,[e(al,{modelValue:a.enabled,"onUpdate:modelValue":k=>a.enabled=k,size:"small",onChange:Vt,style:{"margin-right":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),e(u,{size:"small",onClick:k=>zt(a),loading:Al.value===a.id},{default:t(()=>[...l[93]||(l[93]=[i("测试连接",-1)])]),_:1},8,["onClick","loading"]),e(u,{size:"small",onClick:k=>ht(a)},{default:t(()=>[...l[94]||(l[94]=[i("编辑",-1)])]),_:1},8,["onClick"]),e(u,{size:"small",type:"danger",plain:"",onClick:k=>$t(a)},{default:t(()=>[...l[95]||(l[95]=[i("删除",-1)])]),_:1},8,["onClick"])])]),a.type==="web"?(o(),m("div",vs,[s("div",ps,[l[97]||(l[97]=s("span",{class:"channel-info-label"},"公开地址",-1)),s("span",cs,[e(Qt,{href:Ee(S(_),a.id),target:"_blank",type:"primary",style:{"font-size":"13px"}},{default:t(()=>[i(f(Ee(S(_),a.id)),1)]),_:2},1032,["href"]),e(u,{size:"small",link:"",style:{"margin-left":"8px"},onClick:k=>Ql(Ee(S(_),a.id))},{default:t(()=>[...l[96]||(l[96]=[i("复制",-1)])]),_:1},8,["onClick"])])]),s("div",ms,[l[98]||(l[98]=s("span",{class:"channel-info-label"},"访问密码",-1)),s("span",ys,[e(V,{size:"small",type:a.config?.password?"warning":"info",effect:"plain"},{default:t(()=>[i(f(a.config?.password?"已设置":"无密码"),1)]),_:2},1032,["type"])])])])):h("",!0),a.type==="telegram"?(o(),m("div",gs,[s("div",_s,[l[100]||(l[100]=s("span",{class:"channel-info-label"},"白名单用户",-1)),s("span",ws,[a.allowedFromUsers?.length?(o(!0),m(N,{key:0},Y(a.allowedFromUsers,k=>(o(),x(V,{key:k.id,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:Jl=>Xl(a.id,k.id)},{default:t(()=>[i(f(k.username?"@"+k.username:k.firstName||String(k.id))+" ",1),s("span",bs,"("+f(k.id)+")",1)]),_:2},1032,["onClose"]))),128)):a.config?.allowedFrom?(o(!0),m(N,{key:1},Y(a.config.allowedFrom.split(","),k=>(o(),x(V,{key:k,size:"small",closable:"","disable-transitions":!0,style:{"margin-right":"4px","margin-bottom":"4px"},onClose:Jl=>Xl(a.id,Number(k.trim()))},{default:t(()=>[i(f(k.trim()),1)]),_:2},1032,["onClose"]))),128)):(o(),x(j,{key:2,type:"warning",size:"small"},{default:t(()=>[...l[99]||(l[99]=[i("未设置（配对模式，向用户返回其 ID）",-1)])]),_:1}))])]),s("div",ks,[s("div",{class:"pending-section-header",onClick:k=>Tt(a.id)},[l[102]||(l[102]=s("span",null,"待审核用户",-1)),e(at,{value:(Ke.value[a.id]||[]).length,hidden:!(Ke.value[a.id]||[]).length,type:"warning",style:{"margin-left":"6px"}},null,8,["value","hidden"]),e(u,{size:"small",link:"",onClick:gt(k=>wl(a.id),["stop"]),style:{"margin-left":"8px"}},{default:t(()=>[...l[101]||(l[101]=[i("刷新",-1)])]),_:1},8,["onClick"]),e(A,{style:We([{"margin-left":"4px",transition:"transform 0.2s"},{transform:el.value===a.id?"rotate(180deg)":""}])},{default:t(()=>[e(S(da))]),_:1},8,["style"])],8,xs),el.value===a.id?(o(),m("div",hs,[Pl.value[a.id]?(o(),m("div",Cs,[e(j,{type:"info",size:"small"},{default:t(()=>[...l[103]||(l[103]=[i("加载中...",-1)])]),_:1})])):(Ke.value[a.id]||[]).length?(o(!0),m(N,{key:1},Y(Ke.value[a.id],k=>(o(),m("div",{key:k.id,class:"pending-user-row"},[s("div",Vs,[s("span",$s,f(k.firstName||"未知"),1),k.username?(o(),m("span",zs,"@"+f(k.username),1)):h("",!0),s("span",Ts,"ID: "+f(k.id),1),e(j,{type:"info",size:"small",style:{"margin-left":"8px"}},{default:t(()=>[i(f(ce(k.lastSeen)),1)]),_:2},1024)]),s("div",Ss,[e(u,{size:"small",type:"success",plain:"",onClick:Jl=>St(a.id,k.id),loading:jl.value===`${a.id}-${k.id}`},{default:t(()=>[...l[104]||(l[104]=[i("加入白名单",-1)])]),_:1},8,["onClick","loading"]),e(u,{size:"small",type:"danger",plain:"",onClick:Jl=>Lt(a.id,k.id)},{default:t(()=>[...l[105]||(l[105]=[i("忽略",-1)])]),_:1},8,["onClick"])])]))),128)):(o(),m("div",Ls," 暂无待审核用户。让用户向 Bot 发送 /start 即可出现在此处。 "))])):h("",!0)])])):h("",!0)]))),128)),!Dl.value&&!ve.value.length?(o(),x(Vl,{key:0,description:"暂无消息渠道，点击「添加消息渠道」开始配置","image-size":80,style:{"margin-top":"40px"}})):h("",!0),e(nl,{modelValue:je.value,"onUpdate:modelValue":l[49]||(l[49]=a=>je.value=a),title:ae.value?"编辑消息渠道":"添加消息渠道",width:"540px"},{footer:t(()=>[e(u,{onClick:l[48]||(l[48]=a=>je.value=!1)},{default:t(()=>[...l[115]||(l[115]=[i("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:Ct,loading:Fl.value},{default:t(()=>[...l[116]||(l[116]=[i("保存",-1)])]),_:1},8,["loading"])]),default:t(()=>[e($e,{model:w.value,"label-width":"120px"},{default:t(()=>[e(z,{label:"类型",required:""},{default:t(()=>[e(ne,{modelValue:w.value.type,"onUpdate:modelValue":l[39]||(l[39]=a=>w.value.type=a),style:{width:"100%"}},{default:t(()=>[e(T,{label:"Telegram",value:"telegram"}),e(T,{label:"Web 聊天页",value:"web"}),e(T,{label:"iMessage",value:"imessage"}),e(T,{label:"WhatsApp",value:"whatsapp"})]),_:1},8,["modelValue"])]),_:1}),e(z,{label:"名称",required:""},{default:t(()=>[e(P,{modelValue:w.value.name,"onUpdate:modelValue":l[40]||(l[40]=a=>w.value.name=a),placeholder:"如：客服 Bot"},null,8,["modelValue"])]),_:1}),w.value.type==="telegram"?(o(),m(N,{key:0},[e(z,{label:"Bot Token",required:""},{default:t(()=>[s("div",Is,[s("div",Us,[e(P,{modelValue:w.value.botToken,"onUpdate:modelValue":l[41]||(l[41]=a=>w.value.botToken=a),type:"password","show-password":"",placeholder:"从 @BotFather 获取",style:{flex:"1"},status:I.value.status==="error"?"error":I.value.status==="ok"?"success":""},null,8,["modelValue","status"]),e(u,{size:"default",loading:I.value.loading,type:I.value.status==="ok"?"success":I.value.status==="error"?"danger":"default",onClick:Gl,disabled:!w.value.botToken||Ml(w.value.botToken)},{default:t(()=>[...l[106]||(l[106]=[i("验证",-1)])]),_:1},8,["loading","type","disabled"])]),I.value.loading?(o(),m("div",Ds,[e(A,{class:"is-loading"},{default:t(()=>[e(S($l))]),_:1}),l[107]||(l[107]=i(" 正在验证 Token… ",-1))])):I.value.status==="ok"?(o(),m("div",Fs,[e(A,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Xt)]),_:1}),l[108]||(l[108]=i("Token 有效，Bot 名称：",-1)),s("b",null,"@"+f(I.value.botName),1)])):I.value.status==="duplicate"?(o(),m("div",As,[e(A,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(Zt)]),_:1}),l[109]||(l[109]=i("此 Token 已被成员「",-1)),s("b",null,f(I.value.usedBy),1),i("」的渠道「"+f(I.value.usedByCh)+"」使用 ",1)])):I.value.status==="error"?(o(),m("div",Ns,[e(A,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(ea)]),_:1}),i(f(I.value.error),1)])):(o(),m("div",Ms,[e(j,{type:"info",size:"small"},{default:t(()=>[e(A,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(ot)]),_:1}),l[110]||(l[110]=i("输入完成后自动验证，也可点右侧「验证」按钮手动触发",-1))]),_:1})]))])]),_:1}),e(z,{label:"白名单用户"},{default:t(()=>[e(P,{modelValue:w.value.allowedFrom,"onUpdate:modelValue":l[42]||(l[42]=a=>w.value.allowedFrom=a),placeholder:"填入 Telegram 用户 ID，多个用逗号分隔"},null,8,["modelValue"]),e(j,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[e(A,{style:{"vertical-align":"-2px","margin-right":"4px"}},{default:t(()=>[e(ot)]),_:1}),l[111]||(l[111]=i("留空时 Bot 进入配对模式——向用户返回其 ID，引导联系管理员添加白名单 ",-1))]),_:1})]),_:1})],64)):h("",!0),w.value.type==="web"?(o(),m(N,{key:1},[ae.value?(o(),x(z,{key:0,label:"访问链接"},{default:t(()=>[s("div",Bs,[e(A,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(it)]),_:1}),s("span",Ps,f(Ee(S(_),ae.value)),1),e(u,{size:"small",link:"",onClick:l[43]||(l[43]=a=>Ql(Ee(S(_),ae.value)))},{default:t(()=>[...l[112]||(l[112]=[i("复制",-1)])]),_:1})])]),_:1})):h("",!0),ae.value?h("",!0):(o(),x(z,{key:1,label:"访问链接"},{default:t(()=>[s("div",js,[e(A,{style:{"flex-shrink":"0",color:"#909399"}},{default:t(()=>[e(it)]),_:1}),s("span",Es,f(Ee(S(_),_l.value)),1),e(V,{size:"small",type:"info",effect:"plain"},{default:t(()=>[...l[113]||(l[113]=[i("保存后生效",-1)])]),_:1})]),e(j,{type:"info",size:"small",style:{display:"block","margin-top":"4px"}},{default:t(()=>[...l[114]||(l[114]=[i(" 每个 Web 渠道有独立链接，可同时开放多个入口 ",-1)])]),_:1})]),_:1})),e(z,{label:"访问密码"},{default:t(()=>[e(P,{modelValue:w.value.webPassword,"onUpdate:modelValue":l[44]||(l[44]=a=>w.value.webPassword=a),type:"password","show-password":"",placeholder:"留空则无需密码"},null,8,["modelValue"])]),_:1}),e(z,{label:"欢迎语"},{default:t(()=>[e(P,{modelValue:w.value.webWelcome,"onUpdate:modelValue":l[45]||(l[45]=a=>w.value.webWelcome=a),placeholder:"你好！有什么可以帮你的？"},null,8,["modelValue"])]),_:1}),e(z,{label:"页面标题"},{default:t(()=>[e(P,{modelValue:w.value.webTitle,"onUpdate:modelValue":l[46]||(l[46]=a=>w.value.webTitle=a),placeholder:"AI 助手"},null,8,["modelValue"])]),_:1})],64)):h("",!0),e(z,{label:"启用"},{default:t(()=>[e(al,{modelValue:w.value.enabled,"onUpdate:modelValue":l[47]||(l[47]=a=>w.value.enabled=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})}}}),qs=wt(Ks,[["__scopeId","data-v-b94aacca"]]);export{qs as default};
